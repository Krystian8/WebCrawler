(function(){
var hola_ldr_require;(function(){if(!navigator||!navigator.userAgent||/ MSIE [1-8]\./.test(navigator.userAgent)){return}var E={};hola_ldr_require=E;E.zdot=function(name){if(1)

return {
json: "{\"gen\":{\"order\":2,\"agent\":{\"manifest2cache\":{\"__Function__\":\"function (url){\\n                url = url.replace('&secure=true', '');\\n                return url;\\n            }\"},\"origins\":[\"secure.brightcove.com\",\"brightcove.vo.llnwd.net\",\"c.brightcove.com\",\"brightcove01.brightcove.com\"],\"preview\":{\"auto_generate\":false}},\"cdn\":{\"bwsaver\":{},\"filter_out\":{\"js\":\"var match = {\\\"video_url\\\":\\\"(^https?:\\\\\\\\/\\\\\\\\/storage\\\\\\\\.googleapis\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn2\\\\\\\\.movad\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.simpli\\\\\\\\.fi\\\\\\\\/ads\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s3\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.vidible\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?hes\\\\\\\\.themrbinman\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?mediabong\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?cdn-01\\\\\\\\.yumenetworks\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?dyjnzf8evxrp2\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?playtime\\\\\\\\.tubemogul\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s-static\\\\\\\\.innovid\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s3\\\\\\\\.eu-central-1\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?rezonence\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.teads\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?rackcdn\\\\\\\\.com\\\\\\\\/Ads\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/v\\\\\\\\.adsrvr\\\\\\\\.org\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video-assets\\\\\\\\.mathtag\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/redirector\\\\\\\\.gvt1\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.innovid\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s1\\\\\\\\.adform\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.adap\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.serving-sys\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/gcdn\\\\\\\\.2mdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn01\\\\\\\\.centro\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vstatic\\\\\\\\.fastclick\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vid1\\\\\\\\.cdns\\\\\\\\.turn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.videoamp\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vcdn\\\\\\\\.adnxs\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.bidr\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.flashtalking\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/a\\\\\\\\.runadtag\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c3\\\\\\\\.rfihub\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/pixeltrack\\\\\\\\.eyeviewads\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn1\\\\\\\\.extremereach\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/secure\\\\\\\\.img-cdn\\\\\\\\.mediaplex\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s4w9z8k2\\\\\\\\.ssl\\\\\\\\.hwcdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/assets\\\\\\\\.scoota\\\\\\\\.co\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/p\\\\\\\\.videologygroup\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.fuel451\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.adform\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.n\\\\\\\\.dynstc\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/dt7qfu63wpsad\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/twcmediasales\\\\\\\\.akamaized\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/creative\\\\\\\\.akamaized\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c1\\\\\\\\.undertonevideo\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/aka\\\\\\\\.spotxcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/videos\\\\\\\\.adforgecdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.atlassbx\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/studiov8-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/scdn-01\\\\\\\\.yumenetworks\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video\\\\\\\\.turncdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/resources\\\\\\\\.eyereturn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cache-ssl\\\\\\\\.celtra\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/adaptvcdn-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s1\\\\\\\\.adformdsp\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/securecdn\\\\\\\\.videologygroup\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/i\\\\\\\\.loopme\\\\\\\\.me\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/swf\\\\\\\\.mixpo\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn-a\\\\\\\\.amazon-adsystem\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdns\\\\\\\\.amgdgt\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cache\\\\\\\\.linkstorm\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.adhigh\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdnsonata\\\\\\\\.taptapnetworks\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/assets\\\\\\\\.tapad\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.splicky\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ad\\\\\\\\.appier\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ads\\\\\\\\.w55c\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/d2qkpebv23oowx\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s2\\\\\\\\.content\\\\\\\\.video\\\\\\\\.llnw\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.giantmedia\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/fdi-revs\\\\\\\\.s3-us-west-2\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/www\\\\\\\\.hbd-cm\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c-609870\\\\\\\\.http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/streaming\\\\\\\\.emerse\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ced\\\\\\\\.sascdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/live-ssl\\\\\\\\.cdn\\\\\\\\.spongecell\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/static\\\\\\\\.sharethrough\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s3-eu-west-1\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/4f-affiliates\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?web\\\\\\\\.sundaysky\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/d30cbwo13f9n09\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/www\\\\\\\\.youtube\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn01\\\\\\\\.basis\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.visiblemeasures\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.storygize\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/snifreewheelpmd-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/sb\\\\\\\\.bidswitch\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/turbo\\\\\\\\.engageclick\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/i\\\\\\\\.r1-cdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/toots-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/level3cdn\\\\\\\\.screen9\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cstatic\\\\\\\\.weborama\\\\\\\\.fr\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?adgear\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video-assets\\\\\\\\.brandcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/videocdn\\\\\\\\.adm-vids\\\\\\\\.info\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/files\\\\\\\\.provenpixel\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn2\\\\\\\\.extremereach\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/server\\\\\\\\.adformdsp\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ad-resources\\\\\\\\.brandcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/brightcove\\\\\\\\.vo\\\\\\\\.llnwd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/brightcove\\\\\\\\.hs\\\\\\\\.llnwd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/udso-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.sundaysky\\\\\\\\.com\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/umedia\\\\\\\\.exe\\\\\\\\.bid\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/player\\\\\\\\.mediabong\\\\\\\\.com\\\\\\\\/static\\\\\\\\/videojs\\\\\\\\/black\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.vindicosuite\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.adrcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/w\\\\\\\\.swarmdsp\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/jas-prod-cdn\\\\\\\\.juiceserver\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?fna\\\\\\\\.fbcdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ocdn\\\\\\\\.eu\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?criteo\\\\\\\\.net\\\\\\\\/.*)|(^data:video\\\\\\\\/mp4.*)|(fp\\\\\\\\.dev\\\\\\\\.lumen-research\\\\\\\\.com)|(creative\\\\\\\\.lkqd\\\\\\\\.net)|(sting\\\\\\\\.de17a\\\\\\\\.com)|(vast-videos\\\\\\\\.springserve\\\\\\\\.com)|(^https?:\\\\\\\\/\\\\\\\\/f1\\\\\\\\.media\\\\\\\\.brightcove\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.mp4\\\\\\\\?)|(^https?:\\\\\\\\/\\\\\\\\/p\\\\\\\\.hadvid\\\\\\\\.com\\\\\\\\/)|(^https?:\\\\\\\\/\\\\\\\\/static\\\\\\\\.scanscout\\\\\\\\.com\\\\\\\\/)|(^https?:\\\\\\\\/\\\\\\\\/fo-api\\\\\\\\.omnitagjs\\\\\\\\.com\\\\\\\\/)\\\"};\\nfunction video_url(opt, match){\\n    return new RegExp(match.video_url).test(opt.video_url);\\n}\\nreturn video_url(opt, match);\",\"video_url\":\"^https?:\\\\/\\\\/storage\\\\.googleapis\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn2\\\\.movad\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.simpli\\\\.fi\\\\/ads\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s3\\\\.amazonaws\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.vidible\\\\.tv\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?hes\\\\.themrbinman\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?mediabong\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?cdn-01\\\\.yumenetworks\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?dyjnzf8evxrp2\\\\.cloudfront\\\\.net\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?playtime\\\\.tubemogul\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s-static\\\\.innovid\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s3\\\\.eu-central-1\\\\.amazonaws\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?rezonence\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.teads\\\\.tv\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?rackcdn\\\\.com\\\\/Ads\\\\/.* ^https?:\\\\/\\\\/v\\\\.adsrvr\\\\.org\\\\/.* ^https?:\\\\/\\\\/video-assets\\\\.mathtag\\\\.com\\\\/.* ^https?:\\\\/\\\\/redirector\\\\.gvt1\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.innovid\\\\.com\\\\/.* ^https?:\\\\/\\\\/s1\\\\.adform\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.adap\\\\.tv\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.serving-sys\\\\.com\\\\/.* ^https?:\\\\/\\\\/gcdn\\\\.2mdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn01\\\\.centro\\\\.net\\\\/.* ^https?:\\\\/\\\\/vstatic\\\\.fastclick\\\\.net\\\\/.* ^https?:\\\\/\\\\/vid1\\\\.cdns\\\\.turn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.videoamp\\\\.com\\\\/.* ^https?:\\\\/\\\\/vcdn\\\\.adnxs\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.bidr\\\\.io\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.flashtalking\\\\.com\\\\/.* ^https?:\\\\/\\\\/s\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/a\\\\.runadtag\\\\.com\\\\/.* ^https?:\\\\/\\\\/http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/c3\\\\.rfihub\\\\.net\\\\/.* ^https?:\\\\/\\\\/pixeltrack\\\\.eyeviewads\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn1\\\\.extremereach\\\\.io\\\\/.* ^https?:\\\\/\\\\/secure\\\\.img-cdn\\\\.mediaplex\\\\.com\\\\/.* ^https?:\\\\/\\\\/s4w9z8k2\\\\.ssl\\\\.hwcdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/assets\\\\.scoota\\\\.co\\\\/.* ^https?:\\\\/\\\\/p\\\\.videologygroup\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.fuel451\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.adform\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.n\\\\.dynstc\\\\.com\\\\/.* ^https?:\\\\/\\\\/dt7qfu63wpsad\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/twcmediasales\\\\.akamaized\\\\.net\\\\/.* ^https?:\\\\/\\\\/creative\\\\.akamaized\\\\.net\\\\/.* ^https?:\\\\/\\\\/c1\\\\.undertonevideo\\\\.com\\\\/.* ^https?:\\\\/\\\\/aka\\\\.spotxcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/videos\\\\.adforgecdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.atlassbx\\\\.com\\\\/.* ^https?:\\\\/\\\\/studiov8-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/scdn-01\\\\.yumenetworks\\\\.com\\\\/.* ^https?:\\\\/\\\\/video\\\\.turncdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/resources\\\\.eyereturn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cache-ssl\\\\.celtra\\\\.com\\\\/.* ^https?:\\\\/\\\\/adaptvcdn-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/s1\\\\.adformdsp\\\\.net\\\\/.* ^https?:\\\\/\\\\/securecdn\\\\.videologygroup\\\\.com\\\\/.* ^https?:\\\\/\\\\/i\\\\.loopme\\\\.me\\\\/.* ^https?:\\\\/\\\\/swf\\\\.mixpo\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn-a\\\\.amazon-adsystem\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdns\\\\.amgdgt\\\\.com\\\\/.* ^https?:\\\\/\\\\/cache\\\\.linkstorm\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.adhigh\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdnsonata\\\\.taptapnetworks\\\\.com\\\\/.* ^https?:\\\\/\\\\/assets\\\\.tapad\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.splicky\\\\.com\\\\/.* ^https?:\\\\/\\\\/ad\\\\.appier\\\\.net\\\\/.* ^https?:\\\\/\\\\/ads\\\\.w55c\\\\.net\\\\/.* ^https?:\\\\/\\\\/d2qkpebv23oowx\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/s2\\\\.content\\\\.video\\\\.llnw\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.giantmedia\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/fdi-revs\\\\.s3-us-west-2\\\\.amazonaws\\\\.com\\\\/.* ^https?:\\\\/\\\\/www\\\\.hbd-cm\\\\.com\\\\/.* ^https?:\\\\/\\\\/c-609870\\\\.http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/streaming\\\\.emerse\\\\.com\\\\/.* ^https?:\\\\/\\\\/ced\\\\.sascdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/live-ssl\\\\.cdn\\\\.spongecell\\\\.com\\\\/.* ^https?:\\\\/\\\\/static\\\\.sharethrough\\\\.com\\\\/.* ^https?:\\\\/\\\\/s3-eu-west-1\\\\.amazonaws\\\\.com\\\\/4f-affiliates\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?web\\\\.sundaysky\\\\.com\\\\/.* ^https?:\\\\/\\\\/d30cbwo13f9n09\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/www\\\\.youtube\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn01\\\\.basis\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.visiblemeasures\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.storygize\\\\.net\\\\/.* ^https?:\\\\/\\\\/snifreewheelpmd-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/sb\\\\.bidswitch\\\\.net\\\\/.* ^https?:\\\\/\\\\/turbo\\\\.engageclick\\\\.com\\\\/.* ^https?:\\\\/\\\\/i\\\\.r1-cdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/toots-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/level3cdn\\\\.screen9\\\\.com\\\\/.* ^https?:\\\\/\\\\/cstatic\\\\.weborama\\\\.fr\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?adgear\\\\.com\\\\/.* ^https?:\\\\/\\\\/video-assets\\\\.brandcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/videocdn\\\\.adm-vids\\\\.info\\\\/.* ^https?:\\\\/\\\\/files\\\\.provenpixel\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn2\\\\.extremereach\\\\.io\\\\/.* ^https?:\\\\/\\\\/server\\\\.adformdsp\\\\.net\\\\/.* ^https?:\\\\/\\\\/ad-resources\\\\.brandcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/brightcove\\\\.vo\\\\.llnwd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/brightcove\\\\.hs\\\\.llnwd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/udso-a\\\\.akamaihd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/media\\\\.sundaysky\\\\.com\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/umedia\\\\.exe\\\\.bid\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/player\\\\.mediabong\\\\.com\\\\/static\\\\/videojs\\\\/black\\\\.mp4 ^https?:\\\\/\\\\/cdn\\\\.vindicosuite\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.adrcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/w\\\\.swarmdsp\\\\.com\\\\/.* ^https?:\\\\/\\\\/jas-prod-cdn\\\\.juiceserver\\\\.com\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?fna\\\\.fbcdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/ocdn\\\\.eu\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?criteo\\\\.net\\\\/.* ^data:video\\\\/mp4.* fp\\\\.dev\\\\.lumen-research\\\\.com creative\\\\.lkqd\\\\.net sting\\\\.de17a\\\\.com vast-videos\\\\.springserve\\\\.com  ^https?:\\\\/\\\\/f1\\\\.media\\\\.brightcove\\\\.com\\\\/.*\\\\.mp4\\\\? ^https?:\\\\/\\\\/p\\\\.hadvid\\\\.com\\\\/ ^https?:\\\\/\\\\/static\\\\.scanscout\\\\.com\\\\/ ^https?:\\\\/\\\\/fo-api\\\\.omnitagjs\\\\.com\\\\/\"},\"send_reqs\":{\"only_if_can_get\":true,\"hola\":{},\"origin\":{\"name\":\"Brightcove\"}},\"method\":{\"auto_load_keyframe_map\":false,\"detect_meta_data_location\":false}},\"kw\":{\"customer_active\":1,\"customer_vertical_brand\":1,\"customer_hotline\":1,\"enabled\":1,\"stats\":1,\"monitor_basic\":1},\"loader\":{\"match\":{\"country\":{},\"js\":\"return false;\"},\"rules\":[{\"cdn\":0,\"bwsaver\":0,\"stats\":1,\"display_cdn\":0,\"display_stats\":100}]},\"monitor\":{},\"origin_control\":[{\"group\":\"secure.brightcove.com\",\"sources\":[\"secure.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"secure.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"brightcove.vo.llnwd.net\",\"sources\":[\"brightcove.vo.llnwd.net\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"brightcove.vo.llnwd.net\",\"apply\":\"dont_change\"}]}]},{\"group\":\"c.brightcove.com\",\"sources\":[\"c.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"c.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"brightcove01.brightcove.com\",\"sources\":[\"brightcove01.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"brightcove01.brightcove.com\",\"apply\":\"dont_change\"}]}]}],\"player\":{\"no_media_size_server\":true,\"persistent_video\":{\"enabled\":false},\"thumbnails\":{\"enable\":false}},\"portal\":{\"conf\":{},\"filter\":{\"video_url_g\":[\"storage.googleapis.com\",\"cdn2.movad.net\",\"cdn.simpli.fi/ads/**\",\"**.s3.amazonaws.com\",\"cdn.vidible.tv\",\"**.hes.themrbinman.com/**.(mp4|webm)\",\"**.mediabong.com/**.(mp4|webm)\",\"**.cdn-01.yumenetworks.com/**.(mp4|webm)\",\"**.dyjnzf8evxrp2.cloudfront.net/**.(mp4|webm)\",\"**.playtime.tubemogul.com/**.(mp4|webm)\",\"**.s-static.innovid.com/**.(mp4|webm)\",\"**.s3.eu-central-1.amazonaws.com/**.(mp4|webm)\",\"**.rezonence.com/**\",\"cdn.teads.tv\",\"**.rackcdn.com/Ads/**\",\"v.adsrvr.org\",\"video-assets.mathtag.com\",\"redirector.gvt1.com\",\"*.innovid.com\",\"s1.adform.net\",\"cdn.adap.tv\",\"*.serving-sys.com\",\"gcdn.2mdn.net\",\"cdn01.centro.net\",\"vstatic.fastclick.net\",\"vid1.cdns.turn.com\",\"cdn.videoamp.com\",\"vcdn.adnxs.com\",\"media.bidr.io\",\"cdn.flashtalking.com\",\"s.yimg.com\",\"a.runadtag.com\",\"http.atlas.cdn.yimg.com\",\"c3.rfihub.net\",\"pixeltrack.eyeviewads.com\",\"cdn1.extremereach.io\",\"secure.img-cdn.mediaplex.com\",\"s4w9z8k2.ssl.hwcdn.net\",\"assets.scoota.co\",\"p.videologygroup.com\",\"media.fuel451.com\",\"*.adform.net\",\"cdn.n.dynstc.com\",\"dt7qfu63wpsad.cloudfront.net\",\"twcmediasales.akamaized.net\",\"creative.akamaized.net\",\"c1.undertonevideo.com\",\"aka.spotxcdn.com\",\"videos.adforgecdn.com\",\"cdn.atlassbx.com\",\"studiov8-a.akamaihd.net\",\"scdn-01.yumenetworks.com\",\"video.turncdn.com\",\"resources.eyereturn.com\",\"cache-ssl.celtra.com\",\"adaptvcdn-a.akamaihd.net\",\"s1.adformdsp.net\",\"securecdn.videologygroup.com\",\"i.loopme.me\",\"swf.mixpo.com\",\"cdn-a.amazon-adsystem.com\",\"cdns.amgdgt.com\",\"cache.linkstorm.net\",\"cdn.adhigh.net\",\"cdnsonata.taptapnetworks.com\",\"assets.tapad.com\",\"cdn.splicky.com\",\"ad.appier.net\",\"ads.w55c.net\",\"d2qkpebv23oowx.cloudfront.net\",\"s2.content.video.llnw.net\",\"cdn.giantmedia.com\",\"*.http.atlas.cdn.yimg.com\",\"fdi-revs.s3-us-west-2.amazonaws.com\",\"www.hbd-cm.com\",\"c-609870.http.atlas.cdn.yimg.com\",\"streaming.emerse.com\",\"ced.sascdn.com\",\"live-ssl.cdn.spongecell.com\",\"static.sharethrough.com\",\"s3-eu-west-1.amazonaws.com/4f-affiliates/**\",\"**.web.sundaysky.com\",\"d30cbwo13f9n09.cloudfront.net\",\"www.youtube.com\",\"cdn01.basis.net\",\"cdn.visiblemeasures.com\",\"cdn.storygize.net\",\"snifreewheelpmd-a.akamaihd.net\",\"sb.bidswitch.net\",\"turbo.engageclick.com\",\"i.r1-cdn.net\",\"toots-a.akamaihd.net\",\"level3cdn.screen9.com\",\"cstatic.weborama.fr\",\"**.adgear.com\",\"video-assets.brandcdn.com\",\"videocdn.adm-vids.info\",\"files.provenpixel.com\",\"cdn2.extremereach.io\",\"server.adformdsp.net\",\"ad-resources.brandcdn.com\",\"brightcove.vo.llnwd.net/**/*.mp4\",\"brightcove.hs.llnwd.net/**/*.mp4\",\"udso-a.akamaihd.net/**/*.mp4\",\"media.sundaysky.com/**/*.mp4\",\"umedia.exe.bid/**/*.mp4\",\"player.mediabong.com/static/videojs/black.mp4\",\"cdn.vindicosuite.com\",\"media.adrcdn.com\",\"w.swarmdsp.com\",\"jas-prod-cdn.juiceserver.com\",\"**.fna.fbcdn.net\",\"ocdn.eu\",\"**.criteo.net\",\"**video/mp4**\"]},\"match\":{},\"zones\":{}},\"test_urls\":[],\"util\":{\"log\":{\"report\":{\"date\":\"2017-07-25T07:34:51.265Z\",\"user\":\"basic/stanislav@hola.org\",\"end\":{\"add_log\":0,\"unittest\":0},\"seek\":{\"add_log\":0,\"unittest\":0},\"start\":{\"add_log\":0,\"unittest\":0},\"wait\":{\"add_log\":0,\"unittest\":0}}}},\"wrapper\":{\"methods\":{\"cdn\":[\"hls\",\"hap_hls\",\"hds\",\"dash\"],\"stats\":[\"hls\",\"hap_hls\",\"hds\",\"dash\"]}}},\"zones\":{\"independent\":{\"order\":1,\"agent\":{\"manifest2cache\":{\"__Function__\":\"function (url){ return url; }\"},\"origins\":[\"f1.media.brightcove.com\",\"hls.cf.brightcove.com\",\"brightcove.hs.llnwd.net\",\"hls.ak.o.brightcove.com\",\"uds.ak.o.brightcove.com\",\"secure.brightcove.com\",\"brightcove01.brightcove.com\",\"c.brightcove.com\",\"brightcove.vo.llnwd.net\"],\"url2cache\":{\"__Function__\":\"function (url){\\n                    var a = url.match(/^https?:(.*)$/);\\n                    return a&&a[1] ? a[1] : url;\\n                }\"},\"preview\":{\"auto_generate\":false}},\"analysis\":{\"hola_uid\":\"basic/volodymyr@hola.org\",\"js\":[],\"tag\":{\"date\":{\"__ISODate__\":\"2017-08-11T15:13:06.000Z\"},\"id\":28}},\"cdn\":{\"bwsaver\":{\"lowcost_watermark_sec\":10,\"urgent_watermark_sec\":5},\"send_reqs\":{\"hola\":{},\"origin\":{\"name\":\"Brightcove\"},\"only_if_can_get\":true},\"filter_out\":{\"js\":\"var match = {\\\"video_url\\\":\\\"(^https?:\\\\\\\\/\\\\\\\\/storage\\\\\\\\.googleapis\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn2\\\\\\\\.movad\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.simpli\\\\\\\\.fi\\\\\\\\/ads\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s3\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.vidible\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?hes\\\\\\\\.themrbinman\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?mediabong\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?cdn-01\\\\\\\\.yumenetworks\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?dyjnzf8evxrp2\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?playtime\\\\\\\\.tubemogul\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s-static\\\\\\\\.innovid\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?s3\\\\\\\\.eu-central-1\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.(mp4|webm))|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?rezonence\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.teads\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?rackcdn\\\\\\\\.com\\\\\\\\/Ads\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/v\\\\\\\\.adsrvr\\\\\\\\.org\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video-assets\\\\\\\\.mathtag\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/redirector\\\\\\\\.gvt1\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.innovid\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s1\\\\\\\\.adform\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.adap\\\\\\\\.tv\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.serving-sys\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/gcdn\\\\\\\\.2mdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn01\\\\\\\\.centro\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vstatic\\\\\\\\.fastclick\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vid1\\\\\\\\.cdns\\\\\\\\.turn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.videoamp\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/vcdn\\\\\\\\.adnxs\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.bidr\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.flashtalking\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/a\\\\\\\\.runadtag\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c3\\\\\\\\.rfihub\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/pixeltrack\\\\\\\\.eyeviewads\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn1\\\\\\\\.extremereach\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/secure\\\\\\\\.img-cdn\\\\\\\\.mediaplex\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s4w9z8k2\\\\\\\\.ssl\\\\\\\\.hwcdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/assets\\\\\\\\.scoota\\\\\\\\.co\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/p\\\\\\\\.videologygroup\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.fuel451\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.adform\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.n\\\\\\\\.dynstc\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/dt7qfu63wpsad\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/twcmediasales\\\\\\\\.akamaized\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/creative\\\\\\\\.akamaized\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c1\\\\\\\\.undertonevideo\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/aka\\\\\\\\.spotxcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/videos\\\\\\\\.adforgecdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.atlassbx\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/studiov8-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/scdn-01\\\\\\\\.yumenetworks\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video\\\\\\\\.turncdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/resources\\\\\\\\.eyereturn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cache-ssl\\\\\\\\.celtra\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/adaptvcdn-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s1\\\\\\\\.adformdsp\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/securecdn\\\\\\\\.videologygroup\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/i\\\\\\\\.loopme\\\\\\\\.me\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/swf\\\\\\\\.mixpo\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn-a\\\\\\\\.amazon-adsystem\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdns\\\\\\\\.amgdgt\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cache\\\\\\\\.linkstorm\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.adhigh\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdnsonata\\\\\\\\.taptapnetworks\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/assets\\\\\\\\.tapad\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.splicky\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ad\\\\\\\\.appier\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ads\\\\\\\\.w55c\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/d2qkpebv23oowx\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s2\\\\\\\\.content\\\\\\\\.video\\\\\\\\.llnw\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.giantmedia\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/[^./]+\\\\\\\\.http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/fdi-revs\\\\\\\\.s3-us-west-2\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/www\\\\\\\\.hbd-cm\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/c-609870\\\\\\\\.http\\\\\\\\.atlas\\\\\\\\.cdn\\\\\\\\.yimg\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/streaming\\\\\\\\.emerse\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ced\\\\\\\\.sascdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/live-ssl\\\\\\\\.cdn\\\\\\\\.spongecell\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/static\\\\\\\\.sharethrough\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/s3-eu-west-1\\\\\\\\.amazonaws\\\\\\\\.com\\\\\\\\/4f-affiliates\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?web\\\\\\\\.sundaysky\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/d30cbwo13f9n09\\\\\\\\.cloudfront\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/www\\\\\\\\.youtube\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn01\\\\\\\\.basis\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.visiblemeasures\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.storygize\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/snifreewheelpmd-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/sb\\\\\\\\.bidswitch\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/turbo\\\\\\\\.engageclick\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/i\\\\\\\\.r1-cdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/toots-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/level3cdn\\\\\\\\.screen9\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cstatic\\\\\\\\.weborama\\\\\\\\.fr\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?adgear\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/video-assets\\\\\\\\.brandcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/videocdn\\\\\\\\.adm-vids\\\\\\\\.info\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/files\\\\\\\\.provenpixel\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/cdn2\\\\\\\\.extremereach\\\\\\\\.io\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/server\\\\\\\\.adformdsp\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ad-resources\\\\\\\\.brandcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/brightcove\\\\\\\\.vo\\\\\\\\.llnwd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/brightcove\\\\\\\\.hs\\\\\\\\.llnwd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/udso-a\\\\\\\\.akamaihd\\\\\\\\.net\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.sundaysky\\\\\\\\.com\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/umedia\\\\\\\\.exe\\\\\\\\.bid\\\\\\\\/(([^/]+\\\\\\\\/)+)?[^/]+\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/player\\\\\\\\.mediabong\\\\\\\\.com\\\\\\\\/static\\\\\\\\/videojs\\\\\\\\/black\\\\\\\\.mp4)|(^https?:\\\\\\\\/\\\\\\\\/cdn\\\\\\\\.vindicosuite\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/media\\\\\\\\.adrcdn\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/w\\\\\\\\.swarmdsp\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/jas-prod-cdn\\\\\\\\.juiceserver\\\\\\\\.com\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?fna\\\\\\\\.fbcdn\\\\\\\\.net\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/ocdn\\\\\\\\.eu\\\\\\\\/.*)|(^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?criteo\\\\\\\\.net\\\\\\\\/.*)|(^data:video\\\\\\\\/mp4.*)|(fp\\\\\\\\.dev\\\\\\\\.lumen-research\\\\\\\\.com)|(creative\\\\\\\\.lkqd\\\\\\\\.net)|(sting\\\\\\\\.de17a\\\\\\\\.com)|(vast-videos\\\\\\\\.springserve\\\\\\\\.com)|(^https?:\\\\\\\\/\\\\\\\\/f1\\\\\\\\.media\\\\\\\\.brightcove\\\\\\\\.com\\\\\\\\/.*\\\\\\\\.mp4\\\\\\\\?)|(^https?:\\\\\\\\/\\\\\\\\/p\\\\\\\\.hadvid\\\\\\\\.com\\\\\\\\/)|(^https?:\\\\\\\\/\\\\\\\\/static\\\\\\\\.scanscout\\\\\\\\.com\\\\\\\\/)|(^https?:\\\\\\\\/\\\\\\\\/fo-api\\\\\\\\.omnitagjs\\\\\\\\.com\\\\\\\\/)\\\"};\\nfunction video_url(opt, match){\\n    return new RegExp(match.video_url).test(opt.video_url);\\n}\\nreturn video_url(opt, match);\",\"video_url\":\"^https?:\\\\/\\\\/storage\\\\.googleapis\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn2\\\\.movad\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.simpli\\\\.fi\\\\/ads\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s3\\\\.amazonaws\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.vidible\\\\.tv\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?hes\\\\.themrbinman\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?mediabong\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?cdn-01\\\\.yumenetworks\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?dyjnzf8evxrp2\\\\.cloudfront\\\\.net\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?playtime\\\\.tubemogul\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s-static\\\\.innovid\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?s3\\\\.eu-central-1\\\\.amazonaws\\\\.com\\\\/.*\\\\.(mp4|webm) ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?rezonence\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.teads\\\\.tv\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?rackcdn\\\\.com\\\\/Ads\\\\/.* ^https?:\\\\/\\\\/v\\\\.adsrvr\\\\.org\\\\/.* ^https?:\\\\/\\\\/video-assets\\\\.mathtag\\\\.com\\\\/.* ^https?:\\\\/\\\\/redirector\\\\.gvt1\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.innovid\\\\.com\\\\/.* ^https?:\\\\/\\\\/s1\\\\.adform\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.adap\\\\.tv\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.serving-sys\\\\.com\\\\/.* ^https?:\\\\/\\\\/gcdn\\\\.2mdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn01\\\\.centro\\\\.net\\\\/.* ^https?:\\\\/\\\\/vstatic\\\\.fastclick\\\\.net\\\\/.* ^https?:\\\\/\\\\/vid1\\\\.cdns\\\\.turn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.videoamp\\\\.com\\\\/.* ^https?:\\\\/\\\\/vcdn\\\\.adnxs\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.bidr\\\\.io\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.flashtalking\\\\.com\\\\/.* ^https?:\\\\/\\\\/s\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/a\\\\.runadtag\\\\.com\\\\/.* ^https?:\\\\/\\\\/http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/c3\\\\.rfihub\\\\.net\\\\/.* ^https?:\\\\/\\\\/pixeltrack\\\\.eyeviewads\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn1\\\\.extremereach\\\\.io\\\\/.* ^https?:\\\\/\\\\/secure\\\\.img-cdn\\\\.mediaplex\\\\.com\\\\/.* ^https?:\\\\/\\\\/s4w9z8k2\\\\.ssl\\\\.hwcdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/assets\\\\.scoota\\\\.co\\\\/.* ^https?:\\\\/\\\\/p\\\\.videologygroup\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.fuel451\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.adform\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.n\\\\.dynstc\\\\.com\\\\/.* ^https?:\\\\/\\\\/dt7qfu63wpsad\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/twcmediasales\\\\.akamaized\\\\.net\\\\/.* ^https?:\\\\/\\\\/creative\\\\.akamaized\\\\.net\\\\/.* ^https?:\\\\/\\\\/c1\\\\.undertonevideo\\\\.com\\\\/.* ^https?:\\\\/\\\\/aka\\\\.spotxcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/videos\\\\.adforgecdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.atlassbx\\\\.com\\\\/.* ^https?:\\\\/\\\\/studiov8-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/scdn-01\\\\.yumenetworks\\\\.com\\\\/.* ^https?:\\\\/\\\\/video\\\\.turncdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/resources\\\\.eyereturn\\\\.com\\\\/.* ^https?:\\\\/\\\\/cache-ssl\\\\.celtra\\\\.com\\\\/.* ^https?:\\\\/\\\\/adaptvcdn-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/s1\\\\.adformdsp\\\\.net\\\\/.* ^https?:\\\\/\\\\/securecdn\\\\.videologygroup\\\\.com\\\\/.* ^https?:\\\\/\\\\/i\\\\.loopme\\\\.me\\\\/.* ^https?:\\\\/\\\\/swf\\\\.mixpo\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn-a\\\\.amazon-adsystem\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdns\\\\.amgdgt\\\\.com\\\\/.* ^https?:\\\\/\\\\/cache\\\\.linkstorm\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.adhigh\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdnsonata\\\\.taptapnetworks\\\\.com\\\\/.* ^https?:\\\\/\\\\/assets\\\\.tapad\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.splicky\\\\.com\\\\/.* ^https?:\\\\/\\\\/ad\\\\.appier\\\\.net\\\\/.* ^https?:\\\\/\\\\/ads\\\\.w55c\\\\.net\\\\/.* ^https?:\\\\/\\\\/d2qkpebv23oowx\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/s2\\\\.content\\\\.video\\\\.llnw\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.giantmedia\\\\.com\\\\/.* ^https?:\\\\/\\\\/[^./]+\\\\.http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/fdi-revs\\\\.s3-us-west-2\\\\.amazonaws\\\\.com\\\\/.* ^https?:\\\\/\\\\/www\\\\.hbd-cm\\\\.com\\\\/.* ^https?:\\\\/\\\\/c-609870\\\\.http\\\\.atlas\\\\.cdn\\\\.yimg\\\\.com\\\\/.* ^https?:\\\\/\\\\/streaming\\\\.emerse\\\\.com\\\\/.* ^https?:\\\\/\\\\/ced\\\\.sascdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/live-ssl\\\\.cdn\\\\.spongecell\\\\.com\\\\/.* ^https?:\\\\/\\\\/static\\\\.sharethrough\\\\.com\\\\/.* ^https?:\\\\/\\\\/s3-eu-west-1\\\\.amazonaws\\\\.com\\\\/4f-affiliates\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?web\\\\.sundaysky\\\\.com\\\\/.* ^https?:\\\\/\\\\/d30cbwo13f9n09\\\\.cloudfront\\\\.net\\\\/.* ^https?:\\\\/\\\\/www\\\\.youtube\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn01\\\\.basis\\\\.net\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.visiblemeasures\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn\\\\.storygize\\\\.net\\\\/.* ^https?:\\\\/\\\\/snifreewheelpmd-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/sb\\\\.bidswitch\\\\.net\\\\/.* ^https?:\\\\/\\\\/turbo\\\\.engageclick\\\\.com\\\\/.* ^https?:\\\\/\\\\/i\\\\.r1-cdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/toots-a\\\\.akamaihd\\\\.net\\\\/.* ^https?:\\\\/\\\\/level3cdn\\\\.screen9\\\\.com\\\\/.* ^https?:\\\\/\\\\/cstatic\\\\.weborama\\\\.fr\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?adgear\\\\.com\\\\/.* ^https?:\\\\/\\\\/video-assets\\\\.brandcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/videocdn\\\\.adm-vids\\\\.info\\\\/.* ^https?:\\\\/\\\\/files\\\\.provenpixel\\\\.com\\\\/.* ^https?:\\\\/\\\\/cdn2\\\\.extremereach\\\\.io\\\\/.* ^https?:\\\\/\\\\/server\\\\.adformdsp\\\\.net\\\\/.* ^https?:\\\\/\\\\/ad-resources\\\\.brandcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/brightcove\\\\.vo\\\\.llnwd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/brightcove\\\\.hs\\\\.llnwd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/udso-a\\\\.akamaihd\\\\.net\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/media\\\\.sundaysky\\\\.com\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/umedia\\\\.exe\\\\.bid\\\\/(([^/]+\\\\/)+)?[^/]+\\\\.mp4 ^https?:\\\\/\\\\/player\\\\.mediabong\\\\.com\\\\/static\\\\/videojs\\\\/black\\\\.mp4 ^https?:\\\\/\\\\/cdn\\\\.vindicosuite\\\\.com\\\\/.* ^https?:\\\\/\\\\/media\\\\.adrcdn\\\\.com\\\\/.* ^https?:\\\\/\\\\/w\\\\.swarmdsp\\\\.com\\\\/.* ^https?:\\\\/\\\\/jas-prod-cdn\\\\.juiceserver\\\\.com\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?fna\\\\.fbcdn\\\\.net\\\\/.* ^https?:\\\\/\\\\/ocdn\\\\.eu\\\\/.* ^https?:\\\\/\\\\/(([^./]+\\\\.)+)?criteo\\\\.net\\\\/.* ^data:video\\\\/mp4.* fp\\\\.dev\\\\.lumen-research\\\\.com creative\\\\.lkqd\\\\.net sting\\\\.de17a\\\\.com vast-videos\\\\.springserve\\\\.com  ^https?:\\\\/\\\\/f1\\\\.media\\\\.brightcove\\\\.com\\\\/.*\\\\.mp4\\\\? ^https?:\\\\/\\\\/p\\\\.hadvid\\\\.com\\\\/ ^https?:\\\\/\\\\/static\\\\.scanscout\\\\.com\\\\/ ^https?:\\\\/\\\\/fo-api\\\\.omnitagjs\\\\.com\\\\/\"},\"method\":{\"auto_load_keyframe_map\":false,\"detect_meta_data_location\":false}},\"kw\":{\"customer_active\":1,\"customer_vertical_brand\":1,\"customer_hotline\":1,\"enabled\":1,\"stats\":1,\"bwsaver\":1,\"active\":1,\"monitor_basic\":1,\"monitor_full\":1},\"loader\":{\"match\":{\"allow_frame_match\":true,\"js\":\"var match = {\\\"url\\\":\\\"^https?:\\\\\\\\/\\\\\\\\/(([^./]+\\\\\\\\.)+)?independent\\\\\\\\.co\\\\\\\\.uk\\\\\\\\/.*\\\"};\\nfunction url_or_frame(opt, match){\\n    var re = new RegExp(match.url);\\n    return re.test(opt.url) || re.test(opt.frame_url);\\n}\\nreturn url_or_frame(opt, match);\",\"country\":{},\"url\":[\"^https?:\\\\/\\\\/(([^./]+\\\\.)+)?independent\\\\.co\\\\.uk\\\\/.*\"]},\"rules\":[{\"browser\":\"chrome\",\"os\":\"windows\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chromium_based\",\"os\":\"windows\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"firefox\",\"os\":\"windows\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"ie\",\"os\":\"windows\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"opera\",\"os\":\"windows\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chrome\",\"os\":\"macos\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chromium_based\",\"os\":\"macos\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"firefox\",\"os\":\"macos\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"opera\",\"os\":\"macos\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"safari\",\"os\":\"macos\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chrome\",\"os\":\"linux\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chromium_based\",\"os\":\"linux\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"firefox\",\"os\":\"linux\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"edge\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"browser\":\"chrome\",\"os\":\"android\",\"cdn\":1,\"bwsaver\":0,\"stats\":0,\"display_cdn\":95,\"display_stats\":5},{\"cdn\":0,\"bwsaver\":0,\"stats\":1,\"display_cdn\":0,\"display_stats\":100}]},\"monitor\":{},\"origin_control\":[{\"group\":\"f1.media.brightcove.com\",\"sources\":[\"f1.media.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"f1.media.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"hls.cf.brightcove.com\",\"sources\":[\"hls.cf.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"hls.cf.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"brightcove.hs.llnwd.net\",\"sources\":[\"brightcove.hs.llnwd.net\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"brightcove.hs.llnwd.net\",\"apply\":\"dont_change\"}]}]},{\"group\":\"hls.ak.o.brightcove.com\",\"sources\":[\"hls.ak.o.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"hls.ak.o.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"uds.ak.o.brightcove.com\",\"sources\":[\"uds.ak.o.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"uds.ak.o.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"secure.brightcove.com\",\"sources\":[\"secure.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"secure.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"brightcove01.brightcove.com\",\"sources\":[\"brightcove01.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"brightcove01.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"c.brightcove.com\",\"sources\":[\"c.brightcove.com\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"c.brightcove.com\",\"apply\":\"dont_change\"}]}]},{\"group\":\"brightcove.vo.llnwd.net\",\"sources\":[\"brightcove.vo.llnwd.net\"],\"rules\":[{\"policy\":\"dont_change\",\"select\":\"all\",\"set\":[{\"source\":\"brightcove.vo.llnwd.net\",\"apply\":\"dont_change\"}]}]}],\"player\":{\"brightcove\":{\"account_id\":\"624246174001\",\"policy_key\":\"BCpkADawqM1LWNlVUIra9f4CdCGasxbw_7b7g1OK4bdolCcrbECKEbHyfx2jz6GXPFswTdB76hQ64VA6Fp6HPqKyHwimImO1CxVFXFY13pZ387RC0NZMGBNooo0\"},\"persistent_video\":{\"enabled\":false},\"thumbnails\":{\"enable\":false},\"no_media_size_server\":true},\"portal\":{\"conf\":{},\"match\":{\"url_g\":[\"**.independent.co.uk/**\"]},\"zones\":{}},\"test_urls\":[],\"util\":{\"log\":{\"report\":{\"date\":\"2017-09-21T14:32:10.812Z\",\"user\":\"basic/volodymyr@hola.org\",\"end\":{\"add_log\":0,\"unittest\":0},\"seek\":{\"add_log\":0,\"unittest\":0},\"start\":{\"add_log\":0,\"unittest\":0},\"wait\":{\"add_log\":0,\"unittest\":0}}}},\"video_src_filter_out\":[\"\\n                cdn.adgear.com\\n              \",\"\\n                cdn.admarvel.com\\n              \",\"\\n                cdn.teads.tv\\n              \",\"\\n                cdn2.movad.net\\n              \"],\"wrapper\":{\"methods\":{\"cdn\":[\"hls\",\"hap_hls\",\"hds\",\"dash\"],\"stats\":[\"hls\",\"hap_hls\",\"hds\",\"dash\"]}}}},\"disabled\":false,\"customer\":\"independent_co_uk\",\"loader\":{\"real_random\":false,\"log\":{\"log_level\":\"crit\"},\"stub_modules\":[\"android\",\"dash\",\"flowplayer\",\"flv\",\"ios\",\"jwplayer\",\"mp4box\",\"shaka\",\"webm\",\"youtube\"]},\"test\":{\"tag\":{\"id\":578,\"date\":{\"__ISODate__\":\"2017-10-20T01:30:21.369Z\"}}},\"recalc_bw_date\":{\"__ISODate__\":\"2016-08-01T09:05:51.000Z\"},\"calc_usage\":{\"bw\":0,\"date\":{\"__ISODate__\":\"2016-08-31T07:03:47.000Z\"},\"day\":{\"__ISODate__\":\"2016-08-30T00:00:00.000Z\"},\"dur\":0.245,\"metrics\":30},\"privacy\":false,\"send_impl_reminder\":false,\"send_conf_change\":true,\"provider\":{\"hap_hls_ver\":\"1.0.117\",\"register_percent\":95},\"spark\":{\"autoplay\":{\"desktop\":{\"disable\":false,\"volume_mode\":\"scroll\",\"browsers\":{\"exclude\":[],\"include\":[]},\"urls\":{\"exclude\":[],\"include\":[]}},\"mobile\":{\"disable\":false,\"use_desktop_conf\":true,\"volume_mode\":\"scroll\",\"browsers\":{\"exclude\":[],\"include\":[]},\"urls\":{\"exclude\":[],\"include\":[]}}},\"general\":{\"player\":{\"container\":\"\",\"filter_by_css\":{\"exclude\":[],\"include\":[]}}},\"image_previews\":{\"enable\":true,\"unite_img_and_link\":\"div.grid-mod-half-story, li.story, div.grid-mod-story\",\"browsers\":{\"exclude\":[],\"include\":[]},\"gallery\":{\"attr\":\"data-original\",\"selector\":\".grid-mod-gallery li[data-original]\"},\"imgs_selector\":{\"__Function__\":\"function ($, el){\\n            var imgs = el.find(\\\".image\\\");\\n            if (imgs.length)\\n                return imgs;\\n            if (el.parent().hasClass('image'))\\n                return el.parent();\\n        }\"},\"links_selector\":{\"__Function__\":\"function ($){\\n            var els = $('li.story a, div.image a');\\n            var els_ip = Array.prototype.map.call(els, function(el){ return el.previousElementSibling; })\\n            .filter(function(el) {return el && $(el).hasClass('icon-play');})\\n            .map(function(el){ return el.nextElementSibling; });\\n            return els.not(els.has('.icon-play')).not($(els_ip));\\n        }\"},\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[\"http://www.independent.co.uk/news/world/asia/life-in-yangon-burma-a-beautiful-congested-funky-city-video-10320117.html\"]}},\"persistent\":{\"enable\":false,\"browsers\":{\"exclude\":[],\"include\":[]},\"params\":{\"ad_persistent\":true,\"draggable\":true,\"draggable_head\":true},\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[\"http://www.independent.co.uk/news/uk/home-news/uk-model-italy-kidnap-milan-auction-dark-web-a7878666.html\"]},\"video_url\":{\"exclude\":[],\"include\":[]}},\"playlist\":{\"enable\":true,\"t_enable\":true,\"browsers\":{\"exclude\":[],\"include\":[]},\"conf\":[{\"no_switch\":true,\"redir\":true,\"text\":\"\",\"match\":{\"url\":\"http://www.independent.co.uk/news/world/asia/life-in-yangon-burma-a-beautiful-congested-funky-city-video-10320117.html\"},\"persistent_detect\":{\"__Function__\":\"function (_$, container){\\n                    var c = _$('.bc_container');\\n                    return c.length && c.hasClass('sticky');\\n                }\"},\"selectors\":{\"desc\":\".video-playlist li:first-child h2\",\"img\":\".video-playlist li:first-child img\",\"item\":\".video-playlist li:first-child\",\"link\":\".video-playlist li:first-child a\"}}],\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[]},\"watermark\":{\"enable\":true}},\"thumbnails\":{\"enable\":true,\"browsers\":{\"exclude\":[],\"include\":[]},\"cdns\":[{\"host\":\"147.135.220.236\",\"hostname\":\"zagent1576.h-cdn.com\"}],\"params\":{\"full_frame_thumbnails\":true,\"styles\":[{\"property\":\"position\",\"selector\":\"div.vjs-progress-control.vjs-control\",\"value\":\"relative\"},{\"property\":\"outline\",\"selector\":\".video-js\",\"value\":\"none\"}]},\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[\"http://www.independent.co.uk/news/world/asia/life-in-yangon-burma-a-beautiful-congested-funky-city-video-10320117.html\"]},\"watermark\":{\"enable\":true}},\"video_previews\":{\"auto_mapping\":true,\"enable\":true,\"icon_loader_location\":\"top-right\",\"line_loader\":true,\"links_selector\":\".video-playlist li a, .video-sidebar li a, div.grid-mod-half-story div.image a, li.story a, .grid-mod-four-videos .container-half a, .grid-mod-four-sub-sections div.section a, .grid-mod-collection-sub-section div.section a\",\"preroll\":true,\"unite_img_and_link\":\".video-playlist li, .video-sidebar li, div.grid-mod-half-story div.image, li.story, .grid-mod-four-videos .container-half, .grid-mod-four-sub-sections div.section, .grid-mod-collection-sub-section div.section\",\"browsers\":{\"exclude\":[],\"include\":[]},\"cdn\":{\"host\":\"147.135.220.236\",\"hostname\":\"zagent1576.h-cdn.com\"},\"extra_css_fn\":{\"__Function__\":\"function (){\\n            return {\\n                '.hola_video_preview': {\\n                    height: '100%'\\n                },\\n            };\\n        }\"},\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[\"http://www.independent.co.uk/news/world/asia/life-in-yangon-burma-a-beautiful-congested-funky-city-video-10320117.html\"]},\"watermark\":{\"enable\":true}},\"watch_later\":{\"enable\":true,\"refresh_timeout\":120,\"show_on_refresh\":\"always\",\"base_path\":[\"/\"],\"browsers\":{\"exclude\":[],\"include\":[]},\"platform\":{\"desktop_disabled\":false,\"mobile_disabled\":false},\"urls\":{\"exclude\":[],\"include\":[\"http://www.independent.co.uk/news/world/asia/life-in-yangon-burma-a-beautiful-congested-funky-city-video-10320117.html\"]},\"video_icon\":{\"margin\":{},\"position\":\"tl\"},\"video_url\":{\"exclude\":[],\"include\":[]}}},\"preview\":{\"map_ver\":3},\"customer_status\":\"active\"}",
customer: "independent_co_uk",
agents: [{"hostname":"zagent1230.h-cdn.com","host":"147.135.222.141","country":"FR","pool":"single","type":"single"},{"hostname":"zagent1249.h-cdn.com","host":"144.217.255.209","country":"CA","pool":"single","type":"single"},{"hostname":"zagent918.h-cdn.com","host":"5.79.110.99","country":"NL","pool":"single","type":"single"},{"hostname":"zagent856.h-cdn.com","host":"144.217.79.5","country":"CA","pool":"single","type":"single"},{"hostname":"zagent709.h-cdn.com","host":"144.217.254.124","country":"CA","pool":"single","type":"single"}],
all_agents: {"single":[{"hostname":"zagent2.h-cdn.com","host":"198.27.74.29","country":"CA","pool":"single","type":"single","name":"zagent2","hrw":{"a":-1843546122,"b":-433544043},"geo":{"lat":0.7941946228274996,"long":-1.2841207611670722}},{"hostname":"zagent11.h-cdn.com","host":"95.141.32.92","country":"IT","pool":"single","type":"single","name":"zagent11","hrw":{"a":-1694552619,"b":-588704254},"geo":{"lat":0.8002334620394002,"long":0.19198621771937624}},{"hostname":"zagent55.h-cdn.com","host":"198.255.38.90","country":"US","pool":"single","type":"single","name":"zagent55","hrw":{"a":-1588671226,"b":-1488766183},"geo":{"lat":0.7309020028331774,"long":-1.5293831543035752}},{"hostname":"zagent87.h-cdn.com","host":"198.255.112.234","country":"US","pool":"single","type":"single","name":"zagent87","hrw":{"a":-687598062,"b":1017248608},"geo":{"lat":0.6918205902225203,"long":-1.8309516144386673}},{"hostname":"zagent92.h-cdn.com","host":"95.211.213.97","country":"NL","pool":"single","type":"single","name":"zagent92","hrw":{"a":1775159668,"b":-819859934},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent131.h-cdn.com","host":"50.7.86.90","country":"DE","pool":"single","type":"single","name":"zagent131","hrw":{"a":-1985717927,"b":944332005},"geo":{"lat":0.8746769906247142,"long":0.15153472164590367}},{"hostname":"zagent156.h-cdn.com","host":"95.211.99.135","country":"NL","pool":"single","type":"single","name":"zagent156","hrw":{"a":-1234972379,"b":1055340485},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent157.h-cdn.com","host":"108.59.10.156","country":"US","pool":"single","type":"single","name":"zagent157","hrw":{"a":461839296,"b":-1490832655},"geo":{"lat":0.6924314554607184,"long":-1.3213050008808112}},{"hostname":"zagent159.h-cdn.com","host":"62.76.114.89","country":"RU","pool":"single","type":"single","name":"zagent159","hrw":{"a":-1875102974,"b":1918558107},"geo":{"lat":0.8461495840008669,"long":2.357814155738196}},{"hostname":"zagent164.h-cdn.com","host":"95.211.246.229","country":"NL","pool":"single","type":"single","name":"zagent164","hrw":{"a":587663907,"b":-1110219561},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent231.h-cdn.com","host":"50.7.82.66","country":"ES","pool":"single","type":"single","name":"zagent231","hrw":{"a":-862655002,"b":-206656970},"geo":{"lat":0.707631527916337,"long":-0.06310936042286296}},{"hostname":"zagent232.h-cdn.com","host":"23.237.44.42","country":"US","pool":"single","type":"single","name":"zagent232","hrw":{"a":1788970756,"b":-196530353},"geo":{"lat":0.5942741383285572,"long":-2.064097931907826}},{"hostname":"zagent296.h-cdn.com","host":"173.208.120.210","country":"US","pool":"single","type":"single","name":"zagent296","hrw":{"a":1325719094,"b":1380273975},"geo":{"lat":0.7301968898153717,"long":-1.5352142993344882}},{"hostname":"zagent298.h-cdn.com","host":"209.58.144.150","country":"US","pool":"single","type":"single","name":"zagent298","hrw":{"a":364771382,"b":-1755189656},"geo":{"lat":0.572162562035041,"long":-1.6898399990856738}},{"hostname":"zagent299.h-cdn.com","host":"173.208.111.18","country":"US","pool":"single","type":"single","name":"zagent299","hrw":{"a":-506092057,"b":-675453181},"geo":{"lat":0.5964069306744942,"long":-2.0651014962277228}},{"hostname":"zagent352.h-cdn.com","host":"50.7.74.138","country":"US","pool":"single","type":"single","name":"zagent352","hrw":{"a":47911649,"b":1890555606},"geo":{"lat":0.83102979669084,"long":-2.1353754332300223}},{"hostname":"zagent364.h-cdn.com","host":"88.212.245.12","country":"RU","pool":"single","type":"single","name":"zagent364","hrw":{"a":1887440742,"b":1763351462},"geo":{"lat":0.9728220904521113,"long":0.6563624811390035}},{"hostname":"zagent403.h-cdn.com","host":"88.212.232.36","country":"RU","pool":"single","type":"single","name":"zagent403","hrw":{"a":-1269179284,"b":-584673372},"geo":{"lat":0.9728220904521113,"long":0.6563624811390035}},{"hostname":"zagent405.h-cdn.com","host":"50.7.154.26","country":"GB","pool":"single","type":"single","name":"zagent405","hrw":{"a":-984765221,"b":-326322344},"geo":{"lat":0.899092401530863,"long":-0.0016249015336067209}},{"hostname":"zagent475.h-cdn.com","host":"217.182.174.165","country":"FR","pool":"single","type":"single","name":"zagent475","hrw":{"a":-1646947550,"b":1419915448},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent536.h-cdn.com","host":"212.32.225.101","country":"NL","pool":"single","type":"single","name":"zagent536","hrw":{"a":2087699593,"b":1088908279},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent537.h-cdn.com","host":"212.32.225.99","country":"NL","pool":"single","type":"single","name":"zagent537","hrw":{"a":-1822975869,"b":758227934},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent538.h-cdn.com","host":"212.32.225.98","country":"NL","pool":"single","type":"single","name":"zagent538","hrw":{"a":879598570,"b":935621360},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent539.h-cdn.com","host":"212.32.225.97","country":"NL","pool":"single","type":"single","name":"zagent539","hrw":{"a":938380468,"b":738273172},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent540.h-cdn.com","host":"212.32.225.100","country":"NL","pool":"single","type":"single","name":"zagent540","hrw":{"a":1284801164,"b":94315521},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent541.h-cdn.com","host":"162.210.197.200","country":"US","pool":"single","type":"single","name":"zagent541","hrw":{"a":-215265418,"b":737217111},"geo":{"lat":0.6588792459203793,"long":-1.707315980885893}},{"hostname":"zagent542.h-cdn.com","host":"173.234.245.226","country":"US","pool":"single","type":"single","name":"zagent542","hrw":{"a":2077638551,"b":1918624548},"geo":{"lat":0.713136296377127,"long":-1.298570342044333}},{"hostname":"zagent622.h-cdn.com","host":"23.19.99.98","country":"US","pool":"single","type":"single","name":"zagent622","hrw":{"a":1384787372,"b":-2001791308},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent664.h-cdn.com","host":"69.147.254.138","country":"US","pool":"single","type":"single","name":"zagent664","hrw":{"a":-1006137425,"b":-1826976442},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent698.h-cdn.com","host":"173.234.62.90","country":"US","pool":"single","type":"single","name":"zagent698","hrw":{"a":-2017986451,"b":1283717897},"geo":{"lat":0.730390621362343,"long":-1.529416315559363}},{"hostname":"zagent709.h-cdn.com","host":"144.217.254.124","country":"CA","pool":"single","type":"single","name":"zagent709","hrw":{"a":1724897975,"b":-699463374},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent730.h-cdn.com","host":"88.212.250.132","country":"RU","pool":"single","type":"single","name":"zagent730","hrw":{"a":-1318599309,"b":406075478},"geo":{"lat":0.9728220904521113,"long":0.6563624811390035}},{"hostname":"zagent795.h-cdn.com","host":"23.106.36.222","country":"US","pool":"single","type":"single","name":"zagent795","hrw":{"a":-388096066,"b":1559799080},"geo":{"lat":0.5890137159630463,"long":-1.472810051929431}},{"hostname":"zagent812.h-cdn.com","host":"64.120.46.58","country":"US","pool":"single","type":"single","name":"zagent812","hrw":{"a":-474364490,"b":-285403575},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent839.h-cdn.com","host":"173.208.102.34","country":"US","pool":"single","type":"single","name":"zagent839","hrw":{"a":1927427717,"b":1079613996},"geo":{"lat":0.5890137159630463,"long":-1.472810051929431}},{"hostname":"zagent852.h-cdn.com","host":"144.217.79.7","country":"CA","pool":"single","type":"single","name":"zagent852","hrw":{"a":-1401947574,"b":2007718357},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent854.h-cdn.com","host":"144.217.79.6","country":"CA","pool":"single","type":"single","name":"zagent854","hrw":{"a":-539327153,"b":-2107323901},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent855.h-cdn.com","host":"144.217.79.17","country":"CA","pool":"single","type":"single","name":"zagent855","hrw":{"a":1420498568,"b":889171600},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent856.h-cdn.com","host":"144.217.79.5","country":"CA","pool":"single","type":"single","name":"zagent856","hrw":{"a":46577622,"b":-1836632779},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent857.h-cdn.com","host":"144.217.79.16","country":"CA","pool":"single","type":"single","name":"zagent857","hrw":{"a":-1975276604,"b":1185233725},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent858.h-cdn.com","host":"144.217.79.15","country":"CA","pool":"single","type":"single","name":"zagent858","hrw":{"a":-1496582892,"b":-2074483209},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent859.h-cdn.com","host":"217.182.138.56","country":"FR","pool":"single","type":"single","name":"zagent859","hrw":{"a":-1708141336,"b":-56681765},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent860.h-cdn.com","host":"217.182.174.173","country":"FR","pool":"single","type":"single","name":"zagent860","hrw":{"a":-559075861,"b":781820050},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent861.h-cdn.com","host":"217.182.174.172","country":"FR","pool":"single","type":"single","name":"zagent861","hrw":{"a":1421282614,"b":-311155430},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent862.h-cdn.com","host":"217.182.174.171","country":"FR","pool":"single","type":"single","name":"zagent862","hrw":{"a":1245344623,"b":936218423},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent863.h-cdn.com","host":"217.182.174.170","country":"FR","pool":"single","type":"single","name":"zagent863","hrw":{"a":-2014380647,"b":1843120141},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent864.h-cdn.com","host":"217.182.174.169","country":"FR","pool":"single","type":"single","name":"zagent864","hrw":{"a":-846858636,"b":-1767760612},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent865.h-cdn.com","host":"217.182.174.168","country":"FR","pool":"single","type":"single","name":"zagent865","hrw":{"a":1897667651,"b":-337625943},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent866.h-cdn.com","host":"217.182.174.167","country":"FR","pool":"single","type":"single","name":"zagent866","hrw":{"a":-759710035,"b":-1533238814},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent867.h-cdn.com","host":"217.182.174.166","country":"FR","pool":"single","type":"single","name":"zagent867","hrw":{"a":576738570,"b":-1947864874},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent870.h-cdn.com","host":"147.135.222.145","country":"FR","pool":"single","type":"single","name":"zagent870","hrw":{"a":-1324905661,"b":-766204633},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent871.h-cdn.com","host":"147.135.222.144","country":"FR","pool":"single","type":"single","name":"zagent871","hrw":{"a":1101315812,"b":-656303663},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent872.h-cdn.com","host":"37.187.175.116","country":"FR","pool":"single","type":"single","name":"zagent872","hrw":{"a":1639509390,"b":298743535},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent878.h-cdn.com","host":"209.58.130.220","country":"US","pool":"single","type":"single","name":"zagent878","hrw":{"a":-997854218,"b":-11449491},"geo":{"lat":0.6516849987436587,"long":-2.1274062598654164}},{"hostname":"zagent885.h-cdn.com","host":"209.58.147.205","country":"US","pool":"single","type":"single","name":"zagent885","hrw":{"a":1515373990,"b":-667162010},"geo":{"lat":0.572162562035041,"long":-1.6898399990856738}},{"hostname":"zagent891.h-cdn.com","host":"108.59.14.130","country":"US","pool":"single","type":"single","name":"zagent891","hrw":{"a":-491447050,"b":2044494746},"geo":{"lat":0.6924314554607184,"long":-1.3213050008808112}},{"hostname":"zagent892.h-cdn.com","host":"23.108.191.211","country":"US","pool":"single","type":"single","name":"zagent892","hrw":{"a":-381400908,"b":1010322135},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent897.h-cdn.com","host":"108.59.8.35","country":"US","pool":"single","type":"single","name":"zagent897","hrw":{"a":1135895440,"b":-321674354},"geo":{"lat":0.6924314554607184,"long":-1.3213050008808112}},{"hostname":"zagent898.h-cdn.com","host":"81.171.3.167","country":"NL","pool":"single","type":"single","name":"zagent898","hrw":{"a":-122385270,"b":-1312509969},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent899.h-cdn.com","host":"81.171.3.165","country":"NL","pool":"single","type":"single","name":"zagent899","hrw":{"a":-1008586323,"b":74314755},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent900.h-cdn.com","host":"81.171.3.168","country":"NL","pool":"single","type":"single","name":"zagent900","hrw":{"a":1232330979,"b":1511591143},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent907.h-cdn.com","host":"108.59.8.1","country":"US","pool":"single","type":"single","name":"zagent907","hrw":{"a":1281591370,"b":396877694},"geo":{"lat":0.6924314554607184,"long":-1.3213050008808112}},{"hostname":"zagent914.h-cdn.com","host":"37.48.106.109","country":"NL","pool":"single","type":"single","name":"zagent914","hrw":{"a":1417083200,"b":1322691297},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent917.h-cdn.com","host":"5.79.110.98","country":"NL","pool":"single","type":"single","name":"zagent917","hrw":{"a":-1915227474,"b":1832354968},"geo":{"lat":0.9086812404413198,"long":0.07538251572288708}},{"hostname":"zagent918.h-cdn.com","host":"5.79.110.99","country":"NL","pool":"single","type":"single","name":"zagent918","hrw":{"a":-1244152766,"b":-1036054942},"geo":{"lat":0.9086812404413198,"long":0.07538251572288708}},{"hostname":"zagent920.h-cdn.com","host":"5.79.110.100","country":"NL","pool":"single","type":"single","name":"zagent920","hrw":{"a":-850779985,"b":-1153394889},"geo":{"lat":0.9086812404413198,"long":0.07538251572288708}},{"hostname":"zagent1009.h-cdn.com","host":"217.182.174.159","country":"FR","pool":"single","type":"single","name":"zagent1009","hrw":{"a":1254344829,"b":1041212008},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1230.h-cdn.com","host":"147.135.222.141","country":"FR","pool":"single","type":"single","name":"zagent1230","hrw":{"a":-1294147400,"b":-1731018284},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1249.h-cdn.com","host":"144.217.255.209","country":"CA","pool":"single","type":"single","name":"zagent1249","hrw":{"a":-2039871307,"b":1629822202},"geo":{"lat":0.7909273664677663,"long":-1.2892031599488794}},{"hostname":"zagent1356.h-cdn.com","host":"108.62.115.122","country":"US","pool":"single","type":"single","name":"zagent1356","hrw":{"a":-113507354,"b":1524305162},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent1357.h-cdn.com","host":"172.255.77.147","country":"US","pool":"single","type":"single","name":"zagent1357","hrw":{"a":1496562591,"b":1480428029},"geo":{"lat":0.5877361349505864,"long":-1.9539292588634398}},{"hostname":"zagent1358.h-cdn.com","host":"147.135.222.138","country":"FR","pool":"single","type":"single","name":"zagent1358","hrw":{"a":1825279934,"b":-1510348284},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1359.h-cdn.com","host":"147.135.222.139","country":"FR","pool":"single","type":"single","name":"zagent1359","hrw":{"a":942334560,"b":-532209735},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1498.h-cdn.com","host":"95.211.213.98","country":"NL","pool":"single","type":"single","name":"zagent1498","hrw":{"a":-608408428,"b":-217875282},"geo":{"lat":0.9142453500966776,"long":0.08551240670146217}},{"hostname":"zagent1538.h-cdn.com","host":"217.182.174.179","country":"FR","pool":"single","type":"single","name":"zagent1538","hrw":{"a":1512706185,"b":393553076},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1539.h-cdn.com","host":"217.182.174.180","country":"FR","pool":"single","type":"single","name":"zagent1539","hrw":{"a":-1178057450,"b":494234731},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1540.h-cdn.com","host":"217.182.174.181","country":"FR","pool":"single","type":"single","name":"zagent1540","hrw":{"a":-1648214946,"b":241443632},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}}],"fast":[{"hostname":"zagent24.h-cdn.com","host":"89.163.135.82","country":"DE","pool":"fast","fast_start":true,"type":"fast","name":"zagent24","hrw":{"a":887910285,"b":1641243403},"geo":{"lat":0.8953416889683271,"long":0.16564919930678182}},{"hostname":"zagent155.h-cdn.com","host":"66.70.178.14","country":"CA","pool":"fast","fast_start":true,"type":"fast","name":"zagent155","hrw":{"a":-1762937858,"b":-1883433806},"geo":{"lat":0.7941946228274996,"long":-1.2841207611670722}},{"hostname":"zagent336.h-cdn.com","host":"147.135.220.210","country":"FR","pool":"fast","fast_start":true,"type":"fast","name":"zagent336","hrw":{"a":2100929673,"b":46298639},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent638.h-cdn.com","host":"147.135.220.211","country":"FR","pool":"fast","fast_start":true,"type":"fast","name":"zagent638","hrw":{"a":472617653,"b":381748376},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}},{"hostname":"zagent1577.h-cdn.com","host":"147.135.220.237","country":"FR","pool":"fast","fast_start":true,"type":"fast","name":"zagent1577","hrw":{"a":-1622971282,"b":1197619014},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}}],"efast":[{"hostname":"zagent118.h-cdn.com","host":"158.58.173.48","country":"IT","pool":"fast","efast":1,"fast_start":true,"type":"efast","name":"zagent118","hrw":{"a":415401154,"b":-1628187079},"geo":{"lat":0.793501727114458,"long":0.16038703161201892}},{"hostname":"zagent727.h-cdn.com","host":"145.239.66.192","country":"FR","pool":"fast","efast":1,"fast_start":true,"type":"efast","name":"zagent727","hrw":{"a":1680687511,"b":-1088426070},"geo":{"lat":0.8527364565978934,"long":0.04081801521639138}}]},
version: "1.66.857",
qs_ver: 'ver=1.66.857',
disabled: !!+false,
host: 'player.h-cdn.com',
videojs: '/svc/cdn/pub/video-js.swf?md5=18467-517c596c',
videojs_osmf: '/svc/cdn/pub/videojs-osmf.swf?md5=186245-ec749577',
videojs_flashls: '/svc/cdn/pub/videojs-flashls.swf?md5=74609-97e11010',
videojs5_osmf: '/svc/cdn/pub/videojs5-osmf.swf?md5=189643-2d3bd98a',
videojs5: '/svc/cdn/pub/videojs-5/video-js.swf?md5=92486-46aeeea9',
videojs5_10: '/svc/cdn/pub/videojs_swf_sv.swf?md5=92547-f789b0cf',
videojs5_10_css: '/svc/cdn/pub/css/vjs5_10.css?md5=47687-bb1aae6d',
hola_skin: '/svc/cdn/pub/css/videojs-hola-skin.css?md5=24828-5d4979f2',
thumbnails: '/svc/cdn/pub/css/videojs.thumbnails.css?md5=874-39aa2ea2',
tpl: "/svc/cdn/pub/loader.js?minify=true&snapshot=&host=player.h-cdn.com&percent=undefined",
stats_css: '/css/stats.css?md5=23491-d319d419',
cdngraph_js: '/svc/cdn/pub/cdngraph.js?md5=70771-7b49a398',
debug_js: '/svc/cdn/pub/debug.js?md5=90136-db2e6b8d',
hls_js: '/svc/cdn/pub/hls.js?md5=520963-b0487cff',
flow_hls_engine: '/svc/cdn/pub/flowplayer_hls_engine.js?md5=46554-29f2099a',
flow_dash_engine: '/svc/cdn/pub/flowplayer_dash_engine.js?md5=20155-6413735a',
vjs_hls_provider: '/svc/cdn/pub/vjs_hls_provider.js?md5=12415-3bb37e3a',
vstat: '/svc/cdn/pub/vstat.js?md5=29974-eee6a2bd',
watch_later_css: '/svc/cdn/pub/css/watch_later.css?md5=7364-aecc9a17',
watch_later_add_svg: '/svc/cdn/pub/img/watch_later_add.svg?md5=745-58cecff7',
watch_later_wait_gif: '/svc/cdn/pub/img/watch_later_wait.gif?md5=29931-34fa5045',
watch_later_done_svg: '/svc/cdn/pub/img/watch_later_done.svg?md5=1536-95619268',
playlist_css: '/svc/cdn/pub/css/playlist.css?md5=2081-9b2b383d',
}[name];
return{}[name]};var console=window.console;function ie9_console(){if(console)return;console={log:function(){},error:function(){}}}ie9_console();function escape_qs(param,opt){opt=opt||{};var qs=opt.qs||"";var sep=qs||opt.amp?"&":"";if(!param)return qs;var uri_comp=encodeURIComponent;var uri_comp_val=uri_comp;for(var i in param){var val=param[i];if(val===undefined)continue;var key=uri_comp(i);qs+=sep;if(val===null)qs+=key;else if(Array.isArray(val)){if(!val.length)continue;qs+=val.map(function(val){return key+"="+uri_comp_val(val)}).join("&")}else qs+=key+"="+uri_comp_val(val);sep="&"}return qs}function send_beacon(url,data){if(navigator&&navigator.sendBeacon){if(navigator.sendBeacon(url,to_form_data(data)))return}var is_xdr=window.XDomainRequest!==undefined;var xhr=is_xdr?new XDomainRequest:new XMLHttpRequest;xhr.open("POST",url);if(window.FormData&&!is_xdr)data=to_form_data(data);else{data=escape_qs(data);if(!is_xdr){xhr.setRequestHeader("Accept","*/*");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8")}else{return}}xhr.send(data)}function to_form_data(o){var data=new FormData;for(var k in o)data.append(k,o[k]);return data}function perr_raw(opt){var data={},qs={},zone,ver,hola_mode;if(window.hola_cdn){zone=window.hola_cdn.zone;ver=window.hola_cdn.ver;hola_mode=window.hola_cdn.mode}qs.browser=window.chrome?"chrome":"other";qs.id=opt.id;qs.ver=ver;data.build="platform: "+navigator.platform+"\n"+"user_agent: "+navigator.userAgent;data.is_json=1;data.info=opt.info||{};data.info.customer=customer;data.info.zone=zone;data.info.hola_mode=hola_mode;data.info.location_url=location.href;data.info.referrer=document.referrer;data.info=JSON.stringify(data.info);data.bt=opt.bt;var protocol=window&&window.location&&window.location.protocol;protocol=!protocol||!protocol.startsWith("http")?"http:":protocol;var url=protocol+"//perr.h-cdn.com/be_client_cgi/perr?"+escape_qs(qs);send_beacon(url,data)}function array_reduce(callback){if(this===null){throw new TypeError("Array.prototype.reduce called on null or"+" undefined")}if(typeof callback!=="function")throw new TypeError(callback+" is not a function");var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length==2)value=arguments[1];else{while(k<len&&!(k in t))k++;if(k>=len)throw new TypeError("Reduce of empty array with no initial value");value=t[k++]}for(;k<len;k++){if(k in t)value=callback(value,t[k],k,t)}return value}function fix_obj_props(obj,prop,test,fix){if(!obj[prop]||!test()){if(!fix)return;obj[prop]=fix}Object.defineProperty(obj,prop,{writable:false})}var site_errors,hola_errors,js_errors,ldr_errors,is_loader;var customer=E.zdot("customer"),tpl=E.zdot("tpl");is_loader=/^\/svc\/cdn\/pub\/loader.js/.test(tpl);if(is_loader){window.addEventListener("error",function(e){try{var send_perr;js_errors=(js_errors||0)+1;if(e.error){if(/\.h-cdn.com/.test(e.filename)){hola_errors=(hola_errors||0)+1;send_perr=hola_errors==1}else site_errors=(site_errors||0)+1}if(send_perr){perr_raw({id:"www_cdn_db_hola_js_error",bt:(e.error||{}).stack,info:{filename:e.filename,err:""+e.error,hola_errors:hola_errors,js_errors:js_errors,site_errors:site_errors,ldr_errors:ldr_errors}})}}catch(err){console.error("ldr_require error handler error",err);ldr_errors=(ldr_errors||0)+1}})}fix_obj_props(Array.prototype,"reduce",function(){return[].reduce(String,1)==1},array_reduce);if(window.Prototype){delete Object.prototype.toJSON;delete Array.prototype.toJSON;delete String.prototype.toJSON;delete Number.prototype.toJSON;for(var p in[])Object.defineProperty(Array.prototype,p,{enumerable:false})}E.module_registry={};E.aliases={};E.config=function(config){if(config.map!==undefined)E.aliases=config.map};function init_module(module,req){if(module.inited==true)return module.init;var args=get_args(module);if(module.inited==true)return module.init;module.init=typeof module.init!=="function"?module.init:module.init.apply(null,args);if(module.init instanceof Object){for(var prop in module.exports){if(module.exports.hasOwnProperty(prop))module.init[prop]=module.exports[prop]}}else if(!module.init){console.error("empty module: "+req);ldr_errors=(ldr_errors||0)+1}else module.init=module.exports;module.inited=true;return module.init}function get_args(requirments){var args=[];var reqs=Array.isArray(requirments)?requirments:requirments.reqs;for(var i=0,len=reqs.length;i<len;i++){var req=reqs[i];switch(req){case"exports":if(!requirments.exports)throw new Error("ldr_require: invalid dependence!");args.push(requirments.exports);break;default:var module=E.module_registry[req]||(E.aliases[req]?E.module_registry[E.aliases[req]]:undefined);if(!module)throw new Error("ldr_require: missing module: "+req);args.push(init_module(module,req));break}}return args}E.define=function(name,requirements,init){if(typeof name!="string")throw new Error("ldr_require: module name is needed");if(init===undefined&&!Array.isArray(requirements)){init=requirements;requirements=[]}E.module_registry[name]={init:init,reqs:requirements,inited:false,exports:{}}};E.specified=function(name){return!!E.module_registry[name]};E.require=function(requirements,fn){fn.apply(null,get_args(requirements))};if(is_loader)window.hola_cdn_require=E.require})();function define(name,deps,init){if(hola_ldr_require)return hola_ldr_require.define(name,deps,init)}define.amd=true;function require(reqs,fn){if(hola_ldr_require)return hola_ldr_require.require(reqs,fn)}require.config=function(){return require};require.specified=function(name){return hola_ldr_require.specified(name)};require.zdot=function(name){return hola_ldr_require.zdot(name)};define("/svc/cdn/pub/ldr_require.js",function(){});
(function(global){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=function(name,setup){module.exports=setup()};define("/svc/cdn/pub/typedarray_shim.js",[],function(){var E={};if(is_node_ff||typeof ArrayBuffer!="undefined")return E;var MAX_ARRAY_LENGTH=1e5;function Type(v){switch(typeof v){case"undefined":return"undefined";case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return v===null?"null":"object"}}function Class(v){return Object.prototype.toString.call(v).replace(/^\[object *|\]$/g,"")}function IsCallable(o){return typeof o==="function"}function ToObject(v){if(v===null||v===undefined)throw TypeError();return Object(v)}function ToInt32(v){return v>>0}function ToUint32(v){return v>>>0}var LN2=Math.LN2,abs=Math.abs,floor=Math.floor,log=Math.log,max=Math.max,min=Math.min,pow=Math.pow,round=Math.round;(function(){var orig=Object.defineProperty;var dom_only=!function(){try{return Object.defineProperty({},"x",{})}catch(_){return false}}();if(!orig||dom_only){Object.defineProperty=function(o,prop,desc){if(orig)try{return orig(o,prop,desc)}catch(_){}if(o!==Object(o))throw TypeError("Object.defineProperty called on non-object");if(Object.prototype.__defineGetter__&&"get"in desc)Object.prototype.__defineGetter__.call(o,prop,desc.get);if(Object.prototype.__defineSetter__&&"set"in desc)Object.prototype.__defineSetter__.call(o,prop,desc.set);if("value"in desc)o[prop]=desc.value;return o}}})();function makeArrayAccessors(obj){if(obj.length>MAX_ARRAY_LENGTH)throw RangeError("Array too large for polyfill");function makeArrayAccessor(index){Object.defineProperty(obj,index,{get:function(){return obj._getter(index)},set:function(v){obj._setter(index,v)},enumerable:true,configurable:false})}var i;for(i=0;i<obj.length;i+=1){makeArrayAccessor(i)}}function as_signed(value,bits){var s=32-bits;return value<<s>>s}function as_unsigned(value,bits){var s=32-bits;return value<<s>>>s}function packI8(n){return[n&255]}function unpackI8(bytes){return as_signed(bytes[0],8)}function packU8(n){return[n&255]}function unpackU8(bytes){return as_unsigned(bytes[0],8)}function packU8Clamped(n){n=round(Number(n));return[n<0?0:n>255?255:n&255]}function packI16(n){return[n&255,n>>8&255]}function unpackI16(bytes){return as_signed(bytes[1]<<8|bytes[0],16)}function packU16(n){return[n&255,n>>8&255]}function unpackU16(bytes){return as_unsigned(bytes[1]<<8|bytes[0],16)}function packI32(n){return[n&255,n>>8&255,n>>16&255,n>>24&255]}function unpackI32(bytes){return as_signed(bytes[3]<<24|bytes[2]<<16|bytes[1]<<8|bytes[0],32)}function packU32(n){return[n&255,n>>8&255,n>>16&255,n>>24&255]}function unpackU32(bytes){return as_unsigned(bytes[3]<<24|bytes[2]<<16|bytes[1]<<8|bytes[0],32)}function packIEEE754(v,ebits,fbits){var bias=(1<<ebits-1)-1;function roundToEven(n){var w=floor(n),f=n-w;if(f<.5)return w;if(f>.5)return w+1;return w%2?w+1:w}var s,e,f;if(v!==v){e=(1<<ebits)-1;f=pow(2,fbits-1);s=0}else if(v===Infinity||v===-Infinity){e=(1<<ebits)-1;f=0;s=v<0?1:0}else if(v===0){e=0;f=0;s=1/v===-Infinity?1:0}else{s=v<0;v=abs(v);if(v>=pow(2,1-bias)){e=min(floor(log(v)/LN2),1023);var significand=v/pow(2,e);if(significand<1){e-=1;significand*=2}if(significand>=2){e+=1;significand/=2}var d=pow(2,fbits);f=roundToEven(significand*d)-d;e+=bias;if(f/d>=1){e+=1;f=0}if(e>2*bias){e=(1<<ebits)-1;f=0}}else{e=0;f=roundToEven(v/pow(2,1-bias-fbits))}}var bits=[],i;for(i=fbits;i;i-=1){bits.push(f%2?1:0);f=floor(f/2)}for(i=ebits;i;i-=1){bits.push(e%2?1:0);e=floor(e/2)}bits.push(s?1:0);bits.reverse();var str=bits.join("");var bytes=[];while(str.length){bytes.unshift(parseInt(str.substring(0,8),2));str=str.substring(8)}return bytes}function unpackIEEE754(bytes,ebits,fbits){var bits=[],i,j,b,str,bias,s,e,f;for(i=0;i<bytes.length;++i){b=bytes[i];for(j=8;j;j-=1){bits.push(b%2?1:0);b=b>>1}}bits.reverse();str=bits.join("");bias=(1<<ebits-1)-1;s=parseInt(str.substring(0,1),2)?-1:1;e=parseInt(str.substring(1,1+ebits),2);f=parseInt(str.substring(1+ebits),2);if(e===(1<<ebits)-1){return f!==0?NaN:s*Infinity}else if(e>0){return s*pow(2,e-bias)*(1+f/pow(2,fbits))}else if(f!==0){return s*pow(2,-(bias-1))*(f/pow(2,fbits))}else{return s<0?-0:0}}function unpackF64(b){return unpackIEEE754(b,11,52)}function packF64(v){return packIEEE754(v,11,52)}function unpackF32(b){return unpackIEEE754(b,8,23)}function packF32(v){return packIEEE754(v,8,23)}(function(){function ArrayBuffer(length){length=ToInt32(length);if(length<0)throw RangeError("ArrayBuffer size is not a small enough positive integer.");Object.defineProperty(this,"byteLength",{value:length});Object.defineProperty(this,"_bytes",{value:Array(length)});for(var i=0;i<length;i+=1)this._bytes[i]=0}global.ArrayBuffer=global.ArrayBuffer||ArrayBuffer;function $TypedArray$(){if(!arguments.length||typeof arguments[0]!=="object"){return function(length){length=ToInt32(length);if(length<0)throw RangeError("length is not a small enough positive integer.");Object.defineProperty(this,"length",{value:length});Object.defineProperty(this,"byteLength",{value:length*this.BYTES_PER_ELEMENT});Object.defineProperty(this,"buffer",{value:new ArrayBuffer(this.byteLength)});Object.defineProperty(this,"byteOffset",{value:0})}.apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&arguments[0]instanceof $TypedArray$){return function(typedArray){if(this.constructor!==typedArray.constructor)throw TypeError();var byteLength=typedArray.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:0});Object.defineProperty(this,"length",{value:typedArray.length});for(var i=0;i<this.length;i+=1)this._setter(i,typedArray._getter(i))}.apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&!(arguments[0]instanceof $TypedArray$)&&!(arguments[0]instanceof ArrayBuffer||Class(arguments[0])==="ArrayBuffer")){return function(array){var byteLength=array.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:0});Object.defineProperty(this,"length",{value:array.length});for(var i=0;i<this.length;i+=1){var s=array[i];this._setter(i,Number(s))}}.apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&(arguments[0]instanceof ArrayBuffer||Class(arguments[0])==="ArrayBuffer")){return function(buffer,byteOffset,length){var byteLength;byteOffset=ToUint32(byteOffset);if(byteOffset>buffer.byteLength)throw RangeError("byteOffset out of range");if(byteOffset%this.BYTES_PER_ELEMENT)throw RangeError("buffer length minus the byteOffset is not a multiple of the element size.");if(length===undefined){byteLength=buffer.byteLength-byteOffset;if(byteLength%this.BYTES_PER_ELEMENT)throw RangeError("length of buffer minus byteOffset not a multiple of the element size");length=byteLength/this.BYTES_PER_ELEMENT}else{length=ToUint32(length);byteLength=length*this.BYTES_PER_ELEMENT}if(byteOffset+byteLength>buffer.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:buffer});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:byteOffset});Object.defineProperty(this,"length",{value:length})}.apply(this,arguments)}throw TypeError()}Object.defineProperty($TypedArray$,"from",{value:function(iterable){return new this(iterable)}});Object.defineProperty($TypedArray$,"of",{value:function(){return new this(arguments)}});var $TypedArrayPrototype$={};$TypedArray$.prototype=$TypedArrayPrototype$;Object.defineProperty($TypedArray$.prototype,"_getter",{value:function(index){if(arguments.length<1)throw SyntaxError("Not enough arguments");index=ToUint32(index);if(index>=this.length)return undefined;var bytes=[],i,o;for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1){bytes.push(this.buffer._bytes[o])}return this._unpack(bytes)}});Object.defineProperty($TypedArray$.prototype,"get",{value:$TypedArray$.prototype._getter});Object.defineProperty($TypedArray$.prototype,"_setter",{value:function(index,value){if(arguments.length<2)throw SyntaxError("Not enough arguments");index=ToUint32(index);if(index>=this.length)return;var bytes=this._pack(value),i,o;for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1){this.buffer._bytes[o]=bytes[i]}}});Object.defineProperty($TypedArray$.prototype,"constructor",{value:$TypedArray$});Object.defineProperty($TypedArray$.prototype,"copyWithin",{value:function(target,start){var end=arguments[2];var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);len=max(len,0);var relativeTarget=ToInt32(target);var to;if(relativeTarget<0)to=max(len+relativeTarget,0);else to=min(relativeTarget,len);var relativeStart=ToInt32(start);var from;if(relativeStart<0)from=max(len+relativeStart,0);else from=min(relativeStart,len);var relativeEnd;if(end===undefined)relativeEnd=len;else relativeEnd=ToInt32(end);var final_;if(relativeEnd<0)final_=max(len+relativeEnd,0);else final_=min(relativeEnd,len);var count=min(final_-from,len-to);var direction;if(from<to&&to<from+count){direction=-1;from=from+count-1;to=to+count-1}else{direction=1}while(count>0){o._setter(to,o._getter(from));from=from+direction;to=to+direction;count=count-1}return o}});Object.defineProperty($TypedArray$.prototype,"every",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var thisArg=arguments[1];for(var i=0;i<len;i++){if(!callbackfn.call(thisArg,t._getter(i),i,t))return false}return true}});Object.defineProperty($TypedArray$.prototype,"fill",{value:function(value){var start=arguments[1],end=arguments[2];var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);len=max(len,0);var relativeStart=ToInt32(start);var k;if(relativeStart<0)k=max(len+relativeStart,0);else k=min(relativeStart,len);var relativeEnd;if(end===undefined)relativeEnd=len;else relativeEnd=ToInt32(end);var final_;if(relativeEnd<0)final_=max(len+relativeEnd,0);else final_=min(relativeEnd,len);while(k<final_){o._setter(k,value);k+=1}return o}});Object.defineProperty($TypedArray$.prototype,"filter",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var res=[];var thisp=arguments[1];for(var i=0;i<len;i++){var val=t._getter(i);if(callbackfn.call(thisp,val,i,t))res.push(val)}return new this.constructor(res)}});Object.defineProperty($TypedArray$.prototype,"find",{value:function(predicate){var o=ToObject(this);var lenValue=o.length;var len=ToUint32(lenValue);if(!IsCallable(predicate))throw TypeError();var t=arguments.length>1?arguments[1]:undefined;var k=0;while(k<len){var kValue=o._getter(k);var testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult))return kValue;++k}return undefined}});Object.defineProperty($TypedArray$.prototype,"findIndex",{value:function(predicate){var o=ToObject(this);var lenValue=o.length;var len=ToUint32(lenValue);if(!IsCallable(predicate))throw TypeError();var t=arguments.length>1?arguments[1]:undefined;var k=0;while(k<len){var kValue=o._getter(k);var testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult))return k;++k}return-1}});Object.defineProperty($TypedArray$.prototype,"forEach",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var thisp=arguments[1];for(var i=0;i<len;i++)callbackfn.call(thisp,t._getter(i),i,t)}});Object.defineProperty($TypedArray$.prototype,"indexOf",{value:function(searchElement){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(len===0)return-1;var n=0;if(arguments.length>0){n=Number(arguments[1]);if(n!==n){n=0}else if(n!==0&&n!==1/0&&n!==-(1/0)){n=(n>0||-1)*floor(abs(n))}}if(n>=len)return-1;var k=n>=0?n:max(len-abs(n),0);for(;k<len;k++){if(t._getter(k)===searchElement){return k}}return-1}});Object.defineProperty($TypedArray$.prototype,"join",{value:function(separator){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);var tmp=Array(len);for(var i=0;i<len;++i)tmp[i]=t._getter(i);return tmp.join(separator===undefined?",":separator)}});Object.defineProperty($TypedArray$.prototype,"lastIndexOf",{value:function(searchElement){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(len===0)return-1;var n=len;if(arguments.length>1){n=Number(arguments[1]);if(n!==n){n=0}else if(n!==0&&n!==1/0&&n!==-(1/0)){n=(n>0||-1)*floor(abs(n))}}var k=n>=0?min(n,len-1):len-abs(n);for(;k>=0;k--){if(t._getter(k)===searchElement)return k}return-1}});Object.defineProperty($TypedArray$.prototype,"map",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var res=[];res.length=len;var thisp=arguments[1];for(var i=0;i<len;i++)res[i]=callbackfn.call(thisp,t._getter(i),i,t);return new this.constructor(res)}});Object.defineProperty($TypedArray$.prototype,"reduce",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();if(len===0&&arguments.length===1)throw TypeError();var k=0;var accumulator;if(arguments.length>=2){accumulator=arguments[1]}else{accumulator=t._getter(k++)}while(k<len){accumulator=callbackfn.call(undefined,accumulator,t._getter(k),k,t);k++}return accumulator}});Object.defineProperty($TypedArray$.prototype,"reduceRight",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();if(len===0&&arguments.length===1)throw TypeError();var k=len-1;var accumulator;if(arguments.length>=2){accumulator=arguments[1]}else{accumulator=t._getter(k--)}while(k>=0){accumulator=callbackfn.call(undefined,accumulator,t._getter(k),k,t);k--}return accumulator}});Object.defineProperty($TypedArray$.prototype,"reverse",{value:function(){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);var half=floor(len/2);for(var i=0,j=len-1;i<half;++i,--j){var tmp=t._getter(i);t._setter(i,t._getter(j));t._setter(j,tmp)}return t}});Object.defineProperty($TypedArray$.prototype,"set",{value:function(index,value){if(arguments.length<1)throw SyntaxError("Not enough arguments");var array,sequence,offset,len,i,s,d,byteOffset,byteLength,tmp;if(typeof arguments[0]==="object"&&arguments[0].constructor===this.constructor){array=arguments[0];offset=ToUint32(arguments[1]);if(offset+array.length>this.length){throw RangeError("Offset plus length of array is out of range")}byteOffset=this.byteOffset+offset*this.BYTES_PER_ELEMENT;byteLength=array.length*this.BYTES_PER_ELEMENT;if(array.buffer===this.buffer){tmp=[];for(i=0,s=array.byteOffset;i<byteLength;i+=1,s+=1){tmp[i]=array.buffer._bytes[s]}for(i=0,d=byteOffset;i<byteLength;i+=1,d+=1){this.buffer._bytes[d]=tmp[i]}}else{for(i=0,s=array.byteOffset,d=byteOffset;i<byteLength;i+=1,s+=1,d+=1){this.buffer._bytes[d]=array.buffer._bytes[s]}}}else if(typeof arguments[0]==="object"&&typeof arguments[0].length!=="undefined"){sequence=arguments[0];len=ToUint32(sequence.length);offset=ToUint32(arguments[1]);if(offset+len>this.length){throw RangeError("Offset plus length of array is out of range")}for(i=0;i<len;i+=1){s=sequence[i];this._setter(offset+i,Number(s))}}else{throw TypeError("Unexpected argument type(s)")}}});Object.defineProperty($TypedArray$.prototype,"slice",{value:function(start,end){var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);var relativeStart=ToInt32(start);var k=relativeStart<0?max(len+relativeStart,0):min(relativeStart,len);var relativeEnd=end===undefined?len:ToInt32(end);var final_=relativeEnd<0?max(len+relativeEnd,0):min(relativeEnd,len);var count=final_-k;var c=o.constructor;var a=new c(count);var n=0;while(k<final_){var kValue=o._getter(k);a._setter(n,kValue);++k;++n}return a}});Object.defineProperty($TypedArray$.prototype,"some",{value:function(callbackfn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn))throw TypeError();var thisp=arguments[1];for(var i=0;i<len;i++){if(callbackfn.call(thisp,t._getter(i),i,t)){return true}}return false}});Object.defineProperty($TypedArray$.prototype,"sort",{value:function(comparefn){if(this===undefined||this===null)throw TypeError();var t=Object(this);var len=ToUint32(t.length);var tmp=Array(len);for(var i=0;i<len;++i)tmp[i]=t._getter(i);if(comparefn)tmp.sort(comparefn);else tmp.sort();for(i=0;i<len;++i)t._setter(i,tmp[i]);return t}});Object.defineProperty($TypedArray$.prototype,"subarray",{value:function(start,end){function clamp(v,min,max){return v<min?min:v>max?max:v}start=ToInt32(start);end=ToInt32(end);if(arguments.length<1){start=0}if(arguments.length<2){end=this.length}if(start<0){start=this.length+start}if(end<0){end=this.length+end}start=clamp(start,0,this.length);end=clamp(end,0,this.length);var len=end-start;if(len<0){len=0}return new this.constructor(this.buffer,this.byteOffset+start*this.BYTES_PER_ELEMENT,len)}});function makeTypedArray(elementSize,pack,unpack){var TypedArray=function(){Object.defineProperty(this,"constructor",{value:TypedArray});$TypedArray$.apply(this,arguments);if(0)makeArrayAccessors(this)};if("__proto__"in TypedArray){TypedArray.__proto__=$TypedArray$}else{TypedArray.from=$TypedArray$.from;TypedArray.of=$TypedArray$.of}TypedArray.BYTES_PER_ELEMENT=elementSize;var TypedArrayPrototype=function(){};TypedArrayPrototype.prototype=$TypedArrayPrototype$;TypedArray.prototype=new TypedArrayPrototype;Object.defineProperty(TypedArray.prototype,"BYTES_PER_ELEMENT",{value:elementSize});Object.defineProperty(TypedArray.prototype,"_pack",{value:pack});Object.defineProperty(TypedArray.prototype,"_unpack",{value:unpack});return TypedArray}var Int8Array=makeTypedArray(1,packI8,unpackI8);var Uint8Array=makeTypedArray(1,packU8,unpackU8);var Uint8ClampedArray=makeTypedArray(1,packU8Clamped,unpackU8);var Int16Array=makeTypedArray(2,packI16,unpackI16);var Uint16Array=makeTypedArray(2,packU16,unpackU16);var Int32Array=makeTypedArray(4,packI32,unpackI32);var Uint32Array=makeTypedArray(4,packU32,unpackU32);var Float32Array=makeTypedArray(4,packF32,unpackF32);var Float64Array=makeTypedArray(8,packF64,unpackF64);global.Int8Array=global.Int8Array||Int8Array;global.Uint8Array=global.Uint8Array||Uint8Array;global.Uint8ClampedArray=global.Uint8ClampedArray||Uint8ClampedArray;global.Int16Array=global.Int16Array||Int16Array;global.Uint16Array=global.Uint16Array||Uint16Array;global.Int32Array=global.Int32Array||Int32Array;global.Uint32Array=global.Uint32Array||Uint32Array;global.Float32Array=global.Float32Array||Float32Array;global.Float64Array=global.Float64Array||Float64Array})();(function(){function r(array,index){return IsCallable(array.get)?array.get(index):array[index]}var IS_BIG_ENDIAN=function(){var u16array=new Uint16Array([4660]),u8array=new Uint8Array(u16array.buffer);return r(u8array,0)===18}();function DataView(buffer,byteOffset,byteLength){if(!(buffer instanceof ArrayBuffer||Class(buffer)==="ArrayBuffer"))throw TypeError();byteOffset=ToUint32(byteOffset);if(byteOffset>buffer.byteLength)throw RangeError("byteOffset out of range");if(byteLength===undefined)byteLength=buffer.byteLength-byteOffset;else byteLength=ToUint32(byteLength);if(byteOffset+byteLength>buffer.byteLength)throw RangeError("byteOffset and length reference an area beyond the end of the buffer");Object.defineProperty(this,"buffer",{value:buffer});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:byteOffset})}function makeGetter(arrayType){return function GetViewValue(byteOffset,littleEndian){byteOffset=ToUint32(byteOffset);if(byteOffset+arrayType.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");byteOffset+=this.byteOffset;var uint8Array=new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT),bytes=[];for(var i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1)bytes.push(r(uint8Array,i));if(Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN))bytes.reverse();return r(new arrayType(new Uint8Array(bytes).buffer),0)}}Object.defineProperty(DataView.prototype,"getUint8",{value:makeGetter(Uint8Array)});Object.defineProperty(DataView.prototype,"getInt8",{value:makeGetter(Int8Array)});Object.defineProperty(DataView.prototype,"getUint16",{value:makeGetter(Uint16Array)});Object.defineProperty(DataView.prototype,"getInt16",{value:makeGetter(Int16Array)});Object.defineProperty(DataView.prototype,"getUint32",{value:makeGetter(Uint32Array)});Object.defineProperty(DataView.prototype,"getInt32",{value:makeGetter(Int32Array)});Object.defineProperty(DataView.prototype,"getFloat32",{value:makeGetter(Float32Array)});Object.defineProperty(DataView.prototype,"getFloat64",{value:makeGetter(Float64Array)});function makeSetter(arrayType){return function SetViewValue(byteOffset,value,littleEndian){byteOffset=ToUint32(byteOffset);if(byteOffset+arrayType.BYTES_PER_ELEMENT>this.byteLength)throw RangeError("Array index out of range");var typeArray=new arrayType([value]),byteArray=new Uint8Array(typeArray.buffer),bytes=[],i,byteView;for(i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1)bytes.push(r(byteArray,i));if(Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN))bytes.reverse();byteView=new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT);byteView.set(bytes)}}Object.defineProperty(DataView.prototype,"setUint8",{value:makeSetter(Uint8Array)});Object.defineProperty(DataView.prototype,"setInt8",{value:makeSetter(Int8Array)});Object.defineProperty(DataView.prototype,"setUint16",{value:makeSetter(Uint16Array)});Object.defineProperty(DataView.prototype,"setInt16",{value:makeSetter(Int16Array)});Object.defineProperty(DataView.prototype,"setUint32",{value:makeSetter(Uint32Array)});Object.defineProperty(DataView.prototype,"setInt32",{value:makeSetter(Int32Array)});Object.defineProperty(DataView.prototype,"setFloat32",{value:makeSetter(Float32Array)});Object.defineProperty(DataView.prototype,"setFloat64",{value:makeSetter(Float64Array)});global.DataView=global.DataView||DataView})();return E})})(this);
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=function(setup){module.exports=setup()};define("/util/es6_shim.js",[],function(){var E={t:{}};function add_prop(obj,prop,fn){if(obj[prop])return;Object.defineProperty(obj,prop,{enumerable:false,writable:true,configurable:true,value:fn})}E.t.object_assign=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(source.hasOwnProperty(prop))obj[prop]=source[prop]}}return obj};add_prop(Object,"assign",E.t.object_assign);E.t.object_values=function(obj){if(obj==null)throw new TypeError("Cannot convert undefined or null to object");var res=[];for(var prop in obj){if(obj.hasOwnProperty(prop))res.push(obj[prop])}return res};add_prop(Object,"values",E.t.object_values);E.t.object_entries=function(obj){if(obj==null)throw new TypeError("Cannot convert undefined or null to object");var res=[];for(var prop in obj){if(obj.hasOwnProperty(prop))res.push([prop,obj[prop]])}return res};add_prop(Object,"entries",E.t.object_entries);var can_set_proto={__proto__:[]}instanceof Array;E.t.object_setPrototypeOf=function(obj,proto){if(can_set_proto)obj.__proto__=proto;else{for(var prop in proto)obj[prop]=proto[prop]}return true};add_prop(Object,"setPrototypeOf",E.t.object_setPrototypeOf);E.t.string_startsWith=function(head){head=""+head;return!head||this.slice(0,head.length)===head};add_prop(String.prototype,"startsWith",E.t.string_startsWith);E.t.string_endsWith=function(tail){tail=""+tail;return!tail||this.slice(-tail.length)==tail};add_prop(String.prototype,"endsWith",E.t.string_endsWith);E.t.string_includes=function(search,index){return this.indexOf(search,index)>=0};add_prop(String.prototype,"includes",E.t.string_includes);E.t.string_repeat=function(n){var s="";for(var i=0;i<n;i++)s+=this;return s};add_prop(String.prototype,"repeat",E.t.string_repeat);E.t.string_trimLeft=function(){return this.replace(/^\s+/,"")};add_prop(String.prototype,"trimLeft",E.t.string_trimLeft);E.t.string_trimRight=function(){return this.replace(/\s+$/,"")};add_prop(String.prototype,"trimRight",E.t.string_trimRight);E.t.string_padStart=function(len,val){val=val||" ";var l=len-this.length;return l<=0?this:val.repeat(Math.ceil(l/val.length)).slice(0,l)+this};add_prop(String.prototype,"padStart",E.t.string_padStart);E.t.string_padEnd=function(len,val){val=val||" ";var l=len-this.length;return l<=0?this:this+val.repeat(Math.ceil(l/val.length)).slice(0,l)};add_prop(String.prototype,"padEnd",E.t.string_padEnd);E.t.array_includes=function(search,index){return this.indexOf(search,index)>=0};add_prop(Array.prototype,"includes",E.t.array_includes);E.t.array_find=function(fn,this_arg){var a=this,value;for(var i=0;i<a.length;i++){value=a[i];if(i in a&&fn.call(this_arg,value,i,a))return value}};add_prop(Array.prototype,"find",E.t.array_find);E.t.array_findIndex=function(fn,this_arg){var a=this,value;for(var i=0;i<a.length;i++){value=a[i];if(i in a&&fn.call(this_arg,value,i,a))return i}return-1};add_prop(Array.prototype,"findIndex",E.t.array_findIndex);E.t.array_of=function(){return Array.prototype.slice.call(arguments)};add_prop(Array,"of",E.t.array_of);E.t.array_from=function(a,fn,_this){a=Array.prototype.slice.call(a);return!fn?a:a.map(fn,_this)};add_prop(Array,"from",E.t.array_from);E.t.arraybuffer_slice=function(begin,end){begin=begin|0;end=(end==null?this.byteLength:end)|0;if(begin<0)begin+=this.byteLength;if(end<0)end+=this.byteLength;begin=Math.min(Math.max(0,begin),this.byteLength);end=Math.min(Math.max(0,end),this.byteLength);if(end-begin<=0)return new ArrayBuffer(0);var result=new ArrayBuffer(end-begin);var resultBytes=new Uint8Array(result);var sourceBytes=new Uint8Array(this,begin,end-begin);resultBytes.set(sourceBytes);return result};if(typeof ArrayBuffer!="undefined")add_prop(ArrayBuffer.prototype,"slice",E.t.arraybuffer_slice);add_prop(Number,"EPSILON",Math.pow(2,-52));E.t.number_isFinite=function(x){return typeof x=="number"&&isFinite(x)};add_prop(Number,"isFinite",E.t.number_isFinite);E.t.math_sign=function(x){x=+x;return x!==x?NaN:!x?x:x<0?-1:1};add_prop(Math,"sign",E.t.math_sign);E.t.math_trunc=function(x){x=+x;return x!==x?NaN:x<0?Math.ceil(x):Math.floor(x)};add_prop(Math,"trunc",E.t.math_trunc);E.t.math_imul=function(x,y){var hix=x>>>16&65535;var lox=x&65535;var hiy=y>>>16&65535;var loy=y&65535;return lox*loy+(hix*loy+lox*hiy<<16>>>0)|0};add_prop(Math,"imul",E.t.math_imul);function ie9_console(){if(typeof window!="object")return;if(window.console){if(!window.console.debug)window.console.debug=window.console.info;return}var console=window.console={};["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profiles","profileEnd","show","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"].forEach(function(p){console[p]=function(){}});["memory"].forEach(function(p){console[p]={}})}ie9_console();function ie9_location_origin(){if(typeof window!="object"||!window.location||"origin"in window.location){return}var location=window.location;var default_ports={"http:":80,"https:":443};var port=location.port;if(default_ports[location.protocol]==port)port=null;location.origin=location.protocol+"//"+location.hostname+(port?":"+port:"")}ie9_location_origin();function ie_edge_closest(){if(typeof Element!="object"&&typeof Element!="function"||Element.prototype.closest){return}var matches=Element.prototype.matches||Element.prototype.msMatchesSelector;if(!matches)return;Element.prototype.closest=function(selector){var el=this;while(el){if(matches.call(el,selector))return el;el=el.parentElement}return null}}ie_edge_closest();E.t.function_name=function(){var n=this.toString().match(/^function\s+([^\s(]+)/);return n&&n[1]||""};function ie_function_name(){if(ie_function_name.name=="ie_function_name")return;Object.defineProperty(Function.prototype,"name",{enumerable:false,configurable:false,get:E.t.function_name})}ie_function_name();function android18_animFrame(){if(typeof window!="object"||window.requestAnimationFrame)return;var start=Date.now();window.requestAnimationFrame=function(cb){setTimeout(function(){cb(Date.now()-start)},16)}}android18_animFrame();return E})})();
if(typeof hola_ldr_require!="undefined")hola_ldr_require.config({map:{events:"/util/events.js"}});define("/svc/cdn/pub/config.js",[],function(){var E={};var b="//"+require.zdot("host");E.swf_urls={videojs:b+require.zdot("videojs"),videojs_osmf:b+require.zdot("videojs_osmf"),videojs_flashls:b+require.zdot("videojs_flashls"),videojs5_osmf:b+require.zdot("videojs5_osmf"),videojs5:b+require.zdot("videojs5"),videojs5_10:b+require.zdot("videojs5_10")};E.css_urls={videojs:b+require.zdot("videojs5_10_css"),hola_skin:b+require.zdot("hola_skin"),thumbnails:b+require.zdot("thumbnails")};return E});require(["/util/es6_shim.js","/svc/cdn/pub/typedarray_shim.js"],function(){});
define("mp4box",{__stub:1});




(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define("muxjs",[],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.muxjs=f()}})(function(){var __hola_stub_define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){var Stream=_dereq_(22);var AacStream;AacStream=function(){var everything=new Uint8Array,timeStamp=0;AacStream.prototype.init.call(this);this.setTimestamp=function(timestamp){timeStamp=timestamp};this.parseId3TagSize=function(header,byteIndex){var returnSize=header[byteIndex+6]<<21|header[byteIndex+7]<<14|header[byteIndex+8]<<7|header[byteIndex+9],flags=header[byteIndex+5],footerPresent=(flags&16)>>4;if(footerPresent){return returnSize+20}return returnSize+10};this.parseAdtsSize=function(header,byteIndex){var lowThree=(header[byteIndex+5]&224)>>5,middle=header[byteIndex+4]<<3,highTwo=header[byteIndex+3]&3<<11;return highTwo|middle|lowThree};this.push=function(bytes){var frameSize=0,byteIndex=0,bytesLeft,chunk,packet,tempLength;if(everything.length){tempLength=everything.length;everything=new Uint8Array(bytes.byteLength+tempLength);everything.set(everything.subarray(0,tempLength));everything.set(bytes,tempLength)}else{everything=bytes}while(everything.length-byteIndex>=3){if(everything[byteIndex]==="I".charCodeAt(0)&&everything[byteIndex+1]==="D".charCodeAt(0)&&everything[byteIndex+2]==="3".charCodeAt(0)){if(everything.length-byteIndex<10){break}frameSize=this.parseId3TagSize(everything,byteIndex);if(frameSize>everything.length){break}chunk={type:"timed-metadata",data:everything.subarray(byteIndex,byteIndex+frameSize)};this.trigger("data",chunk);byteIndex+=frameSize;continue}else if(everything[byteIndex]&255===255&&(everything[byteIndex+1]&240)===240){if(everything.length-byteIndex<7){break}frameSize=this.parseAdtsSize(everything,byteIndex);if(frameSize>everything.length){break}packet={type:"audio",data:everything.subarray(byteIndex,byteIndex+frameSize),pts:timeStamp,dts:timeStamp};this.trigger("data",packet);byteIndex+=frameSize;continue}byteIndex++}bytesLeft=everything.length-byteIndex;if(bytesLeft>0){everything=everything.subarray(byteIndex)}else{everything=new Uint8Array}}};AacStream.prototype=new Stream;module.exports=AacStream},{22:22}],2:[function(_dereq_,module,exports){var Stream=_dereq_(22);var AdtsStream;var ADTS_SAMPLING_FREQUENCIES=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];AdtsStream=function(){var buffer;AdtsStream.prototype.init.call(this);this.push=function(packet){var i=0,frameNum=0,frameLength,protectionSkipBytes,frameEnd,oldBuffer,sampleCount,adtsFrameDuration;if(packet.type!=="audio"){return}if(buffer){oldBuffer=buffer;buffer=new Uint8Array(oldBuffer.byteLength+packet.data.byteLength);buffer.set(oldBuffer);buffer.set(packet.data,oldBuffer.byteLength)}else{buffer=packet.data}while(i+5<buffer.length){if(buffer[i]!==255||(buffer[i+1]&246)!==240){i++;continue}protectionSkipBytes=(~buffer[i+1]&1)*2;frameLength=(buffer[i+3]&3)<<11|buffer[i+4]<<3|(buffer[i+5]&224)>>5;sampleCount=((buffer[i+6]&3)+1)*1024;adtsFrameDuration=sampleCount*9e4/ADTS_SAMPLING_FREQUENCIES[(buffer[i+2]&60)>>>2];frameEnd=i+frameLength;if(buffer.byteLength<frameEnd){return}this.trigger("data",{pts:packet.pts+frameNum*adtsFrameDuration,dts:packet.dts+frameNum*adtsFrameDuration,sampleCount:sampleCount,audioobjecttype:(buffer[i+2]>>>6&3)+1,channelcount:(buffer[i+2]&1)<<2|(buffer[i+3]&192)>>>6,samplerate:ADTS_SAMPLING_FREQUENCIES[(buffer[i+2]&60)>>>2],samplingfrequencyindex:(buffer[i+2]&60)>>>2,samplesize:16,data:buffer.subarray(i+7+protectionSkipBytes,frameEnd)});if(buffer.byteLength===frameEnd){buffer=undefined;return}frameNum++;buffer=buffer.subarray(frameEnd)}};this.flush=function(){this.trigger("done")}};AdtsStream.prototype=new Stream;module.exports=AdtsStream},{22:22}],3:[function(_dereq_,module,exports){var Stream=_dereq_(22);var ExpGolomb=_dereq_(21);var H264Stream,NalByteStream;var PROFILES_WITH_OPTIONAL_SPS_DATA={100:true,110:true,122:true,244:true,44:true,83:true,86:true,118:true,128:true,138:true,139:true,134:true};var unitTypes={slice_layer_without_partitioning_rbsp:1,slice_layer_without_partitioning_rbsp_idr:5,sei_rbsp:6,seq_parameter_set_rbsp:7,pic_parameter_set_rbsp:8,access_unit_delimiter_rbsp:9};NalByteStream=function(){var syncPoint=0,i,buffer;NalByteStream.prototype.init.call(this);this.push=function(data){var swapBuffer;if(!buffer){buffer=data.data}else{swapBuffer=new Uint8Array(buffer.byteLength+data.data.byteLength);swapBuffer.set(buffer);swapBuffer.set(data.data,buffer.byteLength);buffer=swapBuffer}for(;syncPoint<buffer.byteLength-3;syncPoint++){if(buffer[syncPoint+2]===1){i=syncPoint+5;break}}while(i<buffer.byteLength){switch(buffer[i]){case 0:if(buffer[i-1]!==0){i+=2;break}else if(buffer[i-2]!==0){i++;break}if(syncPoint+3!==i-2){this.trigger("data",buffer.subarray(syncPoint+3,i-2))}do{i++}while(buffer[i]!==1&&i<buffer.length);syncPoint=i-2;i+=3;break;case 1:if(buffer[i-1]!==0||buffer[i-2]!==0){i+=3;break}this.trigger("data",buffer.subarray(syncPoint+3,i-2));syncPoint=i-2;i+=3;break;default:i+=3;break}}buffer=buffer.subarray(syncPoint);i-=syncPoint;syncPoint=0};this.flush=function(){if(buffer&&buffer.byteLength>3){this.trigger("data",buffer.subarray(syncPoint+3))}buffer=null;syncPoint=0;this.trigger("done")}};NalByteStream.prototype=new Stream;H264Stream=function(){var nalByteStream=new NalByteStream,self,trackId,currentPts,currentDts,discardEmulationPreventionBytes,readSequenceParameterSet,skipScalingList;H264Stream.prototype.init.call(this);self=this;this.push=function(packet){if(packet.type!=="video"){return}trackId=packet.trackId;currentPts=packet.pts;currentDts=packet.dts;nalByteStream.push(packet)};nalByteStream.on("data",function(data){var event={trackId:trackId,pts:currentPts,dts:currentDts,data:data};var ev_type=data[0]&31;if(ev_type==1||ev_type>=5&&ev_type<=9){event.nalUnitType=ev_type}if(ev_type==7||ev_type==6){event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));event.config=ev_type==7?readSequenceParameterSet(event.escapedRBSP):null}self.trigger("data",event)});nalByteStream.on("done",function(){self.trigger("done")});this.flush=function(){nalByteStream.flush()};skipScalingList=function(count,expGolombDecoder){var lastScale=8,nextScale=8,j,deltaScale;for(j=0;j<count;j++){if(nextScale!==0){deltaScale=expGolombDecoder.readExpGolomb();nextScale=(lastScale+deltaScale+256)%256}lastScale=nextScale===0?lastScale:nextScale}};discardEmulationPreventionBytes=function(data){var length=data.byteLength,emulationPreventionBytesPositions=[],i=1,newLength,newData;while(i<length-2){if(data[i]===0&&data[i+1]===0&&data[i+2]===3){emulationPreventionBytesPositions.push(i+2);i+=2}else{i++}}if(emulationPreventionBytesPositions.length===0){return data}newLength=length-emulationPreventionBytesPositions.length;newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===emulationPreventionBytesPositions[0]){sourceIndex++;emulationPreventionBytesPositions.shift()}newData[i]=data[sourceIndex]}return newData};readSequenceParameterSet=function(data){var frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,sarScale=1,expGolombDecoder,profileIdc,levelIdc,profileCompatibility,chromaFormatIdc,picOrderCntType,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,sarRatio,aspectRatioIdc,i;expGolombDecoder=new ExpGolomb(data);profileIdc=expGolombDecoder.readUnsignedByte();profileCompatibility=expGolombDecoder.readUnsignedByte();levelIdc=expGolombDecoder.readUnsignedByte();expGolombDecoder.skipUnsignedExpGolomb();if(PROFILES_WITH_OPTIONAL_SPS_DATA[profileIdc]){chromaFormatIdc=expGolombDecoder.readUnsignedExpGolomb();if(chromaFormatIdc===3){expGolombDecoder.skipBits(1)}expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){scalingListCount=chromaFormatIdc!==3?8:12;for(i=0;i<scalingListCount;i++){if(expGolombDecoder.readBoolean()){if(i<6){skipScalingList(16,expGolombDecoder)}else{skipScalingList(64,expGolombDecoder)}}}}}expGolombDecoder.skipUnsignedExpGolomb();picOrderCntType=expGolombDecoder.readUnsignedExpGolomb();if(picOrderCntType===0){expGolombDecoder.readUnsignedExpGolomb()}else if(picOrderCntType===1){expGolombDecoder.skipBits(1);expGolombDecoder.skipExpGolomb();expGolombDecoder.skipExpGolomb();numRefFramesInPicOrderCntCycle=expGolombDecoder.readUnsignedExpGolomb();for(i=0;i<numRefFramesInPicOrderCntCycle;i++){expGolombDecoder.skipExpGolomb()}}expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);picWidthInMbsMinus1=expGolombDecoder.readUnsignedExpGolomb();picHeightInMapUnitsMinus1=expGolombDecoder.readUnsignedExpGolomb();frameMbsOnlyFlag=expGolombDecoder.readBits(1);if(frameMbsOnlyFlag===0){expGolombDecoder.skipBits(1)}expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){frameCropLeftOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropRightOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropTopOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropBottomOffset=expGolombDecoder.readUnsignedExpGolomb()}if(expGolombDecoder.readBoolean()){if(expGolombDecoder.readBoolean()){aspectRatioIdc=expGolombDecoder.readUnsignedByte();switch(aspectRatioIdc){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:{sarRatio=[expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte(),expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte()];break}}if(sarRatio){sarScale=sarRatio[0]/sarRatio[1]}}}return{profileIdc:profileIdc,levelIdc:levelIdc,profileCompatibility:profileCompatibility,width:Math.ceil(((picWidthInMbsMinus1+1)*16-frameCropLeftOffset*2-frameCropRightOffset*2)*sarScale),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-frameCropTopOffset*2-frameCropBottomOffset*2}}};H264Stream.prototype=new Stream;module.exports={H264Stream:H264Stream,NalByteStream:NalByteStream,unitTypes:unitTypes}},{21:21,22:22}],4:[function(_dereq_,module,exports){module.exports={adts:_dereq_(2),h264:_dereq_(3)}},{2:2,3:3}],5:[function(_dereq_,module,exports){var FlvTag;FlvTag=function(type,extraData){var adHoc=0,bufferStartSize=16384,prepareWrite=function(flv,count){var bytes,minLength=flv.position+count;if(minLength<flv.bytes.byteLength){return}bytes=new Uint8Array(minLength*2);bytes.set(flv.bytes.subarray(0,flv.position),0);flv.bytes=bytes;flv.view=new DataView(flv.bytes.buffer)},widthBytes=FlvTag.widthBytes||new Uint8Array("width".length),heightBytes=FlvTag.heightBytes||new Uint8Array("height".length),videocodecidBytes=FlvTag.videocodecidBytes||new Uint8Array("videocodecid".length),i;if(!FlvTag.widthBytes){for(i=0;i<"width".length;i++){widthBytes[i]="width".charCodeAt(i)}for(i=0;i<"height".length;i++){heightBytes[i]="height".charCodeAt(i)}for(i=0;i<"videocodecid".length;i++){videocodecidBytes[i]="videocodecid".charCodeAt(i)}FlvTag.widthBytes=widthBytes;FlvTag.heightBytes=heightBytes;FlvTag.videocodecidBytes=videocodecidBytes}this.keyFrame=false;switch(type){case FlvTag.VIDEO_TAG:this.length=16;bufferStartSize*=6;break;case FlvTag.AUDIO_TAG:this.length=13;this.keyFrame=true;break;case FlvTag.METADATA_TAG:this.length=29;this.keyFrame=true;break;default:throw"Error Unknown TagType"}this.bytes=new Uint8Array(bufferStartSize);this.view=new DataView(this.bytes.buffer);this.bytes[0]=type;this.position=this.length;this.keyFrame=extraData;this.pts=0;this.dts=0;this.writeBytes=function(bytes,offset,length){var start=offset||0,end;length=length||bytes.byteLength;end=start+length;prepareWrite(this,length);this.bytes.set(bytes.subarray(start,end),this.position);this.position+=length;this.length=Math.max(this.length,this.position)};this.writeByte=function(byte){prepareWrite(this,1);this.bytes[this.position]=byte;this.position++;this.length=Math.max(this.length,this.position)};this.writeShort=function(short){prepareWrite(this,2);this.view.setUint16(this.position,short);this.position+=2;this.length=Math.max(this.length,this.position)};this.negIndex=function(pos){return this.bytes[this.length-pos]};this.nalUnitSize=function(){if(adHoc===0){return 0}return this.length-(adHoc+4)};this.startNalUnit=function(){if(adHoc>0){throw new Error("Attempted to create new NAL wihout closing the old one")}adHoc=this.length;this.length+=4;this.position=this.length};this.endNalUnit=function(nalContainer){var nalStart,nalLength;if(this.length===adHoc+4){this.length-=4}else if(adHoc>0){nalStart=adHoc+4;nalLength=this.length-nalStart;this.position=adHoc;this.view.setUint32(this.position,nalLength);this.position=this.length;if(nalContainer){nalContainer.push(this.bytes.subarray(nalStart,nalStart+nalLength))}}adHoc=0};this.writeMetaDataDouble=function(key,val){var i;prepareWrite(this,2+key.length+9);this.view.setUint16(this.position,key.length);this.position+=2;if(key==="width"){this.bytes.set(widthBytes,this.position);this.position+=5}else if(key==="height"){this.bytes.set(heightBytes,this.position);this.position+=6}else if(key==="videocodecid"){this.bytes.set(videocodecidBytes,this.position);this.position+=12}else{for(i=0;i<key.length;i++){this.bytes[this.position]=key.charCodeAt(i);this.position++}}this.position++;this.view.setFloat64(this.position,val);this.position+=8;this.length=Math.max(this.length,this.position);++adHoc};this.writeMetaDataBoolean=function(key,val){var i;prepareWrite(this,2);this.view.setUint16(this.position,key.length);this.position+=2;for(i=0;i<key.length;i++){prepareWrite(this,1);this.bytes[this.position]=key.charCodeAt(i);this.position++}prepareWrite(this,2);this.view.setUint8(this.position,1);this.position++;this.view.setUint8(this.position,val?1:0);this.position++;this.length=Math.max(this.length,this.position);++adHoc};this.finalize=function(){var dtsDelta,len;switch(this.bytes[0]){case FlvTag.VIDEO_TAG:this.bytes[11]=(this.keyFrame||extraData?16:32)|7;this.bytes[12]=extraData?0:1;dtsDelta=this.pts-this.dts;this.bytes[13]=(dtsDelta&16711680)>>>16;this.bytes[14]=(dtsDelta&65280)>>>8;this.bytes[15]=(dtsDelta&255)>>>0;break;case FlvTag.AUDIO_TAG:this.bytes[11]=175;this.bytes[12]=extraData?0:1;break;case FlvTag.METADATA_TAG:this.position=11;this.view.setUint8(this.position,2);this.position++;this.view.setUint16(this.position,10);this.position+=2;this.bytes.set([111,110,77,101,116,97,68,97,116,97],this.position);this.position+=10;this.bytes[this.position]=8;this.position++;this.view.setUint32(this.position,adHoc);this.position=this.length;this.bytes.set([0,0,9],this.position);this.position+=3;this.length=this.position;break}len=this.length-11;this.bytes[1]=(len&16711680)>>>16;this.bytes[2]=(len&65280)>>>8;this.bytes[3]=(len&255)>>>0;this.bytes[4]=(this.dts&16711680)>>>16;this.bytes[5]=(this.dts&65280)>>>8;this.bytes[6]=(this.dts&255)>>>0;this.bytes[7]=(this.dts&4278190080)>>>24;this.bytes[8]=0;this.bytes[9]=0;this.bytes[10]=0;prepareWrite(this,4);this.view.setUint32(this.length,this.length);this.length+=4;this.position+=4;this.bytes=this.bytes.subarray(0,this.length);this.frameTime=FlvTag.frameTime(this.bytes);return this}};FlvTag.AUDIO_TAG=8;FlvTag.VIDEO_TAG=9;FlvTag.METADATA_TAG=18;FlvTag.isAudioFrame=function(tag){return FlvTag.AUDIO_TAG===tag[0]};FlvTag.isVideoFrame=function(tag){return FlvTag.VIDEO_TAG===tag[0]};FlvTag.isMetaData=function(tag){return FlvTag.METADATA_TAG===tag[0]};FlvTag.isKeyFrame=function(tag){if(FlvTag.isVideoFrame(tag)){return tag[11]===23}if(FlvTag.isAudioFrame(tag)){return true}if(FlvTag.isMetaData(tag)){return true}return false};FlvTag.frameTime=function(tag){var pts=tag[4]<<16;pts|=tag[5]<<8;pts|=tag[6]<<0;pts|=tag[7]<<24;return pts};module.exports=FlvTag},{}],6:[function(_dereq_,module,exports){module.exports={tag:_dereq_(5),Transmuxer:_dereq_(7),tools:_dereq_(19)}},{19:19,5:5,7:7}],7:[function(_dereq_,module,exports){var Stream=_dereq_(22);var FlvTag=_dereq_(5);var m2ts=_dereq_(11);var codecs=_dereq_(4);var AdtsStream=codecs.adts;var H264Stream=codecs.h264.H264Stream;var MetadataStream,Transmuxer,VideoSegmentStream,AudioSegmentStream,CoalesceStream,collectTimelineInfo,metaDataTag,extraDataTag;collectTimelineInfo=function(track,data){if(typeof data.pts==="number"){if(track.timelineStartInfo.pts===undefined){track.timelineStartInfo.pts=data.pts}else{track.timelineStartInfo.pts=Math.min(track.timelineStartInfo.pts,data.pts)}}if(typeof data.dts==="number"){if(track.timelineStartInfo.dts===undefined){track.timelineStartInfo.dts=data.dts}else{track.timelineStartInfo.dts=Math.min(track.timelineStartInfo.dts,data.dts)}}};metaDataTag=function(track,pts){var tag=new FlvTag(FlvTag.METADATA_TAG);tag.dts=pts;tag.pts=pts;tag.writeMetaDataDouble("videocodecid",7);tag.writeMetaDataDouble("width",track.width);tag.writeMetaDataDouble("height",track.height);return tag};extraDataTag=function(track,pts){var i,tag=new FlvTag(FlvTag.VIDEO_TAG,true);tag.dts=pts;tag.pts=pts;tag.writeByte(1);tag.writeByte(track.profileIdc);tag.writeByte(track.profileCompatibility);tag.writeByte(track.levelIdc);tag.writeByte(252|3);tag.writeByte(224|1);tag.writeShort(track.sps[0].length);tag.writeBytes(track.sps[0]);tag.writeByte(track.pps.length);for(i=0;i<track.pps.length;++i){tag.writeShort(track.pps[i].length);tag.writeBytes(track.pps[i])}return tag};AudioSegmentStream=function(track){var adtsFrames=[],adtsFramesLength=0,sequenceNumber=0,earliestAllowedDts=0,oldExtraData;AudioSegmentStream.prototype.init.call(this);this.push=function(data){collectTimelineInfo(track,data);if(track&&track.channelcount===undefined){track.audioobjecttype=data.audioobjecttype;track.channelcount=data.channelcount;track.samplerate=data.samplerate;track.samplingfrequencyindex=data.samplingfrequencyindex;track.samplesize=data.samplesize;track.extraData=track.audioobjecttype<<11|track.samplingfrequencyindex<<7|track.channelcount<<3}data.pts=Math.round(data.pts/90);data.dts=Math.round(data.dts/90);adtsFrames.push(data)};this.flush=function(){var currentFrame,adtsFrame,deltaDts,lastMetaPts,tags=[];if(adtsFrames.length===0){this.trigger("done");return}lastMetaPts=-Infinity;while(adtsFrames.length){currentFrame=adtsFrames.shift();if(track.extraData!==oldExtraData||currentFrame.pts-lastMetaPts>=1e3){adtsFrame=new FlvTag(FlvTag.METADATA_TAG);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.writeMetaDataDouble("audiocodecid",10);adtsFrame.writeMetaDataBoolean("stereo",2===track.channelcount);adtsFrame.writeMetaDataDouble("audiosamplerate",track.samplerate);adtsFrame.writeMetaDataDouble("audiosamplesize",16);tags.push(adtsFrame);oldExtraData=track.extraData;adtsFrame=new FlvTag(FlvTag.AUDIO_TAG,true);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.view.setUint16(adtsFrame.position,track.extraData);adtsFrame.position+=2;adtsFrame.length=Math.max(adtsFrame.length,adtsFrame.position);tags.push(adtsFrame);lastMetaPts=currentFrame.pts}adtsFrame=new FlvTag(FlvTag.AUDIO_TAG);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.writeBytes(currentFrame.data);tags.push(adtsFrame)}oldExtraData=null;this.trigger("data",{track:track,tags:tags});this.trigger("done")}};AudioSegmentStream.prototype=new Stream;VideoSegmentStream=function(track){var sequenceNumber=0,nalUnits=[],nalUnitsLength=0,config,h264Frame;VideoSegmentStream.prototype.init.call(this);this.finishFrame=function(tags,frame){if(!frame){return}if(config&&track&&track.newMetadata&&(frame.keyFrame||tags.length===0)){tags.push(metaDataTag(config,frame.pts));tags.push(extraDataTag(track,frame.pts));track.newMetadata=false}frame.endNalUnit();tags.push(frame)};this.push=function(data){collectTimelineInfo(track,data);data.pts=Math.round(data.pts/90);data.dts=Math.round(data.dts/90);nalUnits.push(data)};this.flush=function(){var currentNal,tags=[];while(nalUnits.length&&nalUnits[0].nalUnitType!==codecs.h264.unitTypes.access_unit_delimiter_rbsp){nalUnits.shift()}if(nalUnits.length===0){this.trigger("done");return}while(nalUnits.length){currentNal=nalUnits.shift();switch(currentNal.nalUnitType){case codecs.h264.unitTypes.seq_parameter_set_rbsp:track.newMetadata=true;config=currentNal.config;track.width=config.width;track.height=config.height;track.sps=[currentNal.data];track.profileIdc=config.profileIdc;track.levelIdc=config.levelIdc;track.profileCompatibility=config.profileCompatibility;h264Frame.endNalUnit();break;case codecs.h264.unitTypes.pic_parameter_set_rbsp:track.newMetadata=true;track.pps=[currentNal.data];h264Frame.endNalUnit();break;case codecs.h264.unitTypes.access_unit_delimiter_rbsp:if(h264Frame){this.finishFrame(tags,h264Frame)}h264Frame=new FlvTag(FlvTag.VIDEO_TAG);h264Frame.pts=currentNal.pts;h264Frame.dts=currentNal.dts;break;case codecs.h264.unitTypes.slice_layer_without_partitioning_rbsp_idr:h264Frame.keyFrame=true;h264Frame.endNalUnit();break;default:h264Frame.endNalUnit();break}h264Frame.startNalUnit();h264Frame.writeBytes(currentNal.data)}if(h264Frame){this.finishFrame(tags,h264Frame)}this.trigger("data",{track:track,tags:tags});this.trigger("done")}};VideoSegmentStream.prototype=new Stream;CoalesceStream=function(options){this.numberOfTracks=0;this.metadataStream=options.metadataStream;this.videoTags=[];this.audioTags=[];this.videoTrack=null;this.audioTrack=null;this.pendingCaptions=[];this.pendingMetadata=[];this.pendingTracks=0;CoalesceStream.prototype.init.call(this);this.push=function(output){if(output.text){return this.pendingCaptions.push(output)}if(output.frames){return this.pendingMetadata.push(output)}if(output.track.type==="video"){this.videoTrack=output.track;this.videoTags=output.tags;this.pendingTracks++}if(output.track.type==="audio"){this.audioTrack=output.track;this.audioTags=output.tags;this.pendingTracks++}}};CoalesceStream.prototype=new Stream;CoalesceStream.prototype.flush=function(){var id3,caption,i,timelineStartPts,event={tags:{},captions:[],metadata:[]};if(this.pendingTracks<this.numberOfTracks){return}if(this.videoTrack){timelineStartPts=this.videoTrack.timelineStartInfo.pts}else if(this.audioTrack){timelineStartPts=this.audioTrack.timelineStartInfo.pts}event.tags.videoTags=this.videoTags;event.tags.audioTags=this.audioTags;for(i=0;i<this.pendingCaptions.length;i++){caption=this.pendingCaptions[i];caption.startTime=caption.startPts-timelineStartPts;caption.startTime/=9e4;caption.endTime=caption.endPts-timelineStartPts;caption.endTime/=9e4;event.captions.push(caption)}for(i=0;i<this.pendingMetadata.length;i++){id3=this.pendingMetadata[i];id3.cueTime=id3.pts-timelineStartPts;id3.cueTime/=9e4;event.metadata.push(id3)}event.metadata.dispatchType=this.metadataStream.dispatchType;this.videoTrack=null;this.audioTrack=null;this.videoTags=[];this.audioTags=[];this.pendingCaptions.length=0;this.pendingMetadata.length=0;this.pendingTracks=0;this.trigger("data",event);this.trigger("done")};Transmuxer=function(options){var self=this,videoTrack,audioTrack,packetStream,parseStream,elementaryStream,adtsStream,h264Stream,videoSegmentStream,audioSegmentStream,captionStream,coalesceStream;Transmuxer.prototype.init.call(this);options=options||{};this.metadataStream=new m2ts.MetadataStream;options.metadataStream=this.metadataStream;packetStream=new m2ts.TransportPacketStream;parseStream=new m2ts.TransportParseStream;elementaryStream=new m2ts.ElementaryStream;adtsStream=new AdtsStream;h264Stream=new H264Stream;coalesceStream=new CoalesceStream(options);packetStream.pipe(parseStream).pipe(elementaryStream);elementaryStream.pipe(h264Stream);elementaryStream.pipe(adtsStream);elementaryStream.pipe(this.metadataStream).pipe(coalesceStream);captionStream=new m2ts.CaptionStream;h264Stream.pipe(captionStream).pipe(coalesceStream);elementaryStream.on("data",function(data){var i,videoTrack,audioTrack;if(data.type==="metadata"){i=data.tracks.length;while(i--){if(data.tracks[i].type==="video"){videoTrack=data.tracks[i]}else if(data.tracks[i].type==="audio"){audioTrack=data.tracks[i]}}if(videoTrack&&!videoSegmentStream){coalesceStream.numberOfTracks++;videoSegmentStream=new VideoSegmentStream(videoTrack);h264Stream.pipe(videoSegmentStream).pipe(coalesceStream)}if(audioTrack&&!audioSegmentStream){coalesceStream.numberOfTracks++;audioSegmentStream=new AudioSegmentStream(audioTrack);adtsStream.pipe(audioSegmentStream).pipe(coalesceStream)}}});this.push=function(data){packetStream.push(data)};this.flush=function(){packetStream.flush()};coalesceStream.on("data",function(event){self.trigger("data",event)});coalesceStream.on("done",function(){self.trigger("done")});this.getFlvHeader=function(duration,audio,video){var headBytes=new Uint8Array(3+1+1+4),head=new DataView(headBytes.buffer),metadata,result,metadataLength;duration=duration||0;audio=audio===undefined?true:audio;video=video===undefined?true:video;head.setUint8(0,70);head.setUint8(1,76);head.setUint8(2,86);head.setUint8(3,1);head.setUint8(4,(audio?4:0)|(video?1:0));head.setUint32(5,headBytes.byteLength);if(duration<=0){result=new Uint8Array(headBytes.byteLength+4);result.set(headBytes);result.set([0,0,0,0],headBytes.byteLength);return result}metadata=new FlvTag(FlvTag.METADATA_TAG);metadata.pts=metadata.dts=0;metadata.writeMetaDataDouble("duration",duration);metadataLength=metadata.finalize().length;result=new Uint8Array(headBytes.byteLength+metadataLength);result.set(headBytes);result.set(head.byteLength,metadataLength);return result}};Transmuxer.prototype=new Stream;module.exports=Transmuxer},{11:11,22:22,4:4,5:5}],8:[function(_dereq_,module,exports){var muxjs={codecs:_dereq_(4),mp4:_dereq_(15),flv:_dereq_(6),mp2t:_dereq_(10)};module.exports=muxjs},{10:10,15:15,4:4,6:6}],9:[function(_dereq_,module,exports){var USER_DATA_REGISTERED_ITU_T_T35=4,RBSP_TRAILING_BITS=128,Stream=_dereq_(22),codecs=_dereq_(4);var parseSei=function(bytes){var i=0,result={payloadType:-1,payloadSize:0},payloadType=0,payloadSize=0;while(i<bytes.byteLength){if(bytes[i]===RBSP_TRAILING_BITS){break}while(bytes[i]===255){payloadType+=255;i++}payloadType+=bytes[i++];while(bytes[i]===255){payloadSize+=255;i++}payloadSize+=bytes[i++];if(!result.payload&&payloadType===USER_DATA_REGISTERED_ITU_T_T35){result.payloadType=payloadType;result.payloadSize=payloadSize;result.payload=bytes.subarray(i,i+payloadSize);break}i+=payloadSize;payloadType=0;payloadSize=0}return result};var parseUserData=function(sei){if(sei.payload[0]!==181){return null}if((sei.payload[1]<<8|sei.payload[2])!==49){return null}if(String.fromCharCode(sei.payload[3],sei.payload[4],sei.payload[5],sei.payload[6])!=="GA94"){return null}if(sei.payload[7]!==3){return null}return sei.payload.subarray(8,sei.payload.length-1)};var parseCaptionPackets=function(pts,userData){var results=[],i,count,offset,data;if(!(userData[0]&64)){return results}count=userData[0]&31;for(i=0;i<count;i++){offset=i*3;data={type:userData[offset+2]&3,pts:pts};if(userData[offset+2]&4){data.ccData=userData[offset+3]<<8|userData[offset+4];results.push(data)}}return results};var CaptionStream=function(){var self=this;CaptionStream.prototype.init.call(this);this.captionPackets_=[];this.field1_=new Cea608Stream;this.field1_.on("data",this.trigger.bind(this,"data"));this.field1_.on("done",this.trigger.bind(this,"done"))};CaptionStream.prototype=new Stream;CaptionStream.prototype.push=function(event){var sei,userData,captionPackets;if(event.nalUnitType!==codecs.h264.unitTypes.sei_rbsp){return}sei=parseSei(event.escapedRBSP);if(sei.payloadType!==USER_DATA_REGISTERED_ITU_T_T35){return}userData=parseUserData(sei);if(!userData){return}this.captionPackets_=this.captionPackets_.concat(parseCaptionPackets(event.pts,userData))};CaptionStream.prototype.flush=function(){if(!this.captionPackets_.length){this.field1_.flush();return}this.captionPackets_.sort(function(a,b){return a.pts-b.pts});this.captionPackets_.forEach(this.field1_.push,this.field1_);this.captionPackets_.length=0;this.field1_.flush();return};var BASIC_CHARACTER_TRANSLATION={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608};var getCharFromCode=function(code){if(code===null){return""}code=BASIC_CHARACTER_TRANSLATION[code]||code;return String.fromCharCode(code)};var PADDING=0,RESUME_CAPTION_LOADING=5152,END_OF_CAPTION=5167,ROLL_UP_2_ROWS=5157,ROLL_UP_3_ROWS=5158,ROLL_UP_4_ROWS=5159,RESUME_DIRECT_CAPTIONING=5161,CARRIAGE_RETURN=5165,BACKSPACE=5153,ERASE_DISPLAYED_MEMORY=5164,ERASE_NON_DISPLAYED_MEMORY=5166;var BOTTOM_ROW=14;var createDisplayBuffer=function(){var result=[],i=BOTTOM_ROW+1;while(i--){result.push("")}return result};var Cea608Stream=function(){Cea608Stream.prototype.init.call(this);this.mode_="popOn";this.topRow_=0;this.startPts_=0;this.displayed_=createDisplayBuffer();this.nonDisplayed_=createDisplayBuffer();this.lastControlCode_=null;this.push=function(packet){if(packet.type!==0){return}var data,swap,char0,char1;data=packet.ccData&32639;if(data===this.lastControlCode_){this.lastControlCode_=null;return}if((data&61440)===4096){this.lastControlCode_=data}else{this.lastControlCode_=null}switch(data){case PADDING:break;case RESUME_CAPTION_LOADING:this.mode_="popOn";break;case END_OF_CAPTION:this.flushDisplayed(packet.pts);swap=this.displayed_;this.displayed_=this.nonDisplayed_;this.nonDisplayed_=swap;this.startPts_=packet.pts;break;case ROLL_UP_2_ROWS:this.topRow_=BOTTOM_ROW-1;this.mode_="rollUp";break;case ROLL_UP_3_ROWS:this.topRow_=BOTTOM_ROW-2;this.mode_="rollUp";break;case ROLL_UP_4_ROWS:this.topRow_=BOTTOM_ROW-3;this.mode_="rollUp";break;case CARRIAGE_RETURN:this.flushDisplayed(packet.pts);this.shiftRowsUp_();this.startPts_=packet.pts;break;case BACKSPACE:if(this.mode_==="popOn"){this.nonDisplayed_[BOTTOM_ROW]=this.nonDisplayed_[BOTTOM_ROW].slice(0,-1)}else{this.displayed_[BOTTOM_ROW]=this.displayed_[BOTTOM_ROW].slice(0,-1)}break;case ERASE_DISPLAYED_MEMORY:this.flushDisplayed(packet.pts);this.displayed_=createDisplayBuffer();break;case ERASE_NON_DISPLAYED_MEMORY:this.nonDisplayed_=createDisplayBuffer();break;default:char0=data>>>8;char1=data&255;if(char0>=16&&char0<=23&&char1>=64&&char1<=127&&(char0!==16||char1<96)){char0=32;char1=null}if((char0===17||char0===25)&&(char1>=48&&char1<=63)){char0=9834;char1=""}if((char0&240)===16){return}this[this.mode_](packet.pts,char0,char1);break}}};Cea608Stream.prototype=new Stream;Cea608Stream.prototype.flushDisplayed=function(pts){var content=this.displayed_.map(function(row){return row.trim()}).filter(function(row){return row.length}).join("\n");if(content.length){this.trigger("data",{startPts:this.startPts_,endPts:pts,text:content})}};Cea608Stream.prototype.popOn=function(pts,char0,char1){var baseRow=this.nonDisplayed_[BOTTOM_ROW];baseRow+=getCharFromCode(char0);baseRow+=getCharFromCode(char1);this.nonDisplayed_[BOTTOM_ROW]=baseRow};Cea608Stream.prototype.rollUp=function(pts,char0,char1){var baseRow=this.displayed_[BOTTOM_ROW];if(baseRow===""){this.flushDisplayed(pts);this.startPts_=pts}baseRow+=getCharFromCode(char0);baseRow+=getCharFromCode(char1);this.displayed_[BOTTOM_ROW]=baseRow;
};Cea608Stream.prototype.shiftRowsUp_=function(){var i;for(i=0;i<this.topRow_;i++){this.displayed_[i]=""}for(i=this.topRow_;i<BOTTOM_ROW;i++){this.displayed_[i]=this.displayed_[i+1]}this.displayed_[BOTTOM_ROW]=""};module.exports={CaptionStream:CaptionStream,Cea608Stream:Cea608Stream}},{22:22,4:4}],10:[function(_dereq_,module,exports){module.exports=_dereq_(11)},{11:11}],11:[function(_dereq_,module,exports){var Stream=_dereq_(22),CaptionStream=_dereq_(9),StreamTypes=_dereq_(13),TimestampRolloverStream=_dereq_(14).TimestampRolloverStream;var m2tsStreamTypes=_dereq_(13);var TransportPacketStream,TransportParseStream,ElementaryStream;var MP2T_PACKET_LENGTH=188,SYNC_BYTE=71;TransportPacketStream=function(){var buffer=new Uint8Array(MP2T_PACKET_LENGTH),bytesInBuffer=0;TransportPacketStream.prototype.init.call(this);this.push=function(bytes){var startIndex=0,endIndex=MP2T_PACKET_LENGTH,everything;if(bytesInBuffer){everything=new Uint8Array(bytes.byteLength+bytesInBuffer);everything.set(buffer.subarray(0,bytesInBuffer));everything.set(bytes,bytesInBuffer);bytesInBuffer=0}else{everything=bytes}while(endIndex<everything.byteLength){if(everything[startIndex]===SYNC_BYTE&&everything[endIndex]===SYNC_BYTE){this.trigger("data",everything.subarray(startIndex,endIndex));startIndex+=MP2T_PACKET_LENGTH;endIndex+=MP2T_PACKET_LENGTH;continue}startIndex++;endIndex++}if(startIndex<everything.byteLength){buffer.set(everything.subarray(startIndex),0);bytesInBuffer=everything.byteLength-startIndex}};this.flush=function(){if(bytesInBuffer===MP2T_PACKET_LENGTH&&buffer[0]===SYNC_BYTE){this.trigger("data",buffer);bytesInBuffer=0}this.trigger("done")}};TransportPacketStream.prototype=new Stream;TransportParseStream=function(){var parsePsi,parsePat,parsePmt,parsePes,self;TransportParseStream.prototype.init.call(this);self=this;this.packetsWaitingForPmt=[];this.programMapTable=undefined;parsePsi=function(payload,psi){var offset=0;if(psi.payloadUnitStartIndicator){offset+=payload[offset]+1}if(psi.type==="pat"){parsePat(payload.subarray(offset),psi)}else{parsePmt(payload.subarray(offset),psi)}};parsePat=function(payload,pat){pat.section_number=payload[7];pat.last_section_number=payload[8];self.pmtPid=(payload[10]&31)<<8|payload[11];pat.pmtPid=self.pmtPid};parsePmt=function(payload,pmt){var sectionLength,tableEnd,programInfoLength,offset;if(!(payload[5]&1)){return}self.programMapTable={};sectionLength=(payload[1]&15)<<8|payload[2];tableEnd=3+sectionLength-4;programInfoLength=(payload[10]&15)<<8|payload[11];offset=12+programInfoLength;while(offset<tableEnd){self.programMapTable[(payload[offset+1]&31)<<8|payload[offset+2]]=payload[offset];offset+=((payload[offset+3]&15)<<8|payload[offset+4])+5}pmt.programMapTable=self.programMapTable;while(self.packetsWaitingForPmt.length){self.processPes_.apply(self,self.packetsWaitingForPmt.shift())}};this.push=function(packet){var result={},offset=4;result.payloadUnitStartIndicator=!!(packet[1]&64);result.pid=packet[1]&31;result.pid<<=8;result.pid|=packet[2];if((packet[3]&48)>>>4>1){offset+=packet[offset]+1}if(result.pid===0){result.type="pat";parsePsi(packet.subarray(offset),result);this.trigger("data",result)}else if(result.pid===this.pmtPid){result.type="pmt";parsePsi(packet.subarray(offset),result);this.trigger("data",result)}else if(this.programMapTable===undefined){this.packetsWaitingForPmt.push([packet,offset,result])}else{this.processPes_(packet,offset,result)}};this.processPes_=function(packet,offset,result){result.streamType=this.programMapTable[result.pid];result.type="pes";result.data=packet.subarray(offset);this.trigger("data",result)}};TransportParseStream.prototype=new Stream;TransportParseStream.STREAM_TYPES={h264:27,adts:15};ElementaryStream=function(){var self=this,video={data:[],size:0},audio={data:[],size:0},timedMetadata={data:[],size:0},parsePes=function(payload,pes){var ptsDtsFlags;function extract_ts(arr,index){var ts=(arr[index]&14)*536870912+(arr[index+1]&255)*4194304+(arr[index+2]&254)*16384+(arr[index+3]&255)*128+(arr[index+4]&254)/2;if(ts>4294967295){ts-=8589934592}return ts}pes.dataAlignmentIndicator=(payload[6]&4)!==0;ptsDtsFlags=payload[7];if(ptsDtsFlags&192){pes.pts=extract_ts(payload,9);pes.dts=ptsDtsFlags&64?extract_ts(payload,14):pes.pts}pes.data=payload.subarray(9+payload[8])},flushStream=function(stream,type){var packetData=new Uint8Array(stream.size),event={type:type},i=0,fragment;if(!stream.data.length){return}event.trackId=stream.data[0].pid;while(stream.data.length){fragment=stream.data.shift();packetData.set(fragment.data,i);i+=fragment.data.byteLength}parsePes(packetData,event);stream.size=0;self.trigger("data",event)};ElementaryStream.prototype.init.call(this);this.push=function(data){({pat:function(){},pes:function(){var stream,streamType;switch(data.streamType){case StreamTypes.H264_STREAM_TYPE:case m2tsStreamTypes.H264_STREAM_TYPE:stream=video;streamType="video";break;case StreamTypes.ADTS_STREAM_TYPE:stream=audio;streamType="audio";break;case StreamTypes.METADATA_STREAM_TYPE:stream=timedMetadata;streamType="timed-metadata";break;default:return}if(data.payloadUnitStartIndicator){flushStream(stream,streamType)}stream.data.push(data);stream.size+=data.data.byteLength},pmt:function(){var event={type:"metadata",tracks:[]},programMapTable=data.programMapTable,k,track;for(k in programMapTable){if(programMapTable.hasOwnProperty(k)){track={timelineStartInfo:{baseMediaDecodeTime:0}};track.id=+k;if(programMapTable[k]===m2tsStreamTypes.H264_STREAM_TYPE){track.codec="avc";track.type="video"}else if(programMapTable[k]===m2tsStreamTypes.ADTS_STREAM_TYPE){track.codec="adts";track.type="audio"}event.tracks.push(track)}}self.trigger("data",event)}})[data.type]()};this.flush=function(){flushStream(video,"video");flushStream(audio,"audio");flushStream(timedMetadata,"timed-metadata");this.trigger("done")}};ElementaryStream.prototype=new Stream;var m2ts={PAT_PID:0,MP2T_PACKET_LENGTH:MP2T_PACKET_LENGTH,TransportPacketStream:TransportPacketStream,TransportParseStream:TransportParseStream,ElementaryStream:ElementaryStream,TimestampRolloverStream:TimestampRolloverStream,CaptionStream:CaptionStream.CaptionStream,Cea608Stream:CaptionStream.Cea608Stream,MetadataStream:_dereq_(12)};for(var type in StreamTypes){if(StreamTypes.hasOwnProperty(type)){m2ts[type]=StreamTypes[type]}}module.exports=m2ts},{12:12,13:13,14:14,22:22,9:9}],12:[function(_dereq_,module,exports){var Stream=_dereq_(22),StreamTypes=_dereq_(13),percentEncode=function(bytes,start,end){var i,result="";for(i=start;i<end;i++){result+="%"+("00"+bytes[i].toString(16)).slice(-2)}return result},parseUtf8=function(bytes,start,end){return decodeURIComponent(percentEncode(bytes,start,end))},parseIso88591=function(bytes,start,end){return unescape(percentEncode(bytes,start,end))},parseSyncSafeInteger=function(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},tagParsers={TXXX:function(tag){var i;if(tag.data[0]!==3){return}for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.value=parseUtf8(tag.data,i+1,tag.data.length-1);break}}tag.data=tag.value},WXXX:function(tag){var i;if(tag.data[0]!==3){return}for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.url=parseUtf8(tag.data,i+1,tag.data.length);break}}},PRIV:function(tag){var i;for(i=0;i<tag.data.length;i++){if(tag.data[i]===0){tag.owner=parseIso88591(tag.data,0,i);break}}tag.privateData=tag.data.subarray(i+1);tag.data=tag.privateData}},MetadataStream;MetadataStream=function(options){var settings={debug:!!(options&&options.debug),descriptor:options&&options.descriptor},tagSize=0,buffer=[],bufferSize=0,i;MetadataStream.prototype.init.call(this);this.dispatchType=StreamTypes.METADATA_STREAM_TYPE.toString(16);if(settings.descriptor){for(i=0;i<settings.descriptor.length;i++){this.dispatchType+=("00"+settings.descriptor[i].toString(16)).slice(-2)}}this.push=function(chunk){var tag,frameStart,frameSize,frame,i,frameHeader;if(chunk.type!=="timed-metadata"){return}if(chunk.dataAlignmentIndicator){bufferSize=0;buffer.length=0}if(buffer.length===0&&(chunk.data.length<10||chunk.data[0]!=="I".charCodeAt(0)||chunk.data[1]!=="D".charCodeAt(0)||chunk.data[2]!=="3".charCodeAt(0))){if(settings.debug){console.log("Skipping unrecognized metadata packet")}return}buffer.push(chunk);bufferSize+=chunk.data.byteLength;if(buffer.length===1){tagSize=parseSyncSafeInteger(chunk.data.subarray(6,10));tagSize+=10}if(bufferSize<tagSize){return}tag={data:new Uint8Array(tagSize),frames:[],pts:buffer[0].pts,dts:buffer[0].dts};for(i=0;i<tagSize;){tag.data.set(buffer[0].data.subarray(0,tagSize-i),i);i+=buffer[0].data.byteLength;bufferSize-=buffer[0].data.byteLength;buffer.shift()}frameStart=10;if(tag.data[5]&64){frameStart+=4;frameStart+=parseSyncSafeInteger(tag.data.subarray(10,14));tagSize-=parseSyncSafeInteger(tag.data.subarray(16,20))}do{frameSize=parseSyncSafeInteger(tag.data.subarray(frameStart+4,frameStart+8));if(frameSize<1){return console.log("Malformed ID3 frame encountered. Skipping metadata parsing.")}frameHeader=String.fromCharCode(tag.data[frameStart],tag.data[frameStart+1],tag.data[frameStart+2],tag.data[frameStart+3]);frame={id:frameHeader,data:tag.data.subarray(frameStart+10,frameStart+frameSize+10)};frame.key=frame.id;if(tagParsers[frame.id]){tagParsers[frame.id](frame);if(frame.owner==="com.apple.streaming.transportStreamTimestamp"){var d=frame.data,size=(d[3]&1)<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;size*=4;size+=d[7]&3;frame.timeStamp=size;this.trigger("timestamp",frame)}}tag.frames.push(frame);frameStart+=10;frameStart+=frameSize}while(frameStart<tagSize);this.trigger("data",tag)}};MetadataStream.prototype=new Stream;module.exports=MetadataStream},{13:13,22:22}],13:[function(_dereq_,module,exports){module.exports={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21}},{}],14:[function(_dereq_,module,exports){var Stream=_dereq_(22);var MAX_TS=8589934592;var RO_THRESH=4294967296;var handleRollover=function(value,reference){var direction=1;if(value>reference){direction=-1}while(Math.abs(reference-value)>RO_THRESH){value+=direction*MAX_TS}return value};var TimestampRolloverStream=function(type){var lastDTS,referenceDTS;TimestampRolloverStream.prototype.init.call(this);this.type_=type;this.push=function(data){if(data.type!==this.type_){return}if(referenceDTS===undefined){referenceDTS=data.dts}data.dts=handleRollover(data.dts,referenceDTS);data.pts=handleRollover(data.pts,referenceDTS);lastDTS=data.dts;this.trigger("data",data)};this.flush=function(){referenceDTS=lastDTS;this.trigger("done")}};TimestampRolloverStream.prototype=new Stream;module.exports={TimestampRolloverStream:TimestampRolloverStream,handleRollover:handleRollover}},{22:22}],15:[function(_dereq_,module,exports){module.exports={generator:_dereq_(16),Transmuxer:_dereq_(18).Transmuxer,AudioSegmentStream:_dereq_(18).AudioSegmentStream,VideoSegmentStream:_dereq_(18).VideoSegmentStream,tools:_dereq_(20),MP4ParserStream:_dereq_(17).MP4ParserStream,MP4BuilderStream:_dereq_(17).MP4BuilderStream}},{16:16,17:17,18:18,20:20}],16:[function(_dereq_,module,exports){var UINT32_MAX=Math.pow(2,32)-1;var box,cslg,dinf,esds,ftyp,edts,elst,mdat,mfhd,minf,moof,moov,mvex,mvhd,trak,tkhd,mdia,mdhd,hdlr,sdtp,stbl,stsd,styp,traf,trep,trex,trun,types,MAJOR_BRAND,MINOR_VERSION,AVC1_BRAND,VIDEO_HDLR,AUDIO_HDLR,HDLR_TYPES,VMHD,SMHD,DREF,STCO,STSC,STSZ,STTS;(function(){var i;types={avc1:[],avcC:[],btrt:[],cslg:[],dinf:[],dref:[],edts:[],elst:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trep:[],trex:[],tkhd:[],vmhd:[]};if(typeof Uint8Array==="undefined"){return}for(i in types){if(types.hasOwnProperty(i)){types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]}}MAJOR_BRAND=new Uint8Array(["i".charCodeAt(0),"s".charCodeAt(0),"o".charCodeAt(0),"m".charCodeAt(0)]);AVC1_BRAND=new Uint8Array(["a".charCodeAt(0),"v".charCodeAt(0),"c".charCodeAt(0),"1".charCodeAt(0)]);MINOR_VERSION=new Uint8Array([0,0,0,1]);VIDEO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]);AUDIO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);HDLR_TYPES={video:VIDEO_HDLR,audio:AUDIO_HDLR};DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);SMHD=new Uint8Array([0,0,0,0,0,0,0,0]);STCO=new Uint8Array([0,0,0,0,0,0,0,0]);STSC=STCO;STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);STTS=STCO;VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])})();function uint32_to_arr(num){return[num>>>24&255,num>>>16&255,num>>>8&255,num&255]}function uint16_to_arr(num){return[num>>>8&255,num&255]}box=function(type){var payload=[],size=0,i,result,view;for(i=1;i<arguments.length;i++){payload.push(arguments[i])}i=payload.length;while(i--){size+=payload[i].byteLength}result=new Uint8Array(size+8);view=new DataView(result.buffer,result.byteOffset,result.byteLength);view.setUint32(0,result.byteLength);result.set(type,4);for(i=0,size=8;i<payload.length;i++){result.set(payload[i],size);size+=payload[i].byteLength}return result};cslg=function(cslg){var obj={};for(var k in cslg)obj[k]=cslg[k]>>>0;return box(types.cslg,new Uint8Array([0,0,0,0,obj.ctts_shift>>>24&255,obj.ctts_shift>>>16&255,obj.ctts_shift>>>8&255,obj.ctts_shift&255,obj.min_ctts>>>24&255,obj.min_ctts>>>16&255,obj.min_ctts>>>8&255,obj.min_ctts&255,obj.max_ctts>>>24&255,obj.max_ctts>>>16&255,obj.max_ctts>>>8&255,obj.max_ctts&255,obj.min_cts>>>24&255,obj.min_cts>>>16&255,obj.min_cts>>>8&255,obj.min_cts&255,obj.max_cts>>>24&255,obj.max_cts>>>16&255,obj.max_cts>>>8&255,obj.max_cts&255]))};dinf=function(){return box(types.dinf,box(types.dref,DREF))};edts=function(track){return box(types.edts,elst(track))};elst=function(track){var count=track.edit_list.length,i;var bytes=[0,0,0,0].concat(uint32_to_arr(count));for(i=0;i<count;i++){bytes=bytes.concat(uint32_to_arr(track.edit_list[i].segment_duration)).concat(uint32_to_arr(track.edit_list[i].media_time)).concat(uint16_to_arr(track.edit_list[i].media_rate)).concat(uint16_to_arr(0))}return box(types.elst,new Uint8Array(bytes))};esds=function(track){return box(types.esds,new Uint8Array([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,track.audioobjecttype<<3|track.samplingfrequencyindex>>>1,track.samplingfrequencyindex<<7|track.channelcount<<3,6,1,2]))};ftyp=function(opt){opt=opt||{};var params=opt.compatible||[MAJOR_BRAND,AVC1_BRAND];params=params.slice(0);params.unshift(types.ftyp,opt.major||MAJOR_BRAND,MINOR_VERSION);return box.apply(null,params)};hdlr=function(type){return box(types.hdlr,HDLR_TYPES[type])};mdat=function(data){return box(types.mdat,data)};mdhd=function(track){var result=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,track.duration>>>24&255,track.duration>>>16&255,track.duration>>>8&255,track.duration&255,85,196,0,0]);if(track.samplerate){result[12]=track.samplerate>>>24&255;result[13]=track.samplerate>>>16&255;result[14]=track.samplerate>>>8&255;result[15]=track.samplerate&255}return box(types.mdhd,result)};mdia=function(track){return box(types.mdia,mdhd(track),hdlr(track.type),minf(track))};mfhd=function(sequenceNumber){return box(types.mfhd,new Uint8Array([0,0,0,0,(sequenceNumber&4278190080)>>24,(sequenceNumber&16711680)>>16,(sequenceNumber&65280)>>8,sequenceNumber&255]))};minf=function(track){return box(types.minf,track.type==="video"?box(types.vmhd,VMHD):box(types.smhd,SMHD),dinf(),stbl(track))};moof=function(sequenceNumber,tracks,opt){var trackFragments=[],i=tracks.length;opt=opt||{};while(i--){trackFragments[i]=traf(tracks[i],opt)}return box.apply(null,[types.moof,mfhd(sequenceNumber)].concat(trackFragments))};moov=function(tracks,opt){var i=tracks.length,boxes=[],duration=0;opt=opt||{};while(i--){boxes[i]=trak(tracks[i]);if(opt.set_duration){duration=Math.max(duration,Math.floor(tracks[i].duration*9e4/tracks[i].samplerate))}}duration=opt.duration||duration||4294967295;return box.apply(null,[types.moov,mvhd(duration)].concat(boxes).concat(mvex(tracks)))};mvex=function(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=trex(tracks[i]);if(tracks[i].cslg&&tracks[i].cslg.max_cts){boxes.push(trep(tracks[i]))}}return box.apply(null,[types.mvex].concat(boxes))};mvhd=function(duration){var bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(duration&4278190080)>>24,(duration&16711680)>>16,(duration&65280)>>8,duration&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return box(types.mvhd,bytes)};sdtp=function(track){var samples=track.samples||[],bytes=new Uint8Array(4+samples.length),flags,i;for(i=0;i<samples.length;i++){flags=samples[i].flags;bytes[i+4]=flags.isLeading<<6|flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy}return box(types.sdtp,bytes)};stbl=function(track){return box(types.stbl,stsd(track),box(types.stts,STTS),box(types.stsc,STSC),box(types.stsz,STSZ),box(types.stco,STCO))};(function(){var videoSample,audioSample;stsd=function(track){return box(types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),track.type==="video"?videoSample(track):audioSample(track))};videoSample=function(track){var sps=track.sps||[],pps=track.pps||[],sequenceParameterSets=[],pictureParameterSets=[],i;for(i=0;i<sps.length;i++){sequenceParameterSets.push((sps[i].byteLength&65280)>>>8);sequenceParameterSets.push(sps[i].byteLength&255);sequenceParameterSets=sequenceParameterSets.concat(Array.prototype.slice.call(sps[i]))}for(i=0;i<pps.length;i++){pictureParameterSets.push((pps[i].byteLength&65280)>>>8);pictureParameterSets.push(pps[i].byteLength&255);pictureParameterSets=pictureParameterSets.concat(Array.prototype.slice.call(pps[i]))}return box(types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(track.width&65280)>>8,track.width&255,(track.height&65280)>>8,track.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),box(types.avcC,new Uint8Array([1,track.profileIdc,track.profileCompatibility,track.levelIdc,255].concat([sps.length|224]).concat(sequenceParameterSets).concat([pps.length]).concat(pictureParameterSets))),box(types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))};audioSample=function(track){return box(types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(track.channelcount&65280)>>8,track.channelcount&255,(track.samplesize&65280)>>8,track.samplesize&255,0,0,0,0,(track.samplerate&65280)>>8,track.samplerate&255,0,0]),esds(track))}})();styp=function(){return box(types.styp,MAJOR_BRAND,MINOR_VERSION,MAJOR_BRAND)};tkhd=function(track){var duration=track.duration;if(track.samplerate){duration=Math.floor(duration*9e4/track.samplerate)}var result=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,0,(track.duration&4278190080)>>24,(track.duration&16711680)>>16,(track.duration&65280)>>8,track.duration&255,0,0,0,0,0,0,0,0,0,0,0,0,+(track.type=="audio"),0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(track.width&65280)>>8,track.width&255,0,0,(track.height&65280)>>8,track.height&255,0,0]);return box(types.tkhd,result)};traf=function(track,opt){var trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable,dataOffset,upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime;opt=opt||{};trackFragmentHeader=box(types.tfhd,new Uint8Array([0,opt.no_multi_init?2:0,0,58,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0]));upperWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime/(UINT32_MAX+1));lowerWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime%(UINT32_MAX+1));trackFragmentDecodeTime=box(types.tfdt,new Uint8Array([1,0,0,0,upperWordBaseMediaDecodeTime>>>24&255,upperWordBaseMediaDecodeTime>>>16&255,upperWordBaseMediaDecodeTime>>>8&255,upperWordBaseMediaDecodeTime&255,lowerWordBaseMediaDecodeTime>>>24&255,lowerWordBaseMediaDecodeTime>>>16&255,lowerWordBaseMediaDecodeTime>>>8&255,lowerWordBaseMediaDecodeTime&255]));dataOffset=32+20+8+16+8+8;if(track.type==="audio"){trackFragmentRun=trun(track,dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun)}sampleDependencyTable=sdtp(track);trackFragmentRun=trun(track,sampleDependencyTable.length+dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable)};trak=function(track){track.duration=track.duration||4294967295;var param=[types.trak,tkhd(track),mdia(track)];if(track.edit_list&&track.edit_list.length)param.splice(2,0,edts(track));return box.apply(null,param)};trep=function(track){return box(types.trep,new Uint8Array([0,0,0,0,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255]),cslg(track.cslg))};trex=function(track){var result=new Uint8Array([0,0,0,0,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);if(track.type!=="video"){result[result.length-1]=0}return box(types.trex,result)};trun=function(track,offset){function get_flags(sample){return("duration"in sample&&1)|("size"in sample&&2)|("flags"in sample&&4)|("compositionTimeOffset"in sample&&8)}function trun_header(samples,offset,flags){return[0,0,flags,1,(samples.length&4278190080)>>>24,(samples.length&16711680)>>>16,(samples.length&65280)>>>8,samples.length&255,(offset&4278190080)>>>24,(offset&16711680)>>>16,(offset&65280)>>>8,offset&255]}var samples=track.samples||[];var flags=get_flags(samples[0]||{});offset+=20+4*samples.length*((flags>>3&1)+(flags>>2&1)+(flags>>1&1)+(flags&1));var bytes=trun_header(samples,offset,flags);var was_neg=false;for(var i=0;i<samples.length;i++){var sample=samples[i];if(flags&1){bytes.push(sample.duration>>24&255,sample.duration>>16&255,sample.duration>>8&255,sample.duration&255)}if(flags&2){bytes.push(sample.size>>24&255,sample.size>>16&255,sample.size>>8&255,sample.size&255)}if(flags&4){bytes.push(sample.flags.isLeading<<2|sample.flags.dependsOn,sample.flags.isDependedOn<<6|sample.flags.hasRedundancy<<4|sample.flags.paddingValue<<1|sample.flags.isNonSyncSample,sample.flags.degradationPriority>>8&255,sample.flags.degradationPriority&255)}if(flags&8){was_neg=was_neg||sample.compositionTimeOffset<0;bytes.push(sample.compositionTimeOffset>>24&255,sample.compositionTimeOffset>>16&255,sample.compositionTimeOffset>>8&255,sample.compositionTimeOffset&255)}}bytes[0]=+!!was_neg;return box(types.trun,new Uint8Array(bytes))};module.exports={ftyp:ftyp,mdat:mdat,moof:moof,moov:moov,initSegment:function(tracks,opt){var fileType=ftyp(opt),movie=moov(tracks,opt),result;result=new Uint8Array(fileType.byteLength+movie.byteLength);result.set(fileType);result.set(movie,fileType.byteLength);return result}}},{}],17:[function(_dereq_,module,exports){var Stream=_dereq_(22);var mp4=_dereq_(16);var sample_type={vide:"video",soun:"audio"};var full_box=["meta","mvhd","tkhd","mdhd","smhd","vmhd","dref","hdlr","stsd","esds","stts","stps","stss","ctts","stsc","stsz","stco","esds","elst","nmhd","cslg","sdtp","co64"];var trigger_on_headers=["moov"];var raw_copy=["udta","smhd","vmhd","dref","iods","btrt","pasp","clap","uuid","colr","sbgp","sgpd","gmhd","tref","nmhd","svcC","hmhd","fiel","tapt","load","meta","sefd","beam","tgas","elng"];var containers={trak:{name:"track_info",multi:1},edts:{name:"edit_list"},exts:{name:"edit_list"},mdia:{name:"media_box"},minf:{name:"media_info"},dinf:{name:"data_info"},stbl:{name:"sample_table"}};function byte_to_hex(bt){return("0"+bt.toString(16)).slice(-2)}function int_to_str(tp){return String.fromCharCode(tp>>24&255,tp>>16&255,tp>>8&255,tp&255)}function getUint64(view,ptr){return view.getUint32(ptr+4)+view.getUint32(ptr)*4294967296}function getInt64(view,ptr){var hib=view.getUint8(ptr);if(hib<128)return getUint64(view,ptr);return view.getUint32(ptr+4)+4294967296*(view.getUint32(ptr)-4294967296)}function Bit_reader(view,ptr,size){var pos=0,len=size*8;this.read=function(count,peek){var ret=0,p=pos>>3,r=7-pos%8;for(var i=0,c=view.getUint8(p+ptr);i<count;i++,r--){ret=ret<<1|c>>r&1;if(r)continue;p++;r=8;c=view.getUint8(p+ptr)}if(!peek)pos+=count;return ret};this.bits=function(){return len-pos}}var Box_parser=function(opt){this.conf_update(opt)};Box_parser.prototype={};Box_parser.prototype.conf_update=function(conf){this.force_he_aac_on_low_freq=conf.force_he_aac_on_low_freq};Box_parser.prototype.header=function(opt){while(opt.ptr+opt.buffer.b_pos>=opt.branch.last){if(opt.branch._id=="movie_box")opt.root.h_parsed=true;opt.branch=opt.branch.parent}opt.type=null;opt.offset=8;if(opt.buffer.b_size-opt.ptr<8)return opt.offset=0;opt.size=opt.view.getUint32(opt.ptr);if(opt.size==1){opt.offset=16;if(opt.buffer.b_size-opt.ptr<16)return opt.offset=0;opt.size=(opt.view.getUint32(opt.ptr+8)<<32)+opt.view.getUint32(opt.ptr+12)}opt.type=int_to_str(opt.view.getUint32(opt.ptr+4));if(full_box.includes(opt.type)){opt.offset+=4;if(opt.buffer.b_size-opt.ptr<opt.offset)return opt.offset=0;var extra=opt.view.getUint8(opt.ptr+opt.offset-4);opt.ver=extra>>>24;opt.flags=extra&&16777215}opt.size-=opt.offset;opt.ptr+=opt.offset};Box_parser.prototype.parse=function(opt){if(!this[opt.type])throw new Error("Unknown box type: "+opt.type);this[opt.type](opt)};raw_copy.forEach(function(cont){Box_parser.prototype[cont]=function(opt){var data=opt.branch[cont]=new Uint8Array(opt.size);data.set(opt.buffer._buff.subarray(opt.ptr,opt.ptr+opt.size))}});Object.keys(containers).forEach(function(cont){Box_parser.prototype[cont]=function(opt){var elm=containers[cont];opt.branch[elm.name]=opt.branch[elm.name]||(elm.multi?[]:{});var new_branch=opt.branch[elm.name];if(elm.multi){new_branch.push({});new_branch=new_branch[new_branch.length-1]}new_branch.parent=opt.branch;new_branch.last=opt.buffer.b_pos+opt.ptr+opt.size;new_branch._id=elm.name;opt.branch=new_branch;opt.size=0}});Box_parser.prototype.moov=function(opt){var new_branch=opt.branch.movie_box=opt.branch.movie_box||{};new_branch.parent=opt.branch;new_branch.last=opt.buffer.b_pos+opt.ptr+opt.size;new_branch._id="movie_box";if(opt.buffer.b_pos<256)opt.branch.start_hdr_sz=opt.size;else opt.branch.end_hdr_sz=opt.size;opt.branch=new_branch;opt.size=0};function get_hd_times(opt){var view=opt.view,ptr=opt.ptr,is_tk=opt.type=="tkhd";if(!opt.ver){return[view.getUint32(ptr),view.getUint32(ptr+4),view.getUint32(ptr+8),view.getUint32(ptr+(is_tk?16:12))]}return[getUint64(view,ptr),getUint64(view,ptr+8),view.getUint32(ptr+16),getUint64(view,ptr+(is_tk?24:20))]}function get_table(view,ptr,cnt,tbl){for(var i=0;i<cnt;i++)tbl[i]=view.getUint32(ptr+i*4)}Box_parser.prototype.ftyp=function(opt){opt.branch.major_brand=int_to_str(opt.view.getUint32(opt.ptr));opt.branch.minor_version=opt.view.getUint32(opt.ptr+4);opt.branch.compatible=[opt.branch.major_brand];for(var i=8;i<opt.size;i+=4)opt.branch.compatible.push(int_to_str(opt.view.getUint32(opt.ptr+i)))};Box_parser.prototype.mdat=function(){};Box_parser.prototype.free=function(){};Box_parser.prototype.wide=function(){};Box_parser.prototype.skip=function(){};Box_parser.prototype.mvhd=function(opt){var view=opt.view,ptr=opt.ptr;var offset=opt.ver?28:16;var hdr=opt.branch.mv_hdr={};var times=get_hd_times(opt);hdr.creation_time=times[0];hdr.modification_time=times[1];hdr.time_scale=times[2];hdr.duration=times[3];ptr+=offset;hdr.rate=view.getUint32(ptr)/65536;hdr.volume=view.getUint16(ptr+4)/256;get_table(opt.view,ptr+16,9,hdr.matrix=[]);hdr.next_track=view.getUint32(ptr+76)};Box_parser.prototype.tkhd=function(opt){var view=opt.view,ptr=opt.ptr;var offset=opt.ver?40:28;var hdr=opt.branch.tk_hdr={};var times=get_hd_times(opt);hdr.enabled=!!(opt.flags&1);hdr.in_movie=!!(opt.flags&2);hdr.in_preview=!!(opt.flags&4);hdr.creation_time=times[0];hdr.modification_time=times[1];hdr.track_id=times[2];hdr.duration=times[3];ptr+=offset;hdr.layer=view.getUint16(ptr);hdr.alternate_group=view.getUint16(ptr+2);hdr.volume=view.getInt16(ptr+4)/256;get_table(opt.view,ptr+8,9,hdr.matrix=[]);hdr.width=view.getUint32(ptr+44)/65536;hdr.height=view.getUint32(ptr+48)/65536};Box_parser.prototype.mdhd=function(opt){var view=opt.view,ptr=opt.ptr;var offset=opt.ver?28:16;var hdr=opt.branch.md_hdr={};var times=get_hd_times(opt);hdr.creation_time=times[0];hdr.modification_time=times[1];hdr.time_scale=times[2];hdr.duration=times[3];var lang=view.getUint16(ptr+offset);hdr.lang=String.fromCharCode(lang>>10|96,lang>>5&31|96,lang&31|96)};Box_parser.prototype.elst=function(opt){var view=opt.view,ptr=opt.ptr+4;var count=view.getUint32(opt.ptr);opt.branch.list=[];for(var i=0;i<count;ptr+=4,i++){var elm={};elm.segment_duration=opt.ver?getUint64(view,ptr):view.getUint32(ptr);elm.media_time=opt.ver?getInt64(view,ptr+8):view.getInt32(ptr+4);ptr+=opt.ver?16:8;elm.media_rate=view.getInt16(ptr);opt.branch.list.push(elm)}};Box_parser.prototype.cslg=function(opt){var view=opt.view,ptr=opt.ptr;opt.branch.cslg={ctts_shift:view.getInt32(ptr),min_ctts:view.getInt32(ptr+4),max_ctts:view.getInt32(ptr+8),min_cts:view.getInt32(ptr+12),max_cts:view.getInt32(ptr+16)}};Box_parser.prototype.hdlr=function(opt){opt.branch.handler=int_to_str(opt.view.getUint32(opt.ptr+4))};Box_parser.prototype._parse_avcc=function(opt,elm){elm.avcc=new Uint8Array(opt.size);elm.avcc.set(opt.buffer._buff.subarray(opt.ptr,opt.ptr+opt.size));var view=opt.view,ptr=opt.ptr;var sps=elm.sps=[];var pps=elm.pps=[];elm.avc_p_i=view.getUint8(ptr+1);elm.prof_compat=view.getUint8(ptr+2);elm.avc_l_i=view.getUint8(ptr+3);elm.l_size_m_1=view.getUint8(ptr+4)&3;elm.n_sps=view.getUint8(ptr+5)&31;var offset=6;for(var i=0;i<elm.n_sps;i++){sps[i]={l:view.getUint16(ptr+offset)};offset+=2;sps[i].nal=new Uint8Array(opt.buffer._buff.subarray(ptr+offset,ptr+offset+sps[i].l));offset+=sps[i].l}elm.n_pps=view.getUint8(ptr+offset++);for(i=0;i<elm.n_pps;i++){pps[i]={l:view.getUint16(ptr+offset)};offset+=2;pps[i].nal=new Uint8Array(opt.buffer._buff.subarray(ptr+offset,ptr+offset+pps[i].l));offset+=pps[i].l}};Box_parser.prototype._parse_esds=function(opt,elm){var view=opt.view,ptr=opt.ptr;while(ptr<opt.ptr+opt.size){var tag=view.getUint8(ptr++);var sz=0,sb;do{sb=view.getUint8(ptr++);sz=(sz<<7)+(sb&127)}while(sb&128);switch(tag){case 3:elm.es_id=view.getUint16(ptr);var flags=view.getUint8(ptr+2);ptr+=3+(flags>>6&2)+(flags>>4&2);break;case 4:elm.obj_t=view.getUint8(ptr);elm.str_t=view.getUint8(ptr+1)&63;ptr+=13;break;case 5:var ext_type,sbr=-1,br=new Bit_reader(view,ptr,sz);elm.aot=br.read(5);if(elm.aot==31)elm.aot=32+br.read(6);elm.freq=br.read(4);if(elm.freq==15)elm.freq=br.read(24);elm.channel=br.read(4);if(elm.aot==5||elm.aot==29){ext_type=5;if((elm.ext_freq_index=br.read(4))==15)elm.ext_freq=br.read(24);elm.aot=br.read(5);if(elm.aot==31)elm.aot=32+br.read(6)}if(ext_type!=5&&elm.aot!=36){while(br.bits()>=16){if(br.read(11,1)==695){br.read(11);if(br.read(5)==5){if(sbr=br.read(1)){if(br.read(4)==15)br.read(24);if(br.bits()>=12&&br.read(11)==1352&&br.read(1)!=1){elm.dsi=5}}}}else br.read(1)}if(this.force_he_aac_on_low_freq&&elm.aot==2&&!elm.dsi&&elm.channel>1&&elm.freq>=6&&sbr==-1){elm.dsi=5;elm.ext_freq=elm.freq-3}}ptr+=sz;break;default:ptr+=sz}}};Box_parser.prototype.stsd=function(opt){var view=opt.view,count=view.getUint32(opt.ptr);var handler=opt.branch.parent.parent.handler,i,j;opt.branch.list={};opt.ptr+=4;for(i=0;i<count;i++){this.header(opt);var elm={};var index=view.getUint16(opt.ptr+6);var last_ptr=opt.ptr+opt.size;switch(handler){case"vide":elm.width=view.getUint16(opt.ptr+24);elm.height=view.getUint16(opt.ptr+26);elm.h_res=view.getUint32(opt.ptr+28)/65536;elm.v_res=view.getUint32(opt.ptr+32)/65536;elm.f_count=view.getUint16(opt.ptr+40);
elm.compressor="";for(j=0;j<32;j++){var c=view.getUint8(opt.ptr+42+j);if(!c)break;elm.compressor+=String.fromCharCode()}elm.depth=view.getUint16(opt.ptr+74);opt.ptr+=78;var skip_boxes=[1668246642,1668047216,1885434736,1718183276];while(skip_boxes.includes(view.getUint32(opt.ptr+4)))opt.ptr+=view.getUint32(opt.ptr);switch(view.getUint32(opt.ptr+4)){case 1635148611:elm.avcc={};this.header(opt);this._parse_avcc(opt,elm.avcc);break;case 1702061171:elm.esds={};this.header(opt);this._parse_esds(opt,elm.esds);break;case 1752589123:elm.hvcc={};break}break;case"soun":elm.c_count=view.getUint16(opt.ptr+16);elm.s_size=view.getUint16(opt.ptr+18);elm.s_rate=view.getUint32(opt.ptr+24)/65536;for(j=32;j<opt.size-12;j++){if(view.getUint32(opt.ptr+j)==1702061171){elm.esds={};opt.ptr+=j-4;this.header(opt);this._parse_esds(opt,elm.esds);break}}break;default:}opt.ptr=last_ptr;opt.branch.list[index]=elm}opt.size=0};Box_parser.prototype.stts=function(opt){var cnt=opt.view.getUint32(opt.ptr),ptr=opt.ptr+4;opt.branch.dtts=[];for(var i=0;i<cnt;i++){var u_cnt=opt.view.getUint32(opt.ptr+4+i*8);var data=opt.view.getUint32(ptr+i*8+4);for(var j=0;j<u_cnt;j++)opt.branch.dtts.push(data)}};Box_parser.prototype.ctts=function(opt){var cnt=opt.view.getUint32(opt.ptr),ptr=opt.ptr+4;opt.branch.ctts=[];for(var i=0;i<cnt;i++){var u_cnt=opt.view.getUint32(ptr+i*8);var data=opt.view.getInt32(ptr+i*8+4);for(var j=0;j<u_cnt;j++)opt.branch.ctts.push(data)}};Box_parser.prototype.stsc=function(opt){var count=opt.view.getUint32(opt.ptr);var table=opt.branch.s_t_c=[];var view=opt.view,ptr=opt.ptr+4;for(var i=0;i<count;i++){table[i]={f_c:view.getUint32(ptr+i*12),s_p_c:view.getUint32(ptr+i*12+4),s_d_i:view.getUint32(ptr+i*12+8)}}table.sort(function(c1,c2){return c1.f_c-c2.f_c})};Box_parser.prototype.stss=function(opt){get_table(opt.view,opt.ptr+4,opt.view.getUint32(opt.ptr),opt.branch.s_sync=[])};Box_parser.prototype.stps=function(opt){get_table(opt.view,opt.ptr+4,opt.view.getUint32(opt.ptr),opt.branch.s_psync=[])};Box_parser.prototype.sdtp=function(opt){opt.branch.s_dep=[];for(var i=0;i<opt.size;i++){var bt=opt.view.getUint8(opt.ptr+i);opt.branch.s_dep[i]={red:bt&3,is_dep:bt>>2&3,dep:bt>>4&3,lead:bt>>6&3}}};Box_parser.prototype.stsz=function(opt){var size=opt.view.getUint32(opt.ptr);opt.branch.s_sz=[];opt.branch.s_count=opt.view.getUint32(opt.ptr+4);if(!size)get_table(opt.view,opt.ptr+8,opt.branch.s_count,opt.branch.s_sz);else{for(var i=0;i<opt.branch.s_count;i++)opt.branch.s_sz.push(size)}};Box_parser.prototype.stco=function(opt){get_table(opt.view,opt.ptr+4,opt.view.getUint32(opt.ptr),opt.branch.c_off=[])};Box_parser.prototype.co64=function(opt){var cnt=opt.view.getUint32(opt.ptr);opt.branch.c_off=[];for(var i=0;i<cnt;i++)opt.branch.c_off[i]=getUint64(opt.view,opt.ptr+4+i*8)};var Chunk_parser=function(opt){this.conf_update(opt)};Chunk_parser.prototype={};Chunk_parser.prototype.conf_update=function(conf){this.break_on_count=conf.break_on_count;this.frag_size=conf.frag_size||10;this.disable_val_frame_nal_len4=conf.disable_val_frame_nal_len4};Chunk_parser.prototype.process=function(opt){var event={type:"metadata",tracks:[],brands:["iso5","iso6"],matrix:opt.root.movie_box.mv_hdr.matrix,start_hdr_sz:opt.root.start_hdr_sz,end_hdr_sz:opt.root.end_hdr_sz};var _this=this;event.duration=Math.floor(opt.root.movie_box.mv_hdr.duration*9e4/opt.root.movie_box.mv_hdr.time_scale);event.timescale=9e4;event.s_info=this.s_info=[];event.s_p=this.s_p=[];opt.root.movie_box.track_info.forEach(function(tr){if(!["vide","soun"].includes(tr.media_box.handler)||!tr.media_box.media_info.sample_table.list[1].esds&&tr.media_box.handler=="soun"){return}var elm={id:tr.tk_hdr.track_id,ts:tr.media_box.md_hdr.time_scale,type:tr.media_box.handler,s_off:[],s_time:[],s_dri:[],s_sync:tr.media_box.media_info.sample_table.s_sync||[],s_psync:tr.media_box.media_info.sample_table.s_psync||[],s_sz:tr.media_box.media_info.sample_table.s_sz,s_dep:tr.media_box.media_info.sample_table.s_dep||[],s_ctts:tr.media_box.media_info.sample_table.ctts||[],s_cslg:tr.media_box.media_info.sample_table.cslg||{},s_list:tr.media_box.media_info.sample_table.list};if(tr.edit_list&&tr.edit_list.list.length)elm.elst=tr.edit_list.list;var c_off=tr.media_box.media_info.sample_table.c_off;var s_t_c=tr.media_box.media_info.sample_table.s_t_c;var dtts=tr.media_box.media_info.sample_table.dtts;var c_n=1;var sn=0;var dt=0;var is_sz_arr=Array.isArray(elm.s_sz);for(var i=0;i<s_t_c.length;i++){for(;c_n<(s_t_c[i+1]?s_t_c[i+1].f_c:c_off.length+1);c_n++){var off=c_off[c_n-1];for(var j=0;j<s_t_c[i].s_p_c;j++){elm.s_off[sn]=off;elm.s_time[sn]=dt;elm.s_dri[sn]=s_t_c[i].s_d_i;dt+=dtts[sn];off+=is_sz_arr?elm.s_sz[sn++]:elm.s_sz}}}_this.s_info.push(elm);_this.s_p.push({s:0,max_t:0});if(elm.type=="vide")event.v_idx=_this.v_idx=_this.s_info.length-1;var dr=elm.s_list[1];var event_elm={id:elm.id,type:sample_type[elm.type],edit_list:elm.elst,cslg:elm.s_cslg,dr:dr,timelineStartInfo:{baseMediaDecodeTime:0},bitrate:Math.floor(elm.s_sz.reduce(function(a,b){return a+b})*8*elm.ts/tr.media_box.md_hdr.duration),duration:elm.type=="soun"?tr.media_box.md_hdr.duration:Math.floor(tr.media_box.md_hdr.duration*9e4/elm.ts),samplerate:elm.type=="soun"?elm.ts:9e4,matrix:tr.tk_hdr.matrix,track_width:tr.tk_hdr.width,track_height:tr.tk_hdr.height,nb_samples:elm.s_time.length};if(elm.type=="soun"){var aot=dr.esds.dsi||dr.esds.aot;event_elm.codec="mp4a."+byte_to_hex(dr.esds.obj_t.toString(16))+(aot?"."+aot:"");event_elm.s_i=new Uint8Array([dr.esds.aot<<3|dr.esds.freq>>>1,dr.esds.freq<<7|dr.esds.channel<<3])}else{var avcc;if(avcc=dr.avcc){event_elm.codec="avc1."+byte_to_hex(avcc.avc_p_i)+byte_to_hex(avcc.prof_compat)+byte_to_hex(avcc.avc_l_i);var info=[1,avcc.avc_p_i,avcc.avc_prof_compat,avcc.avc_l_i,255,avcc.sps.length+224];avcc.sps.forEach(function(e){info=info.concat([e.nal.length>>8,e.nal.length&255]);Array.prototype.push.apply(info,e.nal)});info.push(avcc.pps.length);avcc.pps.forEach(function(e){info=info.concat([e.nal.length>>8,e.nal.length&255]);Array.prototype.push.apply(info,e.nal)});event_elm.s_i=new Uint8Array(info);event_elm.avcc=avcc.avcc}else if(dr.hvcc)event_elm.codec="hvc1";else if(dr.esds)event_elm.codec="mp4v"}if(event_elm.edit_list){event_elm.edit_list.forEach(function(e){if(elm.type!="soun")e.media_time=Math.floor(e.media_time*9e4/elm.ts);e.segment_duration=Math.floor(e.segment_duration*9e4/opt.root.movie_box.mv_hdr.time_scale)})}if(event_elm.cslg){for(var k in event_elm.cslg)event_elm.cslg[k]=Math.floor(event_elm.cslg[k]*9e4/elm.ts)}event.tracks.push(event_elm)});opt.stream.trigger("data",event)};Chunk_parser.prototype.is_annexb_avc_len_size4=function(data){var len_size=4,pos=0;while(pos+len_size<data.byteLength){var nal_size=data[pos];nal_size=(nal_size<<8)+data[pos+1];nal_size=(nal_size<<8)+data[pos+2];nal_size=(nal_size<<8)+data[pos+3];pos+=len_size+nal_size}return pos==data.byteLength};Chunk_parser.prototype.parse=function(opt){if(!this.s_info)this.process(opt);var b_start=opt.buffer.b_pos;var b_end=opt.buffer.b_size+b_start;var pc=-1,max_dcd=0,i;var v_fin=false;while(pc){pc=0;for(i=0;i<this.s_p.length;i++){var sinfo=this.s_info[i];var sn=this.s_p[i].s;var pos=sinfo.s_off[sn];var sz=sinfo.s_sz[sn];var time=sinfo.s_time;var valid=true;if(pos>=b_start&&pos+sz<=b_end){this.s_p[i].s++;pc++;var sample={trackId:sinfo.id};sample.type=sample_type[sinfo.type];sample.dts=time[sn];sample.pts=sample.dts+(sinfo.s_ctts[sn]||0);sample.duration=sn==time.length-1?time[sn]-time[sn-1]:time[sn+1]-time[sn];sample.size=sz;this.s_p[i].max_t=sample.dts/sinfo.ts;sample.data=opt.buffer._buff.subarray(pos-b_start,pos+sz-b_start);sample.dr=sinfo.s_list[sinfo.s_dri[sn]];sample.ts=sinfo.ts;sample.synced=!sinfo.s_sync.length||sinfo.s_sync.includes(sn+1);sample.sn=sn;sample.dep=sinfo.s_dep[sn];if(sinfo.type=="vide"&&(this.break_on_count?sn%this.frag_size===0:sample.synced)){opt.stream.flush()}var avcc=sample.dr&&sample.dr.avcc;if(!this.disable_val_frame_nal_len4&&avcc&&avcc.l_size_m_1==3&&sample.type=="video"&&sample.duration<10){valid=this.is_annexb_avc_len_size4(sample.data)}if(valid)opt.stream.trigger("data",sample);max_dcd=pos+sz-b_start}else if(pos+sz>b_end&&i==this.v_idx)v_fin=true}}if(max_dcd)opt.buffer.advance(max_dcd);var new_pos=Infinity;for(i=0;i<this.s_p.length;i++){if(this.s_p[i].s==this.s_info[i].s_off.length){this.s_p[i].finish=true;continue}new_pos=Math.min(new_pos,this.s_info[i].s_off[this.s_p[i].s])}if(new_pos==Infinity)opt.stream.flush();if(new_pos==Infinity||new_pos>=b_start&&new_pos<b_end)new_pos=b_end;return new_pos};Chunk_parser.prototype.seek=function(time,use_ss){if(!this.s_info)throw new Error("No metadata information for seeking");var target=time*9e4;var m_pos=Infinity;function get_frame(target,elm,use_ss){var l,r,sn,m,m_time,tt;var i_ss=use_ss&&elm.s_sync.length>0;var i_soun=elm.type=="soun";var scale=elm.ts/9e4;l=0;r=i_ss?elm.s_sync.length:elm.s_time.length;tt=Math.floor(target*scale);while(l<r-1){m=l+r>>1;sn=i_ss?elm.s_sync[m]-1:m;if((m_time=elm.s_time[sn]+(elm.s_ctts[sn]|0))>tt)r=m;else{l=m;if(m_time==tt)break}}var res_sn=i_ss?elm.s_sync[l]-1:l;tt=m_time=elm.s_time[res_sn]+(elm.s_ctts[res_sn]|0);if(!i_ss&&elm.s_ctts.length){for(sn=l-1;sn>l-10;sn--){if(elm.s_time[sn]+(elm.s_ctts[sn]|0)>tt)res_sn=sn}for(sn=res_sn;sn<l+10;sn++){m_time=elm.s_time[sn]+(elm.s_ctts[sn]|0);if(m_time>((elm.s_cslg&&elm.s_cslg.min_ctts)|0)&&m_time<tt){tt=m_time}}}return{sn:res_sn,min_t:tt/elm.ts}}if(this.v_idx!==undefined){var elm=this.s_info[this.v_idx];var v_fr=get_frame(target,elm,use_ss);var v_sn=v_fr.sn;this.s_p[this.v_idx].s=v_sn;this.s_p[this.v_idx].max_t=(elm.s_time[v_sn]+(elm.s_ctts[v_sn]|0))/elm.ts;target=v_fr.min_t*9e4;m_pos=elm.s_off[v_sn]}var _this=this;this.s_info.forEach(function(elm,idx){if(idx==_this.v_idx)return;var s_sn=get_frame(target,elm,use_ss).sn;_this.s_p[idx].s=s_sn;_this.s_p[idx].max_t=(elm.s_time[s_sn]+(elm.s_ctts[s_sn]|0))/elm.ts;m_pos=Math.min(elm.s_off[s_sn],m_pos)});return{offset:m_pos,time:this.s_p[this.v_idx!==undefined?this.v_idx:0].max_t}};var Buffer=function(){this._buff=new Uint8Array(3*1048576);this.b_pos=0;this.b_size=0;this.pos=0};Buffer.prototype={};Buffer.prototype.advance=function(ptr){this._buff.set(this._buff.subarray(ptr,this.b_size));this.b_pos+=ptr;this.b_size-=ptr};Buffer.prototype.push=function(chunk){var _newbuff;var c_len=chunk.length;while(c_len+this.b_size>this._buff.length){_newbuff=new Uint8Array(2*this._buff.length);_newbuff.set(this._buff);this._buff=_newbuff}if(this.pos<this.b_pos+this.b_size&&this.pos+c_len>=this.b_pos){_newbuff=new Uint8Array(Math.max(this.pos+c_len,this.b_pos+this.b_size)-Math.min(this.pos,this.b_pos));if(this.pos<=this.b_pos){_newbuff.set(chunk);if(this.pos+c_len<this.b_pos+this.b_size){_newbuff.set(this._buff.subarray(this.pos+c_len-this.b_pos,this.b_size),c_len)}}else{_newbuff.set(this._buff.subarray(0,this.pos-this.b_pos));_newbuff.set(chunk,this.pos-this.b_pos)}this._buff.set(_newbuff);this.b_size=_newbuff.length;_newbuff=null;this.b_pos=Math.min(this.b_pos,this.pos)}else if(this.pos==this.b_pos+this.b_size){this._buff.set(chunk,this.b_size);this.b_size+=c_len}else{this._buff.set(chunk);this.b_size=c_len;this.b_pos=this.pos}this.view=new DataView(this._buff.buffer,this._buff.byteOffset,this.b_size)};var MP4ParserStream=function(opt){if(!(this instanceof MP4ParserStream))return new MP4ParserStream(opt);MP4ParserStream.prototype.init.call(this);this.buffer=new Buffer;this.b_parser=new Box_parser(opt);this.c_parser=new Chunk_parser(opt);this.on("confupdate",function(conf){this.c_parser.conf_update(conf);this.b_parser.conf_update(conf)});this.metadata={};this.buffer.pos=opt.pos||0;if(opt.metadata){this.metadata.h_parsed=true;this.c_parser.s_info=opt.metadata.s_info.slice();this.c_parser.s_p=opt.metadata.s_p.slice();this.c_parser.v_idx=opt.metadata.v_idx}};MP4ParserStream.prototype=new Stream;MP4ParserStream.prototype.constructor=MP4ParserStream;MP4ParserStream.prototype.get_tl=function(id){if(!this.metadata.h_parsed)throw new Error("No metadata information for time map");var t_i=this.c_parser.s_info.filter(function(e){return e.id==id});if(!t_i.length)throw new Error("No track information for time map");return{offset:t_i[0].s_off.slice(0),time:t_i[0].s_time.map(function(e){return e/t_i[0].ts})}};MP4ParserStream.prototype.push=function(chunk){this.buffer.push(chunk);var opt={root:this.metadata,branch:this.metadata,buffer:this.buffer,view:this.buffer.view,stream:this,ptr:0};while(!this.metadata.h_parsed){this.b_parser.header(opt);if(!opt.type||opt.size+opt.ptr>this.buffer.b_size)break;this.b_parser.parse(opt);opt.ptr+=opt.size}if(trigger_on_headers.includes(opt.type))this.trigger("header_found",{type:opt.type,pos:this.buffer.b_pos});if(this.metadata.h_parsed)this.buffer.pos=this.c_parser.parse(opt);else{this.buffer.advance(opt.ptr-opt.offset);this.buffer.pos=this.buffer.b_pos+(opt.type=="mdat"?opt.size+opt.offset:this.buffer.b_size)}return this.buffer.pos};MP4ParserStream.prototype.seek=function(time,use_ssync,opt){if(opt&&opt.offset!==undefined)return void(this.buffer.pos=opt.offset);this.trigger("data",{type:"seek"});var seek_info=this.c_parser.seek(time,use_ssync);seek_info.prev=this.buffer.pos;this.buffer.pos=seek_info.offset;return seek_info};MP4ParserStream.prototype.get_buf_pos=function(){return this.buffer.pos};var AudioFilterStream=function(){if(!(this instanceof AudioFilterStream))return new AudioFilterStream;AudioFilterStream.prototype.init.call(this)};AudioFilterStream.prototype=new Stream;AudioFilterStream.prototype.constructor=AudioFilterStream;AudioFilterStream.prototype.push=function(packet){if(packet.type!="audio")return;var scale=9e4/packet.ts;packet.pts=Math.floor(packet.pts*scale);packet.dts=Math.floor(packet.dts*scale);this.trigger("data",{type:"audio",samplerate:packet.dr.s_rate,samplesize:packet.dr.s_size,audioobjecttype:packet.dr.esds.aot,samplingfrequencyindex:packet.dr.esds.freq,channelcount:packet.dr.esds.channel,ts:packet.ts,dts:packet.dts,pts:packet.pts,data:new Uint8Array(packet.data)})};var VideoFilterStream=function(){if(!(this instanceof VideoFilterStream))return new VideoFilterStream;VideoFilterStream.prototype.init.call(this);this.synced=false;this.au=new Uint8Array([9,240])};VideoFilterStream.prototype=new Stream;VideoFilterStream.prototype.constructor=VideoFilterStream;VideoFilterStream.prototype.flush=function(){this.dr=null;this.synced=false;this.trigger("done")};VideoFilterStream.prototype.push=function(packet){if(packet.type!="video")return;var pos=0,i;var view=new DataView(packet.data.buffer,packet.data.byteOffset,packet.data.byteLength);var scale=9e4/packet.ts;packet.pts=Math.floor(packet.pts*scale);packet.dts=Math.floor(packet.dts*scale);this.trigger("data",{trackId:packet.trackId,pts:packet.pts,dts:packet.dts,data:this.au,nalUnitType:"access_unit_delimiter_rbsp"});if(this.dr!=packet.dr||!this.synced){this.dr=packet.dr;if(this.dr.avcc.n_sps){for(i=0;i<this.dr.avcc.n_sps;i++){this.trigger("data",{trackId:packet.trackId,pts:packet.pts,dts:packet.dts,nalUnitType:"seq_parameter_set_rbsp",data:this.dr.avcc.sps[i].nal,config:{profileIdc:this.dr.avcc.avc_p_i,levelIdc:this.dr.avcc.avc_l_i,profileCompatibility:this.dr.avcc.prof_compat,width:this.dr.width,height:this.dr.height}})}}if(this.dr.avcc.n_pps){for(i=0;i<this.dr.avcc.n_pps;i++){this.trigger("data",{trackId:packet.trackId,pts:packet.pts,dts:packet.dts,nalUnitType:"pic_parameter_set_rbsp",data:this.dr.avcc.pps[0].nal})}}this.synced=true}while(pos<packet.data.length){var sz=view.getUint32(pos);var event={trackId:packet.trackId,pts:packet.pts,dts:packet.dts,data:new Uint8Array(packet.data.subarray(pos+4,pos+sz+4))};if((event.data[0]&31)==5)event.nalUnitType="slice_layer_without_partitioning_rbsp_idr";event.synced=!pos&&packet.synced;pos+=sz+4;this.trigger("data",event)}};var MP4BuilderStream=function(opt){if(!(this instanceof MP4BuilderStream))return new MP4BuilderStream(opt);MP4BuilderStream.prototype.init.call(this);this.options=opt||{};this.tracks={};this.options.no_multi_init=true;this.options.major=new Uint8Array([105,115,111,53]);this.options.compatible=[new Uint8Array([105,115,111,54])];this.options.set_duration=true;this.on("confupdate",function(conf){this.options.break_on_count=conf.break_on_count;this.options.mark_non_sync=conf.mark_non_sync;this.options.disable_edts=conf.disable_edts});this.metadata=opt.metadata;this.inited=!!this.metadata};MP4BuilderStream.prototype=new Stream;MP4BuilderStream.prototype.constructor=MP4BuilderStream;MP4BuilderStream.prototype.push=function(packet){var id;if(packet.type=="metadata"){this.metadata=packet;return void setInterval(this.flush_meta.bind(this),0)}if(packet.type=="seek"){for(id in this.tracks)this.tracks[id].samples=[];return}id=packet.trackId;this.tracks[id]=this.tracks[id]||{samples:[],seqno:0,sc:0,type:packet.type};var sample={duration:packet.duration,size:packet.size,dts:packet.dts,pts:packet.pts,data:new Uint8Array(packet.data),sn:packet.sn};if(packet.type=="video"){var scale=9e4/packet.ts;sample.duration=Math.floor(sample.duration*scale);sample.pts=Math.floor(sample.pts*scale);sample.dts=Math.floor(sample.dts*scale);sample.flags={dependsOn:(sample.dep&&sample.dep.dep)|0,isDependedOn:(sample.dep&&sample.dep.is_dep)|0,hasRedundancy:(sample.dep&&sample.dep.red)|0||2*packet.synced,isLeading:(sample.dep&&sample.dep.lead)|0};if(!this.options.break_on_count||this.options.mark_non_sync)sample.flags.isNonSyncSample=+!packet.synced;sample.compositionTimeOffset=sample.pts-sample.dts}packet.data=null;this.tracks[id].samples.push(sample)};MP4BuilderStream.prototype.flush_meta=function(){if(this.inited)return;this.inited=true;var inits=[],_this=this;this.metadata.tracks.forEach(function(tr){switch(tr.type){case"video":var avcc;if(avcc=tr.dr.avcc){tr.profileIdc=avcc.avc_p_i;tr.levelIdc=avcc.avc_l_i;tr.profileCompatibility=avcc.prof_compat;tr.sps=avcc.sps.map(function(e){return e.nal});tr.pps=avcc.pps.map(function(e){return e.nal})}tr.width=tr.track_width;tr.height=tr.track_height;break;case"audio":tr.samplesize=tr.dr.s_size;tr.audioobjecttype=tr.dr.esds.aot;tr.samplingfrequencyindex=tr.dr.esds.freq;tr.channelcount=tr.dr.esds.channel}if(tr.edit_list){tr.edit_list.forEach(function(el){el.segment_duration=0});if(_this.options.disable_edts)delete tr.edit_list}inits.push({id:tr.id,buffer:mp4.initSegment([tr],_this.options)})});this.trigger("data",{init:true,inits:inits})};MP4BuilderStream.prototype.flush=function(){var moof,mdat,seg_sz;if(!this.inited)this.flush_meta();for(var id in this.tracks){var track=this.tracks[id];if(!track.samples.length)continue;var seg_slice=track.samples;seg_sz=seg_slice.reduce(function(a,b){return a+b.data.length},0);moof=mp4.moof(++track.seqno,[{id:id,baseMediaDecodeTime:seg_slice[0].dts,samples:seg_slice,type:track.type}],this.options);var segment=new Uint8Array(8+seg_sz+moof.length);var sd=new Uint8Array(seg_sz);var offset=0;for(var i=0;i<seg_slice.length;i++){sd.set(seg_slice[i].data,offset);offset+=seg_slice[i].data.length}mdat=mp4.mdat(sd);segment.set(moof);segment.set(mdat,moof.length);segment.sn=seg_slice[seg_slice.length-1].sn;sd=mdat=moof=null;this.tracks[id].sc+=seg_slice.length;this.trigger("data",{id:id,data:segment,sc:this.tracks[id].sc});this.tracks[id].samples=[]}this.trigger("done")};module.exports={MP4ParserStream:MP4ParserStream,AudioFilterStream:AudioFilterStream,VideoFilterStream:VideoFilterStream,MP4BuilderStream:MP4BuilderStream}},{16:16,22:22}],18:[function(_dereq_,module,exports){var Stream=_dereq_(22);var mp4=_dereq_(16);var mp4p=_dereq_(17);var m2ts=_dereq_(11);var codecs=_dereq_(4);var AdtsStream=codecs.adts;var H264Stream=codecs.h264.H264Stream;var AacStream=_dereq_(1);var AUDIO_PROPERTIES=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"];var VIDEO_PROPERTIES=["width","height","profileIdc","levelIdc","profileCompatibility"];var ONE_SECOND_IN_TS=9e4;var VideoSegmentStream,AudioSegmentStream,Transmuxer,CoalesceStream;var createDefaultSample,isLikelyAacData,collectDtsInfo,clearDtsInfo,calculateTrackBaseMediaDecodeTime,arrayEquals,sumFrameByteLengths;createDefaultSample=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0}}};isLikelyAacData=function(data){if(data[0]==="I".charCodeAt(0)&&data[1]==="D".charCodeAt(0)&&data[2]==="3".charCodeAt(0)){return true}return false};arrayEquals=function(a,b){var i;if(a.length!==b.length){return false}for(i=0;i<a.length;i++){if(a[i]!==b[i]){return false}}return true};sumFrameByteLengths=function(array){var i,currentObj,sum=0;for(i=0;i<array.length;i++){currentObj=array[i];sum+=currentObj.data.byteLength}return sum};AudioSegmentStream=function(track){var adtsFrames=[],sequenceNumber=0,earliestAllowedDts=0;AudioSegmentStream.prototype.init.call(this);this.push=function(data){collectDtsInfo(track,data);if(track){AUDIO_PROPERTIES.forEach(function(prop){track[prop]=data[prop]})}adtsFrames.push(data)};this.setEarliestDts=function(earliestDts){earliestAllowedDts=earliestDts-track.timelineStartInfo.baseMediaDecodeTime};this.flush=function(){var frames,moof,mdat,boxes;if(adtsFrames.length===0){this.trigger("done","AudioSegmentStream");return}frames=this.trimAdtsFramesByEarliestDts_(adtsFrames);track.samples=this.generateSampleTable_(frames);mdat=mp4.mdat(this.concatenateFrameData_(frames));adtsFrames=[];calculateTrackBaseMediaDecodeTime(track);moof=mp4.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);clearDtsInfo(track);this.trigger("data",{track:track,boxes:boxes});this.trigger("done","AudioSegmentStream")};this.trimAdtsFramesByEarliestDts_=function(adtsFrames){if(track.minSegmentDts>=earliestAllowedDts){return adtsFrames}track.minSegmentDts=Infinity;return adtsFrames.filter(function(currentFrame){if(currentFrame.dts>=earliestAllowedDts){track.minSegmentDts=Math.min(track.minSegmentDts,currentFrame.dts);track.minSegmentPts=track.minSegmentDts;return true}return false})};this.generateSampleTable_=function(frames){var i,currentFrame,samples=[];for(i=0;i<frames.length;i++){currentFrame=frames[i];samples.push({size:currentFrame.data.byteLength,duration:1024})}return samples};this.concatenateFrameData_=function(frames){var i,currentFrame,dataOffset=0,data=new Uint8Array(sumFrameByteLengths(frames));for(i=0;i<frames.length;i++){currentFrame=frames[i];data.set(currentFrame.data,dataOffset);dataOffset+=currentFrame.data.byteLength}return data}};AudioSegmentStream.prototype=new Stream;VideoSegmentStream=function(track){var sequenceNumber=0,nalUnits=[],config,pps;VideoSegmentStream.prototype.init.call(this);delete track.minPTS;this.gopCache_=[];this.push=function(nalUnit){collectDtsInfo(track,nalUnit);if(nalUnit.nalUnitType===codecs.h264.unitTypes.seq_parameter_set_rbsp&&!config){config=nalUnit.config;track.sps=[nalUnit.data];VIDEO_PROPERTIES.forEach(function(prop){track[prop]=config[prop]},this)}if(nalUnit.nalUnitType===codecs.h264.unitTypes.pic_parameter_set_rbsp&&!pps){pps=nalUnit.data;track.pps=[nalUnit.data]}nalUnits.push(nalUnit)};this.flush=function(){var frames,gopForFusion,gops,moof,mdat,boxes;while(nalUnits.length&&nalUnits[0].nalUnitType!==codecs.h264.unitTypes.access_unit_delimiter_rbsp){nalUnits.shift()}if(nalUnits.length===0){this.resetStream_();this.trigger("done","VideoSegmentStream");return}frames=this.groupNalsIntoFrames_(nalUnits);gops=this.groupFramesIntoGops_(frames);if(!gops[0][0].keyFrame){gopForFusion=this.getGopForFusion_(nalUnits[0],track);if(gopForFusion){gops.unshift(gopForFusion);gops.byteLength+=gopForFusion.byteLength;gops.nalCount+=gopForFusion.nalCount;gops.pts=gopForFusion.pts;gops.dts=gopForFusion.dts;gops.duration+=gopForFusion.duration}else{gops=this.extendFirstKeyFrame_(gops)}}collectDtsInfo(track,gops);track.samples=this.generateSampleTable_(gops);mdat=mp4.mdat(this.concatenateNalData_(gops));this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps});this.gopCache_.length=Math.min(6,this.gopCache_.length);nalUnits=[];calculateTrackBaseMediaDecodeTime(track);this.trigger("timelineStartInfo",track.timelineStartInfo);moof=mp4.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);this.trigger("data",{track:track,boxes:boxes});this.resetStream_();this.trigger("done","VideoSegmentStream")};this.resetStream_=function(){clearDtsInfo(track);config=undefined;pps=undefined};this.getGopForFusion_=function(nalUnit){var halfSecond=45e3,allowableOverlap=1e4,nearestDistance=Infinity,dtsDistance,nearestGopObj,currentGop,currentGopObj,i;for(i=0;i<this.gopCache_.length;i++){currentGopObj=this.gopCache_[i];currentGop=currentGopObj.gop;if(!(track.pps&&arrayEquals(track.pps[0],currentGopObj.pps[0]))||!(track.sps&&arrayEquals(track.sps[0],currentGopObj.sps[0]))){continue}if(currentGop.dts<track.timelineStartInfo.dts){continue}dtsDistance=nalUnit.dts-currentGop.dts-currentGop.duration;if(dtsDistance>=-allowableOverlap&&dtsDistance<=halfSecond){if(!nearestGopObj||nearestDistance>dtsDistance){nearestGopObj=currentGopObj;nearestDistance=dtsDistance}}}if(nearestGopObj){return nearestGopObj.gop}return null};this.extendFirstKeyFrame_=function(gops){var currentGop;if(!gops[0][0].keyFrame&&gops.length>1){currentGop=gops.shift();gops.byteLength-=currentGop.byteLength;gops.nalCount-=currentGop.nalCount;gops[0][0].dts=currentGop.dts;gops[0][0].pts=currentGop.pts;gops[0][0].duration+=currentGop.duration}return gops};this.groupNalsIntoFrames_=function(nalUnits){var i,currentNal,currentFrame=[],frames=[];currentFrame.byteLength=0;for(i=0;i<nalUnits.length;i++){currentNal=nalUnits[i];if(currentNal.nalUnitType===codecs.h264.unitTypes.access_unit_delimiter_rbsp){if(currentFrame.length){currentFrame.duration=currentNal.dts-currentFrame.dts;frames.push(currentFrame)}currentFrame=[currentNal];currentFrame.byteLength=currentNal.data.byteLength;currentFrame.pts=currentNal.pts;currentFrame.dts=currentNal.dts}else{if(currentNal.nalUnitType===codecs.h264.unitTypes.slice_layer_without_partitioning_rbsp_idr){currentFrame.keyFrame=true}currentFrame.duration=currentNal.dts-currentFrame.dts;currentFrame.byteLength+=currentNal.data.byteLength;currentFrame.push(currentNal)}}if(frames.length&&(!currentFrame.duration||currentFrame.duration<=0)){currentFrame.duration=frames[frames.length-1].duration}frames.push(currentFrame);return frames};this.groupFramesIntoGops_=function(frames){var i,currentFrame,currentGop=[],gops=[];currentGop.byteLength=0;currentGop.nalCount=0;currentGop.duration=0;currentGop.pts=frames[0].pts;currentGop.dts=frames[0].dts;gops.byteLength=0;gops.nalCount=0;gops.duration=0;gops.pts=frames[0].pts;gops.dts=frames[0].dts;for(i=0;i<frames.length;i++){currentFrame=frames[i];if(currentFrame.keyFrame){if(currentGop.length){gops.push(currentGop);gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration}currentGop=[currentFrame];currentGop.nalCount=currentFrame.length;currentGop.byteLength=currentFrame.byteLength;currentGop.pts=currentFrame.pts;currentGop.dts=currentFrame.dts;currentGop.duration=currentFrame.duration}else{currentGop.duration+=currentFrame.duration;currentGop.nalCount+=currentFrame.length;currentGop.byteLength+=currentFrame.byteLength;currentGop.push(currentFrame)}}if(gops.length&&currentGop.duration<=0){currentGop.duration=gops[gops.length-1].duration}gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration;gops.push(currentGop);return gops};this.generateSampleTable_=function(gops,baseDataOffset){var h,i,sample,currentGop,currentFrame,dataOffset=baseDataOffset||0,samples=[];for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];sample=createDefaultSample();sample.dataOffset=dataOffset;sample.compositionTimeOffset=currentFrame.pts-currentFrame.dts;sample.duration=currentFrame.duration;sample.size=4*currentFrame.length;sample.size+=currentFrame.byteLength;if(currentFrame.keyFrame){sample.flags.dependsOn=2}dataOffset+=sample.size;samples.push(sample)}}return samples};this.concatenateNalData_=function(gops){var h,i,j,currentGop,currentFrame,currentNal,dataOffset=0,nalsByteLength=gops.byteLength,numberOfNals=gops.nalCount,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];for(j=0;j<currentFrame.length;j++){currentNal=currentFrame[j];view.setUint32(dataOffset,currentNal.data.byteLength);dataOffset+=4;data.set(currentNal.data,dataOffset);dataOffset+=currentNal.data.byteLength}}}return data}};VideoSegmentStream.prototype=new Stream;collectDtsInfo=function(track,data){if(typeof data.pts==="number"){if(track.timelineStartInfo.pts===undefined){track.timelineStartInfo.pts=data.pts}if(track.minSegmentPts===undefined){track.minSegmentPts=data.pts}else{track.minSegmentPts=Math.min(track.minSegmentPts,data.pts)}if(track.maxSegmentPts===undefined){track.maxSegmentPts=data.pts}else{track.maxSegmentPts=Math.max(track.maxSegmentPts,data.pts)}}if(typeof data.dts==="number"){if(track.timelineStartInfo.dts===undefined){track.timelineStartInfo.dts=data.dts}if(track.minSegmentDts===undefined){track.minSegmentDts=data.dts}else{track.minSegmentDts=Math.min(track.minSegmentDts,data.dts)}if(track.maxSegmentDts===undefined){track.maxSegmentDts=data.dts}else{track.maxSegmentDts=Math.max(track.maxSegmentDts,data.dts)}}};clearDtsInfo=function(track){delete track.minSegmentDts;delete track.maxSegmentDts;delete track.minSegmentPts;delete track.maxSegmentPts};calculateTrackBaseMediaDecodeTime=function(track){var oneSecondInPTS=9e4,scale,timeSinceStartOfTimeline=track.minSegmentDts-track.timelineStartInfo.dts,firstSampleCompositionOffset=track.minSegmentPts-track.minSegmentDts;track.baseMediaDecodeTime=track.timelineStartInfo.baseMediaDecodeTime;track.baseMediaDecodeTime+=timeSinceStartOfTimeline;track.baseMediaDecodeTime-=firstSampleCompositionOffset;track.baseMediaDecodeTime=Math.max(0,track.baseMediaDecodeTime);if(track.type==="audio"){scale=track.samplerate/oneSecondInPTS;track.baseMediaDecodeTime*=scale;track.baseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime)}return track.baseMediaDecodeTime};CoalesceStream=function(options,metadataStream){this.numberOfTracks=0;this.metadataStream=metadataStream;if(typeof options.remux!=="undefined"){this.remuxTracks=!!options.remux}else{this.remuxTracks=true}this.pendingTracks=[];this.videoTrack=null;this.pendingBoxes=[];this.pendingCaptions=[];this.pendingMetadata=[];this.pendingBytes=0;this.emittedTracks=0;CoalesceStream.prototype.init.call(this);this.push=function(output){if(output.text){return this.pendingCaptions.push(output)}if(output.frames){return this.pendingMetadata.push(output)}this.pendingTracks.push(output.track);this.pendingBoxes.push(output.boxes);this.pendingBytes+=output.boxes.byteLength;if(output.track.type==="video"){this.videoTrack=output.track}if(output.track.type==="audio"){this.audioTrack=output.track}}};CoalesceStream.prototype=new Stream;CoalesceStream.prototype.flush=function(flushSource){var offset=0,event={captions:[],metadata:[],info:{}},caption,id3,initSegment,timelineStartPts=0,i;if(this.pendingTracks.length<this.numberOfTracks){if(flushSource!=="VideoSegmentStream"&&flushSource!=="AudioSegmentStream"){return}else if(this.remuxTracks){return}else if(this.pendingTracks.length===0){this.emittedTracks++;if(this.emittedTracks>=this.numberOfTracks){this.trigger("done");this.emittedTracks=0}return}}if(this.videoTrack){timelineStartPts=this.videoTrack.timelineStartInfo.pts;VIDEO_PROPERTIES.forEach(function(prop){event.info[prop]=this.videoTrack[prop]},this)}else if(this.audioTrack){timelineStartPts=this.audioTrack.timelineStartInfo.pts;AUDIO_PROPERTIES.forEach(function(prop){event.info[prop]=this.audioTrack[prop]},this)}if(this.pendingTracks.length===1){
event.type=this.pendingTracks[0].type}else{event.type="combined"}this.emittedTracks+=this.pendingTracks.length;initSegment=mp4.initSegment(this.pendingTracks,this.options);this.pendingBytes+=initSegment.byteLength;this.pendingBoxes.unshift(initSegment);event.data=new Uint8Array(this.pendingBytes);for(i=0;i<this.pendingBoxes.length;i++){event.data.set(this.pendingBoxes[i],offset);offset+=this.pendingBoxes[i].byteLength}for(i=0;i<this.pendingCaptions.length;i++){caption=this.pendingCaptions[i];caption.startTime=caption.startPts-timelineStartPts;caption.startTime/=9e4;caption.endTime=caption.endPts-timelineStartPts;caption.endTime/=9e4;event.captions.push(caption)}for(i=0;i<this.pendingMetadata.length;i++){id3=this.pendingMetadata[i];id3.cueTime=id3.pts-timelineStartPts;id3.cueTime/=9e4;event.metadata.push(id3)}event.metadata.dispatchType=this.metadataStream.dispatchType;this.pendingTracks.length=0;this.videoTrack=null;this.pendingBoxes.length=0;this.pendingCaptions.length=0;this.pendingBytes=0;this.pendingMetadata.length=0;this.trigger("data",event);if(this.emittedTracks>=this.numberOfTracks){this.trigger("done");this.emittedTracks=0}};Transmuxer=function(options){var self=this,hasFlushed=true,videoTrack,audioTrack;Transmuxer.prototype.init.call(this);options=options||{};options.input_type=options.input_type||"ts";if(options.break_on_count===undefined){options.break_on_count=true}this.baseMediaDecodeTime=options.baseMediaDecodeTime||0;this.transmuxPipeline_={};this.setupAacPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type="aac";pipeline.metadataStream=new m2ts.MetadataStream;pipeline.aacStream=new AacStream;pipeline.audioTimestampRolloverStream=new m2ts.TimestampRolloverStream("audio");pipeline.timedMetadataTimestampRolloverStream=new m2ts.TimestampRolloverStream("timed-metadata");pipeline.adtsStream=new AdtsStream;pipeline.coalesceStream=new CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.aacStream;pipeline.aacStream.pipe(pipeline.audioTimestampRolloverStream).pipe(pipeline.adtsStream);pipeline.aacStream.pipe(pipeline.timedMetadataTimestampRolloverStream).pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream);pipeline.metadataStream.on("timestamp",function(frame){pipeline.aacStream.setTimestamp(frame.timeStamp)});pipeline.aacStream.on("data",function(data){if(data.type==="timed-metadata"&&!pipeline.audioSegmentStream){audioTrack=audioTrack||{timelineStartInfo:{baseMediaDecodeTime:self.baseMediaDecodeTime},codec:"adts",type:"audio"};pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new AudioSegmentStream(audioTrack);pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)}});pipeline.coalesceStream.on("data",this.trigger.bind(this,"data"));pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))};this.setupTsPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type=options.input_type;if(pipeline.type=="ts"){options.metadataStream=pipeline.metadataStream=new m2ts.MetadataStream;pipeline.packetStream=new m2ts.TransportPacketStream;pipeline.parseStream=new m2ts.TransportParseStream;pipeline.elementaryStream=new m2ts.ElementaryStream;pipeline.videoTimestampRolloverStream=new m2ts.TimestampRolloverStream("video");pipeline.audioTimestampRolloverStream=new m2ts.TimestampRolloverStream("audio");pipeline.timedMetadataTimestampRolloverStream=new m2ts.TimestampRolloverStream("timed-metadata");pipeline.adtsStream=new AdtsStream;pipeline.h264Stream=new H264Stream;pipeline.captionStream=new m2ts.CaptionStream;pipeline.coalesceStream=new CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.packetStream;pipeline.packetStream.pipe(pipeline.parseStream).pipe(pipeline.elementaryStream);pipeline.elementaryStream.pipe(pipeline.videoTimestampRolloverStream).pipe(pipeline.h264Stream);pipeline.elementaryStream.pipe(pipeline.audioTimestampRolloverStream).pipe(pipeline.adtsStream);pipeline.elementaryStream.pipe(pipeline.timedMetadataTimestampRolloverStream).pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream);pipeline.h264Stream.pipe(pipeline.captionStream).pipe(pipeline.coalesceStream)}else{pipeline.headOfPipeline=pipeline.elementaryStream=new mp4p.MP4ParserStream(options);pipeline.mp4BuilderStream=new mp4p.MP4BuilderStream(options);pipeline.elementaryStream.pipe(pipeline.mp4BuilderStream);this.seek=function(pos,ss,opt){return pipeline.elementaryStream.seek(pos,ss,opt)};this.get_tl=function(id){return pipeline.elementaryStream.get_tl(id)};this.get_buf_pos=function(){return pipeline.elementaryStream.get_buf_pos()};this.conf_update=function(conf){pipeline.elementaryStream.trigger("confupdate",conf);pipeline.mp4BuilderStream.trigger("confupdate",conf)}}pipeline.elementaryStream.on("data",function(data){var i;if(data.type==="metadata"){if(options.input_type==="mp4"){return void self.trigger("metadata",data)}i=data.tracks.length;while(i--){if(!videoTrack&&data.tracks[i].type==="video"){videoTrack=data.tracks[i];videoTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}else if(!audioTrack&&data.tracks[i].type==="audio"){audioTrack=data.tracks[i];audioTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}}if(videoTrack&&!pipeline.videoSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.videoSegmentStream=new VideoSegmentStream(videoTrack);pipeline.videoSegmentStream.on("timelineStartInfo",function(timelineStartInfo){if(audioTrack){audioTrack.timelineStartInfo=timelineStartInfo;pipeline.audioSegmentStream.setEarliestDts(timelineStartInfo.dts)}});pipeline.h264Stream.pipe(pipeline.videoSegmentStream).pipe(pipeline.coalesceStream)}if(audioTrack&&!pipeline.audioSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new AudioSegmentStream(audioTrack);pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)}}});pipeline.elementaryStream.on("header_found",this.trigger.bind(this,"header_found"));if(options.input_type==="mp4"){pipeline.mp4BuilderStream.on("data",this.trigger.bind(this,"data"));pipeline.mp4BuilderStream.on("done",this.trigger.bind(this,"done"))}else{pipeline.coalesceStream.on("data",this.trigger.bind(this,"data"));pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))}};this.setBaseMediaDecodeTime=function(baseMediaDecodeTime){var pipeline=this.transmuxPipeline_;this.baseMediaDecodeTime=baseMediaDecodeTime;if(audioTrack){audioTrack.timelineStartInfo.dts=undefined;audioTrack.timelineStartInfo.pts=undefined;clearDtsInfo(audioTrack);audioTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime}if(videoTrack){if(pipeline.videoSegmentStream){pipeline.videoSegmentStream.gopCache_=[]}videoTrack.timelineStartInfo.dts=undefined;videoTrack.timelineStartInfo.pts=undefined;clearDtsInfo(videoTrack);videoTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime}};this.push=function(data){if(hasFlushed){var isAac=isLikelyAacData(data)&&options.input_type!="mp4";if(isAac&&this.transmuxPipeline_.type!=="aac"){this.setupAacPipeline()}else if(!isAac&&this.transmuxPipeline_.type!==options.input_type){this.setupTsPipeline()}hasFlushed=false}return this.transmuxPipeline_.headOfPipeline.push(data)};this.appendBuffer=function(data){return this.push(new Uint8Array(data))};this.flush=function(){hasFlushed=true;this.transmuxPipeline_.headOfPipeline.flush()}};Transmuxer.prototype=new Stream;module.exports={Transmuxer:Transmuxer,VideoSegmentStream:VideoSegmentStream,AudioSegmentStream:AudioSegmentStream,AUDIO_PROPERTIES:AUDIO_PROPERTIES,VIDEO_PROPERTIES:VIDEO_PROPERTIES}},{1:1,11:11,16:16,17:17,22:22,4:4}],19:[function(_dereq_,module,exports){var tagTypes={8:"audio",9:"video",18:"metadata"},hex=function(val){return"0x"+("00"+val.toString(16)).slice(-2).toUpperCase()},hexStringList=function(data){var arr=[],i;while(data.byteLength>0){i=0;switch(data.byteLength){default:arr.push(hex(data[i++]));case 7:arr.push(hex(data[i++]));case 6:arr.push(hex(data[i++]));case 5:arr.push(hex(data[i++]));case 4:arr.push(hex(data[i++]));case 3:arr.push(hex(data[i++]));case 2:arr.push(hex(data[i++]));case 1:arr.push(hex(data[i++]))}data=data.subarray(i)}return arr.join(" ")},parseAVCTag=function(tag,obj){var avcPacketTypes=["AVC Sequence Header","AVC NALU","AVC End-of-Sequence"],nalUnitTypes=["unspecified","slice_layer_without_partitioning","slice_data_partition_a_layer","slice_data_partition_b_layer","slice_data_partition_c_layer","slice_layer_without_partitioning_idr","sei","seq_parameter_set","pic_parameter_set","access_unit_delimiter","end_of_seq","end_of_stream","filler","seq_parameter_set_ext","prefix_nal_unit","subset_seq_parameter_set","reserved","reserved","reserved"],compositionTime=tag[1]&parseInt("01111111",2)<<16|tag[2]<<8|tag[3];obj=obj||{};obj.avcPacketType=avcPacketTypes[tag[0]];obj.CompositionTime=tag[1]&parseInt("10000000",2)?-compositionTime:compositionTime;if(tag[0]===1){obj.nalUnitTypeRaw=hexStringList(tag.subarray(4,100))}else{obj.data=hexStringList(tag.subarray(4))}return obj},parseVideoTag=function(tag,obj){var frameTypes=["Unknown","Keyframe (for AVC, a seekable frame)","Inter frame (for AVC, a nonseekable frame)","Disposable inter frame (H.263 only)","Generated keyframe (reserved for server use only)","Video info/command frame"],codecIDs=["JPEG (currently unused)","Sorenson H.263","Screen video","On2 VP6","On2 VP6 with alpha channel","Screen video version 2","AVC"],codecID=tag[0]&parseInt("00001111",2);obj=obj||{};obj.frameType=frameTypes[(tag[0]&parseInt("11110000",2))>>>4];obj.codecID=codecID;if(codecID===7){return parseAVCTag(tag.subarray(1),obj)}return obj},parseAACTag=function(tag,obj){var packetTypes=["AAC Sequence Header","AAC Raw"];obj=obj||{};obj.aacPacketType=packetTypes[tag[0]];obj.data=hexStringList(tag.subarray(1));return obj},parseAudioTag=function(tag,obj){var formatTable=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16-kHz mono","Nellymoser 8-kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","Speex","MP3 8-Khz","Device-specific sound"],samplingRateTable=["5.5-kHz","11-kHz","22-kHz","44-kHz"],soundFormat=(tag[0]&parseInt("11110000",2))>>>4;obj=obj||{};obj.soundFormat=formatTable[soundFormat];obj.soundRate=samplingRateTable[(tag[0]&parseInt("00001100",2))>>>2];obj.soundSize=(tag[0]&parseInt("00000010",2))>>>1?"16-bit":"8-bit";obj.soundType=tag[0]&parseInt("00000001",2)?"Stereo":"Mono";if(soundFormat===10){return parseAACTag(tag.subarray(1),obj)}return obj},parseGenericTag=function(tag){return{tagType:tagTypes[tag[0]],dataSize:tag[1]<<16|tag[2]<<8|tag[3],timestamp:tag[7]<<24|tag[4]<<16|tag[5]<<8|tag[6],streamID:tag[8]<<16|tag[9]<<8|tag[10]}},inspectFlvTag=function(tag){var header=parseGenericTag(tag);switch(tag[0]){case 8:parseAudioTag(tag.subarray(11),header);break;case 9:parseVideoTag(tag.subarray(11),header);break;case 18:}return header},inspectFlv=function(bytes){var i=9,dataSize,parsedResults=[],tag;i+=4;while(i<bytes.byteLength){dataSize=bytes[i+1]<<16;dataSize|=bytes[i+2]<<8;dataSize|=bytes[i+3];dataSize+=11;tag=bytes.subarray(i,i+dataSize);parsedResults.push(inspectFlvTag(tag));i+=dataSize+4}return parsedResults},textifyFlv=function(flvTagArray){return JSON.stringify(flvTagArray,null,2)};module.exports={inspectTag:inspectFlvTag,inspect:inspectFlv,textify:textifyFlv}},{}],20:[function(_dereq_,module,exports){(function(global){var inspectMp4,textifyMp4,parseType=function(buffer){var result="";result+=String.fromCharCode(buffer[0]);result+=String.fromCharCode(buffer[1]);result+=String.fromCharCode(buffer[2]);result+=String.fromCharCode(buffer[3]);return result},parseMp4Date=function(seconds){return new Date(seconds*1e3-20828448e5)},parseSampleFlags=function(flags){return{isLeading:(flags[0]&12)>>>2,dependsOn:flags[0]&3,isDependedOn:(flags[1]&192)>>>6,hasRedundancy:(flags[1]&48)>>>4,paddingValue:(flags[1]&14)>>>1,isNonSyncSample:flags[1]&1,degradationPriority:flags[2]<<8|flags[3]}},nalParse=function(avcStream){var avcView=new DataView(avcStream.buffer,avcStream.byteOffset,avcStream.byteLength),result=[],i,length;for(i=0;i+4<avcStream.length;i+=length){length=avcView.getUint32(i);i+=4;if(length<=0){result.push("<span style='color:red;'>MALFORMED DATA</span>");continue}switch(avcStream[i]&31){case 1:result.push("slice_layer_without_partitioning_rbsp");break;case 5:result.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:result.push("sei_rbsp");break;case 7:result.push("seq_parameter_set_rbsp");break;case 8:result.push("pic_parameter_set_rbsp");break;case 9:result.push("access_unit_delimiter_rbsp");break;default:result.push("UNKNOWN NAL - "+avcStream[i]&31);break}}return result},parse={avc1:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{dataReferenceIndex:view.getUint16(6),width:view.getUint16(24),height:view.getUint16(26),horizresolution:view.getUint16(28)+view.getUint16(30)/16,vertresolution:view.getUint16(32)+view.getUint16(34)/16,frameCount:view.getUint16(40),depth:view.getUint16(74),config:inspectMp4(data.subarray(78,data.byteLength))}},avcC:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={configurationVersion:data[0],avcProfileIndication:data[1],profileCompatibility:data[2],avcLevelIndication:data[3],lengthSizeMinusOne:data[4]&3,sps:[],pps:[]},numOfSequenceParameterSets=data[5]&31,numOfPictureParameterSets,nalSize,offset,i;offset=6;for(i=0;i<numOfSequenceParameterSets;i++){nalSize=view.getUint16(offset);offset+=2;result.sps.push(new Uint8Array(data.subarray(offset,offset+nalSize)));offset+=nalSize}numOfPictureParameterSets=data[offset];offset++;for(i=0;i<numOfPictureParameterSets;i++){nalSize=view.getUint16(offset);offset+=2;result.pps.push(new Uint8Array(data.subarray(offset,offset+nalSize)));offset+=nalSize}return result},btrt:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{bufferSizeDB:view.getUint32(0),maxBitrate:view.getUint32(4),avgBitrate:view.getUint32(8)}},esds:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),esId:data[6]<<8|data[7],streamPriority:data[8]&31,decoderConfig:{objectProfileIndication:data[11],streamType:data[12]>>>2&63,bufferSize:data[13]<<16|data[14]<<8|data[15],maxBitrate:data[16]<<24|data[17]<<16|data[18]<<8|data[19],avgBitrate:data[20]<<24|data[21]<<16|data[22]<<8|data[23],decoderConfigDescriptor:{tag:data[24],length:data[25],audioObjectType:data[26]>>>3&31,samplingFrequencyIndex:(data[26]&7)<<1|data[27]>>>7&1,channelConfiguration:data[27]>>>3&15}}}},ftyp:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={majorBrand:parseType(data.subarray(0,4)),minorVersion:view.getUint32(4),compatibleBrands:[]},i=8;while(i<data.byteLength){result.compatibleBrands.push(parseType(data.subarray(i,i+4)));i+=4}return result},dinf:function(data){return{boxes:inspectMp4(data)}},dref:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),dataReferences:inspectMp4(data.subarray(8))}},hdlr:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),language,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),handlerType:parseType(data.subarray(8,12)),name:""},i=8;for(i=24;i<data.byteLength;i++){if(data[i]===0){i++;break}result.name+=String.fromCharCode(data[i])}result.name=decodeURIComponent(global.escape(result.name));return result},mdat:function(data){return{byteLength:data.byteLength,nals:nalParse(data)}},mdhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,language,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),language:""};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=4;result.duration=view.getUint32(i)}i+=4;language=view.getUint16(i);result.language+=String.fromCharCode((language>>10)+96);result.language+=String.fromCharCode(((language&960)>>5)+96);result.language+=String.fromCharCode((language&31)+96);return result},mdia:function(data){return{boxes:inspectMp4(data)}},mfhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sequenceNumber:data[4]<<24|data[5]<<16|data[6]<<8|data[7]}},minf:function(data){return{boxes:inspectMp4(data)}},mp4a:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={dataReferenceIndex:view.getUint16(6),channelcount:view.getUint16(16),samplesize:view.getUint16(18),samplerate:view.getUint16(24)+view.getUint16(26)/65536};if(data.byteLength>28){result.streamDescriptor=inspectMp4(data.subarray(28))[0]}return result},moof:function(data){return{boxes:inspectMp4(data)}},moov:function(data){return{boxes:inspectMp4(data)}},mvex:function(data){return{boxes:inspectMp4(data)}},mvhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=4;result.duration=view.getUint32(i)}i+=4;result.rate=view.getUint16(i)+view.getUint16(i+2)/16;i+=4;result.volume=view.getUint8(i)+view.getUint8(i+1)/8;i+=2;i+=2;i+=2*4;result.matrix=new Uint32Array(data.subarray(i,i+9*4));i+=9*4;i+=6*4;result.nextTrackId=view.getUint32(i);return result},pdin:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),rate:view.getUint32(4),initialDelay:view.getUint32(8)}},sdtp:function(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},i;for(i=4;i<data.byteLength;i++){result.samples.push({dependsOn:(data[i]&48)>>4,isDependedOn:(data[i]&12)>>2,hasRedundancy:data[i]&3})}return result},sidx:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),references:[],referenceId:view.getUint32(4),timescale:view.getUint32(8),earliestPresentationTime:view.getUint32(12),firstOffset:view.getUint32(16)},referenceCount=view.getUint16(22),i;for(i=24;referenceCount;i+=12,referenceCount--){result.references.push({referenceType:(data[i]&128)>>>7,referencedSize:view.getUint32(i)&2147483647,subsegmentDuration:view.getUint32(i+4),startsWithSap:!!(data[i+8]&128),sapType:(data[i+8]&112)>>>4,sapDeltaTime:view.getUint32(i+8)&268435455})}return result},smhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),balance:data[4]+data[5]/256}},stbl:function(data){return{boxes:inspectMp4(data)}},stco:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),chunkOffsets:[]},entryCount=view.getUint32(4),i;for(i=8;entryCount;i+=4,entryCount--){result.chunkOffsets.push(view.getUint32(i))}return result},stsc:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),entryCount=view.getUint32(4),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleToChunks:[]},i;for(i=8;entryCount;i+=12,entryCount--){result.sampleToChunks.push({firstChunk:view.getUint32(i),samplesPerChunk:view.getUint32(i+4),sampleDescriptionIndex:view.getUint32(i+8)})}return result},stsd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleDescriptions:inspectMp4(data.subarray(8))}},stsz:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleSize:view.getUint32(4),entries:[]},i;for(i=12;i<data.byteLength;i+=4){result.entries.push(view.getUint32(i))}return result},stts:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),timeToSamples:[]},entryCount=view.getUint32(4),i;for(i=8;entryCount;i+=8,entryCount--){result.timeToSamples.push({sampleCount:view.getUint32(i),sampleDelta:view.getUint32(i+4)})}return result},styp:function(data){return parse.ftyp(data)},tfdt:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),baseMediaDecodeTime:data[4]<<24|data[5]<<16|data[6]<<8|data[7]}},tfhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4)},baseDataOffsetPresent=result.flags[2]&1,sampleDescriptionIndexPresent=result.flags[2]&2,defaultSampleDurationPresent=result.flags[2]&8,defaultSampleSizePresent=result.flags[2]&16,defaultSampleFlagsPresent=result.flags[2]&32,i;i=8;if(baseDataOffsetPresent){i+=4;result.baseDataOffset=view.getUint32(12);i+=4}if(sampleDescriptionIndexPresent){result.sampleDescriptionIndex=view.getUint32(i);i+=4}if(defaultSampleDurationPresent){result.defaultSampleDuration=view.getUint32(i);i+=4}if(defaultSampleSizePresent){result.defaultSampleSize=view.getUint32(i);i+=4}if(defaultSampleFlagsPresent){result.defaultSampleFlags=view.getUint32(i)}return result},tkhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.trackId=view.getUint32(i);i+=4;i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.trackId=view.getUint32(i);i+=4;i+=4;result.duration=view.getUint32(i)}i+=4;i+=2*4;result.layer=view.getUint16(i);i+=2;result.alternateGroup=view.getUint16(i);i+=2;result.volume=view.getUint8(i)+view.getUint8(i+1)/8;i+=2;i+=2;result.matrix=new Uint32Array(data.subarray(i,i+9*4));i+=9*4;result.width=view.getUint16(i)+view.getUint16(i+2)/16;i+=4;result.height=view.getUint16(i)+view.getUint16(i+2)/16;return result},traf:function(data){return{boxes:inspectMp4(data)}},trak:function(data){return{boxes:inspectMp4(data)}},trex:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4),defaultSampleDescriptionIndex:view.getUint32(8),defaultSampleDuration:view.getUint32(12),defaultSampleSize:view.getUint32(16),sampleDependsOn:data[20]&3,sampleIsDependedOn:(data[21]&192)>>6,sampleHasRedundancy:(data[21]&48)>>4,samplePaddingValue:(data[21]&14)>>1,sampleIsDifferenceSample:!!(data[21]&1),sampleDegradationPriority:view.getUint16(22)}},trun:function(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},view=new DataView(data.buffer,data.byteOffset,data.byteLength),dataOffsetPresent=result.flags[2]&1,firstSampleFlagsPresent=result.flags[2]&4,sampleDurationPresent=result.flags[1]&1,sampleSizePresent=result.flags[1]&2,sampleFlagsPresent=result.flags[1]&4,sampleCompositionTimeOffsetPresent=result.flags[1]&8,sampleCount=view.getUint32(4),offset=8,sample;if(dataOffsetPresent){result.dataOffset=view.getUint32(offset);offset+=4}if(firstSampleFlagsPresent&&sampleCount){sample={flags:parseSampleFlags(data.subarray(offset,offset+4))};offset+=4;if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}if(sampleCompositionTimeOffsetPresent){sample.compositionTimeOffset=view.getUint32(offset);offset+=4}result.samples.push(sample);sampleCount--}while(sampleCount--){sample={};if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}if(sampleFlagsPresent){sample.flags=parseSampleFlags(data.subarray(offset,offset+4));offset+=4}if(sampleCompositionTimeOffsetPresent){sample.compositionTimeOffset=view.getUint32(offset);offset+=4}result.samples.push(sample)}return result},"url ":function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4))}},vmhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),graphicsmode:view.getUint16(4),opcolor:new Uint16Array([view.getUint16(6),view.getUint16(8),view.getUint16(10)])}}};inspectMp4=function(data){var i=0,result=[],view,size,type,end,box;var ab=new ArrayBuffer(data.length);var v=new Uint8Array(ab);for(var z=0;z<data.length;++z){v[z]=data[z]}view=new DataView(ab);while(i<data.byteLength){size=view.getUint32(i);type=parseType(data.subarray(i+4,i+8));end=size>1?i+size:data.byteLength;box=(parse[type]||function(data){return{data:data}})(data.subarray(i+8,end));box.size=size;box.type=type;result.push(box);i=end}return result};textifyMp4=function(inspectedMp4,depth){var indent;depth=depth||0;indent=new Array(depth*2+1).join(" ");return inspectedMp4.map(function(box,index){return indent+box.type+"\n"+Object.keys(box).filter(function(key){return key!=="type"&&key!=="boxes"}).map(function(key){var prefix=indent+"  "+key+": ",value=box[key];if(value instanceof Uint8Array||value instanceof Uint32Array){var bytes=Array.prototype.slice.call(new Uint8Array(value.buffer,value.byteOffset,value.byteLength)).map(function(byte){return" "+("00"+byte.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);if(!bytes){return prefix+"<>"}if(bytes.length===1){return prefix+"<"+bytes.join("").slice(1)+">"}return prefix+"<\n"+bytes.map(function(line){return indent+"  "+line}).join("\n")+"\n"+indent+"  >"}return prefix+JSON.stringify(value,null,2).split("\n").map(function(line,index){if(index===0){return line}return indent+"  "+line}).join("\n")}).join("\n")+(box.boxes?"\n"+textifyMp4(box.boxes,depth+1):"")}).join("\n")};module.exports={inspect:inspectMp4,textify:textifyMp4}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],21:[function(_dereq_,module,exports){var ExpGolomb;ExpGolomb=function(workingData){var workingBytesAvailable=workingData.byteLength,workingWord=0,workingBitsAvailable=0;this.length=function(){return 8*workingBytesAvailable};this.bitsAvailable=function(){return 8*workingBytesAvailable+workingBitsAvailable};this.loadWord=function(){var position=workingData.byteLength-workingBytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,workingBytesAvailable);if(availableBytes===0){throw new Error("no bytes available")}workingBytes.set(workingData.subarray(position,position+availableBytes));workingWord=new DataView(workingBytes.buffer).getUint32(0);workingBitsAvailable=availableBytes*8;workingBytesAvailable-=availableBytes};this.skipBits=function(count){var skipBytes;if(workingBitsAvailable>count){workingWord<<=count;workingBitsAvailable-=count}else{count-=workingBitsAvailable;skipBytes=Math.floor(count/8);count-=skipBytes*8;workingBytesAvailable-=skipBytes;this.loadWord();workingWord<<=count;workingBitsAvailable-=count}};this.readBits=function(size){var bits=Math.min(workingBitsAvailable,size),valu=workingWord>>>32-bits;workingBitsAvailable-=bits;if(workingBitsAvailable>0){workingWord<<=bits}else if(workingBytesAvailable>0){this.loadWord()}bits=size-bits;return bits>0&&workingBitsAvailable?valu<<bits|this.readBits(bits):valu};this.skipLeadingZeros=function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<workingBitsAvailable;++leadingZeroCount){if(0!==(workingWord&2147483648>>>leadingZeroCount)){workingWord<<=leadingZeroCount;workingBitsAvailable-=leadingZeroCount;return leadingZeroCount}}this.loadWord();return leadingZeroCount+this.skipLeadingZeros()};this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.readUnsignedExpGolomb=function(){var clz=this.skipLeadingZeros();return this.readBits(clz+1)-1};this.readExpGolomb=function(){var valu=this.readUnsignedExpGolomb();return valu&1?1+valu>>>1:-(valu>>>1)};this.readBoolean=function(){return 1===this.readBits(1)};this.readUnsignedByte=function(){return this.readBits(8)};this.loadWord()};module.exports=ExpGolomb},{}],22:[function(_dereq_,module,exports){var Stream=function(){this.init=function(){var listeners={};this.on=function(type,listener){if(!listeners[type]){listeners[type]=[]}listeners[type].push(listener)};this.off=function(type,listener){var index;if(!listeners[type]){return false}index=listeners[type].indexOf(listener);listeners[type].splice(index,1);return index>-1};this.trigger=function(type){var callbacks,i,length,args;callbacks=listeners[type];if(!callbacks){return}callbacks=callbacks.slice(0);if(arguments.length===2){length=callbacks.length;for(i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{args=[];i=arguments.length;for(i=1;i<arguments.length;++i){args.push(arguments[i])}length=callbacks.length;for(i=0;i<length;++i){callbacks[i].apply(this,args)}}};this.dispose=function(){listeners={}}}};Stream.prototype.pipe=function(destination){this.on("data",function(data){destination.push(data)});this.on("done",function(flushSource){destination.flush(flushSource)});return destination};Stream.prototype.push=function(data){this.trigger("data",data)};Stream.prototype.flush=function(flushSource){this.trigger("done",flushSource)};module.exports=Stream},{}]},{},[8])(8)});
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");var qs;if(!is_node&&!is_ff_addon)define=define||self.define;else{define=require("./require_node.js").define(module,"../");qs=require(is_ff_addon?"sdk/querystring":"querystring")}define("/util/url.js",[],function(){var assign=Object.assign;var E={};E.add_proto=function(url){if(!url.match(/^([a-z0-9]+:)?\/\//i))url="http://"+url;return url};E.rel_proto_to_abs=function(url){var proto=is_node?"http:":location.protocol;return url.replace(/^\/\//,proto+"//")};E.get_top_level_domain=function(host){var n=host.match(/\.([^.]+)$/);return n?n[1]:""};E.get_host=function(url){var n=url.match(/^(https?:)?\/\/([^\/]+)\/.*$/);return n?n[2]:""};E.get_host_without_tld=function(host){return host.replace(/^([^.]+)\.[^.]{2,3}(\.[^.]{2,3})?$/,"$1")};var generic_2ld={com:1,biz:1,net:1,org:1,xxx:1,edu:1,gov:1,ac:1,co:1,or:1,ne:1,kr:1,jp:1,jpn:1,cn:1};E.get_root_domain=function(domain){var s=domain.split("."),root=s,len=s.length;if(len>2){var hd=0;if(s[len-1]=="hola"){hd=2;if(s[len-2].match(/^\d+$/))hd=3}if(generic_2ld[s[len-2-hd]])root=s.slice(-3-hd,len-hd);else root=s.slice(-2-hd,len-hd)}return root.join(".")};E.get_domain_email=function(email){var match=email.toLowerCase().match(/^[a-z0-9_\.\-\+]+@(.*)$/);return match&&match[1]};E.get_root_domain_email=function(email){var domain=E.get_domain_email(email);return domain&&E.get_root_domain(domain)};E.get_path=function(url){var n=url.match(/^https?:\/\/[^\/]+(\/.*$)/);return n?n[1]:""};E.get_proto=function(url){var n=url.match(/^([a-z0-9]+):\/\//);return n?n[1]:""};E.get_host_gently=function(url){var n=url.match(/^(?:(?:[a-z0-9]+?:)?\/\/)?([^\/]+)/);return n?n[1]:""};E.is_ip=function(host){var m=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(host);if(!m)return false;for(var i=1;i<=4;i++){if(+m[i]>255)return false}return true};E.is_ip_mask=function(host){var m=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(host);if(!m)return false;if(E.ip2num(host)==0)return false;var final=false;var check_num_mask=function(num){var arr=(num>>>0).toString(2).split(""),final=false;for(var i=0;i<arr.length;i++){if(final&&arr[i]=="1")return false;if(!final&&arr[i]=="0")final=true}return true};for(var i=1;i<=4;i++){if(+m[i]>255)return false;if(final&&+m[i]>0)return false;if(!final&&+m[i]<255){if(!check_num_mask(+m[i]))return false;final=true}}return!!final};E.ip2num=function(ip){var num=0;ip.split(".").forEach(function(octet){num<<=8;num+=+octet});return num>>>0};E.num2ip=function(num){return(num>>>24)+"."+(num>>16&255)+"."+(num>>8&255)+"."+(num&255)};E.is_ip_subnet=function(host){var m=/(.+?)\/(\d+)$/.exec(host);return m&&E.is_ip(m[1])&&+m[2]<=32};E.is_ip_netmask=function(host){var ips=host.split("/");if(ips.length!=2||!E.is_ip(ips[0])||!E.is_ip_mask(ips[1]))return false;return true};E.is_ip_range=function(host){var ips=host.split("-");if(ips.length!=2||!E.is_ip(ips[0])||!E.is_ip(ips[1]))return false;return E.ip2num(ips[0])<E.ip2num(ips[1])};E.is_ip_port=function(host){var m=/(.+?)(?::(\d{1,5}))?$/.exec(host);return m&&E.is_ip(m[1])&&!(+m[2]>65535)};E.is_valid_url=function(url){return/^(https?:\/\/)?([a-z0-9-]+\.)+[a-z0-9-]+(\/.*)?$/i.test(url)};E.is_valid_domain=function(domain){return/^([a-z0-9]([a-z0-9-_]*[a-z0-9])?\.)+[a-z]{2,63}$/.test(domain)};E.is_hola_domain=function(domain){return domain.search(/^(.*\.)?(hola\.org|holacdn\.com|h-cdn\.com)$/)!=-1};E.is_valid_email=function(email){var n=email.toLowerCase().match(/^[a-z0-9_\.\-\+]+@(.*)$/);return!!(n&&E.is_valid_domain(n[1]))};E.is_ip_in_range=function(ips_range,ip){if(!E.is_ip_range(ips_range)||!E.is_ip(ip))return false;var ips=ips_range.split("-");var min_ip=E.ip2num(ips[0]),max_ip=E.ip2num(ips[1]);var num_ip=E.ip2num(ip);return num_ip>=min_ip&&num_ip<=max_ip};E.host_lookup=function(lookup,host){var pos;while(1){if(host in lookup)return lookup[host];if((pos=host.indexOf("."))<0)return;host=host.slice(pos+1)}};E.uri_obj_href=function(uri){return(uri.protocol||"")+(uri.slashes?"//":"")+(uri.host?(uri.auth?uri.auth+"@":"")+uri.host:"")+uri.path+(uri.hash||"")};var protocol_re=/^((?:about|http|https|file|ftp|ws|wss):)?(\/\/)?/i;var host_section_re=/^(.*?)(?:[\/?#]|$)/;var host_re=/^(?:(([^:@]*):?([^:@]*))?@)?([^:]*)(?::(\d*))?/;var path_section_re=/^([^?#]*)(\?[^#]*)?(#.*)?$/;var path_re_loose=/^(\/(?:.(?![^\/]*\.[^\/.]+$))*\/?)?([^\/]*?(?:\.([^.]+))?)$/;var path_re_strict=/^(\/(?:.(?![^\/]*(?:\.[^\/.]+)?$))*\/?)?([^\/]*?(?:\.([^.]+))?)$/;E.parse=function(url,strict){function re(expr,str){var m;try{m=expr.exec(str)}catch(e){m=null}if(!m)return m;for(var i=0;i<m.length;i++)m[i]=m[i]===undefined?null:m[i];return m}url=url||location.href;var m,uri={orig:url},remaining=url;if(!(m=re(protocol_re,remaining)))return{};uri.protocol=m[1];if(uri.protocol!==null)uri.protocol=uri.protocol.toLowerCase();uri.slashes=!!m[2];if(!uri.protocol&&!uri.slashes){uri.protocol="http:";uri.slashes=true}remaining=remaining.slice(m[0].length);if(!(m=re(host_section_re,remaining)))return{};uri.authority=m[1];remaining=remaining.slice(m[1].length);if(!(m=re(host_re,uri.authority)))return{};uri.auth=m[1];uri.user=m[2];uri.password=m[3];uri.hostname=m[4];uri.port=m[5];if(uri.hostname!==null){uri.hostname=uri.hostname.toLowerCase();uri.host=uri.hostname+(uri.port?":"+uri.port:"")}if(!(m=re(path_section_re,remaining)))return{};uri.relative=m[0];uri.pathname=m[1];uri.search=m[2];uri.query=uri.search?uri.search.substring(1):null;uri.hash=m[3];if(!(m=re(strict?path_re_strict:path_re_loose,uri.pathname)))return{};uri.directory=m[1];uri.file=m[2];uri.ext=m[3];if(uri.file=="."+uri.ext)uri.ext=null;if(!uri.pathname)uri.pathname="/";uri.path=uri.pathname+(uri.search||"");uri.href=E.uri_obj_href(uri);return uri};E.qs_parse=function(q,bin){var obj={};q=q.length?q.split("&"):[];var len=q.length;var unescape_val=bin?function(val){return qs.unescapeBuffer(val,true).toString("binary")}:function(val){return decodeURIComponent(val.replace(/\+/g," "))};for(var i=0;i<len;++i){var x=q[i];var idx=x.indexOf("=");var kstr=idx>=0?x.substr(0,idx):x;var vstr=idx>=0?x.substr(idx+1):"";var k=unescape_val(kstr);var v=unescape_val(vstr);if(obj[k]===undefined)obj[k]=v;else if(Array.isArray(obj[k]))obj[k].push(v);else obj[k]=[obj[k],v]}return obj};function token_regex(s,end){return end?"^"+s+"$":s}E.http_glob_host=function(host,end){var port="";var parts=host.split(":");host=parts[0];if(parts.length>1)port=":"+parts[1].replace("*","[0-9]+");var n=host.match(/^(|.*[^*])(\*+)$/);if(n){host=E.http_glob_host(n[1])+(n[2].length==1?"[^./]+":"[^/]"+(n[1]?"*":"+"));return token_regex(host+port,end)}host=host.replace(/\*\*\./,"**").replace(/\*\./,"*").replace(/\./g,"\\.").replace(/\*\*/g,"(([^./]+\\.)+)?").replace(/\*/g,"[^./]+\\.");return token_regex(host+port,end)};E.http_glob_path=function(path,end){if(path[0]=="*")return E.http_glob_path("/"+path,end);var n=path.match(/^(|.*[^*])(\*+)([^*^\/]*)$/);if(n){path=E.http_glob_path(n[1])+(n[2].length==1?"[^/]+":".*")+E.http_glob_path(n[3]);return token_regex(path,end)}path=path.replace(/\*\*\//,"**").replace(/\*\//,"*").replace(/\//g,"\\/").replace(/\./g,"\\.").replace(/\*\*/g,"(([^/]+\\/)+)?").replace(/\*/g,"[^/]+\\/");return token_regex(path,end)};E.http_glob_url=function(url,end){var n=url.match(/^((.*):\/\/)?([^\/]+)(\/.*)?$/);if(!n)return null;var prot=n[1]?n[2]:"*";var host=n[3];var path=n[4]||"**";if(prot=="*")prot="https?";host=E.http_glob_host(host);path=E.http_glob_path(path);return token_regex(prot+":\\/\\/"+host+path,end)};E.root_url_cmp=function(a,b){var a_s=a.match(/^[*.]*([^*]+)$/);var b_s=b.match(/^[*.]*([^*]+)$/);if(!a_s&&!b_s)return false;var re,s;if(a_s&&b_s&&a_s[1].length>b_s[1].length||a_s&&!b_s){s=a_s[1];re=b}else{s=b_s[1];re=a}s=E.add_proto(s)+"/";if(!(re=E.http_glob_url(re,1)))return false;try{re=new RegExp(re)}catch(e){return false}return re.test(s)};E.qs_strip=function(url){return/^[^?#]*/.exec(url)[0]};function qs_str(qs){var q=[];for(var k in qs){(Array.isArray(qs[k])?qs[k]:[qs[k]]).forEach(function(v){q.push(encodeURIComponent(k)+"="+encodeURIComponent(v))})}return q.join("&")}E.qs_add=function(url,qs){var u=E.parse(url),q=assign(u.query?E.qs_parse(u.query):{},qs);u.path=u.pathname+"?"+qs_str(q);return E.uri_obj_href(u)};E.qs_parse_url=function(url){return E.qs_parse(url.replace(/(^.*\?)|(^[^\?]*$)/,""))};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof navigator=="object"&&navigator.product=="ReactNative";if(!is_node&&!is_rn)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/events.js",[],function(){function EventEmitter(){this._events={}}EventEmitter.prototype.listeners=function listeners(event){return Array.apply(this,this._events[event]||[])};EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){if(!this._events||!this._events[event])return false;var listeners=this._events[event],length=listeners.length,len=arguments.length,fn=listeners[0],args,i;if(1===length){switch(len){case 1:fn.call(fn.__EE3_context||this);break;case 2:fn.call(fn.__EE3_context||this,a1);break;case 3:fn.call(fn.__EE3_context||this,a1,a2);break;case 4:fn.call(fn.__EE3_context||this,a1,a2,a3);break;case 5:fn.call(fn.__EE3_context||this,a1,a2,a3,a4);break;case 6:fn.call(fn.__EE3_context||this,a1,a2,a3,a4,a5);break;default:for(i=1,args=new Array(len-1);i<len;i++){args[i-1]=arguments[i]}fn.apply(fn.__EE3_context||this,args)}if(fn.__EE3_once)this.removeListener(event,fn)}else{for(i=1,args=new Array(len-1);i<len;i++){args[i-1]=arguments[i]}for(i=0;i<length;fn=listeners[++i]){fn.apply(fn.__EE3_context||this,args);if(fn.__EE3_once)this.removeListener(event,fn)}}return true};function _addListener(event,fn,context,prepend){if(!this._events)this._events={};if(!this._events[event])this._events[event]=[];fn.__EE3_context=context;if(prepend)this._events[event].unshift(fn);else this._events[event].push(fn);return this}EventEmitter.prototype.on=function on(event,fn,context){return _addListener.apply(this,[event,fn,context])};EventEmitter.prototype.once=function once(event,fn,context){fn.__EE3_once=true;return this.on(event,fn,context)};EventEmitter.prototype.prependListener=function prependListener(event,fn,context){return _addListener.apply(this,[event,fn,context,true])};EventEmitter.prototype.prependOnceListener=function prependOnceListener(event,fn,context){fn.__EE3_once=true;return this.prependListener(event,fn,context)};EventEmitter.prototype.removeListener=function removeListener(event,fn){if(!this._events||!this._events[event])return this;var listeners=this._events[event],events=[];for(var i=0,length=listeners.length;i<length;i++){if(fn&&listeners[i]!==fn){events.push(listeners[i])}}if(events.length)this._events[event]=events;else this._events[event]=null;return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){if(!this._events)return this;if(event)this._events[event]=null;else this._events={};return this};EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.setMaxListeners=function setMaxListeners(){return this};EventEmitter.prototype.eventNames=function eventNames(){var _this=this;return Object.keys(this._events).filter(function(e){return _this._events[e]!==null})};EventEmitter.EventEmitter=EventEmitter;EventEmitter.EventEmitter2=EventEmitter;EventEmitter.EventEmitter3=EventEmitter;return EventEmitter})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/array.js",[],function(){var E={};var proto_slice=Array.prototype.slice;E.copy=function(a){switch(a.length){case 0:return[];case 1:return[a[0]];case 2:return[a[0],a[1]];case 3:return[a[0],a[1],a[2]];case 4:return[a[0],a[1],a[2],a[3]];case 5:return[a[0],a[1],a[2],a[3],a[4]];default:return proto_slice.call(a)}};E.push=function(a){for(var i=1;i<arguments.length;i++){var arg=arguments[i];if(Array.isArray(arg))a.push.apply(a,arg);else a.push(arg)}return a.length};E.unshift=function(a){for(var i=arguments.length-1;i>0;i--){var arg=arguments[i];if(Array.isArray(arg))a.unshift.apply(a,arg);else a.unshift(arg)}return a.length};E.slice=function(args,from,to){return Array.prototype.slice.call(args,from,to)};E.compact=function(a){return E.compact_self(a.slice())};E.compact_self=function(a){var i,j,n=a.length;for(i=0;i<n&&a[i];i++);if(i==n)return a;for(j=i;i<n;i++){if(!a[i])continue;a[j++]=a[i]}a.length=j;return a};E.flatten_shallow=function(a){return Array.prototype.concat.apply([],a)};E.flatten=function(a){var _a=[],i;for(i=0;i<a.length;i++){if(Array.isArray(a[i]))Array.prototype.push.apply(_a,E.flatten(a[i]));else _a.push(a[i])}return _a};E.unique=function(a){var _a=[];for(var i=0;i<a.length;i++){if(!_a.includes(a[i]))_a.push(a[i])}return _a};E.to_nl=function(a,sep){if(!a||!a.length)return"";if(sep===undefined)sep="\n";return a.join(sep)+sep};E.sed=function(a,regex,replace){var _a=new Array(a.length),i;for(i=0;i<a.length;i++)_a[i]=a[i].replace(regex,replace);return _a};E.grep=function(a,regex,replace){var _a=[],i;for(i=0;i<a.length;i++){if(a[i].search(regex)<0)continue;if(replace!==undefined)_a.push(a[i].replace(regex,replace));else _a.push(a[i])}return _a};E.rm_elm=function(a,elm){var i=a.indexOf(elm);if(i<0)return;a.splice(i,1);return elm};E.rm_elm_tail=function(a,elm){var i=a.length-1;if(elm===a[i]){a.pop();return elm}if((i=a.lastIndexOf(elm,i-1))<0)return;a.splice(i,1);return elm};E.add_elm=function(a,elm){if(a.includes(elm))return;a.push(elm);return elm};E.split_every=function(a,n){var ret=[];for(var i=0;i<a.length;i+=n)ret.push(a.slice(i,i+n));return ret};E.split_at=function(a,delim){var ret=[];delim=delim||"";for(var i=0;i<a.length;i++){var chunk=[];for(;i<a.length&&a[i]!=delim;i++)chunk.push(a[i]);if(chunk.length)ret.push(chunk)}return ret};E.rotate=function(a,n){if(a&&a.length>1&&(n=n%a.length))E.unshift(a,a.splice(n));return a};E.move=function(a,from,to,n){return Array.prototype.splice.apply(a,[to,n].concat(a.slice(from,from+n)))};E.to_array=function(v){return Array.isArray(v)?v:v==null?[]:[v]};var proto={};proto.sed=function(regex,replace){return E.sed(this,regex,replace)};proto.grep=function(regex,replace){return E.grep(this,regex,replace)};proto.to_nl=function(sep){return E.to_nl(this,sep)};proto.push_a=function(){return E.push.apply(null,[this].concat(Array.from(arguments)))};proto.unshift_a=function(){return E.unshift.apply(null,[this].concat(Array.from(arguments)))};var installed;E.prototype_install=function(){if(installed)return;installed=true;for(var i in proto){Object.defineProperty(Array.prototype,i,{value:proto[i],configurable:true,enumerable:false,writable:true})}};E.prototype_uninstall=function(){if(!installed)return;installed=false;for(var i in proto)delete Array.prototype[i]};return E})})();
(function(){var __hola_stub_define,node_util;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof navigator=="object"&&navigator.product=="ReactNative";var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");if(is_ff_addon)define=require("./require_node.js").define(module,"../");else if(is_rn){define=require("./require_node.js").define(module,"../",require("/util/array.js"))}else if(!is_node)define=define||self.define;else{node_util=require("util");define=require("./require_node.js").define(module,"../")}define("/util/util.js",["/util/array.js"],function(array){var E={};E._is_mocha=undefined;E.is_mocha=function(){if(E._is_mocha!==undefined)return E._is_mocha;if(typeof process!="undefined"&&typeof process.env!="undefined")return E._is_mocha=process.env.IS_MOCHA||false;return E._is_mocha=false};E.is_lxc=function(){return is_node&&+process.env.LXC};E.f_mset=function(flags,mask,bits){return flags&~mask|bits};E.f_lset=function(flags,bits,logic){return E.f_mset(flags,bits,logic?bits:0)};E.f_meq=function(flags,mask,bits){return(flags&mask)==bits};E.f_eq=function(flags,bits){return(flags&bits)==bits};E.f_cmp=function(f1,f2,mask){return(f1&mask)==(f2&mask)};E.xor=function(a,b){return!a!=!b};E.div_ceil=function(a,b){return Math.floor((a+b-1)/b)};E.ceil_mul=function(a,b){return E.div_ceil(a,b)*b};E.floor_mul=function(a,b){return Math.floor(a/b)*b};E.range=function(x,a,b){return x>=a&&x<=b};E.range.ii=function(x,a,b){return x>=a&&x<=b};E.range.ie=function(x,a,b){return x>=a&&x<b};E.range.ei=function(x,a,b){return x>a&&x<=b};E.range.ee=function(x,a,b){return x>a&&x<b};E.clamp=function(lower_bound,value,upper_bound){if(value<lower_bound)return lower_bound;if(value<upper_bound)return value;return upper_bound};E.revcmp=function(a,b){return a>b?-1:a<b?1:0};E.union_with=function(fn){var res={},args;if(arguments.length==2&&typeof arguments[1]=="object")args=arguments[1];else args=array.slice(arguments,1);for(var i=0;i<args.length;++i){for(var key in args[i]){var arg=args[i];res[key]=res.hasOwnProperty(key)?fn(res[key],arg[key]):arg[key]}}return res};function _clone_deep(obj){var i,n,ret;if(obj instanceof Array){ret=new Array(obj.length);n=obj.length;for(i=0;i<n;i++)ret[i]=obj[i]instanceof Object?_clone_deep(obj[i]):obj[i];return ret}else if(obj instanceof Date)return new Date(obj);else if(obj instanceof RegExp)return new RegExp(obj);else if(obj instanceof Function)return obj;ret={};for(i in obj)ret[i]=obj[i]instanceof Object?_clone_deep(obj[i]):obj[i];return ret}E.clone_deep=function(obj){if(!(obj instanceof Object))return obj;return _clone_deep(obj)};E.extend=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source)obj[prop]=source[prop]}return obj};function is_object(obj){return obj&&obj.constructor==Object}E.extend_deep=function(obj){if(!is_object(obj))return obj;for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(is_object(source[prop])&&is_object(obj[prop]))E.extend_deep(obj[prop],source[prop]);else obj[prop]=source[prop]}}return obj};E.extend_deep_del_null=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(is_object(source[prop])){if(!is_object(obj[prop]))obj[prop]={};E.extend_deep_del_null(obj[prop],source[prop])}else if(source[prop]==null)delete obj[prop];else obj[prop]=source[prop]}}return obj};E.defaults=function(obj){if(!obj)obj={};for(var i=1;i<arguments.length;i++){var source=arguments[i];if(obj===undefined)continue;for(var prop in source){if(obj[prop]===undefined)obj[prop]=source[prop]}}return obj};E.defaults_deep=function(obj){if(obj!==undefined&&!is_object(obj))return obj;for(var i=1;i<arguments.length;i++){var source=arguments[i];if(obj===undefined)obj=E.clone_deep(source);else if(is_object(source)){for(var prop in source){var s=source[prop],d=obj[prop];if(d===undefined)obj[prop]=E.clone_deep(s);else E.defaults_deep(d,s)}}}return obj};E.clone=function(obj){if(!(obj instanceof Object))return obj;if(obj instanceof Array){var a=new Array(obj.length);for(var i=0;i<obj.length;i++)a[i]=obj[i];return a}return E.extend({},obj)};E.freeze_deep=function(obj){if(typeof obj=="object"){for(var prop in obj){if(obj.hasOwnProperty(prop))E.freeze_deep(obj[prop])}}return Object.freeze(obj)};E.equal_deep=function(a,b){var i;if(a===b)return true;if(!a||!b||a.constructor!==b.constructor)return false;if(a instanceof Function||a instanceof RegExp)return a.toString()==b.toString();if(a instanceof Date)return+a==+b;if(Array.isArray(a)){if(a.length!=b.length)return false;for(i=0;i<a.length;i++){if(!E.equal_deep(a[i],b[i]))return false}return true}if(is_object(a)){var a_keys=Object.keys(a),b_keys=Object.keys(b);if(a_keys.length!=b_keys.length)return false;for(i=0;i<a_keys.length;i++){var key=a_keys[i];if(!E.equal_deep(a[key],b[key]))return false}return true}return false};E.map_obj=function(obj,fn){var ret={};for(var i in obj)ret[i]=fn(obj[i],i,obj);return ret};E.sort_obj=function(obj){if(obj instanceof Array||!(obj instanceof Object))return obj;var ret={},keys=Object.keys(obj).sort();for(var i=0;i<keys.length;i++)ret[keys[i]]=E.sort_obj(obj[keys[i]]);return ret};E.forEach=function(obj,fn,_this){for(var i in obj)fn.call(_this,obj[i],i,obj)};E.find=function(obj,fn,_this){for(var i in obj){if(fn.call(_this,obj[i],i,obj))return obj[i]}};E.find_prop=function(obj,prop,val){return E.find(obj,function(o){return o[prop]===val})};E.isspace=function(c){return/\s/.test(c)};E.isdigit=function(c){return c>="0"&&c<="9"};E.isalpha=function(c){return c>="a"&&c<="z"||c>="A"&&c<="Z"};E.isalnum=function(c){return E.isdigit(c)||E.isalpha(c)};E.obj_pluck=function(obj,prop){var val=obj[prop];delete obj[prop];return val};E.proto_keys=function(proto){var keys=[];for(var i in proto)keys.push(i);return keys};E.values=function(obj){var values=[];for(var i in obj)values.push(obj[i]);return values};E.path=function(path){if(Array.isArray(path))return path;path=""+path;if(!path)return[];return path.split(".")};E.get=function(o,path,def){path=E.path(path);for(var i=0;i<path.length;i++){if(!o||!(path[i]in o))return def;o=o[path[i]]}return o};E.set=function(o,path,value){path=E.path(path);for(var i=0;i<path.length-1;i++){var p=path[i];o=o[p]||(o[p]={})}o[path[path.length-1]]=value};var has_unique={};E.has=function(o,path){return E.get(o,path,has_unique)!==has_unique};E.own=function(o,prop){return Object.prototype.hasOwnProperty.call(o,prop)};E.bool_lookup=function(a,split){var ret={},i;if(typeof a=="string")a=a.split(split||/\s/);for(i=0;i<a.length;i++)ret[a[i]]=true;return ret};E.clone_inplace=function(dst,src){if(dst===src)return dst;if(Array.isArray(dst)){for(var i=0;i<src.length;i++)dst[i]=src[i];dst.splice(src.length)}else if(typeof dst=="object"){for(var k in src)dst[k]=src[k];for(k in dst){if(!src.hasOwnProperty(k))delete dst[k]}}return dst};if(node_util)E.inherits=node_util.inherits;else{E.inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}E.inherit_init=function(obj,ctor,params){var orig_proto=Object.getPrototypeOf(obj);var ctor_proto=Object.assign({},ctor.prototype);Object.setPrototypeOf(ctor_proto,orig_proto);Object.setPrototypeOf(obj,ctor_proto);return ctor.apply(obj,params)};E.pick=function(obj){var i,o={};for(i=1;i<arguments.length;i++){if(E.own(obj,arguments[i]))o[arguments[i]]=obj[arguments[i]]}return o};return E})})();
(function(){var __hola_stub_define,process,zerr,assert;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof navigator=="object"&&navigator.product=="ReactNative";var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");if(!is_node){if(is_ff_addon)define=require("./require_node.js").define(module,"../");else if(is_rn){define=require("./require_node.js").define(module,"../",require("/util/events.js"),require("/util/array.js"),require("/util/util.js"))}else define=define||self.define;process={nextTick:function(fn){setTimeout(fn,0)},env:{}};assert=function(){};if(!is_ff_addon&&!is_rn&&self.hola&&self.hola.zerr)zerr=self.hola.zerr;else{zerr=function(){console.log.apply(console,arguments)};zerr.perr=zerr;zerr.debug=function(){};zerr.is=function(){return false};zerr.L={DEBUG:0}}if(!zerr.is)zerr.is=function(){return false}}else{require("./config.js");process=global.process||require("_process");zerr=require("./zerr.js");assert=require("assert");define=require("./require_node.js").define(module,"../")}define("/util/etask.js",["/util/events.js","/util/array.js","/util/util.js"],function(events,array,zutil){var E=Etask;var etask=Etask;var env=process.env,assign=Object.assign;E.use_bt=+env.ETASK_BT;E.root=[];E.assert_extra=+env.ETASK_ASSERT_EXTRA;E.nextTick=process.nextTick;E.set_zerr=function(_zerr){zerr=_zerr};E.events=new events;var cb_pre,cb_post,cb_ctx,longcb_ms,perf_enable;E.perf_stat={};if(is_rn)E.etask=E;function _cb_pre(et){return{start:Date.now()}}function _cb_post(et,ctx){ctx=ctx||cb_ctx;var ms=Date.now()-ctx.start;if(longcb_ms&&ms>longcb_ms){zerr("long cb "+ms+"ms: "+et.get_name()+", "+et.run_state.f.toString().slice(0,128))}if(perf_enable){var name=et.get_name();var perf=E.perf_stat[name]||(E.perf_stat[name]={ms:0,n:0});perf.ms+=ms;perf.n++}}function cb_set(){if(longcb_ms||perf_enable){cb_pre=_cb_pre;cb_post=_cb_post;cb_ctx={start:Date.now()}}else cb_pre=cb_post=cb_ctx=undefined}E.longcb=function(ms){longcb_ms=ms;cb_set()};E.perf=function(enable){perf_enable=enable;cb_set()};E.longcb(+env.LONGCB);E.perf(+env.ETASK_PERF);function stack_get(){var prev=Error.stackTraceLimit,err;Error.stackTraceLimit=4;err=new Error;Error.stackTraceLimit=prev;return err}function Etask(opt,states){if(!(this instanceof Etask))return new Etask(opt,states);if(Array.isArray(opt)||typeof opt=="function"){states=opt;opt=undefined}opt=typeof opt=="string"&&{name:opt}||opt||{};if(typeof states=="function"){if(states.constructor.name=="GeneratorFunction")return E._generator(null,states,opt);states=[states]}this.cur_state=this.states=this._finally=this.error=this.at_return=this.next_state=this.use_retval=this.running=this.at_continue=this.cancel=this.wait_timer=this.retval=this.run_state=this._stack=this.down=this.up=this.child=this.name=this._name=this.parent=this.cancelable=this.tm_create=this._alarm=this.tm_completed=this.parent_type=this.info=this.then_waiting=this.free=this.parent_guess=this.child_guess=this.wait_retval=undefined;this.name=opt.name;this._name=this.name===undefined?"noname":this.name;this.cancelable=opt.cancel;this.then_waiting=[];this.child=[];this.child_guess=[];this.cur_state=-1;this.states=[];this._stack=Etask.use_bt?stack_get():undefined;this.tm_create=Date.now();this.info={};var idx=this.states.idx={};for(var i=0;i<states.length;i++){var pstate=states[i],t;if(typeof pstate!="function")assert(0,"invalid state type");t=this._get_func_type(pstate);var state={f:pstate,label:t.label,try_catch:t.try_catch,"catch":t.catch,"finally":t.finally,cancel:t.cancel,sig:undefined};if(i==0&&opt.state0_args){state.f=state.f.bind.apply(state.f,[this].concat(opt.state0_args))}if(state.label)idx[state.label]=i;assert((state.catch||state.try_catch?1:0)+(state.finally?1:0)+(state.cancel?1:0)<=1,"invalid multiple state types");state.sig=state.finally||state.cancel;if(state.finally){assert(this._finally===undefined,"more than 1 finally$");this._finally=i}if(state.cancel){assert(this.cancel===undefined,"more than 1 cancel$");this.cancel=i}this.states[i]=state}var _this=this;E.root.push(this);var in_run=E.in_run_top();if(opt.spawn_parent)this.spawn_parent(opt.spawn_parent);else if(opt.up)opt.up._set_down(this);else if(in_run)this._spawn_parent_guess(in_run);if(opt.init)opt.init.call(this);if(opt.async){var wait_retval=this._set_wait_retval();E.nextTick(function(){if(_this.running!==undefined)return;_this._got_retval(wait_retval)})}else this._next_run();return this}zutil.inherits(Etask,events.EventEmitter);E.prototype._root_remove=function(){assert(!this.parent,"cannot remove from root when has parent");if(!array.rm_elm_tail(E.root,this))assert(0,"etask not in root\n"+E.ps({MARK:this}))};E.prototype._parent_remove=function(){if(this.up){var up=this.up;this.up=this.up.down=undefined;if(up.tm_completed)up._check_free();return}if(this.parent_guess)this._parent_guess_remove();if(!this.parent)return this._root_remove();if(!array.rm_elm_tail(this.parent.child,this)){assert(0,"etask child not in parent\n"+E.ps({MARK:[["child",this],["parent",this.parent]]}))}if(this.parent.tm_completed)this.parent._check_free();this.parent=undefined};E.prototype._check_free=function(){if(this.down||this.child.length)return;this._parent_remove();this.free=true};E.prototype._call_err=function(e){E.ef(e)};E.prototype.emit_safe=function(){try{this.emit.apply(this,arguments)}catch(e){this._call_err(e)}};E.prototype._call_safe=function(state_fn){try{return state_fn.call(this)}catch(e){this._call_err(e)}};E.prototype._complete=function(){if(zerr.is(zerr.L.DEBUG))zerr.debug(this._name+": close");this.tm_completed=Date.now();this.parent_type=this.up?"call":"spawn";if(this.error)this.emit_safe("uncaught",this.error);if(this._finally!==undefined){var ret=this._call_safe(this.states[this._finally].f);if(E.is_err(ret))this._set_retval(ret)}this.emit_safe("finally");this.emit_safe("ensure");if(this.error&&!this.up&&!this.parent&&!this.parent_guess)E.events.emit("uncaught",this);if(this.parent)this.parent.emit("child",this);if(this.up&&(this.down||this.child.length)){var up=this.up;this.up=this.up.down=undefined;this.parent=up;up.child.push(this)}this._check_free();this._del_wait_timer();this.del_alarm();this._ecancel_child();this.emit_safe("finally1");while(this.then_waiting.length)this.then_waiting.shift()()};E.prototype._next=function(rv){if(this.tm_completed)return true;rv=rv||{ret:undefined,err:undefined};var states=this.states;var state=this.at_return?states.length:this.next_state!==undefined?this.next_state:this.cur_state+1;this.retval=rv.ret;this.error=rv.err;if(rv.err!==undefined){if(zerr.on_exception)zerr.on_exception(rv.err);if(this.run_state.try_catch){this.use_retval=true;for(;state<states.length&&states[state].sig;state++);}else for(;state<states.length&&!states[state].catch;state++);}else{for(;state<states.length&&(states[state].sig||states[state].catch);state++);}this.cur_state=state;this.run_state=states[state];this.next_state=undefined;if(this.cur_state<states.length)return false;this._complete();return true};E.prototype._next_run=function(rv){if(this._next(rv))return;this._run()};E.prototype._handle_rv=function(rv){var wait_retval,_this=this,ret=rv.ret;if(ret===this.retval);else if(!ret);else if(ret instanceof Etask){if(!ret.tm_completed){this._set_down(ret);wait_retval=this._set_wait_retval();ret.then_waiting.push(function(){_this._got_retval(wait_retval,E.err_res(ret.error,ret.retval))});return true}rv.err=ret.error;rv.ret=ret.retval}else if(ret instanceof Etask_err){rv.err=ret.error;rv.ret=undefined}else if(typeof ret.then=="function"){wait_retval=this._set_wait_retval();ret.then(function(ret){_this._got_retval(wait_retval,ret)},function(err){_this._got_retval(wait_retval,E.err(err))});return true}else if(typeof ret.next=="function"&&typeof ret.throw=="function"){rv.ret=E._generator(ret,this.states[this.cur_state]);return this._handle_rv(rv)}return false};E.prototype._set_retval=function(ret){if(ret===this.retval&&!this.error);else if(!ret){this.retval=ret;this.error=undefined}else if(ret instanceof Etask){if(ret.tm_completed){this.retval=ret.retval;this.error=ret.error}}else if(ret instanceof Etask_err){this.retval=undefined;this.error=ret.error}else if(typeof ret.then=="function");else if(typeof ret.next=="function"&&typeof ret.throw=="function");else{this.retval=ret;this.error=undefined}return ret};E.prototype._set_wait_retval=function(){return this.wait_retval=new Etask_wait(this,"wait_int")};E.in_run=[];E.in_run_top=function(){return E.in_run[E.in_run.length-1]};E.prototype._run=function(){var rv={ret:undefined,err:undefined};while(1){var cb_ctx;var arg=this.error&&!this.use_retval?this.error:this.retval;this.use_retval=false;this.running=true;rv.ret=rv.err=undefined;E.in_run.push(this);if(zerr.is(zerr.L.DEBUG))zerr.debug(this._name+":S"+this.cur_state+": running");if(cb_pre)cb_ctx=cb_pre(this);try{rv.ret=this.run_state.f.call(this,arg)}catch(e){rv.err=e;if(rv.err instanceof Error)rv.err.etask=this}if(cb_post)cb_post(this,cb_ctx);this.running=false;E.in_run.pop();for(;this.child_guess.length;this.child_guess.pop().parent_guess=undefined);if(rv.ret instanceof Etask_wait){var wait_completed=false,wait=rv.ret;if(!this.at_continue&&!wait.ready){this.wait_retval=wait;if(wait.op=="wait_child")wait_completed=this._set_wait_child(wait);if(wait.timeout)this._set_wait_timer(wait.timeout);if(!wait_completed)return;this.wait_retval=undefined}rv.ret=this.at_continue?this.at_continue.ret:wait.ready&&!wait.completed?wait.ready.ret:undefined;wait.completed=true}this.at_continue=undefined;if(this._handle_rv(rv))return;if(this._next(rv))return}};E.prototype._set_down=function(down){if(this.down)assert(0,"caller already has a down\n"+this.ps());if(down.parent_guess)down._parent_guess_remove();assert(!down.parent,"returned etask already has a spawn parent");assert(!down.up,"returned etask already has a caller parent");down._parent_remove();this.down=down;down.up=this};var func_type_cache={};E.prototype._get_func_type=function(func,on_fail){var name=func.name;var type=func_type_cache[name];if(type)return type;type=func_type_cache[name]={name:undefined,label:undefined,try_catch:undefined,"catch":undefined,"finally":undefined,cancel:undefined};if(!name)return type;type.name=name;var n=name.split("$");if(n.length==1){type.label=n[0];return type}if(n.length>2)return type;if(n[1].length)type.label=n[1];var f=n[0].split("_");for(var j=0;j<f.length;j++){if(f[j]=="try"){type.try_catch=true;if(f[j+1]=="catch")j++}else if(f[j]=="catch")type["catch"]=true;else if(f[j]=="finally"||f[j]=="ensure")type.finally=true;else if(f[j]=="cancel")type.cancel=true;else{return void(on_fail||assert.bind(null,false))("unknown func name "+name)}}return type};E.prototype.spawn=function(child,replace){if(!(child instanceof Etask)&&child&&typeof child.then=="function"){var promise=child;child=etask([function(){return promise}])}if(!(child instanceof Etask)){this.emit("child",child);return}if(!replace&&child.parent)assert(0,"child already has a parent\n"+child.parent.ps());child.spawn_parent(this)};E.prototype._spawn_parent_guess=function(parent){this.parent_guess=parent;parent.child_guess.push(this)};E.prototype._parent_guess_remove=function(){if(!array.rm_elm_tail(this.parent_guess.child_guess,this))assert(0,"etask not in parent_guess\n"+E.ps({MARK:this}));this.parent_guess=undefined};E.prototype.spawn_parent=function(parent){if(this.up)assert(0,"child already has an up\n"+this.up.ps());if(this.tm_completed&&!this.parent)return;this._parent_remove();if(parent&&parent.free)parent=undefined;if(!parent)return void E.root.push(this);parent.child.push(this);this.parent=parent};E.prototype.set_state=function(name){var state=this.states.idx[name];assert(state!==undefined,'named func "'+name+'" not found');return this.next_state=state};E.prototype.finally=function(cb){this.prependListener("finally",cb)};E.prototype.goto_fn=function(name){return this.goto.bind(this,name)};E.prototype.goto=function(name,promise){this.set_state(name);var state=this.states[this.next_state];assert(!state.sig,"goto to sig");return this.continue(promise)};E.prototype.loop=function(promise){this.next_state=this.cur_state;return promise};E.prototype._set_wait_timer=function(timeout){var _this=this;this.wait_timer=setTimeout(function(){_this.wait_timer=undefined;_this._next_run({ret:undefined,err:"timeout"})},timeout)};E.prototype._del_wait_timer=function(){if(this.wait_timer)this.wait_timer=clearTimeout(this.wait_timer);this.wait_retval=undefined};E.prototype._get_child_running=function(from){var i,child=this.child;for(i=from||0;i<child.length&&child[i].tm_completed;i++);return i>=child.length?-1:i};E.prototype._set_wait_child=function(wait_retval){var i,_this=this,child=wait_retval.child;var cond=wait_retval.cond,wait_on;assert(!cond||child=="any",'condition supported only for "any" '+"option, you can add support if needed");if(child=="any"){if(this._get_child_running()<0)return true;wait_on=function(){_this.once("child",function(child){if(!cond||cond.call(child,child.retval))return _this._got_retval(wait_retval,{child:child});if(_this._get_child_running()<0)return _this._got_retval(wait_retval);wait_on()})};wait_on()}else if(child=="all"){if((i=this._get_child_running())<0)return true;wait_on=function(child){_this.once("child",function(child){var i;if((i=_this._get_child_running())<0)return _this._got_retval(wait_retval);wait_on(_this.child[i])})};wait_on(this.child[i])}else{assert(child,"no child provided");assert(this===child.parent,"child does not belong to parent");if(child.tm_completed)return true;child.once("finally",function(){return _this._got_retval(wait_retval,{child:child})})}this.emit_safe("wait_on_child")};E.prototype._got_retval=function(wait_retval,res){if(this.wait_retval!==wait_retval||wait_retval.completed)return;wait_retval.completed=true;this._next_run(E._res2rv(res))};E.prototype.continue_fn=function(){return this.continue.bind(this)};E.continue_depth=0;E.prototype.continue=function(promise,sync){this.wait_retval=undefined;this._set_retval(promise);if(this.tm_completed)return promise;if(this.down)this.down._ecancel();this._del_wait_timer();var rv={ret:promise,err:undefined};if(this.running){this.at_continue=rv;return promise}if(this._handle_rv(rv))return rv.ret;var _this=this;if(E.is_final(promise)&&(!E.continue_depth&&!E.in_run.length||sync)){E.continue_depth++;this._next_run(rv);E.continue_depth--}else E.nextTick(function(){_this._next_run(rv)});return promise};E.prototype._ecancel=function(){if(this.tm_completed)return this;this.emit_safe("cancel");if(this.cancel!==undefined)return this._call_safe(this.states[this.cancel].f);if(this.cancelable)return this.return()};E.prototype._ecancel_child=function(){if(!this.child.length)return;var child=Array.from(this.child);for(var i=0;i<child.length;i++)child[i]._ecancel()};E.prototype.return_fn=function(){return this.return.bind(this)};E.prototype.return=function(promise){if(this.tm_completed)return this._set_retval(promise);this.at_return=true;this.next_state=undefined;return this.continue(promise,true)};E.prototype.del_alarm=function(){var a=this._alarm;if(!a)return;clearTimeout(a.id);if(a.cb)this.removeListener("sig_alarm",a.cb);this._alarm=undefined};E.prototype.alarm_left=function(){var a=this._alarm;if(!a)return 0;return a.start-Date.now()};E.prototype._operation_opt=function(opt){if(opt.goto)return{ret:this.goto(opt.goto,opt.ret)};if(opt.throw)return{ret:this.throw(opt.throw)};if(opt.return!==undefined)return{ret:this.return(opt.return)};if(opt.continue!==undefined)return{ret:this.continue(opt.continue)}};E.prototype.alarm=function(ms,cb){var _this=this,opt,a;if(cb&&typeof cb!="function"){opt=cb;cb=function(){var v;if(!(v=_this._operation_opt(opt)))assert(0,"invalid alarm cb opt");return v.ret}}this.del_alarm();a=this._alarm={ms:ms,cb:cb,start:Date.now()};a.id=setTimeout(function(){_this._alarm=undefined;_this.emit("sig_alarm")},a.ms);if(cb)this.once("sig_alarm",cb)};function Etask_wait(et,op,timeout){this.timeout=timeout;this.et=et;this.op=op;this.child=this.at_child=this.cond=undefined;this.ready=this.completed=undefined}Etask_wait.prototype.continue=function(res){if(this.completed)return;if(!this.et.wait_retval)return void(this.ready={ret:res});if(this!==this.et.wait_retval)return;this.et.continue(res)};Etask_wait.prototype.continue_fn=function(){return this.continue.bind(this)};Etask_wait.prototype.throw=function(err){return this.continue(E.err(err))};Etask_wait.prototype.throw_fn=function(){return this.throw.bind(this)};E.prototype.wait=function(timeout){return new Etask_wait(this,"wait",timeout)};E.prototype.wait_child=function(child,timeout,cond){if(typeof timeout=="function"){cond=timeout;timeout=0}var wait=new Etask_wait(this,"wait_child",timeout);wait.child=child;wait.at_child=null;wait.cond=cond;return wait};E.prototype.throw_fn=function(err){return err?this.throw.bind(this,err):this.throw.bind(this)};E.prototype.throw=function(err){return this.continue(E.err(err))};E.prototype.get_name=function(flags){var stack=this._stack instanceof Error?this._stack.stack.split("\n"):undefined;var caller;flags=flags||{};if(stack){caller=/^    at (.*)$/.exec(stack[4]);caller=caller?caller[1]:undefined}var names=[];if(this.name)names.push(this.name);if(caller&&!(this.name&&flags.SHORT_NAME))names.push(caller);if(!names.length)names.push("noname");return names.join(" ")};E.prototype.state_str=function(){return this.cur_state+(this.next_state?"->"+this.next_state:"")};E.prototype.get_depth=function(){var i=0,et=this;for(;et;et=et.up,i++);return i};function trim_space(s){if(s[s.length-1]!=" ")return s;return s.slice(0,-1)}function ms_to_str(ms){var s=""+ms;return s.length<=3?s+"ms":s.slice(0,-3)+"."+s.slice(-3)+"s"}E.prototype.get_time_passed=function(){return ms_to_str(Date.now()-this.tm_create)};E.prototype.get_time_completed=function(){return ms_to_str(Date.now()-this.tm_completed)};E.prototype.get_info=function(){var info=this.info,s="",_i;if(!info)return"";for(var i in info){_i=info[i];if(!_i)continue;if(s!=="")s+=" ";if(typeof _i=="function")s+=_i();else s+=_i}return trim_space(s)};function Etask_err(err){this.error=err||new Error}E.Etask_err=Etask_err;E.err=function(err){return new Etask_err(err)};E.is_err=function(v){return v instanceof Etask&&v.error!==undefined||v instanceof Etask_err};E.err_res=function(err,res){return err?E.err(err):res};E._res2rv=function(res){return E.is_err(res)?{ret:undefined,err:res.error}:{ret:res,err:undefined}};E.is_final=function(v){return!v||typeof v.then!="function"||v instanceof Etask_err||v instanceof Etask&&!!v.tm_completed};E.prototype.then=function(on_res,on_err){var _this=this;function on_done(){if(!_this.error)return!on_res?_this.retval:on_res(_this.retval);return!on_err?E.err(_this.error):on_err(_this.error)}if(this.tm_completed)return etask("then_completed",[function(){return on_done()}]);var then_wait=etask("then_wait",[function(){return this.wait()}]);this.then_waiting.push(function(){try{then_wait.continue(on_done())}catch(e){then_wait.throw(e)}});return then_wait};E.prototype.otherwise=E.prototype.catch=function(on_err){return this.then(null,on_err)};E.prototype.ensure=function(on_ensure){return this.then(function(res){on_ensure();return res},function(err){on_ensure();throw err})};Etask_err.prototype.then=function(on_res,on_err){var _this=this;return etask("then_err",[function(){return!on_err?E.err(_this.error):on_err(_this.error)}])};Etask_err.prototype.otherwise=Etask_err.prototype.catch=function(on_err){return this.then(null,on_err)};Etask_err.prototype.ensure=function(on_ensure){this.then(null,function(){on_ensure()});return this};E.resolve=function(res){return etask([function(){return res}])};E.reject=function(err){return etask([function(){throw err}])};E.prototype.wait_ext=function(promise){if(!promise||typeof promise.then!="function")return promise;var wait=this.wait();promise.then(wait.continue_fn(),wait.throw_fn());return wait};E.prototype.longname=function(flags){flags=flags||{TIME:1};var s="",_s;if(this.running)s+="RUNNING ";s+=this.get_name(flags)+(!this.tm_completed?"."+this.state_str():"")+" ";if(this.tm_completed)s+="COMPLETED"+(flags.TIME?" "+this.get_time_completed():"")+" ";if(flags.TIME)s+=this.get_time_passed()+" ";if(_s=this.get_info())s+=_s+" ";return trim_space(s)};E.prototype.stack=function(flags){var et=this,s="";flags=assign({STACK:1,RECURSIVE:1,GUESS:1},flags);while(et){var _s=et.longname(flags)+"\n";if(et.up)et=et.up;else if(et.parent){_s=(et.parent_type=="call"?"CALL":"SPAWN")+" "+_s;et=et.parent}else if(et.parent_guess&&flags.GUESS){_s="SPAWN? "+_s;et=et.parent_guess}else et=undefined;if(flags.TOPDOWN)s=_s+s;else s+=_s}return s};E.prototype._ps=function(pre_first,pre_next,flags){var i,s="",task_trail,et=this,child_guess;if(++flags.limit_n>=flags.LIMIT)return flags.limit_n==flags.LIMIT?"\nLIMIT "+flags.LIMIT+"\n":"";for(;et.up;et=et.up);for(var first=1;et;et=et.down,first=0){s+=first?pre_first:pre_next;first=0;if(flags.MARK&&(i=flags.MARK.sp.indexOf(et))>=0)s+=(flags.MARK.name[i]||"***")+" ";s+=et.longname(flags)+"\n";if(flags.RECURSIVE){var stack_trail=et.down?".":" ";var child=et.child;if(flags.GUESS)child=child.concat(et.child_guess);for(i=0;i<child.length;i++){task_trail=i<child.length-1?"|":stack_trail;child_guess=child[i].parent_guess?"\\? ":child[i].parent_type=="call"?"\\> ":"\\_ ";s+=child[i]._ps(pre_next+task_trail+child_guess,pre_next+task_trail+"   ",flags)}}}return s};function ps_flags(flags){var m,_m;if(m=flags.MARK){if(!Array.isArray(m))_m={sp:[m],name:[]};else if(!Array.isArray(flags.MARK[0]))_m={sp:m,name:[]};else{_m={sp:[],name:[]};for(var i=0;i<m.length;i++){_m.name.push(m[i][0]);_m.sp.push(m[i][1])}}flags.MARK=_m}}E.prototype.ps=function(flags){flags=assign({STACK:1,RECURSIVE:1,LIMIT:1e7,TIME:1,GUESS:1},flags,{limit_n:0});ps_flags(flags);return this._ps("","",flags)};E._longname_root=function(){return(zerr.prefix?zerr.prefix+"pid "+process.pid+" ":"")+"root"};E.ps=function(flags){var i,s="",task_trail;flags=assign({STACK:1,RECURSIVE:1,LIMIT:1e7,TIME:1,GUESS:1},flags,{limit_n:0});ps_flags(flags);s+=E._longname_root()+"\n";var child=E.root;if(flags.GUESS){child=[];for(i=0;i<E.root.length;i++){if(!E.root[i].parent_guess)child.push(E.root[i])}}for(i=0;i<child.length;i++){task_trail=i<child.length-1?"|":" ";s+=child[i]._ps(task_trail+"\\_ ",task_trail+"   ",flags)}return s};function assert_tree_unique(a){var i;for(i=0;i<a.length-1;i++)assert(!a.includes(a[i],i+1))}E.prototype._assert_tree=function(opt){var i,et;opt=opt||{};assert_tree_unique(this.child);assert(this.parent);if(this.down){et=this.down;assert(et.up===this);assert(!et.parent);assert(!et.parent_guess);this.down._assert_tree(opt)}for(i=0;i<this.child.length;i++){et=this.child[i];assert(et.parent===this);assert(!et.parent_guess);assert(!et.up);et._assert_tree(opt)}if(this.child_guess.length)assert(E.in_run.includes(this));for(i=0;i<this.child_guess.length;i++){et=this.child_guess[i];assert(et.parent_guess===this);assert(!et.parent);assert(!et.up)}};E._assert_tree=function(opt){var i,et,child=E.root;opt=opt||{};assert_tree_unique(E.root);for(i=0;i<child.length;i++){et=child[i];assert(!et.parent);assert(!et.up);et._assert_tree(opt)}};E.prototype._assert_parent=function(){if(this.up)return assert(!this.parent&&!this.parent_guess);assert(this.parent&&this.parent_guess,"parent_guess together with parent");if(this.parent){var child=this.parent?this.parent.child:E.root;assert(child.includes(this),"cannot find in parent "+(this.parent?"":"root"))}else if(this.parent_guess){assert(this.parent_guess.child_guess.includes(this),"cannot find in parent_guess");assert(E.in_run.includes(this.parent_guess))}};E.prototype.return_child=function(){var child=Array.from(this.child);for(var i=0;i<child.length;i++)child[i].return()};E.sleep=function(ms){var timer;ms=ms||0;return etask({name:"sleep",cancel:true},[function(){this.info.ms=ms+"ms";timer=setTimeout(this.continue_fn(),ms);return this.wait()},function finally$(){clearTimeout(timer)}])};var ebreak_obj={ebreak:1};E.prototype.break=function(ret){return this.throw({ebreak:ebreak_obj,ret:ret})};E.for=function(cond,inc,opt,states){if(Array.isArray(opt)||typeof opt=="function"){states=opt;opt={}}if(typeof states=="function")states=[states];opt=opt||{};return etask({name:"for",cancel:true,init:opt.init_parent},[function loop(){return!cond||cond.call(this)},function try_catch$(res){if(!res)return this.return();return etask({name:"for_iter",cancel:true,init:opt.init},states||[])},function(){if(this.error){if(this.error.ebreak===ebreak_obj)return this.return(this.error.ret);return this.throw(this.error)}return inc&&inc.call(this)},function(){return this.goto("loop")}])};E.for_each=function(obj,states){var keys=Object.keys(obj);var iter={obj:obj,keys:keys,i:0,key:undefined,val:undefined};function init_iter(){this.iter=iter}return E.for(function(){this.iter=this.iter||iter;iter.key=keys[iter.i];iter.val=obj[keys[iter.i]];return iter.i<keys.length},function(){return iter.i++},{init:init_iter,init_parent:init_iter},states)};E.while=function(cond,states){return E.for(cond,null,states)};E.all=function(a_or_o,ao2){var i,j,opt={};if(ao2){opt=a_or_o;a_or_o=ao2}if(Array.isArray(a_or_o)){var a=Array.from(a_or_o);i=0;return etask({name:"all_a",cancel:true},[function(){for(j=0;j<a.length;j++)this.spawn(a[j])},function try_catch$loop(){if(i>=a.length)return this.return(a);this.info.at="at "+i+"/"+a.length;var _a=a[i];if(_a instanceof Etask)_a.spawn_parent();return _a},function(res){if(this.error){if(!opt.allow_fail)return this.throw(this.error);res=E.err(this.error)}a[i]=res;i++;return this.goto("loop")}])}else if(a_or_o instanceof Object){var keys=Object.keys(a_or_o),o={};i=0;return etask({name:"all_o",cancel:true},[function(){for(j=0;j<keys.length;j++)this.spawn(a_or_o[keys[j]])},function try_catch$loop(){if(i>=keys.length)return this.return(o);var _i=keys[i],_a=a_or_o[_i];this.info.at="at "+_i+" "+i+"/"+keys.length;if(_a instanceof Etask)_a.spawn_parent();return _a},function(res){if(this.error){if(!opt.allow_fail)return this.throw(this.error);res=E.err(this.error)}o[keys[i]]=res;i++;return this.goto("loop")}])}else assert(0,"invalid type")};E.all_limit=function(limit,arr_iter,cb){var at=0;var iter=!Array.isArray(arr_iter)?arr_iter:function(){if(at<arr_iter.length)return cb.call(this,arr_iter[at++])};return etask({name:"all_limit",cancel:true},[function(){var next;if(!(next=iter.call(this)))return this.goto("done");this.spawn(next);this.loop();if(this.child.length>=limit)return this.wait_child("any")},function done(){return this.wait_child("all")}])};E._apply=function(opt,func,_this,args){var func_name;if(typeof _this=="string"){assert(_this[0]==".","invalid method "+_this);var method=_this.slice(1),_class=func;func=_class[method];_this=_class;assert(_this instanceof Object,"invalid method ."+method);func_name=method}else if(Array.isArray(_this)&&!args){args=_this;_this=null}opt.name=opt.name||func_name||func.name;return etask(opt,[function(){var et=this,ret_sync,returned=0;args=Array.from(args);args.push(function cb(err,res){if(typeof opt.ret_sync=="string"&&!returned){var a=arguments;returned++;return void E.nextTick(function(){cb.apply(null,a)})}var nfn=opt.nfn===undefined||opt.nfn?1:0;if(opt.ret_o){var o={},i;if(Array.isArray(opt.ret_o)){for(i=0;i<opt.ret_o.length;i++)o[opt.ret_o[i]]=arguments[i+nfn]}else if(typeof opt.ret_o=="string")o[opt.ret_o]=array.slice(arguments,nfn);else assert(0,"invalid opt.ret_o");if(typeof opt.ret_sync=="string")o[opt.ret_sync]=ret_sync;res=o}else if(opt.ret_a)res=array.slice(arguments,nfn);else if(!nfn)res=err;et.continue(nfn?E.err_res(err,res):res)});ret_sync=func.apply(_this,args);if(Array.isArray(opt.ret_sync))opt.ret_sync[0][opt.ret_sync[1]]=ret_sync;returned++;return this.wait()}])};E.nfn_apply=function(opt,func,_this,args){var _opt={nfn:1};if(typeof opt=="function"||typeof func=="string"){args=_this;_this=func;func=opt;opt=_opt}else opt=assign(_opt,opt);return E._apply(opt,func,_this,args)};E.cb_apply=function(opt,func,_this,args){var _opt={nfn:0};if(typeof opt=="function"||typeof func=="string"){args=_this;_this=func;func=opt;opt=_opt}else opt=assign(_opt,opt);return E._apply(opt,func,_this,args)};E.prototype.continue_nfn=function(){return function(err,res){this.continue(E.err_res(err,res))}.bind(this)};E.augment=function(_prototype,method,e_method){var i,opt={};if(method instanceof Object&&!Array.isArray(method)){assign(opt,method);method=arguments[2];e_method=arguments[3]}if(Array.isArray(method)){if(e_method)opt.prefix=e_method;for(i=0;i<method.length;i++)E.augment(_prototype,opt,method[i]);return}opt.prefix=opt.prefix||"e_";if(!e_method)e_method=opt.prefix+method;var fn=_prototype[method];_prototype[e_method]=function(){return etask._apply({name:e_method,nfn:1},fn,this,arguments)}};E.wait=function(timeout){return etask({name:"wait",cancel:true},[function(){return this.wait(timeout)}])};E.to_nfn=function(promise,cb,opt){return etask({name:"to_nfn",async:true},[function try_catch$(){return promise},function(res){var ret=[this.error];if(opt&&opt.ret_a)ret=ret.concat(res);else ret.push(res);cb.apply(null,ret)}])};function etask_fn(opt,states,push_this){if(Array.isArray(opt)||typeof opt=="function"){states=opt;opt=undefined}return function(){var _opt=assign({},opt);_opt.state0_args=Array.from(arguments);if(push_this)_opt.state0_args.unshift(this);return new Etask(_opt,states)}}E.fn=function(opt,states){return etask_fn(opt,states,false)};E._fn=function(opt,states){return etask_fn(opt,states,true)};E._generator=function(gen,ctor,opt){opt=opt||{};opt.name=opt.name||ctor&&ctor.name||"generator";if(opt.cancel===undefined)opt.cancel=true;var done;return new Etask(opt,[function(){this.generator=gen=gen||ctor.apply(this,opt.state0_args||[]);this.generator_ctor=ctor;return{ret:undefined,err:undefined}},function try_catch$loop(rv){var res;try{res=rv.err?gen.throw(rv.err):gen.next(rv.ret)}catch(e){return this.return(E.err(e))}if(res.done){done=true;return this.return(res.value)}return res.value},function(ret){return this.goto("loop",this.error?{ret:undefined,err:this.error}:{ret:ret,err:undefined})},function finally$(){if(!done&&gen.return)try{gen.return()}catch(e){}}])};E.ef=function(err){if(zerr.on_exception)zerr.on_exception(err);return err};E.interval=function(opt,states){if(typeof opt=="number")opt={ms:opt};if(opt.mode=="fixed"){return E.for(null,function(){return etask.sleep(opt.ms)},states)}if(opt.mode=="smart"||!opt.mode){var now;return E.for(function(){now=Date.now();return true},function(){var delay=zutil.clamp(0,now+opt.ms-Date.now(),Infinity);return etask.sleep(delay)},states)}if(opt.mode=="spawn"){var stopped=false;return etask([function loop(){etask([function try_catch$(){return etask(states)},function(res){if(!this.error)return;if(this.error.ebreak!==ebreak_obj)return this.throw(this.error);stopped=true}])},function(){if(stopped)return this.return();return etask.sleep(opt.ms)},function(){if(stopped)return this.return();return this.goto("loop")}])}throw new Error("unexpected mode "+opt.mode)};return Etask})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/date.js",[],function(){var E=date_get;function pad(num,size){return("000"+num).slice(-size)}E.ms_to_dur=function(_ms){var s="",sec=Math.floor(_ms/1e3);if(sec<0){s+="-";sec=-sec}var days=Math.floor(sec/(60*60*24));sec-=days*60*60*24;var hours=Math.floor(sec/(60*60));sec-=hours*60*60;var mins=Math.floor(sec/60);sec-=mins*60;if(days)s+=days+" "+(days>1?"Days":"Day")+" ";return s+pad(hours,2)+":"+pad(mins,2)+":"+pad(sec,2)};E.dur_to_str=function(dur,opt){opt=opt||{};var parts=[];dur=+dur;function chop(period,name){if(dur<period)return;var number=Math.floor(dur/period);parts.push(number+name);dur-=number*period}chop(ms.YEAR,"y");chop(ms.MONTH,"mo");if(opt.week)chop(ms.WEEK,"w");chop(ms.DAY,"d");chop(ms.HOUR,"h");chop(ms.MIN,"min");chop(ms.SEC,"s");if(dur)parts.push(dur+"ms");if(!parts.length)return"0s";return parts.slice(0,opt.units||parts.length).join(opt.sep||"")};E.monotonic=undefined;E.init=function(){var adjust,last;if(typeof window=="object"&&window.performance&&window.performance.now){adjust=Date.now()-window.performance.now();E.monotonic=function(){return window.performance.now()+adjust}}else if(is_node&&!global.mocha_running){var timer=process.binding("timer_wrap").Timer;adjust=Date.now()-timer.now();E.monotonic=function(){return timer.now()+adjust}}else{last=adjust=0;E.monotonic=function(){var now=Date.now()+adjust;if(now>=last)return last=now;adjust+=last-now;return last}}};E.init();E.str_to_dur=function(str,opt){opt=opt||{};var month="mo|mon|months?";if(opt.short_month)month+="|m";var m=str.replace(/ /g,"").match(new RegExp("^(([0-9]+)y(ears?)?)?"+"(([0-9]+)("+month+"))?(([0-9]+)w(eeks?)?)?(([0-9]+)d(ays?)?)?"+"(([0-9]+)h(ours?)?)?(([0-9]+)(min|minutes?))?"+"(([0-9]+)s(ec|econds?)?)?(([0-9]+)ms(ec)?)?$","i"));if(!m)return;return ms.YEAR*(+m[2]||0)+ms.MONTH*(+m[5]||0)+ms.WEEK*(+m[8]||0)+ms.DAY*(+m[11]||0)+ms.HOUR*(+m[14]||0)+ms.MIN*(+m[17]||0)+ms.SEC*(+m[20]||0)+(+m[23]||0)};E.months_long=["January","February","March","April","May","June","July","August","September","October","November","December"];E.months_short=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var months_short_lc=E.months_short.map(function(m){return m.toLowerCase()});E.days_long=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];E.days_short=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var days_short_lc=E.days_short.map(function(d){return d.toLowerCase()});var days_long_lc=E.days_long.map(function(d){return d.toLowerCase()});E.locale={months_long:E.months_long,months_short:E.months_short,days_long:E.days_long,days_short:E.days_short,AM:"AM",PM:"PM"};E.get=date_get;function date_get(d,_new){var y,mon,day,H,M,S,_ms;if(d===undefined)return new Date;if(d==null)return new Date(null);if(d instanceof Date)return _new?new Date(d):d;if(typeof d=="string"){var m;d=d.trim();if(m=/^((\d\d\d\d)-(\d\d)-(\d\d)|(\d\d?)-([A-Za-z]{3})-(\d\d(\d\d)?))\s*([\sT](\d\d):(\d\d)(:(\d\d)(\.(\d\d\d))?)?Z?)?$/.exec(d)){H=+m[10]||0;M=+m[11]||0;S=+m[13]||0;_ms=+m[15]||0;if(m[2]){y=+m[2];mon=+m[3];day=+m[4];if(!y&&!mon&&!day&&!H&&!M&&!S&&!_ms)return new Date(NaN);return new Date(Date.UTC(y,mon-1,day,H,M,S,_ms))}if(m[5]){y=+m[7];mon=months_short_lc.indexOf(m[6].toLowerCase())+1;day=+m[5];if(m[7].length==2){y=+y;y+=y>=70?1900:2e3}return new Date(Date.UTC(y,mon-1,day,H,M,S,_ms))}}if(/^\d+$/.test(d))return new Date(+d);return new Date(d)}if(typeof d=="number")return new Date(d);throw new TypeError("invalid date "+d)}E.to_sql_ms=function(d){d=E.get(d);if(isNaN(d))return"0000-00-00 00:00:00.000";return pad(d.getUTCFullYear(),4)+"-"+pad(d.getUTCMonth()+1,2)+"-"+pad(d.getUTCDate(),2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)+"."+pad(d.getUTCMilliseconds(),3)};E.to_sql_sec=function(d){return E.to_sql_ms(d).slice(0,-4)};E.to_sql=function(d){return E.to_sql_ms(d).replace(/( 00:00:00)?....$/,"")};E.from_sql=E.get;E.to_month_short=function(d){d=E.get(d);return E.months_short[d.getUTCMonth()]};E.to_month_long=function(d){d=E.get(d);return E.months_long[d.getUTCMonth()]};E.to_jdate=function(d){d=E.get(d);return(pad(d.getUTCDate(),2)+"-"+E.months_short[d.getUTCMonth()]+"-"+pad(d.getUTCFullYear()%100,2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)).replace(/( 00:00)?:00$/,"")};E.to_log_file=function(d){d=E.get(d);return d.getUTCFullYear()+pad(d.getUTCMonth()+1,2)+pad(d.getUTCDate(),2)+"_"+pad(d.getUTCHours(),2)+pad(d.getUTCMinutes(),2)+pad(d.getUTCSeconds(),2)};E.from_log_file=function(d){var m=d.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})$/);if(!m)return;return new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]))};E.to_log_ms=function(d){return E.to_sql_ms(d).replace(/-/g,".")};E.from_rcs=function(d){var m=d.match(/^(\d{4})\.(\d{2})\.(\d{2})\.(\d{2})\.(\d{2})\.(\d{2})$/);if(!m)return;return new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]))};E.to_rcs=function(d){return E.to_sql_sec(d).replace(/[-: ]/g,".")};E.sec={MS:.001,SEC:1,MIN:60,HOUR:60*60,DAY:24*60*60,WEEK:7*24*60*60,MONTH:30*24*60*60,YEAR:365*24*60*60};E.ms={};for(var key in E.sec)E.ms[key]=E.sec[key]*1e3;var ms=E.ms;E.align=function(d,align){d=E.get(d,1);switch(align.toUpperCase()){case"MS":break;case"SEC":d.setUTCMilliseconds(0);break;case"MIN":d.setUTCSeconds(0,0);break;case"HOUR":d.setUTCMinutes(0,0,0);break;case"DAY":d.setUTCHours(0,0,0,0);break;case"WEEK":d.setUTCDate(d.getUTCDate()-d.getUTCDay());d.setUTCHours(0,0,0,0);break;case"MONTH":d.setUTCDate(1);d.setUTCHours(0,0,0,0);break;case"YEAR":d.setUTCMonth(0,1);d.setUTCHours(0,0,0,0);break;default:throw new Error("invalid align "+align)}return d};E.add=function(d,dur){d=E.get(d,1);if(dur.year)d.setUTCFullYear(d.getUTCFullYear()+dur.year);if(dur.month)d.setUTCMonth(d.getUTCMonth()+dur.month);["day","hour","min","sec","ms"].forEach(function(key){if(dur[key])d.setTime(+d+dur[key]*ms[key.toUpperCase()])});return d};E.describe_interval=function(_ms){return _ms<2*ms.MIN?Math.round(_ms/ms.SEC)+" sec":_ms<2*ms.HOUR?Math.round(_ms/ms.MIN)+" min":_ms<2*ms.DAY?Math.round(_ms/ms.HOUR)+" hours":_ms<2*ms.WEEK?Math.round(_ms/ms.DAY)+" days":_ms<2*ms.MONTH?Math.round(_ms/ms.WEEK)+" weeks":_ms<2*ms.YEAR?Math.round(_ms/ms.MONTH)+" months":Math.round(_ms/ms.YEAR)+" years"};E.time_ago=function(d,until_date){var _ms=E.get(until_date)-E.get(d);if(_ms<ms.SEC)return"right now";return E.describe_interval(_ms)+" ago"};E.ms_to_str=function(_ms){var s=""+_ms;return s.length<=3?s+"ms":s.slice(0,-3)+"."+s.slice(-3)+"s"};E.parse=function(text,opt){opt=opt||{};if(opt.fmt)return E.strptime(text,opt.fmt);var d,a,i,v,_v,dir,_dir,amount,now=opt.now;now=!now?new Date:new Date(now);text=text.replace(/\s+/g," ").trim().toLowerCase();if(!text)return;if(text=="now")return now;if(!isNaN(d=E.get(text)))return d;d=now;a=text.split(" ");dir=a.includes("ago")?-1:a.includes("last")?-1:a.includes("next")?1:undefined;for(i=0;i<a.length;i++){v=a[i];if(/^(ago|last|next)$/.test(v));else if(v=="today")d=E.align(d,"DAY");else if(v=="yesterday")d=E.align(+d-ms.DAY,"DAY");else if(v=="tomorrow")d=E.align(+d+ms.DAY,"DAY");else if((_v=days_short_lc.indexOf(v))>=0)d=new Date(+E.align(d,"WEEK")+_v*ms.DAY+(dir||0)*ms.WEEK);else if((_v=days_long_lc.indexOf(v))>=0)d=new Date(+E.align(d,"WEEK")+_v*ms.DAY+(dir||0)*ms.WEEK);else if(_v=/^([+-]?\d+)(?:([ymoinwdhs]+)(\d.*)?)?$/.exec(v)){if(amount!==undefined)return;amount=dir!==undefined?Math.abs(+_v[1]):+_v[1];if(_v[2]){a.splice(i+1,0,_v[2]);if(_v[3])a.splice(i+2,0,_v[3])}continue}else if(/^([ywdhs]|years?|months?|mon?|weeks?|days?|hours?|minutes?|min|seconds?|sec)$/.test(v)){_v=v[0]=="m"&&v[1]=="i"?ms.MIN:v[0]=="y"?ms.YEAR:v[0]=="m"&&v[1]=="o"?ms.MONTH:v[0]=="w"?ms.WEEK:v[0]=="d"?ms.DAY:v[0]=="h"?ms.HOUR:ms.SEC;amount=amount===undefined?1:amount;_dir=dir===undefined?opt.dir||1:dir;if(_v==ms.MONTH)d.setUTCMonth(d.getUTCMonth()+_dir*amount);else if(_v==ms.YEAR)d.setUTCFullYear(d.getUTCFullYear()+_dir*amount);else d=new Date(+d+_v*amount*_dir);amount=undefined}else return;if(amount!==undefined)return}if(amount!==undefined)return;return d};E.strptime=function(str,fmt){function month(m){return months_short_lc.indexOf(m.toLowerCase())}var parse={"%":["%",function(){},0],a:["[a-z]+",function(m){},0],A:["[a-z]+",function(m){},0],b:["[a-z]+",function(m){d.setUTCMonth(month(m))},2],B:["[a-z]+",function(m){d.setUTCMonth(month(m))},2],y:["[0-9]{2}",function(m){d.setUTCFullYear(+m+(m<70?2e3:1900))},1],Y:["[0-9]{4}",function(m){d.setUTCFullYear(+m)},1],m:["[0-9]{0,2}",function(m){d.setUTCMonth(+m-1)},2],d:["[0-9]{0,2}",function(m){d.setUTCDate(+m)},3],H:["[0-9]{0,2}",function(m){d.setUTCHours(+m)},4],M:["[0-9]{0,2}",function(m){d.setUTCMinutes(+m)},5],S:["[0-9]{0,2}",function(m){d.setUTCSeconds(+m)},6],s:["[0-9]+",function(m){d=new Date(+m)},0],L:["[0-9]{0,3}",function(m){d.setUTCMilliseconds(+m)},7],z:["[+-][0-9]{4}",function(m){var timezone=+m.slice(0,3)*3600+m.slice(3,5)*60;d=new Date(+d-timezone*1e3)},8],Z:["[a-z]{0,3}[+-][0-9]{2}:?[0-9]{2}|[a-z]{1,3}",function(m){m=/^([a-z]{0,3})(?:([+-][0-9]{2}):?([0-9]{2}))?$/i.exec(m);if(m[1]=="Z"||m[1]=="UTC")return;var timezone=+m[2]*3600+m[3]*60;d=new Date(+d-timezone*1e3)},8],I:["[0-9]{0,2}",function(m){d.setUTCHours(+m)},4],p:["AM|PM",function(m){if(d.getUTCHours()==12)d.setUTCHours(d.getUTCHours()-12);if(m.toUpperCase()=="PM")d.setUTCHours(d.getUTCHours()+12)},9]};var ff=[];var ff_idx=[];var re=new RegExp("^\\s*"+fmt.replace(/%(?:([a-zA-Z%]))/g,function(_,fd){var d=parse[fd];if(!d)throw Error("Unknown format descripter: "+fd);ff_idx[d[2]]=ff.length;ff.push(d[1]);return"("+d[0]+")"})+"\\s*$","i");var matched=str.match(re);if(!matched)return;var d=new Date(0);for(var i=0;i<ff_idx.length;i++){var idx=ff_idx[i];var fun=ff[idx];if(fun)fun(matched[idx+1])}return d};var utc_local={local:{getSeconds:function(d){return d.getSeconds()},getMinutes:function(d){return d.getMinutes()},getHours:function(d){return d.getHours()},getDay:function(d){return d.getDay()},getDate:function(d){return d.getDate()},getMonth:function(d){return d.getMonth()},getFullYear:function(d){return d.getFullYear()},getYearBegin:function(d){return new Date(d.getFullYear(),0,1)}},utc:{getSeconds:function(d){return d.getUTCSeconds()},getMinutes:function(d){return d.getUTCMinutes()},getHours:function(d){return d.getUTCHours()},getDay:function(d){return d.getUTCDay()},getDate:function(d){return d.getUTCDate()},getMonth:function(d){return d.getUTCMonth()},getFullYear:function(d){return d.getUTCFullYear()},getYearBegin:function(d){return new Date(Date.UTC(d.getUTCFullYear(),0,1))}}};E.strftime=function(fmt,d,opt){function hours12(hours){return hours==0?12:hours>12?hours-12:hours}function ord_str(n){var i=n%10,ii=n%100;if(ii>=11&&ii<=13||i==0||i>=4)return"th";switch(i){case 1:return"st";case 2:return"nd";case 3:return"rd"}}function week_num(l,d,first_weekday){var wday=l.getDay(d);if(first_weekday=="monday")wday=wday==0?wday=6:wday-1;var yday=(d-l.getYearBegin(d))/ms.DAY;return Math.floor((yday+7-wday)/7)}function padx(n,padding,length){if(typeof padding=="number"){length=padding;padding="0"}if(padding===undefined)padding="0";length=length||2;var s=""+n;if(padding)for(;s.length<length;s=padding+s);return s}opt=opt||{};d=E.get(d);var locale=opt.locale||E.locale;var formats=locale.formats||{};var tz=opt.timezone;var utc=opt.utc!==undefined?opt.utc:opt.local!==undefined?!opt.local:true;if(tz!=null){utc=true;if(typeof tz=="string"){var sign=tz[0]=="-"?-1:1;var hours=parseInt(tz.slice(1,3),10);var mins=parseInt(tz.slice(3,5),10);tz=sign*(60*hours+mins)}if(typeof tz=="number")d=new Date(+d+tz*6e4)}var l=utc?utc_local.utc:utc_local.local;function replace(fmt){return fmt.replace(/%([-_0]?.)/g,function(_,c){var mod,padding,day;if(c.length==2){mod=c[0];if(mod=="-")padding="";else if(mod=="_")padding=" ";else if(mod=="0")padding="0";else return _;c=c[1]}switch(c){case"A":return locale.days_long[l.getDay(d)];case"a":return locale.days_short[l.getDay(d)];case"B":return locale.months_long[l.getMonth(d)];case"b":return locale.months_short[l.getMonth(d)];case"C":return padx(Math.floor(l.getFullYear(d)/100),padding);case"D":return replace(formats.D||"%m/%d/%y");case"d":return padx(l.getDate(d),padding);case"e":return l.getDate(d);case"F":return replace(formats.F||"%Y-%m-%d");case"H":return padx(l.getHours(d),padding);case"h":return locale.months_short[l.getMonth(d)];case"I":return padx(hours12(l.getHours(d)),padding);case"j":day=Math.ceil((+d-l.getYearBegin(d))/(1e3*60*60*24));return pad(day,3);case"k":return padx(l.getHours(d),padding===undefined?" ":padding);case"L":return pad(Math.floor(d.getMilliseconds()),3);case"l":return padx(hours12(l.getHours(d)),padding===undefined?" ":padding);case"M":return padx(l.getMinutes(d),padding);case"m":return padx(l.getMonth(d)+1,padding);case"n":return"\n";case"o":return""+l.getDate(d)+ord_str(l.getDate(d));case"P":return(l.getHours(d)<12?locale.AM:locale.PM).toLowerCase();case"p":return l.getHours(d)<12?locale.AM:locale.PM;case"R":return replace(formats.R||"%H:%M");case"r":return replace(formats.r||"%I:%M:%S %p");case"S":return padx(l.getSeconds(d),padding);case"s":return Math.floor(+d/1e3);case"T":return replace(formats.T||"%H:%M:%S");case"t":return"	";case"U":return padx(week_num(l,d,"sunday"),padding);case"u":day=l.getDay(d);return day==0?7:day;case"v":return replace(formats.v||"%e-%b-%Y");case"W":return padx(week_num(l,d,"monday"),padding);case"w":return l.getDay(d);case"Y":return l.getFullYear(d);case"y":return(""+l.getFullYear(d)).slice(-2);case"Z":if(utc)return"GMT";var tz_string=d.toString().match(/\((\w+)\)/);return tz_string&&tz_string[1]||"";case"z":if(utc)return"+0000";var off=typeof tz=="number"?tz:-d.getTimezoneOffset();return(off<0?"-":"+")+pad(Math.abs(off/60),2)+pad(off%60,2);default:return c}})}return replace(fmt)};E.compile_schedule=function(expr){var re=/^(\d\d?)(?::(\d\d?))?-(\d\d?)(?::(\d\d?))?$/;var parts=expr.split(/\s+/);var intervals=[];for(var i=0;i<parts.length;i++){if(!parts[i])continue;var m=re.exec(parts[i]);if(!m)throw new Error("Schedule syntax error: "+expr);var from=m[1]*ms.HOUR,to=m[3]*ms.HOUR;if(m[2])from+=m[2]*ms.MIN;if(m[4])to+=m[4]*ms.MIN;intervals.push({from:from%ms.DAY,to:to%ms.DAY})}return function(d){var t=E.get(d)%ms.DAY;for(var i=0;i<intervals.length;i++){var interval=intervals[i];if(interval.from<interval.to){if(t>=interval.from&&t<interval.to)return true}else{if(t<interval.to||t>=interval.from)return true}}return false}};return E})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/sprintf.js",[],function(){var E=sprintf;E.sprintf=sprintf;var has=Object.prototype.hasOwnProperty;function sprintf(fmt){if(has.call(E.cache,fmt))return E.cache[fmt](arguments);E.cache[fmt]=E.parse(fmt);E.cache_n++;if(E.cache_cb)E.cache_cb(fmt);return E.cache[fmt](arguments)}E.cache={};E.cache_n=0;E.to_int=function(num){return(num=+num)>=0?Math.floor(num):-Math.floor(-num)};E.thousand_grouping=function(num_s){var m=/^([-+])?(\d*)(\.\d*)?$/.exec(num_s);if(!m)return num_s;m[2]=(m[2]||"").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+",");return(m[1]||"")+m[2]+(m[3]||"")};E.parse_fast=function(fmt){var _fmt=fmt,match=[],arg_names=0,cursor=1;var pad_chr,pad_chrs,arg_padded,f,s=JSON.stringify;f='var out = "", arg, arg_s, sign;\n';for(;_fmt;_fmt=_fmt.substring(match[0].length)){if(match=/^[^%]+/.exec(_fmt))f+="out += "+s(match[0])+";\n";else if(match=/^%%/.exec(_fmt))f+='out += "%";\n';else if(match=/^%(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?(')?([bcdefoOsuxX])/.exec(_fmt)){var positional=match[1],keyword=match[2],sign=match[3];var pad_zero=match[4],pad_min=match[5],pad_max=match[6];var precision=match[7],thousand_grouping=match[8]=="'";var conversion=match[9],keyword_list=[];if(keyword){arg_names|=1;var _keyword=keyword,kmatch;if(!(kmatch=/^([a-z_][a-z_\d]*)/i.exec(_keyword)))throw"sprintf: invalid keyword property name "+_keyword;keyword_list.push(kmatch[1]);while(_keyword=_keyword.substring(kmatch[0].length)){if(kmatch=/^\.([a-z_][a-z_\d]*)/i.exec(_keyword))keyword_list.push(kmatch[1]);else if(kmatch=/^\[(\d+)\]/.exec(_keyword))keyword_list.push(kmatch[1]);else throw"sprintf: invalid keyword format "+_keyword}}else arg_names|=2;if(arg_names===3){throw"sprintf: mixing positional and named placeholders is "+"not (yet) supported"}f+="sign = false;\n";if(keyword_list.length){f+="arg = argv["+cursor+"]";for(var k=0;k<keyword_list.length;k++)f+="["+s(keyword_list[k])+"]";f+=";\n"}else if(positional)f+="arg = argv["+positional+"];\n";else f+="arg = argv["+cursor++ +"];\n";if(/[^sO]/.test(conversion))f+="arg = +arg;\n";switch(conversion){case"b":f+="arg_s = arg.toString(2);\n";break;case"c":f+="arg_s = String.fromCharCode(arg);\n";break;case"d":f+='arg = sprintf.to_int(arg); arg_s = ""+arg;\n';if(thousand_grouping)f+="arg_s = sprintf.thousand_grouping(arg_s);\n";break;case"e":f+="arg_s = arg.toExponential("+(precision?s(precision):"")+");\n";break;case"f":if(precision)f+="arg_s = arg.toFixed("+precision+");\n";else f+='arg_s = ""+arg;\n';if(thousand_grouping)f+="arg_s = sprintf.thousand_grouping(arg_s);\n";break;case"o":f+="arg_s = arg.toString(8);\n";break;case"O":f+="arg_s = JSON.stringify(arg);\n";break;case"u":f+='arg = arg >>> 0; arg_s = ""+arg;\n';break;case"x":f+="arg_s = arg.toString(16);\n";break;case"X":f+="arg_s = arg.toString(16).toUpperCase();\n";break;case"s":f+='arg_s = ""+arg;\n';if(precision)f+="arg_s = arg_s.substring(0, "+precision+");\n";break}if(/[def]/.test(conversion)){if(sign)f+='if (arg>=0) arg_s = "+"+arg_s;\n';f+='sign = arg_s[0]=="-" || arg_s[0]=="+";\n'}pad_chr=!pad_zero?" ":pad_zero=="0"?"0":pad_zero[1];pad_chrs=s(pad_chr)+".repeat(Math.max("+ +pad_max+"-arg_s.length, 0))";arg_padded=!pad_max?"arg_s":pad_min?"arg_s+"+pad_chrs:/[def]/.test(conversion)&&pad_chr=="0"?"(sign ? arg_s[0]+"+pad_chrs+"+arg_s.slice(1) : "+pad_chrs+"+arg_s)":pad_chrs+"+arg_s";f+="out += "+arg_padded+";\n"}else throw"sprintf invalid format "+_fmt}f+="return out;\n";return new Function(["sprintf","argv"],f).bind(null,sprintf)};E.parse_slow=function(fmt){var _fmt=fmt,match=[],arg_names=0,cursor=1;var _f=[],out,arg,arg_s,argv,sign;function f(fn){_f.push(fn)}for(;_fmt;_fmt=_fmt.substring(match[0].length))(function(){if(match=/^[^%]+/.exec(_fmt)){var _match=match;f(function(){return out+=_match[0]})}else if(match=/^%%/.exec(_fmt))f(function(){return out+="%"});else if(match=/^%(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?(')?([bcdefoOsuxX])/.exec(_fmt)){var positional=match[1],keyword=match[2],sign=match[3];var pad_zero=match[4],pad_min=match[5],pad_max=match[6];var precision=match[7],thousand_grouping=match[8]=="'";var conversion=match[9],keyword_list=[],_cursor=cursor;if(keyword){arg_names|=1;var _keyword=keyword,kmatch;if(!(kmatch=/^([a-z_][a-z_\d]*)/i.exec(_keyword)))throw"sprintf: invalid keyword property name "+_keyword;keyword_list.push(kmatch[1]);while(_keyword=_keyword.substring(kmatch[0].length)){if(kmatch=/^\.([a-z_][a-z_\d]*)/i.exec(_keyword))keyword_list.push(kmatch[1]);else if(kmatch=/^\[(\d+)\]/.exec(_keyword))keyword_list.push(kmatch[1]);else throw"sprintf: invalid keyword format "+_keyword}}else arg_names|=2;if(arg_names===3){throw"sprintf: mixing positional and named placeholders is "+"not (yet) supported"}f(function(){sign=false});if(keyword_list.length){f(function(){arg=argv[_cursor];for(var k=0;k<keyword_list.length&&arg!=null;k++)arg=arg[keyword_list[k]]})}else if(positional)f(function(){arg=argv[positional]});else{f(function(){arg=argv[_cursor]});cursor++}if(/[^sO]/.test(conversion))f(function(){return arg=+arg});switch(conversion){case"b":f(function(){arg_s=arg.toString(2)});break;case"c":f(function(){arg_s=String.fromCharCode(arg)});break;case"d":f(function(){arg=sprintf.to_int(arg);arg_s=""+arg});if(thousand_grouping)f(function(){arg_s=sprintf.thousand_grouping(arg_s)});break;case"e":f(function(){arg_s=arg.toExponential(precision?precision:undefined)});break;case"f":if(precision)f(function(){arg_s=arg.toFixed(precision)});else f(function(){arg_s=""+arg});if(thousand_grouping)f(function(){arg_s=sprintf.thousand_grouping(arg_s)});break;case"o":f(function(){arg_s=arg.toString(8)});break;case"O":f(function(){arg_s=JSON.stringify(arg)});break;case"u":f(function(){arg=arg>>>0;arg_s=""+arg});break;case"x":f(function(){arg_s=arg.toString(16)});break;case"X":f(function(){arg_s=arg.toString(16).toUpperCase()});break;case"s":f(function(){arg_s=""+arg});if(precision)f(function(){arg_s=arg_s.substring(0,precision)});break}if(/[def]/.test(conversion)){if(sign)f(function(){if(arg>=0)arg_s="+"+arg_s});f(function(){sign=arg_s[0]=="-"||arg_s[0]=="+"})}var pad_chr=!pad_zero?" ":pad_zero=="0"?"0":pad_zero[1];f(function(){var pad_chrs=pad_chr.repeat(Math.max(+pad_max-arg_s.length,0));var arg_padded=!pad_max?arg_s:pad_min?arg_s+pad_chrs:sign&&pad_chr[0]=="0"?arg_s[0]+pad_chrs+arg_s.slice(1):pad_chrs+arg_s;out+=arg_padded})}else throw"sprintf invalid format "+_fmt})();return function(_argv){argv=_argv;out="";for(var i=0;i<_f.length;i++)_f[i](argv);return out}};E.parse=function(){try{if(new Function("return 1")()==1)return E.parse_fast}catch(e){}return E.parse_slow}();E.vsprintf=function(fmt,argv,opt){if(opt){if(opt.fast)return E.parse_fast(fmt)([fmt].concat(argv));if(opt.slow)return E.parse_slow(fmt)([fmt].concat(argv))}return E.sprintf.apply(null,[fmt].concat(argv))};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;if(!is_node)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/rate_limit.js",[],function(){var E=rate_limit;function rate_limit(rl,ms,n){var now=Date.now();if(!rl.count||rl.ts+ms<now){rl.count=1;rl.ts=now;return true}rl.count++;return rl.count<=n}E.leaky_bucket=function leaky_bucket(size,rate){this.size=size;this.rate=rate;this.time=Date.now();this.level=0};E.leaky_bucket.prototype.inc=function(inc){if(inc===undefined)inc=1;var now=Date.now();this.level-=this.rate*(now-this.time);this.time=now;if(this.level<0)this.level=0;var new_level=this.level+inc;if(new_level>this.size)return false;this.level=new_level;return true};return E})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/escape.js",[],function(){var E={};E.un={};var html_escape_table={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};E.html=function(html){return html.replace(/[&<>"']/g,function(m){return html_escape_table[m[0]]})};E.sh=function(s_or_a){function single(s){s=""+s;if(!s)return'""';if(/^[a-z0-9_\-.\/:]+$/i.test(s))return s;return'"'+s.replace(/([\\"`$])/g,"\\$1")+'"'}if(arguments.length==1&&!Array.isArray(s_or_a))return single(s_or_a);var s="",a=Array.isArray(s_or_a)?s_or_a:arguments;for(var i=0;i<a.length;i++)s+=(i?" ":"")+single(a[i]);return s};E.un_sh=function(s,keep_esc){var state={PARSE_STATE_INIT:0,PARSE_STATE_NORMAL_ARG:1,PARSE_STATE_QUOTE_ARG:2},cur_state=state.PARSE_STATE_INIT;var i,quote=0,argv=[],a="";for(i=0;i<s.length;i++){var esc=0;a+=s[i];if(s[i]=="\\"&&s[1]){if(!keep_esc)a=a.slice(0,-1);esc=1;i++;a+=s[i]}switch(cur_state){case state.PARSE_STATE_INIT:switch(s[i]){case"\r":case"\n":case" ":case"	":if(!esc){a="";break}case'"':case"'":if(!esc){cur_state=state.PARSE_STATE_QUOTE_ARG;if(!keep_esc)a=a.slice(0,-1);quote=s[i];break}default:cur_state=state.PARSE_STATE_NORMAL_ARG}break;case state.PARSE_STATE_NORMAL_ARG:switch(s[i]){case"\r":case"\n":case" ":case"	":if(!esc){cur_state=state.PARSE_STATE_INIT;a=a.slice(0,-1);argv.push(a);a=""}break;case'"':case"'":if(!esc){cur_state=state.PARSE_STATE_QUOTE_ARG;quote=s[i];if(!keep_esc)a=a.slice(0,-1)}break}break;case state.PARSE_STATE_QUOTE_ARG:if(s[i]==quote&&!esc){cur_state=state.PARSE_STATE_NORMAL_ARG;if(!keep_esc)a=a.slice(0,-1)}break}}if(cur_state==state.PARSE_STATE_NORMAL_ARG){cur_state=state.PARSE_STATE_INIT;argv.push(a)}if(cur_state!=state.PARSE_STATE_INIT)throw"error parsing shell";return argv};E.regex=function(s){return s.replace(/[[\]{}()*+?.\\^$|\/]/g,"\\$&")};E.uri_comp=function(s){return encodeURIComponent(s).replace(/%20/g,"+")};var http_escape_chars=[];(function(){var i;for(i=0;i<256;i++){var c=String.fromCharCode(i);http_escape_chars[i]=/^[a-zA-Z0-9_.~,\-]$/.test(c)?c:"%"+("0"+i.toString(16)).slice(-2)}})();E.encodeURIComponent_bin=function(s_or_b){var s=Buffer&&s_or_b instanceof Buffer?s_or_b.toString("binary"):""+s_or_b;var esc="";for(var i=0;i<s.length;i++)esc+=http_escape_chars[s.charCodeAt(i)];return esc};E.qs=function(param,opt){opt=opt||{};var qs=opt.qs||"";var sep=qs||opt.amp?"&":"";if(!param)return qs;var uri_comp=opt.space_plus===undefined||opt.space_plus?E.uri_comp:encodeURIComponent;var uri_comp_val=opt.bin?E.encodeURIComponent_bin:uri_comp;for(var i in param){var val=param[i];if(val===undefined)continue;var key=uri_comp(i);qs+=sep;if(val===null)qs+=key;else if(Array.isArray(val)){if(!val.length)continue;qs+=val.map(function(val){return key+"="+uri_comp_val(val)}).join("&")}else qs+=key+"="+uri_comp_val(val);sep="&"}return qs};E.uri=function(uri,qs,hash){var opt;if(typeof uri=="string")opt={uri:uri,_qs:qs,hash:hash};else{opt=Object.assign({},uri);opt._qs=opt.qs;opt.qs=undefined}uri=opt.uri;qs=typeof opt._qs=="string"?opt._qs:E.qs(opt._qs,opt);hash=typeof opt.hash=="string"?opt.hash:E.qs(opt.hash,opt);if(qs){if(!uri.includes("?"))uri+="?";else if(uri[uri.length-1]!="?"&&uri[uri.length-1]!="&")uri+="&"}else qs="";if(hash)hash="#"+hash;else hash="";return uri+qs+hash};E.mailto_url=function(mail){return"mailto:"+(mail.to||"")+"?"+E.qs({cc:mail.cc,bcc:mail.bcc,subject:mail.subject,body:mail.body},{space_plus:false})};E.parse={};E.parse.eat_token=function(s_obj,re){var match;if(!(match=re.exec(s_obj.s)))return match;s_obj.s=s_obj.s.substr(match.index+match[0].length);return match};E.parse.http_words=function(val){var res=[],o={s:val},eat_token=E.parse.eat_token,match;while(o.s){if(match=eat_token(o,/^\s*(=*[^\s=;,]+)/)){var v=match[1];if(match=eat_token(o,/^\s*=\s*\"([^\"\\]*(?:\\.[^\"\\]*)*)\"/))res.push([v,match[1].replace(/\\(.)/,"$1")]);else if(match=eat_token(o,/^\s*=\s*([^;,\s]*)/))res.push([v,match[1].replace(/\s+$/,"")]);else res.push([v,null])}else if(match=eat_token(o,/^\s*,/));else if((match=eat_token(o,/^\s*;/))||(match=eat_token(o,/^\s+/)));else throw new Error("This should not happen: "+o.s)}return res};return E})})();
(function(){var __hola_stub_define,process;var is_node=typeof module=="object"&&module.exports&&module.children;var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");if(!is_node&&!is_ff_addon){define=define||self.define;process={env:{}}}else{define=require("./require_node.js").define(module,"../");if(is_ff_addon)process={env:{}};else if(is_node){process=global.process||require("_process");require("./config.js");var cluster=require("cluster");var version=require("./version.js").version}}define("/util/zerr.js",["/util/array.js","/util/date.js","/util/util.js","/util/sprintf.js","/util/rate_limit.js","/util/escape.js"],function(array,date,zutil,sprintf,rate_limit,zescape){var E,_zerr;var env=process.env;var zerr=function(msg){_zerr(L.ERR,arguments)};E=zerr;E.zerr=zerr;var L=E.L={EMERG:0,ALERT:1,CRIT:2,ERR:3,WARN:4,NOTICE:5,INFO:6,DEBUG:7};var perr_pending=[];var LINV=E.LINV={};for(var k in L)LINV[L[k]]=k;["debug","info","notice","warn","err","crit"].forEach(function(l){var level=L[l.toUpperCase()];E[l]=function(){return _zerr(level,arguments)}});E.assert=function(exp,msg){if(!exp)zerr.crit(msg)};E.json=function(o,replacer,space){try{return JSON.stringify(o,replacer,space)||""}catch(e){return"[circular]"}};E.is=function(level){return level<=E.level};["debug","info","notice","warn","err"].forEach(function(l){var level=L[l.toUpperCase()];E.is[l]=function(){return level<=E.level}});E.log_tail=function(size){return E.log.join("\n").substr(-(size||4096))};E.perr=function(id,info,opt){E._zerr(!opt||opt.level===undefined?L.ERR:opt.level,["perr "+id+" "+E.json(info)]);if(perr_pending&&perr_pending.length<100)perr_pending.push(Array.from(arguments))};var perr_dropped={};var perr_orig=E.perr;function wrap_perr(perr_fn){var send=perr_fn,pre_send;if(typeof perr_fn!="function"){send=perr_fn.send;pre_send=perr_fn.pre_send}return function(id,info,opt){opt=opt||{};var ms=opt.rate_limit&&opt.rate_limit.ms||date.ms.HOUR;var count=opt.rate_limit&&opt.rate_limit.count||10;var rl_hash=perr_orig.rl_hash=perr_orig.rl_hash||{};var rl=rl_hash[id]=rl_hash[id]||{};if(pre_send)pre_send(id,info,opt);if(opt.rate_limit===false||rate_limit(rl,ms,count)){if(perr_dropped[id]){if(info&&typeof info!="string")info.w=perr_dropped[id];perr_dropped[id]=null}return send(id,info,opt)}perr_dropped[id]=(perr_dropped[id]||0)+1;if(info&&typeof info!="string")info=zerr.json(info);zerr("perr %s %s rate too high %s %d %d",id,info,zerr.json(rl),ms,count)}}E.perr_install=function(install_fn){E.perr=wrap_perr(install_fn(perr_orig,perr_pending||[]));perr_pending=null};function err_has_stack(err){return err instanceof Error&&err.stack}E.e2s=function(err){if(!is_node&&err_has_stack(err)){var e_str=""+err,e_stack=""+err.stack;return e_stack.startsWith(e_str)?e_stack:e_str+" "+e_stack}return err_has_stack(err)?""+err.stack:""+err};E.on_exception=undefined;var in_exception;E.set_exception_handler=function(prefix,err_func){E.on_exception=function(err){if(!(err instanceof TypeError||err instanceof ReferenceError)||err.sent_perr){return}if(in_exception)return;in_exception=1;err.sent_perr=true;err_func((prefix?prefix+"_":"")+"etask_typeerror",null,err);in_exception=0}};E.on_unhandled_exception=undefined;E.catch_unhandled_exception=function(func,obj){return function(){var args=arguments;try{return func.apply(obj,Array.from(args))}catch(e){E.on_unhandled_exception(e)}}};if(is_node){E.ZEXIT_LOG_DIR="/tmp/zexit_logs";E.prefix="";E.level=L.NOTICE;E.set_level=function(level){var prev="L"+LINV[E.level];level=level||env.ZERR;if(!level)return prev;var val=L[level]||L[level.replace(/^L/,"")];if(val!==undefined)E.level=val;return prev};E.flush=function(){};E.set_log_buffer=function(on){if(!on){if(E.log_buffer){E.flush();E.log_buffer(0)}return}E.log_buffer=require("log-buffer");E.log_buffer(32*1024);E.flush=function(){E.log_buffer.flush()};setInterval(E.flush,1e3).unref()};var node_init=function(){if(zutil.is_mocha())E.level=L.WARN;else E.prefix=!cluster.isMaster?"C"+cluster.worker.id+" ":""};var init=function(){if(is_node)node_init();E.set_level()};init();var zerr_format=function(args){return args.length<=1?args[0]:sprintf.apply(null,args)};var __zerr=function(level,args){var msg=zerr_format(args);var k=Object.keys(L);var prefix=E.hide_timestamp?"":E.prefix+date.to_sql_ms()+" ";console.error(prefix+k[level]+": "+msg)};E.set_logger=function(logger){__zerr=function(level,args){var msg=zerr_format(args);logger(level,msg)}};_zerr=function(level,args){if(level>E.level)return;__zerr(level,args)};E._zerr=_zerr;E.zexit=function(args){var stack;if(err_has_stack(args)){stack=args.stack;__zerr(L.CRIT,[E.e2s(args)])}else{var e=new Error;stack=e.stack;__zerr(L.CRIT,arguments);console.error(stack)}E.flush();if(zutil.is_mocha()){debugger;process.exit(1)}var conf=require("./conf.js");var zcounter_file=require("./zcounter_file.js");zcounter_file.inc("server_zexit");args=zerr_format(arguments);write_zexit_log({id:"server_zexit",info:""+args,ts:date.to_sql(),backtrace:stack,version:version,app:conf.app});E.flush();debugger;process.exit(1)};var write_zexit_log=function(json){try{var file=require("./file.js");file.write_e(E.ZEXIT_LOG_DIR+"/"+date.to_log_file()+"_zexit_"+process.pid+".log",E.json(json),{mkdirp:1})}catch(e){E.zerr(E.e2s(e))}}}else{var chrome=self.chrome;E.conf=self.conf;E.log=[];var L_STR=E.L_STR=["EMERGENCY","ALERT","CRITICAL","ERROR","WARNING","NOTICE","INFO","DEBUG"];E.level=self.is_tpopup?L.CRITICAL:E.conf&&E.conf.zerr_level?L[self.conf.zerr_level]:L.WARN;E.log.max_size=200;var console_method=function(l){return l<=L.ERR?"error":!chrome?"log":l===L.WARN?"warn":l<=L.INFO?"info":"debug"};_zerr=function(l,args){var s;try{var fmt=""+args[0];var fmt_args=Array.prototype.slice.call(args,1);s=(fmt+(fmt_args.length?" "+E.json(fmt_args):"")).substr(0,1024);var prefix=date.to_sql_ms()+" "+L_STR[l]+": ";E.log.push(prefix+s);if(E.is(l)){Function.prototype.apply.bind(console[console_method(l)],console)([prefix+fmt].concat(fmt_args))}if(E.log.length>E.log.max_size)E.log.splice(0,E.log.length-E.log.max_size/2)}catch(err){try{console.error("ERROR in zerr "+(err.stack||err),arguments)}catch(e){}}if(l<=L.CRIT)throw new Error(s)};E._zerr=_zerr;var post=function(url,data){var use_xdr=typeof XDomainRequest=="function"&&!("withCredentials"in XMLHttpRequest.prototype);var req=use_xdr?new XDomainRequest:new XMLHttpRequest;req.open("POST",url);if(req.setRequestHeader){req.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")}req.send(zescape.qs(data))};var perr_transport=function(id,info,opt){opt=zutil.clone(opt||{});var qs=opt.qs||{},data=opt.data||{};data.is_json=1;if(info&&typeof info!="string")info=zerr.json(info);if(opt.err&&!info)info=""+(opt.err.message||zerr.json(opt.err));data.info=info;qs.id=id;if(!opt.no_zerr){zerr._zerr(opt.level,["perr "+id+(info?" info: "+info:"")+(opt.bt?"\n"+opt.bt:"")])}return post(zescape.uri(E.conf.url_perr+"/perr",qs),data)};var perr=function(perr_orig,pending){while(pending.length)perr_transport.apply(null,pending.shift());return perr_transport};E.perr_install(perr)}return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;if(!is_node)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/ajax_lite.js",["/util/etask.js","/util/date.js","/util/zerr.js","/util/escape.js","events"],function(etask,date,zerr,zescape,events){var E=ajax;var assign=Object.assign;E.json=function(opt){return ajax(assign({},opt,{data_type:"json"}))};E.events=new events.EventEmitter;E.t={};E.t.get_origin=get_origin;E.t.get_url_origin=get_url_origin;E.t.is_current_origin=is_current_origin;var raw_default_opt={method:"GET",url:null,headers:null,data_type:"text",data:null,qs:null,timeout:20*date.ms.SEC,with_credentials:false,return_headers:false};var ajax_default_opt={slow:2*date.ms.SEC,perr:null};var type_helpers={text:{setup:function(xhr){if(xhr instanceof XMLHttpRequest){xhr.setRequestHeader("Accept","text/*");xhr.responseType="text"}},extract:function(xhr){return xhr.responseText}},json:{setup:function(xhr){if(xhr instanceof XMLHttpRequest){xhr.setRequestHeader("Accept","application/json");xhr.responseType="text"}},extract:function(xhr){return JSON.parse(xhr.responseText)}}};function get_origin(location){if(location.origin)return location.origin;var default_ports={"http:":80,"https:":443};var port=location.port;if(default_ports[location.protocol]==port)port=null;return location.protocol+"//"+location.hostname+(port?":"+port:"")}var probe_link;function get_url_origin(url){probe_link=probe_link||document.createElement("a");probe_link.href=url;probe_link.href=probe_link.href;return get_origin(probe_link)}function is_current_origin(url){return is_node?false:window.location.origin==get_url_origin(url)}var can_use_xdr=typeof XDomainRequest=="function"&&!("withCredentials"in XMLHttpRequest.prototype);E.raw=function(opt){return etask([function(){opt=assign({},raw_default_opt,opt);var type_helper=type_helpers[opt.data_type];if(!type_helper){throw{status:null,status_text:"Unknown data_type "+opt.data_type,response_text:null}}var req=can_use_xdr&&!is_current_origin(opt.url)?new XDomainRequest:new XMLHttpRequest;var url=zescape.uri(opt.url,opt.qs);var wait=this.wait();if(opt.timeout){this.alarm(opt.timeout,function(){req.abort();wait.throw({status:null,status_text:"timeout",response_text:null})})}req.open(opt.method,url);type_helper.setup(req);if(opt.headers&&req.setRequestHeader){for(var header in opt.headers)req.setRequestHeader(header,opt.headers[header])}if(opt.with_credentials&&"withCredentials"in req)req.withCredentials=true;req.onload=function(){var status=req.status||200;if(status==1223)status=204;if(status>=200&&status<300){var res=type_helper.extract(req);if(opt.return_headers){return wait.continue({res:res,headers:req.getAllResponseHeaders?req.getAllResponseHeaders():""})}return wait.continue(res)}return wait.throw({status:status,status_text:req.statusText,response_text:req.responseText})};req.onerror=function(){wait.throw({status:req.status,status_text:req.statusText,response_text:req.responseText})};this.finally(function(){req.onload=req.onerror=null});var data=opt.data;if(data!=null){switch(typeof data){case"object":data=zescape.qs(data);break;case"string":data=zescape.uri_comp(data);break;default:data=data+""}if(req.setRequestHeader){req.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")}}req.send(data);return wait}])};function ajax(opt){opt=assign({},raw_default_opt,ajax_default_opt,opt);var t0=Date.now();var url=zescape.uri(opt.url,opt.qs);zerr.debug("ajax("+opt.data_type+") url "+url);return etask([function(){return E.raw(opt)},function catch$(err){zerr.err("ajax("+opt.data_type+") failed url "+url+" data "+zerr.json(opt.data).substr(0,200)+" status: "+err.status+" "+err.status_text+"\nresponseText: "+(err.response_text||"").substr(0,200));if(err.status_text=="timeout")E.events.emit("timeout",this);throw err},function(response){var t=Date.now()-t0,slow=t>opt.slow;zerr[slow?"err":"debug"]("ajax("+opt.data_type+") "+(slow?"SLOW ":"ok ")+t+"ms url "+url);if(slow&&opt.perr)opt.perr({id:"be_ajax_slow",info:t+"ms "+url});return response}])}return E})})();
!function(e){if("function"==typeof define&&define.amd)define("cookie",e);else if("object"==typeof exports)module.exports=e();else{var n=window.Cookies,o=window.Cookies=e();o.noConflict=function(){return window.Cookies=n,o}}}(function(){function e(){for(var e=0,n={};e<arguments.length;e++){var o=arguments[e];for(var t in o)n[t]=o[t]}return n}function n(o){function t(n,i,r){var c;if("undefined"!=typeof document){if(arguments.length>1){if("number"==typeof(r=e({path:"/"},t.defaults,r)).expires){var s=new Date;s.setMilliseconds(s.getMilliseconds()+864e5*r.expires),r.expires=s}try{c=JSON.stringify(i),/^[\{\[]/.test(c)&&(i=c)}catch(e){}return i=o.write?o.write(i,n):encodeURIComponent(String(i)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",i,r.expires&&"; expires="+r.expires.toUTCString(),r.path&&"; path="+r.path,r.domain&&"; domain="+r.domain,r.secure?"; secure":""].join("")}n||(c={});for(var a=document.cookie?document.cookie.split("; "):[],p=/(%[0-9A-Z]{2})+/g,d=0;d<a.length;d++){var f=a[d].split("="),u=f[0].replace(p,decodeURIComponent),l=f.slice(1).join("=");'"'===l.charAt(0)&&(l=l.slice(1,-1));try{if(l=o.read?o.read(l,u):o(l,u)||l.replace(p,decodeURIComponent),this.json)try{l=JSON.parse(l)}catch(e){}if(n===u){c=l;break}n||(c[u]=l)}catch(e){}}return c}}return t.set=t,t.get=function(e){return t(e)},t.getJSON=function(){return t.apply({json:!0},[].slice.call(arguments))},t.defaults={},t.remove=function(n,o){t(n,"",e(o,{expires:-1}))},t.withConverter=n,t}return n(function(){})});
define("/util/storage.js",["cookie"],function(cookie){var E={};var storage;function have_local_storage(){try{var _=localStorage;return true}catch(e){}}function select_local_storage(){storage=localStorage}function select_cookies(domain){var cookie_opt={domain:"."+domain,path:"/",expires:30};storage={getItem:cookie.get,setItem:function(key,val){cookie.set(key,val,cookie_opt)},removeItem:function(key){cookie.remove(key,cookie_opt)}}}E.init=function(domain){if(have_local_storage())return select_local_storage();console.error("cannot use localStorage, using cookies instead");select_cookies(domain||"hola.org")};E.init();E.on_err=function(){};E.set=function(key,val){try{storage.setItem(key,val)}catch(err){E.on_err("storage_set",key,err)}};E.get=function(key){try{return storage.getItem(key)}catch(err){E.on_err("storage_get",key,err)}};E.get_int=function(key){return+E.get(key)||0};E.clr=function(key){try{storage.removeItem(key)}catch(err){E.on_err("storage_clr",key,err)}};E.set_json=function(key,val){try{return E.set(key,JSON.stringify(val||null))}catch(err){E.on_err("storage_set_json",key,err)}};E.get_json=function(key){var val=E.get(key);if(!val)return val;try{val=JSON.parse(val)}catch(err){console.log("err "+err)}return val};return E});
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=function(setup){module.exports=setup()};define("/util/user_agent.js",[],function(){var E={};var win_versions={"10.0":"10.0",6.3:"8.1",6.2:"8",6.1:"7","6.0":"vista",5.2:"2003",5.1:"xp","5.0":"2000"};var arch_mapping={x86_64:"64",i686:"32",arm:"arm"};var check_hola=/\bhola_android\b/i;var check_android_cdn=/Android.* CDNService\/([0-9\.]+)$/;var check_ios_cdn=/ CDNService\/([0-9\.]+)$/;var check_opera=/\bOPR\b\/(\d+)/i;var check_edge=/\bEdge\b\/(\d+)/i;var check_xbox=/\bxbox\b/i;var check_ucbrowser=/\bUCBrowser\b\/(\d+)/i;var check_webview=/ Version\/(\d+)(\.\d)/;var is_browser=!is_node_ff&&typeof window!="undefined";function ios_ua(ua,safari_ver){var res;if(res=/(?:iPhone|iPad|iPod|iPod touch);.*?OS ([\d._]+)/.exec(ua)){var ios_ver=res[1];return{browser:"safari",version:safari_ver||ios_ver,ios:ios_ver,hola_ios:is_browser&&window.hola_cdn_sdk||check_ios_cdn.test(ua)}}if(/HolaCDN iOS/.exec(ua))return{browser:"safari",hola_ios:true}}function check_chromium(ua){if(check_webview.test(ua)||/Android/.test(ua)||/ Mobile /.test(ua)||check_opera.test(ua)){return false}var group="(?: (\\w*)\\/)?",ver="\\/[\\d\\.]+";var res=new RegExp("AppleWebKit"+ver+"(?: \\(.*\\))?"+group+".* Chrome"+ver+group+".* Safari"+ver+group).exec(ua);return res&&(res[1]||res[2]||res[3])}E.guess_browser=function(ua){var res;ua=ua||(is_browser?window.navigator&&navigator.userAgent:"");if(res=/\bOpera Mini\/(\d+)/.exec(ua))return{browser:"opera_mini",version:res[1]};var ucbrowser=check_ucbrowser.exec(ua);if(res=/[( ]MSIE ([6789]|10).\d[);]/.exec(ua))return{browser:"ie",version:res[1],xbox:check_xbox.test(ua)};if(res=/[( ]Trident\/\d+(\.\d)+.*rv:(\d\d)(\.\d)+[);]/.exec(ua))return{browser:"ie",version:res[2],xbox:check_xbox.test(ua)};if(res=/ Chrome\/(\d+)(\.\d+)+.* Safari\/\d+(\.\d+)+/.exec(ua)){var opera=check_opera.exec(ua);var edge;if(edge=check_edge.exec(ua))return{browser:"edge",version:edge[1]};return{browser:"chrome",version:res[1],android:ua.match(/Android/),webview:ua.match(check_webview),hola_android:check_hola.test(ua),hola_app:check_android_cdn.test(ua),chromium_based:check_chromium(ua),opera:opera&&!!opera[1],opera_version:opera?opera[1]:undefined,ucbrowser:ucbrowser&&!!ucbrowser[1],ucbrowser_version:ucbrowser?ucbrowser[1]:undefined,webos_app:/Web0S/.test(ua)}}if(res=/ QupZilla\/(\d+\.\d+\.\d+).* Safari\/\d+.\d+/.exec(ua))return{browser:"qupzilla",version:res[1]};if(res=/\(PlayStation (\d+) (\d+\.\d+)\).* AppleWebKit\/\d+.\d+/.exec(ua)){return{browser:"playstation"+res[1],version:res[2]}}if(res=/ Version\/(\d+)(\.\d)+.* Safari\/\d+.\d+/.exec(ua)){if(!ua.match(/Android/))return ios_ua(ua,res[1])||{browser:"safari",version:res[1]};return{browser:"chrome",version:res[1],android:true,webview:true,hola_android:check_hola.test(ua),hola_app:check_android_cdn.test(ua),ucbrowser:ucbrowser&&!!ucbrowser[1],ucbrowser_version:ucbrowser?ucbrowser[1]:undefined}}if(res=/ (Firefox|PaleMoon)\/(\d+).\d/.exec(ua)){return{browser:"firefox",version:res[2],palemoon:res[1]=="PaleMoon"}}if(/Hola\/\d+\.\d+.*?(?:iPhone|iPad|iPod)/.exec(ua))return{browser:"safari",version:"Hola"};if(res=ios_ua(ua))return res;return{}};E.browser_to_string=function(browser){if(typeof browser!="object"||!browser.browser)return"unknown";var s=browser.browser=="ie"&&browser.version>11?"edge":browser.browser;if(browser.version)s+=" "+browser.version;if(browser.xbox)s+=" xbox";if(browser.android)s+=" android";if(browser.webview)s+=" webview";if(browser.chromium_based)s+=" chromium_based";if(browser.opera){s+=" opera";if(browser.opera_version)s+="-"+browser.opera_version}if(browser.hola_android)s+=" hola_android";if(browser.hola_app)s+=" hola_app";if(browser.ucbrowser){s+=" ucbrowser";if(browser.ucbrowser_version)s+="-"+browser.ucbrowser_version}if(browser.palemoon)s+=" palemoon";if(browser.ios)s+=" ios";if(browser.webos_app)s+=" webos_app";return s?s:"unknown"};E.guess=function(ua,platform){var res;ua=ua||(is_browser?navigator.userAgent:"");platform=platform||(is_browser?navigator.platform:"");if(check_xbox.exec(ua))return{os:"xbox",mobile:false};if(res=/Windows(?: NT(?: (.*?))?)?[);]/.exec(ua)){return{os:"windows",version:win_versions[res[1]],release_version:res[1],arch:ua.match(/WOW64|Win64|x64/)?"64":"32",mobile:false}}if(/Windows Phone/.exec(ua))return{os:"winphone",mobile:true};if(res=/Macintosh.*; (?:Intel|PPC) Mac OS X (\d+[._]\d+)/.exec(ua))return{os:"macos",version:res[1].replace("_","."),mobile:false};if(/Macintosh/.exec(ua))return{os:"macos",mobile:false};if(/Web0S.*SmartTV/.exec(ua)){return{os:"webos",version:/Chrome/.test(ua)?"3":"2",mobile:false,tv:true}}if(res=/(Android|Andr0id)(?: (\d+\.\d+))?/.exec(ua))return{os:"android",version:res[2],mobile:true};if(res=/(Linux|CrOS|OpenBSD|FreeBSD)(?: (x86_64|i686|arm))?/.exec(ua)){if(check_opera.test(ua)&&res[1]=="Linux"&&res[2]=="x86_64"&&/^Linux arm/.test(platform)){return{os:"android",mobile:true}}return{os:res[1].toLowerCase(),arch:arch_mapping[res[2]],nix:true,mobile:false}}if(res=/(?:iPhone|iPad|iPod|iPod touch);.*?OS (\d+[._]\d+)/.exec(ua))return{os:"ios",version:res[1].replace("_","."),mobile:true};if(/iPhone|iPad|iPod|HolaCDN iOS/.exec(ua))return{os:"ios",mobile:true};if(/PLAYSTATION/.exec(ua))return{os:"ps",mobile:false};if(/HitLeap Viewer/.exec(ua))return{os:"windows",mobile:false};return{}};E.guess_device=function(ua){var res;ua=ua||(is_browser?navigator.userAgent:"");if(res=/(iPhone|iPad|iPod)/.exec(ua))return{device:res[1].toLowerCase()};return{}};E.support_fullscreen=function(){return!!(is_browser&&typeof document!="undefined"&&(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled))};E.support_hover=function(){if(!is_browser)return false;if(window.matchMedia&&window.matchMedia("(hover: hover)").matches)return true;return!E.guess().mobile};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else define=require("../../../util/require_node.js").define(module,"../");define("/svc/cdn/pub/log.js",["/util/storage.js","/util/date.js","/util/array.js","/util/util.js","/util/zerr.js","/util/etask.js","/util/sprintf.js"],function(storage,date,array,zutil,zerr,etask,sprintf){var E=log_cdn;var assign=Object.assign;E.type="cdn";zerr.set_exception_handler("cdn",function(id,info,err){E.err("exception "+id+" "+(err.stack||err));E.perr({id:id,info:""+err,bt:err.stack})});etask.set_zerr(zerr);function log_cdn(){var s;try{var args=[].slice.call(arguments);var opt={};if(typeof args[args.length-1]=="object")opt=args.pop();s=args.length>1?sprintf.apply(null,args):args[0];log(E.type,s,opt);if(opt.perr_id&&E.perr)E.perr({id:opt.perr_id,info:s})}catch(e){console.error("error in log_cdn",E.type,s,e);if(E.perr)E.perr({id:"log_cdn_err",info:s,bt:e.stack})}}function extend_opt(def_opt){if(def_opt.muted)return;var args=[].slice.call(arguments,1);var opt={};if(typeof args[args.length-1]=="object")opt=assign({},args.pop());log_cdn.apply(this,args.concat(assign(opt,def_opt)))}var log_levels={no:0,crit:1,err:2,warn:3,notice:4,info:5,debug:6};function log_level_handler(opt,level){var level_opt=level=="console"?{console_log:true,level:"info"}:{level:level};return extend_opt.bind(E,assign({},opt,level_opt))}function Journal(opt){if(!(this instanceof Journal))return new Journal(opt);opt=opt||{logs:[]};assign(this,{crit:log_level_handler(opt,"crit"),err:log_level_handler(opt,"err"),warn:log_level_handler(opt,"warn"),notice:log_level_handler(opt,"notice"),info:log_level_handler(opt,"info"),debug:log_level_handler(opt,"debug"),console:log_level_handler(opt,"console"),set_module:function(module){return new Journal(assign({},opt,{module:module}))},reset_module:function(){return this.set_module(null)},mute:function(){return new Journal(assign({},opt,{muted:true}))},unmute:function(){return new Journal(assign({},opt,{muted:false}))},get_logs:function(){return opt.logs},reset_logs:function(){opt.logs.splice(0,opt.logs.length)},logs_to_str:function(logs,full_log){return logs_to_str(logs||opt.logs,full_log)},concat:function(logs,need_sort){return logs_concat(opt.logs,logs,need_sort)},fork:function(id){return new Journal(assign({},opt,{id:id,logs:opt.logs.slice()}))},stash:function(){var stash=opt.logs.slice();return function(){zutil.clone_inplace(opt.logs,stash)}},uninit:function(){this.reset_logs()}})}assign(E,new Journal);E.settings_def=function(){return{log_level:"notice",max_size:2048,max_full_history_size:8192}};E.settings=E.settings_def();E.init=function(opt){E.settings=assign({},E.settings_def(),zutil.clone_deep(opt),storage.get_json("hola_log_settings"))};E.set=function(o,no_storage){if(!no_storage)storage.set_json("hola_log_settings",o);E.settings=assign({},E.settings_def(),zutil.clone_deep(o))};E.reset=function(clear_storage){E.set(E.settings_def(),true);storage.clr("hola_log_settings");E.console("log reset to defaults, customer settings to be re-applied "+"after page reload")};E.log_is=function(level){return log_levels[E.settings.log_level]>=log_levels[level]};E.full_history=[];function pad(num,size){return E.zmocha_pad||("000"+num).slice(-size)}function log(type,s,opt){opt=opt||{};var logs=opt.logs||E.get_logs();var msg=type+(opt.module?"/"+opt.module:"")+": "+s;var slevel=opt.level||"debug";var level=log_levels[slevel];var set_level=log_levels[E.settings.log_level||"notice"];var print=false;if(opt.console_log&&set_level>0)print=true;else if(level<=set_level){var mods=E.settings.log_modules;if(!opt.module||!mods)print=true;else if(mods&&(mods.includes(opt.module)||mods.includes("*")))print=true}var d=zutil.is_mocha()?E.zmocha_date||new Date:new Date;var _msg=date.to_sql_ms(d)+" ["+(opt.id||0)+"] "+msg;if(print){var l=E.level_to_console(slevel);if(zutil.is_mocha()&&E.zmocha_test_log){E.zmocha_console=E.zmocha_console||[];E.zmocha_console.push(l+" "+_msg)}else console[l](_msg)}E.full_history.push(_msg);if(level<=Math.max(log_levels.info,set_level))logs.push(date.to_log_ms(d)+pad(logs.length,3)+" "+msg);var max_full=E.settings.max_full_history_size||8192;var max_size=E.settings.max_size||2048;if(!E.debug_mode&&E.full_history.length>max_full)E.full_history.splice(0,max_full/2);if(!E.debug_mode&&logs.length>max_size)logs.splice(0,max_size/2)}E.level_to_console=function(level){switch(level){case"crit":return"error";case"err":return"error";case"warn":return"warn";case"notice":return"log";case"info":return"info";case"debug":return zutil.is_mocha()?"info":"debug";default:console.error("invalid level",level);return"error"}};function logs_to_str(logs,full_log){if(!logs)return"no logs";var size=E.settings.max_size/2;if(!full_log&&logs.length>size)logs=logs.slice(-size);return array.to_nl(logs)||"empty logs"}function logs_concat(logs,logs2,need_sort){var combined_logs=(logs||[]).concat(logs2||[]);if(need_sort)combined_logs.sort();return combined_logs}E.set_perr=function(perr_func){E.perr=perr_func};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;if(!is_node)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/rand.js",["/util/array.js"],function(array){var E={};var is_jtest=false;var jtest_vals={};var MAX_INT=2147483647;var MIN_INT=-MAX_INT-1;function jtest_pop(s){var elm;if(s===undefined)return null;if((elm=jtest_vals[s])===undefined)return null;return elm.shift()}E.rand=function(s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.random()};E.rand_int32=function(s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.floor(Math.random()*(MAX_INT-MIN_INT+1))-MAX_INT};E.rand_range=function(from,to,s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.floor(Math.random()*(to-from))+from};E.rand_subset=function(a,size,s){var shuffled=a.slice(0);for(var i=0;i<size;i++){var j=E.rand_range(i,shuffled.length,s);var tmp=shuffled[j];shuffled[j]=shuffled[i];shuffled[i]=tmp}return shuffled.slice(0,size)};E.jtest_push=function(s,arr){if(!jtest_vals[s])jtest_vals[s]=[];if(Array.isArray(arr))array.push(jtest_vals[s],arr);else jtest_vals[s].push(arr)};E.jtest_init=function(){is_jtest=true;jtest_vals={}};E.jtest_uninit=function(){is_jtest=false};E.basic_u32=function(v){return 1103515245*v+12345>>>0};E.basic_u31=function(v){return 1103515245*v+12345&2147483647};return E})})();
!function(n){function t(n,t){var r=(65535&n)+(65535&t),e=(n>>16)+(t>>16)+(r>>16);return e<<16|65535&r}function r(n,t){return n<<t|n>>>32-t}function e(n,e,o,u,c,f){return t(r(t(t(e,n),t(u,f)),c),o)}function o(n,t,r,o,u,c,f){return e(t&r|~t&o,n,t,u,c,f)}function u(n,t,r,o,u,c,f){return e(t&o|r&~o,n,t,u,c,f)}function c(n,t,r,o,u,c,f){return e(t^r^o,n,t,u,c,f)}function f(n,t,r,o,u,c,f){return e(r^(t|~o),n,t,u,c,f)}function i(n,r){n[r>>5]|=128<<r%32,n[(r+64>>>9<<4)+14]=r;var e,i,a,h,d,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e<n.length;e+=16)i=l,a=g,h=v,d=m,l=o(l,g,v,m,n[e],7,-680876936),m=o(m,l,g,v,n[e+1],12,-389564586),v=o(v,m,l,g,n[e+2],17,606105819),g=o(g,v,m,l,n[e+3],22,-1044525330),l=o(l,g,v,m,n[e+4],7,-176418897),m=o(m,l,g,v,n[e+5],12,1200080426),v=o(v,m,l,g,n[e+6],17,-1473231341),g=o(g,v,m,l,n[e+7],22,-45705983),l=o(l,g,v,m,n[e+8],7,1770035416),m=o(m,l,g,v,n[e+9],12,-1958414417),v=o(v,m,l,g,n[e+10],17,-42063),g=o(g,v,m,l,n[e+11],22,-1990404162),l=o(l,g,v,m,n[e+12],7,1804603682),m=o(m,l,g,v,n[e+13],12,-40341101),v=o(v,m,l,g,n[e+14],17,-1502002290),g=o(g,v,m,l,n[e+15],22,1236535329),l=u(l,g,v,m,n[e+1],5,-165796510),m=u(m,l,g,v,n[e+6],9,-1069501632),v=u(v,m,l,g,n[e+11],14,643717713),g=u(g,v,m,l,n[e],20,-373897302),l=u(l,g,v,m,n[e+5],5,-701558691),m=u(m,l,g,v,n[e+10],9,38016083),v=u(v,m,l,g,n[e+15],14,-660478335),g=u(g,v,m,l,n[e+4],20,-405537848),l=u(l,g,v,m,n[e+9],5,568446438),m=u(m,l,g,v,n[e+14],9,-1019803690),v=u(v,m,l,g,n[e+3],14,-187363961),g=u(g,v,m,l,n[e+8],20,1163531501),l=u(l,g,v,m,n[e+13],5,-1444681467),m=u(m,l,g,v,n[e+2],9,-51403784),v=u(v,m,l,g,n[e+7],14,1735328473),g=u(g,v,m,l,n[e+12],20,-1926607734),l=c(l,g,v,m,n[e+5],4,-378558),m=c(m,l,g,v,n[e+8],11,-2022574463),v=c(v,m,l,g,n[e+11],16,1839030562),g=c(g,v,m,l,n[e+14],23,-35309556),l=c(l,g,v,m,n[e+1],4,-1530992060),m=c(m,l,g,v,n[e+4],11,1272893353),v=c(v,m,l,g,n[e+7],16,-155497632),g=c(g,v,m,l,n[e+10],23,-1094730640),l=c(l,g,v,m,n[e+13],4,681279174),m=c(m,l,g,v,n[e],11,-358537222),v=c(v,m,l,g,n[e+3],16,-722521979),g=c(g,v,m,l,n[e+6],23,76029189),l=c(l,g,v,m,n[e+9],4,-640364487),m=c(m,l,g,v,n[e+12],11,-421815835),v=c(v,m,l,g,n[e+15],16,530742520),g=c(g,v,m,l,n[e+2],23,-995338651),l=f(l,g,v,m,n[e],6,-198630844),m=f(m,l,g,v,n[e+7],10,1126891415),v=f(v,m,l,g,n[e+14],15,-1416354905),g=f(g,v,m,l,n[e+5],21,-57434055),l=f(l,g,v,m,n[e+12],6,1700485571),m=f(m,l,g,v,n[e+3],10,-1894986606),v=f(v,m,l,g,n[e+10],15,-1051523),g=f(g,v,m,l,n[e+1],21,-2054922799),l=f(l,g,v,m,n[e+8],6,1873313359),m=f(m,l,g,v,n[e+15],10,-30611744),v=f(v,m,l,g,n[e+6],15,-1560198380),g=f(g,v,m,l,n[e+13],21,1309151649),l=f(l,g,v,m,n[e+4],6,-145523070),m=f(m,l,g,v,n[e+11],10,-1120210379),v=f(v,m,l,g,n[e+2],15,718787259),g=f(g,v,m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,h),m=t(m,d);return[l,g,v,m]}function a(n){var t,r="";for(t=0;t<32*n.length;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;for(t=0;t<8*n.length;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}function d(n){return a(i(h(n),8*n.length))}function l(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length>16&&(o=i(o,8*n.length)),r=0;16>r;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}function g(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}function v(n){return unescape(encodeURIComponent(n))}function m(n){return d(v(n))}function p(n){return g(m(n))}function s(n,t){return l(v(n),v(t))}function C(n,t){return g(s(n,t))}function A(n,t,r){return t?r?s(t,n):C(t,n):r?m(n):p(n)}"function"==typeof define&&define.amd?define("md5",[],function(){return A}):"object"==typeof module&&module.exports?module.exports=A:n.md5=A}(this);
(function(){var __hola_stub_define,crypto,assert,zerr,vm;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof navigator=="object"&&navigator.product=="ReactNative";var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");if(!is_node){if(is_ff_addon)define=require("./require_node.js").define(module,"../");else if(is_rn){define=require("./require_node.js").define(module,"../",require("/util/util.js"))}else define=define||self.define;assert=function(){};if(!is_ff_addon&&!is_rn&&self.hola&&self.hola.zerr)zerr=self.hola.zerr;else{zerr=function(){console.log.apply(console,arguments)};zerr.perr=zerr}}else{require("./config.js");zerr=require("./zerr.js");crypto=require("crypto");assert=require("assert");vm=require("vm");define=require("./require_node.js").define(module,"../")}define("/util/conv.js",["/util/util.js"],function(zutil){var E={};var has_map=typeof Map=="function"&&Map.prototype.get&&Map.prototype.set;has_map=0;E.cache_str_map_fn=function(fn){var cache=new Map;return function(s){s=""+s;var v=cache.get(s);if(v!==undefined||cache.has(s))return v;cache.set(s,v=fn(s));return v}};E.cache_str_obj_fn=function(fn){var cache={};return function(s){if(s in cache)return cache[s];return cache[s]=fn(s)}};E.cache_str_fn=has_map?E.cache_str_map_fn:E.cache_str_obj_fn;E.cache_str_fn2=function(fn){var cache={};return function(s1,s2){var cache2=cache[s1]=cache[s1]||{};if(s2 in cache2)return cache2[s2];return cache2[s2]=fn(s1,s2)}};E.o=function(oct_str){return parseInt(oct_str,8)};E.md5=function(buf,hash_len,encoding){return crypto.createHash("md5").update(buf,encoding||"utf8").digest("hex").slice(0,hash_len)};E.md5_zero=function(key,hash_len){assert(hash_len<=32,"invalid hash len"+hash_len);if(!key||!key.length)return"0".repeat(hash_len);return E.md5(key,hash_len)};E.md5_etag=function(buf){return E.md5(buf,8)};E.inet_ntoa_t=function(ip){return((ip&4278190080)>>>24)+"."+((ip&16711680)>>>16)+"."+((ip&65280)>>>8)+"."+(ip&255)};E.inet_addr=function(ip){var parts=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(ip);if(parts===null)return null;if(parts[1]>255||parts[2]>255||parts[3]>255||parts[4]>255)return null;return(parts[1]<<24)+(parts[2]<<16)+(parts[3]<<8)+(parts[4]|0)>>>0};function flags_to_str_once(flags,conv){var f='var s = "";\n';f+='if (!flags) return "";\n';for(var i in conv){if(!conv.hasOwnProperty(i))continue;f+="if (flags & "+conv[i]+") "+"{ s += "+JSON.stringify(i.toLowerCase())+'+" ";'+" flags &= ~"+conv[i]+"; }\n"}f+="if (flags && conv.__conv_to_str.err) "+"conv.__conv_to_str.err(flags, conv);\n";f+="return s.slice(0, -1);\n";var func=new Function(["flags","conv"],f);Object.defineProperty(conv,"__conv_to_str",{enumerable:false,writable:true});conv.__conv_to_str=func;func.err=function(flags,conv){zerr.perr("flags_str_invalid","flags "+flags+" "+JSON.stringify(conv).slice(0,30))};return conv.__conv_to_str(flags,conv)}E.flags_to_str=function(flags,conv){if(conv.__conv_to_str)return conv.__conv_to_str(flags,conv);return flags_to_str_once(flags,conv)};function flags_from_str_once(s,conv){var f="var flags = 0, a, i;\n";f+="if (!s) return 0;\n";f+="s = s.toUpperCase();\n";f+='a = s.split(",");\n';f+="for (i=0; i<a.length; i++)\n";f+="{\n";f+="    if (!conv[a[i]])\n";f+="    {\n";f+="        if (flags && conv.__conv_from_str.err) "+"conv.__conv_from_str.err(flags, conv);\n";f+="        return -1;\n";f+="    }\n";f+="    flags |= conv[a[i]];\n";f+="}\n";f+="return flags;\n";var func=new Function(["s","conv"],f);Object.defineProperty(conv,"__conv_from_str",{enumerable:false,writable:true});conv.__conv_from_str=func;func.err=function(s,conv){zerr.perr("flags_str_invalid","flags "+s+" "+JSON.stringify(conv).slice(0,30))};return conv.__conv_from_str(s,conv)}E.flags_from_str=function(s,conv){if(conv.__conv_from_str)return conv.__conv_from_str(s,conv);return flags_from_str_once(s,conv)};E.scale_vals={1e3:[{s:"",n:1},{s:"K",n:1e3},{s:"M",n:1e6},{s:"G",n:1e9},{s:"T",n:1e12},{s:"P",n:1e15}],1024:[{s:"",n:1},{s:"K",n:1024},{s:"M",n:Math.pow(1024,2)},{s:"G",n:Math.pow(1024,3)},{s:"T",n:Math.pow(1024,4)},{s:"P",n:Math.pow(1024,5)}]};E.scaled_number=function(num,opt){opt=opt||{};var sign="",per=opt.per,scale=opt.scale;var base=opt.base==1024?1024:1e3,ratio=opt.ratio||1;function _per(){return per?E.format_per(per):""}if(num<0){sign="-";num=-num}if(num===undefined)return"";if(isNaN(num))return opt.nan||"x";if(num==Infinity)return sign+"∞";var scale_vals=E.scale_vals[base],i=0;if(scale==null)for(;i<scale_vals.length-1&&num>=scale_vals[i+1].n*ratio;i++);else i=scale_vals.findIndex(function(_scale){return _scale.s==scale});if(per=="ms"&&i){per="s";i--;num=num/1e3}scale=scale_vals[i];if(opt.is_scale)return scale.n;num/=scale.n;if(num<.001)return"0"+_per();if(num>=base-1)num=Math.trunc(num);var str=num.toFixed(num<1?3:num<10?2:num<100?1:0);return sign+str.replace(/((\.\d*[1-9])|\.)0*$/,"$2")+(opt.space?" ":"")+scale.s+_per()};E.format_per=function(per){if(!per)return"";switch(per){case"s":case"ms":return per;case"%":case"%%":return"%";default:return"/"+per[0]}};E.parse_function=function(f){var m=/^function\s*([\w$]+)?\s*\(\n?([\s\w$,]*?)(\s*\/\*`*\*\/)?\)\s*\{\n?([\s\S]*?)\n?\}$/.exec(f);return{name:m[1]||null,args:m[2]?m[2].split(/\s*,\s*/):[],body:m[4]}};function date_stringify(d){return{__ISODate__:d.toISOString()}}var pos_inf={__Infinity__:1};var neg_inf={__Infinity__:-1};function replace_inf(k,v){switch(v){case Infinity:return pos_inf;case-Infinity:return neg_inf;default:return v}}E.JSON_stringify=function(obj,opt){var s,prev_date,_date,prev_func,prev_re;var date_class,func_class,re_class;opt=opt||{};if(opt.date)_date=typeof opt.date=="function"?opt.date:date_stringify;if(opt.mongo)_date=date_stringify;if(_date){date_class=opt.vm_context?vm.runInContext("Date",opt.vm_context):Date;prev_date=date_class.prototype.toJSON;date_class.prototype.toJSON=function(){return _date(this)}}if(opt.func){func_class=opt.vm_context?vm.runInContext("Function",opt.vm_context):Function;prev_func=func_class.prototype.toJSON;func_class.prototype.toJSON=function(){return{__Function__:this.toString()}}}if(opt.re){re_class=opt.vm_context?vm.runInContext("RegExp",opt.vm_context):RegExp;prev_re=re_class.prototype.toJSON;Object.defineProperty(re_class.prototype,"toJSON",{value:function(){return{__RegExp__:this.toString()}},writable:true})}var opt_replacer=opt.replacer;var replacer=opt_replacer;if(opt.inf){if(opt_replacer&&typeof opt_replacer=="function"){replacer=function(k,v){if(this==pos_inf||this==neg_inf)return v;return opt_replacer.call(this,k,replace_inf.call(this,k,v))}}else if(opt_replacer&&Array.isArray(opt_replacer)){replacer=function(k,v){if(v==obj||this==pos_inf||this==neg_inf)return v;if(opt_replacer.includes(k))return replace_inf.call(this,k,v)}}else replacer=replace_inf}try{s=JSON.stringify(obj,replacer,opt.spaces)}finally{if(_date)date_class.prototype.toJSON=prev_date;if(opt.func)func_class.prototype.toJSON=prev_func;if(opt.re)re_class.prototype.toJSON=prev_re}if(opt.mongo)s=s.replace(/\{"__ISODate__":("[0-9TZ:.-]+")\}/g,"ISODate($1)");return s};function parse_leaf(v,opt){if(!v||typeof v!="object"||Object.keys(v).length!=1)return v;if(v.__ISODate__&&opt.date)return new Date(v.__ISODate__);if(v.__Function__&&opt.func){if(vm)return vm.runInThisContext("("+v.__Function__+")");return new Function("","return ("+v.__Function__+");")()}if(v.__RegExp__&&opt.re){var parsed=/^\/(.*)\/(\w*)$/.exec(v.__RegExp__);if(!parsed)throw new Error("failed parsing regexp");return new RegExp(parsed[1],parsed[2])}if(v.__Infinity__&&opt.inf)return v.__Infinity__<0?-Infinity:Infinity;return v}function parse_obj(v,opt){if(!v||typeof v!="object")return v;if(Array.isArray(v)){for(var i=0;i<v.length;i++)v[i]=parse_obj(v[i],opt);return v}var v2=parse_leaf(v,opt);if(v2!==v)return v2;for(var key in v)v[key]=parse_obj(v[key],opt);return v}E.JSON_parse=function(s,opt){opt=Object.assign({date:true,re:true,func:true,inf:true},opt);return JSON.parse(s,function(k,v){return parse_leaf(v,opt)})};E.JSON_parse_obj=function(v,opt){opt=Object.assign({date:true,re:true,func:true,inf:true},opt);return parse_obj(v,opt)};E.hex2bin=function(hex,opt){var byte_array=opt&&opt.byte_array;var bin=byte_array?new Uint8Array:[];var re=/('.)|([0-9a-f][0-9a-f]?)|\s+|[.-]|(.)/gi;var m,v;for(re.lastIndex=0;m=re.exec(hex);){if(m[1])v=m[1].charCodeAt(1);else if(m[2])v=parseInt(m[2],16);else if(m[3])return null;else continue;bin.push(v)}return bin};E.bin2hex=function(arr){var s="",v,i;for(i=0;i<arr.length;i++){v=(arr[i]&255).toString(16).toUpperCase();s+=(v.length<2?"0":"")+v+" "}return s.trim()};E.str2bin=function(s,offset){var len;if(!s||!(len=s.length))return;offset=offset||0;var arr=new Uint8Array(len-offset);for(var i=offset,j=0;i<len;i++,j++)arr[j]=s.charCodeAt(i);return arr};E.tab2sp=function(line){var added=0;return line.replace(/\t/g,function(m,offset,str){var insert=8-(added+offset)%8;added+=insert-1;return" ".repeat(insert)})};E.str2utf8bin=function(s){if(!s||!s.length)return;var arr=new Uint8Array(s.length*3);var len=s.length,i=0,j=0,c,extra;while(i<len){c=s.charCodeAt(i++);if(c>=55296&&c<=56319&&i<len){extra=s.charCodeAt(i++);if((extra&64512)==56320)c=((c&1023)<<10)+(extra&1023)+65536;else i--}if((c&4294967168)==0)arr[j++]=c;else{if((c&4294965248)==0)arr[j++]=c>>6&31|192;else if((c&4294901760)==0){arr[j++]=c>>12&15|224;arr[j++]=c>>6&63|128}else if((c&4292870144)==0){arr[j++]=c>>18&7|240;arr[j++]=c>>12&63|128;arr[j++]=c>>6&63|128}arr[j++]=c&63|128}}return arr.slice(0,j)};E.utf8bin2str=function(arr,offset,len){if(arr.byteLength&&!arr.length)arr=new Uint8Array(arr);var out="",i=offset||0,cp;var c,char2,char3,char4;len=len?i+len:arr.length;while(i<len){c=arr[i++];switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:out+=String.fromCharCode(c);break;case 12:case 13:char2=arr[i++];out+=String.fromCharCode((c&31)<<6|char2&63);break;case 14:char2=arr[i++];char3=arr[i++];out+=String.fromCharCode((c&15)<<12|(char2&63)<<6|(char3&63)<<0);break;case 15:char2=arr[i++];char3=arr[i++];char4=arr[i++];cp=(c&3)<<18|(char2&63)<<12|(char3&63)<<6|char4&63;cp-=65536;out+=String.fromCharCode(55296|cp>>10);out+=String.fromCharCode(56320|cp&1023);break}}return out};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");var zutil=require("../../../util/util.js");var md5=zutil.is_mocha()&&"/svc/cdn/pub/md5.min.js";define=function(name,deps,fn){return define_node(name,["/util/url.js","/util/ajax_lite.js",null,"/util/escape.js","/util/user_agent.js","/util/etask.js","/util/date.js","/util/array.js","/util/util.js",null,"/util/events.js","/util/rand.js",md5,"/util/conv.js"],fn)}}define("/svc/cdn/pub/util.js",["/util/url.js","/util/ajax_lite.js","/util/storage.js","/util/escape.js","/util/user_agent.js","/util/etask.js","/util/date.js","/util/array.js","/util/util.js","/svc/cdn/pub/log.js","/util/events.js","/util/rand.js","md5","/util/conv.js","/util/rate_limit.js"],function(zurl,ajax,storage,zescape,user_agent,etask,date,array,zutil,_log,events,rand,md5,conv,rate_limit){var def_perr_url="//perr.h-cdn.com/be_client_cgi/perr";var E={conf:{}};var assign=Object.assign;var log;if(is_node){E.uri_opts_list=[]}else{E.geoip=zutil.clone(storage.get_json("hola_geoip")||{});E.perr_url=def_perr_url;E.jtest={};E.uri_opts_list=["tech"];E.session_id="session_id_"+rand.rand("cdn_session_id");var protocol=typeof window!="undefined"&&window.location&&window.location.protocol;E.protocol=!protocol||!protocol.startsWith("http")?"http:":protocol;E.mvp_marker=null;log=_log.set_module("util");E.ERR={failed:-1,ranges_unsupported:-2,aborted:-3,head_unsupported:-4,disconnected:-5,unicode_bom:-6,busy:-7};E.ERR_str={"-1":"failed","-2":"ranges_unsupported","-3":"aborted","-4":"head_unsupported","-5":"disconnected","-6":"unicode_bom","-7":"busy"};E.BEFOREUNLOAD=typeof navigator!="undefined"&&navigator.userAgent.match(/iPad|iPhone|iPod/)?"pagehide":"beforeunload";E.browser_init=function(ua,platform){var browser=E.browser=user_agent.guess_browser(ua);var guess=E.guess=user_agent.guess(ua,platform);E.is_chrome=browser.browser=="chrome"&&!browser.opera;E.is_firefox=browser.browser=="firefox";E.is_edge=browser.browser=="edge";E.is_ie=browser.browser=="ie";E.is_opera=browser.opera;E.is_safari=browser.browser=="safari";E.is_windows=guess.os=="windows";E.is_android=guess.os=="android";E.is_winphone=guess.os=="winphone";E.is_mac=guess.os=="macos";E.is_ios=guess.os=="ios";E.is_linux=guess.os=="linux";E.is_webos=guess.os=="webos";E.is_mobile=guess.mobile;E.is_arch_32=guess.arch=="32";E.is_tv=guess.tv;E.is_ios_sdk=browser.hola_ios;E.is_android_sdk=browser.hola_app;E.browser_rule_s=E.browser.opera?"opera":E.browser.hola_app?"android_app":E.browser.hola_ios?"ios_app":E.browser.webos_app?"webos_app":E.browser.chromium_based?"chromium_based":E.browser.browser};E.browser_init();E.fix_url=function(url){return url.startsWith("//")?E.protocol+url:url};function dom_query_fn(method){return function(selector){var method_exists_on=function(root){return root&&root[method]};var query=function(root){return root&&root[method]?root[method](selector):null};if(method_exists_on(document))return query(document);if(method_exists_on(document.body)||method_exists_on(document.head)){return query(document.body)||query(document.head)}return query(document.createElement("div"))}}E.dom_query=dom_query_fn("querySelector");E.dom_query_all=dom_query_fn("querySelectorAll");E.dom_query_foreach=function(selector,cb){var nodes=E.dom_query_all(selector);for(var i=0;i<nodes.length;i++)cb(nodes[i])};E.dom_listen=function(element,on_dom_change){if(window.MutationObserver){var observer=new window.MutationObserver(on_dom_change);observer.observe(element,{childList:true,subtree:true});E.dom_listen.using_observer=true;return observer.disconnect.bind(observer)}if(window.MutationEvent&&element.addEventListener){E.cdn_perr({id:"using_mutation_events",info:{from:"dom_listen"}});document.addEventListener("DOMSubtreeModified",on_dom_change);return element.removeEventListener.bind(element,"DOMSubtreeModified",on_dom_change)}E.cdn_perr({id:"dom_listen_unavailable"});return function(){}};E.attr_watch=function(element,opt){function onchange(from,to){if(opt.toggle_pattern){var re=opt.toggle_pattern;if(re.test(to)==re.test(from))return;from=(from.match(re)||[])[0];to=(to.match(re)||[])[0]}opt.watch_fn(from,to)}if(zutil.is_mocha()){var prop,attr2prop={"class":"className"};if(prop=attr2prop[opt.attr]){var hook=E.inject_hook(element,prop,{set:function(e,args){var prev=element[prop];hook.original_handlers.set(args[0]);onchange(prev,args[0]);e.set_handled()}});return hook.remove.bind(hook)}}if(window.MutationObserver){var observer=new window.MutationObserver(function(mutations){var first;if(first=mutations.find(function(record){return record.attributeName==opt.attr})){onchange(first.oldValue,element.getAttribute(opt.attr))}});observer.observe(element,{attributes:true,attributeOldValue:true});return observer.disconnect.bind(observer)}if(window.MutationEvent&&element.addEventListener){var on_attr_modified=function(e){if(e.attrName==opt.attr)onchange(e.prevValue,e.newValue)};E.cdn_perr({id:"using_mutation_events",info:{from:"attr_watch"}});element.addEventListener("DOMAttrModified",on_attr_modified);return element.removeEventListener.bind(element,"DOMAttrModified",on_attr_modified)}E.cdn_perr({id:"attr_watch_unavailable"})};E.new_event=function(name){if(typeof Event=="function")return new Event(name);var evt=document.createEvent("Event");evt.initEvent(name,true,true);return evt};E.send_beacon=function(url,data){if(typeof navigator!="undefined"&&navigator.sendBeacon){data.send_type="BEACON";if(navigator.sendBeacon(url,to_form_data(data)))return;data.send_type=undefined}data.send_type="POST";ajax.raw({url:E.fix_url(url),data:data,method:"POST"})};E.is_numeric=function(n){return!isNaN(n)&&n!=null&&n!=Infinity};E.valid_ranges=function(ranges){return ranges&&(!ranges.length||ranges.every(function(r){return E.is_numeric(r.from)&&E.is_numeric(r.to)}))};E.set_local_conf=function(local){storage.set_json("hola_local_conf",local)};E.get_local_conf=function(){var local=storage.get_json("hola_local_conf")||{};if(local.ver!=E.conf.ver)E.set_local_conf(local={ver:E.conf.ver});return local};E.get_dbg_conf=function(){var dbg_conf=storage.get_json("hola_dbg_conf");var window_dbg_conf=typeof window!="undefined"&&window.hola_dbg_conf;if(!window_dbg_conf&&!dbg_conf)return;dbg_conf=zutil.extend_deep({},window_dbg_conf,dbg_conf);if(!E.get_dbg_conf_warn){log.warn("using hola_dbg_conf %O",dbg_conf,{});E.get_dbg_conf_warn=true}return dbg_conf};E.get_spark_conf=function(){var spark_conf=storage.get_json("hola_spark_conf");var window_spark_conf=typeof window!="undefined"&&window.hola_spark_conf;if(!window_spark_conf&&!spark_conf)return;spark_conf=zutil.extend_deep({},window_spark_conf,spark_conf);if(!E.get_spark_conf_warn){log.warn("using hola_spark_conf %O",spark_conf,{});E.get_spark_conf_warn=true}return spark_conf};E.init=function(conf){if(E.inited)return;E.perr_sent={};E.perr_rl_hash={};E.inited=true;E.mvp_marker=null;E.conf=zutil.extend_deep({},conf,E.get_local_conf(),E.get_dbg_conf());E.has_ext=E.conf.loader&&E.conf.loader.injected;var proto=zutil.get(E.conf,"loader.https_xhr_only")?"https:":"";E.perr_url=E.conf.perr_url||proto+def_perr_url;E.ver=E.conf.ver;E._events=new E.events;E.debug_err_url_rx=storage.get("hola_debug_err_url_rx");if(typeof window!="undefined")window.addEventListener(E.BEFOREUNLOAD,on_beforeunload);if(typeof document!="undefined"&&document.visibilityState){E.is_hidden=document.visibilityState!="visible";document.addEventListener("visibilitychange",on_visibilitychange)}};function on_beforeunload(){E.is_beforeunload=true;E._events.emit("beforeunload");E._events.emit("zbeforeunload");E.send_delayed_perrs()}function on_visibilitychange(){if(document.visibilityState=="visible"){E.is_hidden=false;E._events.emit("visible_state")}else if(document.visibilityState=="hidden"){E.is_hidden=true;E._events.emit("hidden_state");if(E.is_mobile)E._events.emit("zbeforeunload")}E.send_delayed_perrs()}E.is_mode_cdn=function(zone){return zone.CG("mode")=="cdn"};E.is_mode_bwsaver=function(zone){return zone.CG("mode")=="bwsaver"};E.is_mode_cdn_or_bwsaver=function(zone){return E.is_mode_cdn(zone)||E.is_mode_bwsaver(zone)};E.uninit=function(){if(!E.inited)return;if(typeof window!="undefined")window.removeEventListener(E.BEFOREUNLOAD,on_beforeunload);if(typeof document!="undefined"&&document.visibilityState)document.removeEventListener("visibilitychange",on_visibilitychange);E.send_delayed_perrs();E.inited=false;E.conf={}};function build_info(){var b={platform:typeof navigator!="undefined"&&navigator.platform,user_agent:typeof navigator!="undefined"&&navigator.userAgent};b.ver=E.ver;b.browser=user_agent.browser_to_string(E.browser);b.browser_build=typeof window!="undefined"&&window.conf&&window.conf.browser&&window.conf.browser.name;b.guess=JSON.stringify(E.guess);return b}function build(){var info=build_info(),s="";for(var f in info)s+=(s&&"\n")+f+": "+info[f];return s}function to_form_data(o){var data=new FormData;zutil.forEach(o,function(v,k){data.append(k,v)});return data}E.perrs=[];E.perr_delayed=function(opt){E.perrs.push(opt);if(E.delayed_timer)return;E.delayed_timer=setTimeout(E.send_delayed_perrs,5*date.ms.SEC)};E.send_delayed_perrs=function(){E.delayed_timer=clearTimeout(E.delayed_timer);if(!E.perrs.length)return;if(!E.is_beforeunload&&!E.is_hidden){var can_send=true;var wrappers=zutil.get(E.loader,"wrapper",[]);wrappers.forEach(function(w){if(!can_send||!w.player||!w.player.is_playing())return;var b=w.player.get_current_buffer();if(b.to-b.from>20)return;can_send=false});if(!can_send)E.delayed_timer=setTimeout(E.send_delayed_perrs,5*date.ms.SEC)}var max=25,perrs=E.perrs.slice(0,max);E.perrs=E.perrs.slice(max);E.cdn_perr({id:"delayed_perrs",delay:false,delayed_perrs:perrs});if(E.perrs.length)E.delayed_timer=setTimeout(E.send_delayed_perrs,date.ms.SEC)};function perr_raw(opt){var data={},qs={},delayed=opt.delay===undefined||!!opt.delay;data.info=opt.info;data.bt=opt.bt;data.filehead=opt.filehead;if(opt.delayed_perrs)data.delayed_perrs=JSON.stringify(opt.delayed_perrs);qs.id=opt.id;qs.browser=opt.browser||(E.browser.opera?"opera":E.browser.ucbrowser?"ucbrowser":E.browser.browser);qs.browser_ver=E.browser.version;qs.customer=opt.customer;if(opt.tag){qs.tag_id=opt.tag.id;qs.tag_date=+opt.tag.date}if(opt.zone)qs.zone=opt.zone;data.session_id=opt.session_id;data.is_json=1;if(delayed&&!+E.get_hola_uri("hola_no_perr_delay")){assign(data,qs);E.perr_delayed(data);return}data.ver=E.ver;data.build=build();var url=(opt.perr_url||E.perr_url)+"?"+zescape.qs(qs);if(opt.use_beacon)return void E.send_beacon(url,data);data.send_type="POST";ajax.raw({url:E.fix_url(url),data:data,method:"POST"})}var is_touch=typeof document!="undefined"&&"ontouchstart"in document.documentElement;var is_embed=typeof window!="undefined"&&window.top&&window.top!==window;function perr_rate_limit(opt){if(opt.rate_limit===false)return true;var _rl=assign({ms:date.ms.HOUR,count:10},opt.rate_limit);var id=opt.id,rl=E.perr_rl_hash[id]=E.perr_rl_hash[id]||{};var ret=rate_limit(rl,_rl.ms,_rl.count);if(!ret){var key="perr_rate_limit_"+id;if(!E.perr_sent[key])E.cdn_perr({id:"perr_rate_limit",info:id,rate_limit:false});E.perr_sent[key]=1}return ret}function db_perr(opt){opt=opt||{};var id=opt.id;if(opt.throttle&&!opt.force&&(E.perr_sent[id]||0)>=opt.throttle)return;perr_rate_limit(opt);var data=opt.data||{};data.sent=data.sent||{};var info=typeof opt.info!="object"?{_info:opt.info}:opt.info;var customer,zone=opt.zone||{};if(!info.customer&&(customer=E.conf.customer))info.customer=customer;if(!info.zone&&zone.name)info.zone=zone.name;if(!info.method&&zone.method)info.method=zone.method;info.hola_mode=info.hola_mode||zone.mode;info.skip=zone.skip;info.dashboard=";type="+(zone.stream_type||"unknown")+(zone.player_type?";player="+zone.player_type:"")+(zone.tech?";tech="+zone.tech:"");var url_frame=E.get_url_frame();var url=data.url||opt.url||url_frame.top_url;var match=url?url.match(/^http(s)?:\/\/(www\.)?([a-zA-Z0-9-\.]+)\/.*$/):null;info.url=url;info.frame=!!url_frame.frame_url;info.location_url=url_frame.frame_url||url_frame.top_url;info.site=match?match[3]:"unknown";info.referrer=typeof document!="undefined"&&document.referrer;info.referrer_type=E.referrer_type(info.location_url,info.referrer,E.conf_get("loader.referrer_internal_regex"));assign(info,opt.extra,{file:data.file,link:data.link,err:opt.err||info.err});info.is_embed=is_embed;info.is_touch=is_touch;if(E.mvp_marker!=null)info.mvp_marker=E.mvp_marker;info.support_fullscreen=user_agent.support_fullscreen();var nc;if(typeof navigator!="undefined"&&(nc=navigator.connection))info.connection={type:nc.type,downlink_max:nc.downlinkMax};if(zone.bwsaver)info.bw_saving=zone.bwsaver;if(zone.video_url&&!info.video_url)info.video_url=zone.video_url;if(zone.video_live&&info.video_live===undefined)info.video_live=zone.video_live;if(zone.player_info)info.player_info=zone.player_info;if(E.is_beforeunload)info.before_unload=true;E.perr_sent[id]=E.perr_sent[id]+1||1;info.session_id=E.session_id;info.tag=zutil.get(E.loader,"tag");info.injected=E.loader&&E.loader.CG("loader.injected");info.analysis_tag=opt.analysis_tag;var info_str;try{info_str=conv.JSON_stringify(info,{inf:true})}catch(e){info_str="[circular]"}perr_raw({tag:info.tag,session_id:E.session_id,id:opt.prefix+id,info:info_str,customer:customer,zone:zone.name,bt:opt.bt,browser:opt.browser,filehead:opt.filehead,use_beacon:opt.use_beacon,perr_url:opt.perr_url,wrapper:opt.wrapper,delay:opt.delay,delayed_perrs:opt.delayed_perrs})}_log.set_perr(function(opt){return E.cdn_perr(opt)});E.cdn_perr=function(opt){if(opt.filehead)opt.filehead+="\n\n";opt.filehead=opt.filehead||"";var logs;if(opt.add_log){var log_obj=opt.zone?opt.zone.log:_log;if(opt.full)opt.filehead+=log_obj.logs_to_str(_log.full_history,true);else{if(opt.player_logs)logs=log_obj.concat(opt.player_logs,true);opt.filehead+=log_obj.logs_to_str(logs,opt.full_log)}}else opt.filehead+="no log requested";return db_perr(assign(opt,{prefix:"www_cdn_db_"}))}}E.conf_set=function(path,val,save,conf){path=path.split(".");conf=conf||E.conf||{};var i,c={},_c=c;for(i=0;i<path.length-1;c=c[path[i]],i++)c[path[i]]=c[path[i]]||{};c[path[i]]=val;zutil.extend_deep(conf,_c);if(save){var local=E.get_local_conf();zutil.extend_deep(local,_c);E.set_local_conf(local)}};E.conf_get=function(path,def){var res=E.conf_find(path.split("."));return res===undefined?def:res};E.conf_find=function(path,conf){if(!path)return;conf=conf||E.conf;var i;for(i=0;i<path.length&&conf&&conf[path[i]]!==undefined;i++)conf=conf[path[i]];return i==path.length?conf:undefined};function update_xhr_progress(xhr,ev){if(ev.lengthComputable)xhr.total=ev.total;xhr.loaded=ev.loaded}function str2bin(xhr,opt){var arr=conv.str2bin(xhr.response,opt.served||0);if(!arr)return;var ret={progress:opt.served,data:arr.buffer,last_progress:date.monotonic()};opt.progress=opt.served;opt.served=xhr.response.length;return ret}function msstream2bin(xhr,opt){var reader=new window.MSStreamReader;function cb(data,to){var ret={progress:opt.served,data:data,last_progress:date.monotonic()};opt.progress=opt.served;opt.served=to;opt.onreadystatechange(xhr,ret)}reader.onprogress=reader.onload=function(ev){update_xhr_progress(xhr,ev);var data=ev.target.result;var to=ev.loaded;if(opt.served!=to)cb(data.slice(opt.served,to),to)};reader.readAsArrayBuffer(xhr.response)}var perr_no_res_sent=false;E.fetch_bin=function(opt){opt.onreadystatechange=opt.onreadystatechange||function(){};opt.onprogress=opt.onprogress||function(){};var xhr,url;return etask({name:"fetch_bin",cancel:true},[function(){url=zescape.uri(E.fix_url(opt.url));var _this=this;this.opt=opt;var fallback_wrapper=function(f){return opt.fallback_wrapper?opt.fallback_wrapper(f):f};if(opt.streaming)opt.progress=opt.served=0;this.xhr=xhr=opt.XHR?new opt.XHR(opt.xhr_opt):new XMLHttpRequest;if(opt.withCredentials)xhr.withCredentials=true;xhr.open(opt.method||(opt.data?"POST":"GET"),url,true);xhr.responseType=opt.response_type||"arraybuffer";xhr.onreadystatechange=fallback_wrapper(function(){if(!opt.streaming||xhr.readyState!=xhr.LOADING)opt.onreadystatechange(xhr)});xhr.onprogress=opt.onprogress;var headers=opt.headers||{};if(headers.Range&&E.browser.browser=="safari")headers["Cache-Control"]="no-store";if(opt.data){headers["Content-Type"]=opt.content_type||"application/json";if(headers["Content-Type"]=="application/json"&&typeof opt.data=="object"){opt.data=JSON.stringify(opt.data)}}for(var hdr in headers)xhr.setRequestHeader(hdr,headers[hdr]);function onload(ev){xhr.success=true;var res=xhr.response;if(opt.response_type=="json"&&xhr.responseType!="json")try{res=JSON.parse(res)}catch(e){}if(xhr.responseType=="ms-stream")res=null;_this.continue({data:res,size:ev.total})}if(E.debug_err_url_rx&&new RegExp(E.debug_err_url_rx).test(url)){log.notice("Xhr onload handler is replaced with debug exception");xhr.onload=function(){log.notice("Generating debug xhr error for "+url);_this.throw("debug xhr error")}}else xhr.onload=fallback_wrapper(onload);xhr.onerror=function(e){_this.throw(e)};if(opt.streaming){var b=E.browser.browser,v=E.browser.version;if(b=="chrome"&&v>=7||b=="firefox"&&v>=9&&opt.streaming_text){xhr.responseType="text";xhr.overrideMimeType("text/plain; charset=x-user-defined");xhr.onprogress=fallback_wrapper(function(e){update_xhr_progress(xhr,e);opt.onprogress.call(xhr,e,str2bin(xhr,opt))})}else if((b=="edge"||b=="ie"&&v>=10)&&window.MSStreamReader){xhr.responseType="ms-stream";xhr.onreadystatechange=fallback_wrapper(function(){if(xhr.readyState==xhr.LOADING)msstream2bin(xhr,opt);else opt.onreadystatechange(xhr)})}else if(b=="firefox"&&v>=9){xhr.responseType="moz-chunked-arraybuffer";xhr.onprogress=fallback_wrapper(function(ev){var res=xhr.response;if(!res){if(!perr_no_res_sent){perr_no_res_sent=true;E.cdn_perr({id:"on_progress_no_res"})}return}update_xhr_progress(xhr,ev);opt.progress=opt.served;opt.served=opt.progress+res.byteLength;opt.onprogress.call(xhr,ev,{progress:opt.progress,data:res,last_progress:date.monotonic()})})}else opt.streaming=false}xhr.streaming=opt.streaming;xhr.send(opt.data);return this.wait(opt.timeout)},function(res){if(this.error||!res)throw"failed fetch request "+this.error;res.hdrs=E.get_resp_hdrs(xhr);if(!res.fullsize){var v;if(v=E.fullsize_from_xhr(xhr))res.fullsize=+v;else if(!opt.hrange&&(!opt.headers||!opt.headers.Range)){res.fullsize=!res.data?0:res.data.byteLength||res.data.length}}res.status=xhr.status;return res},function catch$(e){this.return({err:e})},function finally$(){opt.aborted=true;if(xhr.readyState<xhr.DONE)xhr.abort()}])};E.fullsize_from_xhr=function(xhr){return E.fullsize_from_hdrs(E.get_resp_hdrs(xhr),xhr.status==206)};E.fullsize_from_hdrs=function(hdrs,is_range){if(!hdrs)return;var fs,v;if(v=hdrs["x-hola-fullsize"])fs=+v;else if(v=hdrs["content-range"])fs=+v.split("/")[1];else if((v=hdrs["content-length"])&&!is_range)fs=+v;return fs};E.guess_link_type=function(url){var type=E.get_video_type(url);switch(type){case"mp4":return"video/mp4";case"hls":return"application/x-mpegurl";case"hds":return"application/adobe-f4m";case"dash":return"application/dash+xml";case"flv":return"video/flv";case"webm":return"video/webm";default:log.debug('could not guess link type: "'+url+'" assuming mp4');return"video/mp4"}};E.mime_to_type=function(mime){switch(mime){case"video/mp4":return"mp4";case"application/vnd.apple.mpegurl":case"application/x-mpegurl":return"hls";case"application/adobe-f4m":return"hds";case"application/dash+xml":return"dash";case"video/flv":return"flv";case"video/webm":return"webm"}};E.blob_to_dataurl=function(blob){return etask({name:"blob_to_dataurl",cancel:true},[function(){var _this=this,reader=new FileReader;reader.onerror=function(e){_this.throw(e)};reader.onload=function(){_this.return(reader.result)};reader.readAsDataURL(blob);return this.wait()}])};E.blob_to_dataurl.supported=!!(typeof window!="undefined"&&window.FileReader&&window.Blob);E.btoa=function(arr){return etask([function(){if(E.blob_to_dataurl.supported)return;var bin="";var dv=new DataView(arr.buffer,arr.byteOffset,arr.byteLength);for(var i=0,l=arr.byteLength;i<l;i++)bin+=String.fromCharCode(dv.getUint8(i));return this.return(window.btoa(bin))},function(){return E.blob_to_dataurl(new Blob([arr]))},function(r){return r.slice(r.indexOf(",")+1)}])};E.set_geoip=function(data){if(!data)return;if(E.geoip&&E.geoip.country&&E.geoip.country!=data.country.toLowerCase()){E.cdn_perr({id:"geoip_country_change",info:{prev:E.geoip,next:data}})}E.geoip=zutil.clone(data);E.geoip.ver=E.conf.ver;for(var i in E.geoip){if(typeof E.geoip[i]=="string")E.geoip[i]=E.geoip[i].toLowerCase()}if(data.date){E.geoip.date_skew=date(date.to_jdate())-date(data.date)}storage.set_json("hola_geoip",E.geoip)};E.array_equal=function(arr1,arr2){if(arr1.length!=arr2.length)return false;var i;for(i=0;i<arr1.length&&arr1[i]===arr2[i];i++);return i==arr1.length};E.events=function(){this.events=new events;return this};E.events.prototype.on=function on(event,fn,context){this.events.on(event,fn,context)};E.events.prototype.once=function once(event,fn,context){this.events.once(event,fn,context)};E.events.prototype.one=E.events.prototype.once;E.events.prototype.off=function off(event,fn){this.events.off(event,fn)};E.events.prototype.multi_on=function multi_on(handlers,context){Object.keys(handlers).forEach(function(e){this.events.on(e,handlers[e],context)},this)};E.events.prototype.multi_off=function multi_off(handlers,context){Object.keys(handlers).forEach(function(e){this.events.off(e,handlers[e],context)},this)};E.events.prototype.emit=function emit(event,a1,a2,a3,a4,a5){this.events.emit("pre-"+event,a1,a2,a3,a4,a5);this.events.emit(event,a1,a2,a3,a4,a5);this.events.emit("post-"+event,a1,a2,a3,a4,a5)};E.on=function(event,fn,ctx){E._events.on(event,fn,ctx)};E.off=function(event,fn){E._events.off(event,fn)};E.services={};E.services.brightcove=function(opt,cb){var sources=[];etask([function(){this.finally(function(){cb(sources)});return ajax.raw({url:"https://edge.api.brightcove.com/playback/v1"+"/accounts/"+(opt.account_id||opt.account)+"/videos/"+(opt.video_id||opt.video),headers:{"BCOV-Policy":opt.policy_key||opt.pk},data_type:"json"})},function catch$(){return this.return()},function(data){sources=data.sources.filter(function(src){return src.src&&/^mp4$/i.test(src.container||"")&&/^h264$/i.test(src.codec||"")});sources=sources.map(function(src){return{src:src.src,type:"video/mp4"}})}])};var web_sockets={};E.ws=function(host,opt){opt=opt||{};var ws_c=opt.ws_c||typeof WebSocket!="undefined"&&WebSocket;if(typeof ws_c!="function"||!host)return;if(!(this instanceof E.ws))return new E.ws(host,opt);var path,customer,zone;if(typeof opt=="string")path=opt;else if(typeof opt=="object"){path=opt.path;customer=opt.customer;zone=opt.zone}var protocol=opt.protocol||(E.protocol=="https:"?"wss":"ws");this.url=protocol+"://"+host+"/"+path;this.url=zescape.uri(this.url,{customer:customer,zone:zone});if(web_sockets[this.url])return web_sockets[this.url];this.id=0;this.minor=!!opt.minor;this.pending=[];try{this.ws=new ws_c(this.url)}catch(e){return}this.ws.binaryType="arraybuffer";this.ws.onopen=this.onopen.bind(this);this.ws.onclose=this.onclose.bind(this);this.ws.onerror=this.onerror.bind(this);this.ws.onmessage=this.onmessage.bind(this);this.log=opt.log||log;this.timer=undefined;this.timedout=false;if(opt.timeout){this.timer=setTimeout(this.ontimedout.bind(this),opt.timeout==true?5e3:opt.timeout)}web_sockets[this.url]=this;return this};zutil.inherits(E.ws,events.EventEmitter);E.ws.prototype.close=function(){if(this.ws&&this.ws.readyState<this.ws.CLOSING)this.ws.close();web_sockets[this.url]=undefined};E.ws.prototype.is_ready=function(){return this.ws&&this.ws.readyState==this.ws.OPEN};E.ws.prototype.send=function(cmd,route,data,onmessage){if(!this.ws||this.ws.readyState>=this.ws.CLOSING)return;if(this.ws.readyState<this.ws.OPEN){this.pending.push({cmd:cmd,route:route,data:data,onmessage:onmessage});return}if(typeof data=="string")data=JSON.parse(data);if(Array.isArray(data))data={data:data};var msg={__id:this.id++,cmd:cmd,route:route,data:data||{}};if(onmessage)this.once(msg.__id,onmessage);msg=JSON.stringify(msg);try{this.ws.send(msg)}catch(e){this.log.info("error in websocket send: state "+this.ws.readyState+" "+" msg "+e.message+" url "+this.url)}return msg.length};E.ws.prototype.onopen=function(){var _this=this;if(this.timer){clearTimeout(this.timer);this.timer=undefined}this.pending.forEach(function(item){_this.send(item.cmd,item.route,item.data,item.onmessage)});this.pending=[];this.emit("open")};E.ws.prototype.onclose=function(){if(!this.ws)return;if(this.timer){clearTimeout(this.timer);this.timer=undefined}this.ws=undefined;this.log.info("closed websocket "+this.url);this.emit("close")};E.ws.prototype.onerror=function(e){this.log.info("error websocket "+this.url+" "+e.type);if(this.minor){this.log.info("Note: WebSockets only transmit auxilliary information "+"between clients and servers. WebSocket errors do not impact "+"HolaCDN functionality in any way.")}this.emit("error",e);this.close()};function dv2str(dv,start){var len=dv.getUint32(start);var str="",end=start+len+4;for(var i=start+4;i<end;i+=2)str+=String.fromCharCode(dv.getUint16(i));return str}function bin2json(msg){if(typeof msg=="string")return JSON.parse(msg);if(!msg.byteLength||msg.byteLength<9)throw new Error("bad message");var ctrl=new DataView(msg);var ver=ctrl.getUint8(0);if(ver!=2)throw new Error("unsupported version");var str_part=dv2str(ctrl,4);var obj=JSON.parse(str_part);var offset=str_part.length*2+8;while(offset<msg.byteLength){var id_str=dv2str(ctrl,offset);offset+=id_str.length*2+4;var bin_len=ctrl.getUint32(offset);var bin_data=new Uint8Array(msg,offset+4,bin_len);offset+=bin_len+4;zutil.set(obj,id_str,bin_data)}return obj}E.ws.prototype.onmessage=function(ev){if(typeof ev.data.byteLength=="number"){if(ev.data.byteLength<9)return this.emit("message",{err:"bad message"});var ctrl=new DataView(ev.data,0,8);var ver=ctrl.getUint8(0);if(ver!=1&&ver!=2)return this.emit("message",{err:"unsupported version"});if(ver==1){var bid=ctrl.getUint32(4);var data=new Uint8Array(ev.data,8);return this.emit(bid,{body:data})}}var json;try{json=bin2json(ev.data)}catch(e){json={err:e}}this.emit(json.__id===undefined?"message":json.__id,json.res||json)};E.ws.prototype.ontimedout=function(){if(this.timer){clearTimeout(this.timer);this.timer=undefined}if(!this.ws)return;this.timedout=true;this.close()};E.ms_since=function(since){return Math.round(date.monotonic()-(since||0))};E.origin_is_allowed=function(origin,origins){return E._origin_is_allowed(origins||E.conf_get("agent.origins"),origin)};E.origin_is_allowed_url=function(url,origins){var o=zurl.parse(url);if(!o||!o.hostname)return;return E.origin_is_allowed(o.hostname,origins)};E.get_api=function(){var g=typeof window!="undefined"?window:typeof global!="undefined"?global:self;return(g.hola_cdn||(g.hola_cdn={api:{}})).api};var mp4_suffix=/\.(mp4|m4p|m4v|mov)$/i;var hls_suffix=/\.m3u8$/;var hds_suffix=/\.f4m$/;var dash_suffix=/\.mpd$/;var flv_suffix=/\.flv$/;var webm_suffix=/\.webm$/;function is_rx_link(v,rx){return!!v&&rx.test(zurl.parse(v).pathname.split(";")[0])}E.is_mp4_link=function(v){return is_rx_link(v,mp4_suffix)};E.is_hls_link=function(v){return is_rx_link(v,hls_suffix)};E.is_hds_link=function(v){return is_rx_link(v,hds_suffix)};E.is_dash_link=function(v){return is_rx_link(v,dash_suffix)};E.is_flv_link=function(v){return is_rx_link(v,flv_suffix)};E.is_webm_link=function(v){return is_rx_link(v,webm_suffix)};E.is_youtube_link=function(v){return v&&/^(.*\.)?youtube.com$/.test(zurl.get_host(v))};E.get_video_type=function(v){if(E.is_youtube_link(v))return"yt";if(E.is_mp4_link(v))return"mp4";if(E.is_flv_link(v))return"flv";if(E.is_webm_link(v))return"webm";if(E.is_hls_link(v))return"hls";if(E.is_hds_link(v))return"hds";if(E.is_dash_link(v))return"dash";return null};E.is_adaptive=function(type){return["hls","hds","dash"].indexOf(type)>-1};E.is_progressive=function(type){return["mp4","flv","webm"].indexOf(type)>-1};E.get_method_type=function(type){if(E.is_progressive(type))return"progressive";if(E.is_adaptive(type))return type;return"unknown"};E.get_adaptive_by_type=function(type){if(E.is_adaptive(type)||type=="yt")return type;return null};E.get_adaptive_type=function(v){var type=E.get_video_type(v);return E.get_adaptive_by_type(type)};E.is_blob_url=function(u){return!!(u&&(u.startsWith("blob:")||u.startsWith("mediasource:")))};E.is_proxy_url=function(u){var o=zurl.parse(u);return o.hostname==require.zdot("host")};E.get_proxy_url=function(customer,zone,src){return"//"+require.zdot("host")+"/api/zagent_get?customer="+customer+"&zone="+zone+"&url="+encodeURIComponent(src)};E.proxy2origin=function(src){return decodeURIComponent(src.replace(/.*?&url=(.*)$/,"$1"))};function check_re(lst,s){if(!lst)return false;for(var i=0;i<lst.length;i++){var re=lst[i];if(re===s||re instanceof RegExp&&re.test(s))return true}return false}E._origin_is_allowed=function(origins,origin){return origins=="*"||check_re(origins,origin)};E.video_format_is_enabled=function(zone,url){var media_filter_in=zone.CGJ("cdn.media.filter_in");if(!media_filter_in)return true;for(var i=0;i<media_filter_in.length;i++){var test_func=E["is_"+media_filter_in[i]+"_link"];if(test_func&&test_func(url))return true}return false};E.get_perr_link_msg=function(customer,bugid){return"report sent id "+bugid+"\nbug location url "+"http://holaspark.com/cp/admin/debug/err_problem_report?"+zescape.qs({cust:customer,filter:"info.bugid=="+bugid})};E.get_resp_hdrs=function(xhr){if(!xhr||!xhr.getAllResponseHeaders)return{};var hdrs=xhr.getAllResponseHeaders();if(!hdrs)return{};hdrs=hdrs.split("\n");var ret={},count=1;hdrs.forEach(function(h){if(!h.length||h=="\r")return;var args=h.split(/:(.+)/);var key=args[0].trim().toLowerCase();if(ret[key])key+="_dup"+count++;ret[key]=args[1]&&args[1].trim()});return ret};E.close_to_end=function(cur,dur){return Math.floor(dur)-Math.round(cur)<=0};E.try_wrapper=function(opt,func){if(typeof opt=="function"){func=opt;opt={}}var throttle=opt.throttle||5;var prefix=opt.prefix||"util";return function(){try{return func.apply(this,arguments)}catch(e){if(opt.silent)return;E.cdn_perr({id:prefix+"_try_wrapper_err",err:e.message,throttle:throttle,bt:e.stack,opt:opt});if(log)log.err(prefix+"_try_wrapper_err "+e+" "+e.stack)}}};E.try_wrapper_silent=function(func){return E.try_wrapper({silent:true},func)};E.inject_hook=function(object,prop,opt){function get_property_descriptor_data(o,p){while(o&&!o.hasOwnProperty(p))o=Object.getPrototypeOf(o);return{obj:o,pd:o&&Object.getOwnPropertyDescriptor(o,p)}}function can_install(o,p){var pd=Object.getOwnPropertyDescriptor(o,p);return!pd||pd.configurable}function throw_wrapper(error){if(opt.exit_on_failure)return;throw new Error(error)}if(!object)return throw_wrapper("injecting hook, but no object");if(!can_install(object,prop))return throw_wrapper("injecting hook on unconfigurable property");if(typeof opt=="function")opt={exec:opt};var setup={func_hook:{get_hook:function(){return typeof object[prop]=="function"&&object[prop].hook},install:function(hook){var _hook=function(){return hook("exec",this,arguments)};_hook.hook=hook;hook._orig_handler=object[prop];hook._orig_handler_inherited=Object.hasOwnProperty(object,prop);Object.defineProperty(object,prop,{configurable:true,writable:true,enumerable:true,value:_hook});if(typeof hook._orig_handler!="function")return{exec:function(){}};return{exec:hook._orig_handler}},uninstall:function(hook){if(hook._orig_handler_inherited)delete object[prop];else object[prop]=hook._orig_handler}},value_hook:{get_hook:function(){var data=get_property_descriptor_data(object,prop);return data.pd&&(data.pd.get||data.pd.set||{}).hook},install:function(hook){var data=hook._orig_desc_data=get_property_descriptor_data(object,prop);var pd=data.pd;if(!pd||!pd.set&&!pd.get){
var v=pd?pd.value:undefined;pd={get:function(){return v},set:function(_v){v=_v}}}var _hook=function(type){var h=function(){return hook(type,this,arguments)};h.hook=hook;return h};Object.defineProperty(object,prop,{configurable:true,enumerable:true,set:pd.set&&_hook("set"),get:pd.get&&_hook("get")});return{get:pd.get,set:pd.set}},uninstall:function(hook){var pd=hook._orig_desc_data.pd||{configurable:true,writable:true,enumarable:true};if(pd.writable)pd.value=object[prop];var target=hook._orig_desc_data.obj||object;if(target!=object)delete object[prop];Object.defineProperty(target,prop,pd)}}};var oh,hook,hook_method=opt.exec?setup.func_hook:setup.value_hook;if(!(hook=hook_method.get_hook())){hook=function(origin,owner,args){var e={set_handled:function(){e._handled=true},is_intercepted:function(){return!!e._handled}};var iterate_listeners=function(is_post){var ret,listener,_origin=is_post?"post_"+origin:origin;for(var i=0;i<hook.listeners.length;i++){listener=hook.listeners[i];if(!listener[_origin])continue;try{ret=listener[_origin].call(owner,e,args)}catch(e){E.cdn_perr({id:"hook_fail",info:{err:e},add_log:true});throw e}if(!is_post&&e.is_intercepted())return ret}};e.retval=iterate_listeners();if(!e.is_intercepted()&&hook.original_handlers[origin])e.retval=hook.original_handlers[origin].apply(owner,args);iterate_listeners(true);return e.retval};hook.listeners=[];hook.original_handlers=hook_method.install(hook);hook.uninstall=function(){if(hook_method.get_hook()!=hook)return;hook_method.uninstall(hook)}}hook.listeners.push(opt);oh=hook.original_handlers;return{count:function(){return hook.listeners.length},remove:function(){var index=hook.listeners.indexOf(opt);if(index<0)return;hook.listeners.splice(index,1);if(!hook.listeners.length)hook.uninstall()},original_handlers:{exec:opt.exec&&oh.exec&&oh.exec.bind(object),get:!opt.exec&&oh.get&&oh.get.bind(object),set:!opt.exec&&oh.set&&oh.set.bind(object)}}};E.on_window_message=function(cb,async){function is_postm_modifiable(){var d=Object.getOwnPropertyDescriptor(window,"postMessage");var is_modifiable=!d||d.configurable;if(!is_modifiable)E.cdn_perr({id:"postm_non_modifiable"});return is_modifiable}if(!E.conf_get("loader.post_message_wrapper")||!is_postm_modifiable()){window.addEventListener("message",cb);return window.removeEventListener.bind(window,"message",cb)}var queue=[];function call_async(d){queue.push(d);setTimeout(function(){cb({data:queue.shift()})},0)}var hfunc=async?call_async:function(d){cb({data:d})};var hook=E.inject_hook(window,"postMessage",function(e,a){try{hfunc(a[0])}catch(e){E.cdn_perr({id:"overload_fail",info:{failed_method:"window.postMessage",err:e},add_log:true})}});return hook.remove.bind(hook)};E.absolute_uri=function(s,unwrap_empty){if(!s&&!unwrap_empty)return s;var el=document.createElement("source");el.src=s||"";return el.src};E.set_url_param=function(name,value,delim){return E.set_param(name,value&&encodeURIComponent(value),delim)};E.set_param=function(name,value,delim){if([false,undefined].includes(value))return"";delim=delim||"&";return delim+name+([null,true].includes(value)?"":"="+value)};E.parse={};E.parse.cache_control=function(s){var cc=zescape.parse.http_words(s),ret={};for(var i=0;i<cc.length;i++)ret[cc[i][0]]=cc[i][1]||true;return ret};E.get_hola_uri=function(location,key,def_val){var loc=typeof window!="undefined"&&window.location;if(typeof location!="object"){def_val=key;key=location;location=loc}else if(!location)location=loc;if(!key||!loc)return def_val;var o_url=zurl.parse(window.top===window?location.href:document.referrer);var o_qs=zurl.qs_parse((o_url.search||"").substr(1));var o_hash=zurl.qs_parse((o_url.hash||"").substr(1));return o_qs[key]||o_hash[key]||def_val};E.get_uri_conf=function(){var conf={};E.uri_opts_list.forEach(function(key){var value=E.get_hola_uri("hola_"+key);if(value!==undefined)conf[key]=value});return conf};E.load_script=function(url,onload,attrs){var script=document.createElement("script");script.src=E.fix_url(url);script.onload=onload;if(attrs)Object.assign(script,attrs);if(document.getElementsByTagName("head").length)document.getElementsByTagName("head")[0].appendChild(script);else if(document.getElementsByTagName("body").length)document.getElementsByTagName("body")[0].appendChild(script);else if(document.head)document.head.appendChild(script)};E.max_qid_by_resolution=function(playlists,res){var max_level=playlists.length-1,chosen;if(!res||!res.width||!res.height)return 0;for(var i=max_level;i>=0;i--){var _res=playlists[i].attributes.resolution;var bandwidth=playlists[i].attributes.bandwidth;if(!_res||!_res.width||!_res.height||bandwidth<=64e3)continue;chosen=i;if(_res.width==res.width&&_res.height==res.height)break;if(+_res.width<+res.width&&+_res.height<+res.height){chosen=Math.min(i+1,max_level);break}}return chosen};E.fnv1a=function(chunk){var hash=2166136261,arr=new Uint8Array(chunk);for(var i=0;i<arr.length;i++){hash^=arr[i];hash=hash+(hash<<1)+(hash<<4)+(hash<<7)+(hash<<8)+(hash<<24)>>>0}return hash};E.create_fake_xhr=function(opt){var fake_xhr={setup:{},req_headers:[]};opt.log=opt.log.set_module("util");fake_xhr.open=function(verb,url){fake_xhr.verb=verb;fake_xhr.url=url};fake_xhr.setRequestHeader=function(header,value){fake_xhr.req_headers.push([header,value])};fake_xhr.getAllResponseHeaders=function(){return""};fake_xhr.send=function(){fake_xhr.sent=true;opt.onsend()};fake_xhr.abort=function(){if(!fake_xhr.req||fake_xhr.req.error===E.ERR.aborted||fake_xhr.req.info.rate){return}fake_xhr.req.abort();if(opt.onabort)opt.onabort();opt.log.notice("req aborted",fake_xhr.req.name);if(fake_xhr.onabort)fake_xhr.onabort();if(fake_xhr.onloadend)fake_xhr.onloadend()};return fake_xhr};E.update_fake_xhr=function(req){var fake_xhr=req.info.segment.fake_xhr,err=req.error;fake_xhr.response=err?null:req.res.data;fake_xhr.status=err?404:200;fake_xhr.responseURL=fake_xhr.url;fake_xhr.resp_hdrs=(req.resp||{}).hdrs;if(!err){var ev={loaded:req.res.size,total:req.res.size,target:fake_xhr,lengthComputable:true};if(fake_xhr.onload)fake_xhr.onload(ev)}if(fake_xhr.onloadend)fake_xhr.onloadend();return fake_xhr};E.parse_range_header=function(hdr){var r=hdr.split("=").pop().split("-");return{from:+r[0],to:+r[1]}};E.module_fn=function(module,target){var name=typeof target=="function"?target.name:target;function get_orig(){var s=module.Player.super_,proto_fn=s&&s.prototype[name];return typeof target=="string"&&proto_fn?proto_fn:target}module.Player.prototype[name]=function(a1,a2,a3){var len=arguments.length,mod_fn=this.module&&this.module[name];var fn=mod_fn||get_orig(),fn_this=mod_fn?this.module:this;if(typeof fn!="function")return;switch(len){case 0:return fn.call(fn_this);case 1:return fn.call(fn_this,a1);case 2:return fn.call(fn_this,a1,a2);case 3:return fn.call(fn_this,a1,a2,a3);default:var args=new Array(len);for(var i=0;i<len;i++)args[i]=arguments[i];return fn.apply(fn_this,args)}};module.Player.prototype[name].orig=get_orig};E.call_super=function(module,pl,name){var in_len=arguments.length,s,fn,out_len=in_len-3;if(!module.Player||!(s=module.Player.super_))return;var a=new Array(out_len>0?out_len:0);for(var i=3;i<in_len;i++)a[i-3]=arguments[i];return name?(fn=s.prototype[name])&&fn.apply(pl,a):s.apply(pl,a)};E.create_forwarding_emit=function(player){var events=player.module&&player.module.event_list,in_call=false;if(!events)return;player.old_emit=player.old_emit||player.emit;player.emit=function(e,o1,o2){return!events.includes(e)&&player.old_emit(e,o1,o2)};events.forEach(function(e){player.module.on(e,function(o1,o2){if(in_call)return;in_call=true;try{player.old_emit(e,o1,o2)}finally{in_call=false}})})};E.resolve_url=function(base_url,path){var m=path.match(/^([^:\/?#]+:)?(?:\/\/(?:([^:@\/?#]*)(?::([^:@\/?#]*))?@)?((?:[^:\/?#]*)(?::(?:\d*))?))?([^?#]*)(\?[^#]*)?(#[\s\S]*)?/);var protocol=m[1]||"";var user=m[2]||"";var password=m[3]||"";var host=m[4]||"";var pathname=m[5]||"";var search=m[6]||"";var hash=m[7]||"";if(!/(\w+:)?\/\//.test(base_url))base_url=E.resolve_url(location.href,base_url);var base=zurl.parse(base_url);var is_full=!!protocol||!!host||!!user;if(!is_full&&!pathname&&!search)search=base.search||"";if(!is_full&&pathname.charAt(0)!="/"){pathname=pathname?((base.host||base.user)&&!base.pathname?"/":"")+base.pathname.slice(0,base.pathname.lastIndexOf("/")+1)+pathname:base.pathname}var output=[];pathname.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(p){if(p=="/..")output.pop();else output.push(p)});pathname=output.join("").replace(/^\//,pathname.charAt(0)=="/"?"/":"");if(!is_full){host=base.host;password=base.password;user=base.user}if(!protocol)protocol=base.protocol;return protocol+"//"+(user?user+(password?":"+password:"")+"@":"")+host+pathname+search+hash};var swf_versions=[{match:{jwplayer_version:[7,11,0]},expected:[1,0,37]},{match:{jwplayer_version:[7,10,1]},expected:[1,0,36]},{match:{jwplayer_version:[7,7]},expected:[1,0,35]},{match:{jwplayer_version:[7]},expected:[1,0,34]},{match:{jwplayer_version:[6]},expected:[1,0,28]},{match:{flashls_version:"*"},expected:[2,0,13]},{match:{osmf_version:"*"},expected:[1,0,14]}];var min_hola_player_version=[5,10];function check_ver(version,exp){if(exp=="*")return true;var actual=(version||"").split(".");for(var i=0,l=exp.length;i<l;i++){var act_i=actual[i]|0;if(exp[i]<act_i)return true;if(exp[i]>act_i)return false}return true}E.is_old_hola_player=function(ver){return ver&&!check_ver(ver,min_hola_player_version)};E.is_old_swf=function(ver){if(!ver)return;for(var i=0,l=swf_versions.length;i<l;i++){var rule=swf_versions[i];var matches=Object.keys(rule.match);function check_player(p){return ver[p]&&check_ver(ver[p],rule.match[p])}if(matches.some(check_player))return!check_ver(ver.patch_version,rule.expected)}};E.is_enabled=function(module){return!!module&&!module.__stub};E.assert_enabled=function(module,message){if(!E.is_enabled(module))throw new Error(message||"module is disabled")};E.log_report=function(opt){var bws=opt.cdn&&opt.cdn.attached_bws;var stats=opt.cdn&&opt.cdn.attached_stats;if(!bws&&!stats||!opt.id)return;if(!opt.add_unittest&&!opt.add_log&&!opt.load_perf&&!opt.exception)return;var zone=(bws||stats).zone;var zperr=zone.perr_get();var o={id:opt.id+"_report",delay:false,info:{only_stats:!bws},extra:!opt.exception&&stats&&stats.get_stats_all(),use_beacon:true,add_log:opt.add_log,analysis_tag:opt.analysis_tag};if(zone.CG("log.full"))o.full=true;if(opt.add_unittest&&bws)o.filehead="last test:\n"+bws.unittest.gen_test();if(bws&&bws.serve_log_arr.length)o.info.serve_log=bws.serve_log_arr;if(opt.load_perf){o.filehead=(o.filehead?o.filehead+"\n":"")+"Load perf:\n";o.filehead+=opt.load_perf;o.info.load_perf=true}if(opt.exception)o.info.exception=opt.exception;zperr(o)};E.get_random=function(salt){var key="hola_random_"+salt;var force=+E.get_hola_uri(key,false);if(force){log.notice("force %s random %s",salt,force);return force}if(E.conf_get("loader.real_random")){var saved=storage.get_int(key);if(saved)return saved;var random=rand.rand("random_from_storage");storage.set(key,random);return random}E.get_random.salt=E.get_random.salt||{};var ip=E.geoip&&E.geoip.ip;if(E.get_random.salt[salt])return E.get_random.salt[salt];if(!ip){log.notice("no ip, using random");if(!E.get_random.salt[salt])E.get_random.salt[salt]=rand.rand("random_by_ip")}else{E.get_random.salt[salt]=parseInt(md5(ip+salt).slice(-4),16)/Math.pow(2,16)}return E.get_random.salt[salt]};E.is_hola_hls_js=function(hls){return!!zutil.get(hls,"streamController.onFragChunkLoaded")};E.is_hola_hls_js_constructor=function(Hls){if(Hls.is_hola_hls===undefined){var test=new Hls;Hls.is_hola_hls=E.is_hola_hls_js(test);test.destroy()}return Hls.is_hola_hls};E.get_hls_sc=function(hls){return hls.streamController||hls.mediaController};E.def_hola_hls_config=function(conf_get){var ret={fragLoadingLoopThreshold:1e3,manifestLoadingTimeOut:20*date.ms.SEC,manifestLoadingMaxRetry:4,levelLoadingTimeOut:20*date.ms.SEC,levelLoadingMaxRetry:4};conf_get=conf_get||E.conf_get;assign(ret,conf_get("loader.dailymotion.config")||{});return ret};E.get_size_name=function(width,height){if(!isFinite(width)||!isFinite(height))return"unknown";return Math.round(width/100)*100+"x"+Math.round(height/100)*100};E.get_width_name=function(width){return!isFinite(width)||width<=0?"width_unknown":width<300?"width_300":width<600?"width_600":width<900?"width_900":width<1200?"width_1200":"width_over_1200"};E.get_height_name=function(height){return!isFinite(height)||height<=0?"height_unknown":height<300?"height_300":height<600?"height_600":height<900?"height_900":height<1200?"height_1200":"height_over_1200"};E.get_top_url=function(loaded_in_debug){return E.get_url_frame(loaded_in_debug).top_url};E.get_url_frame=function(loaded_in_debug,check_redirect){if(typeof window=="undefined")return{};var ret={top_url:loaded_in_debug||window.top==window?location.href:document.referrer};ret.frame_url=window.top==window?undefined:location.href;if(ret.frame_url&&E.conf_get("loader.use_top_location"))try{ret.top_url=window.top.location.href}catch(e){}var nav=check_redirect&&(window.top||window).performance&&(window.top||window).performance.getEntriesByType("navigation")[0];if(nav&&nav.name!=ret.top_url&&nav.redirectCount)ret.redirect_top_url=nav.name;return ret};E.referrer_type=function(url,ref,regex){if(!ref)return"none";var url_host=zurl.get_host(url),ref_host=zurl.get_host(ref);if(!url_host||!ref_host)return"invalid";return(regex?regex.test(ref_host):url_host==ref_host)?"internal":"external"};E.data_snapshot=function(data,fields){var past=zutil.clone_deep(data);fields=fields||Object.keys(data);return{diff:function(now){var res=zutil.clone_deep(now);fields.forEach(function(path){var val_past=zutil.get(past,path);var val_now=zutil.get(now,path);var val_res=typeof val_past=="number"&&typeof val_now=="number"?val_now-val_past:val_now;zutil.set(res,path,val_res)});return res}}};function read_i32(s){return parseInt(s.slice(0,2),16)|parseInt(s.slice(2,4),16)<<8|parseInt(s.slice(4,6),16)<<16|parseInt(s.slice(6,8),16)<<24}E.hrw_get=function(url){var hash=md5(url);return{a:read_i32(hash.slice(0,8))|0,b:read_i32(hash.slice(8,16))|0}};function hrw_rand(v){return 1103515245*(v|0)+12345|0}E.hrw_rank=function(shard_md5_int,key_md5_int){var v=hrw_rand(shard_md5_int.a);v=hrw_rand(v+key_md5_int.a);v=hrw_rand(v+shard_md5_int.b);v=hrw_rand(v+key_md5_int.b);return v};E.def_url2cache=function(_url){return _url.replace(/([^?]+).*/,"$1")};E.strip_hostname=function(_url){return _url.replace(/^(https?:)?\/\/([^\/]+)/,"")};E.err_ex=function(err,opt){var e=new Error(err);assign(e,opt);return e};E.parse_segment_url=function(s,opt){var url=zurl.parse(s);if(!opt.proxy)return url;var proxy_path_re=new RegExp(url.hostname+"/"+E.conf.customer+"/"+opt.zone+"/");var hola_param_re=/[?&]hola.*$/;var hola_playlist_re=/.*[?&]hola.*playlist=([^&]*).*/;var hola_manifest_re=/.*[?&]hola.*manifest=([^&]*)$/;url=zurl.parse(s.replace(proxy_path_re,"").replace(hola_param_re,""));var force=url.force_params={};if(hola_playlist_re.test(s))force.playlist=decodeURIComponent(s.replace(hola_playlist_re,"$1"));if(hola_manifest_re.test(s))force.manifest=decodeURIComponent(s.replace(hola_manifest_re,"$1"));return url};E.get_stylesheet=function(styles){var res=[];for(var selector in styles){var keys=Object.keys(styles[selector]).filter(function(key){return!!styles[selector][key]});var css=keys.map(function(key){return"    "+key+": "+styles[selector][key]+";\n"});if(css.length)res.push(selector+" {\n"+css.join("")+"}")}return res.join("\n")};E.debounce=function(func,wait){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;func.apply(context,args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}};E.throttle=function(func,wait){var ctx,args,rtn,timeout;var last=0;var call=function(){timeout=null;last=new Date;rtn=func.apply(ctx,args);ctx=null;args=null};return function(){ctx=this;args=arguments;var delta=new Date-last;if(!timeout){if(delta>=wait)call();else timeout=setTimeout(call,wait-delta)}return rtn}};E.visual_viewport=function(){var vp;if(vp=window.visualViewport){return{top:vp.offsetTop,bottom:vp.offsetTop+vp.height,left:vp.offsetLeft,right:vp.offsetLeft+vp.width,height:vp.height,width:vp.width}}var root_rect=document.documentElement.getBoundingClientRect();return{top:root_rect.top+window.pageYOffset,bottom:root_rect.top+window.pageYOffset+window.innerHeight,left:root_rect.left+window.pageXOffset,right:root_rect.left+window.pageXOffset+window.innerWidth,height:window.innerHeight,width:window.innerWidth}};E.client_rect2page_rect=function(rect){var root_rect=document.documentElement.getBoundingClientRect();return{top:rect.top-root_rect.top,bottom:rect.bottom-root_rect.bottom,left:rect.left-root_rect.left,right:rect.right-root_rect.right,height:rect.height,width:rect.width}};E.t={bin2json:bin2json,ws_onmessage:E.ws.prototype.onmessage};return E})})();
define("/svc/cdn/pub/map.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/log.js","/util/date.js","/util/array.js"],function(util,_log,date,array){var E={};var log=_log.set_module("map");E.Map=function(arg){this.ranges=[];this.sum=0;this.size=-1;this.last_ts=0;if(arg){if(typeof arg=="object"){var add_ranges=util.valid_ranges(arg.ranges)&&(!arg.cache_ranges||typeof arg.cache_ranges!="object"||util.valid_ranges(arg.cache_ranges));this.ranges=add_ranges?arg.ranges:[];this.cache_ranges=add_ranges?arg.cache_ranges:arg.cache_ranges?[]:undefined;this.sum=arg.sum;this.size=arg.size;if(arg.exclude_end)this.exclude_end=arg.exclude_end}else this.size=arg}};E.Map.prototype.reset=function(){this.ranges=[];this.cache_ranges=this.cache_ranges?[]:undefined;this.size=-1};E.Map.prototype.set_size=function(sz,force){if(this.size<0||force)this.size=sz;if(this.size!=sz)log.debug("map err size is "+this.size+" try to set size "+sz)};E.Map.prototype.get_date=function(from,to){var ts=this.date,c;if(c=this.get_cache_range(from,to))ts=c.date;return ts};E.Map.prototype.update=function(from,to,ts,info){if(this.size>=0&&to>=this.size){log.debug("map err update chunk.to "+to+" extends past map size "+this.size)}this.set_cache_range(from,to,ts,info);if(ts&&!this.date||ts>this.date)this.date=ts;this.sum+=to+(this.exclude_end?0:1)-from;this.ranges.push.apply(this.ranges,[{from:from,to:to}]);this.last_ts=date();if(!this.cache_ranges)this.info=info;this.compress()};E.Map.prototype.remove=function(from,to){if(this.size>=0&&to>=this.size){log.debug("map err remove chunk.to "+to+" extends past map size "+this.size)}var i,c;if(this.cache_ranges){if(!(c=this.get_cache_range(from,to)))return;array.rm_elm(this.cache_ranges,c)}var rm=[],add=[];for(i=0;i<this.ranges.length&&(to<0||this.ranges[i].from<=to);i++){var r=this.ranges[i];if(r.to<from)continue;else if(r.from>=from&&(to<0||r.to<=to))rm.push(r);else if(r.from<from&&r.to>to){add.push({from:to+1,to:r.to});r.to=from-1}else if(r.from<from)r.to=from-1;else if(r.to>=to)r.from=to+1}var _this=this;rm.forEach(function(r){array.rm_elm(_this.ranges,r)});add.forEach(function(r){_this.ranges.splice(0,0,r)});this.last_ts=date();this.compress();this.summarize()};E.Map.prototype.get_cache_range=function(from,to){if(!this.cache_ranges)return;for(var i=0;i<this.cache_ranges.length&&(this.cache_ranges[i].from!=from||this.cache_ranges[i].to!=to);i++);return i<this.cache_ranges.length?this.cache_ranges[i]:null};E.Map.prototype.set_cache_range=function(from,to,ts,info){if(!this.cache_ranges)return;var c;if(!(c=this.get_cache_range(from,to)))this.cache_ranges.push({from:from,to:to,date:ts,info:info});else if(!c.date||c.date<ts){c.date=ts;c.info=info}};E.Map.prototype.merge=function(map){var _this=this;map.ranges.forEach(function(r){_this.ranges.push({from:r.from,to:r.to})});if(map.cache_ranges&&this.cache_ranges){map.cache_ranges.forEach(function(r){_this.set_cache_range(r.from,r.to,r.date,r.info)})}if(this.size<0)this.size=map.size;this.last_ts=Math.max(this.last_ts,map.last_ts);this.info=map.info;this.compress()};E.Map.prototype.next_unobtained=function(from,to){if(this.size>=0)to=to>=0?Math.min(to,this.size-1):this.size-1;var i;for(i=0;i<this.ranges.length&&(to<0||from<=to);i++){var c=this.ranges[i];if(c.to+1<from)continue;else if(from<c.from)break;else from=to<0?c.to+1:Math.min(c.to+1,to+1)}return to>=0&&from>to?null:{from:from,to:i==this.ranges.length?to:to<0?this.ranges[i].from-1:Math.min(to,this.ranges[i].from-1)}};E.Map.prototype.next_obtained=function(from,to){for(var i=0;i<this.ranges.length;i++){var c=this.ranges[i];if(c.to<from)continue;if(to>-1&&c.from>to)break;return{from:Math.max(c.from,from),to:to<0?c.to:Math.min(c.to,to),date:this.date,info:this.info}}return null};E.Map.prototype.next_obtained_exact=function(from,to){for(var i=0;i<this.cache_ranges.length;i++){var c=this.cache_ranges[i];if(c.from<from)continue;if(to>-1&&c.from>to)break;return{from:c.from,to:c.to,date:c.date,info:c.info,i:i}}return null};E.Map.prototype.summarize=function(){this.sum=0;this.ranges.forEach(function(r){this.sum+=r.to+(this.exclude_end?0:1)-r.from},this)};E.Map.prototype.compress=function(){this.ranges.sort(function(a,b){return a.from-b.from});if(this.cache_ranges)this.cache_ranges.sort(function(a,b){return a.from-b.from});var changed=1,changed_once=0;while(changed){changed=0;for(var i=this.ranges.length-1;i>=0;i--){if(!i||this.ranges[i-1].to+1<this.ranges[i].from)continue;this.ranges[i-1].to=Math.max(this.ranges[i].to,this.ranges[i-1].to);this.ranges.splice(i,1);changed=changed_once=1}}if(changed_once)this.summarize()};return E});
define("/svc/cdn/pub/cache.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/log.js","/svc/cdn/pub/map.js","/util/storage.js","/util/date.js","/util/util.js","/util/url.js"],function(util,_log,map,storage,date,zutil,zurl){var E={};var KB=1024,MB=1024*KB;var cache;var perr=util.cdn_perr;var assign=Object.assign;E.version="10";E.Cache=function(url,cdns,opt){this.zone=opt.zone;this.log=this.zone.log_get().set_module("cache");if(!cache){cache=new gCache;cache.open(this.log)}this.opt=opt;this.url=this.url2curl(url);this.data=cache.get_url(this.url,false,this.opt.cache_ranges);this.log.debug("read entry "+this.url+" data\n"+JSON.stringify(this.data));this.filter_cdns=[];var _this=this;if(cdns)cdns.forEach(function(cdn){_this.filter_cdns.push(cdn.host)})};E.Cache.prototype.url2curl=function(url){if(typeof url=="string")url=zurl.parse(url);return this.zone.conf_apply(this.opt.adaptive?"agent.manifest2cache":"agent.url2cache",[url.orig],util.def_url2cache(url.orig))};E.Cache.prototype.add_origin_filter_cdn=function(host){this.add_filter_cdn(host,true)};E.Cache.prototype.add_filter_cdn=function(host,origin){if(!origin&&this.zone.CG("cdn.send_reqs.origin_only"))return;if(!this.filter_cdns.some(function(h){return h==host}))this.filter_cdns.push(host)};E.Cache.prototype.save=function(opt){if(cache)cache.save(assign({log:this.log},opt))};E.Cache.prototype.set=function(opt){opt=opt||{};var host=opt.host,from=opt.from,to=opt.to;var zperr=this.zone.perr_get();if(this.zone.CG("cdn.cache.urls.disable"))return;if(!util.is_numeric(from)||!util.is_numeric(to)){return void zperr({id:"bwsaver_cache_err_bad_range",err:"bad range "+from+"-"+to,add_log:true})}var entry=this.get_entry(opt.id);if(!entry.maps[host])entry.maps[host]=new map.Map({cache_ranges:this.opt.cache_ranges});entry.map.update(from,to);entry.maps[host].update(from,to,opt.cache_date?date(opt.cache_date):null,opt.info);entry.maps[host].path=opt.path;entry.last_ts=entry.maps[host].last_ts;this.log.debug("set "+from+"-"+to+" to "+host+" at "+opt.cache_date);this.save()};E.Cache.prototype.next_immediate=function(opt){return this.get(assign(opt,{from_equal:true}),"next_immediate")};E.Cache.prototype.unset=function(opt){if(opt.id&&!this.data.ids)return;var from=opt.from,to=opt.to,_this=this;function process_entry(entry,id){var hosts=opt.host?[opt.host]:Object.keys(entry.maps);hosts.forEach(function(h){var e=entry.maps[h],_ranges;if(!e||!(_ranges=e.cache_ranges||e.ranges)||!_ranges.length)return;var _from=_ranges[0].from,_to=_ranges[0].to;var ranges=from===undefined&&to===undefined?e.cache_ranges?e.cache_ranges:e.ranges:[{from:from===undefined?_from:from,to:to===undefined?_to:to}];ranges.forEach(function(r){e.remove(r.from,r.to);var n=_this.next_obtained(id,from,to);if(!n||n.from>r.from||n.to<r.to){entry.map.remove(r.from,n?n.from:r.to);if(n&&n.to<r.to)entry.map.remove(n.to+1,r.to)}});entry.last_ts=e.last_ts})}if(!opt.id&&this.data.ids){for(var i in this.data.ids)process_entry(this.data.ids[i],i)}else if(opt.id)process_entry(this.data.ids[opt.id],opt.id);else process_entry(this.data);this.log.debug("unset "+(!opt.id&&this.data.ids?"all ids ":opt.id?"id "+opt.id+" ":"")+(opt.host?"host "+opt.host+" ":"all hosts ")+(from===undefined&&to===undefined?"all ranges ":from+"-"+to));this.save()};E.Cache.prototype.update_stats=function(stats){if(!stats.sz||!stats.ms)return;var bpms=stats.sz/(stats.ms+stats.ms_hdrs);this.bpms=Math.round(!this.bpms?bpms:(this.bpms*2+bpms)/3)};E.Cache.prototype.calc_ttc=function(sz){return this.bpms?sz/this.bpms:200};E.Cache.prototype.get_entry=function(id){if(id&&(!this.data.ids||!this.data.ids[id])){this.data.ids=this.data.ids||{};this.data.ids[id]={maps:{},map:new map.Map}}return id?this.data.ids[id]:this.data};E.Cache.prototype.next_unobtained=function(id,from,to,host){var entry=this.get_entry(id);if(!entry||host&&!entry.maps[host])return{from:from,to:to};if(!host)return entry.map.next_unobtained(from,to);return entry.maps[host].next_unobtained(from,to)};E.Cache.prototype.next_obtained=function(id,from,to){return this.get({id:id,from:from,to:to},"next_obtained")};E.Cache.prototype.is_cached=function(opt,host){return(this.get(assign(opt,{from_equal:true}),"is_cached")||[]).some(function(e){return!host||e.cdn==host})};E.Cache.prototype.get=function(opt,caller){if(this.zone.CG("cdn.cache.urls.disable"))return;var process_maps=function(e,cid){for(var host in e.maps){var range,m=e.maps[host];if(this.filter_cdns.length&&!this.filter_cdns.includes(host))continue;if((range=this.opt.cache_ranges?m.next_obtained_exact(from,to):m.next_obtained(from,to))&&(!from_equal||range.from==from)){if(range.date&&range.info&&range.info.max_age){var d=date(+range.date);if(d.setSeconds(d.getSeconds()+range.info.max_age)<+now){if(this.opt.cache_ranges)m.cache_ranges.splice(range.i,1);else delete e.maps[host];continue}}cached.push({cdn:host,range:range,from_cache:true,id:isNaN(cid)?cid:+cid})}}};opt=opt||{};var id=opt.id,from=opt.from,to=opt.to,from_equal=opt.from_equal;var entry=this.get_entry(opt.all?undefined:id);var cached=[],now=date();if(!entry.ids||!Object.keys(entry.ids).length)process_maps.call(this,entry,id);else{for(var _id in entry.ids)process_maps.call(this,entry.ids[_id],_id)}return cached.length?cached:null};E.Cache.prototype.set_single_copy_cdns=function(cdns){if(!cdns)return;this.log.info("set single copy cdns "+JSON.stringify(cdns));this.data.single_copy=zutil.clone_deep(cdns);this.save()};E.Cache.prototype.set_popular_cdns=function(cdns){if(!cdns)return;this.log.info("set popular cdns "+JSON.stringify(cdns));this.data.popular=zutil.clone_deep(cdns);this.save()};E.Cache.prototype.set_fast_cdns=function(cdns){if(!cdns)return;this.log.info("set fast cdns "+JSON.stringify(cdns));this.data.fast=zutil.clone_deep(cdns);this.save()};E.Cache.prototype.get_single_copy_cdns=function(){return this.data.single_copy||[]};E.Cache.prototype.get_popular_cdns=function(){return this.data.popular||[]};E.Cache.prototype.get_fast_cdns=function(){return this.data.fast||[]};E.uninit=function(){if(cache)cache.save({close:true});cache=undefined};E.init=function(){cache=new gCache;cache.open()};function gCache(){if(!(this instanceof gCache))return new gCache;this.max_size=512*KB;this.bpms=0;return this}gCache.prototype.open=function(log){this.data=this.read_storage(log);this.read_ts=date()};gCache.prototype.get_url=function(url,if_exists,cache_ranges){var urls=this.data.urls=this.data.urls||{};if(urls[url]&&!!cache_ranges!=!!urls[url].cache_ranges)urls[url]=null;if(cache_ranges&&urls[url]){var keys=Object.keys(urls[url].maps);if(!keys.every(function(h){return!!urls[url].maps[h].cache_ranges})){urls[url]=null}}if(!urls[url]&&!if_exists){urls[url]={maps:{},cache_ranges:cache_ranges,map:new map.Map}}return urls[url]};gCache.prototype.clean_oldest=function(){var oldest;for(var url in this.data.urls){if(!oldest||this.data.urls[url].last_ts<this.data.urls[oldest].last_ts){oldest=url}}if(oldest)delete this.data.urls[oldest]};gCache.prototype.read_storage=function(log){var remove=[];function _read_entry(u){var maps,m;for(var host in u.maps){maps=maps||{};m=u.maps[host];for(var i=0;m.cache_ranges&&i<m.cache_ranges.length;i++){var c=m.cache_ranges[i];if(c.from>c.to){m.cache_ranges.splice(i,1);i--;continue}c.date=date(c.date)}maps[host]=new map.Map({ranges:m.ranges,sum:m.sum,last_ts:m.last_ts,cache_ranges:m.cache_ranges});maps[host].date=date(m.date);maps[host].path=m.path;maps[host].info=m.info}if(maps)u.maps=maps;var list=new map.Map;for(m in maps)list.merge(maps[m]);list.last_ts=u.map.last_ts;list.summarize();u.map=list}function read_entry(url,qid){var u=qid!==undefined?data.urls[url].ids[qid]:data.urls[url];try{_read_entry(u)}catch(err){perr({id:"bwsaver_cache_err_failed_read",err:err,info:{entry:JSON.stringify(u)},add_log:true});if(log)log.info("error reading entry\n"+JSON.stringify(u));remove.push({url:url,qid:qid})}}var data=storage.get_json("hola_bwsaver_cache");if(!data||data.version!=E.version&&(!zutil.is_mocha()||!util.jtest.skip_version_match)){if(log){log.debug("cache "+(!data?"not found":"version mismatch "+data.version+"!="+E.version))}return{urls:{}}}for(var url in data.urls){if(data.urls[url].ids){for(var qid in data.urls[url].ids)read_entry(url,qid);if(data.urls[url].map)read_entry(url);continue}read_entry(url)}remove.forEach(function(e){if(e.qid!==undefined)delete data.urls[e.url].ids[e.qid];else delete data.urls[e.url]});return data};gCache.prototype.save=function(opt){var _this=this,url;function update_entry(cur,stored,qid){if(cur.last_ts<_this.read_ts)return;if(stored&&cur.cache_ranges!=stored.cache_ranges)stored=null;if(!stored){if(qid)return void(data.urls[url].ids[qid]=cur);return void(data.urls[url]=cur)}if(cur.single_copy)stored.single_copy=cur.single_copy;if(cur.popular)stored.popular=cur.popular;if(!stored.map)stored.map=cur.map;else if(cur.map.last_ts>_this.read_ts)stored.map.merge(cur.map);for(var cdn in cur.maps){if(!stored.maps[cdn])stored.maps[cdn]=cur.maps[cdn];else if(cur.maps[cdn].last_ts>_this.read_ts){stored.maps[cdn].merge(cur.maps[cdn]);stored.maps[cdn].date=cur.maps[cdn].date;stored.maps[cdn].host=cur.maps[cdn].host}}}opt=opt||{};var now=date.monotonic();if(!opt.close&&now-this.last_save<=5*date.ms.SEC)return;var data=this.read_storage(opt.log);if(!data)data=this.data;else{for(url in this.data.urls){var cur=this.data.urls[url];var stored=data.urls[url];if(this.data.urls[url].ids){data.urls[url]=data.urls[url]||{};data.urls[url].ids=data.urls[url].ids||{};for(var qid in this.data.urls[url].ids){cur=this.data.urls[url].ids[qid];stored=data.urls[url].ids[qid];update_entry(cur,stored,qid)}continue}update_entry(cur,stored)}data.single_copy=this.data.single_copy;data.fast=this.data.fast;data.popular=this.data.popular}try{while(JSON.stringify(data)>this.max_size)this.clean_oldest();data.version=E.version;storage.set_json("hola_bwsaver_cache",data);this.last_save=now;if(opt.close&&opt.log)opt.log.debug("saved "+JSON.stringify(data))}catch(err){perr({id:"bwsaver_cache_err_failed_save",err:err});storage.clr("hola_bwsaver_cache")}};E.is_cachable=function(hdrs){if(!hdrs||!hdrs.etag)return 0;if(!hdrs["cache-control"]){if(!hdrs["last-modified"]||!hdrs.date)return 0;var diff=new Date(hdrs.date)-new Date(hdrs["last-modified"]);return diff>=10*date.ms.MIN?diff/10/date.ms.SEC:0}var cc=util.parse.cache_control(hdrs["cache-control"]);return cc["no-cache"]||cc["no-store"]||(cc["max-age"]||0)<=0?0:+cc["max-age"]};return E});
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/hash.js",[],function(){var E={};function imul64h(a,b){var ah=a>>>16&65535;var al=a&65535;var bh=b>>>16&65535;var bl=b&65535;return ah*bh+(ah*bl+al*bh)>>16|0}E.hash_int=function(val){var xh=imul64h(val,1103515245);var xl=Math.imul(val,1103515245);return xl-xh>>>0};E.hash_string=function(s){if(!s.length)return 0;var hash=E.hash_int(s.length);for(var i=0;i<s.length;i+=2){hash=E.hash_int(hash+(s.charCodeAt(i)<<16)+(s.charCodeAt(i+1)|0)>>>0)}return hash};E.sum_parse=function(str){var parts=/([0-9a-f]+)\s+([ *]?)(.*)/i.exec(str);if(!parts)return null;return{hash:parts[1],type:parts[2]=="*"?"binary":"text",file:parts[3]}};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,["/util/util.js","/svc/cdn/pub/util.js",null,"/util/date.js","/util/etask.js","/util/url.js","events","/util/array.js","/util/escape.js","/util/rand.js","/util/hash.js"],fn)}}define("/svc/cdn/pub/cdnlist.js",["/util/util.js","/svc/cdn/pub/util.js","/util/storage.js","/util/date.js","/util/etask.js","/util/url.js","/util/events.js","/util/array.js","/util/escape.js","/util/rand.js","/util/hash.js"],function(zutil,util,storage,date,etask,zurl,events,array,zescape,rand,hash){var E={};var KB=1024,assign=Object.assign;var ms_since=util.ms_since;var ERR=util.ERR;E.version="5";E.pool=[];E.Cdn=function Cdn(opt){opt=opt||{};if(!(this instanceof E.Cdn))return new E.Cdn(opt);var info=E.all_agents&&E.all_agents.get(opt.host)||{};this.ms_hdrs=this.bpms=this.bytes=this.fail=0;this.success=this.delayed=this.aborted_bytes=0;this.aborted=this.ttfb_n=this.ttfb=this.ranges_supported=0;this.enabled=1;this.cache={hit:{},miss:{}};this.cost=+opt.cost||info.cost;this.req_uid=opt.req_uid||0;this.uid=opt.uid;this.role=opt.role||info.role;this.origin=opt.origin;this.master=opt.master;this.owner=opt.owner||info.owner;this.host=opt.host;this.type=opt.type||info.type;this.country=opt.country||info.country;this.disconnect=this.disconnect_wait=this.disconnect_ts=0;this.busy=this.busy_wait=this.busy_ts=0;this.hostname=opt.hostname||info.hostname||opt.host;this.name=opt.name||opt.hostname||this.host;this.id="cw"+this.uid;this.learning=assign({},opt.learning);this.progress_bw={bw:0,samples:[],max:opt.max_samples||50};this.success_ts=this.fail_ts=0;this.split=this.split||{};if(opt.progress_bw)this.set_progress_bw(opt.progress_bw);E.pool.push(this);this.zone_specific={};return this};zutil.inherits(E.Cdn,events.EventEmitter);E.Cdn.prototype.using=function(zone){var _this=this,zname=zone.CG("zone")||zone.id;var zctx=this.zone_specific[zname]=this.zone_specific[zname]||{};return zctx.api=zctx.api||{is_head_unsupported:function(){return _this.head_unsupported||_this.is_origin()&&(zone.CG("cdn.send_reqs.origin.head_unsupported")||zone.CG("cdn.send_reqs.origin.auto_head_unsupported")||_this.hostname.search("brightcove")>-1)},is_ranges_unsupported:function(){return!_this.ranges_supported&&(_this.ranges_unsupported||_this.is_origin()&&(zone.CG("cdn.send_reqs.origin.ranges_unsupported")||zone.CG("cdn.send_reqs.origin.auto_ranges_unsupported")))},get_ws:function(){return zctx.ws},get_ws_stats:function(){return zctx.ws_stats},add_ws_listener:function(){if(!_this.is_hola()||_this.is_bootstrap()||typeof WebSocket!="function"){return}if(!zctx.ws){zctx.ws_stats={};zctx.ws=open_ws_listener(zone,_this,zctx.ws_stats,location.protocol)}zctx.ws_ref=(zctx.ws_ref||0)+1;return zctx.ws},remove_ws_listener:function(){if(!zctx.ws||--zctx.ws_ref)return;zctx.ws.close();zctx.ws.removeAllListeners();zctx.ws=zctx.ws.ws=zctx.ws_stats=undefined},send:function(cmd,route,data,cb,opt){if(typeof route=="function"){opt=cb;cb=route;data=route=undefined}else if(typeof data=="function"){opt=cb;cb=data;data=undefined}opt=opt||{};route=assign({ver:util.ver},util.has_ext?{ext:true}:{},route);if(opt.ws_only||!opt.xhr_only){if(zctx.ws&&zctx.ws.is_ready())return this.send_ws(cmd,route,data,cb);else if(opt.ws_only)return}return this.send_xhr("cmd/"+cmd,route,data,cb)},send_ws:function(cmd,route,data,cb){var ts=date.monotonic();if(zctx.ws){zctx.ws.send(cmd,route,data,function(res){if(!cb)return;cb({cmd:cmd,data:data||{},res:res&&!res.err?res:null,err:res?res.err:"fail",cdn:_this,elapsed:date.monotonic()-ts})})}else if(cb){cb({cdn:_this,cmd:cmd,data:data||{},err:"no open websocket"})}},send_xhr:function(cmd,route,data,cb){var __this=this,ts=date.monotonic();return etask({name:"cdn_send",cancel:true},[function(){var qs=assign({customer:zone.CG("customer")||util.conf.customer,zone:zone.CG("zone")},route);return __this.send_xhr_raw("/"+cmd+"?"+zescape.qs(qs),{data:data})},function(res){var ret={cmd:cmd,opt:data||{},res:res&&res.res,err:res?res.err:"fail",cdn:zutil.is_mocha()?undefined:_this,elapsed:date.monotonic()-ts};if(cb)cb(ret);return ret}])},send_xhr_raw:function(url,opt){opt=opt||{};return etask({name:"cdn_send_xhr_raw",cancel:true},[function(){var protocol=zone.CG("loader.https_xhr_only")?"https:":util.protocol;var host=protocol=="https:"?_this.hostname:_this.host;var _opt={url:protocol+"//"+host+url,response_type:"json",timeout:opt.timeout||6e4,data:opt.data};return util.fetch_bin(_opt)},function(res){var data=res&&res.status==200?{url:url,res:res.data}:null;if(opt.cb)opt.cb(data);return data}])},uninit:function(){this.remove_ws_listener();if(!zctx.ws)_this.zone_specific[zname]=undefined}}};E.Cdn.prototype.get_progress_bw=function(){return this.progress_bw.bw};E.Cdn.prototype.set_progress_bw=function(bw){if(!bw)return;this.progress_bw.samples.push(bw);if(this.progress_bw.samples.length>this.progress_bw.max)this.progress_bw.samples.splice(0,Math.round(this.progress_bw.max/2));var sum=0;this.progress_bw.samples.forEach(function(a){sum+=a});this.progress_bw.bw=Math.round(sum/this.progress_bw.samples.length)};E.Cdn.prototype.is_hola=function(){return this.owner=="hola"};E.Cdn.prototype.is_origin=function(){return this.origin};E.Cdn.prototype.is_master=function(){return this.master};E.Cdn.prototype.is_single=function(){return this.role=="single_copy"};E.Cdn.prototype.is_fast=function(){return this.role=="fast"};E.Cdn.prototype.is_dedicated_fast=function(){return["fast","efast"].includes(this.type)};E.Cdn.prototype.is_efast=function(){return this.type=="efast"};E.Cdn.prototype.is_bootstrap=function(){return this.role=="bootstrap"};E.Cdn.prototype.is_usable=function(){return this.is_enabled()&&!this.is_disconnected()&&!this.is_busy()};E.Cdn.prototype.is_enabled=function(){return this.enabled};E.Cdn.prototype.is_failed=function(){return(!this.success_ts||this.fail_ts>this.success_ts)&&this.fail_ts&&date.monotonic()-this.fail_ts<10*date.ms.MIN?this.fail:0};E.Cdn.prototype.enable=function(){this.enabled=1};E.Cdn.prototype.disable=function(){this.enabled=0};E.Cdn.prototype.update_from_hdrs=function(hdrs){hdrs=hdrs||[];this.update_cache_type(hdrs["x-cache"]);this.update_hola_resp(hdrs["x-hola-resp"])};E.Cdn.prototype.update_hola_resp=function(s){var resp=zescape.parse.http_words(s);for(var i=0;i<resp.length;i++){if(resp[i][0]=="ttfb")this.ttfb=resp[i][1];else if(resp[i][0]=="cache")this.update_cache_type(resp[i][1]);else if(resp[i][0]=="age")this.age=resp[i][1]}};E.Cdn.prototype.need_bw_info=function(){return!this.ms_hdrs||this.is_bw_from_cache()};E.Cdn.prototype.is_bw_from_cache=function(){return this.cache_flag&&this.cache[this.cache_flag].from_cache};E.Cdn.prototype.update_cache_type=function(cache_flag){cache_flag=cache_flag?cache_flag.toLowerCase():"hit";if(!["hit","miss"].includes(cache_flag)||cache_flag==this.cache_flag)return;var prev=this.cache_flag;this.cache_flag=cache_flag;if(!prev)return;if(!this.bpms||this.cache[this.cache_flag].bpms)this.bpms=this.cache[this.cache_flag].bpms;if(!this.ms_hdrs||this.cache[this.cache_flag].ms_hdrs)this.ms_hdrs=this.cache[this.cache_flag].ms_hdrs};E.Cdn.prototype.rate=function(sz){return Math.round((sz||512*KB)/this.bpms)};E.Cdn.prototype.set_error=function(err){if(err==ERR.head_unsupported)this.head_unsupported=true;else if(err==ERR.ranges_unsupported)this.ranges_unsupported=true};E.Cdn.prototype.can_get=function(sz,sec,opt){opt=opt||{};var ms=sec*date.ms.SEC;return(!this.bpms||opt.by_hdrs)&&this.ms_hdrs&&this.ms_hdrs<=ms*.4?true:this.calc_ttc(sz)+500<=ms};E.Cdn.prototype.calc_ttc=function(sz){return!sz?this.ms_hdrs||Infinity:this.bpms?Math.round(sz/this.bpms):Infinity};E.Cdn.prototype.bps=function(){return date.ms.SEC*this.bpms};E.Cdn.prototype.compare=function(cdn2,opt){var _this=this;function log(s,r){if(opt.log)opt.log.info(s+(r?" ret "+r:""));return r}function logt(s){return log(_this.id+" "+s,-1)}function logo(s){return log(cdn2.id+" "+s,1)}log("compare "+this.id+" to "+(cdn2?cdn2.id:"unknown")+" sz "+opt.sz+" sec "+opt.sec);if(!cdn2)return logt("cdn2 missing ");var can_get=opt.sz&&opt.sec?!opt.fastest||this.bpms?this.can_get(opt.sz,opt.sec):false:true;var can_get2=opt.sz&&opt.sec?!opt.fastest||cdn2.bpms?cdn2.can_get(opt.sz,opt.sec):false:true;var bpms=this.bpms,bpms2=cdn2.bpms,hdrs=this.ms_hdrs;var hdrs2=cdn2.ms_hdrs;if(can_get!=can_get2){return can_get?logt("can get "+bpms+">"+bpms2):logo("can get "+bpms2+">"+bpms)}if(this.bpms&&!this.is_bw_from_cache()&&(cdn2.is_bw_from_cache()||!cdn2.bpms)&&can_get){return logt("bpms "+this.bpms+" cdn2 from cache or no bpms")}if((!this.bpms||this.is_bw_from_cache())&&cdn2.bpms&&!cdn2.is_bw_from_cache()&&can_get2){return logo("bpms "+cdn2.bpms+" "+this.id+" from cache or no bpms")}if(this.host==cdn2.host||!bpms&&!bpms2&&!hdrs&&!hdrs2)return log("identical",0);if(!hdrs||!hdrs2)return!hdrs?logo("hdrs "+hdrs2):logt("hdrs "+hdrs);if(!bpms||!bpms2){return bpms&&can_get?logt("bpms "+bpms+" and can get"):bpms2&&can_get2?logo("bpms "+bpms2+" and can get"):hdrs==hdrs2?bpms?logt("same hdrs and bpms "+bpms):bpms2?logo("same hdrs and bpms "+bpms2):log("hdrs identical",0):log("hdrs "+hdrs+" hdrs2 "+hdrs2,hdrs-hdrs2*(opt.ratio||1))}return Math.round(opt.rate?log("rate comparison "+this.rate(opt.sz)+" "+cdn2.rate(opt.sz),this.rate(opt.sz)-cdn2.rate(opt.sz)*(opt.ratio||1)):opt.bps?log("bps comparison "+this.bps()+" "+cdn2.bps(),cdn2.bps()-this.bps()*(opt.ratio||1)):log("bpms comparison "+bpms+" "+cdn2.bpms,cdn2.bpms-this.bpms))};E.Cdn.prototype.compare_rate=function(cdn2,opt){return this.compare(cdn2,assign(opt||{},{rate:true}))};E.Cdn.prototype.compare_bps=function(cdn2,opt){return this.compare(cdn2,assign(opt||{},{bps:true}))};E.Cdn.prototype.set_busy=function(){this.busy++;this.busy_ts=date.monotonic();this.busy_wait=Math.min(this.busy_wait?this.busy_wait*2:2e3,64e3);this.emit("busy")};E.Cdn.prototype.disconnected=function(){this.disconnect++;this.disconnect_ts=date.monotonic();this.disconnect_wait=Math.min(this.disconnect_wait?this.disconnect_wait*2:2e3,64e3);this.emit("disconnect")};E.Cdn.prototype.failed=function(err,adaptive){var disable=err==ERR.ranges_unsupported&&!adaptive||this.is_single();if(this.is_failed()||disable)this.enabled=0;this.fail++;this.fail_ts=date.monotonic();this.emit("failed")};function open_ws_listener(zone,cdn,ws_stats,protocol){if(!ws_stats.ts){assign(ws_stats,{pending:1,failed:0,connected:0,to_https:0,lag:0,ts:date()})}var ws=new util.ws(protocol=="https:"?cdn.hostname:cdn.host,{path:"ws_client",customer:zone.CG("customer"),zone:zone.CG("zone"),minor:true,protocol:protocol=="https:"?"wss":"ws",timeout:protocol=="http:",log:zone.log});if(!ws){ws_stats.pending=0;ws_stats.failed=1;return ws}ws.on("message",function(data){cdn.emit("message",data);cdn.emit("message."+data.cmd,data)});ws.on("open",function(){ws_stats.pending=0;ws_stats.connected=1;ws_stats.lag=Date.now()-ws_stats.ts});if(protocol=="http:"){ws.on("error",function(){ws_stats.to_https=1;open_ws_listener(zone,cdn,ws_stats,"https:")})}if(protocol=="https:"){ws.on("error",function(){ws_stats.pending=0;ws_stats.failed=1})}return ws}E.Cdn.prototype.on_too_slow=function(cache_hit){this.learning.too_slow=this.learning.too_slow||0;this.learning.too_slow++;if(!cache_hit)return;var ip=util.geoip.ip;if(ip&&!this.split[ip]){this.learning.split=this.learning.split||{};if(this.learning.split[ip]=="testing")this.split[ip]="failed";else this.learning.split[ip]="testing"}};E.Cdn.prototype.is_busy=function(){return ms_since(this.busy_ts)<=this.busy_wait};E.Cdn.prototype.is_disconnected=function(){return ms_since(this.disconnect_ts)<=this.disconnect_wait};E.Cdn.prototype.ttfb=function(){return this.ttfb/this.ttfb_n};E.Cdn.prototype.set_ttfb=function(ttfb){this.ttfb_n++;this.ttfb+=ttfb};E.Cdn.prototype.update_stats=function(opt){if(!opt.ms_hdrs&&this.ms_hdrs){if(opt.elapsed<this.ms_hdrs)return;opt.ms_hdrs=opt.elapsed}opt.ms=opt.ms||opt.elapsed-opt.ms_hdrs;this.update_stream_stats(opt);if(!opt.final)return;this.update_cache_stats(opt);if(!opt.error||opt.rate&&this.is_origin()){this.success++;this.success_ts=date.monotonic()}if(!opt.error&&opt.range)this.ranges_supported++;this.bytes+=opt.sz;if(opt.rate)this.rate_bytes=(this.rate_bytes||0)+opt.sz};E.Cdn.prototype.update_stream_stats=function(opt){var ms_hdrs=opt.ms_hdrs,ms=opt.ms,sz=opt.sz,elapsed=opt.elapsed;if(!ms_hdrs&&(!this.ms_hdrs||elapsed<=this.ms_hdrs))return;var replace=opt.replace||this.ms_hdrs<ms_hdrs/2||this.ms_hdrs>ms_hdrs*2;var overwrite=!this.ms_hdrs||this.is_bw_from_cache()||replace;var new_ms_hdrs=overwrite?ms_hdrs:Math.round((this.ms_hdrs+ms_hdrs)/2);if(opt.final)this.ms_hdrs=new_ms_hdrs;if(opt.final&&!sz)return this.bpms=overwrite?0:this.bpms;if(!sz&&(!this.bpms||!ms_hdrs)||sz<64*KB&&opt.ttc<Infinity&&elapsed<opt.ttc/2){return}this.ms_hdrs=new_ms_hdrs;var bpms=sz/(ms+ms_hdrs);replace=replace||this.bpms<bpms/2||this.bpms>bpms*2;overwrite=!this.bpms||this.is_bw_from_cache()||replace;this.bpms=Math.round(overwrite?bpms:(this.bpms+bpms)/2)};E.Cdn.prototype.update_cache_stats=function(opt){var ms_hdrs=opt.ms_hdrs,ms=opt.ms,sz=opt.sz,elapsed=opt.elapsed;if(!ms_hdrs&&(!this.ms_hdrs||elapsed<=this.ms_hdrs))return;if(opt.rate&&!ms_hdrs||!opt.rate&&(!sz&&(!this.bpms||!ms_hdrs)||sz<64*KB&&elapsed<opt.ttc/2||ms_hdrs==elapsed)){return}var set=this.cache[this.cache_flag||"hit"],bpms=sz/(ms+ms_hdrs);var prev_rate=Math.round(512*KB/set.bpms);var replace=opt.replace||this.ms_hdrs<ms_hdrs/2||this.ms_hdrs>ms_hdrs*2;set.ms_hdrs=!set.ms_hdrs?ms_hdrs:Math.round((set.ms_hdrs*2+ms_hdrs)/3);if(opt.rate)return this.bpms=replace?0:this.bpms;set.from_cache=undefined;var new_rate=Math.round(512*KB/bpms);if(prev_rate<=new_rate*(opt.rate_decrease||.7))this.emit("rate_decrease",this,prev_rate/new_rate);replace=replace||this.bpms<bpms/2||this.bpms>bpms*2;set.bpms=Math.round(!set.bpms||replace?bpms:(set.bpms*2+bpms)/3);set.bytes=(set.bytes||0)+sz};E.Cdn_list=function Cdn_list(opt){if(!(this instanceof E.Cdn_list))return new E.Cdn_list(opt);var _this=this;opt=opt||{};this.arr=[];this.uid=opt.uid||(E.bootstraps?E.bootstraps.uid:1);this.save_to=opt.save_to;this.length=0;this.zone=opt.zone;this.zperr=opt.zone.perr_get();this.log=opt.zone.log_get().set_module("cdnlist");this.on_cdn_message=function(data){var cdn=this;_this.emit("message",cdn,data);_this.emit("message."+data.cmd,cdn,data)};this.add(opt.cdns,opt.role);return this};zutil.inherits(E.Cdn_list,events.EventEmitter);E.Cdn_list.prototype.find=function(func,a){for(var i=0;i<this.arr.length;i++){if(func.call(a,this.arr[i]))return this.arr[i]}};E.Cdn_list.prototype.count=function(cond){var count=0;for(var i=0;i<this.arr.length;i++)count+=!!cond(this.arr[i]);return count};E.Cdn_list.prototype.remove_ws_listener=function(){this.arr.forEach(function(cdn){cdn.using(this.zone).remove_ws_listener()},this)};E.Cdn_list.prototype.some=function(func,a){return this.arr.some(func,a)};E.Cdn_list.prototype.every=function(func,a){return this.arr.every(func,a)};E.Cdn_list.prototype.forEach=function(func,a){this.arr.forEach(func,a)};E.Cdn_list.prototype.filter=function(func,a){return this.arr.filter(func,a)};E.Cdn_list.prototype.add_origin=function(cdn){this.add([{host:cdn.host,cost:cdn.cost||this.zone.CG("cdn.send_reqs.origin.cost")||5,origin:true}]);return this.get_by_host(cdn.host)};E.Cdn_list.prototype.send=function(cmd,route,data,cb,opt){opt=opt||{};var timer=0,timers=[],done,resps=0,_this=this;function _cb(res){resps++;if(!res||res.err||done)return;done=opt.wait_for_all?resps==_this.length:true;if(done)timers.forEach(function(t){clearTimeout(t)});if(cb)cb(res&&res.timeout?{err:"timeout"}:res)}this.forEach(function(cdn,index){timers.push(setTimeout(function(){if(opt.on_req)opt.on_req(index);cdn.using(_this.zone).send(cmd,route,data,function(res){if(opt.on_res)opt.on_res(index,res);_cb(res)},opt)},timer));timer+=opt.gap_ms===undefined?300:opt.gap_ms});timers.push(setTimeout(_cb.bind(null,{timeout:true}),opt.timeout||5e3))};E.Cdn_list.prototype.send_xhr=function(cmd,route,data,cb){this.forEach(function(cdn){cdn.using(this.zone).send_xhr(cmd,route,data,cb)},this)};E.Cdn_list.prototype.ping=function(opt){opt=opt||{};var _this=this,ret;return etask({name:"ping",cancel:true},[function(){var sp=this,missing;function has_ping_ms(cdn){return cdn.ping_ms&&(Date.now()-cdn.ping_ts<=opt.stale_ms||15*date.ms.MIN)&&!opt.force}function get_fastest(){var res={};_this.forEach(function(cdn){if(has_ping_ms(cdn)){res.cdn=!res.cdn?cdn:cdn.ping_ms<res.cdn.ping_ms?cdn:res.cdn}else res.missing=true});return res}var r=get_fastest();if(!r.missing&&r.cdn)return this.return(r.cdn);_this.forEach(function(cdn){if(has_ping_ms(cdn))return;cdn.using(_this.zone).send("ping",function(res){cdn.ping_ms=res.elapsed();cdn.ping_ts=Date.now();if(!ret){ret=get_fastest();sp.return(ret.cdn)}})});return this.wait(opt.timeout||5e3)},function catch$(err){_this.log.debug("ping failed "+err)}])};E.Cdn_list.prototype.has_usable=function(){return this.arr.some(function(cdn){return cdn.is_enabled()})};E.Cdn_list.prototype.has=function(host){return!!this.get_by_host(host)};E.Cdn_list.prototype.can_get_by_hola=function(sz,sec,allow_fast){return this.can_get(sz,sec,function(){return(allow_fast||!this.is_fast())&&this.is_hola()})};E.Cdn_list.prototype.can_get_by_origin=function(sz,sec){return this.can_get(sz,sec,function(){return this.is_origin()})};E.Cdn_list.prototype.can_get=function(sz,sec,filter_fn){return this.arr.some(function(cdn){return!filter_fn||filter_fn.apply(cdn)?cdn.can_get(sz,sec):false})};E.Cdn_list.prototype.stats=function(opt){var stats=[];opt=opt||{};for(var i=0;i<this.arr.length;i++){var cdn=this.arr[i];var reset_snapshot=this.reset_snapshot&&this.reset_snapshot.cdn[i];var cdn_stats={bpms:cdn.bpms,ms_hdrs:cdn.ms_hdrs,bytes:cdn.bytes,fail:cdn.fail,enabled:cdn.enabled,success:cdn.success,cost:cdn.cost,delayed:cdn.delayed,name:cdn.name,owner:cdn.owner,cache_hit:cdn.cache.hit.bytes,cache_miss:cdn.cache.miss.bytes,aborted:cdn.aborted,aborted_bytes:cdn.aborted_bytes,host:cdn.host,bps:cdn.bps(),role:cdn.role,country:cdn.country,age:cdn.age,too_slow:cdn.learning.too_slow};if(!opt.from_start&&reset_snapshot)cdn_stats=reset_snapshot.diff(cdn_stats);stats.push(cdn_stats)}return stats};E.Cdn_list.prototype.ws_stats=function(opt){var ret={connected:0,pending:0,failed:0,lag:0};opt=opt||{};for(var i=0;i<this.arr.length;i++){var ws_stats=this.arr[i].using(this.zone).get_ws_stats();if(!ws_stats)continue;ret.connected+=ws_stats.connected;ret.pending+=ws_stats.pending;ret.failed+=ws_stats.failed;ret.lag+=ws_stats.lag}if(!opt.from_start&&this.reset_snapshot)ret=this.reset_snapshot.ws.diff(ret);return ret};E.Cdn_list.prototype.reset_stats=function(){this.reset_snapshot={cdn:this.stats({from_start:true}).map(function(cdn_stats){return util.data_snapshot(cdn_stats,["bytes","rate_bytes","cache_hit","cache_miss","cache_revalidate","aborted","aborted_bytes","too_slow"])}),ws:util.data_snapshot(this.ws_stats({from_start:true}))}};E.Cdn_list.prototype.add=function(cdns,role){if(!cdns)return;var _this=this;function add_cdn(opt){var host=opt.host.toLowerCase();var c=_this.get_by_host(host);if(c){if(c.is_fast()&&opt.role!="fast"){_this.log.debug("changed cdn cw"+c.uid+" role "+c.role+"->"+opt.role);c.role=opt.role;c.cost=opt.cost}c.alt_fast=c.is_single()&&opt.role=="fast";c.master=c.master||opt.master;return}var cdn=E.pool.find(function(c){return c.host==host});if(!cdn){var uid=opt.uid||_this.uid;opt.req_uid=opt.req_uid||(cdn?cdn.req_uid:null);assign(opt,{uid:uid,host:host});cdn=new E.Cdn(assign({role:role,log:_this.log},opt));if(!opt.uid||opt.uid==_this.uid)_this.uid++}else if(_this.save_to!=cdn.save_to){cdn.role=opt.role||role;cdn.master=cdn.master||opt.master}cdn.on("message",_this.on_cdn_message);cdn.using(_this.zone).add_ws_listener();_this.update_from_cache(cdn);_this.arr.push(cdn);var cdn_str=JSON.stringify(opt,function(k,v){if(k!="ws")return v});_this.log.debug("added cdn "+cdn_str+" bw "+cdn.get_progress_bw()+" uid "+cdn.uid+" cost "+cdn.cost);_this.emit("cdn_added",cdn)}var src=Array.isArray(cdns)?cdns:cdns.arr;for(var i=0;i<src.length;i++)add_cdn(src[i]);this.arr.sort(function(a,b){return a.cost-b.cost});this.length=this.arr.length};E.Cdn_list.prototype.have_best_cdn_candidates=function(){var candidates=0;this.arr.forEach(function(cdn){if(cdn.bpms&&cdn.is_enabled())candidates++},this);return candidates};E.Cdn_list.prototype.get_lowcost_cdn=function(sz,sec,allow_fast,replace){var lowest,usable,pending,disc_cdn,debug,_this=this;if(zutil.is_mocha()&&this.jtest_lowcost_cdn){var cdn=this.get_by_uid(this.jtest_lowcost_cdn);return{lowcost:cdn,lowcost_usable:cdn}}function log(s,r){if(debug){_this.log.info(s+(r?" ret "+(typeof r=="object"?"json":r):""))}return r}this.arr.forEach(function(cdn){log("checking cdn "+cdn.id+" can_get sz "+sz+" sec "+sec+" "+cdn.can_get(sz,sec)+" cost "+cdn.cost+" bpms "+cdn.bpms+" ms_hdrs "+cdn.ms_hdrs);if(this.zone.CG("cdn.send_reqs.origin_only")&&!cdn.is_origin())return;if(!cdn.is_enabled()||!allow_fast&&cdn.is_fast())return log(cdn.id+" not usable");cdn=this.get_replacement(cdn,replace);if((!usable||cdn.cost<usable.cost||cdn.cost==usable.cost&&cdn.compare_rate(usable,{log:debug&&this.log})<0)&&cdn.can_get(sz,sec)){if(cdn.is_usable()){log("chosen "+cdn.id+" type usable");usable=cdn}else if(ms_since(cdn.disconnect_ts)>2e3&&ms_since(cdn.busy_ts)>2e3&&(!disc_cdn||cdn.compare_rate(disc_cdn,{sz:sz,sec:sec,log:debug&&this.log})<0)){log("chosen "+cdn.id+" type disconnected");disc_cdn=cdn}}if((!pending||cdn.cost<pending.cost)&&!cdn.bpms)pending=cdn;if(lowest&&lowest.cost<cdn.cost)return void log("higher cost than lowest "+lowest.id);if(!lowest||cdn.cost<lowest.cost||cdn.compare_rate(lowest,{log:debug&&this.log})<0){log("chosen "+cdn.id+" type lowest");lowest=cdn}},this);return log("choice lowest "+(lowest?lowest.id:"none")+" lowcost_usable "+(usable||disc_cdn?(usable||disc_cdn).id:"none")+" pending "+(pending?pending.id:"none"),{lowcost:lowest?lowest.replaced||lowest:null,lowcost_usable:usable?usable.replaced||usable:disc_cdn?disc_cdn.replaced||disc_cdn:null,pending:pending?pending.replaced||pending:null})};E.Cdn_list.prototype.get_best_cdn_bw=function(opt){var best_cdn=this.get_best_cdn("get_best_cdn_bw",opt);return best_cdn?best_cdn.bps():0};E.Cdn_list.prototype.get_best_cdn_bw_bits=function(opt){return this.get_best_cdn_bw(opt)*8};E.Cdn_list.prototype.is_origin_disconnected=function(opt){return this.every(function(cdn){return!cdn.is_origin()||cdn.is_disconnected()})};E.Cdn_list.prototype.hola_fast_usable=function(opt){return this.hola_usable({fast:true})};E.Cdn_list.prototype.hola_single_usable=function(opt){return this.hola_usable({single:true})};E.Cdn_list.prototype.hola_usable=function(opt){opt=opt||{};var count=0;this.arr.forEach(function(cdn){count+=cdn.is_hola()&&cdn.is_usable()&&(!opt.fast&&(!opt.single||cdn.is_single()))&&(!opt.single&&(!opt.fast||cdn.is_fast()))});return count};E.Cdn_list.prototype.count_single_busy=function(opt){return this.count_busy({single:true})};E.Cdn_list.prototype.count_busy=function(opt){opt=opt||{};var count=0;this.arr.forEach(function(cdn){count+=cdn.is_hola()&&cdn.is_enabled()&&cdn.is_busy()&&(!opt.single||cdn.is_single())});return count};E.Cdn_list.prototype.is_busy=function(opt){return this.every(function(cdn){return!cdn.is_enabled()||!cdn.is_hola()||cdn.is_busy()})};E.Cdn_list.prototype.is_disconnected=function(opt){return this.every(function(cdn){return cdn.is_disconnected()})};E.Cdn_list.prototype.is_disconnected_on_start=function(opt){return this.every(function(cdn){return!cdn.bytes&&cdn.is_disconnected()})};E.Cdn_list.prototype.get_replacement=function(cdn,replace){var r;if(!replace||!(r=replace.find(function(c){return c.id==cdn.id})))return cdn;var _cdn=zutil.clone_deep(cdn);_cdn.bpms=r.bpms;_cdn.ms_hdrs=r.ms_hdrs;_cdn.replaced=cdn;return _cdn};E.Cdn_list.prototype.get_best_cdn=function(caller,opt){var debug,log=debug?this.log.info:function(){};opt=opt||{};log("get_best_cdn caller "+caller+" opt "+JSON.stringify(opt));if(zutil.is_mocha()&&this.jtest_best_cdn){var cdn=this.get_by_uid(this.jtest_best_cdn);log("chose "+cdn.id+" by jtest_best_cdn");return cdn}var best_cdn,disc_cdn;this.arr.forEach(function(cdn){cdn=this.get_replacement(cdn,opt.replace);var no_ranges=cdn.using(this.zone).is_ranges_unsupported();var sz=no_ranges?opt.fs||opt.sz:opt.sz;log("test cdn "+cdn.id+" usable "+cdn.is_enabled()+" hdrs "+cdn.ms_hdrs+" fast "+cdn.is_fast()+" prev_bpms "+cdn.prev_bpms+" bpms "+cdn.bpms+" best "+(best_cdn&&best_cdn.id)+" ttc "+cdn.calc_ttc(sz)+" for sec "+opt.sec+" sz "+sz);if(this.zone.CG("cdn.send_reqs.origin_only")&&!cdn.is_origin())return;if(opt.ranges_supported&&no_ranges)return;if(cdn.ms_hdrs&&cdn.is_enabled()&&(opt.allow_fast||!cdn.is_fast())&&(!opt.no_cache||!cdn.is_bw_from_cache())&&(!best_cdn||best_cdn.is_failed()>cdn.is_failed()||best_cdn.is_failed()==cdn.is_failed()&&cdn.compare_rate(best_cdn,{sz:sz,sec:opt.sec,log:(debug||opt.debug)&&this.log})<0)){log("chose "+cdn.id+" disconnected "+cdn.is_disconnected());if(cdn.is_usable())best_cdn=cdn;else if(ms_since(cdn.disconnect_ts)>2e3&&ms_since(cdn.busy_ts)>2e3&&(!disc_cdn||cdn.compare_rate(disc_cdn,{sz:sz,sec:opt.sec,log:(debug||opt.debug)&&this.log})<0)){disc_cdn=cdn}}},this);best_cdn=best_cdn||disc_cdn;if(this.prev_best_cdn!==best_cdn){this.emit("new_best_cdn",best_cdn);this.log.debug("new best_cdn "+(best_cdn?best_cdn.id:"none")+" bpms "+(best_cdn?best_cdn.bpms:0)+" hdrs "+(best_cdn?best_cdn.ms_hdrs:0)+" rate "+(best_cdn?best_cdn.rate():0)+" caller "+caller)}this.prev_best_cdn=best_cdn;return best_cdn?best_cdn.replaced||best_cdn:null};E.Cdn_list.prototype.get_by_id=function(id){return this.find(function(cdn){return cdn.id==id})};E.Cdn_list.prototype.get_by_host=function(host){return this.find(function(cdn){return cdn.host==host||cdn.redir_host==host||cdn.name==host||cdn.hostname==host})};E.Cdn_list.prototype.get_by_uid=function(uid){return this.find(function(cdn){return cdn.uid==uid})};E.Cdn_list.prototype.get_origin=function(){return this.find(function(cdn){return cdn.origin})};E.Cdn_list.prototype.get_master=function(){return this.find(function(cdn){return cdn.master})};E.Cdn_list.prototype.read_storage=function(){if(!this.save_to)return{cdns:{}};var data=storage.get_json(this.save_to);if(!data||data.version!=E.version){this.log.debug("cdn cache "+(!data?"not found":"version mismatch "+data.version+"!="+E.version));return{cdns:{}}}return data};E.Cdn_list.prototype.update_from_cache=function(cdn){if(!this.cache)this.cache=this.read_storage();cdn.cache=this.cache.cdns[cdn.host]||{success_ts:0,hit:{bpms:0,ms_hdrs:0,bytes:0},miss:{bpms:0,ms_hdrs:0,bytes:0},delayed:0,success:0};cdn.cache.hit=cdn.cache.hit||{};cdn.cache.miss=cdn.cache.miss||{};cdn.save_to=this.save_to;if(cdn.success_ts>=cdn.cache.success_ts)return;cdn.cache_flag=cdn.cache.hit.bpms||!cdn.cache.miss.bpms?"hit":"miss";var cache=cdn.cache[cdn.cache_flag];cdn.bpms=cache.bpms||cdn.bpms;cdn.ms_hdrs=cache.ms_hdrs||cdn.ms_hdrs;if(!zutil.is_mocha()||!util.jtest.snapshot)cdn.cache.hit.from_cache=cdn.cache.miss.from_cache=true;cdn.delayed=cdn.cache.delayed||cdn.delayed;cdn.success=cdn.cache.success||cdn.success;cdn.ranges_supported=cdn.cache.ranges_supported||cdn.ranges_supported;cdn.success_ts=cdn.cache.success_ts||cdn.success_ts;if(cdn.cache.progress_bw)cdn.set_progress_bw(cdn.cache.progress_bw)};E.Cdn_list.prototype.to_json=function(){var json={};for(var i=0;i<this.arr.length;i++){var cdn=this.arr[i];json[cdn.host]={fail:cdn.fail,hit:zutil.clone_deep(cdn.cache.hit||{}),miss:zutil.clone_deep(cdn.cache.miss||{}),delayed:cdn.delayed,success:cdn.success,cost:cdn.cost,role:cdn.role,origin:cdn.origin,owner:cdn.owner,success_ts:cdn.success_ts,ttfb_n:cdn.ttfb_n,progress_bw:cdn.get_progress_bw(),fail_ts:cdn.fail_ts,ttfb:cdn.ttfb,ranges_supported:cdn.ranges_supported}}return json};E.Cdn_list.prototype.save=function(opt){if(!this.save_to)return;opt=opt||{};var now=date.monotonic(),cdn;if(!opt.close&&now-this.last_save<=5*date.ms.SEC)return;var data=this.read_storage();assign(data.cdns,this.to_json());try{while(JSON.stringify(data)>this.max_size){var oldest;for(cdn in data.cdns){if(!oldest||data[cdn].success_ts<data[oldest].success_ts)oldest=cdn}if(oldest)delete this.data.cdns[cdn]}data.version=E.version;storage.set_json(this.save_to,data);this.last_save=now;this.log.debug("saved "+JSON.stringify(data))}catch(e){this.zperr({id:"cdn_cache_err_failed_save",err:e});storage.clr(this.save_to)}};E.Cdn_list.prototype.uninit=function(){this.forEach(function(cdn){cdn.off("message",this.on_cdn_message);cdn.using(this.zone).uninit()},this)};E.init=function(bootstraps,zone,all_agents){E.all_agents=typeof all_agents!="object"?{}:all_agents;E.all_agents.get=function(host){var ret;if(this.single&&(ret=this.single.find(function(c){return c.host==host}))||this.fast&&(ret=this.fast.find(function(c){return c.host==host}))||this.efast&&(ret=this.efast.find(function(c){return c.host==host}))){ret.owner="hola";ret.role=["fast","efast"].includes(ret.type)?"fast":"single_copy"}return ret}.bind(E.all_agents);for(var i=0;i<bootstraps.length;i++){bootstraps[i].owner="hola";bootstraps[i].cost=1}var bootstrap_cdns=bootstraps?new E.Cdn_list({cdns:bootstraps,zone:zone,role:"bootstrap"}):undefined;if(bootstrap_cdns)util.on("beforeunload",function(){bootstrap_cdns.uninit()});E.bootstraps=bootstrap_cdns};E.uninit=function(){if(E.bootstraps)E.bootstraps.uninit();E.bootstraps=undefined};E.url2cdns=function(url,timeout,cdns,zone){if(!E.bootstraps)return;var zperr=zone.perr_get();var zlog=zone.log_get().set_module("cdnlist");var bootstraps=E.bootstraps.to_json();var keys=Object.keys(bootstraps),limit=Math.min(5,keys.length);var sent=0;var _this,randomize=keys.length>limit;var async=!zutil.is_mocha()&&zone.CG("cdn.url2cdn.async");url=zone.conf_apply("agent.url2vid",[url],url);function send_req(host,_opt){var cdn=E.bootstraps.get_by_host(host);var protocol=zone.CG("loader.https_xhr_only")?"https:":util.protocol;if(protocol=="https:")host=cdn.hostname;var opt={url:protocol+"//"+host+"/cdn_sources?customer="+zone.CG("customer")+"&zone="+zone.CG("zone")+"&url="+encodeURIComponent(url),response_type:"json",method:"GET"};assign(opt,_opt);E.bootstraps.emit("get_cdns",opt,cdn);cdn.req_uid++;_this.spawn(util.fetch_bin(opt));zlog.debug("req init get cdns "+opt.url+" uid cw"+cdn.uid+"/"+opt.uid)}return etask({name:"url2cdns",cancel:true,async:async},[function loop(){_this=this;this.start_ms=date.monotonic();var cache=storage.get_json("hola_bootstrap_cache");if(Array.isArray(cache)&&cache.length){var had=E.bootstraps.get_by_host(cache[0].host);cache[0].uid=!had&&cdns?cdns.uid++:0;E.bootstraps.add([cache[0]],"bootstrap");send_req(cache[0].host,{from_cache:true});sent++;if(!had)limit=Math.min(5,keys.length+1);else array.rm_elm(keys,had.host)}zlog.info("bootstraping inited for "+url+" sending to "+limit+" cdns");if(util.jtest.bootstrap_wait&&zutil.is_mocha())return this.wait()},function(){return etask.for(function(){return sent<limit},function(){sent++},[function(){var index=randomize?Math.floor(Math.random()*keys.length):0;send_req(keys.splice(index,1)[0])}])},function(){return this.wait_child("any",timeout||1e4,function(retval){if(!retval||retval.err){var _url=zurl.parse(this.opt.url);E.bootstraps.emit("get_cdns_end",_url.hostname,this,true)}zlog.info("get_cdns response for "+this.opt.url+" retval "+(retval&&retval.data?"success":retval&&retval.err)+" status "+(this.xhr&&this.xhr.status));return retval&&retval.data})},function(ret){if(!ret)throw new Error("all children failed");var _url=zurl.parse(ret.child.opt.url);E.bootstraps.emit("get_cdns_end",_url.hostname,ret.child);storage.set_json("hola_bootstrap_cache",[{host:_url.hostname}]);return this.return(ret.child.retval)},function catch$(err){zlog.info("bootstrapping failed "+err)},function finally$(){
zperr({id:"get_cdns_ms",info:{zcounter:{level:date.monotonic()-this.start_ms}}})}])};function geo_get_rad(p){if(!p.latitude&&!p.longitude)return;return{lat:p.latitude*Math.PI/180,"long":p.longitude*Math.PI/180}}function filter_efast(zone,shards){var res=[],efast=zone.CG("agent.efast","").toLowerCase().split(" ");shards=shards||[];if(efast[0]=="all")return shards;for(var i=0;i<shards.length;i++){var agent=shards[i];if(efast.includes(agent.country.toLowerCase()))res.push(agent)}return res}function get_dist(p1,p2){var a=Math.pow(Math.sin((p2.lat-p1.lat)/2),2)+Math.pow(Math.sin((p2.long-p1.long)/2),2)*Math.cos(p1.lat)*Math.cos(p2.lat);var dist=Math.floor(6371*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));return dist}function get_closest(shards,geoip,filter){var res=[];for(var i=0;i<shards.length;i++){var shard=shards[i];if(filter&&!filter(shard)||!shard.geo)continue;res.push(assign({dist:get_dist(shard.geo,geoip)},shard))}return res.sort(function(i,j){return i.dist-j.dist})}function whitelist_filter(zone){var wl=zone.CG("agent.whitelist");if(!wl)return;return function(shard){return wl.includes(shard.host)||wl.includes(shard.name)}}function hrw_select(shards,url,ntop,filter){var top=[],key_int=util.hrw_get(url);for(var i=0;i<shards.length;i++){var shard=shards[i];if(filter&&!filter(shard))continue;var rank=util.hrw_rank(shard.hrw,key_int);top.push(assign({rank:rank},shard))}return top.sort(function(i,j){return j.rank-i.rank}).slice(0,ntop)}function cache_url(zone,proxy_url,headers){var _url=zone.conf_apply("agent.url2cache",[proxy_url,headers],util.def_url2cache(proxy_url));if(zone.CG("agent.cache.strip_hostname",true))_url=util.strip_hostname(_url);return _url}function manifest_url(zone,manifest,proxy_url){var _url=zone.conf_apply("agent.manifest2cache",[manifest,proxy_url],util.def_url2cache(manifest));if(zone.CG("agent.cache.strip_hostname",true))_url=util.strip_hostname(_url);return _url}function page_url(zone,page_url,opt){var _url=zone.conf_apply("agent.page2cache",[page_url,assign({},opt,{mobile:util.is_mobile})],util.def_url2cache(page_url));if(zone.CG("agent.pages.strip_proto",true))_url=_url.replace(/^((?:http|https):)?(\/\/)?/i,"http://");return _url}E.get_closest=function(zone,opt){opt=opt||{};return etask([function(){var _this=this;if(!E.bootstraps||util.geoip&&util.geoip.ip)return;E.bootstraps.once("geoip_received",function on_geoip(){_this.continue()});return this.wait()},function(){var cdns=E.local_url2cdns(zone,E.all_agents,util.geoip,"fake.mp4",{fast_limit:5});opt.ret=cdns&&cdns.fast&&cdns.fast.length?new E.Cdn_list({cdns:rand.rand_subset(cdns.fast,Math.min(cdns.fast.length,opt.fast_limit||1)),zone:zone,role:"fast"}):null;return opt.ret},function finally$(){if(opt.cb)opt.cb(opt.ret)}])};E.get_domain_shards=function(zone,agents,domain,opt){var link_shard=zone.CG("agent.pages.link_shard",3);var num_fallbacks=zone.CG("agent.pages.num_fallbacks",2);var shards=agents.single||[];var hrw_fn=opt.hrw_fn||hrw_select;var domain_shards=[],masters=[];var shards_len=Array.isArray(shards)?shards.length:Object.keys(shards).length;for(var s=0;masters.length!==link_shard;s++){var d_shards=hrw_fn(shards,domain+":"+s,1+num_fallbacks,opt.filter);var m=d_shards[0],m_name=m&&(m.hostname||m.host||m.name);if(!m_name)break;if(masters.includes(m_name)&&shards_len>=link_shard)continue;domain_shards.push(d_shards);masters.push(m_name)}return domain_shards};E.page_item_url=function(zone,item,opt){if(zone.is_agent){return zone[item.type=="page"?"page_url":"cache_url"](item.url,opt.headers)}if(item.type=="page")return page_url(zone,item.url,opt);return cache_url(zone,item.url,opt&&opt.headers||{})};E.pages2cdns=function(zone,agents,links,opt){opt=opt||{};var domain_shards={},res={};for(var i=0;i<links.length;i++){var link=links[i],url=link.url;var domain=zurl.parse(url).hostname;var cache=E.page_item_url(zone,link,opt);var shards=domain_shards[domain]||(domain_shards[domain]=E.get_domain_shards(zone,agents,domain,opt));res[url]=shards[hash.hash_string(cache)%shards.length]}return res};E.local_url2cdns=function(zone,agents,_geoip,_url,opt){opt=opt||{};if(zutil.is_mocha()&&util.jtest&&util.jtest.local_url2cdns){util.jtest.local_url2cdns.extra=util.jtest.extra_singles;return util.jtest.local_url2cdns}if(!agents||(!agents.single||!agents.single.length)&&(!agents.fast||!agents.fast.length)&&(!agents.efast||!agents.afast.length)){return}var res={single:[]};var url=cache_url(zone,_url,opt);if(opt.segment_url)url=manifest_url(zone,_url,opt.segment_url);var geoip=_geoip&&geo_get_rad(_geoip);var fast_limit=opt.fast_limit||zone.CG("agent.select.fast.limit",2);var filter=whitelist_filter(zone);var s_shards=agents.single||[];var f_shards=[].concat(agents.single||[],agents.fast||[],filter_efast(zone,agents.efast));if(opt.fast_as_single||zone.CG("agent.select.allow_fast_as_single"))s_shards=s_shards.concat(f_shards);var single_limit=opt.single_limit||zone.CG("agent.select.single.limit",5);res.extra=hrw_select(s_shards,url,Math.max(single_limit,opt.extra_limit||zone.CG("agent.select.single.extra_limit",20)),filter);res.single=res.extra.splice(0,single_limit);if(res.single.length){res.single[0]=assign({master:true},res.single[0]);res.master=res.single[0]}if(geoip)res.fast=get_closest(f_shards,geoip,filter).slice(0,fast_limit);return res};E.get_fast_cdns=function(opt){return new E.Cdn_list({cdns:E.pool.filter(function(c){return!opt.dedicated&&c.is_fast()||c.is_dedicated_fast()}),zone:opt.zone})};return E})})();
define("/svc/cdn/pub/load_perf.js",["/util/date.js"],function(date){var E={};E.global_events=[];E.zone_events={};E.LOG_THRESHOLD=50;E.init=function(on){E.on=!!on;E.last=date.monotonic()};E.enable=function(){E.on=true};E.disable=function(){E.on=false};E.enabled=function(){return E.on};E.clear=function(){E.gloval_events=[];E.zone_events={}};E.push=function(name,zone,report){if(!E.on)return;var now=date.monotonic(),diff=now-E.last;var event={name:name,ts:Math.round(now),elapsed:Math.round(diff),report:!!report};E.last=now;if(!zone)return void E.global_events.push(event);E.zone_events[zone.id]=E.zone_events[zone.id]||[];E.zone_events[zone.id].push(event)};E.timeline=function(zone){if(!zone)return E.global_events;var a=E.global_events,b=E.zone_events[zone.id]||[];var al=a.length,bl=b.length,rl=al+bl,res=new Array(rl);for(var i=0,j=0,k=0;k<rl;k++){res[k]=j>=bl||i<al&&a[i].ts<=b[j].ts?a[i++]:b[j++];res[k].elapsed=k>0?res[k].ts-res[k-1].ts:res[k].elapsed}return res};E.timeline_to_str=function(zone,all){var tl=E.timeline(zone),tr=E.LOG_THRESHOLD;function ev2str(e){return e.name+" "+e.ts+"ms +"+e.elapsed+"ms"}tl=all?tl:tl.filter(function(e,i){return e.elapsed>=tr||e.report||i<tl.length-1&&(tl[i+1].elapsed>=tr||tl[i+1].report)});return tl.map(function(e){return ev2str(e)}).join("\n")};return E});
define("/svc/cdn/pub/adaptive.js",["/svc/cdn/pub/util.js","/util/zerr.js","/util/date.js","/util/etask.js","/util/events.js","/util/util.js","/util/array.js","/util/url.js","/svc/cdn/pub/cache.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/cdnlist.js"],function(util,zerr,date,etask,events,zutil,array,zurl,zcache,load_perf,cdnlist){var E={};var assign=Object.assign,ERR=util.ERR;E.Method=function(opt){if(!(this instanceof E.Method))return new E.Method(opt);var _this=this;this.sent_perf_events=[];this.send_single_perf_event=function(name,report){if(this.sent_perf_events.includes(name))return;load_perf.push(name,this.bws.zone,report);this.sent_perf_events.push(name)};var player=this.player=opt.player;this.indexer={};this.bws=opt.bws;this.log=opt.bws.zone.log_get().set_module("adaptive");this.CG=this.bws.zone.CG.bind(this.bws.zone);this.CS=this.bws.zone.CS.bind(this.bws.zone);this.CE=this.bws.zone.CE.bind(this.bws.zone);this.CD=this.bws.zone.CD.bind(this.bws.zone);this.zperr=this.bws.zone.perr_get();this.fallback_wrapper=this.bws.fallback_wrapper.bind(this);this.segments=[];this.origins={};this.type="adaptive";this.adaptive=opt.adaptive;this.dur=10;this.choose_bw_src();load_perf.push("player_init_adaptive_start",this.bws.zone);this.sort_reqs=function(){};this.set_fullsize=function(){};this.is_next_chunk=function(){return true};this.first_index=function(){return this.fidx||0};this.start_index=function(){return this.sidx||this.fidx};this.last_index=function(){return this.ldx||0};this.ondata=this.fallback_wrapper(this._ondata,"adaptive");this.reset_segment_index=function(){this.last_segment_index=undefined}.bind(this);this.on_rate_decrease=function(cdn,per){var best_cdn=_this.bws.cdns.get_best_cdn("on_rate_decrease",{allow_fast:_this.bws.method.fast_allowed_range(this,{index:_this.last_segment_index})});if(best_cdn!=cdn)_this.CE("cdn.send_reqs.next_cdn.use_best_single");_this.bws.stats.rate_decrease++};this.on_cdn_added=function(cdn){cdn.on("rate_decrease",this.on_rate_decrease)}.bind(this);this.on_suspend=function(){_this.emit("uninit");player.off("seeking",_this.reset_segment_index)};this.on_continue=function(){player.init_adaptive(_this);player.on("seeking",_this.reset_segment_index)};this.bws.cdns.on("cdn_added",this.on_cdn_added);this.bws.on("suspend",this.on_suspend);this.bws.on("continue",this.on_continue);this.CE("cdn.bwsaver.disable");if(!this.CG("cdn.send_reqs.origin_as_fastest")&&this.CG("cdn.send_reqs.origin.head_unsupported")){this.CE("cdn.send_reqs.origin_until_rated")}if(!this.CG("cdn.bwsaver.lowcost_watermark_sec")&&player.is_live_stream()){this.bws.lowcost_watermark_sec=15}this.on_continue()};zutil.inherits(E.Method,events.EventEmitter);E.Method.prototype.uninit=function(){var _this=this;this.player.off("seeking",this.reset_segment_index);this.bws.off("suspend",this.on_suspend);this.bws.off("continue",this.on_continue);if(this.bws.cdns){this.bws.cdns.off("cdn_added",this.on_cdn_added);this.bws.cdns.forEach(function(cdn){cdn.off("rate_decrease",_this.on_rate_decrease)})}this.emit("uninit")};E.Method.prototype.need_chunk=function(chunk){return!chunk.req.info.rate};E.Method.prototype.set_params=function(req,opt){var s="",segment=req.info.segment;opt=opt||{};s+=util.set_param("stack",this.adaptive);s+=util.set_param("index",segment.index);s+=util.set_param("dur",segment.dur);s+=util.set_param("id",segment.playlist_id);if(segment.playlist_url!="def"){s+=util.set_url_param("playlist",opt.playlist||segment.playlist_url)}s+=util.set_url_param("manifest",opt.manifest||req.stream.bws.url_s);return s};E.Method.prototype.close_obtained_reqs=function(stream){for(var i=0;i<stream.reqs.length;i++){var req=stream.reqs[i];if(req.closed||req.info.rate||!req.info.segment.done)continue;this.log.debug("closing obtained "+req.name);req.abort();i--}};E.Method.prototype.obtained_sec=function(stream){if(!stream||!this.cur)return 0;var sec=0,ids=[];stream.chunks.forEach(function(a){var segment=a.req.info.segment;if(segment.playlist_id!=this.cur.playlist_id||segment.index<=this.indexer[segment.playlist_id].completed||ids.includes(segment.index)){return}sec+=segment.dur;ids.push(segment.index)},this);return sec};E.Method.prototype._ondata=function(chunk){if(!chunk.data){this.log.debug("on data error: failed acquiring range "+chunk.req.from+"-"+chunk.req.to);return}this.send_single_perf_event("adaptive_first_data_recieved",true);this.player.ondata_adaptive(chunk,this);this.bws.stats.served+=chunk.data.byteLength;this.bws.track_state("hls ondata");this.bws.emit("serve",chunk.data,chunk)};E.Method.prototype.req=function(stream,cdn,from,to,info){info=info||{};from=0;to=-1;var seg=info.rate?this.segments[0]||stream.last_segment:this.next_segment();if(!seg)return;info.no_range=cdn.using(this.bws.zone).is_ranges_unsupported();if(seg.range&&!info.rate){from=seg.range.from;to=seg.range.to}this.send_single_perf_event("adaptive_first_req_sent",true);assign(info,{segment:seg,cache_id:seg.playlist_id});var req=stream.req(cdn,from,to,info);if(req.info.segment&&req.info.segment.fake_xhr)req.info.segment.fake_xhr.req=req;return req};E.Method.prototype.send_reqs=function(stream){var cdnr,seg;while(!stream.bws.closed&&this.segments.length&&(seg=this.segments[0])){if(this.bws.cache)this.bws.cache.opt.cache_ranges=!!seg.range;cdnr=stream.cache_get({from:seg.range&&seg.range.from||seg.index,to:seg.range&&seg.range.to||seg.index,cache_id:seg.playlist_id});if(!cdnr||!this.req(stream,cdnr.cdn,null,null,{from_cache:true,vary:cdnr.range.info&&cdnr.range.info.vary})){if(cdnr)this.log.debug("req init failed");break}}while(!stream.bws.closed&&this.segments.length&&(cdnr=stream.next_cdn({from:0,to:-1,url:this.segments[0].url,index:this.segments[0].index}))&&this.req(stream,cdnr.cdn));while(!stream.bws.closed&&(this.segments.length||stream.last_segment)&&(cdnr=stream.next_unrated())&&this.req(stream,cdnr.cdn,null,null,{rate:true}));if(!stream.reqs.length&&this.segments.length){stream.onerror("need data and no resources",{fallback:1,reason:"no_resources"})}};E.Method.prototype.fast_allowed_range=function(stream,range){var index=range.segment?range.segment.index:range.index;return index<(this.CG("cdn.send_reqs.fast.ts_limit")||(this.fidx?this.fidx+1:1))};E.Method.prototype.get_segment_info_from_playlist=function(url,cached){var idx,ret,playlists;if(!(playlists=this.player.get_levels(cached)))return;var current=this.player.get_current_level();for(idx in playlists){if(playlists[idx].segments){if(ret=zutil.find(playlists[idx].segments,function(v){return v.url===url})){return assign({},ret,{playing:current==idx})}}}};E.Method.prototype.get_segment_info_from_player=function(url){var info;if(!(info=this.player.get_segment_info(url)))return;return assign({},info,{playing:this.player.get_current_level()==info.playlist_url})};E.Method.prototype.get_segment_info=function(segment){var info;if(info=segment._info)return info;if(info=this.get_segment_info_from_player(segment.url))return info;if(info=this.get_segment_info_from_playlist(segment.url,true))return info;if(info=this.get_segment_info_from_playlist(segment.url,false))return info;this.zperr({id:"adaptive_no_segment_info",throttle:1,info:{player:this.player.name,tech:this.player.tech,module:this.player.module&&this.player.module.name}})};E.Method.prototype.next_segment=function(){return this.segments.length?this.segments.shift():null};E.Method.prototype.chunk_len=function(chunk){return chunk.data.byteLength};E.Method.prototype.set_chunk_data=function(chunk){if(this.bws.tech=="flash"||!chunk.req.opt.streaming)return;var req=chunk.req,other=req.info.overloaded||req.info.clone;var completed=other?other.from+other.completed:req.other_completed;if(!completed)return;var diff=completed-(req.from+req.completed);if(diff<=0)return;chunk.data=chunk.data.slice(diff);chunk.from=Math.max(diff,0)};E.Method.prototype.indexer_init=function(segment){if(this.indexer[segment.playlist_id])return;this.indexer[segment.playlist_id]={completed:(segment.index||0)-1,playlist_id:segment.playlist_id,bitrate:segment.bitrate}};E.Method.prototype.get_stream_by_segment=function(segment){return this.bws.get_stream_by_id(this.CG("cdn.multiple_streams")?segment.media_type:"video")};E.Method.prototype.add_origin=function(segment){var u=zurl.parse(segment.url),host=u.hostname,bws=this.bws;this.origins[host]=this.origins[host]||bws.origin_select(u).hostname;if(host!=this.origins[host]){u.hostname=this.origins[host];segment.url=zurl.uri_obj_href(u)}bws.add_origin_url(segment.url)};E.Method.prototype.get_cdns=function(segment_url){if(this.cdns_selected)return;var ret;if(!(ret=cdnlist.local_url2cdns(this.bws.zone,cdnlist.all_agents,util.geoip,this.bws.url.orig,Object.assign(util.get_url_frame(),{user_agent:navigator&&navigator.userAgent,segment_url:segment_url})))){return}this.cdns_selected=true;this.bws.extra_singles=ret.extra||[];this.bws.emit("local_get_cdns",ret.single,"single_copy");this.bws.set_single_copy_cdn(ret.single,"adaptive");this.bws.do_streams(null,"send_reqs")};E.Method.prototype.init_segment=function(segment){this.send_single_perf_event("adaptive_init_segment_start",true);this.indexer_init(segment);this.ranged_playlist=!!segment.range;segment.ts_receive=date.monotonic();segment.index=this.indexer[segment.playlist_id].completed+1;this.get_cdns(segment.url);var info;if(!(info=this.get_segment_info(segment)))return this.add_segment(segment,"init_segment");segment.url=info.url;segment.dur=info.duration||0;segment.index=+info.media_index;segment.playlist_id=(this.indexer[info.bitrate||info.playlist_url]?this.indexer[info.bitrate||info.playlist_url].playlist_id:null)||info.bitrate||info.playlist_url;segment.playlist_url=info.playlist_url;segment.bitrate=info.bitrate||0;this.dur=segment.dur||this.dur;this.curr_segment_index=segment.index;if(this.fidx===undefined)this.fidx=!this.bws.buf_sec_total()?segment.index:0;this.last_segment_index=segment.index;this.indexer_init(segment);if(!info.playing)return void this.add_segment(segment,"init_segment");if(!info.role||info.role=="primary"){if(this.cur&&this.cur!=this.indexer[segment.playlist_id]){this.log.notice("quality change "+(this.cur.bitrate||this.cur.playlist_id)+" to "+(segment.bitrate||segment.playlist_id));this.indexer[segment.playlist_id].completed=this.cur.completed}this.cur=this.indexer[segment.playlist_id]}this.add_segment(segment,"init_segment")};E.Method.prototype.get_req_by_id=function(id){var found_req;this.bws.streams.find(function(stream){return found_req=stream.reqs.find(function(r){return r.info&&r.info.segment&&r.info.segment.req_id==id})});return found_req};E.Method.prototype.get_segment_by_req_id=function(req_id){return this.segments.find(function(segment){return segment.req_id==req_id})};E.Method.prototype.choose_bw_src=function(){var cdn,_this=this;if((cdn=this.bws.cdns.get_origin())&&cdn.is_enabled()&&(this.CG("cdn.send_reqs.origin_as_fastest")||this.CG("cdn.send_reqs.origin_until_rated")&&!cdn.bpms)){this.bw_src={host:cdn.host,bw:cdn.get_progress_bw()};return}this.bws.cdns.arr.forEach(function(c){if(!c.is_enabled())return;var bw=c.get_progress_bw();if(!_this.bw_src||bw>_this.bw_src.bw)_this.bw_src={host:c.host,bw:bw||0}})};E.Method.prototype.onprogress=function(event,req){if(req.info.rate)return;function call_fakexhr(p){return["dashjs","dailymotion","vjs"].includes(p.name)}if(call_fakexhr(this.player)||this.player.module&&call_fakexhr(this.player.module)){var segment=req.info.segment;if(segment.fake_xhr&&segment.fake_xhr.onprogress)segment.fake_xhr.onprogress(event)}var bw=req.cdn.get_progress_bw();if(this.bw_src&&(req.info.from_cache||this.bw_src.host!=req.cdn.host&&this.bw_src.bw>bw)){this.log.debug("use best bw for "+req.cdn.host+"/"+bw+" replace by "+this.bw_src.host+" bw "+this.bw_src.bw);bw=this.bw_src.bw}else{this.bw_src={host:req.cdn.host,bw:bw};if(this.bw_src.host==req.cdn.host)this.choose_bw_src();if(bw!=this.bw_src.bw){this.log.debug("choose best bw for "+req.cdn.host+"/"+bw+" replace by "+this.bw_src.host+" bw "+this.bw_src.bw)}}this.log.debug("onprogress loaded "+event.loaded+" hola "+bw+" player bw "+this.player.get_bandwidth())};E.Method.prototype.oncomplete_req=function(req){var stream=req.stream,segment=req.info.segment;array.rm_elm(stream.reqs,req);if(!req.info.rate)this.emit("seg_complete",req);if(!req.error){stream.on_meta_data({bitrate:segment.bitrate,duration:segment.dur,start_hdr_sz:0});if(!req.info.rate){stream.map.update(segment.index,segment.index+1);this.log.debug("map updated "+JSON.stringify(stream.map.ranges));this.close_obtained_reqs(stream)}if(req.res.size)stream.set_slice_size(req.res.size,segment.dur,"oncomplete_req")}if(!this.CG("cdn.method.disable_set_bandwidth")&&this.player.flash_api){this.player.flash_api.set_bandwidth(this.bws.cdns.get_best_cdn_bw_bits())}if(req.error!=ERR.aborted){if(req.error&&!req.info.rate&&(!req.info.was_cloned||!req.stream.get_req_by_id(req.info.was_cloned))&&(!req.info.was_overloaded||!req.stream.get_req_by_id(req.info.was_overloaded))){this.add_segment(segment,"oncomplete_req")}else stream.send_reqs()}};E.Method.prototype.add_segment=function(segment,caller){this.add_origin(segment);var stream=this.get_stream_by_segment(segment);if(!stream&&segment.media_type=="audio"&&this.bws.streams.length==1)stream=this.bws.create_stream({id:"audio"});this.bws.emit("add_segment",segment,stream,caller);this.segments.push(segment);if(stream){stream.last_segment=segment;stream.send_reqs()}};E.Method.prototype.remove_segment=function(segment){array.rm_elm(this.segments,segment)};E.Method.prototype.cache_set=function(req){if(req.info.rate||!this.bws.cache)return;var from=req.info.segment.index,to=req.info.segment.index;if(req.info.segment.range){from=req.info.segment.range.from;to=req.info.segment.range.to}this.bws.cache.opt.cache_ranges=!!req.info.segment.range;this.bws.cache.set({id:req.info.cache_id,host:req.cdn.host,path:req.cache_path,from:from,to:to,cache_date:req.resp.hdrs.date,info:{max_age:zcache.is_cachable(req.resp.hdrs),vary:req.vary_hdr,data_prefix:req.hola_resp.data_prefix}})};return E});
define("/svc/cdn/pub/progressive.js",["/svc/cdn/pub/util.js","/util/etask.js","/util/zerr.js","/util/array.js","/util/date.js","/svc/cdn/pub/cache.js","/util/events.js","/util/util.js"],function(util,etask,zerr,array,date,zcache,events,zutil){var E={};var ERR=util.ERR,perr=util.cdn_perr;var KB=1024,MB=1024*KB;E.Method=function(opt){if(!(this instanceof E.Method))return new E.Method(opt);this.player=opt.player;this.bws=opt.bws;this.log=opt.bws.zone.log_get().set_module("progressive");this.fallback_wrapper=this.bws.fallback_wrapper.bind(this);this.type="progressive";this.ondata=this.fallback_wrapper(this._ondata,"progressive");this.alg={last_req_bw:{},up:0,down:0,jump_at:2,fall_at:2};this.bws.url=this.bws.origin_select(this.bws.url);this.CG=this.bws.zone.CG.bind(this.bws.zone);this.CE=this.bws.zone.CE.bind(this.bws.zone);this.memory_cache=memory_cache.bind(this);this.bws.add_origin(this.bws.url.hostname);var _this=this;this.bws.on("stream_start",this.on_stream_start=function(stream){var loaded=0,sec=0,a=_this.bws.memory_cache.last;if(_this.CG("cdn.method.detect_meta_data_location")&&_this.CG("cdn.send_reqs.disable_streaming")){stream.slice=64*KB}stream.on("serve",function(){if(!this.chunks.length&&!this.map.next_unobtained(this.from,this.to)){this.oncomplete()}});if(!stream.from){if(_this.CG("cdn.method.memory_cache_sec"))stream.chunks=_this.bws.memory_cache.start.slice();stream.chunks.forEach(function(c){c.req.stream=stream;loaded+=c.data.byteLength;sec+=c.sec});if(!a.length||loaded!=a[0].from){if(_this.CG("cdn.method.memory_cache_sec")){_this.bws.stats.memory_cache.start.push({bytes:loaded,sec:sec})}return _this.log.info("loaded "+loaded+" bytes from memory = "+sec+" sec")}}if(!_this.CG("cdn.method.memory_cache_sec")||!a.length)return;if(stream.from>a[a.length-1].to||stream.to>0&&stream.to+1<a[0].from||(loaded||stream.from)<a[0].from){return}a.forEach(function(c){if(c.to<stream.from||stream.to>0&&stream.to+1<c.from)return;var from=Math.max(c.from,stream.from);var to=stream.to<0?c.to:Math.min(c.to,stream.to);var chunk={from:from,to:to,data:c.data.slice(from-c.from,to+1-c.from),req:Object.assign(c.req,{stream:stream}),sec:c.sec};loaded+=chunk.data.byteLength;sec+=chunk.sec;stream.chunks.push(chunk)});_this.log.info("loaded "+loaded+" bytes from memory = "+sec+" sec");if(_this.CG("cdn.method.memory_cache_sec")){var q=stream.start?_this.bws.stats.memory_cache.mid:_this.bws.stats.memory_cache.start;q.push({bytes:loaded,sec:sec})}});this.bws.on("req_start",this.on_req_start=function(){_this.req_start.apply(_this,arguments)});this.bws.once("parser_init",function(){_this.bws.parser.on("hdr_found",_this.on_hdr_found=function(pos){_this.hdr_pos=pos})});this.CE("cdn.send_reqs.lowcost_parallel_on_slow")};zutil.inherits(E.Method,events.EventEmitter);E.Method.prototype.uninit=function(){this.bws.off("stream_start",this.on_stream_start);this.bws.off("req_start",this.on_req_start);if(this.bws.parser)this.bws.parser.off("hdr_found",this.on_hdr_found)};E.Method.prototype.req_start=function(req){var _this=this;req.start_bw=this.alg.last_req_bw[req.cdn.host];req.once("too_slow",function(){_this.on_req_too_slow.apply(_this,arguments)})};E.Method.prototype.on_req_too_slow=function(req,caller){var can_get=this.bws.cdns.can_get(req.size(),req.to_sec());this.log.info(req.id+" failed too slow "+(req.done?req.ms_hdrs+req.ms:req.remaining().ms)+">"+(req.to_ms()-req.elapsed()+500)+" rate "+req.rate()+" another cdn can get "+can_get);req.cdn.on_too_slow(req.resp&&req.resp.hdrs["x-cache"]=="HIT");if(!req.cdn.too_slow&&!can_get){var zperr=this.bws.zone.perr_get();zperr({id:"all_cdns_too_slow"});req.cdn.too_slow=true}};E.Method.prototype.chunk_len=function(chunk){return chunk.to+1-chunk.from};E.Method.prototype.set_chunk_data=function(chunk){var stream=chunk.req.stream;if(chunk.from>=stream.completed)return;chunk.data=chunk.data.slice(stream.completed-chunk.from);chunk.from=stream.completed};E.Method.prototype.set_req_alg=function(req){if(this.CG("cdn.req_alg.disable"))return;var ms=req.to_ms(),event=req.error?"failed":"success";if(req.cdn.is_single()&&!req.info.rate&&req.info.bitrate&&ms&&ms+500<req.ms+req.ms_hdrs){event="too_slow"}req.emit(event,req,"set_req_alg")};E.Method.prototype.oncomplete_req=function(req){var stream=req.stream,reqs=stream.reqs;array.rm_elm(reqs,req);if(!req.error&&req.loaded==req.to+1-req.from){var buf_sec;stream.map.update(req.from,req.to);this.log.debug("map updated "+req.from+"-"+req.to+" "+JSON.stringify(stream.map.ranges));this.close_obtained_reqs(stream);if(this.CG("cdn.origin.auto_slice_sz")&&req.cdn.is_origin()&&(buf_sec=this.bws.buf_sec())&&buf_sec.pos>1&&buf_sec.obtained+buf_sec.player<2){this.CS("cdn.origin.min_slice_sz",(this.CG("cdn.origin.min_slice_sz")||stream.slice)*2)}}this.set_req_alg(req);if(req.error!=ERR.aborted)stream.send_reqs()};E.Method.prototype.set_params=function(req){return""};E.Method.prototype.next_slice_fixup=function(stream,range,sec){var to=range.from+stream.slice-1;if(this.CG("cdn.send_reqs.exact_slice_sz")&&stream.bitrate){to=Math.max(to,this.sec2offset(stream,this.bws.get_pos()+this.bws.slice_sec))}range.to=range.to<0?to:Math.min(range.to,to);this.log.debug("next slice "+stream.slice+" "+JSON.stringify(range)+" needed sec "+sec)};E.Method.prototype.cache_get=function(stream,range){return stream.cache_get(range)};E.Method.prototype.next_slice=function(stream,_debug){var from=stream.completed,to=stream.to,sec,debug=_debug;var log=debug?this.log.info:function(){};log("### next slice for stream "+stream.id);if(!(sec=stream.needed_sec()))return log("--- not needed sec");function is_valid(r){return r&&(r.to<0||r.from<=r.to)}from=Math.max(from,stream.from);var r1=this.next_unobtained(stream,from,to),r,r2;log("--- next unobtained "+from+"-"+to+" "+JSON.stringify(r1));while(r1&&is_valid(r2=this.next_unassigned(stream,r1.from,to))&&is_valid(r1=this.next_unobtained(stream,r2.from,to))&&r1.from!=r2.from);if(!r1||!r2)return log("--- no range found");r={from:r1.from,to:Math.min(r1.to,r2.to)};if(r.to>-1&&r.to<r.from)return log("--- to<from "+r.to+"<"+r.from);this.next_slice_fixup(stream,r,sec);log("### return range "+JSON.stringify(r));return r};E.Method.prototype.next_unassigned=function(stream,from,to){return this.next_missing(stream.reqs,stream.fullsize,from,to,function(r){return r.info.rate})};E.Method.prototype.next_unobtained=function(stream,from,to){return this.next_missing(stream.chunks,stream.fullsize,from,to)};E.Method.prototype.next_missing=function(arr,fullsize,from,to,skip){if(fullsize>0)to=to>=0?Math.min(to,fullsize-1):fullsize-1;for(var i=0;i<arr.length&&(to<0||from<=to);i++){var r=arr[i];if(r.error||r.to>=0&&r.to+1<from||skip&&skip(r))continue;else if(from<r.from)break;else if(r.to<0)return null;else from=to<0?r.to+1:Math.min(r.to+1,to+1)}return to>=0&&from>to?null:{from:from,to:i==arr.length?to:to<0?arr[i].from-1:Math.min(to,arr[i].from-1)}};E.Method.prototype.next_assigned=function(stream,from,to){return this.next_have(stream.reqs,from,to)};E.Method.prototype.next_obtained=function(stream,from,to){return this.next_have(stream.chunks,from,to)};E.Method.prototype.next_have=function(arr,from,to){var chosen;arr.forEach(function(r){if(r.to+1<from||to>-1&&r.from>to+1||chosen&&r.from>chosen.to+1){return}if(!chosen)chosen={from:r.from,to:r.to};else{var n=chosen.to<0?chosen.to:r.to<0?r.to:Math.max(chosen.to,r.to);chosen.from=Math.max(from,Math.min(chosen.from,r.from));chosen.to=to<0?n:Math.min(to,n)}});return chosen};E.Method.prototype.sec2offset=function(stream,pos){var parser=this.bws.parser;return parser&&parser.time2ofs&&!isNaN(parser.time2ofs(pos))?parser.time2ofs(pos):stream.sec2sz(pos)};E.Method.prototype.offset2sec=function(stream,ofs){var parser=this.bws.parser;return parser&&parser.ofs2time&&!isNaN(parser.ofs2time(ofs))?parser.ofs2time(ofs):stream.sz2sec(ofs)};E.Method.prototype.req=function(stream,cdn,from,to,info,caller){if(cdn.is_origin()&&(!info||!info.rate)&&this.CG("cdn.send_reqs.origin.min_slice_sz")){to=Math.min(stream.to>-1?stream.to:Infinity,from+Math.max(to+1-from,this.CG("cdn.send_reqs.origin.min_slice_sz")))}return stream.req(cdn,from,to,info,caller)};E.Method.prototype.on_parallel_req=function(stream,p){p.from_cache=this.bws.cache.is_cached(p.range,p.cdn.host)};E.Method.prototype.send_reqs=function(stream){if(!stream.map.next_unobtained(stream.from,stream.to))return;var cdnr,r,reqs=-1,fastest=this.bws.fastest_policy(),buf_sec;if(this.CG("cdn.send_reqs.throttle_on_sec")&&(buf_sec=this.bws.buf_sec())&&buf_sec.obtained>buf_sec.buffered+this.CG("cdn.send_reqs.throttle_on_sec")){if(!this.js_throttling){this.log.info("needed_sec: throttling on js buffer of "+buf_sec.obtained+" sec")}return this.js_throttling=true}this.js_throttling=false;var req_init_failed,cache_failed=[];while(!this.bws.closed&&reqs<stream.reqs.length){reqs=stream.reqs.length;while(!this.bws.closed&&!this.CG("cdn.cache.urls.disable")&&(r=this.next_slice(stream))&&(cdnr=this.cache_get(stream,r))){if(!stream.allow_req("send_reqs_cache",true)){this.log.info("not allowed cache req");break}if(!this.req(stream,cdnr.cdn,cdnr.range.from,cdnr.range.to,{from_cache:true,vary:cdnr.range.info&&cdnr.range.info.vary,data_prefix:cdnr.range.info&&cdnr.range.info.data_prefix,cache_id:cdnr.cache_id,cache_backup:r.cache_backup},"send_reqs_cache")){this.log.debug("req init "+cdnr.cdn.id+" "+cdnr.range.from+"-"+cdnr.range.to+" failed");req_init_failed=true;cache_failed.push(cdnr.range.from);break}}while(!this.bws.closed&&(r=this.next_slice(stream))&&(cache_failed.indexOf(r.from)>-1||!this.cache_get(stream,r))&&(cdnr=stream.next_cdn(r))){var early;if(!(early=stream.allow_req("send_reqs",true))){this.log.debug("not allowed range req");break}var cached,range=cdnr.range;if(this.bws.cache&&!this.CG("cdn.cache.disabled")&&range.to>-1&&(cached=this.bws.cache.next_obtained(null,range.from,range.to))){cached.sort(function(a,b){return b.range.from-a.range.from});for(var i=0;i<cached.length;i++){var cdn=this.bws.cdns.get_by_host(cached[i].cdn);if(cdn&&cdn.is_enabled()){range.to=Math.min(range.to,cached[i].range.from-1);break}}if(i<cached.length){this.log.debug("next_slice reduced by cache "+range.from+"-"+range.to)}}if(!this.req(stream,cdnr.cdn,range.from,range.to,{early_of:early.id,cache_backup:r.cache_backup},"send_reqs")){this.log.debug("req init "+cdnr.cdn.id+" "+range.from+"-"+range.to+" failed");req_init_failed=true;break}}}while(!this.bws.closed&&(cdnr=stream.next_unrated())&&this.req(stream,cdnr.cdn,0,-1,{rate:true},"send_reqs_rate"));if(!stream.stopped&&!stream.reqs.length&&!req_init_failed&&this.next_slice(stream)){stream.onerror("needed sec and no resources",{fallback:true,reason:this.bws.cdns.is_disconnected_on_start()?"no_connection":"no_resources"})}};E.Method.prototype.obtained_sec=function(stream){if(!stream)return 0;var completed=stream.completed;for(var i=0,sec=0;i<stream.chunks.length;i++){var chunk=stream.chunks[i];if(chunk.to<=completed)continue;if(chunk.from>completed)break;sec+=completed==chunk.from&&chunk.sec?chunk.sec:chunk.req.to_sec(Math.max(completed,chunk.from),chunk.to);completed=chunk.to}if(stream.bitrate&&this.bws.parser&&this.bws.parser.media_appender){sec+=stream.sz2sec(this.bws.parser.media_appender.calc_chunkq_bytes())}return sec};E.Method.prototype.close_obtained_reqs=function(stream){for(var i=0;i<stream.reqs.length;i++){var req=stream.reqs[i];if(req.closed||req.info.rate||stream.map.next_unobtained(req.from,req.to)){continue}this.log.debug("closing obtained "+req.name);req.abort("close obtained");i--}};E.Method.prototype.need_chunk=function(chunk){return chunk.to+1>chunk.req.stream.completed};E.Method.prototype.is_next_chunk=function(chunk){return chunk.from<=chunk.req.stream.completed&&chunk.to>=chunk.req.stream.completed};E.Method.prototype.fast_allowed_range=function(stream,range){return!stream.bitrate||this.bws.parser.ofs2time(range.from)<(this.CG("cdn.send_reqs.fast.sec_limit")||10)};function memory_cache(chunk){var sec=this.CG("cdn.method.memory_cache_sec");var start=this.bws.memory_cache.start,last=this.bws.memory_cache.last;if(!sec)return;var a=!chunk.from||start.length&&chunk.from==start[start.length-1].to+1?start:last;var qsec=0;if(a==start){a.forEach(function(c){qsec+=c.sec});if(qsec+chunk.sec>=sec)a=last}if(a!=start&&a.length&&chunk.from!=a[a.length-1].to+1)a=this.bws.memory_cache.last=[];a.push(chunk);qsec=0;a.forEach(function(c){qsec+=c.sec});while(a.length>1&&qsec-a[0].sec>=sec){qsec-=a[0].sec;a.splice(0,1)}}E.Method.prototype._ondata=function(chunk){var bws=this.bws,req=chunk.req,stream=req.stream,completed;var media_src=this.player.media_src;if(!media_src||media_src.readyState=="closed"){return perr({id:"progressive_mediasource_invalid_state",info:media_src&&media_src.readyState,add_log:true,throttle:3})}this.set_fullsize(stream,req.res?req.res.fullsize:0);if(!chunk.data){this.log.debug("on data error: failed acquiring range "+req.from+"-"+req.to);return}if(chunk.to<stream.completed||chunk.from>stream.completed){this.log.debug("on data error: expected "+stream.completed+" got "+chunk.from+"-"+chunk.to);return}var data=chunk.from==stream.completed?chunk.data:chunk.data.slice(stream.completed-chunk.from);data.fileStart=stream.completed;bws.stats.served+=data.byteLength;var _completed;this.memory_cache(chunk);if(_completed=bws.parser.append_buffer(data,stream.fullsize,req))completed=_completed;if(bws.parser.type!="flv"&&completed>stream.fullsize&&stream.fullsize>0){this.log.info("something happened with "+bws.parser.type+" chunks"+" completed "+completed+" while fullsize is "+stream.fullsize);bws.uninit({err:"completed>fullsize in "+bws.parser.type+" chunks"})}this.log.debug("bwsaver->"+bws.parser.type+" "+data.fileStart+"-"+(data.fileStart+data.byteLength-1)+"="+data.byteLength+" completed "+completed+" stream completed "+bws.stream_completed()+"->"+(stream.completed+data.byteLength));stream.completed+=data.byteLength;bws.track_state("ondata");bws.emit("serve",data,chunk);if(completed!=stream.completed){var cur=stream.completed;stream.set_completed(completed,"ondata");if(this.CG("cdn.method.detect_meta_data_location")&&this.hdr_pos===undefined&&completed>cur){if(!this.CG("cdn.send_reqs.disable_streaming")){if(!req.done&&(req.to<0||req.loaded<req.size()))req.abort("ondata");var close=[];stream.reqs.forEach(function(r){if(!r.info.rate&&completed-r.from-r.loaded>256*KB)close.push(r)});close.forEach(function(r){r.abort()});stream.send_reqs()}else{this.bws.do_streams(null,"set_slice_size",MB,this.bws.slice_sec,"hdr_found")}}}if(bws.parser.flush&&(bws.done||bws.parser.m_i&&stream.fullsize>0&&stream.completed>=stream.fullsize)){bws.parser.flush()}};E.Method.prototype.set_fullsize=function(stream,fullsize,force){if(this.type=="progressive"&&stream.fullsize&&fullsize&&stream.fullsize!=fullsize){this.log.info("probably customer replaced video with another one, file"+" size is different among reqs, was %d now %d",stream.fullsize,fullsize);stream.onerror("same file but requests returned different fullsize",{fallback:true,reason:"fullsize_mismatch"});return}if(stream.fullsize&&!force||!fullsize)return;var old_sz=stream.fullsize;stream.fullsize=fullsize;stream.to=fullsize-1;this.log.info("set fullsize to "+fullsize);if(old_sz>0)this.bws.fullsize-=old_sz;this.bws.fullsize+=fullsize;stream.map.set_size(stream.fullsize,force);this.emit("set_fullsize",fullsize)};E.Method.prototype.sort_reqs=function(stream){stream.reqs.sort(function(a,b){return a.from-b.from})};E.Method.prototype.cache_set=function(req){this.bws.cache.set({id:req.info.cache_id,host:req.cdn.host,path:req.cache_path,from:req.from,to:req.to,cache_date:req.resp.hdrs.date,info:{max_age:zcache.is_cachable(req.resp.hdrs),vary:this.CG("cdn.send_reqs.vary_url_params")&&(req.hrange||req.from==0&&(req.to<0||req.to==req.fullsize)?req.vary_hdr:null),data_prefix:req.hola_resp.data_prefix}})};return E});
define("/svc/cdn/pub/unittest.js",["/util/storage.js","/util/date.js","/util/url.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cache.js","/svc/cdn/pub/cdnlist.js","/util/events.js"],function(storage,date,zurl,zutil,util,cache,cdnlist,events){var E={};var KB=1024,MB=1024*KB;var ERR=util.ERR;E.Unittest=function(opt){var zperr=opt.bws.zone.perr_get();try{this.start_ts=date.to_sql_ms();this.log=opt.bws.zone.log_get().set_module("unittest");this.vc_id=this.start_vc_id=+(opt.vc_id||1);this.last=this.start=date.monotonic();this.url=opt.url;this.adaptive=opt.bws.adaptive;this.origin=opt.origin;this.delayed={};this.test="";this.resp_q={};this.bws=opt.bws;this.CG=this.bws.zone.CG.bind(this.bws.zone);this.CS=this.bws.zone.CS.bind(this.bws.zone);this.max_len=opt.max_len||256*KB;this.conf=zutil.clone_deep(opt.bws.zone.conf);this.snapshot();this.player=opt.player;this.bitrate={};this.pending={};this.stream_info={};this.bws_events=[];this.player_events=[];this.extra_singles=[];this.local_cdns=[];this.res=this.player.get_resolution();this.bws_on("req_end",this.req_end);this.bws_on("req_resp",this.req_resp);this.bws_on("unittest_progress",this.bws_set_progress_all);this.bws_on("set_slow",this.set_slow);this.bws_on("player_state",this.player_state);this.bws_on("serve",this.serve);this.bws_on("req_start",this.req_start);this.bws_on("xhr_start",this.xhr_start);this.bws_on("xhr_end",this.xhr_end);this.bws_on("set_completed",this.set_completed);this.bws_on("stream_start",this.stream_start);this.bws_on("next_single",this.next_single);this.bws_on("pause",this.pause);this.bws_on("resume",this.resume);this.bws_on("suspend",this.suspend);this.bws_on("continue",this._continue);this.bws_on("uninit",this.uninit);this.bws_on("add_segment",this.add_segment);this.bws_on("set_max_reqs",this.set_max_reqs);this.bws_on("method_init",this.method_init);this.bws_on("parser_init",this.parser_init);this.bws_on("track_state",this.track_state);this.bws_on("local_get_cdns",this.local_get_cdns);this.player_on("play",this.set_play);this.player_on("pause",this.set_pause);this.player_on("waiting",this.set_waiting);this.player_on("on_frag_loading",this.on_frag_loading);this.player_on("detached",this.on_player_detach);var cb1,cb2,cb3,cb4,stats=this.bws.cdn_svc.attached_stats;if(stats){cb1=this.try_wrapper(this.on_waiting);cb2=this.try_wrapper(this.on_seek_start);stats.on("wait_begin",cb1);stats.on("seek_start",cb2);this.on("uninit",function(){stats.off("wait_begin",cb1);stats.off("seek_start",cb2)})}if(cdnlist.bootstraps){cb3=this.try_wrapper(this.get_cdns);cb4=this.try_wrapper(this.get_cdns_end);cdnlist.bootstraps.on("get_cdns",cb3);cdnlist.bootstraps.on("get_cdns_end",cb4);this.on("uninit",function(){cdnlist.bootstraps.off("get_cdns",cb3);cdnlist.bootstraps.off("get_cdns_end",cb4)})}if(this.CG("analysis.js",[]).length){this.analysis_int=setInterval(this.try_wrapper(this.analysis_cb),1e3)}}catch(e){if(this.log)this.log.info("error unittests init "+e+" "+e.stack);zperr({id:"bwsaver_err_set_unittest",err:e.message})}return this};zutil.inherits(E.Unittest,events.EventEmitter);E.Unittest.prototype.try_wrapper=function(func){var _this=this;var zperr=this.bws.zone.perr_get();return function(){try{return func.apply(_this,arguments)}catch(e){zperr({id:"bwsaver_err_set_unittest",err:e.message,throttle:1,filehead:e.stack});_this.log.info("unittest error "+e.message+" "+e.stack)}}};E.Unittest.prototype.bws_on=function(event,cb){var _cb=this.try_wrapper(cb);this.bws_events[event]=(this.bws_events[event]||[]).concat(_cb);this.bws.on(event,_cb)};E.Unittest.prototype.player_on=function(event,cb){var _cb=this.try_wrapper(cb);this.player_events[event]=(this.player_events[event]||[]).concat(_cb);this.bws.player_on(event,_cb)};E.Unittest.prototype.snapshot=function(){var _this=this;this.bws.cdns.save({close:true});this.cdns_cache=storage.get("hola_cdnlist_cache");this.bootstrap_cache=storage.get("hola_bootstrap_cache");var vc_id=Infinity;this.bws.streams.forEach(function(stream){vc_id=stream.uid<vc_id?stream.uid:vc_id});if(vc_id<Infinity)this.start_vc_id=vc_id;if(this.bws.cache){var entry=zutil.clone_deep(this.bws.cache.data);this.cache=JSON.stringify(entry)}if(this.bws.cdns){_this.cdns=[];this.bws.cdns.forEach(function(cdn){_this.cdns.push({host:cdn.host,cost:cdn.cost,owner:cdn.owner,name:cdn.name,features:zutil.clone_deep(cdn.features),uid:cdn.uid,req_uid:cdn.req_uid,disabled:!cdn.enabled})})}this.index_at_snapshot=this.hola_adaptive?this.bws.method.frag_current():undefined;this.gen_playlist();this.log.info("unittest snapshot")};E.Unittest.prototype.time_since=function(){var now=date.monotonic(),diff=now-this.last<<0;if(diff>5)this.set(diff+"ms",null);this.last=now};E.Unittest.prototype.handle_pending=function(s,pending){var _this=this;if(pending){if(this.pending[pending]){this.pending[pending].str=s;this.pending[pending].n++}else this.pending[pending]={str:s,n:0};return true}var keys=Object.keys(this.pending);if(keys.length){keys.forEach(function(cmd){_this.test+=" "+_this.pending[cmd].str});this.pending={}}};E.Unittest.prototype.set=function(s,pending){var _this=this;if(this.handle_pending(s,pending))return;this.test+=" "+s;if(this.test.length>this.max_len){if(!this.start_test){this.start_test=this.gen_test();util.log_report({id:"log",cdn:this.bws.cdn_svc,add_log:this.CG("util.log.report.start.add_log"),add_unittest:this.CG("util.log.report.start.unittest")})}var now=date.monotonic();this.log.debug("unittest exceeded max "+this.max_len+" starting new snapshot");this.test="";this.snapshot();this.is_snapshot=true;this.initial_playlist=this.playlist;this.local_cdns=[];var pos=this.player.get_pos();this.player_state(pos,this.bws.buf_sec(pos));this.bws.streams.forEach(function(stream){var reqs=[];stream.jtest_start=stream.completed;stream.reqs.forEach(function(req){var info={};["bitrate","cached_bw","cache_id","from_cache","orig_from_cache","rate","segment","uid","bw_by_performance_stats","vary"].reduce(function(o,p){o[p]=req.info[p];return o},info);info.uid=req.uid;if(req.info.clone)info.clone=req.info.clone.id;if(req.info.overloaded)info.clone=req.info.overloaded.id;var r={stream:stream.uid,range:req.from+"B-"+(req.to+1)+"B",cdn:req.cdn.uid,ms:now-req.tm_create,info:info};stream.jtest_start=Math.min(stream.jtest_start,req.info.segment?req.info.segment.index:req.from);reqs.push(r)});_this.stream_start(stream,{reqs:reqs,start:stream.jtest_start})})}return s};E.Unittest.prototype.set_serve_progressive=function(req){var q=this.resp_q[req.stream.uid],prev_loaded;var stream=req.stream,from,to;while(q.loaded!=prev_loaded){prev_loaded=q.loaded;var c=q.serve[0];if(!c||c.from>q.loaded)break;if(c.jump){q.loaded=c.to;q.serve.splice(0,1);continue}if(from===undefined){from=c.from;to=from+c.len}else to+=c.len;q.serve.splice(0,1);q.loaded+=c.len}if(to===undefined||to<=from)return;from=Math.max(from,stream.jtest_start||0);var s="",len=to-from;s+="vc"+stream.uid+"<resp("+(from||0)+"B-"+to+"B)";this.set(s)};E.Unittest.prototype.set_serve_adaptive=function(req){var q=this.resp_q[req.stream.uid],prev_loaded;var segment=req.info.segment;q.loaded=q.loaded||{index:0,from:0,to:-1};while(q.loaded!=prev_loaded){prev_loaded=q.loaded;var c=q.serve[0];if(!c)break;if(c.index>q.loaded.index+1||c.index>q.loaded.index&&!q.loaded.final||c.index==q.loaded.index&&c.from!=q.loaded.to+1){break}if(c.jump){q.loaded=c.jump;q.serve.splice(0,1);continue}q.serve.splice(0,1);q.loaded=c;if(!c.final){this.set("vc"+req.stream.uid+"<resp("+c.from+"B-"+c.to+"B hls t"+c.index+")")}else this.set("vc"+req.stream.uid+"<resp(hls t"+c.index+")")}};E.Unittest.prototype.req_resp=function(req,caller){if(!req)return;req.unittest=req.unittest||{progress:0,ms_hdrs:0,last_update:date.monotonic()};if(req.loaded==req.unittest.progress&&req.ms_hdrs==req.unittest.ms_hdrs)return;if(caller=="onprogress"&&date.monotonic()-req.unittest.last_update<(this.CG("cdn.unittest.progress_update_ms")||1e3)){return}req.unittest.last_update=date.monotonic();if(caller!="progress")this.time_since();var len=req.to+1-req.from;if(this.adaptive&&this.file!=len){this.set("file("+len+"B)");this.file=len}var buf_sec=this.bws.buf_sec_last;var from=req.from+req.unittest.progress;var to=req.from+req.loaded-1;req.unittest.done=req.info.rate||req.to>-1&&to==req.to||req.done;this.set("cw"+(req.cdn.is_origin()?"o":req.cdn.uid)+"<resp("+(!req.info.rate&&(!req.done||req.unittest.progress)?"progress "+(!req.loaded?"none ":from+"B-"+(to+1)+"B "):"")+"id "+req.uid+(!req.unittest.cache&&(req.info.from_cache||req.info.orig_from_cache)?" "+(!req.info.from_cache?"!":"")+"cache":"")+((req.status||req.resp&&req.resp.status)&&!req.unittest.status?" status "+req.status||req.resp.status:"")+(req.info.rate?" done":"")+(!req.unittest.ms_hdrs&&req.ms_hdrs?" ms_hdrs "+req.ms_hdrs:"")+(req.to>-1&&to==req.to||req.loaded&&req.xhr&&req.xhr.success&&req.done?" ms "+Math.round(req.ms||req.elapsed()-req.ms_hdrs)+" done":"")+(buf_sec&&Math.round(buf_sec.buffered)?" buffered "+Math.round(buf_sec.buffered)+"s":"")+(buf_sec&&Math.round(buf_sec.pos)?" pos "+Math.round(buf_sec.pos)+"s":"")+(req.stream.bitrate&&this.bitrate[req.stream.uid]!=req.stream.bitrate&&!this.hola_adaptive?" bitrate "+req.stream.bitrate+" slice "+req.stream.slice:"")+(req.done&&req.cdn.rate()!=Infinity?" rate "+req.cdn.rate():"")+(req.cdn.cache_flag&&!req.unittest.ms_hdrs?" cf "+req.cdn.cache_flag:"")+(!req.status&&(!req.resp||!req.resp.status)?" no_status":"")+")");this.bitrate[req.stream.uid]=req.stream.bitrate;req.unittest.cache=req.info.from_cache||req.info.orig_from_cache;req.unittest.progress=req.loaded;req.unittest.ms_hdrs=req.ms_hdrs;req.unittest.status=req.status||req.resp&&req.resp.status;req.unittest.resp=true;this.set_serve(req);this.last_cmd="cw_resp"};E.Unittest.prototype.parser_init=function(){var cb=this.try_wrapper(this.onseek);this.bws.parser.on("seek_complete",cb);this.on("uninit",function(){this.bws.parser.off("seek_complete",cb)})};E.Unittest.prototype.allow_early_req=function(req){this.time_since();this.set_progress_all(req.stream)};E.Unittest.prototype.req_log_progress=function(req){if(req&&!req.done)this.req_resp(req,"progress")};E.Unittest.prototype.req_end=function(req){this.time_since();this.req_resp(req,"req_end");var reqs=req.cdn.is_hola()?this.hola_reqs=this.hola_reqs||[]:this.origin_reqs=this.origin_reqs||[];reqs.push(req.url);if(reqs.length>10)reqs.shift(1);if(req.cdn.is_hola())this.last_hola_req_url=req.url;else this.last_origin_req_url=req.url;if(!req.error||req.unittest.done)return;if(req.info.overloaded||req.info.clone||req.info.was_cloned||req.info.was_overloaded){this.req_resp(req.info.overloaded||req.info.clone||req.stream.get_req_by_id(req.info.was_overloaded)||req.stream.get_req_by_id(req.info.was_cloned),"req_end")}if(req.error==ERR.head_unsupported){this.set("cw"+(req.cdn.is_origin()?"o":req.cdn.uid)+"<resp(status "+(req.status||req.xhr&&req.xhr.status||405)+" ms "+req.elapsed()+" done)")}else{this.set("cw"+(req.cdn.is_origin()?"o":req.cdn.uid)+(req.error==ERR.aborted&&!req.abort_fragment?">":"<")+"!(id "+req.uid+(req.abort_fragment?" abort":"")+")")}this.last_cmd="cw_end"};E.Unittest.prototype.gen_playlist=function(level){var _this=this,method=this.bws.method;if(!this.hola_adaptive||!method.playlists)return;var pl=method.playlists;if(!pl||!pl.length)return;var i=method.qid||0;if(!pl[i].segments)for(i=0;i<pl.length&&!pl[i].segments;i++);if(i==pl.length)i=0;this.playlist="";var segments=pl[i].segments,d;for(i=0,d=0;segments&&i<Math.min(segments.length,100);d+=segments[i].duration||10,i++);this.segments_dur=Math.round(d/(i||1));this.playlist=(segments?segments.length+"i;":"")+pl.length+"q"+(segments&&segments[0].media_index?";"+segments[0].media_index+"s":"")+(segments?";"+Math.round(this.segments_dur)+"d":"")+(method.start_index()>method.first_index()?";"+method.start_index()+"j":"");var host;pl.forEach(function(playlist){var seg=playlist.segments;host=host||seg&&seg[0]&&zurl.parse(seg[0].url).hostname;if(!playlist.attributes||!playlist.attributes.bandwidth||playlist.attributes.bandwidth=="undefined"){return}_this.playlist+=";"+playlist.attributes.bandwidth;if(playlist.attributes.resolution){_this.playlist+="-"+playlist.attributes.resolution.width+"x"+playlist.attributes.resolution.height}if(seg&&seg.length){_this.playlist+=(!playlist.attributes.resolution?"-":"")+"--"+(seg[0].media_index!=segments[0].media_index?seg[0].media_index:"")+"s"}_this.playlist+="b"});if(host&&host!=this.bws.url.hostname)this.playlist+=";"+host+"h";if(level!==undefined)this.playlist+=";"+level+"u";this.start_quality=method.qid};E.Unittest.prototype.gen_test=function(){if(this.in_gen_test)return;this.in_gen_test=true;var test,segments_dur;var zperr=this.bws.zone.perr_get();this.bws_set_progress_all();if(this.index_at_snapshot!==undefined){var pl=this.bws.method.playlists;var i=this.bws.method.qid||0;if(!pl[i].segments)for(i=0;i<pl.length&&!pl[i].segments;i++);if(i<pl.length){segments_dur={};var segments=pl[i].segments;for(i=this.index_at_snapshot;i<this.bws.method.frag_current();i++){if(segments[i].duration!=this.segments_dur)segments_dur[i]=segments[i].duration}}}try{var get_cdns;delete this.conf.loader;delete this.conf.analysis;delete this.conf.kw;delete this.conf.origin_control;delete this.conf.portal;delete this.conf.test_urls;delete this.conf.util;delete this.conf.filter_out;delete this.conf.cdn.filter_out;if(this.is_snapshot)get_cdns=JSON.stringify(this.bws.cdns_cache);test="date_init("+this.start_ts+") conf_init("+JSON.stringify(this.conf)+") url("+this.url+") "+(this.cdns&&this.cdns.length?"cdns("+JSON.stringify(this.cdns)+") ":"")+(this.extra_singles.length?"extra_singles("+JSON.stringify(this.extra_singles)+") ":"")+(this.local_cdns.length?"local_url2cdns("+JSON.stringify(this.local_cdns)+") ":"")+(this.cdns_cache?"cdns_cache("+this.cdns_cache+") ":"")+(this.bootstrap_cache?"bootstrap_cache("+this.bootstrap_cache+") ":"")+(this.cache?'cache({"urls":{"'+this.bws.cache.url+'":'+this.cache+'}, "version":'+cache.version+"}) ":"")+(segments_dur?"segments_dur("+JSON.stringify(segments_dur)+") ":"")+"debug open("+(this.adaptive?"hls "+(this.hola_adaptive?"hola qid "+this.bws.method.qid+" ":"hook "):"")+(this.bws.player.is_live_stream()?"live ":"")+"cache auto"+(this.is_snapshot?" snapshot":"")+(this.bws.preload?" preload "+this.bws.preload:"")+(get_cdns&&(get_cdns.single_copy&&get_cdns.single_copy.length||get_cdns.fast&&get_cdns.fast.length||get_cdns.popular&&get_cdns.popular.length)?" get_cdns_cache "+get_cdns:"")+(this.initial_playlist?" playlists "+this.playlist+" start_quality "+this.start_quality:"")+(this.start_vc_id>1?" vc_id "+this.start_vc_id:"")+(this.is_snapshot&&this.hola_adaptive?" delay_stream":"")+(this.res?" resolution "+this.res.width+"x"+this.res.height:"")+") file("+(this.adaptive?"30C":(this.bws.fullsize?this.bws.fullsize+"B":"10C")+" dynamic")+") jtest(set_slice) "+this.test+" free"+(this.bws.cdn_svc.fallback?"(fallback)":"");if(typeof window!=="undefined"&&window.hola_cdn)window.hola_cdn.last_gen_test=test}catch(e){this.log.info("error unittests generation "+e);zperr({id:"bwsaver_err_set_unittest",err:"genration failed "+e.message,bt:e.stack})}this.in_gen_test=false;return test};E.Unittest.prototype.on_waiting=function(){var _this=this;clearTimeout(this.timeout_handle);this.timeout_handle=setTimeout(function(){var s=_this.bws.cdn_svc.attached_stats.get_stats();if(!s.stat.wait_waiting_ms&&!s.stat.wait_waiting_over_max_ms)return;var pos=_this.player.get_pos();if(pos<=3)_this.bws.stats.buffering.start++;else if(pos-_this.bws.start_pos<=3)_this.bws.stats.buffering.seek++;else if(!_this.bws.cdns.can_get_by_hola(_this.bws.slice,_this.bws.slice_sec)){_this.bws.stats.buffering.none_can_get++}else _this.bws.stats.buffering.other++;if(!_this.buffering_test){try{_this.log.info("buffering event "+(s.stat.wait_waiting_ms?"wait_waiting "+s.stat.wait_waiting_ms:"over_max "+s.stat.wait_waiting_over_max_ms));_this.set_player_state("waiting_js");_this.buffering_test=_this.gen_test()}catch(e){_this.buffering_test="error "+e.stack}}if(!_this.buffering_test_sent){util.log_report({id:"log",cdn:_this.bws.cdn_svc,add_log:_this.CG("util.log.report.wait.add_log"),add_unittest:_this.CG("util.log.report.wait.unittest")});_this.buffering_test_sent=true}},this.CG("cdn.unittest.buffering_wait_interval")||1e3)};E.Unittest.prototype.on_seek_start=function(){if(this.seek_test)return;util.log_report({id:"log",cdn:this.bws.cdn_svc,add_log:this.CG("util.log.report.seek.add_log"),add_unittest:this.CG("util.log.report.seek.unittest")});this.seek_test=this.gen_test()};E.Unittest.prototype.set_slow=function(req){if(req.error)return;this.req_resp(req,"set_slow");this.time_since();this.set("cw"+(req.cdn.is_origin()?"o":req.cdn.uid)+">slow("+this.req_range(req)+")");this.last_cmd="cw_slow"};E.Unittest.prototype.player_state=function(pos,bsec){this.time_since();if(bsec.player+bsec.obtained>this.bws.low_watermark_sec-1)this.bws_set_progress_all();var total=Math.round(bsec.buffered+bsec.obtained);this.set("player_state(pos "+Math.round(pos)+"s"+" player "+bsec.player+"s"+(total?" buffered "+total+"s":"")+")","player_state")};E.Unittest.prototype.set_policy=function(policy){this.time_since();this.set("set_policy("+policy+")");this.last_cmd="set_policy"};E.Unittest.prototype.set_serve=function(req){if(this.bws.adaptive)return this.set_serve_adaptive(req);this.set_serve_progressive(req)};E.Unittest.prototype.serve=function(data,chunk){var req=chunk.req,q=this.resp_q[req.stream.uid];if(this.bws.adaptive){q.serve.push({index:chunk.index,from:chunk.from,to:chunk.to,"final":req.xhr&&req.xhr.success})}else q.serve.push({from:data.fileStart||0,len:data.byteLength});this.last_cmd="serve"};E.Unittest.prototype.req_range=function(req){return(req.to!=-1&&(req.info.rate||!this.adaptive||req.info.keymap_split)||req.from?req.from+"B-"+(req.to<0?"-1":req.to+1)+"B ":"")+(req.info.rate?"rate ":"")+(this.adaptive?"qid "+req.info.segment.playlist_id+" hls t"+req.info.segment.index+" ":"")+"id "+req.uid};E.Unittest.prototype.get_cdns=function(fetch_opt,cdn){this.time_since();fetch_opt.uid=fetch_opt.uid||0;this.set("cw"+cdn.uid+">req(get_cdns"+(fetch_opt.from_cache?" cache":"")+")");this.last_cmd="cw_req"};E.Unittest.prototype.get_cdns_end=function(host,child,error){this.time_since();var retval=child.retval,resp="";if(!error&&retval.data){if(retval.data.single&&retval.data.single.length){resp+="single ";retval.data.single.forEach(function(cdn){resp+=cdn.host+","});resp=resp.slice(0,-1)}if(retval.data.fast&&retval.data.fast.length){resp+=(resp.length?"":" ")+"fast ";retval.data.fast.forEach(function(cdn){resp+=cdn.host+","});resp=resp.slice(0,-1)}if(retval.data.popular&&retval.data.popular.length){resp+=(resp.length?"":" ")+"popular ";retval.data.popular.forEach(function(cdn){resp+=cdn.host+","});resp=resp.slice(0,-1)}}else resp="status 403";var cdn=cdnlist.bootstraps.get_by_host(host);this.set("cw"+(cdn?cdn.uid:0)+"<resp("+resp+")");this.last_cmd="get_cdns_resp"};E.Unittest.prototype.xhr_start=function(method,url){this.time_since();this.set("xhr("+method+" "+url+")");this.last_cmd="xhr"};E.Unittest.prototype.xhr_end=function(method,url,status,response_url){this.time_since();this.set("xhr_resp("+method+" "+url+" "+status+(response_url?" "+response_url:"")+")");this.last_cmd="xhr_resp"};E.Unittest.prototype.req_start=function(req){req.unittest={progress:0,ms_hdrs:0};this.time_since();this.set_progress_all(req.stream);var stream_info=this.stream_info[req.stream.uid];if(!req.info.rate&&!stream_info.segment&&stream_info.rate){var fastest;req.stream.reqs.forEach(function(r){if(!r.info.rate||!r.loaded)return;if(!fastest||r.loaded>fastest.loaded)fastest=r});if(fastest)this.req_resp(fastest,"req_start")}if(req.info.rate)stream_info.rate++;else stream_info.segment++;if(req.uid===undefined){if(req.ws_cmd)req.uid=req.cdn.ws.id+1;else{req.uid=req.info.uid||req.cdn.req_uid;req.cdn.req_uid=req.uid+1}}this.set("cw"+(req.cdn.is_origin()?"o":req.cdn.uid)+">req("+this.req_range(req)+(req.info.from_cache?" cache":"")+(req.info.clone?" clone":"")+")");this.last_cmd="cw_req"};E.Unittest.prototype.onseek=function(info){var _this=this;this.time_since();this.bws_set_progress_all();this.bws.streams.forEach(function(stream){_this.set("vc"+stream.uid+">seek("+Math.round(info.time)+"sec offset "+info.offset+(_this.hola_adaptive?"i":"B")+")")});this.last_cmd="seek"};E.Unittest.prototype.on_playlist_update=function(level){this.bws_set_progress_all();var playlist=this.playlist;this.gen_playlist(level);if(playlist==this.playlist)return;this.time_since();this.set("playlists("+this.playlist+")");this.playlist_set=true;this.last_cmd="playlist_update"};E.Unittest.prototype.on_resolution_change=function(res){this.time_since();this.set("resolution("+res.width+"x"+res.height+")");this.last_cmd="resolution"};E.Unittest.prototype.on_playlist_req=function(res){if(!res.loader)return;this.time_since();this.set("cw"+(res.cdn.is_origin()?"o":res.cdn.uid)+">pl_req(qid "+res.qid+")");this.last_cmd="pl_req"};E.Unittest.prototype.on_playlist_resp=function(res){if(!res.loader)return;this.time_since();this.set("cw"+(res.cdn.is_origin()?"o":res.cdn.uid)+"<pl_resp(qid "+res.qid+" status "+res.status+")");this.last_cmd="pl_resp"};E.Unittest.prototype.on_keymap_info=function(res){this.time_since();this.set("keymap_info("+JSON.stringify(res)+")");this.last_cmd="keymap_info"};E.Unittest.prototype.on_set_quality=function(qid,caller){this.time_since();this.bws_set_progress_all();this.set("set_"+(caller=="quality_level"?"manual_":"")+"quality("+qid+")");this.last_cmd="set_quality"};E.Unittest.prototype.analysis_checkpoint=function(){if(this.analysis_int)this.try_wrapper(this.analysis_cb)()};E.Unittest.prototype.uninit=function(){this.emit("uninit");if(this.timeout_handle)clearTimeout(this.timeout_handle);var event,i;for(event in this.bws_events){for(i=0;i<this.bws_events[event].length;i++)this.bws.off(event,this.bws_events[event][i])}for(event in this.player_events){for(i=0;i<this.player_events[event].length;i++)this.bws.player_off(event,this.player_events[event][i])}this.analysis_checkpoint();clearInterval(this.analysis_int);if(!this.start_test){util.log_report({id:"log",cdn:this.bws.cdn_svc,add_log:this.CG("util.log.report.start.add_log"),add_unittest:this.CG("util.log.report.start.unittest")})}};E.Unittest.prototype.resume=function(){this.time_since();this.set("resume");this.last_cmd="resume"};E.Unittest.prototype._continue=function(){this.time_since();this.set("continue");this.last_cmd="continue"};E.Unittest.prototype.suspend=function(){this.time_since();this.set("suspend");this.last_cmd="suspend"};E.Unittest.prototype.pause=function(){this.time_since();this.set("pause");this.last_cmd="pause"};E.Unittest.prototype.bws_set_progress_all=function(){this.bws.streams.forEach(function(stream){this.set_progress_all(stream)},this)};E.Unittest.prototype.set_progress_all=function(stream){stream.reqs.forEach(function(r){this.req_log_progress(r)},this)};E.Unittest.prototype.set_completed=function(stream,completed){var _this=this,q=this.resp_q[stream.uid];if(this.bws.adaptive)q.serve.push({jump:true,index:completed,from:0,to:-1});else q.serve.push({jump:true,from:stream.completed,to:completed});this.set_progress_all(stream);this.set("vc"+stream.uid+">offset("+completed+"B)");this.last_cmd="offset"};E.Unittest.prototype.stream_start=function(stream,opt){var reqs=opt.reqs,id=opt.id,cb,cb2;if(stream.uid===undefined){stream.uid=+id||this.vc_id;this.vc_id=stream.uid+1}this.resp_q[stream.uid]=this.resp_q[stream.uid]||{loaded:this.bws.adaptive?{index:this.bws.method.start_index()||this.bws.method.first_index(),from:0,to:-1}:stream.from,serve:[]};this.stream_info[stream.uid]={rate:0,segment:0};if(this.adaptive&&!reqs){if(this.hola_adaptive){this.set("vc"+stream.uid+">req("+(stream.from?stream.from+"B-"+(stream.to>-1?stream.to+1:-1)+"B ":"")+"verify)");cb=this.try_wrapper(this.allow_early_req);cb2=this.try_wrapper(this.req_resp);stream.on("allow_early_req",cb);stream.on("allow_finish",cb2);this.on("uninit",function(){stream.off("allow_early_req",cb);stream.off("allow_finish",cb2)})}return}this.time_since();this.set("vc"+stream.uid+">req("+(opt.start||stream.from)+"B-"+stream.to+"B"+(stream.slice?" slice "+stream.slice+"B":"")+(this.hola_adaptive?" qid "+stream.bws.method.qid:"")+(stream.bitrate?" bitrate "+stream.bitrate:"")+(stream.map.sum?" map "+JSON.stringify(stream.map):"")+(reqs?" init "+JSON.stringify(reqs):"")+(stream.monitor_start?" monitor_ms "+Math.round(Math.max(500-(date.monotonic()-stream.monitor_start),0)):"")+(this.bws.player.is_paused()?" paused":"")+(stream.completed>(opt.start||stream.from)?" completed "+stream.completed:"")+")");cb=this.try_wrapper(this.allow_early_req);cb2=this.try_wrapper(this.req_resp);stream.on("allow_early_req",cb);stream.on("allow_finish",cb2);this.on("uninit",function(){stream.off("allow_early_req",cb);stream.off("allow_finish",cb2)});this.last_cmd="vc_req"};E.Unittest.prototype.method_init=function(method){if(method.type=="hola_adaptive"){var seek_cb=this.try_wrapper(this.onseek);var pl_cb=this.try_wrapper(this.on_playlist_update);var sq_cb=this.try_wrapper(this.on_set_quality);var res_cb=this.try_wrapper(this.on_resolution_change);var pl_req_cb=this.try_wrapper(this.on_playlist_req);var pl_resp_cb=this.try_wrapper(this.on_playlist_resp);var keymap_info_cb=this.try_wrapper(this.on_keymap_info);var set_fullsize_cb=this.try_wrapper(this.on_set_fullsize);method.on("seek_complete",seek_cb);method.on("update_playlists",pl_cb);method.on("set_quality",sq_cb);method.on("resolution_change",res_cb);method.on("playlist_req",pl_req_cb);method.on("playlist_resp",pl_resp_cb);method.on("keymap_info",keymap_info_cb);method.on("set_fullsize",set_fullsize_cb);this.on("uninit",function(){method.off("seek_complete",seek_cb);method.off("update_playlists",pl_cb);method.off("set_quality",sq_cb);method.off("resolution_change",res_cb);method.off("playlist_req",pl_req_cb);method.off("playlist_resp",pl_resp_cb);method.off("keymap_info",keymap_info_cb);method.off("set_fullsize",set_fullsize_cb)});this.hola_adaptive=true;this.gen_playlist();this.initial_playlist=this.playlist}};E.Unittest.prototype.analysis_cb=function(){var run=function(path,sid){var ex;try{if(!this.bws.zone.conf_apply(path,[],undefined,this.bws,true)){return false}}catch(e){ex=e.message}util.log_report({exception:ex,id:"analysis",cdn:this.bws.cdn_svc,add_unittest:!ex,add_log:!ex,analysis_tag:Object.assign({},this.CG("analysis.tag"),{sid:sid})});if(this.log)this.log.notice("sending log report %s",sid);return true}.bind(this);var snippets=this.CG("analysis.js",[]);snippets.forEach(function(s,i){if(s.disable_cdn||s.mode!="multi"&&s.count>0)return;if(run("analysis.js."+i+".js",s.id))s.count=s.count+1||1});if(snippets.every(function(s){return s.mode!="multi"&&s.count>0}))this.analysis_int=clearInterval(this.analysis_int)};E.Unittest.prototype.set_play=function(){this.set_player_state("play")};E.Unittest.prototype.set_pause=function(){this.set_player_state("pause")};E.Unittest.prototype.set_waiting=function(){this.set_player_state("waiting")};E.Unittest.prototype.set_player_state=function(state){this.time_since();this.set("set_player_state("+state+")");if(state=="waiting_js")this.bws_set_progress_all();this.last_cmd="set_player_state"};E.Unittest.prototype.on_player_detach=function(){this.time_since();this.bws_set_progress_all();this.set("player_detach");this.last_cmd="on_player_detach"};E.Unittest.prototype.on_frag_loading=function(idx){this.time_since();this.bws_set_progress_all();this.set("frag_loading("+idx+")");this.last_cmd="on_frag_loading"};E.Unittest.prototype.on_set_fullsize=function(stream){this.time_since();this.set("file("+stream.fullsize+"B dynamic)");this.last_cmd="set_fullsize"};E.Unittest.prototype.set_max_reqs=function(stream){if(this.max_num_reqs==stream.max_num_reqs)return;this.time_since();this.set("vc"+stream.uid+">set_max_reqs("+stream.max_num_reqs+")");this.max_num_reqs=stream.max_num_reqs;this.last_cmd="set_max_reqs"};E.Unittest.prototype.next_single=function(cdn){this.extra_singles.push({hostname:cdn.hostname,cost:cdn.cost||1,owner:cdn.owner||"hola",host:cdn.host,role:"single_copy"})};E.Unittest.prototype.local_get_cdns=function(cdns,role){if(!cdns)return;cdns.forEach(function(c){this.local_cdns.push({hostname:c.hostname,cost:c.cost||(role=="fast"?5:1),owner:c.owner||"hola",host:c.host,role:role})},this)};E.Unittest.prototype.track_state=function(){this.time_since();this.bws_set_progress_all()};E.Unittest.prototype.add_segment=function(segment,stream,caller){this.time_since();this.set("vc"+stream.uid+">"+(caller=="init_segment"?"req":"readd")+"("+(segment.to?"srange "+segment.from+"B"+"-"+(segment.to+1)+"B ":"")+"qid "+(segment.qid||segment.playlist_id)+" hls t"+segment.index+" dur "+segment.dur+(segment.bitrate&&segment.bitrate!=segment.qid?" bitrate "+segment.bitrate:"")+")");this.last_cmd="vc_req"};return E});
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;var is_rn=typeof navigator=="object"&&navigator.product=="ReactNative";if(is_rn){define=require("./require_node.js").define(module,"../",require("/util/array.js"))}else if(is_node_ff)define=require("./require_node.js").define(module,"../");else define=define||self.define;define("/util/string.js",["/util/array.js"],function(array){var E={};E.rm_empty_last=function(a){if(a[a.length-1]==="")a.pop();return a};E.split_trim=function(s,sep,limit){return array.compact_self(s.split(sep,limit))};E.split_ws=function(s){return E.split_trim(s,/\s+/)};E.qw=function(s){return E.split_ws(!Array.isArray(s)?s:E.es6_str(arguments))};E.chomp=function(s){return s.replace(/\n$/,"")};E.split_crlf=function(s){return E.rm_empty_last(s.split(/\r?\n/))};E.split_nl=function(s){return E.rm_empty_last(s.split("\n"))};E.to_array_buffer=function(s){var buf=new ArrayBuffer(s.length),buf_view=new Uint8Array(buf),i;for(i=0;i<s.length;i++)buf_view[i]=s.charCodeAt(i);return buf};E.from_array_buffer=function(buf){return String.fromCharCode.apply(null,new Uint8Array(buf))};E.capitalize=function(s){s=""+s;return(s[0]||"").toUpperCase()+s.slice(1)};E.trunc=function(s,len){if(s.length<=len)return s;return s.slice(0,len)+"..."};E.template=function(strings){var keys=Array.prototype.slice.call(arguments,1);return function(){var values=arguments;var dict=values[values.length-1]||{};var result=[strings[0]];keys.forEach(function(key,i){var value=Number.isInteger(key)?values[key]:dict[key];result.push(value,strings[i+1])});return result.join("")}};E.es6_str=function(args){var parts=args[0],s="";if(!Array.isArray(parts))return parts;s+=parts[0];for(var i=1;i<parts.length;i++){s+=args[i];s+=parts[i]}return s};E.align=function(){var str=E.es6_str(arguments),lines=str.split("\n");if(!lines[0])lines.shift();var spaces=Infinity;for(var i=0;i<lines.length;i++){var space=lines[i].match(/^\s*/)[0];if(space.length==lines[i].length)space=lines[i]="";else spaces=Math.min(spaces,space.length)}if(spaces>0&&spaces!=Infinity)lines=array.sed(lines,new RegExp("^ {"+spaces+"}"),"");return lines.join("\n")};E.nl2sp=function(){return E.es6_str(arguments).replace(/\n\s*/g," ")};E.detach=function(s){return(" "+s).slice(1)};E.hash=function(s){var hash=0;for(var i=0,l=s.length;i<l;i++)hash=(hash<<5)-hash+s.charCodeAt(i)>>>0;return hash};var alphabet="0123456789abcdefghijklmnopqrstuvwxyz";E.generate=function(len){len=len||12;var ret="";for(var i=0;i<len;i++)ret+=alphabet[Math.random()*alphabet.length|0];return ret};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else define=require("../../../util/require_node.js").define(module,"../");define("/svc/cdn/pub/timeline.js",["/util/util.js","/util/date.js","/util/escape.js","/util/array.js","/util/string.js"],function(zutil,date,zescape,array,string){var E=Timeline;var qw=string.qw;var dict=["loader_ts","nav_start","page_load","stats_init","url_change","name","ts","elapsed","pos","duration","buf_from","buf_to","state","paused","bitrate","live","ad_playing","width","height","full_screen","autostart","document_visibility","use_ad_suspend","ad_scheme","url","attached","info_state","cur_state","no_adblock","ad_play","play","video_time","eduration","eposition","ad_time","duration_change","play_start","pos_prev","res_width","res_height","ended","get_stats","frames","dropped","fps","fps_play_sec","document_hidden","document_visible","info_waiting_event","buf_wait_begin","check_waiting","buf_wait_end","no_fps_begin","no_fps_end","adblock","status","status_text","response_text","freeze_begin","freeze_end","ad_skipped","pause","resume","reset_ts","visibility_end","reset_stats","visibility_start","switch_n","beforeunload","ad_impression","no_fps_over_10sec","unique_view_sec","player_error","no_duration_change","bitrate_rank","rank","res_full_screen","info_seek","seek","info_seeked","seeked","seek_pos","seek_start","duration_change_over_1min","ad_start","ad_complete","timeshift","suspend","restore","slave_pos","slave_state","ad_pause","disable_fps","missing_ended","ad_error","src_change","from","to","restore_start","native_hls","fps_start_1","fps_start_10","fps_start_100","no_bitrate","segment","fallback","disable_ad_stats","ad_error_with_adblock","scrub_begin","scrub_end","events","first_fragment","req_id","frag_url","fragment_js_start_ts1","loadtime","fragment_js_start_ts2","fragment_js_seek_ts1","fragment_js","low_fps_begin","low_fps_end","high_fps_begin","high_fps_end","diff","bandwidth","perf","period","type","ms","n","disable_missing_bitrate","manifest_parsed","fragment_js_start_ts3","ad_request","ad_type","fragment_js_seek_ts2","disable_ad_start","wait_begin","wait_end","bws.slice_sz","slice_sz","slice_sec","method","fragment_loadtime_start_ts1","fragment_loadtime_start_ts2","fragment_loadtime_start_ts3","fragment_loadtime_seek_ts1","fragment_loadtime_seek_ts2","fragment_loadtime_seek_ts3","fragment_loadtime","ad_block","fragment_js_seek_ts3","high_bitrate_begin","high_bitrate_end","ad_suspend","ad_restore","wait2_begin","wait2_d_pd","wait2_d","wait2_pd","wait2_end","seg_stats","dm_segment","dm_keyframes","dm_dropped","dm_avunsyc","dm_audio_gap","dm_video_gap","lag","mem","vjs_hds","clock_skew","reason","pos_wait_begin","pos_wait_end","pos_wait_over_10sec","buf_wait_over_10sec","ready_state","buf_sec","last_pos","system","ad_active","ad_state"];E.t={dict:dict};var dict_2_str={};var dict_from_str={};for(var pi=0;pi<dict.length;pi++){dict_from_str[dict[pi]]=pi;dict_2_str[pi]=dict[pi]}function Timeline(opt){this.opt=opt||{};this.last=date.monotonic();this.arr=[];var _this=this;if(!is_node&&window.performance){if(this.opt.ts)this.arr.push({name:"loader_ts",ts:this.opt.ts});var t=window.performance.timing;if(t){this.arr.push({name:"nav_start",ts:window.performance.now?0:t.navigationStart,elapsed:0});if(t.domContentLoadedEventEnd){this.arr.push({name:"page_load",ts:t.domContentLoadedEventEnd,elapsed:t.domContentLoadedEventEnd-t.navigationStart})}}else{document.addEventListener("DOMContentLoaded",function(event){_this.push("page_load")})}}this.push("stats_init")}Timeline.prototype.find=function(names,ops){names=array.to_array(names);ops=ops||{order:"last"};var i,arr=this.arr;if(ops.order=="last")for(i=arr.length-1;i>=0&&!names.includes(arr[i].name);i--);else for(i=0;i<arr.length&&!names.includes(arr[i].name);i++);return i<arr.length&&i>=0?arr[i]:null};Timeline.prototype.elapsed_from=function(name){function handle_arg(arg){var o=arg.split("=")[0],val=arg.split("=")[1];switch(o){case"order":ops.order=val;break}}var ops={order:"last"};var m=name.match(/(([a-z,-_=]+):)?([a-z0-9_,]+)/);if(m[2])m[2].split(",").forEach(handle_arg);var e=this.find(m[3]?m[3].split(","):[name],ops);if(e)return date.monotonic()-e.ts};function is_seek(name){return/^(seek|info_seek)$/.test(name)}Timeline.prototype.push=function(name,params){var now=date.monotonic(),diff=now-this.last;var e=Object.assign({},{name:name,ts:now,elapsed:diff},params);var arr=this.arr,len=this.arr.length;for(var n in e){if(e[n]===undefined)delete e[n]}if(len&&is_seek(e.name)){if(arr[len-1].name=="seek"&&e.elapsed<100){e.name="scrub_begin";this.seek_count=1}else if(arr[len-1].name=="scrub_begin"){if(e.name=="info_seek")this.seek_count++;return}}if(e.name!="scrub_begin"&&e.name!="scrub_end"&&len&&arr[len-1].name=="scrub_begin"){this.push("scrub_end",{events:this.seek_count});this.push(name,params);return}arr.push(e);if(this.opt.log)this.opt.log(JSON.stringify(e));this.last=now;return diff};Timeline.prototype.last_name=function(){return this.arr[this.arr.length-1].name};Timeline.from_str=function(s){var timeline=new Timeline,a=qw(s),last,val,diff_mode=false;var cache={},pn;timeline.arr=[];for(var i=0;i<a.length;i++){var m=a[i].match(/^([^:]*):([0-9\.]+)(,(.+))?$/);if(!m||m.length!=3&&m.length!=5)throw new Error("invalid timeline");var name=dict_2_str[m[1]]||m[1];var ts=(diff_mode?last:0)+ +m[2];var o=Object.assign({},name in cache?cache[name]:{},{name:name,ts:ts});o.elapsed=last===undefined?0:ts-last;last=ts;if(m[4]){var w=zescape.parse.http_words(m[4]);if(w.length&&(dict_2_str[w[0][0]]||w[0][0])=="ts"){o.ts=+w[0][1];o.elapsed=i==0?0:o.ts-last;last=o.ts;diff_mode=true;w.shift()}for(var j=0;j<w.length;j++){pn=dict_2_str[w[j][0]]||w[j][0];val=w[j][1];if(val=="true")val=true;else if(val=="false")val=false;else if(!isNaN(+val))val=+val;if(val=="undefined")delete o[pn];else o[pn]=val}}cache[name]=o;timeline.arr.push(o);timeline.frames=Math.max(timeline.frames||0,o.frames||0)}return timeline};Timeline.prototype.to_str=function(with_get_stats){var s="",arr=Array.from(this.arr),now=date.monotonic();var last_ts=-1,s2,ts,name,cache={},q;if(with_get_stats)arr.push({name:"get_stats",ts:now,elapsed:now-this.last});for(var i=0;i<arr.length;i++){name=arr[i].name;ts=arr[i].ts;if(name=="stats_init"){s2=":0,ts="+ts;last_ts=ts}else if(last_ts!=-1){s2=":"+Math.floor((ts-last_ts)*1e4)/1e4;last_ts=ts}else s2=":"+ts;var c=name in cache?cache[name]:cache[name]={};s2=(dict_from_str[name]||name)+s2;for(var n in arr[i]){if(!["name","ts","elapsed"].includes(n)&&c[n]!=arr[i][n]){ts=arr[i][n];q=typeof ts=="string"?'"':"";if(typeof ts=="number"&&isFinite(ts))ts=""+Math.floor(ts*1e5)/1e5;s2+=","+(dict_from_str[n]||n)+"="+q+zescape.html(""+ts).replace(/ /g,"_").replace(/\n/g,"")+q}}for(var p in cache[name]){if(!(p in arr[i])&&!["name","ts","elapsed"].includes(p))s2+=","+p+"=undefined"}cache[name]=arr[i];s+=(s?" ":"")+s2}return s};Timeline.prototype._get_stats=function(arr,opt){opt=opt||{};function _throw(s){if(opt.debug)return console.error("Error "+s);throw new Error(s)}function stats_inc(event,ms,_opt){_opt=_opt||{};var no_max=_opt.no_max,n=_opt.n,max_n=_opt.max_n;var prefix=_opt.paused?"paused_":"";var max_ms=Math.max(10*date.ms.SEC,_opt.max_ms||0);var dropoff_ms=Math.max(date.ms.MIN,_opt.dropoff_ms||0);var postfix=!no_max&&ms>max_ms?"_over_max":no_max&&_opt.min_ms&&ms<_opt.min_ms?"_under_min":"";var s=prefix+event+postfix;if(!zutil.is_mocha()){var _s="_"+s.replace("_waiting","").replace("_over_max","");stats[_s+"_n"]=(stats[_s+"_n"]||0)+(n||1);stats[_s+"_ms"]=(stats[_s+"_ms"]||0)+(ms||0)}if(!no_max&&max_ms<dropoff_ms&&ms>dropoff_ms){s=prefix+event+"_over_"+dropoff_ms/date.ms.MIN+"min";stats[s+"_n"]=(stats[s+"_n"]||0)+1;stats[s+"_ms"]=(stats[s+"_ms"]||0)+ms;if(opt.debug)console.debug("*** %s %dms #%d",prefix+event,ms,n||1);return}if(!ms&&!_opt.allow_zero)_throw(event+" too small");stats.events[event]=(stats.events[event]||0)+1;var _n=(stats[s+"_n"]||0)+(stats[s+"_over_"+max_n+"_n"]||0)+n;if(_n&&max_n&&_n>max_n){stats[s+"_over_"+max_n+"_n"]=_n;delete stats[s+"_n"];delete stats[s+"_ms"];return}if(n)stats[s+"_n"]=(stats[s+"_n"]||0)+n;else if(stats[s+"_ms"])_throw("multiple "+event);stats[s+"_ms"]=(stats[s+"_ms"]||0)+ms;if(opt.debug)console.debug("*** %s%s %dms #%d",prefix,event,ms,n||1)}function stats_inc_n(name,n){stats[name]=(stats[name]||0)+(n||1)}function inc_n_pos_unique_view_sec(s,a){stats[s+"_n"]=(stats[s+"_n"]||0)+1;if(stats[s+"_pos"]===undefined)stats[s+"_pos"]=a.pos;if(stats[s+"_unique_view_sec"]===undefined)stats[s+"_unique_view_sec"]=a.unique_view_sec}function get_suspend_type(a){var pos=a.pos||a.last_pos||0,dur=a.duration;return!play_started||pos<10?"pre_suspend":stats.ended_n||dur-pos<2?"post_suspend":"mid_suspend"}function get_restore_type(){return suspend_type.replace("suspend","restore")}function ignore_freeze(){return!video_started||seek_ts||play_ts}function play_start_from(){var ts=Math.max(playback_enabled_ts||0,play_ts||restore_ts||attached_ts);if(!zutil.is_mocha())stats._play_start_from_ts=ts;return ts}var stats={events:{}};var low_buffer_limit=.75*date.ms.SEC;var nav_start_ts,attached_ts,seek_ts,seeked_ts,buf_wait_ts,play_ts,s;var ignore_fps_wait,pos_wait_ts,scrub_ts,show_ts;var low_fps_ts,no_fps_ts,high_fps_ts,loader_ts;var prev_max,play_started,video_started,paused,started_paused;var attached_paused,native_hls,vjs_hds,suspend_type;var disable_missing_bitrate,document_hidden,play_started_ts;var disable_fps,missing_ended_ts,dt,suspend_ts,restore_ts;var manifest_parsed_ts,suspend_n=0,ms,suspend_on_start;var playback_enabled_ts,playback_enabled_check;var ignore_seek_stats;try{var i,a;for(i=0;i<arr.length;i++){a=arr[i];switch(a.name){case"adblock":stats.adblock=1;break;case"no_adblock":if(zutil.is_mocha())break;stats.no_adblock=1;break;case"adblock_css_found":stats.adblock_css_found_n=1;break;case"adblock_css_not_found":stats.adblock_css_not_found_n=1;break}}if(stats.adblock&&!stats.adblock_css_found_n)stats.adblock_test_mismatch_n=1;else if(stats.no_adblock&&!stats.adblock_css_not_found_n)stats.adblock_test_mismatch_n=1;for(i=0;i<arr.length;i++){a=arr[i];if(opt.debug){console.debug("%s elapsed %dms pos %fs %o",a.name,a.elapsed,a.pos,a)}if(a.pos<0){if(a.pos<-10)_throw("negative pos");stats.negative_pos=1}if(a.duration<0)_throw("negative duration");if(a.bitrate&&!stats.bitrate_first)stats.bitrate_first=a.bitrate;if(a.width||a.height){if(!stats.width)stats.width=a.width;if(!stats.height)stats.height=a.height;if(!stats.width_full&&a.full_screen)stats.width_full=a.width;if(!stats.height_full&&a.full_screen)stats.height_full=a.height;stats.last_width=a.width;stats.last_height=a.height}switch(a.name){case"loader_ts":loader_ts=a.ts;break;case"nav_start":nav_start_ts=a.ts;break;case"attached":if(attached_ts)_throw("multiple attached");attached_ts=a.ts;if(a.paused)paused=attached_paused=true;started_paused=!a.autostart;if(a.ad_scheme){stats.ad_scheme=typeof a.ad_scheme=="string"?a.ad_scheme.toLowerCase():undefined}native_hls=a.native_hls;disable_fps=a.disable_fps;disable_missing_bitrate=a.disable_missing_bitrate;if(!zutil.is_mocha()||a.document_visibility!==undefined)document_hidden=a.document_visibility!="visible";if(document_hidden){stats.hidden_n=1;stats.started_hidden_n=1;stats.always_hidden_n=1}else show_ts=a.ts;vjs_hds=a.vjs_hds;if(a.use_ad_suspend&&(a.ad_playing||a.ad_active)){suspend_on_start=true;suspend_ts=a.ts;suspend_type=get_suspend_type(a);suspend_n=stats[suspend_type+"_break_n"]=stats[suspend_type+"_try_n"]=1}if(a.buf_sec!=undefined)stats.attached_buf_sec=a.buf_sec;break;case"document_visible":if(!document_hidden)_throw("document already visible");show_ts=show_ts||a.ts;document_hidden=false;stats.show_n=(stats.show_n||0)+1;break;case"document_hidden":if(document_hidden)_throw("document already hidden");document_hidden=true;stats.hidden_n=(stats.hidden_n||0)+1;break;case"reset_stats":stats.reset_n=1;break;case"visibility_start":stats.visibility_start_n=1;stats.visibility_switch_n=a.switch_n;break;case"playback_enabled_check":playback_enabled_check=true;break;case"playback_enabled":if(a.reason=="testfailure"){stats.playback_test_failed_n=1;if(playback_enabled_ts)stats.playback_test_failed_restart_n=1;playback_enabled_ts=playback_enabled_check=undefined}else{if(playback_enabled_ts)stats.playback_test_restart_n=1;playback_enabled_ts=a.ts}break;case"ended":case"player_error":case"fallback":case"visibility_end":case"beforeunload":case"get_stats":if(document_hidden)stats.ended_hidden_n=1;if(a.name=="ended"){if(stats.visibility_end_n)_throw("ended after visibility_end");if(stats.beforeunload_n)_throw("ended after beforeunload");stats.ended_n=1;if(missing_ended_ts)stats_inc("missing_ended",a.ts-missing_ended_ts)}else if(a.name=="fallback")stats.fallback_n=1;else if(a.name=="player_error")stats.player_error_n=1;else if(a.name=="visibility_end"||a.name=="beforeunload"){if(!zutil.is_mocha()&&paused)stats.last_state_paused_n=1;if(stats.ended_n)_throw(a.name+" after ended");switch(a.name){case"visibility_end":stats.visibility_end_n=1;break;case"beforeunload":stats.beforeunload_n=1;break}}else{if(!zutil.is_mocha()&&paused)stats.last_state_paused_n=1;if(i!=arr.length-1)_throw("get_stats not last");if(opt.require_final_event&&!stats.ended_n&&!stats.visibility_end_n&&!stats.beforeunload_n&&!stats.player_error_n&&!stats.fallback_n){stats.switch_n=1}if(stats.ended_n||stats.visibility_end_n||stats.beforeunload_n||stats.player_error_n||stats.fallback_n){break}}if(suspend_ts){stats_inc(suspend_type+"_waiting",a.ts-suspend_ts,{max_ms:5*date.ms.MIN});if(!play_started){stats_inc(suspend_type+"_before_start_waiting",a.ts-suspend_ts,{max_ms:5*date.ms.MIN})}}else if(!play_started){if(attached_paused&&!play_ts)stats.paused_no_play_ms=a.ts-attached_ts;else if(playback_enabled_check&&!playback_enabled_ts)stats.playback_blocked_ms=a.ts-attached_ts;else{dt=a.ts-play_start_from();var sname=a.pos&&a.pos>1?"play_seek_start_waiting":"play_start_waiting";if(sname=="play_start_waiting"&&a.name=="visibility_end"){stats.hidden_before_start_n=1}stats_inc(sname,dt,{paused:started_paused,dropoff_ms:3*date.ms.MIN});if(suspend_n)stats_inc(get_restore_type()+"_waiting",dt);if(dt>10*date.ms.SEC){stats.left_on_stuck_n=1;stats.left_on_stuck_start_n=1;if(stats.hidden_before_start_n)stats.hidden_before_start_over_10sec_n=1}}}else if(restore_ts&&(suspend_type!="post_suspend"||!stats.ended_n)){stats_inc(get_restore_type()+"_waiting",a.ts-restore_ts);if(suspend_type!="post_suspend"){stats.left_on_stuck_n=1;stats["left_on_stuck_"+get_restore_type()+"_n"]=1}}else if(seek_ts){stats_inc("seek_waiting",a.ts-seek_ts,{paused:paused,allow_zero:true});stats.left_on_stuck_n=1;stats.left_on_stuck_seek_n=1}else if(play_ts){stats_inc("resume_waiting",a.ts-play_ts,{allow_zero:true});stats.left_on_stuck_n=1;stats.left_on_stuck_resume_n=1}else if(missing_ended_ts&&!stats.ended_n){stats_inc("missing_ended_waiting",a.ts-missing_ended_ts);stats.left_on_stuck_n=1;stats.left_on_stuck_missing_ended_n=1}else{if(a.ts-buf_wait_ts>=low_buffer_limit){if(!zutil.is_mocha()){stats_inc("buf_freeze_waiting",a.ts-buf_wait_ts,{allow_zero:true})}stats_inc("buf_wait_waiting",a.ts-buf_wait_ts,{allow_zero:true});if(disable_fps&&!zutil.is_mocha()){stats_inc("freeze_waiting",a.ts-buf_wait_ts,{allow_zero:true});stats_inc("wait_waiting",a.ts-buf_wait_ts,{allow_zero:true});stats.left_on_stuck_n=1;stats.left_on_stuck_wait_n=1}}}if(scrub_ts)stats_inc("scrub_waiting",a.ts-scrub_ts);if(low_fps_ts)stats_inc("low_fps_waiting",a.ts-low_fps_ts);if(pos_wait_ts){stats_inc("pos_freeze_waiting",a.ts-pos_wait_ts);if(disable_fps)stats_inc("freeze_waiting",a.ts-pos_wait_ts)}if(no_fps_ts){stats_inc("fps_freeze_waiting",a.ts-no_fps_ts);if(!disable_fps&&!zutil.is_mocha())stats_inc("freeze_waiting",a.ts-no_fps_ts);if(video_started&&seek_ts===undefined&&!play_ts&&!ignore_fps_wait){stats_inc("fps_wait_waiting",a.ts-no_fps_ts);if(!disable_fps&&!zutil.is_mocha()){stats_inc("wait_waiting",a.ts-no_fps_ts);stats.left_on_stuck_n=1;stats.left_on_stuck_wait_n=1}}}if(high_fps_ts){stats_inc("high_fps",a.ts-high_fps_ts,{n:1,no_max:true})}if(!stats.play_start_ms&&!stats.play_start_over_max_ms&&!stats.play_start_over_3min_n&&!stats.play_start_waiting_ms&&!stats.play_start_waiting_over_max_ms&&!stats.play_start_waiting_over_3min_n&&!stats.paused_play_start_ms&&!stats.paused_play_start_over_max_ms&&!stats.paused_play_start_over_3min_n&&!stats.paused_play_start_waiting_ms&&!stats.paused_play_start_waiting_over_max_ms&&!stats.paused_play_start_waiting_over_3min_n&&!stats.paused_no_play_ms&&!stats.playback_blocked_ms&&!stats.play_seek_start_ms&&!stats.play_seek_start_over_max_ms&&!stats.play_seek_start_over_3min_n&&!stats.play_seek_start_waiting_ms&&!stats.play_seek_start_waiting_over_max_ms&&!stats.play_seek_start_waiting_over_3min_n&&!stats.paused_play_seek_start_ms&&!stats.paused_play_seek_start_over_max_ms&&!stats.paused_play_seek_start_over_3min_n&&!stats.paused_play_seek_start_waiting_ms&&!stats.paused_play_seek_start_waiting_over_max_ms&&!stats.paused_play_seek_start_waiting_over_3min_n&&!stats.pre_suspend_ms&&!stats.pre_suspend_over_max_ms&&!stats.pre_suspend_over_1min_n&&!stats.pre_suspend_waiting_ms&&!stats.pre_suspend_waiting_over_max_ms&&!stats.pre_suspend_waiting_over_1min_n){_throw("unexpected stats")}break;case"play_start":if(!attached_ts)_throw("missing attached");if(play_started)_throw("multiple play_start");if(buf_wait_ts)_throw("play_start without buf_wait_end");if(attached_paused&&!play_ts)_throw("missing play");if(playback_enabled_check&&!playback_enabled_ts)_throw("play_start without playback_enabled");dt=a.ts-play_start_from();if(a.pos&&a.pos>1){if(!show_ts)stats.start_before_show_n=1;stats_inc("play_seek_start",dt,{paused:started_paused,dropoff_ms:3*date.ms.MIN})}else{if(!show_ts)stats.start_before_show_n=1;stats_inc("play_start",dt,{paused:started_paused,dropoff_ms:3*date.ms.MIN})}if(suspend_n)stats_inc(get_restore_type(),dt);if(no_fps_ts)ignore_fps_wait=true;video_started=play_started=true;play_started_ts=a.ts;play_ts=undefined;restore_ts=undefined;if(nav_start_ts!==undefined)stats.time_to_play_ms=a.ts-nav_start_ts;break;case"restore_start":if(video_started)_throw("multiple restore");video_started=true;stats_inc(get_restore_type(),a.ts-restore_ts,{n:1});restore_ts=undefined;break;case"seek":ignore_seek_stats=false;if(a.system){stats.ignore_seek_n=(stats.ignore_seek_n||0)+1;break}if(!video_started){_throw("seek before "+(!play_started?"play_start":get_restore_type()))}if(play_ts){stats.seek_before_resume_n=(stats.seek_before_resume_n||0)+1;play_ts=undefined}seek_ts=a.ts;seeked_ts=undefined;if(no_fps_ts)ignore_fps_wait=true;break;case"seeked":if(no_fps_ts)ignore_fps_wait=true;if(ignore_seek_stats||a.system){stats.ignore_seeked_n=(stats.ignore_seeked_n||0)+1;break}if(!seek_ts){seeked_ts=seek_ts=undefined;stats.seeked_without_seek_n=(stats.seeked_without_seek_n||0)+1;break}seeked_ts=a.ts;if(paused){if(buf_wait_ts)_throw("paused seeked without buf_wait_end");stats_inc("seek",a.ts-seek_ts,{paused:true,n:1});seeked_ts=seek_ts=undefined}break;case"seek_start":if(no_fps_ts)ignore_fps_wait=true;if(ignore_seek_stats||a.system){stats.ignore_seek_start_n=(stats.ignore_seek_start_n||0)+1;break}if(paused)_throw("seek_start in paused");if(!seeked_ts){seeked_ts=seek_ts=undefined;stats.seek_start_without_seeked_n=(stats.seek_start_without_seeked_n||0)+1;break}if(buf_wait_ts)_throw("seek_start without buf_wait_end");stats_inc("seek",a.ts-seek_ts,{paused:paused,n:1});seeked_ts=seek_ts=undefined;break;case"scrub_begin":if(scrub_ts)throw new Error("scrub_begin without scrub_end");scrub_ts=a.ts;break;case"scrub_end":if(!scrub_ts)throw new Error("scrub_end without scrub_begin");stats_inc("scrub",a.ts-scrub_ts,{n:1});scrub_ts=undefined;break;case"resume":if(paused)_throw("resume while paused");if(play_ts===undefined)_throw("resume without play");if(buf_wait_ts)_throw("resume without buf_wait_end");stats_inc("resume",a.ts-play_ts,{paused:paused,n:1,allow_zero:true});play_ts=undefined;break;case"ad_suspend":case"suspend":suspend_n++;if(suspend_ts){if(suspend_on_start)break;_throw("suspend in suspended")}suspend_ts=a.ts;suspend_type=get_suspend_type(a);if(!restore_ts)stats_inc_n(suspend_type+"_break_n");stats_inc_n(suspend_type+"_try_n");restore_ts=undefined;video_started=false;if(suspend_type=="pre_suspend"&&play_started){stats_inc("pre_suspend_after_play_start",a.ts-play_started_ts,{no_max:true})}break;case"restore":case"ad_restore":suspend_on_start=false;if(!suspend_ts)_throw("restore but not suspended");ms=a.ts-suspend_ts;if(a.ad_empty||ms<5*date.ms.SEC){s=suspend_type+(stats.adblock?"_blocked":a.ad_empty?"_empty":"_error");stats_inc(s,ms,{n:1,no_max:true,allow_zero:true})}else{s=suspend_type;stats_inc(s,ms,{n:1,no_max:true,min_ms:10*date.ms.SEC})}if(opt.debug)console.debug("*** %s %dms #%d",s,ms,1);suspend_ts=undefined;seeked_ts=seek_ts=play_ts=undefined;paused=attached_paused=!!a.paused;restore_ts=a.ts;break;case"buf_wait_begin":if(paused)_throw("buf_wait_begin in paused");if(buf_wait_ts)_throw("buf_wait_begin after buf_wait_begin");buf_wait_ts=a.ts;break;case"buf_wait_over_10sec":if(paused)_throw("buf_wait_over_10sec in paused");if(buf_wait_ts===undefined)_throw("buf_wait_over_10sec without buf_wait_begin");inc_n_pos_unique_view_sec("buf_freeze_over_10sec",a);if(disable_fps)inc_n_pos_unique_view_sec("freeze_over_10sec",a);break;case"buf_wait_end":if(paused)_throw("buf_wait_end in paused");if(buf_wait_ts===undefined)_throw("buf_wait_end without buf_wait_begin");if(a.ts-buf_wait_ts>=low_buffer_limit&&!zutil.is_mocha()){stats_inc("buf_freeze",a.ts-buf_wait_ts,{n:1,max_n:50});if(disable_fps){stats_inc("freeze",a.ts-buf_wait_ts,{n:1,max_n:50})}}if(!ignore_freeze()&&a.ts-buf_wait_ts){if(a.ts-buf_wait_ts<low_buffer_limit)stats_inc("low_buffer",a.ts-buf_wait_ts,{n:1});else{stats_inc("buf_wait",a.ts-buf_wait_ts,{n:1,max_n:zutil.is_mocha()?3:50});if(disable_fps&&!zutil.is_mocha()){stats_inc("wait",a.ts-buf_wait_ts,{n:1,max_n:zutil.is_mocha()?3:50})}}}buf_wait_ts=undefined;break;case"play":if(!paused){if(!play_started)break;_throw("play while playing")}if(seek_ts!==undefined){if(ignore_seek_stats)stats.play_in_seek_n=(stats.play_in_seek_n||0)+1;else{ignore_seek_stats=true;stats.play_in_paused_seek_n=(stats.play_in_paused_seek_n||0)+1}seeked_ts=seek_ts=undefined}paused=false;play_ts=a.ts;stats.play_n=(stats.play_n||0)+1;break;case"pause":if(paused)_throw("pause while paused");if(!play_started)attached_paused=started_paused=true;paused=true;play_ts=undefined;if(seek_ts){ignore_seek_stats=true;stats.pause_in_seek_n=(stats.pause_in_seek_n||0)+1;seek_ts=seeked_ts=undefined}else stats.pause_n=(stats.pause_n||0)+1;break;case"no_bitrate":stats.no_bitrate_n=(stats.no_bitrate_n||0)+1;break;case"bitrate":if(!a.bitrate){if(native_hls||vjs_hds)break;if(!play_started)break;if(disable_missing_bitrate)break;_throw("missing bitrate")}if(stats.bitrate_last==a.bitrate)break;prev_max=stats.bitrate_max;stats.bitrate_n=(stats.bitrate_n||0)+1;stats.bitrate_last=a.bitrate;stats.bitrate_min=stats.bitrate_min?Math.min(stats.bitrate_min,a.bitrate):a.bitrate;stats.bitrate_max=Math.max(stats.bitrate_max||0,a.bitrate);if(prev_max!=stats.bitrate_max){if(stats.pause_n)delete stats.bitrate_max_ms;else stats.bitrate_max_ms=a.ts-attached_ts}break;case"pos_wait_begin":if(pos_wait_ts)_throw("pos_wait_begin after pos_wait_begin");pos_wait_ts=a.ts;break;case"pos_wait_over_10sec":if(!pos_wait_ts)_throw("pos_wait_over_10sec without pos_wait_begin");inc_n_pos_unique_view_sec("pos_freeze_over_10sec",a);inc_n_pos_unique_view_sec("pos_freeze_over_10sec"+(a.buf_to-a.pos>10?"_high_buf":"_low_buf"),a);if(disable_fps)inc_n_pos_unique_view_sec("freeze_over_10sec",a);break;case"pos_wait_end":if(pos_wait_ts===undefined)_throw("pos_wait_end without pos_wait_begin");if(a.ts-pos_wait_ts<date.ms.SEC){stats.pos_freeze_under_1sec_n=(stats.pos_wait_under_1sec_n||0)+1}else{stats_inc("pos_freeze",a.ts-pos_wait_ts,{n:1,max_n:50});if(disable_fps){stats_inc("freeze",a.ts-pos_wait_ts,{n:1,max_n:50})}}pos_wait_ts=undefined;break;case"low_fps_begin":if(disable_fps)break;if(low_fps_ts)_throw("low_fps_begin after low_fps_begin");low_fps_ts=a.ts;break;case"low_fps_end":if(disable_fps)break;if(low_fps_ts===undefined)_throw("low_fps_end without low_fps_begin");if(a.ts-low_fps_ts<date.ms.SEC){stats.low_fps_under_1sec_n=(stats.low_fps_under_1sec_n||0)+1}else stats_inc("low_fps",a.ts-low_fps_ts,{n:1,max_n:50});low_fps_ts=undefined;break;case"no_fps_over_10sec":if(disable_fps)break;if(!no_fps_ts)_throw("no_fps_over_10sec without no_fps_begin");inc_n_pos_unique_view_sec("fps_freeze_over_10sec",a);inc_n_pos_unique_view_sec("fps_freeze_over_10sec"+(a.buf_to-a.pos>.5?"_has_buf":"_no_buf"),a);inc_n_pos_unique_view_sec("freeze_over_10sec",a);break;case"no_fps_begin":if(disable_fps)break;if(no_fps_ts)_throw("no_fps_begin after no_fps_begin");no_fps_ts=a.ts;if(seek_ts||seeked_ts)ignore_fps_wait=true;break;case"no_fps_end":if(disable_fps)break;if(no_fps_ts===undefined)_throw("no_fps_end without no_fps_begin");if(a.ts-no_fps_ts<date.ms.SEC){stats.fps_freeze_under_1sec_n=(stats.fps_freeze_under_1sec_n||0)+1}else{stats_inc("fps_freeze",a.ts-no_fps_ts,{n:1,max_n:50});if(!zutil.is_mocha())stats_inc("freeze",a.ts-no_fps_ts,{n:1,max_n:50});if(!ignore_freeze()&&!ignore_fps_wait){stats_inc("fps_wait",a.ts-no_fps_ts,{n:1,max_n:50});if(!disable_fps&&!zutil.is_mocha()){stats_inc("wait",a.ts-no_fps_ts,{n:1,max_n:50})}}}no_fps_ts=undefined;ignore_fps_wait=false;break;case"high_fps_begin":if(disable_fps)break;if(high_fps_ts)_throw("high_fps_begin after high_fps_begin");high_fps_ts=a.ts;break;case"high_fps_end":if(disable_fps)break;if(high_fps_ts===undefined)_throw("high_fps_end without high_fps_begin");stats_inc("high_fps",a.ts-high_fps_ts,{n:1,no_max:true});high_fps_ts=undefined;break;case"missing_ended":missing_ended_ts=a.ended;break;case"url_change":stats.url_change_n=(stats.url_change_n||0)+1;break;case"clock_skew":stats_inc("clock_skew",a.diff,{n:1,no_max:true});break;case"manifest_parsed":if(manifest_parsed_ts)_throw("multiple manifest_parsed");stats_inc("manifest_parsed",a.ts-attached_ts);manifest_parsed_ts=a.ts;break;case"fragment_js_start_ts1":case"fragment_js_start_ts2":case"fragment_js_start_ts3":case"fragment_js_seek_ts1":case"fragment_js_seek_ts2":case"fragment_js_seek_ts3":case"fragment_js":case"fragment_loadtime_start_ts1":case"fragment_loadtime_start_ts2":case"fragment_loadtime_start_ts3":case"fragment_loadtime_seek_ts1":case"fragment_loadtime_seek_ts2":case"fragment_loadtime_seek_ts3":case"fragment_loadtime":stats_inc(a.name,a.loadtime,{n:1});break;case"ad_skipped":case"ad_complete":case"ad_error":case"ad_block":case"ad_play":case"ad_request":case"ad_impression":case"ad_timeout":s=a.name+"_event_n";stats[s]=(stats[s]||0)+1;if(a.ad_type){s=a.ad_type+"_"+s;stats[s]=(stats[s]||0)+1}break;case"timeshift":stats.timeshift_n=(stats.timeshift_n||0)+1;break}}if(opt.ad||opt.all){stats.ad={preroll:get_ad_stats("pre",stats),midroll:get_ad_stats("mid",stats)}}if(!opt.all)delete stats.events}catch(e){if(opt.debug)console.error("Error %s %o",e.message||e,e);stats.error=""+(e.message||e);if(!opt.all)delete stats.events}return stats};function get_ad_stats(type,stats){var n,ad={};if(n=stats[type+"_suspend_break_n"]){ad.break_n=n;if(n=(stats.events[type+"_restore"]||0)+(stats[type+"_restore_over_1min_n"]||0)){ad.start_n=n}if(stats.events[type+"_restore_waiting"]||stats[type+"_restore_waiting_over_1min_n"]){ad.stuck_n=1}ad.try_n=stats[type+"_suspend_try_n"];if(stats.events[type+"_suspend_waiting"])ad.left_n=1;if(n=ad.try_n-(ad.left_n||0))ad.stay_n=n;if(n=(stats[type+"_suspend_n"]||0)+(stats[type+"_suspend_under_min_n"]||0)){ad.watched_n=n}if(n=stats[type+"_suspend_blocked_n"])ad.blocked_n=n;if(n=stats[type+"_suspend_empty_n"])ad.empty_n=n;if(n=stats[type+"_suspend_error_n"])ad.error_n=n}else ad.none_n=1;if(stats.paused_no_play_ms||stats.playback_blocked_ms)return ad.break_n?{discarded_n:1}:{};if(ad.break_n){var ctrl={break_n:(ad.start_n||0)+(ad.stuck_n||0)+(ad.left_n||0),try_n:(ad.watched_n||0)+(ad.blocked_n||0)+(ad.empty_n||0)+(ad.error_n||0)+(ad.left_n||0)};if(ad.break_n!=ctrl.break_n||ad.try_n!=ctrl.try_n)throw new Error("invalid ad stats")}return ad}Timeline.prototype.get_stats=function(opt){opt=opt||{};var arr=Array.from(this.arr),now=date.monotonic();if(!opt.debug)arr.push({name:"get_stats",ts:now,elapsed:now-this.last});return this._get_stats(arr,opt)};return E})})();
define("/svc/cdn/pub/stats.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/map.js","/util/util.js","/util/date.js","/svc/cdn/pub/timeline.js","/util/etask.js","/util/url.js","/util/sprintf.js","/util/events.js","/util/user_agent.js","/util/zerr.js","/svc/cdn/pub/load_perf.js","/util/conv.js","/util/ajax_lite.js"],function(util,map,zutil,date,timeline,etask,zurl,sprintf,events,user_agent,zerr,load_perf,conv,ajax){var E={};var assign=Object.assign;var guess=user_agent.guess();var is_android=guess.os=="android";var is_ios=guess.os=="ios";var is_webos=guess.os=="webos";function get_stats_timing(){if(!window.performance||!window.performance.getEntries)return;var timing={};if(window.performance.now)timing.loader=window.performance.now();var entries=window.performance.getEntries();var m=new RegExp("//player.h-cdn.com/(loader_[^/]+.js|"+"loader.js\\?.*customer=)");var m2=new RegExp("//hap.h-cdn.com/(hola_[^/]+_hls.js\\?.*customer=)");var loader,provider;for(var i=0;i<entries.length;i++){var e=entries[i];if(!loader&&m.test(entries[i].name)){timing.connect=e.connectEnd-e.connectStart;timing.dns=e.domainLookupEnd-e.domainLookupStart;timing.duration=e.duration;timing.redirect=e.redirectEnd-e.redirectStart;timing.response=e.responseEnd-e.responseStart;timing.response_end=e.responseEnd;if(timing.loader)timing.init=timing.loader-e.responseEnd;loader=true}if(!provider&&m2.test(entries[i].name)){timing.provider={};timing.provider.connect=e.connectEnd-e.connectStart;timing.provider.dns=e.domainLookupEnd-e.domainLookupStart;timing.provider.duration=e.duration;timing.provider.redirect=e.redirectEnd-e.redirectStart;timing.provider.response=e.responseEnd-e.responseStart;timing.provider.response_end=e.responseEnd;provider=true}if(loader&&provider)break}var t=window.performance.timing;if(t)timing.page_load=t.domContentLoadedEventEnd-t.navigationStart;return timing}var stats_timing;E.get_stats_timing=function(){return stats_timing};E.init=function(){stats_timing=get_stats_timing()};E.PlayerStats=function(opt){try{this.init(opt)}catch(e){this.uninit();throw e}};zutil.inherits(E.PlayerStats,events.EventEmitter);E.PlayerStats.prototype.init=function(opt){if(this.inited)return;this.inited=true;function update_avsync(values){if(!values||!values.length)return;stats.avsync_max=stats.avsync_max||0;stats.avsync_min=stats.avsync_min||Infinity;update_avsync.avsync_sum=update_avsync.avsync_sum||0;update_avsync.avsync_cnt=(update_avsync.avsync_cnt||0)+values.length;for(var i=0;i<values.length;i++){stats.avsync_max=Math.max(stats.avsync_max,values[i]);stats.avsync_min=Math.min(stats.avsync_min,values[i]);update_avsync.avsync_sum+=values[i]}stats.avsync_avg=update_avsync.avsync_sum/update_avsync.avsync_cnt}function update_bitrate_sec(name,prev_pos,pos){stats.bitrate_sec[name]=stats.bitrate_sec[name]||new map.Map({sum:0,size:-1,exclude_end:true});stats.bitrate_sec[name].update(prev_pos,pos)}function update_pos_val(name,prev_pos,pos,val){stats.pos_val[name]=stats.pos_val[name]||{sum:0,sec:0};stats.pos_val[name].sum=stats.pos_val[name].sum+(val||0)*(pos-prev_pos);stats.pos_val[name].sec=stats.pos_val[name].sec+(pos-prev_pos)}function update_bitrate(stats,pos,prev_pos){var ctx=update_bitrate;var res=player.get_resolution()||{width:0,height:0};if(res.width!=ctx.prev_res_width){ctx.prev_res_width=res.width;_this.push("res_width")}if(res.height!=ctx.prev_res_height){ctx.prev_res_height=res.height;_this.push("res_height")}if(!_this.adaptive||player.is_native_hls())return;var bitrate=player.get_bitrate();update_pos_val(util.get_width_name(res.width),prev_pos,pos,bitrate);update_pos_val(util.get_height_name(res.height),prev_pos,pos,bitrate);if(res.full_screen!=ctx.prev_res_full_screen){ctx.prev_res_full_screen=res.full_screen;_this.push("res_full_screen")}if(res.full_screen)update_pos_val("full",prev_pos,pos,bitrate);if(!bitrate){if(!player.is_bitrate_supported())return;ctx.no_bitrate_n=(ctx.no_bitrate_n||0)+1;if(ctx.no_bitrate_n>10)return;_this.push("no_bitrate");return}if(bitrate!=ctx.prev_bitrate)_this.push("bitrate",{bitrate:bitrate});ctx.prev_bitrate=bitrate;update_bitrate_sec(bitrate,prev_pos,pos)}this.zone=opt.zone;this.wrapper=opt.wrapper;this.cdn=opt.wrapper.cdn;this.log=this.zone.log_get().set_module("stats");this.perm_data=this.perm_data||{};var _this=this;var zperr=this.zone.perr_get();this.log.debug("new player stats");zperr({id:"stats_new",info:{only_stats:opt.only_stats}});this.opt=opt;var player=this.player=opt.player;var stats=this.stats={};this.timeline=new timeline({log:this.log.debug.bind(this.log),ts:opt.ts});this.start_time_tracker=new E.StartTimeTracker(this);this.use_ad_suspend=!this.zone.CG("player.disable_ad_suspend");stats.buf_n=stats.buf_sec=0;stats.bitrate_sec={};stats.pos_val={high:{sum:0,sec:0},low:{sum:0,sec:0},best:{sum:0,sec:0},unknown:{sum:0,sec:0},full:{sum:0,sec:0},width_300:{sum:0,sec:0},width_600:{sum:0,sec:0},width_900:{sum:0,sec:0},width_1200:{sum:0,sec:0},width_over_1200:{sum:0,sec:0},width_unknown:{sum:0,sec:0},height_200:{sum:0,sec:0},height_400:{sum:0,sec:0},height_800:{sum:0,sec:0},height_over_800:{sum:0,sec:0},height_unknown:{sum:0,sec:0}};stats.download_sec=new map.Map({sum:0,size:-1,exclude_end:true});this.fps=undefined;this.fps_poll=this.try_wrapper(function(){this.fps_poll.check()});this.fps_poll.check=function(){if(zutil.is_mocha()||this.fps_unsupported)return;var limit=20;if(player.is_idle()&&this.fps_poll.was_playing)return;if(!player.is_playing()||this.ended.n>1||this.playback_check_in_progress||player.get_media_type()=="audio"){return this.fps_poll.reset_ts()}this.fps_poll.was_playing=true;var f=player.get_decoded_frames(),ts=date.monotonic();if(f){stats.decoded_frames=f;stats.dropped_frames=player.get_dropped_frames()}if(f===undefined)return;if(!this.fps_poll.ts){this.fps_poll.ts={t0:{ts:ts,f:f},t1:{ts:ts,f:f}};return}var dt=ts-this.fps_poll.ts.t1.ts;var df=f-this.fps_poll.ts.t1.f;if(dt<.4*date.ms.SEC)return;var fps=this.fps=date.ms.SEC*df/dt;this.fps_poll.ts.t1={ts:ts,f:f};if(fps)stats.fps_play_sec=(stats.fps_play_sec||0)+dt/1e3;if(fps<=limit&&this.fps_poll.high_fps){this.fps_poll.high_fps=false;if(0)this.push("high_fps_end")}if(fps&&this.fps_poll.no_fps_ts){this.fps_poll.no_fps_ts=this.fps_poll.over_wait_ts=undefined;this.push("no_fps_end")}if(!fps&&!this.fps_poll.no_fps_ts){this.fps_poll.no_fps_ts=this.fps_poll.over_wait_ts=ts;this.push("no_fps_begin")}if((!fps||fps>limit)&&this.fps_poll.low_fps){this.fps_poll.low_fps=false;if(0)this.push("low_fps_end")}if(fps&&fps<=limit&&!this.fps_poll.low_fps){this.fps_poll.low_fps=true;if(0)this.push("low_fps_begin")}if(fps>limit&&!this.fps_poll.high_fps){this.fps_poll.high_fps=true;if(0)this.push("high_fps_begin")}if(fps>=limit){stats.fps_avg=this.fps_poll.avg.f=(this.fps_poll.avg.f*this.fps_poll.avg.t+fps*dt)/(this.fps_poll.avg.t+dt);this.fps_poll.avg.t=this.fps_poll.avg.t+dt}if(is_over_10sec(this.fps_poll.over_wait_ts)){this.fps_poll.over_wait_ts=undefined;this.push("no_fps_over_10sec",{unique_view_sec:stats.unique_view_sec.sum});if(!this.disable_fps_emit){var edata={ts:this.fps_poll.no_fps_ts,elapsed_ms:ts-this.fps_poll.no_fps_ts};if(player.html5&&player.html5.buffered){var video=player.html5,buffer=video.buffered;this.log.info("video froze at "+video.currentTime);var msg=["buffer:"];for(var i=0;i<buffer.length;i++)msg.push("["+buffer.start(i)+","+buffer.end(i)+"]");this.log.info(msg.join(" "))}player.emit("no_fps_over_10sec",edata);player.emit_external("hola.no_fps",edata);this.log.info("video froze for over 10sec")}}}.bind(this);this.fps_poll.avg={f:0,t:0};this.fps_poll.reset_ts=function(){if(!this.fps_poll.ts)return;var ts=date.monotonic(),dt=ts-this.fps_poll.ts.t1.ts;stats.fps_play_sec=(stats.fps_play_sec||0)+dt/1e3;if(this.fps_poll.no_fps_ts){this.fps_poll.no_fps_ts=this.fps_poll.over_wait_ts=undefined;this.push("no_fps_end",{reset_ts:1})}if(this.fps_poll.low_fps){this.fps_poll.low_fps=false;if(0)this.push("low_fps_end",{reset_ts:1})}if(this.fps_poll.high_fps){this.fps_poll.high_fps=false;if(0)this.push("high_fps_end",{reset_ts:1})}this.fps_poll.ts=undefined}.bind(this);this.download_poll=this.try_wrapper(function(){var b=player.get_current_buffer();if(!b)return;var c=player.get_pos();if(c<b.from||c>b.to){stats.invalid_current_buffer_n=(stats.invalid_current_buffer_n||0)+1;return}stats.download_sec.update(c,b.to);stats.buf_n++;stats.buf_sec+=b.to-c});stats.unique_view_sec=new map.Map({sum:0,size:-1,exclude_end:true});stats.no_fps_unique_view_sec=new map.Map({sum:0,size:-1,exclude_end:true});this.view_poll=this.try_wrapper(function(){var prev_pos=this.view_poll.view_prev_pos;var prev_frames=this.view_poll.view_prev_frames;var pos=player.get_pos();var frames=player.get_decoded_frames();this.view_poll.view_prev_pos=pos;this.view_poll.view_prev_frames=frames;var duration=player.get_duration();var prev_duration=stats.duration_sec;stats.duration_sec=duration||stats.duration_sec;if(prev_duration!=stats.duration_sec&&!zutil.is_mocha()&&!player.is_live_stream()){_this.push("duration_change",!stats.duration_sec?{no_duration_change:1}:stats.duration_sec-prev_duration>date.sec.MIN?{duration_change_over_1min:1}:{})}if(!isFinite(pos)||!isFinite(prev_pos)||!this.play_start)return;var d=pos-prev_pos;if(d<=0||d>2)return;var bws=this.cdn.attached_bws;var avsync=bws&&bws.parser&&bws.parser.type=="mp4"&&bws.parser.media_appender.get_avsync();var frames_unsupported=!Number.isFinite(frames)||(is_android||is_webos)&&frames==0||player.get_media_type()=="audio";if(frames_unsupported||frames-prev_frames>0){stats.unique_view_sec.update(prev_pos,pos);stats.view_sec=(stats.view_sec||0)+d}else if(frames!==undefined)stats.no_fps_unique_view_sec.update(prev_pos,pos);update_bitrate(stats,pos,prev_pos);update_avsync(avsync)});this.ended={};this.ended_poll=this.try_wrapper(function(){if(player.is_live_stream()||player.is_paused())return;var cur=player.html5?player.html5.currentTime:player.get_pos();var dur=player.html5?player.html5.duration:player.get_duration();if(!cur||!dur||!util.close_to_end(cur,dur))return;if(!this.ended.n)this.ended.ts=date.monotonic();this.ended.n=(this.ended.n||0)+1;if(this.ended.n!=7)return;this.push("missing_ended",{ended:this.ended.ts});player.emit("missing_ended");this.log.err("video ended but missing ended event");zperr({id:"missing_ended_event_error",add_log:true,extra:this.get_stats_all()})});this.ended_poll.reset_ts=function(){this.ended.n=0}.bind(this);this.pos_wait_poll=this.try_wrapper(function(){this.pos_wait_poll.check()});this.pos_wait_poll.check=function(){var pos_wait_ctx=this.pos_wait_poll;if(zutil.is_mocha())return;this.check_waiting("pos_wait");if(this.video_start===undefined||!player.is_playing()||player.vjs&&player.vjs.paused()){return this.pos_wait_poll.reset_ts()}var limit=2*date.ms.SEC;var pos_prev=pos_wait_ctx.pos,pos_curr=player.get_pos();var ts_prev=pos_wait_ctx.ts,ts_curr=date.monotonic();if(ts_prev){var bws=this.cdn.attached_bws;var b=player.get_current_buffer();if(b.to-pos_curr>this.buf_wait_min&&Math.abs(pos_prev-pos_curr)<.25){pos_wait_ctx.detected=true;if(ts_curr-ts_prev>limit){if(!pos_wait_ctx.handled){pos_wait_ctx.handled=true;pos_wait_ctx.over_wait_ts=date.monotonic();stats.pos_wait_n=(stats.pos_wait_n||0)+1;this.push("pos_wait_begin");if(stats.pos_wait_n==1){this.log.info("pos_freeze over "+limit+" ms");zperr({id:"video_pos_freeze",add_log:true,extra:this.get_stats_all(),filehead:bws?"last test:\n"+bws.unittest.gen_test():undefined})}else if(stats.pos_wait_n==2){this.log.info("pos_freeze #"+stats.pos_wait_n+" over "+limit+" ms");zperr({id:"video_pos_freeze_2",add_log:true,extra:this.get_stats_all(),filehead:bws?"last test:\n"+bws.unittest.gen_test():undefined})}}else if(is_over_10sec(pos_wait_ctx.over_wait_ts)){this.push("pos_wait_over_10sec",{unique_view_sec:stats.unique_view_sec.sum});pos_wait_ctx.over_wait_ts=undefined}}}else{if(pos_wait_ctx.handled)this.push("pos_wait_end");pos_wait_ctx.handled=pos_wait_ctx.detected=false;pos_wait_ctx.over_wait_ts=undefined}}if(pos_wait_ctx.detected)return;pos_wait_ctx.pos=pos_curr;pos_wait_ctx.ts=ts_curr}.bind(this);this.pos_wait_poll.reset_ts=function(){var pos_wait_ctx=this.pos_wait_poll;if(!pos_wait_ctx.ts)return;if(pos_wait_ctx.handled)this.push("pos_wait_end");pos_wait_ctx.ts=pos_wait_ctx.over_wait_ts=pos_wait_ctx.pos=undefined;pos_wait_ctx.handled=pos_wait_ctx.detected=false}.bind(this);this.clock_skew_poll=this.try_wrapper(function(){var ctx=this.clock_skew_poll;var last_ts=ctx.ts,ts=ctx.ts=date.monotonic();if(ts-last_ts<ctx.ival*ctx.skew_factor)return;if(!ctx.count){var info={diff:ts-last_ts-ctx.ival,document_visibility:document.visibilityState};this.log.notice("clock skew detected: time moved by %d ms",info.diff);this.push("clock_skew",info)}ctx.count++});this.clock_skew_poll.count=0;this.clock_skew_poll.ts=date.monotonic();this.clock_skew_poll.ival=this.zone.CG("stats.skew_interval",1e3);this.clock_skew_poll.skew_factor=this.zone.CG("stats.skew_factor",60);this.set_adaptive(!!this.opt.adaptive);if(this.zone.CG("analysis.js",[]).length){this.analysis_int=setInterval(this.try_wrapper(this.analysis_cb),1e3)}this.stats_init();this.start_time_tracker.init();this.start_listening({init:true});if(this.use_ad_suspend){if(player.is_ad_active())this.stop_listening()}};E.PlayerStats.prototype.analysis_checkpoint=function(){if(this.analysis_int)this.try_wrapper(this.analysis_cb)()};E.PlayerStats.prototype.analysis_cb=function(){if(this.cdn.attached_bws)return void(this.analysis_int=clearInterval(this.analysis_int));var run=function(path,sid){var ex;try{if(!this.zone.conf_apply(path,[],undefined,this,true))return false}catch(e){ex=e.message}util.log_report({exception:ex,id:"analysis",cdn:this.cdn,add_unittest:false,add_log:!ex,analysis_tag:Object.assign({},this.zone.CG("analysis.tag"),{sid:sid})});if(this.log)this.log.notice("sending log report %s",sid);return true}.bind(this);var snippets=this.zone.CG("analysis.js",[]);snippets.forEach(function(s,i){if(!s.enable_stats||s.mode!="multi"&&s.count>0)return;if(run("analysis.js."+i+".js",s.id))s.count=s.count+1||1});if(snippets.every(function(s){return s.mode!="multi"&&s.count>0})||this.cdn.attached_bws){this.analysis_int=clearInterval(this.analysis_int)}};E.PlayerStats.prototype.start_listening=function(opt){opt=opt||{};var zperr=this.zone.perr_get();var player=this.player;this.interval_200ms=clearInterval(this.interval_200ms);this.interval_500ms=clearInterval(this.interval_500ms);this.interval_ping=clearInterval(this.interval_ping);this.interval_200ms=setInterval(function(){this.download_poll();this.view_poll();this.buf_wait_poll();this.start_time_tracker.poll()}.bind(this),200);this.interval_500ms=setInterval(function(){this.fps_poll();this.ended_poll();this.pos_wait_poll()}.bind(this),500);var ping_sec=this.zone.CG("stats.ping_sec");if(ping_sec){this.interval_ping=setInterval(function(){zperr({id:"stats_ping",info:{only_stats:this.opt.only_stats,ping_sec:ping_sec,timeline_str:this.timeline.to_str(true)}})}.bind(this),(+ping_sec||60)*1e3)}if(opt.init){this.test_playback_status({init:true});this.interval_clock_skew=setInterval(this.clock_skew_poll,this.clock_skew_poll.ival);this.wrapper.on("context_created",this.stats_new_context_cb);this.cdn.on("pre-suspend",this.stats_pre_suspend_cb)}if(opt.init||opt.restore)this.set_suspend_mode(false);this.set_ad_mode(false)};E.PlayerStats.prototype.set_suspend_mode=function(on){var player=this.player;if(this.suspend_mode!==undefined&&!!on==!!this.suspend_mode)return;this.suspend_mode=!!on;if(on){player.off("ad_play",this.stats_ad_play);player.off("ad_timeout",this.stats_ad_timeout);player.off("ad_skipped",this.stats_ad_skipped);player.off("ad_complete",this.stats_ad_complete);player.off("ad_error",this.stats_ad_error);player.off("ad_time",this.stats_ad_time);player.off("ad_request",this.stats_ad_request);player.off("ad_block",this.stats_ad_block);player.off("src_change",this.stats_src_change);if(this.use_ad_suspend){player.off("ad_suspend",this.stats_ad_suspend);player.off("ad_restore",this.stats_ad_restore)}}else{player.on("ad_play",this.stats_ad_play);player.on("ad_timeout",this.stats_ad_timeout);player.on("ad_skipped",this.stats_ad_skipped);player.on("ad_complete",this.stats_ad_complete);player.on("ad_error",this.stats_ad_error);player.on("ad_time",this.stats_ad_time);player.on("ad_request",this.stats_ad_request);player.on("ad_block",this.stats_ad_block);player.on("src_change",this.stats_src_change);if(this.use_ad_suspend){player.on("ad_suspend",this.stats_ad_suspend);player.on("ad_restore",this.stats_ad_restore)}}};E.PlayerStats.prototype.set_ad_mode=function(on){var player=this.player;if(this.ad_mode!==undefined&&!!on==!!this.ad_mode)return;this.ad_mode=!!on;if(on){player.off("timeupdate",this.stats_time_cb);player.off("seeking",this.stats_seeking_cb);player.off("seeked",this.stats_seeked_cb);player.off("pre-state",this.states_pre_state_cb);player.off("pre-ended",this.stats_pre_ended2_cb);player.off("pre-error",this.stats_pre_error_cb);player.off("pre-fallback",this.stats_pre_fallback_cb);player.off("request_fragment",this.stats_request_fragment);player.off("request_fragment_done",this.stats_request_fragment_done);player.off("fragmentloaded",this.stats_fragment_loaded);player.off("waiting",this.stats_waiting);player.off("manifest_parsed",this.stats_manifest_parsed);player.off("seg_stats",this.stats_seg_stats);player.off("buf_stats",this.stats_buf_stats);player.off("frag_load_stats",this.stats_frag_load_stats);player.off("media_type",this.media_type_cb)}else{player.on("timeupdate",this.stats_time_cb);player.on("seeking",this.stats_seeking_cb);player.on("seeked",this.stats_seeked_cb);player.on("pre-state",this.states_pre_state_cb);player.on("pre-ended",this.stats_pre_ended2_cb);player.on("pre-error",this.stats_pre_error_cb);player.on("pre-fallback",this.stats_pre_fallback_cb);player.on("request_fragment",this.stats_request_fragment);player.on("request_fragment_done",this.stats_request_fragment_done);player.on("fragmentloaded",this.stats_fragment_loaded);player.on("waiting",this.stats_waiting);player.on("manifest_parsed",this.stats_manifest_parsed);player.on("seg_stats",this.stats_seg_stats);player.on("buf_stats",this.stats_buf_stats);player.on("frag_load_stats",this.stats_frag_load_stats);player.on("media_type",this.media_type_cb)}};E.PlayerStats.prototype.stop_listening=function(opt){opt=opt||{};var player=this.player;this.fps_poll.reset_ts();this.ended_poll.reset_ts();this.pos_wait_poll.reset_ts();this.interval_200ms=clearInterval(this.interval_200ms);this.interval_500ms=clearInterval(this.interval_500ms);this.interval_ping=clearInterval(this.interval_ping);if(opt.shutdown){this.test_playback_status({shutdown:true});this.interval_clock_skew=clearInterval(this.interval_clock_skew);this.wrapper.off("context_created",this.stats_new_context_cb);this.cdn.off("pre-suspend",this.stats_pre_suspend_cb)}if(opt.shutdown||opt.suspend)this.set_suspend_mode(true);this.set_ad_mode(true)};E.PlayerStats.prototype.suspend=function(suspend,opt){if(!this.inited)return;opt=opt||{};var is_ad=opt.source=="ad";this.video_start=undefined;this.play_pos=this.seek_pos=this.sys_seek=undefined;if(suspend){this.push(is_ad?"ad_suspend":"suspend",assign({},opt.data,{last_pos:this.last_valid_pos}));this.check_waiting.reset("suspend");this.stop_listening({suspend:!is_ad})}else{this.push(is_ad?"ad_restore":"restore",opt.data);if(!this.player.is_paused()&&this.playing_t0===undefined)this.playing_t0=date.monotonic();else if(this.player.is_paused()&&this.playing_t0!==undefined)this.playing_t0=undefined;this.start_listening({restore:!is_ad})}};E.PlayerStats.prototype.set_adaptive=function(adaptive){this.adaptive=adaptive};E.PlayerStats.prototype.reset=function(){if(this.cdn.attached_bws)this.cdn.attached_bws.reset_stats();this.uninit();this.init(assign(this.opt,{reset:true}));this.push("reset_stats")};E.PlayerStats.prototype.uninit=util.try_wrapper(function(){if(!this.inited)return;this.inited=false;var player=this.player;this.log.debug("player stats uninit");if(this.adblock_xhr_uninit)this.adblock_xhr_uninit=this.adblock_xhr_uninit();if(this.adblock_css_uninit)this.adblock_css_uninit=this.adblock_css_uninit();util.off("pre-beforeunload",this.stats_pre_beforeunload2_cb);util.off("pre-visible_state",this.stats_visible_state_cb);util.off("pre-hidden_state",this.stats_hidden_state_cb);util.off("post-hidden_state",this.stats_post_hidden_state_cb);player.off("visibility_end",this.stats_visibility_end_cb);player.off("visibility_start",this.stats_visibility_start_cb);player.off("media_type",this.media_type_cb);this.stop_listening({shutdown:true});this.start_time_tracker.uninit();this.analysis_checkpoint();clearInterval(this.analysis_int)});E.PlayerStats.prototype.push=function(e,o){o=o||{};var info,player=this.player;if(zutil.is_mocha())info=zutil.clone(o);else{var slave,b=player.get_current_buffer(),pos=player.get_pos();var bws=this.cdn.attached_bws;var duration=player.get_duration();var dropped=player.get_dropped_frames();var frames=player.get_decoded_frames();info=assign({pos:pos,duration:duration,buf_from:b.from,buf_to:b.to,state:player.get_state(),paused:player.is_paused(),fps:this.fps,fps_play_sec:this.stats.fps_play_sec,frames:frames,bitrate:player.get_bitrate(),live:player.is_live_stream(),ad_active:player.is_ad_active()},player.get_resolution(),o);if(info.ad_active)info.ad_state=player.get_ad_state();if(frames)info.frames=frames;if(dropped)info.dropped=dropped;if(this.adaptive&&bws&&bws.method&&bws.method.curr_segment_index!==undefined){info.segment=bws.method.curr_segment_index}if(!this.play_start)info.ready_state=player.html5?player.html5.readyState:null;if(slave=player.slave||player.html5_inst){info.slave_pos=slave.get_pos();info.slave_state=slave.get_state()}}var url=player.get_url();if(this.prev_url!=url){var _info=assign({},info);_info.url=url;this.log.info("url_change %s->%s pos %s",this.prev_url,url,_info.pos);this.timeline.push("url_change",_info);this.emit("url_change",_info);this.prev_url=url}this.log.info("%s pos %s buf %s-%s state %s ad_active %s bitrate %s",e,info.pos,info.buf_from,info.buf_to,info.state,info.ad_active,info.bitrate);this.timeline.push(e,info);this.emit(e,o)};E.PlayerStats.prototype.stats_init=function(){load_perf.push("stats_init_start",this.zone);var player=this.player;var last_time;var _this=this;function push_info(e,o){if(zutil.is_mocha())return;_this.push("info_"+e,o)}function update_time(type,e){e=e||{};if(zutil.is_mocha())return;if(last_time==type)return;load_perf.push("stats_"+type+"_time_triggered",_this.zone);last_time=type;_this.push(type+"_time",{eduration:e.duration,eposition:e.position})}function is_waiting(){if(player.is_idle()||_this.playing_t0===undefined)return false;var b=player.get_current_buffer();var pos=player.get_pos(),diff=b.to-pos;var duration=player.get_duration();if(duration&&duration-pos<2)return false;return diff<_this.buf_wait_min}this.play_start=this.video_start=this.waiting=this.seek_pos=this.play_pos=this.pos_prev=undefined;this.buf_wait_min=player.jwplayer||player.html5&&util.is_firefox?1:.25;this.check_waiting=function(src){if(_this.video_start===undefined)return;if(player.is_ad_active())return;if(_this.zone.CG("stats.ignore_player_buffer"))return;if(!_this.waiting&&is_waiting()){_this.push("buf_wait_begin",{check_waiting:src});_this.waiting=true;_this.check_waiting.over_wait_ts=date.monotonic()}else if(_this.waiting&&!is_waiting()){_this.push("buf_wait_end",{check_waiting:src});_this.waiting=false;_this.check_waiting.over_wait_ts=undefined}else if(is_over_10sec(_this.check_waiting.over_wait_ts)){_this.push("buf_wait_over_10sec",{unique_view_sec:this.stats.unique_view_sec.sum});_this.check_waiting.over_wait_ts=undefined}};this.check_waiting.reset=function(src){if(!_this.waiting)return;_this.push("buf_wait_end",{check_waiting:src});_this.waiting=false;_this.check_waiting.over_wait_ts=undefined};this.stats_new_context_cb=this.try_wrapper(function(cdn){var suspends=this.stats.suspends;var last_suspend=suspends&&suspends[suspends.length-1];if(this.suspend_mode&&!last_suspend.suspended_by.id){last_suspend.suspended_by.id=cdn.id;last_suspend.suspended_by.url=player.get_url()}});this.stats_pre_suspend_cb=this.try_wrapper(function(){if(!this.stats.suspends)this.stats.suspends=[];this.stats.suspends.push({suspended_by:{},pos:this.wrapper.player.get_pos(),duration:this.wrapper.player.get_duration(),url:this.wrapper.player.get_url()})});this.stats_time_cb=this.try_wrapper(function(pos){update_time("video",{position:pos,duration:this.player.get_duration()});if(player.is_idle())return;this.check_waiting("time");if(_this.waiting)return;var pos_prev=this.pos_prev,pos_diff=pos-pos_prev;this.pos_prev=pos;this.last_valid_pos=pos||this.last_valid_pos;if(this.video_start===undefined){if(!pos_prev||!isFinite(pos_prev)||!isFinite(pos)||pos_diff<=0||pos_diff>1){return}if(pos_diff<.25)return void(this.pos_prev=pos_prev);this.video_start=pos;if(this.play_start){this.push("restore_start",zutil.is_mocha()?undefined:{pos_prev:pos_prev});return void this.log.debug("restore_start_ms "+this.timeline.elapsed_from("restore"))}this.play_start=true;load_perf.push("stats_play_start_triggered",this.zone,true);this.push("play_start",zutil.is_mocha()?undefined:{pos_prev:pos_prev});return void this.log.debug("play_start_ms "+this.timeline.elapsed_from("stats_init"))}if(this.seek_pos!==undefined){if(!player.is_paused()&&this.seek_pos<pos){this.push("seek_start",{seek_pos:this.seek_pos,system:this.sys_seek});this.log.debug("seek_ms "+this.timeline.elapsed_from("seek"));this.seek_pos=this.sys_seek=undefined}return}if(pos_diff<-1)this.push("timeshift",{pos_prev:pos_prev,timeshift:pos_diff});if(this.play_pos<pos){this.play_pos=undefined;this.push("resume");this.log.debug("resume_ms "+this.timeline.elapsed_from("play"))}});this.stats_seeking_cb=this.try_wrapper(function(pos,off,sys_seek){push_info("seek",{system:!!sys_seek});if(player.is_idle())return;this.check_waiting("seeking");if(this.video_start===undefined)return;this.play_pos=this.seek_pos=undefined;this.sys_seek=!!sys_seek;this.push("seek",{system:this.sys_seek})});this.stats_seeked_cb=this.try_wrapper(function(){push_info("seeked",{system:this.sys_seek});if(player.is_idle())return;this.check_waiting("seeked");if(this.video_start===undefined)return;this.ended_poll.reset_ts();this.seek_pos=player.get_pos();this.push("seeked",{seek_pos:this.seek_pos,system:this.sys_seek})});this.states_pre_state_cb=this.try_wrapper(function(state){this.pos_wait_poll.check();this.fps_poll.check();var estate=typeof state=="string"?state:zerr.json(state);if(player.is_idle()){push_info("state",{cur_state:estate});return}if(this.playing_t0!==undefined&&!player.is_playing()&&!this.seek_pos){this.stats.play_sec=(this.stats.play_sec||0)+(date.monotonic()-this.playing_t0)/date.ms.SEC;this.playing_t0=undefined;this.check_waiting("state");push_info("state",{cur_state:estate});this.push("pause");this.play_pos=undefined}else if(this.playing_t0===undefined&&player.is_playing()){this.playing_t0=date.monotonic();push_info("state",{cur_state:estate});this.push("play");this.check_waiting("state");if(this.video_start===undefined)return;this.seek_pos=undefined;this.play_pos=player.get_pos()}else{this.check_waiting("state");push_info("state",{cur_state:estate})}});this.stats_pre_ended2_cb=this.try_wrapper(function(){this.stats_calc_fragment_load_avg();this.push("ended")});this.stats_pre_error_cb=this.try_wrapper(function(){this.push("player_error")});this.stats_pre_fallback_cb=this.try_wrapper(function(){this.push("fallback")});this.stats_request_fragment=this.try_wrapper(function(o){var ctx=this.stats_request_fragment;if(ctx.fragments)return;ctx.fragments=(ctx.fragments||0)+1;if(ctx.fragments==1)this.push("first_fragment",{req_id:o.req_id,frag_url:o.url})});this.stats_fragment_data={};this.stats_fragment_record=function(stats_name,o){var ctx=this.stats_fragment_data;function fragment_load_report_next(opt){var name,from_seek,from_seek_start,from_report,prop_reported=stats_name+"_reported";ctx[prop_reported]=ctx[prop_reported]||0;if(!(from_seek=this.timeline.elapsed_from("seek"))){name=stats_name+"_start_ts";if(this.timeline.find("play_start"))return}else{name=stats_name+"_seek_ts";from_seek_start=this.timeline.elapsed_from("seek_start");if(from_seek_start&&from_seek_start<from_seek)return;from_report=this.timeline.elapsed_from(name+"1");if(!from_report||from_seek<from_report)ctx[prop_reported]=0}if(ctx[prop_reported]>=opt.max_report_count)return;ctx[prop_reported]++;return name+ctx[prop_reported]}var id;if(id=fragment_load_report_next.call(this,{max_report_count:3}))this.push(id,{loadtime:o.loadtime});ctx[stats_name+"_sum"]=(ctx[stats_name+"_sum"]||0)+o.loadtime;ctx[stats_name+"_count"]=(ctx[stats_name+"_count"]||0)+1};this.stats_fragment_record_avg=function(stats_name){var ctx=this.stats_fragment_data;if(!ctx[stats_name+"_count"])return;var avg=ctx[stats_name+"_sum"]/ctx[stats_name+"_count"];this.push(stats_name,{loadtime:Math.round(avg)})};this.stats_request_fragment_done=this.try_wrapper(function(o){this.stats_fragment_record("fragment_js",{loadtime:o.jstime})});this.stats_fragment_loaded=this.try_wrapper(function(o){this.stats_fragment_record("fragment_loadtime",{loadtime:o.loadtime})});this.stats_calc_fragment_load_avg=this.try_wrapper(function(){this.stats_fragment_record_avg("fragment_js");this.stats_fragment_record_avg("fragment_loadtime")});this.stats_waiting=this.try_wrapper(function(o){push_info("waiting_event")});this.stats_manifest_parsed=this.try_wrapper(function(){this.push("manifest_parsed")});this.stats_pre_beforeunload2_cb=this.try_wrapper(function(){this.stats_calc_fragment_load_avg();this.push("beforeunload")});this.stats_visible_state_cb=this.try_wrapper(function(){this.push("document_visible")});this.stats_hidden_state_cb=this.try_wrapper(function(){this.push("document_hidden")});this.stats_post_hidden_state_cb=this.try_wrapper(function(){if(this.timeline.find("visibility_end"))this.uninit()});this.stats_visibility_end_cb=this.try_wrapper(function(){this.stats_calc_fragment_load_avg();this.push("visibility_end")});this.stats_visibility_start_cb=this.try_wrapper(function(){this.perm_data.visibility_switch_n=(this.perm_data.visibility_switch_n||0)+1;this.push("visibility_start",{switch_n:this.perm_data.visibility_switch_n})});this.media_type_cb=this.try_wrapper(function(e){this.push("media_type",{media_type:e})});this.buf_wait_poll=this.try_wrapper(function(){if(player.is_idle())return;this.check_waiting("poll")});var ad_events=["ad_play","ad_pause","ad_impression","ad_config","ad_start","ad_download","ad_timeout"];ad_events.forEach(function(evt){_this["stats_"+evt]=_this.try_wrapper(function(){return function(){this.push(evt)}}())});this.stats_ad_complete=this.try_wrapper(function(){load_perf.push("stats_ad_finish",this.zone,true);this.push("ad_complete")});this.stats_ad_skipped=this.try_wrapper(function(){load_perf.push("stats_ad_finish",this.zone,true);this.push("ad_skipped")});this.stats_ad_error=this.try_wrapper(function(e){load_perf.push("stats_ad_error",this.zone,true);this.push("ad_error",{ad_error:""+e});if(this.adblock)this.push("ad_error_with_adblock",{ad_error:""+e})});this.stats_ad_time=this.try_wrapper(function(e){update_time("ad",e)});this.stats_ad_play=this.try_wrapper(function(e){e=e||{};this.push("ad_play",{ad_type:e.ad_type})});this.stats_ad_request=this.try_wrapper(function(e){e=e||{};this.push("ad_request",{ad_type:e.ad_type})});this.stats_ad_block=this.try_wrapper(function(e){e=e||{};this.push("ad_block",{ad_type:e.ad_type})});this.stats_src_change=this.try_wrapper(function(e){this.push("src_change",e)});this.stats_seg_stats=this.try_wrapper(function(e){var stats=this.stats;if(!e.keyFrames){this.log.warn("segment without keyframe %o",e,{});stats.dm_no_keyframe_n=(stats.dm_no_keyframe_n||0)+1}if(e.dropped){this.log.warn("dropped frames %s %o",e.dropped,e,{});stats.dm_dropped_n=(stats.dm_dropped_n||0)+1;if(e.dropped/e.framesCount>.8){this.log.warn("segment %s is dropped",e.segment,{});
stats.dm_dropped_seg_n=(stats.dm_dropped_seg_n||0)+1}}if(e.AVUnsync){this.log.info("audio/video unsync %ssec %o",e.AVUnsync,e,{});stats.dm_avunsync_n=(stats.dm_avunsync_n||0)+1;stats.dm_avunsync_sec=(stats.dm_avunsync_sec||0)+e.AVUnsync}if(e.audioGap){this.log.info("gap in audio s:%s d:%sms->%sms",e.audioGap.cnt,e.audioGap.min,e.audioGap.max);stats.dm_audio_gap_n=(stats.dm_audio_gap_n||0)+1}if(e.videoGap){this.log.info("gap in video d:%sms",e.videoGap[0]);stats.dm_video_gap_n=(stats.dm_video_gap_n||0)+1}if(e.notFirstKeyframe){this.log.info("segment not starting with keyframe",e,{});stats.dm_not_1st_keyframe_n=(stats.dm_not_1st_keyframe_n||0)+1}});this.stats_buf_stats=this.try_wrapper(function(e){var val,stats=this.stats;function st_stats(name){stats[name+"_n"]=(stats[name+"_n"]||0)+1;if(val.ts!==undefined&&stats[name+"_st_sec"]===undefined)stats[name+"_st_sec"]=val.ts}if(val=e.bufNotStalled){stats.dm_buf_not_stalled_n=(stats.dm_buf_not_stalled_n||0)+1;if(val.lowBuf!==undefined&&!val.lowBuf)stats.dm_hbuf_restore_n=(stats.dm_hbuf_restore_n||0)+1;if(val.dur!==undefined){stats.dm_buf_stall_dur_ms=(stats.dm_buf_stall_dur_ms||0)+val.dur}}if(val=e.bufStalledLow)st_stats("dm_buf_stalled_low",val);if(val=e.bufSeekOverHole)st_stats("dm_buf_seek_over_hole",val);if(val=e.bufStalledHigh)st_stats("dm_buf_stalled_high",val);if(val=e.bufNudge)st_stats("dm_buf_nudge",val)});this.stats_frag_load_stats=this.try_wrapper(function(e){var val=e.stats||{},stats=this.stats;function st_stats(name,val){stats[name+"_max"]=Math.max(stats[name+"_max"]||0,val);st_stats[name+"_sum"]=(st_stats[name+"_sum"]||0)+val;st_stats[name+"_cnt"]=(st_stats[name+"_cnt"]||0)+1;stats[name+"_avg"]=st_stats[name+"_sum"]/st_stats[name+"_cnt"]}if(!val.tfirst)return;st_stats("dm_frag_load",val.tload-val.tfirst);st_stats("dm_frag_parse",val.tparsed-val.tload);st_stats("dm_frag_buffered",val.tbuffered-val.tparsed)});this.stats_ad_suspend=this.try_wrapper(function(e){this.suspend(true,{source:"ad"})});this.stats_ad_restore=this.try_wrapper(function(e){this.suspend(false,{source:"ad",data:{ad_empty:e&&e.ad_empty}})});if(!zutil.is_mocha()){this.adblock_xhr_uninit=this.test_adblock_by_xhr();this.adblock_css_uninit=this.test_adblock_by_css()}util.on("pre-beforeunload",this.stats_pre_beforeunload2_cb);util.on("pre-visible_state",this.stats_visible_state_cb);util.on("pre-hidden_state",this.stats_hidden_state_cb);util.on("post-hidden_state",this.stats_post_hidden_state_cb);player.on("visibility_end",this.stats_visibility_end_cb);player.on("visibility_start",this.stats_visibility_start_cb);player.on("media_type",this.media_type_cb);this.playing_t0=player.is_paused()?undefined:date.monotonic();var attached_opt={ad_active:player.is_ad_active(),autostart:!is_android&&!is_ios&&player.is_autostart()};if(!zutil.is_mocha())attached_opt.document_visibility=document.visibilityState;var video_type=player.get_video_type_name();if(is_android&&this.opt.only_stats&&video_type=="hls")attached_opt.native_hls=true;if(player.name=="vjs"&&video_type=="hds")attached_opt.vjs_hds=true;if(this.zone.CG("stats.disable_missing_bitrate"))attached_opt.disable_missing_bitrate=true;if(util.is_android&&video_type=="hls"){attached_opt.disable_fps=true;if(player.is_native_hls())this.fps_unsupported=true}if(this.zone.CG("stats.disable_fps")||!player.html5&&player.tech!="html5"&&!zutil.is_mocha()){attached_opt.disable_fps=this.disable_fps_emit=true}if(this.use_ad_suspend)attached_opt.use_ad_suspend=true;attached_opt.ad_scheme=player.get_ad_scheme();attached_opt.media_type=player.get_media_type();if(!this.opt.reset&&this.wrapper.video_check_n==1)attached_opt.buf_sec=player.get_buffered_sec();this.push("attached",attached_opt);load_perf.push("stats_init_end",this.zone)};E.PlayerStats.prototype.get_stats=util.try_wrapper(function(minimal,skip_stat){var bws=this.cdn.attached_bws;var ret=zutil.clone(this.stats);ret.play_sec=(ret.play_sec||0)+(this.playing_t0!==undefined?(date.monotonic()-this.playing_t0)/date.ms.SEC:0);if(!minimal)ret.timeline=this.timeline.arr;ret.timeline_str=this.timeline.to_str(true);if(!skip_stat){ret.stat=this.timeline.get_stats({all:true});ret.no_fps_play_per=100*ret.stat.no_fps_ms/1e3/ret.fps_play_sec;ret.low_fps_play_per=100*ret.stat.low_fps_ms/1e3/ret.fps_play_sec;ret.high_fps_play_per=100*ret.stat.high_fps_ms/1e3/ret.fps_play_sec;ret.clock_skew_count=this.clock_skew_poll.count;ret.clock_skew_last_poll=date.monotonic()-this.clock_skew_poll.ts}ret.player_n=this.wrapper&&this.wrapper.player_n;ret.video_check_n=this.wrapper&&this.wrapper.video_check_n;var b,t=0,n=0;for(b in ret.bitrate_sec){if(ret.bitrate_sec[b].sum<0)ret.invalid_sec_sum_n=(ret.invalid_sec_sum_n||0)+1;else if(+b>0){t+=+b*ret.bitrate_sec[b].sum;n+=ret.bitrate_sec[b].sum}else ret.invalid_bitrate_n=(ret.invalid_bitrate_n||0)+1}ret.bitrate_avg=n?t/n:0;for(var name in ret.pos_val){ret["bitrate_"+name+"_sec"]=ret.pos_val[name].sec;ret["bitrate_"+name+"_avg"]=ret.pos_val[name].sum/ret.pos_val[name].sec||0}delete ret.bitrate_sec;delete ret.pos_val;delete ret.time;if(bws&&bws.method&&bws.method.first_index)ret.first_index=bws.method.first_index();ret.est_downloaded_bytes=this.player.get_est_bytes();if(this.player.tech=="native")ret.app_name=this.player.app_name||"native_sdk";return ret});E.PlayerStats.prototype.try_wrapper=function(func){return util.try_wrapper({prefix:"stats"},func.bind(this))};E.PlayerStats.prototype.get_stats_all=util.try_wrapper(function(minimal){var bws=this.cdn.attached_bws;var player=this.get_stats(true,minimal);var timing=E.get_stats_timing();var start_time=this.start_time_tracker.get_stats();var ret={player:player,timing:timing};if(start_time)ret.start_time=start_time;if(bws)ret=assign(ret,bws.get_stats());return ret});E.PlayerStats.prototype.test_adblock_by_xhr=util.try_wrapper(function(){var _this=this;this.adblock=false;var test=etask([function(){return ajax.raw({url:util.fix_url("//"+require.zdot("host")+"/ads.js."),timeout:0})},function(){_this.push("no_adblock")},function catch$(e){_this.adblock=true;_this.push("adblock",{status:e.status,status_text:e.status_text,response_text:e.response_text})}]);return function(){test.return()}});E.PlayerStats.prototype.test_adblock_by_css=util.try_wrapper(function(){var _this=this;this.adblock_by_css=false;this.push("adblock_css_begin");var bait=document.createElement("div");bait.setAttribute("class","ub_300x250 pub_300x250m pub_728x90 text-ad "+"textAd text_ad text_ads text-ads text-ad-links");bait.setAttribute("style","width: 1px !important; "+"height: 1px !important; position: absolute !important; "+"left: -10000px !important; top: -1000px !important;");window.document.body.appendChild(bait);var count=0;var timer=setTimeout(function cb(){timer=undefined;if(bait.offsetParent===null||bait.offsetHeight==0||bait.offsetLeft==0||bait.offsetTop==0||bait.offsetWidth==0||bait.clientHeight==0||bait.clientWidth==0){_this.push("adblock_css_found");return}if(count>20)return _this.push("adblock_css_not_found");count++;timer=setTimeout(cb,50)},50);return function(){if(timer)timer=clearTimeout(timer)}});E.PlayerStats.prototype.test_playback_status=function(opt){var ctx=this.test_playback_ctx=this.test_playback_ctx||{};if(opt.init){ctx.playback_test_cb=this.try_wrapper(function(e){switch(e.state){case"checking":this.push("playback_enabled_check");this.playback_check_in_progress=true;ctx.decision_based_on=undefined;break;case"enabled":this.push("playback_enabled",{reason:e.based_on});this.playback_check_in_progress=false;ctx.decision_based_on=e.based_on;break}});ctx.playback_hidden_cb=this.try_wrapper(function(){var allow_restart=!this.timeline.find("visibility_end");if(allow_restart&&!this.play_start&&ctx.decision_based_on=="visibility"){this.test_playback_status({restart:true})}});util.on("post-hidden_state",ctx.playback_hidden_cb)}if(opt.restart||opt.shutdown){ctx.decision_based_on=undefined;if(ctx.playback_test_uninit)ctx.playback_test_uninit=ctx.playback_test_uninit();if(opt.shutdown){util.off("post-hidden_state",ctx.playback_hidden_cb);return ctx=this.test_playback_ctx=undefined}}ctx.playback_test_uninit=this.player.check_playback_status(ctx.playback_test_cb)};function format_traffic_stats(ret,bws){var total=0,aborted=0;var s="Traffic distribution statistics";s+="\n"+String.fromCharCode(8212).repeat(31);s+="\nstats                cdn            total    %"+"                           name            Bps\n";function out(cdn,dn,perc,name,bps){s+=sprintf("     %+19s %+16s %+4s %+30s %+14s\n",cdn,conv.scaled_number(+dn,{space:true,base:1024}),perc,name&&name!=cdn?name:"",bps?(isNaN(bps)?bps:conv.scaled_number(+bps,{space:true,base:1024}))+"/sec":"")}ret.cdns.forEach(function(cdn){total+=cdn.bytes+cdn.aborted_bytes;aborted+=cdn.aborted_bytes});total+=bws.stats.cached;ret.cdns.forEach(function(cdn){var _s=zurl.is_ip(cdn.host)?cdn.host:cdn.host.split(".")[0];out(_s,cdn.bytes,(total?Math.round(cdn.bytes*100/total):0)+"%",cdn.name,cdn.bps)});if(bws.stats.cached){var sum=bws.stats.cached;out("cache",sum,Math.round(sum*100/total)+"%")}if(aborted)out("aborted",Math.round(aborted),Math.round(aborted*100/total)+"%");return s}function format_play_start(stats){var s="Start time -";var manual=(stats._paused_play_start_ms||0)+(stats._paused_play_seek_start_ms||0);var autostart=(stats._play_start_ms||0)+(stats._play_seek_start_ms||0);s+=" Autostart: "+(autostart?Math.round(autostart)+" ms":"n/a")+";";s+=" Manual play: "+(manual?Math.round(manual)+" ms":"n/a");return s}function format_seek(stats){var count=(stats._seek_n||0)+(stats._paused_seek_n||0);var seek_time=(stats._seek_ms||0)+(stats._paused_seek_ms||0);var average=count?Math.round(seek_time/count):0;return"Seek - Number of seeks: "+count+";"+" Average seek time: "+average+" ms"}function format_buffering(stats){return"Buffering - Number of buffering events: "+(stats._wait_n||0)+";"+" Total buffering time: "+Math.round(stats._wait_ms||0)+" ms"}function format_engagement(player){return"Engagement - Video duration: "+Math.round(player.duration_sec||0)+" sec; Viewed so far: "+Math.round(player.view_sec||0)+" sec"}function format_bitrate(stats){return"Bitrate - Current: "+Math.round(stats.bitrate_last/1e3||0)+" kbps; Min: "+Math.round(stats.bitrate_min/1e3||0)+" kbps;"+" Max: "+Math.round(stats.bitrate_max/1e3||0)+" kbps;"+" Number of bitrate changes: "+(stats.bitrate_n||0)}function format_video_quality_stats(ret){var s="Video Quality of Experience statistics";var stat=ret.player?ret.player.stat||{}:{};s+="\n"+String.fromCharCode(8212).repeat(38);s+="\n"+format_play_start(stat);s+="\n"+format_seek(stat);s+="\n"+format_buffering(stat);s+="\n"+format_engagement(ret.player||{});s+="\n"+format_bitrate(stat);return s}function format_misc_stats(ret,bws,player){var bsec;if(!(bsec=bws&&bws.buf_sec())){var b=player.get_current_buffer(),pos=player.get_pos()||0;var diff=Math.ceil(b.to)-Math.round(pos);bsec={player:diff,buffered:diff,obtained:0}}var s="Current forward buffer: player "+bsec.player+" buffered "+bsec.buffered+" sec, js "+bsec.obtained+" sec\n";var stream=bws&&bws.get_stream_by_id("video");if(stream)s+="Bitrate "+Math.round(stream.bitrate)+" bps\n";else s+="Stream not found\n";if(ret.timing){s+="Script load time "+Math.round(ret.timing.duration)+"ms\n";if(ret.timing.page_load)s+="Page load time "+ret.timing.page_load+"ms\n"}return s}E.PlayerStats.prototype.print_stats=function(omit){var ret=this.get_stats_all();var bws=this.cdn.attached_bws;var s="";if(!zutil.is_mocha()){if(ret.cdns)s+="\n\n"+format_traffic_stats(ret,bws);s+="\n\n"+format_video_quality_stats(ret);s+="\n\n"+format_misc_stats(ret,bws,this.player)}this.log.console(s);if(ret&&ret.player&&ret.player.stat){if(ret.player.stat.error)this.log.err("error with stats: "+ret.player.stat.error);var stat=ret.player.stat;var t={};zutil.forEach(stat,function(v,k){if(omit&&omit.includes(k))return;if(k.substr(-3,3)=="_ms")v=Math.round(v);t[k]=v});stat=t;this.log.console("player stats: "+JSON.stringify(stat))}return ret};E.StartTimeTracker=function(stats){var _this=this,zperr=stats.zone.perr_get();this.zone=stats.zone;this.player=stats.player;this.wrapper=stats.wrapper;this.cdn=stats.wrapper.cdn;this.timeline=stats.timeline;this.player_stats=stats;this.is_enabled=this.zone.CG("stats.start_time");if(!this.is_enabled)return;this.sourceopen_ts=null;this.ready_ts=null;this.stats={elapsed_to_buf:{},buf_on_start:{}};this.is_cdn=false;this.cdn.on("post-attach",this.on_bws=function(){var bws;if(!(bws=_this.cdn.attached_bws))return;_this.is_cdn=true;bws.once("sourceopen",_this.on_sourceopen=function(){_this.sourceopen_ts=date.monotonic();_this.stats.sourceopen=_this.timeline.elapsed_from("playback_enabled")});bws.on("req_start",_this.on_req=function(req){var from_start=_this._from_start();if(!_this.stats.any_req)_this.stats.any_req=from_start;if(!_this.stats.data_req&&!req.info.rate)_this.stats.data_req=from_start});bws.on("parser_init",_this.on_parser=function(){bws.parser.once("meta_info",_this.on_meta=function(){_this.stats.parser_meta=_this._from_start()});bws.parser.once("append_samples",_this.on_sample=function(){_this.stats.parser_sample=_this._from_start()})});if(bws.parser){_this.on_sourceopen();_this.on_parser()}});if(this.cdn.is_attached())this.on_bws();this.player_stats.on("play_start",this.on_play_start=function(){var s=_this.timeline.get_stats()._play_start_from_ts;var a=_this.timeline.find("stats_init",{order:"first"}).ts;_this.stats.start_from=s-a;_this.stats.buf_on_start=_this.get_buffered();if(!_this.ready_ts){var state=_this.player.html5&&_this.player.html5.readyState;zperr({id:"play_start_not_ready_error",add_log:true,extra:{ready_state:state}})}_this.stats.play_start=date.monotonic()-Math.max(_this.ready_ts,s)})};E.StartTimeTracker.prototype._from_start=function(){if(this.is_cdn)return date.monotonic()-this.sourceopen_ts;return this.timeline.elapsed_from("order=first:playback_enabled")};E.StartTimeTracker.prototype.init=function(){if(!this.is_enabled)return;var state=this.player.get_state();this.stats.type=this.player_stats.opt.reset?"reset":state.toLowerCase();this.stats.init_attached_diff=this.player_stats.opt.attach_ts-this.player_stats.opt.ts;this.stats.buf_on_attach=this.player.get_buffered_sec();this.stats.ready_on_attach=this.player.html5&&this.player.html5.readyState;if(!window.hola_cdn_customer_storage)return;var ext=window.hola_cdn_customer_storage;this.stats.external={};if(!ext.loadstart[0])return;this.stats.external.loadstart=ext.loadstart[0];if(ext.progress[0]){this.stats.external.progress=ext.progress[0];this.stats.external.progress_count=ext.progress.length}};E.StartTimeTracker.prototype.uninit=function(){if(!this.is_enabled)return;this.cdn.off("post-attach",this.on_bws);this.player_stats.off("play_start",this.on_play_start);if(window.hola_cdn_customer_storage)window.hola_cdn_customer_storage=undefined;var bws=this.cdn.attached_bws;if(!bws)return;bws.off("sourceopen",this.on_sourceopen);bws.off("req_start",this.on_req);bws.off("parser_init",this.on_parser);if(!bws.parser)return;bws.parser.off("meta_info",this.on_meta);bws.parser.off("append_samples",this.on_sample)};E.StartTimeTracker.prototype.get_buffered=function(){var bws=this.cdn.attached_bws;var s=bws&&bws.get_stream_by_id("video");this.player.refresh_buffered();return{player:this.player.get_buffered_sec(),downloaded:s&&s.downloaded_sec,served:s&&s.served_sec}};E.StartTimeTracker.prototype.poll=function(){if(!this.is_enabled||this.is_cdn&&!this.sourceopen_ts)return;var stats=this.stats;var from_start=this._from_start();var elapsed_to_buf=stats.elapsed_to_buf;var buf=this.get_buffered();Object.keys(buf).forEach(function(k){var v=buf[k];if(!elapsed_to_buf[k+"_0"]&&v>0)elapsed_to_buf[k+"_0"]=from_start;if(!elapsed_to_buf[k+"_3"]&&v>3)elapsed_to_buf[k+"_3"]=from_start});var ready_state=this.player.html5&&this.player.html5.readyState;if(!this.ready_ts&&ready_state>=3)this.ready_ts=date.monotonic();var ready={meta:1,future:3,enough:4};Object.keys(ready).forEach(function(s){if(!stats["ready_"+s]&&ready_state>=ready[s])stats["ready_"+s]=from_start})};E.StartTimeTracker.prototype.get_stats=function(){return this.stats};E.is_bad_performance_single=function(stat,e){return stat[e+"_over_max_ms"]||stat[e+"_waiting_over_max_ms"]};E.is_bad_performance=function(stat){return E.is_bad_performance_single(stat,"play_start")||E.is_bad_performance_single(stat,"paused_play_start")||E.is_bad_performance_single(stat,"seek")||E.is_bad_performance_single(stat,"paused_seek")||E.is_bad_performance_single(stat,"wait")||E.is_bad_performance_single(stat,"resume")};function is_over_10sec(ts){return ts&&date.monotonic()-ts>10*date.ms.SEC}return E});
!function(t,e){"function"==typeof define&&define.amd?define("cash",e):"undefined"!=typeof exports?module.exports=e():t.cash=t.$=e()}(this,function(){function t(t,e){e=e||A;var n=q.test(t)?e.getElementsByClassName(t.slice(1)):W.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t);return n}function e(t){if(!w){w=A.implementation.createHTMLDocument("");var e=w.createElement("base");e.href=A.location.href,w.head.appendChild(e)}return w.body.innerHTML=t,w.body.childNodes}function n(t){"loading"!==A.readyState?t():A.addEventListener("DOMContentLoaded",t)}function r(r,i){if(!r)return this;if(r.cash&&r!==S)return r;var o,u=r,s=0;if(k(r))u=R.test(r)?A.getElementById(r.slice(1)):D.test(r)?e(r):t(r,i);else if(P(r))return n(r),this;if(!u)return this;if(u.nodeType||u===S)this[0]=u,this.length=1;else for(o=this.length=u.length;s<o;s++)this[s]=u[s];return this}function i(t,e){return new r(t,e)}function o(t,e){for(var n=t.length,r=0;r<n&&e.call(t[r],t[r],r,t)!==!1;r++);}function u(t,e){var n=t&&(t.matches||t.webkitMatchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector);return!!n&&n.call(t,e)}function s(t){return k(t)?u:t.cash?function(e){return t.is(e)}:function(t,e){return t===e}}function c(t){return i(B.call(t).filter(function(t,e,n){return n.indexOf(t)===e}))}function a(t){return t[_]=t[_]||{}}function f(t,e,n){return a(t)[e]=n}function h(t,e){var n=a(t);return void 0===n[e]&&(n[e]=t.dataset?t.dataset[e]:i(t).attr("data-"+e)),n[e]}function l(t,e){var n=a(t);n?delete n[e]:t.dataset?delete t.dataset[e]:i(t).removeAttr("data-"+name)}function d(t){return k(t)&&t.match(j)}function p(t,e){return t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)}function v(t,e,n){t.classList?t.classList.add(e):n.indexOf(" "+e+" ")&&(t.className+=" "+e)}function m(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(e,"")}function g(t,e){return parseInt(S.getComputedStyle(t[0],null)[e],10)||0}function y(t,e,n){var r=h(t,"_cashEvents")||f(t,"_cashEvents",{});r[e]=r[e]||[],r[e].push(n),t.addEventListener(e,n)}function b(t,e,n){var r,i=h(t,"_cashEvents"),u=i&&i[e];u&&(n?(t.removeEventListener(e,n),r=u.indexOf(n),r>=0&&u.splice(r,1)):(o(u,function(n){t.removeEventListener(e,n)}),u=[]))}function x(t,e){return"&"+encodeURIComponent(t)+"="+encodeURIComponent(e).replace(/%20/g,"+")}function L(t){var e=[];return o(t.options,function(t){t.selected&&e.push(t.value)}),e.length?e:null}function N(t){var e=t.selectedIndex;return e>=0?t.options[e].value:null}function C(t){var e=t.type;if(!e)return null;switch(e.toLowerCase()){case"select-one":return N(t);case"select-multiple":return L(t);case"radio":return t.checked?t.value:null;case"checkbox":return t.checked?t.value:null;default:return t.value?t.value:null}}function E(t,e,n){if(n){var r=t.childNodes[0];t.insertBefore(e,r)}else t.appendChild(e)}function T(t,e,n){var r=k(e);return!r&&e.length?void o(e,function(e){return T(t,e,n)}):void o(t,r?function(t){return t.insertAdjacentHTML(n?"afterbegin":"beforeend",e)}:function(t,r){return E(t,0===r?e:e.cloneNode(!0),n)})}var w,A=document,S=window,M=Array.prototype,B=M.slice,I=M.filter,H=M.push,O=function(){},P=function(t){return typeof t==typeof O&&t.call},k=function(t){return"string"==typeof t},R=/^#[\w-]*$/,q=/^\.[\w-]*$/,D=/<.+>/,W=/^\w+$/,$=i.fn=i.prototype=r.prototype={cash:!0,length:0,push:H,splice:M.splice,map:M.map,init:r};Object.defineProperty($,"constructor",{value:i}),i.parseHTML=e,i.noop=O,i.isFunction=P,i.isString=k,i.extend=$.extend=function(t){t=t||{};var e=B.call(arguments),n=e.length,r=1;for(1===e.length&&(t=this,r=0);r<n;r++)if(e[r])for(var i in e[r])e[r].hasOwnProperty(i)&&(t[i]=e[r][i]);return t},i.extend({merge:function(t,e){for(var n=+e.length,r=t.length,i=0;i<n;r++,i++)t[r]=e[i];return t.length=r,t},each:o,matches:u,unique:c,isArray:Array.isArray,isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)}});var _=i.uid="_cash"+Date.now();$.extend({data:function(t,e){if(k(t))return void 0===e?h(this[0],t):this.each(function(n){return f(n,t,e)});for(var n in t)this.data(n,t[n]);return this},removeData:function(t){return this.each(function(e){return l(e,t)})}});var j=/\S+/g;$.extend({addClass:function(t){var e=d(t);return e?this.each(function(t){var n=" "+t.className+" ";o(e,function(e){v(t,e,n)})}):this},attr:function(t,e){if(t){if(k(t))return void 0===e?this[0]?this[0].getAttribute?this[0].getAttribute(t):this[0][t]:void 0:this.each(function(n){n.setAttribute?n.setAttribute(t,e):n[t]=e});for(var n in t)this.attr(n,t[n]);return this}},hasClass:function(t){var e=!1,n=d(t);return n&&n.length&&this.each(function(t){return e=p(t,n[0]),!e}),e},prop:function(t,e){if(k(t))return void 0===e?this[0][t]:this.each(function(n){n[t]=e});for(var n in t)this.prop(n,t[n]);return this},removeAttr:function(t){return this.each(function(e){e.removeAttribute?e.removeAttribute(t):delete e[t]})},removeClass:function(t){if(!arguments.length)return this.attr("class","");var e=d(t);return e?this.each(function(t){o(e,function(e){m(t,e)})}):this},removeProp:function(t){return this.each(function(e){delete e[t]})},toggleClass:function(t,e){if(void 0!==e)return this[e?"addClass":"removeClass"](t);var n=d(t);return n?this.each(function(t){var e=" "+t.className+" ";o(n,function(n){p(t,n)?m(t,n):v(t,n,e)})}):this}}),$.extend({add:function(t,e){return c(i.merge(this,i(t,e)))},each:function(t){return o(this,t),this},eq:function(t){return i(this.get(t))},filter:function(t){if(!t)return this;var e=P(t)?t:s(t);return i(I.call(this,function(n){return e(n,t)}))},first:function(){return this.eq(0)},get:function(t){return void 0===t?B.call(this):t<0?this[t+this.length]:this[t]},index:function(t){var e=t?i(t)[0]:this[0],n=t?this:i(e).parent().children();return B.call(n).indexOf(e)},last:function(){return this.eq(-1)}});var F=function(){var t=/(?:^\w|[A-Z]|\b\w)/g,e=/[\s-_]+/g;return function(n){return n.replace(t,function(t,e){return t[0===e?"toLowerCase":"toUpperCase"]()}).replace(e,"")}}(),U=function(){var t={},e=document,n=e.createElement("div"),r=n.style;return function(e){if(e=F(e),t[e])return t[e];var n=e.charAt(0).toUpperCase()+e.slice(1),i=["webkit","moz","ms","o"],u=(e+" "+i.join(n+" ")+n).split(" ");return o(u,function(n){if(n in r)return t[n]=e=t[e]=n,!1}),t[e]}}();i.prefixedProp=U,i.camelCase=F,$.extend({css:function(t,e){if(k(t))return t=U(t),arguments.length>1?this.each(function(n){return n.style[t]=e}):S.getComputedStyle(this[0])[t];for(var n in t)this.css(n,t[n]);return this}}),o(["Width","Height"],function(t){var e=t.toLowerCase();$[e]=function(){return this[0].getBoundingClientRect()[e]},$["inner"+t]=function(){return this[0]["client"+t]},$["outer"+t]=function(e){return this[0]["offset"+t]+(e?g(this,"margin"+("Width"===t?"Left":"Top"))+g(this,"margin"+("Width"===t?"Right":"Bottom")):0)}}),$.extend({off:function(t,e){return this.each(function(n){return b(n,t,e)})},on:function(t,e,r,i){var o;if(!k(t)){for(var s in t)this.on(s,e,t[s]);return this}return P(e)&&(r=e,e=null),"ready"===t?(n(r),this):(e&&(o=r,r=function(t){for(var n=t.target;!u(n,e);){if(n===this)return n=!1;n=n.parentNode}n&&o.call(n,t)}),this.each(function(e){var n=r;i&&(n=function(){r.apply(this,arguments),b(e,t,n)}),y(e,t,n)}))},one:function(t,e,n){return this.on(t,e,n,!0)},ready:n,trigger:function(t,e){var n=A.createEvent("HTMLEvents");return n.data=e,n.initEvent(t,!0,!1),this.each(function(t){return t.dispatchEvent(n)})}}),$.extend({serialize:function(){var t="";return o(this[0].elements||this,function(e){if(!e.disabled&&"FIELDSET"!==e.tagName){var n=e.name;switch(e.type.toLowerCase()){case"file":case"reset":case"submit":case"button":break;case"select-multiple":var r=C(e);null!==r&&o(r,function(e){t+=x(n,e)});break;default:var i=C(e);null!==i&&(t+=x(n,i))}}}),t.substr(1)},val:function(t){return void 0===t?C(this[0]):this.each(function(e){return e.value=t})}}),$.extend({after:function(t){return i(t).insertAfter(this),this},append:function(t){return T(this,t),this},appendTo:function(t){return T(i(t),this),this},before:function(t){return i(t).insertBefore(this),this},clone:function(){return i(this.map(function(t){return t.cloneNode(!0)}))},empty:function(){return this.html(""),this},html:function(t){if(void 0===t)return this[0].innerHTML;var e=t.nodeType?t[0].outerHTML:t;return this.each(function(t){return t.innerHTML=e})},insertAfter:function(t){var e=this;return i(t).each(function(t,n){var r=t.parentNode,i=t.nextSibling;e.each(function(t){r.insertBefore(0===n?t:t.cloneNode(!0),i)})}),this},insertBefore:function(t){var e=this;return i(t).each(function(t,n){var r=t.parentNode;e.each(function(e){r.insertBefore(0===n?e:e.cloneNode(!0),t)})}),this},prepend:function(t){return T(this,t,!0),this},prependTo:function(t){return T(i(t),this,!0),this},remove:function(){return this.each(function(t){return t.parentNode.removeChild(t)})},text:function(t){return void 0===t?this[0].textContent:this.each(function(e){return e.textContent=t})}});var z=A.documentElement;$.extend({position:function(){var t=this[0];return{left:t.offsetLeft,top:t.offsetTop}},offset:function(){var t=this[0].getBoundingClientRect();return{top:t.top+S.pageYOffset-z.clientTop,left:t.left+S.pageXOffset-z.clientLeft}},offsetParent:function(){return i(this[0].offsetParent)}}),$.extend({children:function(t){var e=[];return this.each(function(t){H.apply(e,t.children)}),e=c(e),t?e.filter(function(e){return u(e,t)}):e},closest:function(t){return!t||this.length<1?i():this.is(t)?this.filter(t):this.parent().closest(t)},is:function(t){if(!t)return!1;var e=!1,n=s(t);return this.each(function(r){return e=n(r,t),!e}),e},find:function(e){if(!e||e.nodeType)return i(e&&this.has(e).length?e:null);var n=[];return this.each(function(r){H.apply(n,t(e,r))}),c(n)},has:function(e){var n=k(e)?function(n){return 0!==t(e,n).length}:function(t){return t.contains(e)};return this.filter(n)},next:function(){return i(this[0].nextElementSibling)},not:function(t){if(!t)return this;var e=s(t);return this.filter(function(n){return!e(n,t)})},parent:function(){var t=[];return this.each(function(e){e&&e.parentNode&&t.push(e.parentNode)}),c(t)},parents:function(t){var e,n=[];return this.each(function(r){for(e=r;e&&e.parentNode&&e!==A.body.parentNode;)e=e.parentNode,(!t||t&&u(e,t))&&n.push(e)}),c(n)},prev:function(){return i(this[0].previousElementSibling)},siblings:function(){var t=this.parent().children(),e=this[0];return t.filter(function(t){return t!==e})}});var z=A.documentElement;return $.extend({jqPosition:function(){var t=this[0];if(t){var e,n,r,o,u=i(t),s={top:0,left:0};if("fixed"===u.css("position"))r=t.getBoundingClientRect();else{for(r=this.offset(),o=t.ownerDocument,e=t.offsetParent||z,n=i(e);e&&(e===o.body||e===z)&&"static"===n.css("position");)e=e.parentNode;e&&e!==t&&1===e.nodeType&&(s=n.offset(),s.top+=parseInt(n.css("borderTopWidth"),10)||0,s.left+=parseInt(n.css("borderLeftWidth"),10)||0)}return{top:r.top-s.top-(parseInt(u.css("marginTop"),10)||0),left:r.left-s.left-(parseInt(u.css("marginLeft"),10)||0)}}}}),i});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,[],fn)}}define("/svc/cdn/pub/spark_features.js",[],function(){var E={};E.libs={links:{name:"links",s_enable:"links.enable",force_enable:"hola_links"}};E.features={persistent:{title:"Video Persistent",enable:"spark.persistent.enable",s_enable:"persistent_video.enable",metrics:["cdn_ve_video_persistent_events"],counters:["cdn_ve_video_persistent_events"],name:"persistent",force_enable:"hola_persistent_video"},video_previews:{title:"Video Preview",enable:"spark.video_previews.enable",s_enable:"video_preview.enable",metrics:["cdn_ve_media_bytes"],counters:["cdn_preview_req"],name:"video_previews",force_enable:"hola_ve_preview",dep:["links"]},image_previews:{title:"Image Preview",enable:"spark.image_previews.enable",s_enable:"image_preview.enable",metrics:["cdn_ve_media_bytes"],counters:["cdn_image_preview_req"],name:"image_previews",force_enable:"hola_ve_image_preview",dep:["links"]},playlist:{title:"Playlist",name:"playlist",enable:"spark.playlist.enable",s_enable:"playlist.enable",metrics:["cdn_ve_playlist_ctr"],counters:["cdn_ve_playlist_ctr"],force_enable:"hola_ve_playlist",dep:["links"]},thumbnails:{title:"Player thumbnails",enable:"spark.thumbnails.enable",s_enable:"thumbnails.enable",metrics:["cdn_ve_media_bytes"],counters:["cdn_thumb_req"],name:"thumbnails",force_enable:"hola_thumbnails"},watch_later:{title:"Watch later",enable:"spark.watch_later.enable",s_enable:"watch_later.enable",metrics:["cdn_ve_watch_later_events"],counters:["cdn_ve_watch_later_events"],name:"watch_later",force_enable:"hola_watch_later",dep:["links","position_memory"]},position_memory:{title:"Position memory",enable:"spark.position_memory.enable",s_enable:"position_memory.enable",metrics:["cdn_ve_position_memory_events"],counters:["cdn_ve_position_memory_events"],name:"position_memory",force_enable:"hola_position_memory",dep:["links"]},autoplay:{title:"Video auto play",enable:"spark.autoplay.enable",s_enable:"autoplay.enable",metrics:["cdn_ve_autoplay_events"],counters:["cdn_ve_autoplay_events"],name:"autoplay",force_enable:"hola_video_autoplay"}};return E})})();
define("/svc/cdn/pub/yt_embed.js",["cash","/util/events.js","/util/util.js","/svc/cdn/pub/util.js"],function($,events,zutil,util){var E=YT;zutil.inherits(YT,events.EventEmitter);function YT(){this.players=[]}YT.Player=function(yt,iframe,id){this.id=id;this.yt=yt;if(iframe&&iframe.src.indexOf("enablejsapi")==-1){iframe.src+=(iframe.src.indexOf("?")!=-1?"&":"?")+"enablejsapi=1"}this.iframe=iframe;this.api=null};zutil.inherits(YT.Player,events.EventEmitter);YT.Player.prototype.init=function(){var p;var ready_fn=this.on_ready.bind(this);var state_changed_fn=this.on_state_changed.bind(this);if(p=window.YT.get(this.iframe.id)){ready_fn({target:p});p.addEventListener("onStateChange",state_changed_fn)}else{new window.YT.Player(this.iframe,{events:{onReady:ready_fn,onStateChange:state_changed_fn}})}};YT.Player.prototype.on_ready=function(event){this.api=event.target;this.yt.emit("player_init",{player:this})};YT.Player.prototype.on_state_changed=function(event){if(event.data==0||event.data==2)this.emit("pause");else if(event.data==1)this.emit("play")};YT.Player.prototype.paused=function(){var state=this.api.getPlayerState();return state!=1};YT.Player.prototype.play=function(){this.api.playVideo()};YT.Player.prototype.pause=function(){this.api.pauseVideo()};YT.Player.prototype.getPosition=function(){return this.api.getCurrentTime()};YT.Player.prototype.setPosition=function(pos){this.api.seekTo(pos)};YT.prototype.find_player=function(iframe){return this.players.find(function(p){return p.iframe==iframe})};YT.prototype.find_embeds=function(){var iframes=document.getElementsByTagName("iframe");for(var i=0;i<iframes.length;i++){if(iframes[i]){var src=iframes[i].getAttribute("src");if(!src||src.indexOf("youtube.com/embed")==-1)continue;if(this.find_player(iframes[i]))continue;var p=new YT.Player(this,iframes[i],this.players.length);this.players.push(p);if(this.attached)p.init()}}};YT.prototype._attach=function(){if(!window.YT)return void setTimeout(this._attach.bind(this),250);this.attached=true;var _this=this;window.YT.ready(function(){_this.players.forEach(function(p){p.init()})})};YT.prototype.attach=function(){if(window.YT)return void this._attach();var tag=document.createElement("script");tag.src="//www.youtube.com/iframe_api";document.head.appendChild(tag);this._attach()};YT.prototype.start=function(opt){opt=opt||{};var _this=this;$(function(){_this.find_embeds();if(_this.players.length)_this.attach()});if(opt.dom_listen){util.dom_listen(document,function(){_this.find_embeds()})}};return E});
define("/svc/cdn/pub/watermark.js",["cash","/util/util.js","/svc/cdn/pub/util.js"],function($,zutil,util){var E=Watermark;var def_styles={".hola_watermark.hola_hidden":{visibility:"hidden",opacity:"0"},".hola_watermark":{position:"absolute !important","z-index":"999","max-width":"50px","max-height":"50px","min-width":"20px","min-height":"20px",width:"30%",height:"40%",opacity:"1",transition:"opacity 0.5s ease-in-out","pointer-events":"auto","background-size":"contain","background-repeat":"no-repeat","background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)"},".hola_watermark.rel_x":{},".hola_watermark.rel_y":{},".hola_watermark:hover":{"background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)"},".hola_watermark:hover .hola_hint":{visibility:"visible"},".hola_watermark:hover .hola_hint.hola_hidden":{visibility:"hidden"},".hola_watermark .hola_hint::after":{display:"inline-block","align-self":"center",content:"''",width:"0",position:"absolute",height:"0","border-style":"solid"},".hola_watermark .hola_hint::before":{display:"inline-block","align-self":"center",content:"''",width:"0",position:"absolute",height:"0","border-style":"solid"},".hola_watermark .hola_hint":{visibility:"hidden","box-shadow":"0 2px 2px 0 rgba(17, 42, 52, 0.69)","text-align":"center",display:"inline-block","align-self":"center","line-height":"20px","font-size":"14px","font-family":"Lato, Helvetica, Verdana",position:"relative","border-radius":"4px","border-style":"solid","border-width":"1px",padding:"8px 15px","white-space":"nowrap"}};var def_settings={corner:"top-right",max_icon_shift:{x:"8px",y:"8px"},icon_shift:{x:"2%",y:"4%"},hint_shift:{x:"0px",y:"auto"},hint_bg:"white",hint_fg:"rgba(0, 82, 113, 0.82)",hint_pointer_shift:"auto",hint_pointer_size:"10px",hint_text:"Powered by Hola Spark"};function Watermark(opt){opt=zutil.extend_deep({},zutil.clone_deep(def_settings),zutil.clone_deep(opt));if(!(this instanceof Watermark)){if(!opt.enable&&!/show_hola_icon/.test(window.location.href))return;return new Watermark(opt)}this.customer=opt.customer;this.module=opt.module;this.css_name=opt.module+"_watermark";var styles={},style;var conf_styles=zutil.extend_deep({},zutil.clone_deep(def_styles),opt.extra_css,opt.extra_css_fn?opt.extra_css_fn():undefined);for(style in conf_styles){styles[style.replace(".hola_watermark","."+this.css_name)]=conf_styles[style]}var fix_px=function(size){return/\d$/.test(""+size)?size+"px":size};var wm_style=styles["."+this.css_name];if(opt.static){opt.delay=function(duration,pos){return 0};Object.assign(wm_style,{height:"10%",width:"auto","max-height":"140px","max-width":"140px",transition:null})}this.delay=opt.delay;if(opt.icon_url)wm_style["background-image"]="url("+opt.icon_url+")";if("icon_hover_url"in opt){styles["."+this.css_name+":hover"]["background-image"]=opt.icon_hover_url?"url("+opt.icon_hover_url+")":null}if(typeof opt.corner=="string"){opt.corner={topright:0,bottomright:1,bottomleft:2,topleft:3,tr:0,br:1,bl:2,tl:3}[opt.corner.toLowerCase().replace(/[-_]+/g,"")]}opt.corner=Math.min(3,Math.max(0,opt.corner||0))|0;opt.max_icon_shift=opt.max_icon_shift||{};var x_shift=opt.corner==0||opt.corner==1?"right":"left";var y_shift=opt.corner==0||opt.corner==3?"top":"bottom";var iy_shift=opt.corner==0||opt.corner==3?"bottom":"top";wm_style[x_shift]=fix_px(opt.max_icon_shift.x);wm_style[y_shift]=fix_px(opt.max_icon_shift.y);opt.icon_shift=opt.icon_shift||{};styles["."+this.css_name+".rel_x"][x_shift]=fix_px(opt.icon_shift.x);styles["."+this.css_name+".rel_y"][y_shift]=fix_px(opt.icon_shift.y);var icon_shift={rel_x:/%$/.test(opt.icon_shift.x),rel_y:/%$/.test(opt.icon_shift.y),x:parseInt(opt.icon_shift.x),y:parseInt(opt.icon_shift.y),max_x:parseInt(opt.max_icon_shift.x),max_y:parseInt(opt.max_icon_shift.y)};this.use_rel=function(cont,axis){var shift=1;if(icon_shift["rel_"+axis])shift=(axis=="x"?$(cont).width():$(cont).height())/100;return icon_shift["max_"+axis]>shift*icon_shift[axis]};wm_style["background-position-x"]=x_shift=="right"?"100%":"0%";wm_style["background-position-y"]=y_shift=="bottom"?"100%":"0%";var hint_style=styles["."+this.css_name+" .hola_hint"];var hint_style_a=styles["."+this.css_name+" .hola_hint::after"];var hint_style_b=styles["."+this.css_name+" .hola_hint::before"];hint_style_a[iy_shift]="100%";hint_style_b[iy_shift]="100%";var color_rotate=function(c){return y_shift=="top"?"transparent transparent "+c:c+" transparent transparent"};hint_style_a["border-color"]=color_rotate(opt.hint_bg);hint_style_b["border-color"]=color_rotate(opt.hint_fg);hint_style.background=opt.hint_bg;hint_style["border-color"]=opt.hint_fg;hint_style.color=opt.hint_fg;if(opt.hint_pointer_shift=="auto"){this.hint_pointer_shift="auto";delete opt.hint_pointer_shift}opt.hint_pointer_shift=parseInt(opt.hint_pointer_shift||"8px");hint_style_a[x_shift]=opt.hint_pointer_shift+"px";hint_style_b[x_shift]=opt.hint_pointer_shift-1+"px";opt.hint_pointer_size=this.hint_pointer_size=parseInt(opt.hint_pointer_size);hint_style_a["border-width"]=opt.hint_pointer_size+"px";hint_style_b["border-width"]=opt.hint_pointer_size+1+"px";opt.hint_shift=opt.hint_shift||{};if(opt.hint_shift.y=="auto"){opt.hint_shift.y=y_shift=="top"?"calc(100% + "+(opt.hint_pointer_size+1)+"px)":(parseInt(hint_style["line-height"])||0)+(parseInt(hint_style.padding)||0)*2+(parseInt(hint_style["border-width"])||0)*2+opt.hint_pointer_size+1+"px"}hint_style[y_shift]=fix_px(opt.hint_shift.y);this.hint_shift=parseInt(opt.hint_shift.x);if(x_shift=="left"){hint_style[x_shift]=this.hint_shift+"px";delete this.hint_shift}this.hint_text=opt.hint_text;this.doc=opt.doc||document;this.x_shift=x_shift;var old_fallback=this.x_shift=="top"?"."+this.css_name+" .hola_hint {\n    top: 110%;\n}\n":"";$(this.doc).find("head").append("<style>"+old_fallback+util.get_stylesheet(styles)+"</style>")}Watermark.prototype.apply=function(opt){if(this.container)this.remove(this.container);this.container=opt.container;var hint=this.hint=this.doc.createElement("div");$(hint).addClass("hola_hint");$(hint).html(this.hint_text);var pic=this.pic=this.doc.createElement("div");pic.appendChild(hint);$(pic).addClass(this.css_name);$(pic).addClass("hola_hidden");this.style=this.doc.createElement("style");pic.appendChild(this.style);this.link=this.doc.createElement("a");var cam="wm_"+this.module+"_"+this.customer;$(this.link).attr("href","http://holaspark.com?cam="+cam);$(this.link).attr("target","_blank");$(this.link).attr("style","position: static !important;");this.link.appendChild(pic);opt.container.appendChild(this.link);var _this=this;this.rm_dur=on_duration_change(opt.v,function(duration){var _pic=_this.pic;if(!_pic)return;if(!duration||!$(_pic).hasClass("hola_hidden"))return;var cb=function(){if(this.rm_dur)this.rm_dur=clearTimeout(this.rm_dur);var pos=opt.v.currentTime||opt.v.get_pos&&opt.v.get_pos()||0;var opt_delay=_this.delay&&_this.delay(duration,pos)||0;var delay=Math.max(0,opt_delay)*1e3;this.rm_dur=setTimeout(function(){$(_pic).removeClass("hola_hidden")},delay)};var html5=opt.v.html5||window.HTMLMediaElement&&opt.v instanceof window.HTMLMediaElement&&opt.v;if(html5){$(html5).on("playing",cb);$(html5).on("seeked",cb)}cb()});$(pic).one("mouseenter",this.on_size_known.bind(this,opt));this.rm_size=setTimeout(this.on_size_known.bind(this,opt),0);this.rm_size_ensure=setTimeout(this.on_size_known.bind(this,opt),5e3)};Watermark.prototype.on_size_known=function(opt){if(!this.hint||!this.pic)return;var hint=this.hint,pic=this.pic;var small_for_hint=$(opt.container).innerWidth()<=$(hint).outerWidth()||$(opt.container).innerHeight()<=$(hint).outerHeight()+$(pic).height();ensure_class(hint,small_for_hint,"hola_hidden");ensure_class(pic,this.use_rel(opt.container,"x"),"rel_x");ensure_class(pic,this.use_rel(opt.container,"y"),"rel_y");if(this.hint_pointer_shift=="auto"){var hint_pointer_shift=Math.max(1,(Math.min($(pic).innerWidth(),$(pic).innerHeight())>>1)-this.hint_pointer_size);var styles={},elements=["after","before"];for(var i=0;i<elements.length;i++){var s=styles["."+this.css_name+" .hola_hint::"+elements[i]]={};s[this.x_shift]=hint_pointer_shift-i+"px"}$(this.style).text(util.get_stylesheet(styles))}if(!("hint_shift"in this))return;$(hint).css("right",$(hint).innerWidth()+this.hint_shift-$(pic).innerWidth()+"px")};Watermark.prototype.remove=function(container){if(container&&container!=this.container)return;this.container=null;if(this.rm_size)this.rm_size=clearTimeout(this.rm_size);if(this.rm_size_ensure)this.rm_size_ensure=clearTimeout(this.rm_size_ensure);if(this.rm_dur)this.rm_dur=clearTimeout(this.rm_dur);if(this.hint){$(this.hint).remove();this.hint=null}if(this.pic){$(this.pic).remove();this.pic=null}if(this.link){$(this.link).remove();this.link=null}if(this.style){$(this.style).remove();this.style=null}};function ensure_class(elem,cond,c){$(elem)[cond?"addClass":"removeClass"](c)}function on_duration_change(player,cb,sync){var html5=player.html5||window.HTMLMediaElement&&player instanceof window.HTMLMediaElement&&player;var duration=html5&&html5.duration||player.get_duration&&player.get_duration()||0;if(duration||sync)return void cb(duration==Infinity?60:duration);if(html5){return void $(html5).on("durationchange",on_duration_change.bind(null,player,cb,true))}return setTimeout(on_duration_change.bind(null,player,cb),1e3)}return E});
define("/svc/cdn/pub/persistent_video.js",["/svc/cdn/pub/log.js","cash","/svc/cdn/pub/util.js","/util/util.js","/svc/cdn/pub/yt_embed.js","/util/storage.js","/svc/cdn/pub/watermark.js"],function(_log,$,util,zutil,_yt_embed,storage,watermark){var E={},assign=Object.assign,id="persistent_video";var log=_log.set_module(id);var is_touch=typeof document!="undefined"&&"ontouchstart"in document;var _window=typeof window!="undefined"&&window.top;var _document;try{_document=_window.document}catch(e){}var yt_embed=new _yt_embed;E.players=[];E.slaves=[];E.default_conf={params:{y_percentage:.5,corner:is_touch?1:0,margin_top:5,margin_right:10,margin_bottom:5,margin_left:10,desktop:{width:"200px",height:"inherit",z_index:9999999,css:""},mobile:{width:"200px",height:"inherit",z_index:9999999,css:""},paused:false,draggable:true,draggable_head:true,pause_on_close:false,sync_frame_size:false,infinite_scroll_aware:false,ad_persistent:true}};function add_style_string(str,doc){doc=doc||_document;var node;try{node=doc.createElement("style");node.innerHTML=str;doc.head.appendChild(node)}catch(e){return false}return node}function generate_styles(){var color_first="#000000";var color_second="rgba(0,0,0,0.3)";var color_contrast="white";var sm_min="768px";var md_min="992px";var lg_min="1200px";var width=parseInt(util.is_mobile?E.conf.params.mobile.width:E.conf.params.desktop.width)||200;var height=parseInt(util.is_mobile?E.conf.params.mobile.height:E.conf.params.desktop.height);var z_index=util.is_mobile?E.conf.params.mobile.z_index:E.conf.params.desktop.z_index;var css_classes={".floating-video":{width:width+"px",position:"fixed !important","z-index":z_index+" !important",border:"1px solid "+color_first,padding:"0 !important","box-shadow":"0 0 5px black","min-height":height?height+"px":undefined,"background-color":"black",transform:"none !important"},".floating-video-holder":{display:"block"},".floating-video-hidden":{display:"none !important"},".floating-video-control":{position:"fixed","z-index":z_index+1,cursor:E.conf.params.draggable?"move":"auto","pointer-events":E.conf.params.draggable?"auto":"none","text-align":"left !important"},".floating-video-control .fv-close":{color:color_contrast,width:"20px","line-height":"20px",border:"none",background:"transparent",cursor:"pointer !important","pointer-events":"auto",padding:"0"},".floating-video-control .fv-close::after":{"font-size":"25px","font-family":"monospace",display:"block",transform:"translateY(-2px) rotate(45deg)",content:'"\\00ab"'},".floating-video-control .fv-close:hover":{background:color_second},".floating-video *":{"max-height":"100% !important","min-height":"0px !important"},".floating-watermark-overlay":{position:"fixed","z-index":z_index+2,padding:"0","pointer-events":"none"}};var styles=util.get_stylesheet(css_classes);styles+="@media (min-width: "+sm_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.25+"px","min-height":height?height*1.25+"px":undefined}})+"}";styles+="@media (min-width: "+md_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.5+"px","min-height":height?height*1.25+"px":undefined}})+"}";styles+="@media (min-width: "+lg_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.5+"px","min-height":height?height*1.5+"px":undefined}})+"}";styles+=util.is_mobile?E.conf.params.mobile.css:E.conf.params.desktop.css;return add_style_string(styles)}function is_visible_by_y(el){var rect=el.getBoundingClientRect();var delta=E.conf.params.y_percentage*rect.height;return rect.top>=-delta&&rect.bottom<=(_window.innerHeight||_document.documentElement.clientHeight)+delta}function get_margins(baseline,translate_x,translate_y){var res={};switch(parseInt(E.conf.params.corner)){case 1:res.right=E.conf.params.margin_right+translate_x;res.bottom=baseline+E.conf.params.margin_bottom-translate_y;break;case 2:res.bottom=baseline+E.conf.params.margin_bottom-translate_y;res.left=E.conf.params.margin_left-translate_x;break;case 3:res.top=baseline+E.conf.params.margin_top+translate_y;res.left=E.conf.params.margin_left-translate_x;break;default:res.top=baseline+E.conf.params.margin_top+translate_y;res.right=E.conf.params.margin_right+translate_x}return res}function calc_baseline(player){var prev=player.prev_floating;if(!prev)return 0;var c=parseInt(E.conf.params.corner);var m=c==1||c==2?E.conf.params.margin_bottom:E.conf.params.margin_top;return util.is_mobile?prev.baseline+10*m:prev.baseline+prev.height+m}function update_baselines(first_player){var p=first_player;while(p){var old_baseline=p.baseline;p.baseline=calc_baseline(p);var m1=get_margins(old_baseline,p.translate_x||0,p.translate_y||0);var m2=get_margins(p.baseline,p.translate_x||0,p.translate_y||0);var keys=[{top:m1.top?m1.top+"px":"auto",right:m1.right?m1.right+"px":"auto",bottom:m1.bottom?m1.bottom+"px":"auto",left:m1.left?m1.left+"px":"auto"},{top:m2.top?m2.top+"px":"auto",right:m2.right?m2.right+"px":"auto",bottom:m2.bottom?m2.bottom+"px":"auto",left:m2.left?m2.left+"px":"auto"}];animate_player(p,keys,function(){});p=p.next_floating}}function init_watermark(player){if(!player.watermark_overlay){var d=_document||window.document;var watermark_overlay=d.createElement("div");player.watermark_overlay=watermark_overlay;$(watermark_overlay).addClass("floating-watermark-overlay");d.body.appendChild(watermark_overlay);E.watermark.apply({v:player.hola,container:watermark_overlay})}player.watermark_overlay.style.display="block";update_watermark(player)}function update_watermark(player){if(!player.watermark_overlay)return;var m=get_margins(player.baseline||0,player.translate_x||0,player.translate_y||0);for(var i in m)set_property(player.watermark_overlay,i,m[i]+"px");set_property(player.watermark_overlay,"width",$(player.container).width()+"px");set_property(player.watermark_overlay,"height",$(player.container).height()+"px")}function hide_video_control(player){if(player.watermark_overlay)player.watermark_overlay.style.display="none";if(player.video_control)player.video_control.style.display="none";if(E.conf.params.draggable)disable_draggable(player)}function close_video_control(player){if(E.conf.params.draggable)disable_draggable(player);if(player.video_control)_document.body.removeChild(player.video_control);if(player.watermark_overlay){_document.body.removeChild(player.watermark_overlay);E.watermark.remove(player.watermark_overlay)}}function init_video_control(player){if(!player.video_control){player.video_control=_document.createElement("div");player.video_control.setAttribute("class","floating-video-control");player.video_control.innerHTML="<button class=fv-close></button>";_document.body.appendChild(player.video_control);$(player.video_control).find("button[class=fv-close]").on("click",function(){disable_floating(player)})}player.video_control.style.display="block";update_video_control(player);if(E.conf.params.draggable)enable_draggable(player)}function update_video_control(player){if(!player.video_control)return;var ratio=$(player.container).height()/$(player.container).width();var height=Math.round(player.width*ratio);set_property(player.video_control,"top","auto");set_property(player.video_control,"right","auto");set_property(player.video_control,"bottom","auto");set_property(player.video_control,"left","auto");set_property(player.video_control,"width",player.width+"px");if(!E.conf.params.draggable_head)set_property(player.video_control,"height",height+"px");var vc_width=$(player.video_control).width();var vc_height=$(player.video_control).height();var m=get_margins(player.baseline||0,player.translate_x||0,player.translate_y||0);for(var i in m){if(i=="bottom")m[i]+=height-vc_height;if(i=="left")m[i]+=player.width-vc_width;set_property(player.video_control,i,m[i]+"px")}}function enable_touch_gestures(player,is_slave){log.debug_spark("enable touch gestures");var start_x=null,translate_x=null;if(!player.touch_fns){player.touch_fns={touchstart:function(e){var t=e.touches[0];start_x=t.screenX},touchmove:function(e){e.preventDefault();var t=e.touches[0];translate_x=start_x-t.screenX;if(is_slave)E.msg.touch_move({translate_x:translate_x});else player.touch_fns.do_touchmove(translate_x)},touchend:function(e){start_x=null;if(is_slave)E.msg.touch_end({translate_x:translate_x});else player.touch_fns.do_touchend(translate_x)}};if(!is_slave){var doc_width=_window.innerWidth||_document.documentElement.clientWidth||_document.body.clientWidth;player.touch_fns.do_touchmove=function(translate){update_floating_position(player,translate);$(player.container).css({opacity:Math.max(0,1-Math.abs(translate/(doc_width/2)))})};player.touch_fns.do_touchend=function(translate){if(doc_width/2<Math.abs(translate))disable_floating(player);else{update_floating_position(player);$(player.container).css({opacity:1})}}}}player.container.addEventListener("touchstart",player.touch_fns.touchstart,false);player.container.addEventListener("touchmove",player.touch_fns.touchmove,false);player.container.addEventListener("touchend",player.touch_fns.touchend,false)}function disable_touch_gestures(player){log.debug_spark("disable_touch_gestures");player.container.removeEventListener("touchstart",player.touch_fns.touchstart,false);player.container.removeEventListener("touchmove",player.touch_fns.touchmove,false);player.container.removeEventListener("touchend",player.touch_fns.touchend,false)}function set_property(node,property,value){node.style.setProperty(property,value,"important")}function update_floating_position(player,translate_x,translate_y){if(get_fullscreen_element())return;var m=get_margins(player.baseline||0,player.translate_x||+translate_x||0,player.translate_y||+translate_y||0);for(var i in m)set_property(player.container,i,m[i]+"px")}function get_fullscreen_element(){return _document.fullscreenElement||_document.mozFullScreenElement||_document.webkitFullscreenElement||_document.msFullscreenElement}function init_floating_position(player,height,keyframe){if(get_fullscreen_element())return;keyframe=keyframe||{};var ratio=$(player.container).height()/$(player.container).width();var ms=player.hola?player.hola.get_media_size():player.state.media_size;if(ms)ratio=ms.height/ms.width;player.height=height||Math.round(player.width*ratio);set_property(player.container,"min-width",player.width+"px");set_property(player.container,"width",keyframe.width||player.width+"px");set_property(player.container,"height",keyframe.height||height+"px");set_property(player.container,"min-height",player.height+"px");set_property(player.container,"top",keyframe.top||"auto");set_property(player.container,"right",keyframe.right||"auto");set_property(player.container,"bottom",keyframe.bottom||"auto");set_property(player.container,"left",keyframe.left||"auto");var old_scroll_y=window.scrollY;set_property(player.container,"position","fixed");if(old_scroll_y!=window.scrollY)window.scrollBy(0,old_scroll_y-window.scrollY);if(!keyframe.left&&!keyframe.right)update_floating_position(player)}function keyframes_floating_start(player){var orig_width=$(player.container).width();var orig_height=$(player.container).height();var width=player.width;var ratio=orig_height/orig_width;var ms=player.hola?player.hola.get_media_size():player.state.media_size;if(ms)ratio=ms.height/ms.width;var height=Math.round(width*ratio);var m=get_margins(player.baseline||0,player.translate_x||0,player.translate_y||0);var cr=player.container.getBoundingClientRect();return[{width:orig_width+"px",height:orig_height+"px",top:m.top?cr.top+"px":"auto",right:m.right?_document.body.clientWidth-cr.right+"px":"auto",bottom:m.bottom?_document.body.clientHeight-cr.bottom+"px":"auto",left:m.left?cr.left+"px":"auto"},{width:width+"px",height:height+"px",top:m.top?m.top+"px":"auto",right:m.right?m.right+"px":"auto",bottom:m.bottom?m.bottom+"px":"auto",left:m.left?m.left+"px":"auto"}]}function keyframes_floating_end_f1(player,m){return{width:$(player.container).width()+"px",height:$(player.container).height()+"px",top:m.top?m.top+"px":"auto",right:m.right?m.right+"px":"auto",bottom:m.bottom?m.bottom+"px":"auto",left:m.left?m.left+"px":"auto"}}function keyframes_floating_end_f2(player,m,f2){var cr=player.holder.getBoundingClientRect();var res={width:$(player.holder).width()+"px",height:$(player.holder).height()+"px",top:m.top?cr.top+"px":"auto",right:m.right?_document.body.clientWidth-cr.right+"px":"auto",bottom:m.bottom?_document.body.clientHeight-cr.bottom+"px":"auto",left:m.left?cr.left+"px":"auto"};if(f2)assign(f2,res);return res}function disable_floating(player){if(E.conf.params.pause_on_close){player.pause();end_floating(player)}else end_floating(player,function(){remove_player(player)})}function detect_googima(player){if(!player.hola)return player.state.is_googima;return player.is_ad_playing()&&(!!$(player.container).find("#"+player.container.id+"_googima").length||!!$(player.container).find("#"+player.container.id+"_ima-ad-container").length)}function enable_draggable(player){log.debug_spark("enable dragging");player.translate_x=player.translate_x||0;player.translate_y=player.translate_y||0;if(!player.draggable_fns){player.draggable_fns={mousedown:function(e){player.draggable={start_x:e.x,start_y:e.y};e.preventDefault()},mousemove:function(e){if(!player.draggable)return;player.translate_x+=-e.x+player.draggable.start_x;player.translate_y+=e.y-player.draggable.start_y;update_floating_position(player);update_video_control(player);update_watermark(player);player.draggable.start_x=e.x;player.draggable.start_y=e.y;e.preventDefault()},mouseup:function(){player.draggable=false}}}$(player.video_control).on("mousedown",player.draggable_fns.mousedown);$(_document.body).on("mousemove",player.draggable_fns.mousemove);$(_document.body).on("mouseup",player.draggable_fns.mouseup)}function disable_draggable(player){if(!player.video_control)return;log.debug_spark("disable dragging");player.draggable=false;$(player.video_control).off("mousedown",player.draggable_fns.mousedown);$(_document.body).off("mousemove",player.draggable_fns.mousemove);$(_document.body).off("mouseup",player.draggable_fns.mouseup)}function relative_css_val(v1,v2,ratio){var a=parseFloat(v1);var b=parseFloat(v2);if(v1.endsWith("px")&&v2.endsWith("px"))return(b-a)*ratio+a+"px"}function fix_ima_size(player){if(!player.hola){if(player.container.tagName=="IFRAME"){send_hola_msg({frame:player.container.contentWindow},"pv_fix_ima_size")}return}if(player.is_ad_playing()&&player.hola.vjs&&player.hola.vjs.ima&&player.hola.vjs.ima.adsManager){var ima=player.hola.vjs.ima;var NORMAL=window.google&&window.google.ima?window.google.ima.ViewMode.NORMAL:"normal";ima.adsManager.resize($(player.container).width(),$(player.container).height(),NORMAL);if(player.is_floating)init_floating_position(player,player.height)}else{if(typeof window.UIEvent==="function")window.dispatchEvent(new window.UIEvent("resize"));else{var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",true,false,window,0);window.dispatchEvent(evt)}}}function sync_frame_size(player,persistent,fdims){if(!E.conf.params.sync_frame_size)return;fdims=fdims||_window.getComputedStyle(player.container);if(!player.hola){send_hola_msg({frame:player.container.contentWindow},"pv_sync_size",{persistent:persistent,width:fdims.width,height:fdims.height});return}var real_container=player.hola.get_container();if(!persistent){if(player.stored_rcstyle){real_container.style.width=player.stored_rcstyle.width;real_container.style.height=player.stored_rcstyle.height}player.stored_rcstyle=undefined;return}var cdims=window.getComputedStyle(real_container);if(cdims.width.length!=0&&fdims.width!=cdims.width||cdims.height.length!=0&&fdims.height!=cdims.height){player.stored_rcstyle={};player.stored_rcstyle.width=real_container.style.width;player.stored_rcstyle.height=real_container.style.height;real_container.style.width=fdims.width;real_container.style.height=fdims.height}}function animate_player(player,keyframes,done){if(player.is_animating){if(!player.animation_stack)player.animation_stack=[];player.animation_stack.push({keyframes:keyframes,done:done});return}function done_wrapper(e){done(e);fix_ima_size(player);player.is_animating=false;if(player.animation_stack&&player.animation_stack.length){var a=player.animation_stack.shift();animate_player(player,a.keyframes,a.done)}}player.is_animating=true;var dur=.3;if(detect_googima(player)){log.debug_spark("Google IMA is active, doing immediate transition");dur=0}var start_time=(new Date).getTime();var end_time=dur*1e3;var int=setInterval(function frame_update(){var frame_time=((new Date).getTime()-start_time)/end_time;var animation_end=false;if(frame_time>=1){frame_time=1;animation_end=true}for(var k in keyframes[0]){var val=relative_css_val(keyframes[0][k],keyframes[1][k],frame_time);if(val)set_property(player.container,k,val)}if(animation_end){clearInterval(int);done_wrapper()}},10)}function end_floating(player,done){log.debug_spark("player id "+player.container.id+": floating -> normal");var is_playing=player.is_playing();hide_video_control(player);if(is_touch)disable_touch_gestures(player);var m=get_margins(player.baseline||0,player.translate_x||0,player.translate_y||0);var f1=keyframes_floating_end_f1(player,m);var f2=keyframes_floating_end_f2(player,m);var keyframe_int=setInterval(function keyframe_recalc(){keyframes_floating_end_f2(player,m,f2)},10);var np=remove_from_floating_list(player);delete player.baseline;animate_player(player,[f1,f2],function(){update_baselines(np);clearInterval(keyframe_int);if(player.dom_transform){$(player.holder).before(player.container);setTimeout(function(){if(is_playing)player.play()},1)}if(player.container.parentNode){player.container.parentNode.classList.remove("floating-video-parent")}if(player.container.tagName=="IFRAME"){if(player.old_scrolling_attr){$(player.container).attr("scrolling",player.old_scrolling_attr)}else $(player.container).removeAttr("scrolling");sync_frame_size(player,false);send_hola_msg({frame:player.container.contentWindow},"pv_end_floating")}player.container.classList.remove("floating-video");$(player.container).attr("style",player.container_styles);player.holder.classList.add("floating-video-hidden");player.is_floating=false;if(player.hola){player.hola.emit("persistent.end_floating");player.hola.enable_context_menu();player.hola.set_captions_track(player.saved_captions_track)}if(done)done()})}var HOLDER_STYLES=["display","width","height","top","left","right","bottom","position","margin","marginTop","marginLeft","marginRight","marginBottom","minWidth"];function calculate_width(){var a=$("<div class=floating-video>&nbsp;</div>");a.css({visibility:"hidden",position:"fixed"});$(_document.body).append(a);var width=a.width();a.remove();return width}function add_to_floating_list(player){if(!E.floating_head)return E.floating_head=player;var cur=E.floating_head;while(cur.next_floating)cur=cur.next_floating;cur.next_floating=player;player.prev_floating=cur}function remove_from_floating_list(player){if(player.prev_floating)player.prev_floating.next_floating=player.next_floating;else E.floating_head=player.next_floating;if(player.next_floating)player.next_floating.prev_floating=player.prev_floating;var np=player.next_floating;delete player.prev_floating;delete player.next_floating;return np}function start_floating(player){var old_scroll_top=_document.body.scrollTop;log.debug_spark("player id "+player.container.id+": normal -> floating");if(player.hola){player.hola.emit("persistent.start_floating");player.hola.disable_context_menu();player.saved_captions_track=player.hola.get_captions_track();player.hola.set_captions_track(-1)}add_to_floating_list(player);player.baseline=calc_baseline(player);player.width=calculate_width();var keys=keyframes_floating_start(player),i;var is_playing=player.is_playing();if(!E.spark.stats.get(id+"_start_n"))E.stats_inc("start_unique");E.stats_inc("start_n");player.container_styles=$(player.container).attr("style")||"";if(!player.holder){player.holder=_document.createElement("div");$(player.container).after(player.holder);player.holder.setAttribute("class","floating-video-holder")}for(i=0;i<HOLDER_STYLES.length;i++){$(player.holder).css(HOLDER_STYLES[i],$(player.container).css(HOLDER_STYLES[i]))}if($(player.container).css("display")=="inline")$(player.holder).css("display","inline-block");player.holder.classList.remove("floating-video-hidden");init_floating_position(player,null,keys[0]);if(player.dom_transform){$(_document.body).append(player.container);setTimeout(function(){if(is_playing)player.play()},1)}player.container.classList.add("floating-video");if(player.container.parentNode)player.container.parentNode.classList.add("floating-video-parent");if(player.container.tagName=="IFRAME"){player.old_scrolling_attr=$(player.container).attr("scrolling");$(player.container).attr("scrolling","no");send_hola_msg({frame:player.container.contentWindow},"pv_start_floating")}animate_player(player,keys,function(){set_property(player.container,"animation","none");update_floating_position(player);setTimeout(function(){if(is_touch)enable_touch_gestures(player);else init_video_control(player);if(E.watermark){if(player.container.tagName=="IFRAME"){send_hola_msg({frame:player.container.contentWindow},"pv_init_watermark")}else init_watermark(player)}},0);if(player.container.tagName=="IFRAME")sync_frame_size(player,true)});player.is_floating=true;_document.body.scrollTop=old_scroll_top}var checked_videos=[];function check_skip_video(video,opt){opt=opt||{};var tag=video.get_container?video.get_container():video;if(checked_videos.indexOf(video)>=0||tag.tagName=="VIDEO"&&tag.currentSrc.indexOf("//ve.h-cdn.com/previews/static/")>=0||tag.tagName=="IFRAME"&&tag.src.indexOf("//www.youtube.com/embed")>=0&&!opt.yt){return false}checked_videos.push(video);return!!E.conf.enable||E.spark.force_enable("persistent")}function send_hola_msg(dst,msg,data){var o=dst.origin||"*";dst.frame.postMessage({hola_msg:msg,data:data},o)}function proc_floating_msg(msg,data){switch(msg){case"pv_start_floating":$("body").addClass("floating-video-iframe");E.players.forEach(function(player){enable_touch_gestures(player,true);if(player.hola){player.hola.emit("persistent.start_floating");player.hola.disable_context_menu();player.saved_captions_track=player.hola.get_captions_track();player.hola.set_captions_track(-1)}});break;case"pv_end_floating":$("body").removeClass("floating-video-iframe");E.players.forEach(function(player){disable_touch_gestures(player);if(player.hola){player.hola.emit("persistent.end_floating");player.hola.enable_context_menu();player.hola.set_captions_track(player.saved_captions_track)}});break;case"pv_sync_size":E.players.forEach(function(player){sync_frame_size(player,data.persistent,{width:data.width,height:data.height})});break;case"pv_fix_ima_size":E.players.forEach(function(player){fix_ima_size(player)});break;case"pv_pause_player":E.players.forEach(function(player){player.pause()});break;case"pv_init_watermark":E.players.forEach(function(player){init_watermark(player)})}}function listen_toplevel(){log.debug_spark("listening for the top-level loader...");window.addEventListener("message",function(event){var msg=event.data;var master=E.master;if(!msg.hola_msg)return;log.debug_spark("received "+msg.hola_msg+" from "+event.origin);if(msg.hola_msg=="pv_hello"){if(E.toplevel_polling_int){clearInterval(E.toplevel_polling_int);E.toplevel_polling_int=undefined}if(!master){master=E.master={frame:event.source,origin:event.origin};if(E.wrapper)E.attach_wrapper(undefined,true);add_style_string(util.is_mobile?E.conf.params.mobile.css:E.conf.params.desktop.css,document);E.inited=true}}else proc_floating_msg(msg.hola_msg,msg.data)});window.addEventListener("unload",function(){E.msg.goodbye()});log.debug_spark("running in an iframe, trying to contact top-level "+"loader...");E.toplevel_polling_int=setInterval(function(){E.msg.hello()},1e3)}function wrap_player_api(cdn_player){return{is_playing:cdn_player.is_playing.bind(cdn_player),is_ad_playing:cdn_player.is_any_ad_mode.bind(cdn_player),get_video_url:cdn_player.get_url.bind(cdn_player),play:cdn_player.html5?cdn_player.html5.play.bind(cdn_player.html5):function(){},pause:cdn_player.pause.bind(cdn_player)}}function ignore_player(container){if(!E.conf.params.ignore_player_func)return false;try{var fn=new Function("container",E.conf.params.ignore_player_func);return fn(container)}catch(e){log.err("invalid ignore_player_func function: "+(e&&e.toString())||"JS Error")}}function get_player(player){var api=wrap_player_api(player);var dt=E.conf.params.dom_transform;if(typeof dt=="string"){try{var fn=new Function(dt);dt=fn()}catch(e){log.err("invalid dom_transform function: "+(e&&e.toString()||"JS Error"));dt=false}}var container=player.get_container();if(E.conf.params.container_js)container=E.conf.params.container_js($,container);else{var csel=E.conf.params.container_sel;if(csel){var c=$(csel);if(c.length)container=c[0];else{log.err("container selector "+csel+" match no element on the "+"page")}}}if(!container||ignore_player(container))return;var p=assign(api,{container:container,hola:player,dom_transform:dt&&document==_document});if(E.conf.params.infinite_scroll_aware){p.infinite_scroll={};p.infinite_scroll.enable_floating=false}if(E.master){player.on("state",function(){E.msg.player_state({is_playing:p.is_playing(),video_url:p.get_video_url(),media_size:player.get_media_size()})});p.state_upd_int=setInterval(function(){E.msg.player_state({is_ad_playing:p.is_ad_playing(),is_googima:detect_googima(p),media_size:player.get_media_size()})},500)}return p}function attach_video(video,opt){if(!video||!check_skip_video(video,opt))return;var p;if(video.get_container)p=get_player(video);if(p&&!E.conf.params.run_in_iframe&&window.top!=window&&!E.master&&window.frameElement){var win=window;while(window.top!=win.parent)win=win.parent;p.container=win.frameElement}if(!p)return;var found=false;for(var i=0;!found&&i<E.players.length;i++)found=E.players[i].container==p.container;if(found)return;E.players.push(p);E.msg.player_found({is_playing:p.is_playing(),is_ad_playing:p.is_ad_playing(),video_url:p.get_video_url(),is_googima:detect_googima(p)});log.debug_spark("attached to player id "+p.container.id);return p}function attach_slave_frame(src,state){var container;var frames=$("iframe").get();for(var i=0;!container&&i<frames.length;i++){if(frames[i].contentWindow===src.frame)container=frames[i]}if(E.conf.params.container_js)container=E.conf.params.container_js($,container);if(!container||get_existing_player(container)||ignore_player(container)){return}var p={container:container,is_playing:function(){return this.state.is_playing},is_ad_playing:function(){return this.state.is_ad_playing},get_video_url:function(){return this.state.video_url},play:function(){},pause:function(){send_hola_msg({frame:container.contentWindow},"pv_pause_player")},slave:src,state:{is_playing:!!state.is_playing,is_ad_playing:!!state.is_ad_playing},origin:src.origin};if(E.conf.params.infinite_scroll_aware){p.infinite_scroll={};p.infinite_scroll.enable_floating=false}E.players.push(p);log.debug_spark("attached to slave iframe id "+p.container.id)}function detach_slave_frame(src){for(var i=0;i<E.players.length;i++){var p=E.players[i];if(p.origin==src.origin){E.players.splice(i,1);log.debug_spark("detached from slave iframe id "+p.container.id);break}}}function find_player_by_frame(src){for(var i=0;i<E.players.length;i++){if(E.players[i].slave&&E.players[i].slave.frame===src.frame&&E.players[i].slave.origin==src.origin){return E.players[i]}}}function update_player_state(src,state){var p=find_player_by_frame(src);if(p)assign(p.state,state)}function process_player_touch(src,msg,data){var p=find_player_by_frame(src);if(!p)return;switch(msg){case"pv_touch_move":p.touch_fns.do_touchmove(data.translate_x);break;case"pv_touch_end":p.touch_fns.do_touchend(data.translate_x)}}function remove_player(player){close_video_control(player);if(player.state_upd_int)clearInterval(player.state_upd_int);if(player.dom_transform&&player.is_floating)$(player.holder).before(player.container);log.debug_spark("detached from player id "+player.container.id);E.players.splice(E.players.indexOf(player),1)}E.unattach_video=function(video){var i=checked_videos.indexOf(video);if(i>=0)checked_videos.splice(i,1);var p=get_existing_player(video.get_container());if(!p)return;if(p.is_floating){var np=remove_from_floating_list(p);update_baselines(np)}remove_player(p)};function get_existing_player(container){var player;for(var i=0;!player&&i<E.players.length;i++){if($(E.players[i].container)[0].contains(container))player=E.players[i]}return player}E.attach_wrapper=function(wrapper,force){if(!E.inited&&!force&&!E.master){if(!E.wrapper)E.wrapper=wrapper;return}var w=wrapper||E.wrapper;if(!w)return;E.wopt=zutil.get((w.zone||{}).conf,"player.persistent_video");function attach_player(){var p=attach_video(w.player,E.wopt);w.player.persistent_video=p}if(w.zone&&w.zone.conf&&w.zone.conf.player)attach_player();w.player.on("wrapper.zone_init",function(){var video=w.player;var player=get_existing_player(video.get_container());if(!player){E.unattach_video(video);attach_player()}else{player.alternates=player.alternates||[];player.alternates.push(wrap_player_api(video))}})};E.detach_wrapper=function(wrapper){E.unattach_video(wrapper.player)};function _on_fullscreen_change(p,full_el){if(p.is_floating){if(p.container==full_el){p.container.classList.remove("floating-video");$(p.container).removeAttr("style");if(is_touch)disable_touch_gestures(p)}else{p.container.classList.add("floating-video");if(is_touch)enable_touch_gestures(p)}}}function on_fullscreen_change(){var full_el=get_fullscreen_element();for(var i=0;i<E.players.length;i++)_on_fullscreen_change(E.players[i],full_el)}function listen_for_fake_players(){util.dom_listen(document,function(){var fp=util.dom_query_all("iframe[hola_spark_persistent]");for(var i=0;i<fp.length;i++){if(!get_existing_player(fp[i])){var p={container:fp[i],is_playing:function(){return true},is_ad_playing:function(){return false},get_video_url:function(){return""},play:function(){},pause:function(){},state:{}};E.players.push(p);log.debug_spark("forced to attach to iframe id "+p.container.id)}}})}function setup_msg_handlers(){E.msg.add_handler("hello",function(src){if(!E.slaves.includes(src.origin)){E.slaves.push(src.origin);send_hola_msg(src,"pv_hello")}});E.msg.add_handler("player_found",function(data,src){attach_slave_frame(src,data)});E.msg.add_handler("player_state",function(data,src){update_player_state(src,data)});E.msg.add_handler("touch_move",function(data,src){process_player_touch(src,"pv_touch_move",data)});E.msg.add_handler("touch_end",function(data,src){process_player_touch(src,"pv_touch_end",data)});E.msg.add_handler("goodbye",function(src){var i=E.slaves.indexOf(src.origin);if(i>=0){E.slaves.splice(i,1);detach_slave_frame({origin:src.origin})}})}E.init=function(spark){E.spark=spark;log=E.spark.log(id);E.conf=zutil.defaults_deep(E.spark.conf.persistent,E.default_conf);E.stats_inc=function(s,v){spark.stats.inc(id+"_"+s,v)};E.watermark=watermark(assign({customer:E.spark.customer,module:"persistent_video",delay:function(duration,pos){return duration-pos-Math.min(duration/2,30)}},E.conf.watermark));E.msg=new E.spark.Msg("pv",{cross_domain_master_only:true});setup_msg_handlers();E.spark.on_wrapper_attached(E.attach_wrapper);E.spark.on_wrapper_detached(E.detach_wrapper);E.spark.players.forEach(function(p){E.attach_wrapper(p.wrapper)});if(/hola_ad_non_persistent/.test(window.location))E.conf.params.ad_persistent=false;if(E.conf.params.run_in_iframe){_window=window;_document=window.document}if(!generate_styles()){listen_toplevel();return}if(window.top!=window){add_style_string(util.is_mobile?E.conf.params.mobile.css:E.conf.params.desktop.css,document);window.addEventListener("message",function(event){var msg=event.data;if(!msg.hola_msg)return;proc_floating_msg(msg.hola_msg,msg.data)})}E.animation=add_style_string("");function is_playing(player){
var alts=player.alternates||[];var playing=E.conf.params.ad_persistent?player.is_playing()||player.is_ad_playing():player.is_playing()&&!player.is_ad_playing();for(var i=0;!playing&&i<alts.length;i++){playing=E.conf.params.ad_persistent?playing||alts[i].is_playing()||alts[i].is_ad_playing():(playing||alts[i].is_playing())&&!alts[i].is_ad_playing()}return playing}function is_video_allowed(player){if(player.infinite_scroll&&player.infinite_scroll.href!=window.location.href){return false}var f=E.conf.video_url;var alts=player.alternates||[];if(!alts.length||player.is_playing())return E.spark.check_url(player.get_video_url(),f);for(var i=0;i<alts.length;i++){if(alts[i].is_playing())return E.spark.check_url(alts[i].get_video_url(),f)}return E.spark.check_url(player.get_video_url(),f)}if(is_touch){_document.addEventListener("fullscreenchange",on_fullscreen_change);_document.addEventListener("mozfullscreenchange",on_fullscreen_change);_document.addEventListener("MSFullscreenChange",on_fullscreen_change);_document.addEventListener("webkitfullscreenchange",on_fullscreen_change)}_window.addEventListener("scroll",function(){var full_el=get_fullscreen_element();for(var i=0,p;i<E.players.length;i++){p=E.players[i];if(p.is_animating)continue;if(p.infinite_scroll&&!p.infinite_scroll.enable_floating){if(p.container!=full_el&&is_visible_by_y(p.holder?p.holder:p.container)){p.infinite_scroll.enable_floating=true;p.infinite_scroll.href=window.location.href}}if(p.is_floating){if(p.container!=full_el&&is_visible_by_y(p.holder)||!is_video_allowed(p)){end_floating(p)}}else{if(!is_visible_by_y(p.container)&&(is_playing(p)||E.conf.paused)&&is_video_allowed(p)){start_floating(p)}}}},true);_window.addEventListener("orientationchange",function(){for(var i=0,p;i<E.players.length;i++){p=E.players[i];if(p.is_floating){log.debug_spark("player id "+p.container.id+": orientation change, recalc position");p.width=calculate_width(p);init_floating_position(p)}}});_window.addEventListener("resize",function(){var full_el=get_fullscreen_element();for(var i=0,p;i<E.players.length;i++){p=E.players[i];_on_fullscreen_change(p,full_el);if(p.is_floating){log.debug_spark("player id "+p.container.id+": resize, recalc position");p.width=calculate_width(p);init_floating_position(p,p.height)}}});listen_for_fake_players();yt_embed.start({dom_listen:true});yt_embed.on("player_init",function(e){if(e.player)attach_video(e.player.iframe,{yt:e.player})});E.inited=true;log.debug_spark("inited")};return E});
define("/svc/cdn/pub/thumbnails.js",["/svc/cdn/pub/log.js","cash","/svc/cdn/pub/util.js","/util/util.js","/util/etask.js","/util/url.js","/util/escape.js","/util/storage.js","/util/sprintf.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/watermark.js"],function(_log,$,util,zutil,etask,zurl,zescape,storage,sprintf,cdnlist,watermark){var E={};var assign=Object.assign;var id="thumbnails",log=_log.set_module(id);function Vtimeline(player,opt){this.strip_url="//player.h-cdn.com/svc/cdn/pub/img/"+"thumbnails_cinema_roll.svg";this.strip_pad_percent=21;this.hor_margin_px=3;this.shown=false;this.thumbs_count=E.conf.params.vt_thumbs_count||10;this.listeners=[];this.player=player;this.container=this.get_container();if(!this.container.length)return;this.controlbar=this.get_control_bar();if(!this.controlbar.length)return;this.seekbar=this.get_progress_bar();if(!this.seekbar.length)return;this.seek=this.get_seek_fn();this.opt=opt;this.check_reqs_timeout=0;var s=this.opt["0"].sprites;this.ratio=s.height/s.width;this.thumbs_width=s.width;this.thumbs_interval=s.interval;this.thumbs_per_img=s.count;this.adjust();this.bind_events();this.last_move=0;log.notice("visual timeline inited",opt)}Vtimeline.prototype.get_container=function(){if(E.conf.params.abs_container)return $(E.conf.params.abs_container);var container=this.player.get_container();if(E.conf.params.container)return $(container).closest(E.conf.params.container);if(this.player.flowplayer)return $(container).closest(".flowplayer");return $(container)};Vtimeline.prototype.get_control_bar=function(){if(E.conf.params.control_bar)return this.container.find(E.conf.params.control_bar);if(this.player.vjs)return this.container.find(".vjs-control-bar");if(this.player.jwplayer)return this.container.find(".jw-controlbar");if(this.player.flowplayer)return this.container.find(".fp-controls");log.err("visual timeline - no control bar")};Vtimeline.prototype.get_progress_bar=function(){if(E.conf.params.progress_bar)return this.controlbar.find(E.conf.params.progress_bar);if(this.player.jwplayer)return this.container.find(".jw-slider-time.jw-slider-horizontal");if(this.player.vjs)return this.container.find(".vjs-progress-control");if(this.player.flowplayer)return this.container.find(".fp-timeline");log.err("visual timeline - no progress bar")};Vtimeline.prototype.get_seek_fn=function(){var _this=this;if(this.player.jwplayer)return function(pos){_this.player.jwplayer.seek(pos)};if(this.player.vjs)return function(pos){_this.player.vjs.currentTime(pos)};if(this.player.flowplayer)return function(pos){_this.player.flowplayer.seek(pos)};if(this.player.html5)return function(pos){_this.player.html5.currentTime=pos}};Vtimeline.prototype.make_list=function(){var duration=this.player.get_duration(),count=0;var dint=duration/this.max_count;var i=dint/2;this.thumb_list=[];if(!i)return;while(count++<this.max_count){var raw_idx=Math.floor(i/this.thumbs_interval);var idx=raw_idx%this.thumbs_per_img;var active=Math.floor(i/(this.thumbs_per_img*this.thumbs_interval));var setting=this.opt[active*this.thumbs_per_img*this.thumbs_interval];var img_x=idx%setting.sprites.rows*setting.sprites.width;var img_y=Math.floor(idx/setting.sprites.rows)*setting.sprites.height;this.thumb_list.push({"background-image":'url("'+setting.src+'")',"background-position":"-"+img_x/setting.sprites.width*100+"% -"+img_y/setting.sprites.height*100+"%",pos:raw_idx*this.thumbs_interval});i+=dint}};Vtimeline.prototype.bind_events=function(){this._subscribe(this.container,"mousemove",this.show.bind(this));this._subscribe(this.container,"mouseleave",this.hide.bind(this));var _this=this;function check_reqs(){var c=_this.controlbar;if(c.css("display")=="none"||c.css("opacity")=="0"||c.css("visibility")=="hidden"){if(Date.now()-_this.last_move>3e3)_this.hide()}if(_this.seekbar.width()!=_this.seekbar_width||_this.player.get_duration()!=_this.video_duration){_this.adjust()}_this.check_reqs_timeout=setTimeout(check_reqs,500)}check_reqs()};Vtimeline.prototype.adjust=function(){this.video_duration=this.player.get_duration();this.seekbar_width=this.seekbar.width();this.max_count=Math.min(Math.floor(this.seekbar.width()/75),this.thumbs_count);this.make_list();this.render();if(this.shown){this.shown=false;this.show()}};Vtimeline.prototype._subscribe=function(elem,name,fn){$(elem).on(name,fn);this.listeners.push({elem:elem,name:name,fn:fn})};Vtimeline.prototype.detach=function(){this.hide();this.listeners.forEach(function(l){$(l.elem).off(l.name,l.fn)});this.listeners=[];if(this.tlwrap)$(this.tlwrap).remove();if(this.check_reqs_timeout)this.check_reqs_timeout=window.clearTimeout(this.check_reqs_timeout)};function pad(num,size){return("000"+num).slice(-size)}function format_sec(sec){sec=Math.round(sec);var s=sec%60;var min=Math.floor(sec%3600/60);var hour=Math.floor(sec/3600);return(hour?pad(hour,2)+":":"")+pad(min,2)+":"+pad(s,2)+".000"}Vtimeline.prototype.format_time=function(sec){return format_sec(sec).slice(0,-4)};Vtimeline.prototype.render=function(){var _this=this;if(this.tl){$(this.tl).find("div").get().forEach(function(elem){_this.listeners=_this.listeners.filter(function(ev){if(ev.elem==elem)$(elem).off(ev.name,ev.fn);return ev.elem!=elem})});$(this.tlwrap).remove()}var tlwrap=document.createElement("div");$(tlwrap).addClass("hola_visual_timeline_holder");$(tlwrap).css({opacity:0,"background-image":"url("+this.strip_url+")","background-repeat":"no-repeat","background-size":"cover",position:"absolute",bottom:0,left:0,width:"100%"});var tl=document.createElement("div");$(tl).css({display:"flex",position:"absolute",height:100-this.strip_pad_percent*2+"%",top:this.strip_pad_percent+"%"});this.thumb_list.forEach(function(item){var elem=document.createElement("div");$(elem).css({margin:"0 "+_this.hor_margin_px+"px",display:"block",cursor:"pointer","justify-content":"flex-start","flex-basis":100/_this.max_count+"%","background-image":item["background-image"],"background-position":item["background-position"],"background-size":"500% 500%","pointer-events":"auto"});$(elem).attr("data-hola-vt-tooltip",_this.format_time(item.pos));_this._subscribe(elem,"click",function(){log.notice("seek to "+item.pos);_this.seek(item.pos)});$(tl).append(elem)});tlwrap.appendChild(tl);this.controlbar.after(tlwrap);this.tl=tl;this.tlwrap=tlwrap};Vtimeline.prototype.show=function(){var _this=this;if(Date.now()-this.last_move>200)setTimeout(function(){_this.controlbar.trigger("mousemove")},0);this.last_move=Date.now();if(is_player_floating(this.player)){this.hide();return}if(this.shown)return;this.shown=true;log.notice("show viewer");var w=this.seekbar.width()/this.max_count-this.hor_margin_px*2;var h=w*this.ratio;log.notice("w, h",w,h);var dt=100*h/(100-this.strip_pad_percent*2);log.notice("dt",dt);if(E.conf.params.translate_control_bar)this.controlbar.css({transform:"translateY(-"+dt+"px)"});else this.controlbar.css({bottom:dt+"px",position:"absolute"});var left=this.seekbar.offset().left-this.controlbar.offset().left;$(this.tlwrap).css({opacity:1,height:dt+"px"});$(this.tl).css({left:left+"px",width:this.seekbar.width()+"px"})};Vtimeline.prototype.hide=function(){if(!this.shown)return;this.shown=false;log.notice("hide viewer");$(this.tlwrap).css("opacity",0);if(E.conf.params.translate_control_bar)this.controlbar.css({transform:"translateY(0px)"});else this.controlbar.css({bottom:"0px",position:"absolute"})};function Viewer(player,thumbs){this.listeners=[];this.player=player;this.container=this.get_container();if(!this.container||!this.container.length)return log.err("invalid container selector");this.control_bar=this.get_control_bar(player);if(!this.control_bar||!this.control_bar.length)return log.err("invalid control_bar selector");this.progress_bar_sel=this.get_progress_bar_sel();if(!this.progress_bar_sel)return log.err("invalid progress_bar selector");this.control_bar.addClass("hola_thumb_progress_control");this.thumbs=thumbs;this.thumbs_interval=thumbs[0].sprites.interval;this.thumbs_per_img=this.thumbs_interval*thumbs[0].sprites.count;this.size={width:thumbs[0].sprites.width,height:thumbs[0].sprites.height};if(E.conf.params.full_frame_thumbnails)this.init_drag();this.div=document.createElement("div");this.div.style.display="none";this.div.className="hola_thumb_holder";this.img=document.createElement("div");this.div.appendChild(this.img);this.img.className="hola_thumb_thumbnail";var css={width:this.size.width+"px",height:this.size.height+"px","background-image":'url("'+thumbs[0].src+'")'};var colors=E.conf.params.colors;if(colors)assign(css,{"border-color":colors.bg,color:colors.text});assign(this.img.style,css);this.video_offset=E.conf.params.get_video_offset?E.conf.params.get_video_offset(window)||0:0;this.control_padding=this.get_control_padding();this.control_bar.append(this.div);this.thumb_elem=$(this.img);this.add_styles();this.subscribe(this.control_bar,this.progress_bar_sel,"mousemove",this.on_move.bind(this),true);this.subscribe(this.control_bar,this.progress_bar_sel,"mouseout",this.move_cancel.bind(this),true)}Viewer.prototype.init_drag=function(){var progress_bar=this.get_progress_bar();this.drag_div=document.createElement("div");this.drag_div.style.display="none";this.drag_div.className="hola_thumb_fullscreen";this.drag_img=document.createElement("div");this.drag_div.appendChild(this.drag_img);this.drag_img.style.width=this.size.width+"px";this.drag_img.style.height=this.size.height+"px";this.drag_handler=document.createElement("div");this.drag_handler.className="hola_thumb_drag_handler";progress_bar.append(this.drag_handler);$(this.drag_div).insertAfter(this.player.html5);this.subscribe(this.drag_handler,null,["mousedown","touchstart"],this.drag_start.bind(this));this.subscribe(window,null,["mouseup","touchend","touchcancel"],this.drag_end.bind(this));this.subscribe(document.body,null,["mousemove","touchmove"],this.on_drag.bind(this))};Viewer.prototype.drag_start=function(event){var _this=this;if(this.player.is_any_ad_mode())return;event.stopPropagation();this.dragging=true;this.control_bar.addClass("fake_active");this.was_playing_before_drag=this.player.is_playing();this.player.pause();setTimeout(function(){_this.on_drag(event)})};Viewer.prototype.on_drag=function(event){if(!this.dragging||this.player.is_any_ad_mode())return;this.update_drag_image(event);this.update_play_progress(this.get_mouse_progress(event));this.drag_div.style.display="block";this.on_move(event)};Viewer.prototype.drag_end=function(event){var _this=this;if(!this.dragging)return;this.drag_div.style.display="block";this.update_drag_image(event);this.seek(this.get_mouse_time(event));if(this.was_playing_before_drag)this.player.play();this.dragging=false;this.control_bar.removeClass("fake_active");this.player.once("seeked",function(){_this.drag_div.style.display="none"});this.move_cancel()};Viewer.prototype.seek=function(pos){var _this=this;if(this.player.jwplayer)return void _this.player.jwplayer.seek(pos);if(this.player.vjs)return void _this.player.vjs.currentTime(pos);if(this.player.flowplayer)return void _this.player.flowplayer.seek(pos);if(this.player.html5)return void(_this.player.html5.currentTime=pos)};Viewer.prototype.is_over_thumb_elem=function(event){var offset=this.thumb_elem.offset(),l=offset.left,t=offset.top;var h=this.thumb_elem.height(),w=this.thumb_elem.width();var page_x=event.changedTouches?event.changedTouches[0].pageX:event.pageX;var page_y=event.changedTouches?event.changedTouches[0].pageY:event.pageY;return page_y<=t+h&&page_y>=t&&page_x<=l+w&&page_x>=l};Viewer.prototype.get_container=function(){if(E.conf.params.abs_container)return $(E.conf.params.abs_container);var container=this.player.get_container();if(E.conf.params.container)return $(container).closest(E.conf.params.container);if(this.player.flowplayer)return $(container).closest(".flowplayer");return $(container)};Viewer.prototype.get_control_bar=function(){if(E.conf.params.control_bar)return this.container.find(E.conf.params.control_bar);if(this.player.vjs)return this.container.find(".vjs-control-bar");if(this.player.jwplayer)return this.container.find(".jw-controlbar");if(this.player.flowplayer)return this.container.find(".fp-controls")};Viewer.prototype.get_progress_bar_sel=function(){if(E.conf.params.progress_bar)return E.conf.params.progress_bar;if(this.player.vjs)return".vjs-progress-control";if(this.player.jwplayer)return".jw-controlbar-center-group";if(this.player.flowplayer)return".fp-timeline"};Viewer.prototype.update_play_progress=function(progress){var sel;if(E.conf.params.play_progress)sel=E.conf.params.play_progress;else if(this.player.vjs)sel=".vjs-play-progress, .vjs-slider-bar";this.container.find(sel).css("width",progress*100+"%")};Viewer.prototype.get_progress_bar=function(){if(this.progress_bar&&this.progress_bar.length)return this.progress_bar;return this.control_bar.find(this.progress_bar_sel)};Viewer.prototype.is_node_detached=function(){return this.div&&!document.body.contains(this.div)};Viewer.prototype.is_fullscreen_mode=function(){var fullscreen_sel;if(E.conf.params.fullscreen_sel)fullscreen_sel=E.conf.params.fullscreen_sel;else if(this.player.vjs)fullscreen_sel=".vjs-fullscreen";else if(this.player.jwplayer)fullscreen_sel=".jw-flag-fullscreen";else if(this.player.flowplayer)fullscreen_sel=".is-fullscreen";return fullscreen_sel&&(this.container.is(fullscreen_sel)||this.container.find(fullscreen_sel).length)};Viewer.prototype.get_control_padding=function(){if(E.conf.params.control_padding)return E.conf.params.control_padding;if(this.player.name=="hola")return 2;if(this.player.vjs)return 7;if(this.player.jwplayer)return 4;if(this.player.flowplayer)return 4};Viewer.prototype.get_mouse_progress=function(event){var progress_bar=this.get_progress_bar();var page_x=event.changedTouches?event.changedTouches[0].pageX:event.pageX;var parent_offset=progress_bar.offset().left;var progress=page_x-parent_offset;var width=progress_bar.width();if(this.control_padding){progress-=this.control_padding;width-=this.control_padding*2}return Math.max(0,Math.min(1,progress/width))};Viewer.prototype.get_mouse_time=function(event){var progress=this.get_mouse_progress(event);var duration=this.player.get_duration();return Math.floor(progress*duration)+this.video_offset};Viewer.prototype.update_drag_image=function(event){var mouse_time=this.get_mouse_time(event);var idx=Math.floor(mouse_time%this.thumbs_per_img/this.thumbs_interval);var active=Math.floor(mouse_time/this.thumbs_per_img);var setting=this.thumbs[this.thumbs_per_img*active];if(!setting)return;var img_x=idx%5*setting.sprites.width;var img_y=Math.floor(idx/5)*setting.sprites.height;assign(this.drag_img.style,{"background-image":'url("'+setting.src+'")',"background-position":"-"+img_x+"px -"+img_y+"px","transform-origin":"top left",opacity:"0.7"});this.drag_img.style.transform="scale("+this.container.height()/this.size.height+")"};Viewer.prototype.add_styles=function(){var styles=[],container=this.container;if(this.player.name=="hola"){styles=[{selector:".hola_thumb_thumbnail",property:"bottom",value:"3.5em"},{selector:".vjs-mouse-display-tooltip",property:"display",value:"none"},{selector:".vjs-loading-spinner",property:"z-index",value:"1"}]}else if(this.player.vjs){styles=[{selector:".vjs-mouse-display",property:"display",value:"none"},{selector:".vjs-control-bar",property:"z-index",value:"2"},{selector:".vjs-control-bar.fake_active .vjs-slider-bar:after",property:"display",value:"none"}]}else if(this.player.jwplayer){styles=[{selector:".jw-tooltip-time",property:"display",value:"none"},{selector:".jw-controls",property:"z-index",value:"2"},{selector:".jw-controlbar-center-group",property:"position",value:"relative"}]}else if(this.player.flowplayer){styles=[{selector:".fp-timestamp",property:"display",value:"none"}]}if(E.conf.params.styles)styles=styles.concat(E.conf.params.styles);var style=styles.map(function(s){var parent=container;if(s.parent_selector)parent=container.closest(s.parent_selector);parent.find(s.selector).css(s.property,s.value);return sprintf("%s %s {%s: %s !important;}",s.parent_selector||E.conf.params.abs_container||E.conf.params.container||"",s.selector,s.property,s.value)}).join("\n");if(E.style_injected[style])return;var style_el=document.createElement("style");style_el.textContent=style;document.head.appendChild(style_el);E.style_injected[style]=true};Viewer.prototype.subscribe=function(elem,sel,name,fn,use_capture){if(elem instanceof $)elem=elem[0];if(!elem||!Element.prototype.matches)return;var _this=this;var _fn=function(ev){if(!sel||ev.target.matches(sel+", "+sel+" *"))fn(ev)};var names=Array.isArray(name)?name:[name];names.forEach(function(name){elem.addEventListener(name,_fn,use_capture);_this.listeners.push({elem:elem,name:name,fn:_fn})})};Viewer.prototype.detach=function(){this.listeners.forEach(function(l){if(l.elem)l.elem.removeEventListener(l.name,l.fn)});this.listeners=[];$(this.img).remove();$(this.div).remove();$(this.drag_handler).remove();$(this.drag_img).remove();$(this.drag_div).remove();$(this.control_bar).removeClass("hola_thumb_progress_control")};Viewer.prototype.format_time=function(sec){return format_sec(sec).slice(0,-4)};Viewer.prototype.move_cancel=function(event){if(this.dragging)return;if(event&&this.is_over_thumb_elem(event))return;this.div.style.display="none";if(this.hide_watermark)this.hide_watermark()};Viewer.prototype.on_move=function(event){if(this.player.is_any_ad_mode())return void this.move_cancel();var page_x=event.changedTouches?event.changedTouches[0].pageX:event.pageX;var progress_bar=this.get_progress_bar();var parent_offset=progress_bar.offset().left;var progress=page_x-parent_offset;if(this.control_padding)progress-=this.control_padding;var mouse_time=this.get_mouse_time(event);var active=Math.floor(mouse_time/this.thumbs_per_img);var setting=this.thumbs[this.thumbs_per_img*active];if(!setting)return;var idx=Math.floor(mouse_time%this.thumbs_per_img/this.thumbs_interval);var img_x=idx%5*setting.sprites.width;var img_y=Math.floor(idx/5)*setting.sprites.height;assign(this.img.style,{"background-image":'url("'+setting.src+'")',"background-position":"-"+img_x+"px -"+img_y+"px","transform-origin":"bottom",transform:this.is_fullscreen_mode()?"scale(1.5, 1.5)":"none"});var progress_bar_offset=parent_offset-this.control_bar.offset().left;var left_pos=progress-setting.sprites.width/2+progress_bar_offset;this.div.style.left=left_pos+"px";this.div.style.bottom=progress_bar.height()+"px";this.div.style.display="block";if(this.show_watermark)this.show_watermark();var container_pos=$(this.container).offset();var img_pos=$(this.img).offset();if(img_pos.left<container_pos.left)this.div.style.left=left_pos+(container_pos.left-img_pos.left)+"px";if(img_pos.left+$(this.img).width()>container_pos.left+$(this.container).width()){this.div.style.left=left_pos+(container_pos.left+$(this.container).width()-img_pos.left-$(this.img).width())+"px"}$(this.img).attr("data-content",this.format_time(mouse_time-this.video_offset))};function load_css(){if(E.css_added)return;E.css_added=1;var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href="//player.h-cdn.com/svc/cdn/pub/css/thumbnails.css";document.getElementsByTagName("head")[0].appendChild(link)}function get_thumb_url(cdn,url){var cdn_host=util.protocol=="https:"?cdn.hostname:cdn.host;return util.protocol+"//"+cdn_host+url}function is_player_floating(p){return zutil.get(p,"persistent_video.is_floating")}var Thumbnails=function(player){this.player=player};Thumbnails.prototype.inc_stats=function(s){E.spark.stats.inc(id+"_"+s)};Thumbnails.prototype.attach=function(bws){var player=this.player;if(!player)return this.inc_stats("undefined_player");this.method=player.get_video_type_name();this.adaptive=bws&&bws.adaptive||!bws&&util.is_adaptive(this.method);this.video_url=util.absolute_uri(player.get_url());if(!this.is_video_supported())return this.inc_stats("unsupported_video");var _this=this;return this.loading_task=etask({name:"init_thumbnails"},[function(){_this.route=_this.get_route();_this.inc_stats("fetch_try_n");return E.spark.fetch_from_fastest("get_thumb_info",_this.route,{cdnlist:E.conf.cdns||E.conf.cdn,zone:player.zone,on_req:function(n){_this.inc_stats("req_try_n");_this.inc_stats("req_try_"+(n+1)+"_n")},on_res:function(n,data){if(data.res&&data.res.info){_this.inc_stats("req_success_n");_this.inc_stats("req_success_"+(n+1)+"_n")}else{_this.inc_stats("req_fail_n");_this.inc_stats("req_fail_"+(n+1)+"_n");if(data.err){if(/^\w+$/.test(data.err))_this.inc_stats("req_fail_"+data.err+"_n");else _this.inc_stats("req_fail_error_n")}else _this.inc_stats("req_fail_processing_n")}}})},function(data){if(!data||!data.res||!data.res.info||!data.res.chunks)return _this.inc_stats("fetch_fail_n");var info=data.res.info;var urls=data.res.urls;var groups=Object.keys(data.res.chunks);var rows=Math.sqrt(info.group_size);if(!urls)return _this.inc_stats("fetch_undefined_urls");_this.inc_stats("fetch_success_n");if(!urls)_this.inc_stats("fetch_undefined_urls");_this.thumbs={};groups.forEach(function(id){_this.thumbs[(id-1)*info.group_size*info.interval]={src:get_thumb_url(data.cdn,urls[id]),sprites:{width:info.width,height:info.height,interval:info.interval,count:info.group_size,rows:rows}}});_this.attached=true;if(is_player_floating(player))return;_this.view_thumbnails()},function catch$(e){log.err("error during fetch thumbs:",e)}])};Thumbnails.prototype.detach=function(){if(this.loading_task)this.loading_task.return();this.hide();if(this.vtimeline)this.vtimeline.detach()};Thumbnails.prototype.show=function(){if(!this.viewer&&this.thumbs)return this.view_thumbnails()};Thumbnails.prototype.hide=function(){var player=this.player;if(!E.conf.params.full_frame_thumbnails&&player&&player.name=="hola")return player.vjs.thumbnails({});if(!this.viewer)return;this.viewer.detach();this.viewer=null;if(this.vtimeline){this.vtimeline.detach();this.vtimeline=null}if(this.watermark){$(this.watermark.pic).parent().remove();clearTimeout(this.watermark.defer)}delete this.watermark};Thumbnails.prototype.is_video_supported=function(){return this.video_url&&!this.player.is_live_stream()&&(!this.adaptive||this.method=="hls"||this.method=="dash")};Thumbnails.prototype.view_thumbnails=function(){var player=this.player,thumbs=this.thumbs;if(!E.conf.params.full_frame_thumbnails&&player.name=="hola"&&player.vjs.thumbnails){player.vjs.thumbnails(zutil.clone_deep(thumbs))}else{load_css();this.viewer=new Viewer(player,thumbs)}if(E.conf.params.visual_timeline)this.vtimeline=new Vtimeline(player,thumbs);this.add_watermark()};Thumbnails.prototype.add_watermark=function(){if(this.watermark!==undefined)return;this.watermark=watermark(assign({customer:E.spark.customer,module:id,hint_text:"Thumbnails powered by Hola Spark",corner:"top-left",delay:function(duration,pos){return 1e6}},E.conf.watermark));var container=this.viewer?this.viewer.get_container()[0]:this.player.get_container&&this.player.get_container();if(!this.watermark||!container)return this.watermark=null;this.watermark.apply({v:this.player,container:container});var set_watermark_visible,_this=this,visible=true;(set_watermark_visible=function(v){if(!_this.watermark)return;if(v&&_this.watermark.defer)_this.watermark.defer=clearTimeout(_this.watermark.defer);if(visible==v)return;if(v&&(visible=v)){$(_this.watermark.pic).css("opacity","");return $(_this.watermark.pic).removeClass("hola_hidden")}_this.watermark.defer=setTimeout(function(){if(!_this.watermark)return;$(_this.watermark.pic).css("opacity","0");visible=v;var duration=0;var property=$(_this.watermark.pic).css("transition-property");property=(property||"").split(" ");var idx=Math.max(property.lastIndexOf("opacity"),property.lastIndexOf("all"));if(idx>=0){duration=$(_this.watermark.pic).css("transition-duration");duration=(duration||"").split(" ");duration=parseFloat(duration[idx%duration.length]||"0")*1e3}_this.watermark.defer=setTimeout(function(){if(!_this.watermark)return;$(_this.watermark.pic).addClass("hola_hidden");$(_this.watermark.pic).css("opacity","");_this.watermark.defer=0},duration)},zutil.get(E.conf,"watermark_delay",2e3))}).call(this,false);var hide_watermark=set_watermark_visible.bind(null,false);var show_watermark=set_watermark_visible.bind(null,true);$(_this.watermark.pic).on("mouseenter",show_watermark);$(_this.watermark.pic).on("mouseleave",hide_watermark);if(this.viewer){this.viewer.hide_watermark=hide_watermark;this.viewer.show_watermark=show_watermark;return}this.player.vjs.on("userinactive",hide_watermark);var control=this.player.vjs.controlBar.progressControl;control.on("mouseout",hide_watermark);control.on("touchcancel",hide_watermark);control.on("touchend",hide_watermark);control.on("mousemove",show_watermark);control.on("touchmove",show_watermark)};Thumbnails.prototype.get_route=function(){var route={url:this.video_url,zone:this.player.zone.name,customer:E.spark.customer};if(E.spark.force_enable(id))route.ext=1;if(this.adaptive)route.manifest=this.video_url;return route};Thumbnails.prototype.check_attached=function(){if(this.viewer&&this.viewer.is_node_detached()){log.notice("reattach");var is_vtimeline_shown=this.vtimeline&&this.vtimeline.shown;this.hide();this.show();if(is_vtimeline_shown)this.vtimeline.show()}};E.on_player_attach=function(player,ctx,reason){var controls=player.controls,thumbnails=ctx.attached_thumbnails;if(!thumbnails){thumbnails=ctx.attached_thumbnails=new Thumbnails(controls);thumbnails.attach(ctx.attached_bws);thumbnails.on_float=thumbnails.hide.bind(thumbnails);thumbnails.on_float_end=thumbnails.show.bind(thumbnails);thumbnails.check_attached=thumbnails.check_attached.bind(thumbnails)}else if(reason=="restore"){if(!is_player_floating(controls))thumbnails.show()}controls.on("persistent.start_floating",thumbnails.on_float);controls.on("persistent.end_floating",thumbnails.on_float_end);controls.on("play",thumbnails.check_attached);controls.on("pause",thumbnails.check_attached);player.once("detach",function(ctx,reason){controls.off("persistent.start_floating",thumbnails.on_float);controls.off("persistent.end_floating",thumbnails.on_float_end);controls.off("play",thumbnails.check_attached);controls.off("pause",thumbnails.check_attached);if(reason=="suspend")return thumbnails.hide();thumbnails.detach();ctx.attached_thumbnails=undefined})};E.default_conf={params:{}};E.style_injected={};E.init=function(spark){E.spark=spark;E.conf=zutil.defaults_deep(E.spark.conf[id],E.default_conf);if(/full_frame_thumbnails/.test(window.location.href))E.conf.params.full_frame_thumbnails=1;E.spark.players.on("attach",E.on_player_attach);E.inited=true;log.notice("inited")};return E});
define("/svc/cdn/pub/preview.js",["cash","/svc/cdn/pub/util.js","/util/util.js","/util/url.js","/util/escape.js","/svc/cdn/pub/cdnlist.js","/util/etask.js","/svc/cdn/pub/log.js","/util/array.js","/util/events.js","/svc/cdn/pub/watermark.js","/util/date.js","/util/storage.js","/util/sprintf.js"],function($,util,zutil,zurl,zescape,cdnlist,etask,_log,array,events,watermark,date,storage,sprintf){var E=new util.events,assign=Object.assign;var perr=util.cdn_perr,log=_log.set_module("preview");var previews=[],previews_map={},uniq_id=0;var def_opt={line_loader:2,logo_loader_opacity:"0.6",autoplay:{},fade_time:500};var def_styles={".hola_preview_debug":{"pointer-events":"none",position:"absolute",display:"block",border:"2px dashed #f00","z-index":"2147483647",padding:"10px","box-sizing":"border-box"},".hola_preview_debug span":{color:"#fff",background:"rgba(0,0,0,0.5)",display:"inline-block",padding:"4px 2px",font:"bold 13px/13px Tahoma"},".hola_preview_debug.no_video":{"border-style":"solid"},".hola_preview_debug.has_video":{"border-style":"solid","border-color":"#ff0"},".hola_preview_debug.active":{"border-color":"#0f0"},".hola_preview_ext_info":{"pointer-events":"none",position:"absolute",display:"block","box-sizing":"border-box",background:"rgba(50,50,50,0.7)",color:"#f0f0f0",padding:"4px",font:"bold 14px/14px Tahoma"},".hola_preview_ext_info.has_video_ready":{display:"none"},".hola_preview_ext_info div":{"text-align":"center","pointer-events":"auto","padding-right":"30px"},".hola_preview_ext_info .title":{"font-size":"1.25em"},".hola_preview_viewport_debug":{border:"1px dashed #00f",background:"rgba(200,200,255,0.4)"},".hola_preview_container":{margin:"0",padding:"0",border:"0",position:"absolute","z-index":"auto",overflow:"hidden"},".hola_preview_background":{position:"absolute",top:"0",left:"0","object-fit":"cover"},".hola_preview_popup":{"border-width":"2px","border-style":"solid","border-color":"#ff0000","background-color":"#000000","box-sizing":"content-box","z-index":"2147483647",transition:"opacity .3s ease-in-out",opacity:"0"},".hola_preview_text_link_popup":{padding:"2px","border-color":"#888","background-color":"#eee",overflow:"visible"},".hola_preview_text_link_popup>a":{display:"block",position:"relative",width:"100%",height:"100%",overflow:"hidden"},".hola_preview_text_link_popup .hola_video_preview":{visibility:"visible"},".hola_popup_arrow, .hola_popup_arrow_border":{position:"absolute",width:"0",height:"0",top:"100%","border-style":"solid",transform:"skewX(30deg)"},".hola_popup_arrow":{left:"35px","border-color":"#eee transparent transparent transparent","border-width":"20px 0 0 50px"},".hola_popup_arrow_border":{left:"31px","border-color":"#888 transparent transparent transparent","border-width":"22px 0 0 56px"},".hola_preview_popup_visible":{opacity:"1"},".hola_preview_popup .hola_preview_poster":{width:"100%",height:"100%"},".hola_preview_title":{position:"absolute",width:"100%","line-height":"24px",bottom:"0","padding-left":"5px",overflow:"hidden","font-size":"14px","font-family":"Lato, Helvetica, Verdana","white-space":"nowrap","text-overflow":"ellipsis",color:"#ffffff","background-color":"rgba(0, 0, 0, 0.7)"},".hola_preview_playing .hola_preview_poster":{visibility:"hidden"},".hola_preview_playing .hola_video_preview":{visibility:"visible"},".hola_preview_poster":{top:"0",left:"0","max-width":"inherit !important","max-height":"inherit !important",margin:"0 !important",position:"absolute",transition:"transform 0.3s ease-in-out"},".hola_video_preview":{top:"0",left:"0",position:"absolute",visibility:"hidden","object-fit":"cover",opacity:"1",transition:"opacity 0.3s ease-in-out"},".hola_video_preview.hola_fade_out":{opacity:"0"},".hola_preview_img":{visibility:"hidden"},".hola_preroll":{"background-size":"contain","background-position":"50% 50%","background-repeat":"no-repeat","background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)","pointer-events":"none",position:"absolute",transition:"width, height, left, top, opacity 0.25s ease-in 0.25s","transition-timing-function":"ease-in","transition-duration":"0.5s",width:"0%",height:"0%",left:"50%",top:"50%"},".hola_preroll_end":{width:"200%",height:"200%",left:"-50%",top:"-50%",opacity:"0"},".hola_preview_loader":{top:"0",left:"0",width:"0",position:"absolute",transition:"width 0.2s",height:"2px","max-height":"2px","background-color":"#ff0000"},".hola_preview_loader_logo":{all:"initial","pointer-events":"none",position:"absolute",top:"0",left:"0",display:"block",width:"30px",height:"30px","min-width":"20px","min-height":"20px","max-width":"140px","max-height":"140px",opacity:"0",transition:"opacity 0.2s"},".hola_preview_loader_hide":{transition:"opacity 0.7s ease-in-out",opacity:"0 !important"},".hola_preview_loader_logo svg":{width:"100%",height:"100%",fill:"#ffffff",stroke:"#ffffff",transition:"transform 0.2s ease-in-out",transform:"scale(1)"},".hola_preview_loader_init svg":{transform:"scale(0.1)"},".hola_preview_loader_hide svg":{transition:"transform 0.5s ease-in-out",transform:"scale(0.1)"},".hola_preview_icon":{position:"absolute"},".hola_preview_icon svg":{width:"100%",height:"100%",fill:"#ffffff",stroke:"#ffffff"},".hola_preview_icon_countdown .icon-bg":{filter:"url(#shadow)"},".hola_preview_playing .hola_preview_icon":{visibility:"hidden"},".hola_preview_playing .hola_preview_icon_countdown":{visibility:"visible","z-index":"9999999"},".hola_preview_icon .hola_preview_icon_cancel":{display:"block !important",height:"auto !important",width:"auto !important","line-height":"normal !important",margin:"0 auto !important",padding:"0 1px !important","text-align":"center !important",color:"#fff !important","text-shadow":"0 0 2px #000 !important","transform-origin":"50% 0 !important","font-size":"12px !important","white-space":"nowrap !important"},".hola_preview_icon .hola_preview_icon_cancel:hover":{transform:"scale(1.1)"},".hola_preview_icon .hola_preview_icon_cancel:after":{content:"",display:"none !important"},".hola_preview_icon .hola_preview_icon_cancel:before":{content:"",display:"none !important"},".hola_preview_duration_container":{"pointer-events":"none",position:"absolute"},".hola_preview_duration":{position:"absolute",color:"#fff","background-color":"rgba(0, 0, 0, 0.7)","line-height":"12px","font-size":"12px",padding:"2px 4px","border-radius":"2px","letter-spacing":"0.5px"}};var tooltip_generate="Since you are using the Hola Spark configuration "+"extension and this is not a real production environment, the preview for "+"this video has not been generated yet. Play the video in a new tab and "+"refresh the page in a few minutes. In production, previews are "+"generated automatically, and users don’t see this message";var tooltip_generating="Since you are using the Hola Spark configuration "+"extension and this is not a real production environment, the preview for "+"this video is currently being generated. In production, previews are "+"generated automatically, and users don’t see this message.";var ext_strings={title:{no_mapping:"Watch to generate preview",not_requested:"Hover to generate preview",downloading:"Generating preview",generating:"Generating preview",download_queue:"Generating preview",generate_queue:"Generating preview",generate_queue_full:"Error",download_queue_full:"Error",error:"Error",disabled:"Disabled"},extra:{download_queue:["Status: Waiting do download original video (position %d)","position"],downloading:["Status: Downloading original video (%s)","progress"],generate_queue:["Status: Waiting in preview generation queue (position %d)","position"],generate_queue_full:"Generate queue full",download_queue_full:"Download queue full",error:["%s","error"]},tooltip:{no_mapping:tooltip_generate,not_requested:tooltip_generate,downloading:tooltip_generating,generating:tooltip_generating,download_queue:tooltip_generating,generate_queue:tooltip_generating}};var svg_shadow='<defs><filter id="shadow%id%">'+'<feDropShadow dx="0" dy="0" stdDeviation="2"/></filter></defs>';var logo_svg=["M102,55.1c-1.9-5.9,2-13.1,2-13.1s-1.9,0.1-6.5,4.1c-4.6,4-4.8,9.6-4.8,9.6"+"C87.2,43,76.2,34.8,72,29.3"+"c-4.1-5.5-1.2-12.7-1.2-12.7C62.5,20.2,58.3,29.1,57,39.7"+"c-1.2,10.6-8,14.5-8,14.5c-1.1-9.9-12.4-12.5-12.4-12.5"+"c2.3,0.8,6.4,12.2,2,20.5C35.7,67.8,34,73.8,34,79.7"+"c0,19.6,12.6,35.7,35.8,35.7c21.5,0,36.1-16,36.1-35.7"+"C106.4,72.6,103.8,61.2,102,55.1z M82.8,68.5c2.8,0,5.1,3.1,5.1,6.9"+"c0,3.8-2.3,6.9-5.1,6.9c-2.8,0-5.1-3.1-5.1-6.9"+"C77.8,71.5,80,68.5,82.8,68.5z M57.3,68.5c2.8,0,5.1,3.1,5.1,6.9"+"c0,3.8-2.3,6.9-5.1,6.9c-2.8,0-5.1-3.1-5.1-6.9"+"C52.2,71.5,54.5,68.5,57.3,68.5z M70.8,108.4"+"c-14.8,0.4-27.2-11.2-27.6-26.1h4c0.4,12.2,10.2,21.9,22.3,22.3"+"c12.7,0.4,23.4-9.6,23.8-22.3h3.7C96.5,96.6,85,108,70.8,108.4z","M97.8,39.8c-5.5,2.9-8.8,8.9-8.8,8.9c-5.8-9.5-12.7-13.9-16.8-19.4"+"C68.1,23.8,71,16.6,71,16.6"+"c-8.3,3.6-12.6,12.5-13.8,23.1c-0.7,7.4-4.5,10.2-4.5,10.2"+"c-2.4-7-6.4-8.2-6.4-8.2c1.9,6.1-3,12.2-7.4,20.5"+"c-2.9,5.6-4.6,11.6-4.6,17.5c0,19.6,12.6,35.7,35.7,35.7"+"c21.5,0,36.1-16,36.1-35.7C106.1,55.5,94.1,54.8,97.8,39.8z M90.5,68.5"+"c2.1,0,3.8,3.1,3.8,6.9c0,3.8-1.7,6.9-3.8,6.9s-3.8-3.1-3.8-6.9"+"C86.8,71.5,88.5,68.5,90.5,68.5z M71.5,68.5c2.1,0,3.8,3.1,3.8,6.9"+"c0,3.8-1.7,6.9-3.8,6.9s-3.8-3.1-3.8-6.9C67.8,71.5,69.5,68.5,71.5,68.5z "+"M81.6,108.4c-11,0.4-20.3-11.2-20.6-26.1h3"+"c0.3,12.2,7.6,21.9,16.6,22.3c9.5,0.4,17.4-9.6,17.7-22.3h2.7"+"C100.7,96.6,92.2,108,81.6,108.4z","M94,82.4h1.5c0.1,7.8,1.6,14.6,3.9,18.6c4.3-5.9,6.7-13.3,6.7-21.3"+"c0-24.2-29.5-43.4-35.1-63.1"+"C58.1,31.2,43.3,53.9,38.9,62.2c-2.9,5.6-4.6,11.6-4.6,17.5"+"c0,19.6,12.6,35.7,35.7,35.7c11.8,0,21.6-4.9,27.9-12.5"+"C95.6,98.1,94.1,90.8,94,82.4z M99.3,68.5c1,0,1.9,3.1,1.9,6.9"+"c0,3.8-0.8,6.9-1.9,6.9c-1,0-1.9-3.1-1.9-6.9"+"C97.4,71.5,98.2,68.5,99.3,68.5z","M37.3,94.9C37.3,94.9,37.3,94.9,37.3,94.9c-2-4.6-3.2-9.7-3.2-15.2"+"c0-21.6,11.9-24.2,10-37.3"+"c2,1.2,3.3,2.7,4.2,4.1c0,0,0,0,0,0c0.3,0.5,0.6,0.9,0.8,1.3"+"c0.7,1.2,0.9,2.1,0.9,2.1c5.8-9.5,13.8-15.1,18-20.6"+"c4.1-5.5,1.2-12.7,1.2-12.7c8.3,3.6,12.6,12.5,13.8,23.1"+"c0.3,2.9,0.8,4.9,1.4,6.3c0.5,1,0.9,1.9,1.9,2.8c2.4-5.8,8-9.6,8-9.6"+"c-2.7,7.3,2.6,14.8,7,23c2.9,5.6,4.6,11.6,4.6,17.5"+"c0,19.6-12.6,35.7-35.7,35.7c-11.7,0-21.4-4.7-27.7-12.2c0,0,0,0-0.1,0"+"c-1.1-1.3-1.8-2.3-2.5-3.3c-1-1.5-1.8-3.1-2.6-4.7"+"C37.3,95,37.3,94.9,37.3,94.9z","M101.4,62.2c-4.4-8.3-0.3-19.7,2-20.5c0,0-11.2,2.6-12.4,12.5"+"c0,0-6.7-3.9-8-14.5c-1.3-10.6-5.5-19.4-13.8-23.1"+"c0,0,2.9,7.2-1.2,12.7C63.9,34.8,52.8,43,47.4,55.8c0,0-0.1-5.6-4.7-9.6"+"c-4.5-4-6.5-4.1-6.5-4.1s3.9,7.1,2,13.1"+"c-1.9,6.1-4.5,17.5-4,24.6c0,19.6,14.6,35.7,36.1,35.7"+"c23.2,0,35.7-16,35.7-35.7C106,73.8,104.3,67.8,101.4,62.2z","M97.8,39.8c-5.5,2.9-8.8,8.9-8.8,8.9c-5.8-9.5-12.7-13.9-16.8-19.4"+"C68.1,23.8,71,16.6,71,16.6"+"c-8.3,3.6-12.6,12.5-13.8,23.1c-0.7,7.4-4.5,10.2-4.5,10.2"+"c-2.4-7-6.4-8.2-6.4-8.2c1.9,6.1-3,12.2-7.4,20.5"+"c-2.9,5.6-4.6,11.6-4.6,17.5c0,19.6,12.6,35.7,35.7,35.7"+"c21.5,0,36.1-16,36.1-35.7C106.1,55.5,94.1,54.8,97.8,39.8z","M101.5,62.2c-4.4-8.3-19.2-31-32.1-45.6c-5.6,19.7-35.1,38.9-35.1,63.1"+"c0,7.9,2.4,15.2,6.6,21.1"+"c2.2-4,3.7-10.7,3.8-18.5H46c-0.1,8.2-1.6,15.5-3.8,20.3"+"c6.4,7.8,16.2,12.7,28.1,12.7c23.2,0,35.7-16,35.7-35.7"+"C106.1,73.8,104.4,67.8,101.5,62.2z M40.8,82.2c-1,0-1.9-3.1-1.9-6.9"+"c0-3.8,0.8-6.9,1.9-6.9c1,0,1.9,3.1,1.9,6.9"+"C42.7,79.2,41.8,82.2,40.8,82.2z","M101.3,62.2c-4.4-8.3-9.7-15.7-7-23c0,0-5.6,3.8-8,9.6"+"c-1-0.9-1.4-1.8-1.9-2.8c-0.6-1.4-1.2-3.4-1.4-6.3"+"c-1.3-10.6-5.5-19.4-13.8-23.1c0,0,2.9,7.2-1.2,12.7"+"c-4.1,5.5-12.1,11-18,20.6c0,0-0.2-0.9-0.9-2.1c-0.2-0.4-0.5-0.9-0.8-1.3"+"c0,0,0,0,0,0c-0.9-1.3-2.3-2.8-4.2-4.1c1.9,13.1-10,15.7-10,37.3"+"c0,5.5,1.1,10.6,3.2,15.3c0,0,0-0.1,0-0.1c0,0.1,0.1,0.1,0.1,0.2"+"c0.7,1.6,1.6,3.2,2.6,4.7c0.7,1,1.4,2.1,2.5,3.3c0,0,0,0,0.1,0"+"c6.4,7.5,16,12.2,27.7,12.2c23.2,0,35.7-16,35.7-35.7"+"C105.9,73.8,104.3,67.8,101.3,62.2z M68.5,68.5c2.1,0,3.8,3.1,3.8,6.9"+"c0,3.8-1.7,6.9-3.8,6.9c-2.1,0-3.8-3.1-3.8-6.9"+"C64.8,71.5,66.5,68.5,68.5,68.5z M49.5,68.5c2.1,0,3.8,3.1,3.8,6.9"+"c0,3.8-1.7,6.9-3.8,6.9s-3.8-3.1-3.8-6.9"+"C45.8,71.5,47.5,68.5,49.5,68.5z M59.6,108.4c-11,0.4-20.3-11.2-20.6-26.1"+"h3c0.3,12.2,7.6,21.9,16.6,22.3"+"c9.5,0.4,17.4-9.6,17.7-22.3H79C78.7,96.6,70.2,108,59.6,108.4z"];E.init=function(spark){log.notice("preview init");E.spark=spark;E.links=spark.links;var local_conf=storage.get_json("hola_preview_conf")||{};E.conf=assign({},def_opt,spark.conf.video_previews,local_conf,window.hola_ve_preview_conf);E.conf.preroll=E.conf.preroll||/show_hola_preroll/.test(window.location.href);E.conf.debug=!!(E.conf.debug||spark.conf.debug||/hola_ve_preview_debug/.test(window.location.href));E.stats=new Stats;apply_styles(E.conf);E.watermark=watermark(assign({customer:spark.customer,module:"preview",delay:function(duration,pos){return duration/2-pos}},E.conf.watermark));E.one("has_previews",function(){if(util.is_mobile||E.conf.autoplay.enable&&E.conf.autoplay.type==2){init_autoplay_on_scroll(E.conf);if(!util.is_mobile)return}var random_enabled=E.conf.autoplay_interval_enabled||E.conf.autoplay.enable&&E.conf.autoplay.type==1;var random_interval=E.conf.autoplay_interval||E.conf.autoplay.random_interval;if(random_enabled&&random_interval)init_random_autoplay(E.conf)});var update=function(){update_links(E.conf)};E.links.on("update",update);update();E.links.on("detach",function(detached){previews=previews.filter(function(p){if(!detached.includes(p.el))return true;p.destroy()})});util.on("zbeforeunload",util.try_wrapper({prefix:"preview"},function(){E.stats.send_perr()}))};function apply_styles(opt){var styles=zutil.extend_deep({},def_styles,opt.extra_css_fn?opt.extra_css_fn():null);if(!opt.line_loader){styles[".hola_preview_loading .hola_preview_poster"]={transform:"scale(1.1)"}}var loader_style=styles[".hola_preview_loader"];if(opt.line_loader_height){loader_style.height=opt.line_loader_height+"px";loader_style["max-height"]=opt.line_loader_height+"px"}if(opt.line_loader_color)loader_style["background-color"]=opt.line_loader_color;var popup_style=styles[".hola_preview_popup"];if(opt.popup_border_width)popup_style["border-width"]=opt.popup_border_width+"px";if(opt.popup_border_color)popup_style["border-color"]=opt.popup_border_color;if(opt.duration_location){var dur_style=styles[".hola_preview_duration"];var dur_loc=opt.duration_location.split("-");dur_style.margin=(opt.duration_margin||4)+"px";dur_style[dur_loc[0]]="0";dur_style[dur_loc[1]]="0"}if(opt.fade_time){styles[".hola_video_preview.hola_fade_out"]["transition-duration"]=opt.fade_time+"ms"}E.styles=util.get_stylesheet(styles);$("head").append("<style>"+E.styles+"</style>")}function Stats(){this.prefix="preview_";this.init()}Stats.prototype.init=function(reset){if(!reset&&this.stats&&!zutil.is_mocha())return void log.notice("stats already initialized");this.stats={};if(reset){this.hovers=this.hovers.map(function(){return{}});this.inc("stats_reset_n")}else{this.hovers=[];this.inc("init_n")}this.total_hover_ms=0;this.total_load_ms=0;this.total_play_ms=0;this.played_hover_ms=0;this.played_load_ms=0;this.loaded_not_played_hover_ms=0};Stats.prototype.add_preview=function(preview){var id=preview.get_id();preview.on("hover",this.try_wrapper(this.hover,id));preview.on("unhover",this.try_wrapper(this.unhover,id));preview.on("hide",this.try_wrapper(this.hide,id));preview.on("loaded",this.try_wrapper(this.loaded,id));preview.on("played",this.try_wrapper(this.played,id));preview.on("autoplay",this.try_wrapper(this.autoplay,id));preview.on("countdown_show",this.try_wrapper(this.countdown_show,id));preview.on("countdown_cancel",this.try_wrapper(this.countdown_cancel,id));preview.on("navigate",this.try_wrapper(this.navigate,id));preview.on("link_click",this.try_wrapper(this.click,id));this.hovers[id]={}};Stats.prototype.inc=function(s,v){return this.set(s,(this.get(s)||0)+(v||1))};Stats.prototype.set=function(s,v){return this.stats[this.prefix+s]=v};Stats.prototype.get=function(s){return this.stats[this.prefix+s]};Stats.prototype.get_stats=function(){var _this=this;this.hovers.forEach(function(h,id){if(h.active)_this.unhover(id)});function set_avg(key,total,count){if(total&&count)_this.set(key,total/count)}set_avg("hover_ms",this.total_hover_ms,this.get("hover_n"));set_avg("load_ms",this.total_load_ms,this.get("loaded_n"));set_avg("play_ms",this.total_play_ms,this.get("played_n"));set_avg("played_hover_ms",this.played_hover_ms,this.get("played_n"));set_avg("played_load_ms",this.played_load_ms,this.get("loaded_n"));set_avg("loaded_not_played_hover_ms",this.loaded_not_played_hover_ms,this.get("loaded_n")-(this.get("played_n")||0));return this.stats};Stats.prototype.hover=function(id){if(this.hovers[id].active)return;this.hovers[id]={active:true,start:date.monotonic()};this.inc("hover_n")};Stats.prototype.unhover=function(id){if(!this.hovers[id].active)return;var now=date.monotonic();var time=now-this.hovers[id].start;var loaded=this.hovers[id].loaded;var played=this.hovers[id].played;if(played){this.total_play_ms+=now-this.hovers[id].play_start;this.played_load_ms+=this.hovers[id].load_ms||0}if(loaded&&!played)this.loaded_not_played_hover_ms+=time;this.hovers[id].active=false;this.total_hover_ms+=time;if(loaded)return;if(time<300)this.inc("hover_under_300ms_n");else if(time<500)this.inc("hover_under_500ms_n")};Stats.prototype.loaded=function(id){if(this.hovers[id].loaded)return;this.hovers[id].loaded=true;this.hovers[id].load_ms=date.monotonic()-this.hovers[id].start;this.total_load_ms+=this.hovers[id].load_ms;this.inc("loaded_n")};Stats.prototype.played=function(id){if(!this.hovers[id].active||this.hovers[id].played)return;this.hovers[id].played=true;this.hovers[id].play_start=date.monotonic();this.played_hover_ms+=this.hovers[id].play_start-this.hovers[id].start;this.inc("played_n")};Stats.prototype.hide=function(id){this.hovers[id].autoplay=false};Stats.prototype.autoplay=function(id){this.hovers[id].autoplay=true};Stats.prototype.click=function(id){var stats=this.hovers[id];if(stats.click||stats.navigate)return;var name="navigate_";name+=stats.active?"on_":"not_";if(stats.active&&stats.autoplay)name+="auto_";name+="playing_n";stats.click=true;this.inc(name)};Stats.prototype.navigate=function(id){var stats=this.hovers[id];if(!stats.active||stats.navigate||stats.click)return;stats.navigate=true;this.inc("auto_navigate_on_hover_n")};Stats.prototype.countdown_show=function(id){var stats=this.hovers[id];if(!stats.active||stats.countdown_show)return;stats.countdown_show=true;this.inc("countdown_show_n")};Stats.prototype.countdown_cancel=function(id){var stats=this.hovers[id];if(!stats.active||stats.countdown_cancel)return;stats.countdown_cancel=true;this.inc("countdown_cancel_n")};Stats.prototype.try_wrapper=function(func,arg){return util.try_wrapper({prefix:"preview_stats"},func.bind(this,arg))};Stats.prototype.send_perr=function(){if(!this.total_hover_ms)return;perr({id:"preview_stats",info:{stats:this.get_stats()},delay:false,use_beacon:true});this.init(true)};zutil.inherits(CachedVideo,events.EventEmitter);function CachedVideo(url,opt,force){this.url=url;this.progress=0;this.loaded=this.ready=false;if(!opt.preload_cache&&!force&&!opt.line_loader)return void this.set_ready();this.start()}CachedVideo.prototype.start=function(){if(this.active)return;this.active=true;if(!this.url||!this.url.startsWith("http"))return void setTimeout(this.onerror.bind(this),0);var _this=this;if(!this.check_timeout()){return void setTimeout(function(){_this.set_ready({err:"repeat_timeout"})},0)}this._last_req_ts=date.monotonic();var xhr=new XMLHttpRequest;xhr.onprogress=this.onprogress.bind(this);xhr.onload=this.onload.bind(this);xhr.onerror=this.onerror.bind(this);xhr.open("GET",this.url);xhr.responseType="blob";xhr.send()};CachedVideo.prototype.check_timeout=function(){return!this._last_req_ts||date.monotonic()-this._last_req_ts>=10*date.ms.SEC};CachedVideo.prototype.set_ready=function(error){this.ready=!error;this.emit("ready");this.active=false};CachedVideo.prototype.onload=function(event){var xhr=event&&event.target;if(xhr&&xhr.status!=200)return void this.onerror();if(xhr&&URL&&URL.createObjectURL)this.result=URL.createObjectURL(xhr.response);this.loaded=true;this.emit("loaded");this.set_ready()};CachedVideo.prototype.onprogress=function(event){var xhr=event&&event.target;if(!xhr||xhr.readyState<2||xhr.status!=200)return;this.headers_received=true;this.progress=event.loaded/event.total;this.emit("progress")};CachedVideo.prototype.onerror=function(){this.set_ready({err:"fetch_error"})};CachedVideo.prototype.get_src=function(){return this.result||this.url};CachedVideo.prototype.uninit=function(){if(this.result&&URL.revokeObjectURL)URL.revokeObjectURL(this.result);this.result=undefined};var video_cache=function(){var cached_videos={};return{get:function(url,opt,force){return cached_videos[url]||(cached_videos[url]=new CachedVideo(url,opt,force))},purge:function(url){if(cached_videos[url])cached_videos[url]=cached_videos[url].uninit()}}}();function Preview(link,opt){this.opt=opt;var el=this.el=link.link;this.href=E.links.get_href(el,opt);var _this=this;this.use_autoplay=!util.is_safari;this.active=false;this.has_info=false;this.uniq_id=++uniq_id;this.is_playlist_link=$(el).is("[data-hola-playlist-link]");var $el=$(el);$el.prop("hola-video-preview-id",this.uniq_id);this.img=link.img;this.click_pass_through=this.el==$(this.img).get(0)&&E.conf.click_pass_through;this.text_link=link.text_link;this.description=link.description;$el.on("mouseenter",this.hover.bind(this));$el.on("click",function(){_this.emit("link_click")});var $links=$(el);if(link.links){link.links.filter(function(t){return!within(el,t)}).each(function(t){$(t).on("mouseenter",_this.hover.bind(_this));$(t).on("click",function(){_this.emit("link_click")});$links.add(t)})}if(!this.img.parents().filter($links).length)this.img.on("mouseenter",this.hover.bind(this));if(!this.text_link)this.loader=new Loader(this);if(opt.icon_location&&!this.text_link)this.icon=new Icon(this);if(opt.duration_location&&!this.text_link)this.duration=new Duration(this);this.preroll=new Preroll(this,opt.preroll);this.init_debug_rect();this.update()}zutil.inherits(Preview,events.EventEmitter);Preview.prototype.init_debug_rect=function(){this.ext_info_enabled=util.has_ext&&false;if(!(this.use_debug_rect=E.conf.debug||this.ext_info_enabled))return;var _this=this;this.update_debug_interval=setInterval(function(){_this.draw_debug_rect()},3e3)};Preview.prototype.uninit_debug_rect=function(){this.update_debug_interval=clearInterval(this.update_debug_interval);this.use_debug_rect=false;if(this.logo)this.logo.remove();this.logo=null};Preview.prototype.draw_debug_rect=function(rect){if(!this.use_debug_rect)return;rect=util.client_rect2page_rect(rect||(this.img[0]||this.el).getBoundingClientRect());var $rect=$("#hola_preview_debug_"+this.uniq_id);if(!$rect||!$rect.length){$rect=$("<div id=hola_preview_debug_"+this.uniq_id+">").toggleClass("hola_preview_debug",E.conf.debug).toggleClass("hola_preview_ext_info",!E.conf.debug&&this.ext_info_enabled).appendTo($(document.body));if(!E.conf.debug){if(this.debug_elems){this.debug_elems.off("mouseover",this.debug_mouseover);this.debug_elems.off("mouseleave",this.debug_mouseleave)}this.logo=new Logo(this,this.opt,{rect:$rect,pos:rect,show:true});this.debug_elems=$([$rect[0],this.el]).on("mouseover",this.debug_mouseover=this.logo.animate.bind(this.logo)).on("mouseleave",this.debug_mouseleave=this.logo.pause.bind(this.logo))}}$rect.toggleClass("no_video",!!this.has_info&&!this.has_video);$rect.toggleClass("has_video",!!this.has_video);$rect.css({top:rect.top-2+"px",left:rect.left-2+"px",width:rect.width+2+"px",height:rect.height+2+"px"});var src=previews_map[this.href],info;if(!src)info={status:"no_mapping"};else if(src.info)info=src.info;else if(src.error)info={status:src.url?"ready":"error",error:src.error};if(E.conf.debug){var lines=[];for(var s in info)lines.push("<span>"+s+": <b>"+info[s]+"</b></span>");$rect.html(lines.join("<br/>"));return}var video=this.get_video();if(info&&info.status=="ready"||video&&video.ready){$rect.addClass("has_video_ready");if(this.debug_elems){this.debug_elems.off("mouseover",this.debug_mouseover);this.debug_elems.off("mouseleave",this.debug_mouseleave);this.debug_elems=null}if(this.logo)this.logo.remove();this.logo=null}if(!info)return;var title=ext_strings.title[info.status]||"";var extra=ext_strings.extra[info.status]||"";var tooltip=ext_strings.tooltip[info.status]||"";if(Array.isArray(extra)){extra=sprintf.apply(null,extra.map(function(p,i){return i==0?p:info[p]||""}))}$("<div>").attr({title:tooltip}).html("<span class=title>"+title+"</span>"+"<br/><br/>"+extra).appendTo($rect.empty())};Preview.prototype.get_id=function(){return this.uniq_id};Preview.prototype.get_url=function(){var opt=this.opt,src=previews_map[this.href];var has_url=typeof src=="string"||src&&src.url;if(!has_url||src.info&&src.info.status=="error")return;if(src.error=="not ready")this.not_ready=true;src=src.url||src;if(util.is_android)src=src.replace(/m3u8/g,"m%33u8");var cdn_host=util.protocol=="https:"?opt.cdn.hostname:opt.cdn.host;return util.protocol+"//"+cdn_host+src};Preview.prototype.get_video=function(){return video_cache.get(this.get_url(),this.opt)};Preview.prototype.update=function(){var video=this.get_url();this.has_info=true;if(this.icon)this.icon.update();if(video){this.has_video=true;if(E.conf.debug)log.notice("Preview #"+this.uniq_id+" video:"+video)}else this.has_video=false;$(this.el).prop("hola-video-preview-has-video",this.has_video);this.draw_debug_rect()};Preview.prototype.hover=function(event){this.emit("hover");this.show(event)};Preview.prototype.show=function(event,autoplay){var stats_autoplay;if(!autoplay&&this.autoplay&&this.active){this.hide(undefined,true);stats_autoplay=true}if(this.active)return;var video=this.get_video(),_this=this;if(video.loaded)this.emit("loaded");else{if(this.on_loaded)video.off("loaded",this.on_loaded);video.on("loaded",this.on_loaded=function(){video.off("loaded",_this.on_loaded);_this.on_loaded=undefined;_this.emit("loaded")})}if(!this.text_link&&(!this.img.width()||!this.img.height()))return void this.error();this.last_mouse_event=event;if(!autoplay){var img_size=this.get_img_size_el();var link=event&&event.currentTarget||this.el;if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);$(document).on("mousemove",this.on_doc_mousemove=function(ev){_this.last_mouse_event=ev;if(mouse_within(link,ev)||mouse_within(img_size,ev)||_this.container&&mouse_within(_this.container,ev)){return}_this.unhover()});if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.scrollable_parents=$(link).parents().filter(function(el){var $el=$(el),scrollable=["scroll","auto"];if(window.Node&&window.Node.ELEMENT_NODE!=el.nodeType)return false;return scrollable.includes($el.css("overflow-x"))||scrollable.includes($el.css("overflow-y"))});this.scrollable_parents.on("scroll",this.on_parents_scroll=function(){_this.on_doc_mousemove(_this.last_mouse_event)});previews.forEach(function(p){if(p.active&&p.autoplay)p.hide()})}if(!video.get_src())return void this.error();if(autoplay||stats_autoplay)this.emit("autoplay");this.autoplay=autoplay;draw_debug_active(this.uniq_id,true);this.active=true;if(this.text_link){if(!this.on_mousemove){$(this.el).on("mousemove",this.on_mousemove=function(ev){_this.last_mouse_event=ev})}}if(this.loader){if(!video.ready){return void this.loader.show(this._show.bind(this),this.hide.bind(this))}this.loader.show()}else if(this.text_link&&!video.ready){return void video.on("ready",this.on_ready=function(){if(video.ready)_this._show();else _this.hide()})}this._show()};Preview.prototype._show=function(){var _this=this,img=this.img,opt=this.opt;if(!this.get_video().get_src()||!this.text_link&&(!img.width()||!img.height())){this.active=false;return void this.hide()}this.draw_debug_rect();$(this.el).removeClass("hola_preview_error");this.create_elements();if(!this.popup&&!this.click_pass_through)$(img).addClass("hola_preview_img");$(this.el).parent().addClass("hola_preview_link_container");var parent=this.popup?$(this.container):$(this.img).parent();setTimeout(function(){if(_this.active)parent.addClass("hola_preview_loading")});this.preroll.show();$(this.video_el).on(this.use_autoplay?"play":"playing",function(){_this.play_timeout=setTimeout(function(){_this.preroll.end();_this.emit("played");parent.removeClass("hola_preview_loading");parent.addClass("hola_preview_playing")},300)});if(!this.use_autoplay)this.video_el.play();if(opt.fade_time)this.init_fade();if(no_object_fit())this.object_fit_fallback();if(!this.autoplay&&!util.is_mobile&&!this.is_playlist_link&&opt.navigate_on_hover_enabled){if(typeof opt.navigate_on_hover_sec=="number"){this.rm_navigate=setTimeout(function(){_this.countdown_show()},opt.navigate_on_hover_sec*date.ms.SEC)}else if(typeof opt.countdown_on_hover=="number")this.countdown_show()}};function no_object_fit(){return util.is_ie||util.is_edge&&util.browser.version<16}function object_fit_css(v){var video_ratio=v.videoWidth/v.videoHeight;var el_ratio=v.width/v.height;var new_width,new_height;if(video_ratio>el_ratio){new_width=v.height*video_ratio;new_height=v.height}else{new_width=v.width;new_height=v.width/video_ratio}return{width:Math.round(new_width)+"px",height:Math.round(new_height)+"px",marginTop:Math.round((v.height-new_height)/2)+"px",marginLeft:Math.round((v.width-new_width)/2)+"px"}}Preview.prototype.object_fit_fallback=function(){var v=this.video_el;var fit=function(){$(v).css(object_fit_css(v));$(v).off("loadedmetadata",this.on_meta);this.on_meta=null};if(v.readyState>0)fit();else $(v).on("loadedmetadata",this.on_meta=fit)};Preview.prototype.init_fade=function(){var _this=this,opt=this.opt,v=this.video_el;$(v).on("timeupdate",this.on_timeupdate=function(){var delay=(v.duration-v.currentTime)*date.ms.SEC-opt.fade_time;if(!_this.fade_timeout&&delay<1e3){_this.fade_timeout=setTimeout(function(){if(_this.video_el)$(_this.video_el).addClass("hola_fade_out")},delay)}});var captured=false;var capture_frame=function(){if(!_this.video_el)return;var c=_this.canvas;$(c).attr({height:v.videoHeight,width:v.videoWidth});if(no_object_fit())$(c).css(object_fit_css(v));else $(c).css({height:v.offsetHeight+"px",width:v.offsetWidth+"px"});c.getContext("2d").drawImage(v,0,0);captured=true};$(v).on("playing",this.on_playing=function(){if(!captured){if(util.is_ie)setTimeout(capture_frame,150);else capture_frame()}if(_this.fade_timeout)_this.fade_timeout=clearTimeout(_this.fade_timeout);$(v).removeClass("hola_fade_out")})};Preview.prototype.countdown_show=function(){if(!this.opt.countdown_on_hover)return this.navigate();this.emit("countdown_show");this.rm_navigate=setTimeout(this.navigate.bind(this),this.opt.countdown_on_hover*date.ms.SEC);this.countdown=new Icon(this,{icon_countdown:true,icon_location:"center",on_countdown_cancel:this.countdown_cancel.bind(this)})};Preview.prototype.countdown_cancel=function(){this.emit("countdown_cancel");if(this.rm_navigate)this.rm_navigate=clearTimeout(this.rm_navigate)};Preview.prototype.navigate=function(){if(!this.el||typeof this.el.click!="function")return;this.emit("navigate");this.el.click()};Preview.prototype.unhover=function(){this.emit("unhover");this.hide()};Preview.prototype.hide=function(error,preserve_elements){var video=this.get_video();if(this.on_loaded){video.off("loaded",this.on_loaded);this.on_loaded=null}if(this.on_ready){video.off("ready",this.on_ready);this.on_ready=null}if(this.loader)this.loader.hide();if(this.preroll)this.preroll.hide();this.last_mouse_event=null;if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);this.on_doc_mousemove=null;if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.on_parents_scroll=null;this.scrollable_parents=null;if(!this.active)return;if(!preserve_elements)this.emit("hide");clearTimeout(this.play_timeout);if(this.rm_loop)this.rm_loop=clearTimeout(this.rm_loop);
if(this.rm_navigate)this.rm_navigate=clearTimeout(this.rm_navigate);if(this.countdown){this.countdown.hide();this.countdown=null}draw_debug_active(this.uniq_id,false);this.active=false;if(error)$(this.el).addClass("hola_preview_error");if(this.on_mousemove)$(this.el).off("mousemove",this.on_mousemove);this.on_mousemove=null;if(this.on_timeupdate)$(this.video_el).off("timeupdate",this.on_timeupdate);this.on_timeupdate=null;if(this.on_playing)$(this.video_el).off("playing",this.on_playing);this.on_playing=null;if(this.on_meta)$(this.video_el).off("loadedmetadata",this.on_meta);this.on_meta=null;if(preserve_elements)return;var parent=this.popup?$(this.container):$(this.img).parent();parent.removeClass("hola_preview_loading");parent.removeClass("hola_preview_playing");$(this.img).removeClass("hola_preview_img");$(this.el).parent().removeClass("hola_preview_link_container");this.remove_elements()};Preview.prototype.error=function(){this.was_error=true;this.emit("error")};function in_rect(r,a,opt){if(opt&&opt.is_inside)r={top:r.bottom,bottom:r.top,left:r.right,right:r.left};return r.bottom>a.top&&r.top<a.bottom&&r.right>a.left&&r.left<a.right}Preview.prototype.in_middle=function(check_x){var img=$(this.img);if(this.text_link||!img.width()||!img.height())return;var rect=img[0].getBoundingClientRect();var result=in_rect(rect,get_mid_rect(check_x));this.draw_debug_rect(rect);draw_debug_active(this.uniq_id,result);return result};Preview.prototype.in_viewport=function(entirely){var img=$(this.img);if(this.text_link||!img.width()||!img.height())return;var rect=img[0].getBoundingClientRect();this.draw_debug_rect(rect);return in_rect(rect,util.visual_viewport(),{is_inside:entirely})};Preview.prototype.get_img_size_el=function(overlay){var img=this.img,opt=this.opt,img_size;if(this.text_link)return this.el;var selector=overlay?opt.img_size_for_overlay||opt.img_size:opt.img_size;if(selector)img_size=img.closest(selector);if(!img_size||!img_size.length)img_size=img;return img_size};Preview.prototype.get_position=function(overlay){var img=this.img,opt=this.opt;var img_size=this.get_img_size_el(overlay);var img_offset=$(img_size).offset();var x=img_offset.left,y=img_offset.top;var doc=$(img_size)[0].ownerDocument;var iframe=(doc.defaultView||doc.parentWindow||{}).frameElement;if(iframe){var iframe_offset=$(iframe).offset();x+=iframe_offset.left;y+=iframe_offset.top}var width=$(img_size).outerWidth(),height=$(img_size).outerHeight();if(this.text_link){var popup_width=opt.popup_width||196;var popup_height=opt.popup_height||110;var tip_offset={y:30,x:95};return{top:y-popup_height-tip_offset.y,left:x+(this.last_mouse_event?this.last_mouse_event.offsetX-tip_offset.x:0),width:popup_width,height:popup_height,popup:true}}if(!util.is_mobile&&!overlay&&(opt.scale||width<opt.min_width||height<opt.min_height)&&!this.is_playlist_link){var scale=opt.scale||Math.max((opt.min_width||0)/width,(opt.min_height||0)/height);var new_width=width*scale,new_height=height*scale;return{top:Math.max(y-(new_height-height)/2,0),left:Math.max(x-(new_width-width)/2,0),width:new_width,height:new_height,popup:true}}var img_pos=E.conf.custom_position?E.conf.custom_position(img,$):$(img).jqPosition();return{top:img_size==img?img_pos.top:y-$(img).offsetParent().offset().top,left:img_size==img?img_pos.left:x-$(img).offsetParent().offset().left,width:width,height:height,transform:"none"}};Preview.prototype.create_relative_container=function(){if(!E.conf.position_relative||!E.conf.position_relative(this.el,$))return;var pos=this.get_position();var dummy_div=document.createElement("div");$(this.img).after(dummy_div);var dummy_pos=$(dummy_div).jqPosition();$(dummy_div).remove();var outer_container=document.createElement("div");$(outer_container).css({top:pos.top-dummy_pos.top+"px",left:pos.left-dummy_pos.left+"px",position:"relative"});return outer_container};Preview.prototype.create_elements=function(){if(this.video_el)return;var pos=this.get_position();var container=this.container=document.createElement("div");var outer_container;if(outer_container=this.outer_container=this.create_relative_container()){outer_container.appendChild(container);pos.top=pos.left=0}container.hola_preview=this;this.popup=pos.popup;$(container).addClass("hola_preview_container");$(container).css({top:pos.top+"px",left:pos.left+"px",width:pos.width+"px",height:pos.height+"px",transform:pos.transform});if(this.click_pass_through)$(container).css("pointer-events","none");var v=this.create_video_el(pos.width,pos.height);var poster,canvas;if(!this.text_link){poster=$(this.img).clone();if(this.img[0]&&this.img[0].currentSrc)poster.attr("src",this.img[0].currentSrc);poster.css("visibility","");poster.addClass("hola_preview_poster")}if(this.opt.fade_time){canvas=$("<canvas class=hola_preview_background></canvas>");canvas.css({width:pos.width+"px",height:pos.height+"px"});this.canvas=canvas[0]}if(pos.popup){$(container).addClass("hola_preview_popup");if(this.text_link){$(container).addClass("hola_preview_text_link_popup");$(container).append("<div class=hola_popup_arrow_border></div>");$(container).append("<div class=hola_popup_arrow></div>")}setTimeout(function(){$(container).addClass("hola_preview_popup_visible")},100);var link=document.createElement("a");$(link).attr({href:this.href,hola_ve_preview:"none"});if(canvas)$(link).append(canvas);link.appendChild(v);if(poster)$(link).append(poster);if(!this.text_link){$(link).append("<div class=hola_preview_title>"+this.description+"</div>")}container.appendChild(link)}else{$(poster).css({width:$(this.img).width()+"px",height:$(this.img).height()+"px"});if(canvas)$(container).append(canvas);container.appendChild(v);$(container).append(poster)}if(outer_container)container=outer_container;if(E.watermark)E.watermark.apply({v:v,container:container});if(pos.popup)$(document.body).append(container);else if(this.opt.last_in_container)this.img.parent().append(container);else this.img.after(container)};Preview.prototype.remove_elements=function(){var container=this.container,popup=this.popup;if(!container)return;var outer_container=this.outer_container;var remove=function(){if($(container).parent().length)$(container).remove();if($(outer_container).parent().length)$(outer_container).remove()};if(E.watermark)E.watermark.remove(this.container);this.container=null;this.outer_container=null;this.popup=null;this.video_el=null;this.canvas=null;if(!popup)return void remove();$(container).removeClass("hola_preview_popup_visible");setTimeout(remove,300)};Preview.prototype.create_video_el=function(width,height){var v=document.createElement("video"),_this=this;var attrs={muted:1,playsinline:1,width:Math.ceil(width),height:Math.ceil(height)};if(this.use_autoplay)attrs.autoplay=1;$(v).attr(attrs);$(v).addClass("hola_video_preview");$(v).on("loadeddata",function(){_this.emit("loaded")});$(v).on("ended",function(){if(!_this.autoplay)v.play();_this.emit("loop_restart");_this.rm_loop=setTimeout(function(){if(_this.active)v.play()},0)});var s=document.createElement("source");$(s).prop({type:"video/mp4",src:this.get_video().get_src()});v.appendChild(s);s.addEventListener("error",function(){_this.hide(true)});this.video_el=v;return v};Preview.prototype.destroy=function(){this.hide();if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);this.on_doc_mousemove=null;if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.on_parents_scroll=null;this.scrollable_parents=null;if(this.on_mousemove)$(this.el).off("mousemove",this.on_mousemove);this.on_mousemove=null;this.uninit_debug_rect();video_cache.purge(this.get_url())};function Loader(preview){this.preview=preview;this.opt=this.preview.opt;this.is_logo=this.opt.line_loader==2||!this.opt.disable_logo_loader;this.video_ready_fn=this.video_ready.bind(this);this.video_progress_fn=this.video_progress.bind(this);this._initial_progress=.1}Loader.prototype.show=function(on_ready,on_error){if(this.active)return;this.active=true;this.video=this.preview.get_video();this.on_ready=on_ready;this.on_error=on_error;var pos=this.preview.get_position(true);this.wait_headers=(true||this.preview.not_ready)&&!this.video.headers_received;if(this.opt.line_loader==1){this.max_width=pos.width;this.elem=document.createElement("div");$(this.elem).addClass("hola_preview_loader");$(this.elem).css({display:this.wait_headers?"none":"block",top:pos.top+"px",left:pos.left+"px",transform:pos.transform});$(this.preview.img).after(this.elem)}if(this.is_logo){this.logo=new Logo(this.preview,this.opt,{hide:this.wait_headers,animate:true})}this.video_progress_fn();if(this.video.ready)return void this.video_ready_fn();this.video.on("ready",this.video_ready_fn);this.video.on("progress",this.video_progress_fn);this.video.start()};Loader.prototype.hide=function(){if(!this.active)return;this.active=false;this.video.off("ready",this.video_ready_fn);this.video.off("progress",this.video_progress_fn);if(this.ready_t)this.ready_t=clearTimeout(this.ready_t);if(this.rm_t)this.rm_t=clearTimeout(this.rm_t);if(this.elem)$(this.elem).remove();if(this.logo)this.logo.remove();this.on_ready=null;this.on_error=null};Loader.prototype.video_ready=function(){if(!this.video.ready&&this.on_error)return this.on_error();if(this.video.ready&&this.on_ready)this.on_ready();var _this=this;if(this.max_width){this.ready_t=setTimeout(function(){$(_this.elem).css({width:_this.max_width+"px",maxWidth:_this.max_width+"px"})},0)}if(this.logo)return this.logo.hide();this.rm_t=setTimeout(function(){$(_this.elem).css("display","none")},200)};Loader.prototype.video_progress=function(){var $elem=this.elem?$(this.elem):null;if(this.preview.not_ready||this.wait_headers){if(!this.video.headers_received&&!this.video.ready)return;if($elem)$elem.css({display:"block"});if(this.logo)this.logo.show();this.preview.not_ready=false}if(!$elem)return;var progress=Math.max(this._initial_progress,this.video.progress);$elem.css({width:progress*this.max_width+"px",maxWidth:progress*this.max_width+"px"})};function Logo(preview,opt,conf){this.opt=opt;this.index=0;var id=preview.uniq_id;var pos=conf.pos||preview.get_position(true);var browser=util.browser&&util.browser.browser;var use_shadow=!["edge","ie"].includes(browser);var svg='<svg viewBox="0 0 140 140">'+svg_shadow.replace("%id%",id)+'<g><path class="logo_path" d="'+logo_svg[this.index]+'"'+(use_shadow?'filter="url(#shadow'+id+')"':"")+" /></g></svg>";var $logo=this.logo=$("<div>"+svg+"</div>");var size=Math.min(140,Math.max(20,pos.width*.1));var margin=opt.icon_loader_margin===undefined?size/4:opt.icon_loader_margin;$logo.addClass("hola_preview_loader_logo");if(!conf.show)$logo.addClass("hola_preview_loader_init");var pos_size=get_icon_pos_size({pos:pos,shadow:true,margin:margin,location:opt.icon_loader_location||"top-right",size_px:size});$logo.css({position:"absolute",width:size+"px",height:size+"px",top:pos.top+pos_size.top+"px",left:pos.left+pos_size.left+"px",opacity:conf.hide?0:opt.logo_loader_opacity});this.path_el=$logo.find(".logo_path")[0];this.start_hiding=false;if(conf.animate)this.animate();$(conf.rect||preview.img).after(this.logo)}Logo.prototype.animate=function(){if(this.animating)return;this.animating=true;this._animate()};Logo.prototype._animate=function(ts){var _this=this;function next(){_this.rm_anim=requestAnimationFrame(_this._animate.bind(_this))}if(!this.start){this.logo.removeClass("hola_preview_loader_init");this.start=ts;return next()}if(ts-this.start<60)return next();this.start=ts;this.index++;this.redraw();if(!this.start_hiding||this.index>0)return next();if(this.hiding)return;this.hiding=true;this.rm_t=setTimeout(function(){_this.logo.addClass("hola_preview_loader_hide");_this.rm_t=clearTimeout(_this.rm_t);next()},1e3)};Logo.prototype.pause=function(){this.rm_anim=cancelAnimationFrame(this.rm_anim);this.animating=false;this.index=0;this.redraw()};Logo.prototype.redraw=function(){if(this.index>=logo_svg.length)this.index=0;this.path_el.setAttribute("d",logo_svg[this.index])};Logo.prototype.show=function(){this.start_hiding=false;this.logo.css({opacity:this.opt.logo_loader_opacity})};Logo.prototype.hide=function(){this.start_hiding=true};Logo.prototype.remove=function(){this.rm_anim=cancelAnimationFrame(this.rm_anim);this.rm_t=clearTimeout(this.rm_t);this.logo.remove()};function Preroll(preview,enable){if(!enable)return this;this.preview=preview}Preroll.prototype.show=function(){if(!this.preview)return;this.logo=document.createElement("div");$(this.logo).addClass("hola_preroll");this.preview.container.appendChild(this.logo)};Preroll.prototype.end=function(){if(!this.logo)return;var _this=this;$(this.logo).addClass("hola_preroll_end");setTimeout(function(){if(_this.logo&&+$(_this.logo).css("opacity")==0)_this.hide()},2e3)};Preroll.prototype.hide=function(){if(!this.logo)return;if($(this.logo).parent().length)$(this.logo).remove();delete this.logo};function Icon(preview,opt){this.preview=preview;this.opt=assign({},this.preview.opt,opt);this.update();this._countdown=this.opt.countdown_on_hover*date.ms.SEC}Icon.prototype.update=function(){var p=previews_map[this.preview.href];if(p&&(!p.error||p.error=="same_size"||p.error=="not ready"))this.show();else this.hide()};function get_icon_pos_size(opt){var pos=opt.pos||opt.preview.get_position(true);var size=opt.size_px?opt.size_px:(opt.size||.25)*pos.height+(opt.shadow?10:0);var top,left,loc=opt.location.split("-");var margin=opt.margin||10;if(loc[0]=="center"){left=(pos.width-size)/2;top=(pos.height-size)/2}else{top=loc[0]=="top"?margin:pos.height-size-margin;left=loc[1]=="left"?margin:pos.width-size-margin}return{pos:pos,top:top,left:left,size:size}}Icon.prototype.show=function(){if(this.elem)return;var img=$(this.preview.img)[0];var _this=this;if(img.width<2||img.naturalWidth<2){$(img).on("load",function on_load(){$(img).off("load",on_load);_this.show()});return}var opt=this.opt;var icon='<g><path d="M 0,0 0,20 14,10 Z"/></g>';var stroke_width=3;var r=40/2-stroke_width/2;var cir=this.cir=Math.ceil(2*Math.PI*r);var circle="";var bg_circle='<g><circle class="icon-bg" cx="5" cy="10" fill="#333" '+'fill-opacity="0.7" r="'+r+'" stroke-width="0"></circle></g>';var class_name="hola_preview_icon";if(opt.icon_countdown){class_name+=" hola_preview_icon_countdown";circle='<g><circle class="icon-progress" cx="-10" cy="5" '+'fill-opacity="0" r="'+r+'" stroke="#FFFFFF" stroke-dasharray="'+cir+'" stroke-dashoffset="0" stroke-width="'+stroke_width+'" transform="rotate(-90)"></circle></g>'}var svg='<svg viewBox="-20 -15 50 50">'+svg_shadow.replace("%id%","")+bg_circle+icon+circle+"</svg>";var elem=$('<div class="'+class_name+'">'+svg+"</div>");var pos_size=get_icon_pos_size({preview:this.preview,shadow:true,location:opt.icon_location,size:opt.icon_size,margin:opt.icon_margin});var pos=pos_size.pos;var top=pos_size.top;var left=pos_size.left;var size=pos_size.size;elem.css({width:size+"px",height:size+"px",top:pos.top+top+"px",left:pos.left+left+"px"});if(opt.on_countdown_cancel){var cancel=$('<span class="hola_preview_icon_cancel">'+(opt.countdown_cancel_string||"Cancel")+"</span>");cancel.on("click",function(e){e.stopImmediatePropagation();e.preventDefault();opt.on_countdown_cancel();_this.hide()});elem.append(cancel)}$(img).after(elem);this.elem=elem;if(opt.icon_countdown)this.rm_anim=requestAnimationFrame(this.update_countdown.bind(this))};Icon.prototype.hide=function(){if(!this.elem)return;if(this.rm_anim)this.rm_anim=cancelAnimationFrame(this.rm_anim);this.elem.remove();this.elem=null};Icon.prototype.update_countdown=function(ts){if(!this._countdown_ts)this._countdown_ts=ts;var elapsed=Math.min(1,(ts-this._countdown_ts)/this._countdown);this._update_countdown(elapsed);if(elapsed==1)return;this.rm_anim=requestAnimationFrame(this.update_countdown.bind(this))};Icon.prototype._update_countdown=function(val){if(!this.elem)return;var $circle=$(this.elem).find(".icon-progress");if(!$circle||!$circle.length)return;$circle.css("stroke-dashoffset",-val*this.cir)};function Duration(preview,opt){this.preview=preview;this.opt=assign({},this.preview.opt,opt);E.links.on("update_db",this.update.bind(this));preview.on("hover",this.hover.bind(this));preview.on("unhover",this.unhover.bind(this));this.update()}Duration.prototype.update=function(){this.duration=E.links.get_db([{url:this.preview.href}])[0].duration;if(this.duration)this.show();else this.hide()};Duration.prototype.show=function(){if(this.elem)return;var img=$(this.preview.img)[0],_this=this;if(img.width<2||img.naturalWidth<2){$(img).on("load",function on_load(){$(img).off("load",on_load);_this.show()});return}var text=date.ms_to_dur(this.duration*1e3).replace(/^00:/,"");var pos=this.preview.get_position(true);if(pos.width<(this.opt.duration_min_width||160))return;var elem=$("<div class=hola_preview_duration_container>"+"<div class=hola_preview_duration>"+text+"</div></div>");elem.css({top:pos.top+"px",left:pos.left+"px",width:pos.width+"px",height:pos.height+"px",transform:pos.transform});var outer_container;if(outer_container=this.preview.create_relative_container()){$(img).after(outer_container);$(outer_container).append(elem);elem.css({top:0,left:0});elem=$(outer_container)}else $(img).after(elem);this.elem=elem};Duration.prototype.hide=function(){if(!this.elem)return;this.elem.remove();this.elem=null};Duration.prototype.hover=function(){if(this.elem)$(this.elem).css("display","none")};Duration.prototype.unhover=function(){if(this.elem)$(this.elem).css("display","")};function get_mid_rect(check_x){var opt=E.conf.autoplay||{};var vp=util.visual_viewport();var mid_y=vp.top+vp.height/2,mid_x=vp.left+vp.width/2;var height=vp.height*(opt.area_height||10)/100;var width=check_x?vp.width*(opt.area_width||10)/100:vp.width;return{top:mid_y-height/2,left:mid_x-width/2,bottom:mid_y+height/2,right:mid_x+width/2,height:height,width:width}}function get_new_links(opt){$("iframe.hola_playlist").get().forEach(function(s){if($(s).prop("hola_ve_preview_added")||!E.styles)return;$(s).prop("hola_ve_preview_added",true);$(s.contentDocument.head).append("<style>"+E.styles+"</style>")});return E.links.get(opt).filter(function(l){if(l.no_video)return false;if(!l.force_video){if(l.root)return false;var href=$(l.link).attr("href");if(href&&href[0]=="#")return false}if($(l.link).hasClass("hola_preview_poster"))return false;return!$(l.link).prop("hola-video-preview-id")})}function get_previews(new_links,opt){if(!new_links.length)return;return etask([function(){var count=E.stats.inc("get_previews_n");if([5,10,20,50].indexOf(count)>-1)E.stats.inc("get_previews_over_"+count+"_n");E.stats.inc("get_previews_url_n",new_links.length);return E.links.get_previews(new_links,opt)},function(res){var data;if(!(data=res&&res.res))throw new Error("no links data");new_links.forEach(function(p){var preview=data[p.url]&&data[p.url].preview;var url_fail=function(reason){E.stats.inc("get_previews_url_fail_n");E.stats.inc("get_previews_url_fail_"+reason+"_n")};if(!preview)return void url_fail("processing");if(preview.error){url_fail(typeof preview.error!="string"?"unknown":/disconnected agent/.test(preview.error)?"disconnected_agent":preview.error.replace(/[^a-zA-Z0-9_]/g,"_"));log.notice("get_previews error: %s %s",preview.error,p.url)}previews_map[p.url]=preview});previews.forEach(function(p){p.update()});return{cdn:res.cdn}},function catch$(e){E.stats.inc("get_previews_fail_n");var msg=e.message||"unknown";log.notice("get_previews error: %s",msg);perr({id:"get_previews_error",err:msg})}])}function within(outer,inner){var o=outer.getBoundingClientRect();var i=inner.getBoundingClientRect();return i.left>=o.left&&i.top>=o.top&&i.right<=o.right&&i.bottom<=o.bottom}function mouse_within(el,ev){if(!ev||ev.type!="mousemove")return;var r=$(el)[0].getBoundingClientRect();if(r.top<0&&$(el).parents().filter(function(p){return $(p).css("position")=="sticky"}).length){return true}return ev.clientX<=r.right+3&&ev.clientX>=r.left-3&&ev.clientY<=r.bottom+3&&ev.clientY>=r.top-3}function update_links(opt){var nl=E.links.filter(get_new_links(opt),opt);etask([function(){return get_previews(nl,opt)},function(res){if(!res||!res.cdn)return;var _opt=assign({},opt,res);nl.forEach(function(l){if(l.text_link&&util.is_mobile)return;var p=new Preview(l,_opt);E.stats.add_preview(p);previews.push(p)});E.emit("has_previews")}])}function draw_debug_viewport(check_x){if(!E.conf.debug)return;var $viewport=$(".hola_preview_viewport_debug");if(!$viewport||!$viewport.length){$viewport=$("<div>");$viewport.addClass("hola_preview_debug hola_preview_viewport_debug");$(document.body).append($viewport)}var mid_rect=util.client_rect2page_rect(get_mid_rect(check_x));$viewport.css({top:mid_rect.top+"px",left:mid_rect.left+"px",width:mid_rect.width+"px",height:mid_rect.height+"px"})}function draw_debug_active(_uniq_id,active){if(E.conf.debug)$("#hola_preview_debug_"+_uniq_id).toggleClass("active",!!active)}function init_autoplay_on_scroll(opt){var in_middle;function play_preview(p){if(E.active_preview==p)return;cancel_autoplay();if(!p)return;E.active_preview=p;E.active_preview.on("loop_restart",play_next);E.active_preview.on("hide",cancel_autoplay);E.active_preview.on("error",play_next);E.active_preview.show(null,true)}function play_next(){if(!in_middle||in_middle.length<2)return;var _in_middle=in_middle.filter(function(p){return!p.was_error||p==E.active_preview});if(_in_middle.length<2)return;var index=_in_middle.indexOf(E.active_preview);index=++index%_in_middle.length;play_preview(_in_middle[index])}function cancel_autoplay(){if(E.active_preview){E.active_preview.off("loop_restart",play_next);E.active_preview.off("hide",cancel_autoplay);E.active_preview.off("error",play_next);E.active_preview.hide();E.active_preview=undefined}}var update=util.throttle(function(){if(opt.preload){previews.filter(function(p){if(p.in_viewport())video_cache.get(p.get_url(),opt,true)})}in_middle=previews.filter(function(p){return p.in_middle()});var is_area=E.conf.autoplay&&E.conf.autoplay.active_area;draw_debug_viewport(is_area);if(is_area){in_middle=in_middle.filter(function(p){return p.in_middle(is_area)})}if(E.active_preview&&in_middle.includes(E.active_preview))return;play_preview(in_middle[0])},300);if(util.is_mobile)$(window).on("orientationchange",update);$(window).on("scroll",update);if(window.visualViewport){window.visualViewport.addEventListener("scroll",update);window.visualViewport.addEventListener("resize",update)}if(opt.update_interval)setInterval(update,opt.update_interval);draw_debug_viewport(E.conf.autoplay&&E.conf.autoplay.active_area)}function init_random_autoplay(opt){var autoplay=function(){if(previews.some(function(p){return p.active&&!p.autoplay}))return;var curr=previews.filter(function(p){return p.in_viewport(true)});var rand=curr[Math.floor(Math.random()*curr.length)];previews.forEach(function(p){if(p==rand)p.show(null,true);else p.hide()})};var interval=opt.autoplay_interval||opt.autoplay.random_interval;setInterval(autoplay,interval*1e3);autoplay()}E.t={previews_map:previews_map,Preview:Preview,get_previews:get_previews,get_new_links:get_new_links};return E});
define("/svc/cdn/pub/watch_later.js",["cash","/util/es6_shim.js","/util/events.js","/util/util.js","/svc/cdn/pub/util.js","/util/conv.js","/util/url.js","/util/date.js","/util/sprintf.js","/util/etask.js","/util/storage.js"],function($,shim,events,zutil,util,conv,url,date,sprintf,etask,storage){var assign=Object.assign;var perr=util.cdn_perr,log={},id="watch_later";var _window=window;var _document=document;if(!window.location.href.match(/^https?:\/\/holaspark\.com\//)){try{_window=window.top||window;_document=_window.document}catch(e){_window=window;_document=document}}var E={};E.players=[];function describe_interval(_ms){var ms=date.ms;if(_ms<2*ms.MIN)return sprintf(E.conf.strings.time_ago.sec,Math.round(_ms/ms.SEC));if(_ms<2*ms.HOUR)return sprintf(E.conf.strings.time_ago.min,Math.round(_ms/ms.MIN));if(_ms<2*ms.DAY)return sprintf(E.conf.strings.time_ago.hour,Math.round(_ms/ms.HOUR));if(_ms<2*ms.WEEK)return sprintf(E.conf.strings.time_ago.day,Math.round(_ms/ms.DAY));if(_ms<2*ms.MONTH)return sprintf(E.conf.strings.time_ago.week,Math.round(_ms/ms.WEEK));if(_ms<2*ms.YEAR){return sprintf(E.conf.strings.time_ago.month,Math.round(_ms/ms.MONTH))}return sprintf(E.conf.strings.time_ago.year,Math.round(_ms/ms.TEAR))}function time_ago(d){var _ms=date.get()-date.get(d);if(_ms<date.ms.SEC)return E.conf.strings.time_ago.now;return describe_interval(_ms)}zutil.inherits(Storage,events.EventEmitter);function Storage(){}Storage.prototype.init=etask._fn([function(_this){this.storage=_this;return _this.resync()},function(){var _this=this.storage;util.on("beforeunload",etask.fn([function(){return _this.resync()},function(){_this.save_local()}]))}]);Storage.prototype.resync=etask._fn([function(_this){this.storage=_this;return E.msg.get_storage()},function(cache){var _this=this.storage;try{_this.data=zutil.extend_deep(conv.JSON_parse(cache)||{},_this.data)}catch(e){_this.data={}}_this.data.items=_this.data.items||{};for(var k in _this.data.items){if(_this.data.items[k].synced===false)_this.sync_data(_this.data.items[k])}}]);Storage.prototype.save_local=function(){if(!E.msg.is_master()||window.top!=window&&!window.location.href.match(/^https?:\/\/holaspark\.com\//)){E.msg.send_req(E.msg.master?E.msg.master:{frame:window.top},"set_storage",{args:[conv.JSON_stringify(this.data)]});return}_window.localStorage.setItem("hola_watch_later_storage",conv.JSON_stringify(this.data))};Storage.prototype.get=function(u){var d=this.data.items[u]&&assign({},this.data.items[u])||{};d.synced="synced"in d?d.synced:true;return d};Storage.prototype.set=etask._fn([function(_this,u,data){this.storage=_this;this.url=u;this.data=data;return _this.resync()},function(){var _this=this.storage,u=this.url,data=this.data;data.valid=true;data.synced=false;data.updated_at=Date.now();_this.data.items[u]=assign({},data);_this.data.updated_at=Date.now();_this.save_local();_this.emit("set",{url:u,data:_this.get(data.url)});_this.sync_data(data)}]);Storage.prototype.sync_data=function(data){var _this=this;if(!this.data.items[data.url])this.data.items[data.url]={};setTimeout(function(){_this.data.items[data.url].synced=true;_this.emit("set",{url:data.url,data:_this.get(data.url)})},650)};Storage.prototype.remove=etask._fn([function(_this,u){this.storage=_this;this.url=u;return _this.resync()},function(){var _this=this.storage,u=this.url;delete _this.data.items[u];_this.data.updated_at=Date.now();_this.save_local();_this.emit("set",{url:u})}]);Storage.prototype.size=function(){return Object.keys(this.data.items).length};Storage.prototype.reset=function(){delete this.data;this.resync()};zutil.inherits(VideoLink,events.EventEmitter);function VideoLink(elem){this.elem=elem;this.adder=new Adder(elem,false,E.conf.video_link_icon,this.get_link_data.bind(this));$(elem).on("mouseover",this.on_mouse_over.bind(this))}VideoLink.prototype.on_mouse_over=function(){this.adder.show();var _this=this;var data=this.get_link_data();var mouse_move_fn=function(event){if(_this.elem==event.target||$(_this.elem).has(event.target).length)return;var hpc=$(event.target).closest(".hola_preview_container").get(0);if(hpc&&hpc.hola_preview.href==data.url){_this.adder.update_position(hpc);return}if(event.target==_this.adder.btn)return;$(document).off("mousemove",mouse_move_fn);_this.on_mouse_out(event)};$(document).on("mousemove",mouse_move_fn)};VideoLink.prototype.on_mouse_out=function(event){this.adder.hide()};VideoLink.prototype._$=function(selector){return $(this.elem).find(selector)};VideoLink.prototype.get_sel_val=function(selector,attr){if(typeof selector=="function")return selector(this._$.bind(this));var el=this._$(selector).get(0);if(!el)return;return el[attr]};VideoLink.prototype.get_link_data=function(){var u=this.get_sel_val(E.conf.selectors.video_links.url,"href");var img=this.get_sel_val(E.conf.selectors.video_links.img,"src");var title=this.get_sel_val(E.conf.selectors.video_links.title,"innerText");if(!title){var a=$(this.elem).find("a").get(0);if(a)title=a.getAttribute("title")}return{url:u,img:img,title:title}};VideoLink.init=function(){var selector=E.conf.selectors.video_links.item;function get_new_items(){var sel=typeof selector=="function"?selector($):$(selector).get();return sel.filter(function(elem){return!$(elem).prop("hola-watch-later")})}function update_links(){var items=get_new_items();items.forEach(function(elem){$(elem).prop("hola-watch-later",true);new VideoLink(elem)});setTimeout(update_links,5e3)}update_links()};function is_home_page(p){var base_path=E.conf.base_path||[];if(base_path.constructor!=Array)base_path=[base_path];return base_path.find(function(path){if(path&&path.constructor==RegExp)return path.test(p);return p==path})}zutil.inherits(Notification,events.EventEmitter);function Notification(){this.video_items=[]}Notification.init=function(){var n;function u2p(u){return url.get_path(url.qs_strip(u))}return function(force){if(!E.storage.size()||!E.msg.is_master())return;var prev_page=_window.localStorage.getItem("watch_later_last_page");var cur_page=window.location.href;_window.localStorage.setItem("watch_later_last_page",cur_page);if(!force){var p=u2p(cur_page);if(!is_home_page(p))return;var is_refresh=u2p(prev_page)==u2p(cur_page);var last_shown=_window.localStorage.getItem("watch_later_last_shown");if(typeof E.conf.url_equals=="function")is_refresh=E.conf.url_equals(cur_page,prev_page);if(is_refresh){if(E.conf.show_on_refresh=="skip")return;if(E.conf.show_on_refresh=="timeout"){if(Date.now()-parseInt(last_shown)<E.conf.refresh_timeout*1e3){return}}}}if(!n||!n.active){n=new Notification;n.draw()}return true}}();Notification.prototype.draw=function(){E.stats_inc("small_roaster_n");var wrapper=document.createElement("div");$(wrapper).addClass("watch_later_notification_wrapper");$(wrapper).addClass("watch_later_notification_wrapper_"+E.conf.notification_pos);var div=document.createElement("div");$(div).addClass("watch_later_notification");var btn_hide=document.createElement("div");$(btn_hide).addClass("watch_later_notification_btn_hide");$(btn_hide).attr("data-hola-tooltip",E.conf.strings.hide);var icon=document.createElement("div");$(icon).addClass("watch_later_notification_icon");$(icon).attr("data-hola-tooltip",E.conf.strings.saved_videos);$(icon).on("click",this.show_list.bind(this));$(div).append(icon);$(div).append(btn_hide);$(wrapper).append(div);$(document.body).append(wrapper);this.wrapper=wrapper;this.div=div;var _this=this;var ul=document.createElement("ul");this.append_items(ul);$(div).append(ul);$(div).on("click",function(event){if(event.target!==div)return;_this.show_list()});$(btn_hide).one("click",function(event){event.preventDefault();event.stopPropagation();_this.hide()});var check_hide_fn=function(event){if(event.target==wrapper||event.target.id=="pg_show_watch_later"||$(wrapper).has(event.target).length){return}$(document).off("click",check_hide_fn);_this.hide()};$(document).on("click",check_hide_fn);this.active=true;_window.localStorage.setItem("watch_later_last_shown",Date.now());E.links.scan()};Notification.prototype.append_items=function(ul){var items=E.storage.data.items,i=0;for(var k in items){var vi=new VideoItem(ul,items[k],{type:"small"});this.video_items.push(vi);vi.on("url_changed",this.hide.bind(this));if(3==++i)break}E.stats_inc("small_roaster_items_n",i);if(Object.keys(E.storage.data.items).length<=3)return;var li=document.createElement("li");$(li).addClass("watch_later_notification_more");li.innerHTML="&#10140;";$(li).on("click",this.show_list.bind(this));ul.appendChild(li)};Notification.prototype.hide=function(){if(!this.active)return;this.active=false;$(this.div).addClass("watch_later_notification_hide");this.video_items=[];var _this=this;setTimeout(function(){$(_this.wrapper).remove()},1200)};Notification.prototype.show_list=function(){VideoList.init();this.hide()};zutil.inherits(VideoList,events.EventEmitter);VideoList.init=function(){new VideoList};function VideoList(){this.items=E.storage.data.items;this.video_items=[];this.draw()}VideoList.prototype.draw=function(){E.stats_inc("big_roaster_n");var wrapper=document.createElement("div");var div=document.createElement("div");var ul=document.createElement("ul");var heading=document.createElement("div");var close=document.createElement("div");var h4=document.createElement("h4");var h5=document.createElement("h5");$(wrapper).addClass("watch_later_list_wrapper");$(div).addClass("watch_later_list");$(heading).addClass("watch_later_list_heading");$(close).addClass("watch_later_list_close");$(ul).addClass("watch_later_list_list");heading.appendChild(h4);heading.appendChild(h5);div.appendChild(close);div.appendChild(heading);for(var k in this.items){var vi=new VideoItem(ul,this.items[k]);this.video_items.push(vi);vi.on("remove",function(){_this.update_heading()});vi.on("url_changed",this.close.bind(this));E.stats_inc("big_roaster_items_n")}div.appendChild(ul);wrapper.appendChild(div);document.body.appendChild(wrapper);var _this=this;this.wrapper=wrapper;this.div=div;this.h4=h4;this.h5=h5;this.update_heading();$(wrapper).on("click",function(event){if(event.target==wrapper)_this.close()});$(close).on("click",function(){_this.close()});this.update_items_height();E.links.scan()};VideoList.prototype.update_heading=function(){this.items=E.storage.data.items;this.h4.innerHTML=E.conf.strings.list_heading_title;this.h5.innerHTML=sprintf(E.conf.strings.list_heading_stats,Object.keys(this.items).length,time_ago(E.storage.data.updated_at))};VideoList.prototype.update_items_height=function(){var w=$(this.video_items[0].li).width();this.video_items.forEach(function(item){item.li.style.cssText="height: "+Math.round(w+w*.1)+"px;"})};VideoList.prototype.close=function(fast){if(fast)return void $(this.wrapper).remove();$(this.div).addClass("watch_later_list_hide");this.video_items=[];var _this=this;setTimeout(function(){$(_this.wrapper).remove()},1200)};zutil.inherits(VideoItem,events.EventEmitter);function VideoItem(parent,item,opt){var _this=this;this.item=item;this.opt=opt||{};var li=document.createElement("li");$(li).addClass("watch_later_list_item");var a=document.createElement("a");a.href=item.url;a.target="_self";$(a).on("click",function(){E.stats_inc(_this.opt.type=="small"?"small_roaster_link_followed_n":"big_roaster_link_followed_n");_this.emit("url_changed")});this.img=document.createElement("img");this.img.src=item.img;var div=document.createElement("div");$(div).addClass(this.opt.type=="small"?"watch_later_list_img_container_small":"watch_later_list_img_container");div.appendChild(this.img);a.appendChild(div);if(this.opt.type!="small"){var h5=document.createElement("h5");h5.innerHTML=item.title;a.appendChild(h5)}li.appendChild(a);var close=document.createElement("div");if(this.opt.type!="small")close.setAttribute("data-hola-tooltip",E.conf.strings.remove_item);$(close).addClass("watch_later_list_item_close");$(close).on("click",this.remove.bind(this));li.appendChild(close);if(this.opt.type=="small"){$(li).attr("data-hola-tooltip",sprintf(E.conf.strings.nt_title,(item.title||"").replace(/\s+$/g,""))+"\n"+sprintf(E.conf.strings.nt_date,time_ago(item.updated_at)))}parent.appendChild(li);this.li=li;if(this.opt.type!="small")this.readjust_size()}VideoItem.prototype.remove=function(){E.storage.remove(this.item.url);$(this.li).addClass("watch_later_list_item_hide");var _this=this;setTimeout(function(){$(_this.li).remove()},300);this.emit("remove");E.stats_inc(this.opt.type=="small"?"small_roaster_link_removed_n":"big_roaster_link_removed_n")};VideoItem.prototype.readjust_size=function(){var _this=this;setTimeout(function check_size(){if(_this.img.naturalWidth&&_this.img.naturalHeight){if(_this.img.naturalHeight>_this.img.naturalWidth)$(_this.img).addClass("watch_later_item_horiz_img");return}setTimeout(check_size,100)},100)};function offset_parent(elem){var res=null,cur_elem=$(elem).parent();while(!res&&cur_elem[0].tagName!="HTML"){if(["relative","absolute","fixed"].includes(cur_elem.css("position"))){res=cur_elem.offset()}cur_elem=cur_elem.parent()}return res}function position(elem){var parent_offset=offset_parent(elem);if(!parent_offset)parent_offset={left:0,top:0};var elem_offset=$(elem).offset();return{left:elem_offset.left-parent_offset.left,top:elem_offset.top-parent_offset.top}}zutil.inherits(Adder,events.EventEmitter);function Adder(elem,is_video,opt,get_data_fn){this.opt=assign({},E.conf.video_icon,opt);this.elem=elem;this.is_video=is_video;this.pos_elem=!is_video&&$(elem).find("img").get(0)||elem;this.btn_width=this.opt.width;this.btn_height=this.opt.height;this.get_data_fn=get_data_fn;this.click_fn=this.click.bind(this);this.show_tooltip_fn=this.show_tooltip.bind(this);this.hide_tooltip_fn=this.hide_tooltip.bind(this);this.on_storage_update_fn=this.on_storage_update.bind(this);E.storage.on("set",this.on_storage_update_fn);this.render_button();E.stats_inc(is_video?"video_n":"link_n")}Adder.prototype.show_tooltip=function(){this.hide_tooltip();var div=document.createElement("div");$(div).attr("data-hola-tooltip",$(this.btn).attr("data-hola-tooltip-ext"));$(div).attr("data-hola-tooltip-visible","1");var pos=this.opt.tooltip_position;if(pos=="auto")pos=this.opt.position.includes("l")?"right":"left";$(div).addClass("tooltip-"+pos);$(div).css({position:"absolute",left:$(this.btn).offset().left+"px",top:$(this.btn).offset().top+"px",width:$(this.btn).width()+"px",height:$(this.btn).height()+"px","pointer-events":"none","z-index":this.opt.z_index});document.body.appendChild(div);this.tooltip=div};Adder.prototype.hide_tooltip=function(){if(!this.tooltip)return;$(this.tooltip).remove();this.tooltip=null};Adder.precache=function(){var paths={add:"//player.h-cdn.com"+require.zdot("watch_later_add_svg"),wait:"//player.h-cdn.com"+require.zdot("watch_later_wait_gif"),done:"//player.h-cdn.com"+require.zdot("watch_later_done_svg")};for(var k in paths){Adder[k+"_icon"]=new Image;Adder[k+"_icon"].src=paths[k]}};Adder.prototype.detach=function(){E.storage.off("set",this.on_storage_update_fn);$(this.btn).off("click",this.click_fn);$(this.btn).off("touchstart",this.click_fn);$(this.btn).off("mouseover",this.show_tooltip_fn);$(this.btn).off("mouseout",this.hide_tooltip_fn)};Adder.prototype.on_storage_update=etask._fn([function(_this,args){this.adder=_this;this.su_args=args;return _this.get_data_fn()},function(data){var _this=this.adder,args=this.su_args;if(args.url!=data.url)return;return _this.update_state()}]);Adder.prototype.click=function(event){var _this=this;event.preventDefault();event.stopPropagation();etask([function(){return _this.get_status()},function(status){if(status!="miss")return;return _this.save()}])};Adder.prototype.save=etask._fn([function(_this){this.is_video=_this.is_video;log.debug_spark("updating site data...");return _this.get_data_fn()},function(data){if(!data.img){perr({id:"watch_later_empty_poster",info:{link_title:data.title,link_url:data.url},delay:false,use_beacon:true})}log.debug_spark("storing watch later data...");E.storage.set(data.url,data);E.stats_inc(this.is_video?"video_saved_n":"link_saved_n")}]);Adder.prototype.render_button=etask._fn([function(_this){this.adder=_this;_this.btn=document.createElement("div");$(_this.btn).css("cssText","width: "+_this.btn_width+"px !important;"+"height: "+_this.btn_height+"px !important");$(_this.btn).css({position:"absolute",cursor:"pointer","border-radius":"2px",display:"none","z-index":_this.opt.z_index,"pointer-events":"all"});$(_this.elem).parent().append(_this.btn);return _this.update_state()},function(){var _this=this.adder;$(_this.btn).on("click",_this.click_fn);$(_this.btn).on("touchstart",_this.click_fn);$(_this.btn).on("mouseover",_this.show_tooltip_fn);$(_this.btn).on("mouseout",_this.hide_tooltip_fn)}]);Adder.prototype.update_position=function(pos_elem){if(!$(this.elem).parent().length)return;pos_elem=pos_elem||this.pos_elem;if($(pos_elem).css("transform")!="none")pos_elem=$(pos_elem).parent();var css={};var pos=position(this.elem);var dpos={left:$(pos_elem).offset().left-$(this.elem).offset().left,top:$(pos_elem).offset().top-$(this.elem).offset().top};pos={left:pos.left+dpos.left,top:pos.top+dpos.top};if(this.opt.position=="tr"){var off=this.opt.hola_player?this.opt.hola_player.share_btn_size+this.opt.margin.x:0;assign(css,{top:pos.top+this.opt.margin.y+"px",left:pos.left+$(pos_elem).width()-this.btn_width-this.opt.margin.x-off+"px"})}else if(this.opt.position=="br"){assign(css,{top:pos.top+$(pos_elem).height()-this.btn_height-this.opt.margin.y+"px",left:pos.left+$(pos_elem).width()-this.btn_width-this.opt.margin.x+"px"})}else if(this.opt.position=="tl"){assign(css,{top:pos.top+this.opt.margin.y+"px",left:pos.left+this.opt.margin.x+"px"})}else if(this.opt.position=="bl"){assign(css,{top:pos.top+$(pos_elem).height()-this.btn_height-this.opt.margin.y+"px",left:pos.left+this.opt.margin.x+"px"})}$(this.btn).css(css)};Adder.prototype.get_status=etask._fn([function(_this){return _this.get_data_fn()},function(data){var stored=E.storage.get(data.url);return stored.valid?stored.synced?"stored":"progress":"miss"}]);Adder.prototype.update_state=etask._fn([function(_this){this.adder=_this;return _this.get_status()},function(status){var _this=this.adder;var icon=status=="miss"?Adder.add_icon.src:status=="progress"?Adder.wait_icon.src:Adder.done_icon.src;$(_this.btn).css({background:"url("+icon+") no-repeat","background-size":"contain"});$(_this.btn).addClass("watch_later_adder");$(_this.btn).attr("data-hola-tooltip-ext",E.conf.strings["icon_"+(status=="miss"?"add":status=="stored"?"done":"progress")]);if(_this.tooltip){$(_this.tooltip).attr("data-hola-tooltip",$(_this.btn).attr("data-hola-tooltip-ext"))}}]);Adder.prototype.hide=function(){$(this.btn).css({display:"none"})};Adder.prototype.show=etask._fn([function(_this){this.adder=_this;return _this.get_status()},function(status){this.adder_status=status;if(status!="miss")return;return this.adder.update_state()},function(){var _this=this.adder;if(this.adder_status!="miss")return;_this.update_position();$(_this.btn).css({display:"block"})}]);zutil.inherits(Player,events.EventEmitter);function Player(_loader){if(!(this instanceof Player))return new Player(_loader);this._loader=_loader;this.attached=false}Player.prototype.monitor_playback=function(){var _this=this;var timeout=Math.max(Math.min(E.conf.delay/10,500),100);function check_reqs(){if(!_this.attached)return;if(_this.adder)_this.adder.update_position();_this.monitor_playback_id=setTimeout(check_reqs,timeout)}this.monitor_playback_id=setTimeout(check_reqs,timeout)};function get_og_image(){var meta_img;var w=window,pw=window.top||window;while(1){try{meta_img=$(w.document).find('meta[property="og:image"]').get(0)}catch(e){return}if(meta_img||w==pw)break;w=w.parent}if(meta_img)return meta_img.content}Player.prototype.get_assoc_img=function(container){var urls=$(container).find(E.conf.selectors.player.img).get().filter(function(el){if(el.tagName=="DIV"&&!el.style.backgroundImage)return false;return true}).map(function(el){if(el.tagName=="DIV"){var res=/url\(('([^)]+)'|"([^)]+)"|([^)]+))\)/gi.exec(el.style.backgroundImage);return res&&(res[2]||res[3]||res[4])}return el.src}).filter(function(u){return!!u});if(urls.length)return urls[0]};function get_container(container){return $(container).closest(E.conf.selectors.player.container)}function get_poster(container,controls){var $container=$(container);var poster_attr="hola_spark_poster_url";var poster=$container.attr(poster_attr)||$container.find("["+poster_attr+"]").eq(0).attr(poster_attr);if(poster)return poster;poster=$(controls.html5).attr("poster");if(poster&&poster.startsWith("data:image"))return null;return poster}Player.prototype.get_link_data=etask._fn([function(_this){this.player=_this;if(E.conf.extract_title_func){try{var fn=new Function("$",E.conf.extract_title_func);return fn($)}catch(e){log.err("invalid extract_title_func function: "+(e&&e.toString())||"JS Error")}}return E.msg.get_title()},function(title){this.data={title:title};return E.msg.get_location_href()},function(_url){this.data=assign(this.data,{url:_url});return E.msg.get_og_image()},function(img){this.data=assign(this.data,{img:img});var container=get_container(this.player.controls.get_container());var poster=get_poster(container,this.player.controls);var poster_img=poster||this.data.img||this.player.get_assoc_img(container);this.data.img=poster_img;return this.data}]);Player.prototype._attach=function(controls){this.before_unload=this.detach.bind(this);util.on("beforeunload",this.before_unload);this.controls=controls;this.attached=true;log.debug_spark("attached to "+this.controls.name+" "+this.controls.player_id);this.monitor_playback();this.player_state_changed_fn=this.player_state_changed.bind(this);this.video_finished_fn=this.video_finished.bind(this);var _this=this;etask([function(){if(E.msg.is_master())return;var et=this;this.st=setTimeout(function(){E.msg.reset_master();et.st=null;log.debug_spark("master doesn't answer");et.continue()},1e3);return E.msg.ping()},function(){if(this.st)clearTimeout(this.st);var container=get_container(controls.get_container());var adder_opt={};if(controls.name=="hola"){var share_btn=$(container).find(".vjs-share-button");if(share_btn.length){var share_btn_size=share_btn.width();adder_opt.hola_player={share_btn_size:share_btn_size}}}_this.adder=new Adder(container,true,adder_opt,_this.get_link_data.bind(_this));_this.mouse_over_fn=_this.on_mouse_over.bind(_this);_this.mouse_out_fn=_this.on_mouse_out.bind(_this);$(container).on("mouseover",_this.mouse_over_fn);$(container).on("mouseout",_this.mouse_out_fn);_this.controls.on("state",_this.player_state_changed_fn);_this.player_state_changed();return _this.restore_video()},function catch$(e){console.log("watch later error",e)}])};Player.prototype.restore_video=etask._fn([function(_this){this.player=_this;return E.msg.get_location_href()},function(_url){var _this=this.player;var data=E.storage.get(_url);if(!data.valid)return;log.debug_spark("stored data found, restoring video");if(!_this.controls.is_playing()){log.debug_spark("starting playing");_this.controls.play()}log.debug_spark("removing data from storage");return E.storage.remove(_url)}]);Player.prototype.detach=function(){if(!this.attached)return;log.debug_spark("detach from "+this.controls.name+" "+this.controls.player_id);this.attached=false;if(this.monitor_playback_id)this.monitor_playback_id=clearTimeout(this.monitor_playback_id);if(this.adder)this.adder.detach();if(this.controls){$(get_container(this.controls.get_container())).off("mouseover",this.mouse_over_fn)}this.controls.off("state",this.video_state_changed_fn);this.emit("detach");util.off("beforeunload",this.before_unload)};Player.prototype.is_video_allowed=function(){return E.spark.check_url(this.controls.get_url(),E.conf.video_url)};Player.prototype.on_mouse_over=function(event){if(!this.controls||this.controls.media_type=="audio"||this.controls.is_playing()&&!E.conf.show_when_playing||this.controls.is_any_ad_mode()||!this.is_video_allowed()){return}this.show_watch_later()};Player.prototype.on_mouse_out=function(event){if(E.conf.show_when_playing&&this.controls&&this.controls.is_playing()){this.hide_watch_later()}};Player.prototype.player_state_changed=function(){if(this.player_state_changed_t){clearTimeout(this.player_state_changed_t);delete this.player_state_changed_t}if(this.controls.is_any_ad_mode()||!this.is_video_allowed()||this.controls.media_type=="audio"){this.hide_watch_later();return}if(!this.controls.is_playing()){var _this=this;this.player_state_changed_t=setTimeout(function(){_this.show_watch_later()},E.conf.delay);return}if(!E.conf.persistent&&!E.conf.show_when_playing)this.hide_watch_later();if(E.conf.persistent)this.show_watch_later()};Player.prototype.video_finished=function(){if(this.player_state_changed_t){clearTimeout(this.player_state_changed_t);delete this.player_state_changed_t}this.hide_watch_later()};Player.prototype.show_watch_later=function(){if(!this.adder)return;this.adder.show()};Player.prototype.hide_watch_later=function(){if(!this.adder)return;this.adder.hide()};Player.prototype.attach=function(hola_player){var event_complete=this.emit.bind(this,"video_finished");hola_player.on("ended",event_complete);this._attach(hola_player)};function ignore_player(container){if(!E.conf.ignore_player_func)return false;try{var fn=new Function("$","container",E.conf.ignore_player_func);return fn($,container)}catch(e){log.err("invalid ignore_player_func function: "+(e&&e.toString())||"JS Error")}}E.attach_player=function(wrapper){var c=get_container(wrapper.player.get_container());if(ignore_player(c))return;var player=new Player(E);E.players.push(player);player.attach(wrapper.player)};E.detach_player=function(wrapper){var c=wrapper.player.get_container();var p,i;for(i=0;!p&&i<E.players.length;i++){if(c==E.players[i].controls.container)p=E.players[i]}if(p){p.detach();E.players.splice(i-1,1)}};function preload_css(){var css=document.createElement("link");css.rel="stylesheet";css.href="//player.h-cdn.com"+require.zdot("watch_later_css");document.head.appendChild(css);if(E.conf.extra_css_fn){var styles=util.get_stylesheet(E.conf.extra_css_fn());$("head").append("<style>"+styles+"</style>")}}function setup_msg_handlers(){E.msg.add_handler("ping",function(){},{exec_on_self:true});E.msg.add_handler("get_title",function(){return document.title},{exec_on_self:true});E.msg.add_handler("get_og_image",function(){return get_og_image()},{exec_on_self:true});E.msg.add_handler("get_location_href",function(){return _window.location.href},{exec_on_self:true});E.msg.add_handler("get_storage",function(){return _window.localStorage.getItem("hola_watch_later_storage")},{exec_on_self:true});E.msg.add_handler("set_storage",function(cache){_window.localStorage.setItem("hola_watch_later_storage",cache);E.storage.reset()},{exec_on_self:true})}E.default_conf={strings:{remove_item:"Remove",list_heading_title:"Videos you saved",list_heading_stats:"%d videos | Updated %s",icon_add:"Watch later",icon_progress:"Adding",icon_done:"Added",saved_videos:"Saved videos",hide:"Hide",nt_title:"%s",nt_date:"saved: %s",time_ago:{now:"right now",sec:"%d sec ago",min:"%d min ago",hour:"%d hours ago",day:"%d days ago",week:"%d weeks ago",month:"%d months ago",year:"%d years ago"}},selectors:{video_links:{item:"article.has-video",url:"a",img:"img",title:".title"},player:{container:"*",img:"img, div"}},video_link_icon:{position:"br",margin:{x:4,y:4},width:22,height:22},video_icon:{position:"tr",tooltip_position:"auto",margin:{x:10,y:10},width:40,height:40,z_index:2147483647},notification_pos:"mid",base_path:["/"],extra_css_fn:false,delay:500,persistent:false};E.init=etask.fn([function(spark){E.spark=spark;E.links=spark.links;log=E.spark.log(id);E.conf=zutil.defaults_deep(E.spark.conf[id],E.default_conf);E.msg=new E.spark.Msg("wl",{cross_domain_master_only:true});setup_msg_handlers();preload_css();Adder.precache();E.stats_inc=function(s,v){spark.stats.inc(id+"_"+s,v)};E.stats_inc("init_n");E.storage=new Storage;return E.storage.init()},function(){VideoLink.init();Notification.init();E.spark.on_wrapper_attached(E.attach_player);E.spark.on_wrapper_detached(E.detach_player);E.spark.players.forEach(function(p){E.attach_player(p.wrapper)});E.spark.loader.watch_later={show_popup:function(){return Notification.init(true)}};E.inited=true;log.debug_spark("inited")}]);return E});
define("json_stable_stringify",[],function(){var json=JSON;var E=function(obj,opts){if(!opts)opts={};if(typeof opts==="function")opts={cmp:opts};var space=opts.space||"";if(typeof space==="number")space=Array(space+1).join(" ");var cycles=typeof opts.cycles==="boolean"?opts.cycles:false;var replacer=opts.replacer||function(key,value){return value};var cmp=opts.cmp&&function(f){return function(node){return function(a,b){var aobj={key:a,value:node[a]};var bobj={key:b,value:node[b]};return f(aobj,bobj)}}}(opts.cmp);var seen=[];return function stringify(parent,key,node,level){var indent=space?"\n"+new Array(level+1).join(space):"";var colonSeparator=space?": ":":";if(node&&node.toJSON&&typeof node.toJSON==="function"){node=node.toJSON()}node=replacer.call(parent,key,node);if(node===undefined){return}if(typeof node!=="object"||node===null){return json.stringify(node)}if(Array.isArray(node)){var out=[];for(var i=0;i<node.length;i++){var item=stringify(node,i,node[i],level+1)||json.stringify(null);out.push(indent+space+item)}return"["+out.join(",")+indent+"]"}else{if(seen.indexOf(node)!==-1){if(cycles)return json.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else seen.push(node);var keys=Object.keys(node).sort(cmp&&cmp(node));var out=[];for(var i=0;i<keys.length;i++){var key=keys[i];var value=stringify(node,key,node[key],level+1);if(!value)continue;var keyValue=json.stringify(key)+colonSeparator+value;out.push(indent+space+keyValue)}seen.splice(seen.indexOf(node),1);return"{"+out.join(",")+indent+"}"}}({"":obj},"",obj,0)};return E});
define("/svc/cdn/pub/zone_match.js",["json_stable_stringify"],function(json_stable_stringify){var matchers={url:function url(opt,match){return new RegExp(match.url).test(opt.url)},url_or_frame:function url_or_frame(opt,match){var re=new RegExp(match.url);return re.test(opt.url)||re.test(opt.frame_url)},frame_url:function frame_url(opt,match){return opt.frame_url&&new RegExp(match.frame_url).test(opt.frame_url)},no_mse:function no_mse(opt,match){return match.no_mse?!!opt.no_mse:false},no_h264:function no_h264(opt,match){return match.no_h264?!!opt.no_h264:false},player_n:function player_n(opt,match){return match.player_n?match.player_n==opt.player_n:true},video_check_n:function video_check_n(opt,match){return match.video_check_n?match.video_check_n==opt.video_check_n:true},video_url:function video_url(opt,match){return new RegExp(match.video_url).test(opt.video_url)},browser:function browser(opt,match){if(typeof match.browser=="string")return match.browser=="*"||opt.browser==match.browser;return match.browser.includes(opt.browser)},os:function os(opt,match){return match.os.includes(opt.os)},rand:function rand(opt,match){return opt.random<opt.rand_percent},country:function country(opt,match){var whitelisted,blacklisted;if(match.country.include&&match.country.include.length)whitelisted=match.country.include.includes(opt.country);else whitelisted=true;if(match.country.exclude&&match.country.exclude.length)blacklisted=!match.country.exclude.includes(opt.country);else blacklisted=true;return whitelisted&&blacklisted},hours:function hours(opt,match){if(!opt.date)return true;var day_msec=24*3600*1e3;var current_date=+opt.date;return!!match.hours.find(function(time){var from=time.from.split(":");var date_from=new Date(current_date);date_from.setUTCHours(from[0],from[1],0,0);date_from=+date_from;var to=time.to.split(":");var date_to=new Date(current_date);date_to.setUTCHours(to[0],to[1],0,0);date_to=+date_to;if(date_to<date_from){if(current_date<date_to)date_from-=day_msec;else date_to+=day_msec}return current_date>=date_from&&current_date<date_to})},tech:function tech(opt,match){return!opt.player||!opt.player.tech||opt.player.tech==match.tech}};function parse_rules(rules){var result={browser:[],os:[]};if(!rules||!rules.length)return result;function set_value(rule_value,list){if(!result[list])return;if(rule_value=="*"){result[list]=false;return}if(rule_value&&result[list].indexOf(rule_value)==-1)result[list].push(rule_value)}rules.forEach(function(rule){set_value(rule.browser,"browser");set_value(rule.os,"os")});if(!result.browser)result.browser=[];if(!result.os)result.os=[];return result}function make_match_fn(match,opt){opt=opt||{};var full_match=opt.full_match;var use_or=opt.use_or;var criterias=[];if(match.zone!="gen"&&match.rules){var parsed_rules=parse_rules(match.rules);match.browser=parsed_rules.browser;match.os=parsed_rules.os}for(var name in matchers){var match_opt=match[name];if(name=="rand"&&match_opt==0)return"return false;";if(typeof matchers[name]!="function"||!match_opt)continue;if(Array.isArray(match_opt)){if(!match_opt.length)continue;if(["url","frame_url","video_url"].includes(name)){match_opt=match_opt.filter(String);if(!match_opt.length)continue;if(match_opt.length==1)match_opt=match[name]=match_opt[0];else match_opt=match[name]="("+match_opt.join(")|(")+")"}}if(name=="country"&&(!match_opt.exclude||!match_opt.exclude.length)&&(!match_opt.include||!match_opt.include.length)){continue}criterias.push(name)}if(!criterias.length)return"return false;";var match_var=full_match?match:criterias.reduce(function(r,c){return r[c]=match[c],r},{});if(match_var.country){if(!match_var.country.include)match_var.country.include=[];if(!match_var.country.exclude)match_var.country.exclude=[]}var url_idx;if(match.allow_frame_match&&(url_idx=criterias.indexOf("url"))!=-1)criterias[url_idx]="url_or_frame";var fn_body="";var mse_h264=criterias.indexOf("no_mse")>-1&&criterias.indexOf("no_h264")>-1;if(mse_h264)fn_body+="(no_mse(opt, match) || no_h264(opt, match)) && ";fn_body+=criterias.map(function(c){if(mse_h264&&(c=="no_mse"||c=="no_h264"))return"true";return c+"(opt, match)"}).join(use_or?" || ":" && ");return"var match = "+json_stable_stringify(match_var)+";\n"+criterias.map(function(c){return(""+matchers[c]).replace(/\n?\n?/,"")}).join("\n")+"\nreturn "+fn_body+";"}return{make_fn:make_match_fn}});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,["/util/util.js","/util/date.js","/util/url.js",null,"/svc/cdn/pub/util.js",null,"/util/conv.js"],fn)}}define("/svc/cdn/pub/zone.js",["/util/util.js","/util/date.js","/util/url.js","/svc/cdn/pub/zone_match.js","/svc/cdn/pub/util.js","/svc/cdn/pub/log.js","/util/conv.js"],function(zutil,date,zurl,zone_match,util,_log,conv){var E=Zone,assign=Object.assign;var random;function reset_random(set){random=set||undefined}function select_zone(zones,opt){function storage_zone(){try{return window.sessionStorage.getItem("hola_zone")||localStorage.getItem("hola_zone")}catch(err){}}function is_selected(zone){var match=zone.loader?zone.loader.match:zone.match;if(!match||!Object.keys(match).length||zone.kw.disabled||zone.kw.hidden){return}var geoip=util.geoip||{};var current_date=typeof geoip.date_skew=="number"?date(Date.now()-geoip.date_skew):null;rand_percent+=match.rand||0;random=random||util.get_random("zone");var match_opt=assign({url:opt.top_url,browser:util.browser_rule_s,os:util.guess.os,version:util.guess.version,random:random,rand_percent:rand_percent,date:current_date,video_url:opt.video_url,frame_url:opt.frame_url,no_mse:opt.no_mse,no_h264:opt.no_h264,player_n:opt.player_n,video_check_n:opt.video_check_n,player:opt.player},geoip);var matched=false;if(!match.js){match.zone=zone.zone;match.rules=zone.loader&&zone.loader.rules;match.js=zone_match.make_fn(match)}try{var match_fn=new Function("opt",match.js);matched=match_fn(match_opt)}catch(err){_log.err(err.stack||""+err)}if(matched)return zone}var uri_zone=util.get_hola_uri(opt.location||location,"hola_zone");var rand_percent=0,name;if(uri_zone)return uri_zone;if(name=storage_zone())return name;return(zutil.find(zones,is_selected)||{zone:"gen"}).zone}function check_h264(){var type='video/mp4; codecs="avc1.42E01E"';var ms=window.MediaSource;if(ms&&ms.isTypeSupported)return ms.isTypeSupported(type);if(window.hola_cdn_sdk)return true;var el=document.createElement("video");return el.canPlayType&&(el.canPlayType(type)||el.canPlayType(type+', mp4a.40.2"'))}function get_zone_opt(loader){var jtest_location=loader.jtest&&loader.jtest.location;if(jtest_location)return{location:jtest_location,top_url:jtest_location.href};var loaded_in_debug=util.get_hola_uri("hola_debug");var url_frame=util.get_url_frame(loaded_in_debug);return{top_url:url_frame.top_url,frame_url:url_frame.frame_url,no_mse:!window.MediaSource,no_h264:!check_h264()}}Zone.prototype.log_get=function(){return this.log};Zone.prototype.perr_get=function(){var _this=this;return function(opt){opt.zone=assign({},_this.info);opt.zone.name=_this.name;opt.zone.mode=_this.CG("mode");opt.zone.skip=_this.CG("skip");opt.wrapper=_this.loader&&_this.loader.get_wrapper(_this.wrapper_id);if(opt.add_log)opt.zone.log=_this.log;util.cdn_perr(opt)}};Zone.prototype.conf_set=function(path,val,opt){if(typeof opt!="object")opt={save:opt};util.conf_set(path,val,opt.save);util.conf_set(path,val,false,this.conf);if(opt.reconf)this.reconf();return val};Zone.prototype.conf_mvp=function(path){var percent;if(!(percent=this.conf_get(path+"_mvp"))||util.mvp_marker!=null)return;random=random||util.get_random("zone");if(random>percent/100)return util.mvp_marker=0;this.conf_set(path,util.mvp_marker=1)};Zone.prototype.conf_get=function(path,def){var res=util.conf_find(path.split("."),this.conf);return res===undefined?def:res};Zone.prototype.conf_get_json=function(path,def){var s=this.conf_get(path,def);if(!s||typeof s=="object")return s;try{return JSON.parse(s)}catch(err){}};Zone.prototype.conf_set_save=function(path,val){this.conf_set(path,val,true)};Zone.prototype.conf_enable_save=function(path){this.conf_set(path,true,true)};Zone.prototype.conf_enable=function(path,save){this.conf_set(path,true,save)};Zone.prototype.conf_disable=function(path,save){this.conf_set(path,false,save)};Zone.prototype.conf_have=function(path){return this.conf_get(path)!==undefined};Zone.prototype.conf_test_disable=function(path){if(!this.conf_get(path))return false;this.conf_disable(path);return true};Zone.prototype.conf_apply=function(path,args,def,_this,throw_ex){var func=this.conf_get(path,def),ret;if(typeof func!="function"&&!func.__Function__)return func;if(func.__Function__){if(!args.length)args=func.args;var info=conv.parse_function(func.__Function__);func=new Function(info.args.join(","),info.body)}try{ret=func.apply(_this,args)}catch(e){this.log.info("conf_apply of path "+path+" failed with err "+e);if(throw_ex)throw e;ret=def}return ret};var aliases={CG:"conf_get",CGJ:"conf_get_json",CS:"conf_set",CE:"conf_enable",CD:"conf_disable",CH:"conf_have",CTD:"conf_test_disable",CES:"conf_enable_save",CSS:"conf_set_save",CMVP:"conf_mvp"};for(var k in aliases)Zone.prototype[k]=Zone.prototype[aliases[k]];Zone.prototype.init=function(conf){this.conf=zutil.extend_deep(conf||{},util.get_local_conf(),util.get_dbg_conf(),util.get_uri_conf());var gen=this.loader?this.loader.get_zones().gen:{};if(gen.url2type)this.conf.url2type=gen.url2type};Zone.prototype.uninit=function(){this.inited=false;this.conf={};this.info={}};Zone.prototype.stash=function(){var _this=this;var stash={conf:zutil.clone_deep(this.conf),info:zutil.clone_deep(this.info),name:this.name};return function(){assign(_this,stash);_this.reconf()}};Zone.prototype.customer_conf_get=function(){var _this=this,zones=this.loader.get_zones();var predicate=function(z){return z.zone==_this.name};return this.name=="gen"?zones.gen:zutil.find(zones.zones,predicate)};Zone.prototype.zone_init=function(opt){var zperr=this.perr_get();if(!util.geoip||!util.geoip.country){if(this.loader&&this.loader.loader_conf&&this.loader.loader_conf.geoip_fallback){util.set_geoip(this.loader.loader_conf.geoip_fallback)}}var zones=this.loader.get_zones();this.name=opt.force_zone?opt.force_zone:select_zone(zones.zones,assign({},opt,get_zone_opt(this.loader)));this.conf=zutil.extend_deep({zone:this.name},zutil.clone_deep(util.conf),zutil.clone_deep(this.customer_conf_get()),util.get_local_conf(),util.get_dbg_conf(),util.get_uri_conf());this.inited=true;this.reconf()};function watch_reconf(watch,zone_conf,is_init){var val={},old_val=watch.value,path=watch.opt.conf;if(typeof path=="string")val=zutil.get(zone_conf,path);else{if(!watch.hasOwnProperty("value"))old_val={};Object.keys(path).forEach(function(name){if(zutil.has(zone_conf,path[name]))val[name]=zutil.get(zone_conf,path[name])})}if(watch.opt.ontoggle&&(is_init||val!=old_val))watch.opt.ontoggle(watch.ctx,val);else if(watch.opt.onchange&&(is_init||!zutil.equal_deep(old_val,val)))watch.opt.onchange(watch.ctx,old_val,val);watch.value=val}Zone.prototype.conf_watch=function(watches){var _this=this;if(!(watches instanceof Array))watches=[watches];watches.forEach(function(w){var zw={opt:w,ctx:{}};watch_reconf(zw,_this.conf,true);_this.watches.push(zw)});return{uninit:function(){watches.forEach(function(w){var zw=_this.watches.find(function(zw){return zw.opt==w});if(zw.opt.uninit)zw.opt.uninit(zw.ctx,zw.value);_this.watches.splice(_this.watches.indexOf(zw),1)});watches=[]}}};Zone.prototype.reconf=function(watches){var new_conf=this.conf;this.watches.forEach(function(zw){watch_reconf(zw,new_conf)})};function Zone(_loader,conf,id,opt){if(!(this instanceof Zone))return new Zone(_loader);opt=opt||{};this.loader=_loader;this.info={};this.watches=[];this.id=id||0;this.log=(opt.log||_log).reset_module();this.zperr=this.perr_get();var m=(""+this.id).match(/^(\d)+\/(\d)+$/);this.wrapper_id=m?+m[1]:undefined;if(conf)this.init(conf)}Zone.prototype.url2type=function(v){var url2type=this.conf_get("url2type");return url2type&&v&&url2type(v)||v};Zone.prototype.get_link_type=function(link){var type=util.get_video_type(this.url2type(link));return util.get_method_type(type)};E.t={select_zone:select_zone,get_zone_opt:get_zone_opt,check_h264:check_h264,reset_random:reset_random,Zone:Zone};return E})})();
define("/svc/cdn/pub/links.js",["cash","/svc/cdn/pub/log.js","/util/etask.js","/svc/cdn/pub/util.js","/util/storage.js","/util/util.js","/util/date.js","/svc/cdn/pub/cdnlist.js"],function($,_log,etask,util,storage,zutil,date,cdnlist){var E=new util.events,assign=Object.assign;var NUM_DB_FAIL=3,NUM_DUPLICATES=5;var perr=util.cdn_perr,log=_log.set_module("links");var def_opt={unite_img_and_link:"a",img_selector:"img"};var get_img_parents_used,scan_timeout,sent_links={},links_info={};var all_links=[];var rejected_origins=["facebook.com","twitter.com","instagram.com","google.com","youtube.com","telegram.me","javascript"].map(function(o){return new RegExp("^(https?://)?[^/]*"+o+"([/:].*)?$")});var db_fail_cnt=0;function pages2cdns(zone,links){var maps=cdnlist.pages2cdns(zone,cdnlist.all_agents,links);var res=[];links.forEach(function(l){var group=res.find(function(g){return zutil.equal_deep(g.cdnlist,maps[l])});if(!group)group=res[res.push({cdnlist:maps[l],pages:[]})-1];group.pages.push(l)});return res}function fetch_from_map_cdns(cmd,links,opt){var ret={};return etask({name:"fetch_from_map_cdns",cancel:true},[function(){var groups=opt.cdnlist?[{cdnlist:opt.cdnlist,pages:links}]:E.pages2cdns(opt.zone||this.zone,links);return etask.for_each(groups,[function(){var g=this.iter.val;return E.spark.fetch_from_singles(cmd,{customer:E.spark.customer,url:E.spark.top_url},assign({},opt,{cdnlist:g.cdnlist,data:{items:g.pages,full:opt.full}}))},function(res){if(opt.cb)opt.cb(res);if(res&&!res.error)assign(ret,res)}])},function(){return this.wait_child("all",opt.timeout||1e4)},function(){return ret}])}function send_map_video_page(player){if(player.sent_map_video_page)return;var info=E.get_page_db(),duration=player.controls.get_duration();if(!info){if(!E.last_update_db&&E.last_sent_update_db)return E.once("update_db",send_map_video_page.bind(null,player));if(!E.msg.is_master()&&!E.failed_set_page_info){return E.once("set_page_info",send_map_video_page.bind(null,player))}}if(info&&(info.video_url||(info.videos||[]).length)){var cache_url=util.strip_hostname(E.spark.video2cache(player.url,player.adaptive));var check=function(v){return v.url==cache_url&&(v.duration||!duration)};if(check({url:info.video_url,duration:info.duration})||(info.videos||[]).find(check)){return}}var res=player.controls.get_resolution();var data={size:res?res.width+"x"+res.height:null};var playlists=player.controls.get_playlists();if(duration)data.duration=duration;if(player.adaptive)data.manifest_url=player.url;else{data.video_url=player.url;if(playlists&&playlists.length>1)data.sources=playlists.map(function(p){return p.url})}player.sent_map_video_page=true;send_cmd("map_video_page",data)}E.init=function(spark){log.notice("links init");E.spark=spark;spark.links=E;E.zone=spark.zone;var local_conf=storage.get_json("hola_links_conf")||{};E.conf=assign({},def_opt,E.spark.conf.video_previews,E.spark.conf.links,local_conf,window.hola_ve_links_conf);E.spark.players.on("attach",function(player){if(util.is_blob_url(player.url))return;if(!player.html5||player.html5.readyState>=player.html5.HAVE_METADATA){send_map_video_page(player)}else{player.html5.addEventListener("loadedmetadata",function cb(){player.html5.removeEventListener("loadedmetadata",cb);send_map_video_page(player)})}});E.stats=new Stats;E.msg=new E.spark.Msg("ln");E.msg.add_handler("get_top_url_db",etask.fn([function(){if(E.last_update_db)return;E.once("update_db",this.continue_fn());this.wait()},function(){return E.get_page_db()}]));etask([function(){return E.msg.get_top_url_db()},function(info){if(info)set_page_info(info)}]);E.scan();init_scan_on_scroll()};function Stats(){this.prefix="links_";util.on("zbeforeunload",util.try_wrapper({prefix:"links"},this.send_perr.bind(this)));this.init()}Stats.prototype.init=function(reset){if(!reset&&this.stats&&!zutil.is_mocha())return void log.notice("stats already initialized");this.stats={};this.timers={};this.durations={};this.inc(reset?"stats_reset":"init")};Stats.prototype.inc=function(s,v){return this.set(s+"_n",(this.get(s+"_n")||0)+(v||1))};Stats.prototype.set=function(s,v){return this.stats[this.prefix+s]=v};Stats.prototype.get=function(s){return this.stats[this.prefix+s]};Stats.prototype.get_stats=function(){for(var key in this.durations)this.set(key+"_ms",this.durations[key]/this.get(key+"_n"));return this.stats};Stats.prototype.start=function(s){this.inc(s);this.timers[s]=date.monotonic();this.durations[s]=this.durations[s]||0};Stats.prototype.stop=function(s){if(!this.timers[s])return;this.durations[s]+=date.monotonic()-this.timers[s];delete this.timers[s]};Stats.prototype.send_perr=function(){perr({id:"links_stats",info:{stats:this.get_stats()},delay:false,use_beacon:true});this.init(true)};function get_opt(opt){return assign({url:E.spark.top_url},E.conf,opt)}E.get=function(opt){return get_links(get_opt(opt))};E.get_db=function(links,opt){E.stats.inc("get_db");links=links||E.get(opt);return links.map(function(l){return assign({},l,links_info[l.url])})};E.get_page_db=function(){return links_info[E.spark.top_url]};function set_page_info(info){if(info)links_info[E.spark.top_url]=info;else E.failed_set_page_info=Date.now();E.emit("set_page_info",info)}E.set_page_db=function(data){send_cmd("set_page_info",data)};function send_cmd(cmd,data){if(E.spark.zone.CG("agent.use_pages2cdns"))return new_send_cmd(cmd,data);return _send_cmd(cmd,data)}function new_send_cmd(cmd,data){E.stats.start(cmd);etask([function(){return fetch_from_map_cdns(cmd,[{url:E.spark.top.url}],{data:data,timeout:6e4,cdnlist:E.conf.cdns||E.conf.cdn})},function catch$(){E.stats.inc(cmd+"_fail")},function finally$(){E.stats.stop(cmd)}])}function _send_cmd(cmd,data){E.stats.start(cmd);etask([function(){return E.spark.fetch_from_fastest(cmd,{customer:E.spark.customer,url:E.spark.top_url},{data:data,timeout:6e4,cdnlist:E.conf.cdns||E.conf.cdn})},function catch$(){E.stats.inc(cmd+"_fail")},function finally$(){E.stats.stop(cmd)}])}E.get_previews=function(links,opt){return get_links_db(links,assign(get_opt(opt),{gen_previews:true}))};E.set_db=function(links,opt){return set_links_db(links,get_opt(opt))};E.filter=function(links,opt){return links.filter(function(l){return/^(https?:)?\/\//.test(E.get_href(l.link,get_opt(opt)))})};function init_scan_on_scroll(){if(!E.conf.scan_on_scroll)return;E.stats.inc("scroll_scan_init");var size=document.body&&document.body.innerHTML.length,scroll_timeout;$(window).on("scroll",function(){clearTimeout(scroll_timeout);scroll_timeout=setTimeout(function(){var new_size=document.body&&document.body.innerHTML.length;if(new_size==size)return void E.stats.inc("scroll_no_scan");size=new_size;E.stats.inc("scroll_scan");var new_links;if(!(new_links=E.scan()))return;E.stats.inc("scroll_scan_found");E.stats.inc("scroll_scan_found_links",new_links)},200)})}E.scan=function(){E.stats.start("scan");clear_scan();var scanned=function(el,val){return $(el).prop("hola-links-scanned",val)};var detached=[],all=[];var contains=function(doc,l){return doc.body&&doc.body.contains(l)};all_links.forEach(function(l){if(contains(document,l)||is_playlist_link(l)&&$("iframe.hola_playlist").get().find(function(i){return contains(i.contentDocument,l)})){return void all.push(l)}detached.push(l);scanned(l,0)});all_links=all;if(detached.length)E.emit("detach",detached);var s;var links=E.get({filter:function(a){return!(s=scanned(a))||s=="error"}});E.stats.stop("scan");if(!links.length)return void submit_scan();var new_links=links.filter(function(l){return!scanned(l.link)});links.forEach(function(l){scanned(l.link,1);if(!all_links.includes(l.link))all_links.push(l.link)});links=E.filter(links.filter(function(l){return!sent_links[l.url]}));if(new_links.length){E.stats.inc("found_links",new_links.length);E.stats.inc("found");E.emit("update",new_links)}links=links.map(function(l){if(l.type!="video")return l;E.stats.inc("type_video");if(!l.page_url||l.url==l.page_url)return l;E.stats.inc("type_video_override");return assign(l,{type:"page",url:l.page_url})});etask([function(){return set_links_db(links,E.conf)},function finally$(){submit_scan()}]);return links.length};function clear_scan(){scan_timeout=clearTimeout(scan_timeout)}function submit_scan(){clear_scan();scan_timeout=setTimeout(E.scan,5e3)}function get_links(opt){E.stats.inc("get");var cur_links=[],conf_links=opt.links_selector||"a";var sel_ar=Array.isArray(conf_links)?conf_links:[conf_links];if(opt.text_links_selector)sel_ar.push(opt.text_links_selector);sel_ar.push("a[hola_ve_preview], a[hola_spark_video_url]");$("iframe.hola_playlist").get().forEach(function(s){sel_ar.push($(s.contentDocument).find("[data-hola-playlist-link]").get(0))});var text_links=[];sel_ar.forEach(function(sel){var t;if(typeof sel=="function")t=sel($);else t=$(sel);if(sel==opt.text_links_selector)text_links=text_links.concat(t.get());var a=$(t).filter(function(e){return!cur_links.includes(e)});if(opt.filter)a=a.filter(opt.filter);if(!a.length)return;cur_links=cur_links.concat(a.get())});var ret=cur_links.map(function(a){var $a=$(a),video_url,allow_video;var v_url=$a.attr("hola_ve_preview")||$a.attr("hola_spark_video_url");if(allow_video=v_url!="none")video_url=v_url;var adaptive,cache_v_url;if(video_url){adaptive=!!util.get_adaptive_type(video_url);cache_v_url=util.strip_hostname(E.spark.video2cache(video_url,adaptive))}var page_url=get_href(a,opt);var url=allow_video?E.get_href(a,opt):page_url;var cache_url=E.spark.page2cache(url);var links=opt.unite_img_and_link?$a.closest(opt.unite_img_and_link).find("a[href]").not($a).filter(function(el){return E.get_href(el,opt)==url}):$([]);var img=get_img(a),size,poster;if(img.length){size=img[0].clientWidth+"x"+img[0].clientHeight;poster=get_img_src(img,opt)}return{link:a,links:links,url:video_url||url,page_url:page_url,cache_url:cache_v_url||cache_url,type:video_url?"video":"page",img:img,poster:poster,size:size,description:get_link_text(a,links,img,opt),video_url:cache_v_url,adaptive:adaptive,root:/.*\/\/[^\/]*\/$/.test(url),self:cache_url==E.spark.top_url,force_video:allow_video&&!!v_url,no_video:!allow_video,text_link:text_links.includes(a),playlist:is_playlist_link(a)}}).filter(is_link_allowed);clear_duplicates(ret);return ret}E.get_href=function(a,opt){if(a.hasAttribute("data-hola-playlist-link"))return a.getAttribute("data-hola-playlist-link");if(a.hasAttribute("hola_ve_preview"))return a.getAttribute("hola_ve_preview");if(a.hasAttribute("hola_spark_video_url"))return a.getAttribute("hola_spark_video_url");return get_href(a,opt)};function get_href(a,opt){var ret=opt.get_href?opt.get_href(a,window.location.host,$):a.href;return opt.href_keep_hash?ret:ret&&ret.replace(/#.*/,"")}function get_img(a){if(E.conf.get_img)return find_biggest(E.conf.get_img(a,$));var ret=find_biggest($(a).find(E.conf.img_selector));if(ret.length||E.conf.disable_get_img_style)return ret;if(get_img_style(a)&&is_visible(a))return $(a);ret=find_biggest($(a).find("*").filter(function(c){return get_img_style(c)&&big_enough(c,a)}));if(ret.length)return ret;ret=find_biggest($(a).parents().filter(function(p){if(window.Node&&window.Node.ELEMENT_NODE!=p.nodeType)return false;return get_img_style(p)&&big_enough(a,p)}));if(ret.length&&!get_img_parents_used&&(get_img_parents_used=true))perr({id:"get_img_parents_used"});return ret}function get_img_src(a,opt){var src,$a=$(a);if(opt.get_img_src&&(src=opt.get_img_src(a)))return src;if((src=$a[0].src||$a[0].currentSrc)&&!/^data:/.test(src))return src;var attrs=["data-original","data-src","srcset","data-srcset"];for(var i=0;i<attrs.length;i++){if(src=$a.attr(attrs[i]))return src}return get_img_style(a)}function get_img_style(e){if(E.conf.disable_get_img_style)return;var m=($(e).css("background-image")||"").match(/url\(['"]?([^'"]*)['"]?\)/);return m&&m[1]}function big_enough(c,p){var cs=c.getBoundingClientRect(),ps=p.getBoundingClientRect();var w=Math.min(cs.right,ps.right)-Math.max(cs.left,ps.left);var h=Math.min(cs.bottom,ps.bottom)-Math.max(cs.top,ps.top);return w>(ps.right-ps.left)*.3&&h>(ps.bottom-ps.top)*.5}function find_biggest(img){img=img.filter(is_visible);if(img.length<=1)return img;var max,max_size;img.each(function(i){var size=i.clientWidth*i.clientHeight;if(max&&size<=max_size)return;max_size=size;max=i});return $(max)}function is_visible(el){return!!(el.offsetWidth||el.offsetHeight||el.getClientRects().length)}function get_link_text(a,links,img,opt){var $a=$(a),c;var methods=[function(){return opt.get_link_text&&opt.get_link_text(a)},function(){return $a[0].title},function(){return(c=$a.children(".description")[0])&&c.innerText},function(){return $a[0].innerText},function(){return img[0]&&img[0].alt},function(){return $a.text()}];var trim=function(t){return t?t.trim().replace(/\s+/g," "):""};var text;for(var i=0;i<methods.length;i++){if((text=trim(methods[i]()))&&is_text_allowed(text))return text}return links.map(function(el){return el.textContent}).map(trim).filter(is_text_allowed).sort(function(s1,s2){return s2.length-s1.length})[0]}function is_text_allowed(t){var m;return t&&t.length>3&&(m=t.match(/[^0-9\s]/g))&&m.length/t.length>.4}function is_link_allowed(l){return!!(!rejected_origins.find(function(o){return o.test(l.url)})&&(l.img.length||l.text_link))}function clear_duplicates(links){var posters={},descriptions={};var set=function(obj,key){obj[key]=key?(obj[key]||0)+1:0};links.forEach(function(l){set(posters,l.poster);set(descriptions,l.description)});links.forEach(function(l){if(posters[l.poster]>NUM_DUPLICATES)delete l.poster;if(descriptions[l.description]>NUM_DUPLICATES)delete l.description})}function is_playlist_link(a){return!!$(a).attr("data-hola-playlist-link")}function get_links_db(links,opt){var cmd=opt.gen_previews?"get_previews":"get_links_info";var items_data={};if(cmd=="get_links_info"&&!links_info[E.spark.top_url])links.push({url:E.spark.top_url,type:"page",current:true});var items=links.filter(function(a){return!items_data[a.url]&&(items_data[a.url]=a)}).map(function(a){return zutil.pick(a,"url","type","poster","description","size")});if(!items.length)return;items.forEach(function(l){sent_links[l.url]=1});E.stats.start(cmd);return etask([function(){clear_scan();E.last_sent_update_db=Date.now();if(E.spark.zone.CG("agent.use_pages2cdns")){return fetch_from_map_cdns(cmd,items,{full:opt.debug||util.has_ext,timeout:6e4,cdnlist:E.conf.cdns||E.conf.cdn,zone:E.zone})}return E.spark.fetch_from_fastest(cmd,{customer:E.spark.customer,url:opt.url||E.spark.top_url},{data:{items:items,full:opt.debug||util.has_ext},timeout:6e4,cdnlist:E.conf.cdns||E.conf.cdn,zone:E.zone})},function(res){var data;if(!(data=res&&res.res)||data.error||res.err)throw new Error(data&&data.error||res&&res.err);return res},function catch$(e){E.stats.inc(cmd+"_fail");if(db_fail_cnt++<NUM_DB_FAIL){items.forEach(function(l){sent_links[l.url]=0});links.forEach(function(l){$(l.link).prop("hola-links-scanned","error")})}throw e},function(res){db_fail_cnt=0;var data=res.res,ret={};var dom=["link","links","img"];var update_db=function(url,db_data){ret[url]=zutil.defaults({},items_data[url],db_data);if(!links_info[url])links_info[url]={db:{}};assign(links_info[url],ret[url]);for(var i=0;i<dom.length;i++)delete links_info[url][dom[i]];assign(links_info[url].db,db_data)};if(opt.gen_previews){items.forEach(function(p){update_db(p.url,{preview:data[p.url]})})}else items.forEach(function(p){update_db(p.url,data[p.url])});if(items.length){E.last_update_db=Date.now();E.emit("update_db",E.get_db(links.filter(function(l){return!l.current&&ret[l.url]})))}return{res:ret,cdn:res.cdn}},function finally$(){submit_scan();E.stats.stop(cmd)}])}function set_links_db(links,opt){log.notice("set_db count: %s",links.length);return etask([function(){return get_links_db(links,opt)},function(){}])}function uninit(){clear_scan();links_info={};sent_links={};E.off("update");E.off("update_db")}if(zutil.is_mocha())E.t={uninit:uninit};return E});
define("/svc/cdn/pub/position_memory.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/util/storage.js","/util/url.js","/util/date.js"],function($,zutil,util,storage,zurl,date){var assign=Object.assign;var log,id="position_memory";var E={};var _window=window;var def_styles={".hola_position_marker":{top:"0",left:"0",width:"0",position:"absolute",height:"2px","background-color":"#ff0000"}};function apply_styles(opt){var styles=zutil.extend_deep({},def_styles,opt.extra_css_fn?opt.extra_css_fn():null);var marker_style=styles[".hola_position_marker"];if(opt.position_marker_height)marker_style.height=opt.position_marker_height+"px";if(opt.position_marker_color)marker_style["background-color"]=opt.position_marker_color;E.styles=util.get_stylesheet(styles);$("head").append("<style>"+E.styles+"</style>")}function Marker(opt){this.opt=opt;this.img=opt.link.img;this.el=opt.link.link;var bar=this.bar=document.createElement("div");var pos=this.get_position();this.max_width=pos.width;$(bar).addClass("hola_position_marker");var height=this.opt.position_marker_height||2;this.max_width=pos.width;$(bar).css({top:pos.top+pos.height-height+"px",left:pos.left+"px",transform:pos.transform});this.set_progress(opt.e.per)}Marker.prototype.show=function(){$(this.img).after(this.bar)};Marker.prototype.set_progress=function(per){var progress=per/100;$(this.bar).css({width:progress*this.max_width+"px"})};Marker.prototype.get_img_size_el=function(){var img=this.img,opt=this.opt,img_size;if(opt.img_size)img_size=img.closest(opt.img_size);if(!img_size||!img_size.length)img_size=img;return img_size};Marker.prototype.get_position=function(){var img=this.img,img_size=this.get_img_size_el();var img_offset=$(img_size).offset();var x=img_offset.left,y=img_offset.top;var doc=$(img_size)[0].ownerDocument;var iframe=(doc.defaultView||doc.parentWindow).frameElement;if(iframe){var iframe_offset=$(iframe).offset();x+=iframe_offset.left;y+=iframe_offset.top}var width=$(img_size).outerWidth(),height=$(img_size).outerHeight();return{top:img_size==img?$(img).position().top:y-$(img).parent().offset().top,left:img_size==img?$(img).position().left:x-$(img).parent().offset().left,width:width,height:height,transform:img_size==img?$(img).css("transform"):"none"}};E.markers={};function mark_position(l,e,url){l.position_memory=e;var marker=E.markers[url];if(marker)marker.set_progress(e.per);else{E.markers[url]=new Marker(assign({},E.conf,{link:l,e:e}));marker=E.markers[url];marker.show()}}function frame_offset(offset){if(window==_window||!window.frameElement)return offset;var o=$(window.frameElement).offset();return{left:offset.left+o.left,top:offset.top+o.top}}function on_links_update(links){function get_entry(url){return E.storage.o.urls[zurl.parse(url).path]}links.forEach(function(l){if(l.position_memory||l.root||l.self||!l.video_url&&!(l.videos||[]).length){return}var e;if(l.video_url&&(e=get_entry(l.video_url)))return mark_position(l,e,l.video_url);for(var i=0;i<(l.videos||[]).length;i++){var v;if((v=l.videos[i])&&v.url&&(e=get_entry(v.url)))return mark_position(l,e,v.url)}})}function on_links_detach(detached){for(var key in E.markers){if(detached.includes(E.markers[key].el))delete E.markers[key]}}function on_player_attach(player,ctx,reason){if(!E.monitor)E.monitor=setInterval(update_players,1e3);var pm_ctx=ctx.attached_pm=ctx.attached_pm||{};var e=E.storage.o.urls[player.url_key]||{};var force_pos=+util.get_hola_uri("hola_pm_force_pos");function pos_recovery_required(e){return force_pos||e.pos&&e.dur&&e.per!==undefined&&e.per<99&&e.per>1&&e.dur-e.pos>3}function on_state(state){if(state!="PLAYING")return;if(player.controls.get_pos()<=2)setTimeout(player.seek.bind(player,force_pos||e.pos));player.controls.off("state",on_state);pm_ctx.position_handled=true}function on_ended(){E.storage.o.urls[player.url_key]=undefined;E.storage.sync()}if(!pm_ctx.position_handled){if(!pos_recovery_required(e))pm_ctx.position_handled=true;else{if(e.offset&&E.spark.players.length==1)_window.scroll(0,e.offset.top);if(player.controls.state=="PLAYING")on_state("PLAYING");else player.controls.on("state",on_state)}}player.controls.on("ended",on_ended);player.once("detach",function(ctx,reason){if(!pm_ctx.position_handled)player.controls.off("state",on_state);player.controls.off("ended",on_ended);if(reason!="suspend")pm_ctx=ctx.attached_pm=undefined;if(!E.spark.players.find(function(p){return p.attached}))E.monitor=clearInterval(E.monitor)})}function update_players(){var updated;E.spark.players.forEach(function(p){if(p.attached&&!p.controls.is_live_stream())updated=update_pos(p)||updated});if(updated)E.storage.sync()}function update_pos(player){if(!player.pos||!player.dur||!player.url_key||!E.spark.top_url||player.dur<player.pos||E.storage.o.urls[player.url_key]&&E.storage.o.urls[player.url_key].pos==player.pos){return}var e=E.storage.o.urls[player.url_key]||{};if(!e.offset)e.offset=frame_offset($(player.container).offset());E.storage.o.urls[player.url_key]={pos:player.pos,dur:player.dur,per:Math.round(player.pos*100/player.dur),offset:e.offset};return true}E.init=function(spark){E.spark=spark;log=E.spark.log(id);E.conf=zutil.defaults_deep(E.spark.conf[id],E.default_conf)||{};apply_styles(E.conf);E.storage=E.spark.storage.get(id,{urls:{}});E.storage.set_leaf_max_stale("urls",date.sec.WEEK);E.spark.players.on("attach",on_player_attach);E.spark.links.on("update_db",on_links_update);E.spark.links.on("update",function(){on_links_update(E.spark.links.get_db())});E.inited=true;log.debug_spark("inited");on_links_update(E.spark.links.get_db());E.spark.links.on("detach",on_links_detach)};return E});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else define=require("../../../util/require_node.js").define(module,"../");define("/svc/cdn/pub/spark_welcome.js",["/util/etask.js","/util/util.js","/util/storage.js"],function(etask,zutil,storage){var E={};function svg_css_url(str){return"url('data:image/svg+xml,"+str.replace("'","\\")+"')"}function set_style(el,styles){var args=arguments;args[0]=args[0].style;Object.assign.apply(Object,args)}function force_relayout(){return doc.documentElement.offsetHeight}var preload_img=etask.fn({cancel:true},[function(src){var wait=this.wait();var img=doc.createElement("img");img.onload=img.onerror=function(){wait.continue()};img.src=src;this.finally(function(){img.onload=img.onerror=null;img.src="";img=null});return wait}]);var doc=document,body=doc.body;var max_z_index=2147483647;var x_icon='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">'+'<path fill="#004D74" fill-rule="evenodd"'+' d="M13 0l1 1-6 6 6 6-1 1-6-6-6 6-1-1 6-6-6-6 1-1 6 6 6-6z"'+' opacity=".4"/>'+"</svg>";var msg_arr='<svg xmlns="http://www.w3.org/2000/svg" width="7" height="12">'+'<path fill="#ddf4fd" fill-rule="evenodd" d="M7 12L0 6l7-6v12z"/>'+"</svg>";var img_base="//player.h-cdn.com/svc/cdn/pub/img/";var strings,default_strings={popup_title:"New video features!",got_it:"Got it!",video_previews_hint:"Mouseover for preview",watch_later_hint:"Click on icon to watch later"};var styles={_font:{fontFamily:"Lato, Tahoma, Arial, sans-serif"},bg:{position:"fixed",left:"0",top:"0",backgroundColor:"#000",pointerEvents:"none",width:"100%",height:"100%",zIndex:max_z_index,opacity:"0",transition:"opacity 600ms ease-out"},popup:{position:"fixed",backgroundColor:"#fff",borderRadius:"8px",boxShadow:"0px 10px 14px 0 rgba(0, 0, 0, .4)",cursor:"default",marginLeft:"-190px",left:"50%",top:"50%",transform:"translateY(-50%)",width:"380px",zIndex:max_z_index},popup_body:{margin:"20px 30px"},popup_title:{color:"#004d74",fontSize:"20px",fontWeight:"bold",textAlign:"center"},popup_x:{cursor:"pointer",position:"absolute",right:"0",top:"0",width:"14px",height:"14px",backgroundImage:svg_css_url(x_icon),backgroundPosition:"50% 50%",backgroundRepeat:"no-repeat",boxSizing:"content-box",padding:"10px"},popup_buttons:{textAlign:"center"},popup_button:{backgroundColor:"#fff",border:"1px solid #00b7f1",borderRadius:"2px",color:"#00b7f1",cursor:"pointer",display:"inline-block",fontSize:"16px",lineHeight:"1",padding:"7px 40px 9px",verticalAlign:"baseline"},feature_list:{listStyleType:"none",margin:"0",padding:"0"},feature_list_item:{margin:"20px 0",padding:"0",display:"flex",alignItems:"center"},feature_img:{width:"150px",height:"100px",display:"block",flexShrink:"0"},feature_msg:{backgroundColor:"#ddf4fd",color:"#004d74",flexGrow:"1",fontSize:"18px",lineHeight:"20px",marginLeft:"20px",padding:"12px 10px",textAlign:"center",position:"relative"},feature_msg_arr:{backgroundImage:svg_css_url(msg_arr),height:"12px",position:"absolute",right:"100%",top:"50%",width:"7px",marginTop:"-6px"}};var feature_handlers={video_previews:{preload:function(){return preload_img(img_base+"video_previews_welcome_low.png")},create:function(li){var low_img=doc.createElement("img");var full_img=doc.createElement("img");low_img.onload=low_img.onerror=function(){this.onload=this.onerror=null;full_img.src=img_base+"video_previews_welcome_full.gif"};full_img.onload=function(){li.replaceChild(this,low_img);low_img=null};low_img.src=img_base+"video_previews_welcome_low.png";set_style(low_img,styles.feature_img);set_style(full_img,styles.feature_img);var text=doc.createElement("div");set_style(text,styles._font,styles.feature_msg);var arr=doc.createElement("div");set_style(arr,styles.feature_msg_arr);text.appendChild(arr);text.appendChild(doc.createTextNode(strings.video_previews_hint));li.appendChild(low_img);li.appendChild(text)}},watch_later:{preload:function(){return preload_img(img_base+"watch_later_welcome_full.gif")},create:function(li){var img=doc.createElement("img");img.src=img_base+"watch_later_welcome_full.gif";set_style(img,styles.feature_img);var text=doc.createElement("div");set_style(text,styles._font,styles.feature_msg);var arr=doc.createElement("div");set_style(arr,styles.feature_msg_arr);text.appendChild(arr);text.appendChild(doc.createTextNode(strings.watch_later_hint));li.appendChild(img);li.appendChild(text)}}};function create_popup_el(doc){var popup=doc.createElement("div");set_style(popup,styles.popup);var popup_x=doc.createElement("div");popup_x.setAttribute("popup-continue","cancel");set_style(popup_x,styles.popup_x);var popup_body=doc.createElement("div");set_style(popup_body,styles.popup_body);popup.appendChild(popup_x);popup.appendChild(popup_body);return popup}function create_bg_el(doc){var bg=doc.createElement("div");set_style(bg,styles.bg);return bg}function create_welcome_msg(features){var msg=doc.createDocumentFragment();var title=doc.createElement("div");set_style(title,styles._font,styles.popup_title);var feature_list=doc.createElement("ul");set_style(feature_list,styles.feature_list);features.forEach(function(feature){var handler=zutil.get(feature_handlers,[feature,"create"]);if(!handler)return console.warn("No handler for "+feature+" feature");var li=doc.createElement("li");set_style(li,styles.feature_list_item);handler(li);feature_list.appendChild(li)});var btns=doc.createElement("div");set_style(btns,styles.popup_buttons);var btn_got_it=doc.createElement("button");set_style(btn_got_it,styles._font,styles.popup_button);btn_got_it.textContent=strings.got_it;btn_got_it.setAttribute("popup-continue","ok");btns.appendChild(btn_got_it);title.textContent=strings.popup_title;msg.appendChild(title);msg.appendChild(feature_list);msg.appendChild(btns);return msg}var preload_resources=etask.fn({cancel:true},[function(features){var preloaders=[];features.forEach(function(f){var preloader=zutil.get(feature_handlers,[f,"preload"]);if(!preloader)return;preloaders.push(preloader())});return etask.all(preloaders)}]);E.show_overlay=etask.fn({cancel:true},[function(content){var wait=this.wait();var bg=create_bg_el(doc);var popup=create_popup_el(doc);var popup_body=popup.lastElementChild;popup_body.appendChild(content);var popup_onclick=function(e){var el=e.target;do{if(!el.hasAttribute("popup-continue"))continue;wait.continue(el.getAttribute("popup-continue"));return}while(el=el==popup?null:el.parentElement)};var doc_onmdown=function(e){var el=e.target;do{if(el==popup)return}while(el=el.parentElement);wait.continue("cancel")};var doc_onkdown=function(e){if(e.keyCode!=27)return;e.preventDefault();e.stopPropagation();wait.continue("cancel")};body.appendChild(bg);body.appendChild(popup);popup.addEventListener("click",popup_onclick);doc.addEventListener("keydown",doc_onkdown,true);doc.addEventListener("mousedown",doc_onmdown,true);force_relayout();var anim_f=requestAnimationFrame(function(){bg.style.opacity="0.55"});this.finally(function(){cancelAnimationFrame(anim_f);bg.addEventListener("transitionend",function(){body.removeChild(bg)});bg.style.opacity="0";body.removeChild(popup);popup.removeEventListener("click",popup_onclick);doc.removeEventListener("keydown",doc_onkdown,true);doc.removeEventListener("mousedown",doc_onmdown,true)});return wait}]);E.available_for=function(f){return!!feature_handlers[f]};E.init=function(conf_strings){strings=zutil.defaults({},conf_strings,default_strings)};E.show=etask.fn({cancel:true},[function(features){this.features=features;return preload_resources(features)},function(){var msg=create_welcome_msg(this.features);return E.show_overlay(msg)}]);E.show_once=etask.fn({cancel:true},[function(features){var state_key="holaspark_welcome";var default_state={features_shown:{}};var stored_state=storage.get_json(state_key)||{};var state=Object.assign({},default_state,stored_state);var features_shown=state.features_shown;var features_to_show=features.reduce(function(acc,f){if(!features_shown[f])acc.push(f);return acc},[]);if(!features_to_show.length)return;features_to_show.forEach(function(f){state.features_shown[f]=true});storage.set_json(state_key,state);return E.show(features_to_show)}]);return E})})();
define("/svc/cdn/pub/image_preview.js",["cash","/svc/cdn/pub/util.js","/util/util.js","/util/etask.js","/svc/cdn/pub/log.js","/util/date.js","/util/storage.js","/util/events.js","/svc/cdn/pub/watermark.js","/util/ajax_lite.js"],function($,util,zutil,etask,_log,date,storage,events,watermark,ajax){var E=new util.events,assign=Object.assign;var perr=util.cdn_perr,log=_log.set_module("image_preview");var loc=window.location.host,storage_host="ve.h-cdn.com";var pages_to_images={},uniq_id=0,previews={};E.default_conf={links_selector:"a",imgs_selector:"img",container:{max_width:500,max_height:500},animation:{slide_duration:1500,swap_duration:500,start_duration:0},count:5,get_href:function(link,host){var href=link.href||"";if(href.startsWith("http"))return href;var base=href.startsWith("/")?window.location.href.match("(https?://[^/]+)/")[1]:window.location.href.match(".*/")[0];return base+href}};var link_img_cache={};function in_area(a,area){var uid=$(a).prop("hola-image-preview-id");if(!uid)$(a).prop("hola-image-preview-id",uid=++uniq_id);var data=link_img_cache[uid];if(!data){var img=$(a).find("img");if(!img||!img.length)return!(link_img_cache[uid]={});img=img[0];data=link_img_cache[uid]={img:img,top:$(img).offset().top,height:$(img).height()}}if(!data.height)return false;data.top=$(data.img).offset().top;var ywin=data.top-window.pageYOffset;if(area=="m"){var ymid=window.innerHeight/2;return ywin<=ymid&&ywin+data.height>=ymid}return ywin>=0&&data.top<=window.pageYOffset+window.innerHeight}function pre_cache(href){var src=pages_to_images[href];if(src&&src[0])cached_image(src[0])}function mobile_nav(){if(!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return}var active_links=[];var resize_fn=function(){link_img_cache={};$(active_links).trigger("mouseleave");$(window).trigger("scroll")};var update=util.throttle(function(){},100);$(window).on("resize",resize_fn);$(window).on("orientationchange",resize_fn);$(window).on("scroll",update);setTimeout(function(){$(window).trigger("scroll")},1e3)}function get_previews(new_links,opt){var pages=new_links.map(function(l){return l.url});return etask([function(){if(!pages.length)return[];return ajax.json({url:"//"+storage_host+"/image_previews/get_previews",method:"POST",data:{image_pages:pages,host:loc,customer:E.spark.customer}})},function(r){assign(pages_to_images,r)}])}function img_of_elem(elem){if(typeof E.conf.imgs_selector=="function")return E.conf.imgs_selector($,$(elem))||[];return $(elem).find(E.conf.imgs_selector)}function get_new_links(opt){return E.links.get(opt).filter(function(l){if(l.type!="page")return;if(!l.force_video){if(l.root)return false;var href=l.url;if(href&&href[0]=="#")return false}if(!img_of_elem(l.link).length)return false;return!$(l.link).prop("hola-image-preview-id")})}function update_links(opt){var nl=E.links.filter(get_new_links(opt),opt);etask([function(){return get_previews(nl,opt)},function(res){if(0&&(!res||!res.cdn))return;var _opt=assign({},opt,res);nl.forEach(function(l){var p=new Preview(l,_opt);E.stats.add_preview(p);previews[p.id]=p});E.emit("has_previews")}])}var cached_images={};function cached_image(src){return cached_images[src]||(cached_images[src]=new CachedImage(src))}zutil.inherits(CachedImage,events.EventEmitter);function CachedImage(src){this.image=new Image;this.image.onload=this._onload.bind(this);this.image.src=src}CachedImage.prototype._onload=function(){this.width=this.image.width;this.height=this.image.height;this.ready=true;this.emit("ready")};CachedImage.prototype.onready=function(cb){if(this.ready)cb();this.once("ready",cb)};zutil.inherits(Icon,events.EventEmitter);function Icon(preview){this.preview=preview;this.icon=cached_image("//ve-cdn.h-cdn.com/svc/preview/pub/img/ic_gallery.svg");this.update()}Icon.prototype.get_img=function(){var img=img_of_elem(this.preview.elem);if(!img.length){if(!E.conf.unite_img_and_link)return;img=$(this.preview.elem).closest(E.conf.unite_img_and_link).find('a[href="'+this.preview.href+'"] img');if(!img.length)return}return img};Icon.prototype.show=function(){if(!E.conf.icon_location)return;if(!this.img)this.img=this.get_img();if(!this.img)return;if(this.elem)return;var img=this.img;var $img=$(img);if(img.width<2||img.naturalWidth<2){var _this=this;$img.on("load",function on_load(){$img.off("load",on_load);_this.show()});return}var size=$img.height()*(E.conf.icon_size||25)/100;var elem=document.createElement("div");var $elem=$(elem);$elem.addClass("hola_image_preview_icon");$elem.attr("hola-image-preview-id",this.preview.id);$elem.css({position:"absolute",width:size+"px",height:size+"px","background-image":'url("'+this.icon.image.src+'")',"background-position":"center","background-repeat":"no-repeat"});var pos={top:$img.position().top,left:$img.position().left,width:$img.width(),height:$img.height()};var top,left,loc=E.conf.icon_location.split("-");var margin=E.conf.icon_margin||10;if(loc[0]=="center"){left=(pos.width-size)/2;top=(pos.height-size)/2}else{top=loc[0]=="top"?margin:pos.height-size-margin;left=loc[1]=="left"?margin:pos.width-size-margin}$elem.css({width:size+"px",height:size+"px",top:pos.top+top+"px",left:pos.left+left+"px"});$img.after(elem);this.elem=elem};Icon.prototype.update=function(){var src=pages_to_images[this.preview.href];if(!src)return;this.show()};Icon.prototype.hide=function(){if(!this.elem)return;$(this.elem).remove();this.elem=null};function Preview(link){var elem=link.link;this.id=++uniq_id;$(elem).prop("hola-image-preview-id",this.id);this.elem=elem;this.href=link.url;this.on_show=this.emit.bind(this,"show");this.on_hide=this.emit.bind(this,"hide");this.on("show",this.show.bind(this));this.on("hide",this.hide.bind(this));this.is_playing=false;this.previews_requested=false;this.hide_requested=false;this.animation=new Animation;this.bind_events()}zutil.inherits(Preview,events.EventEmitter);Preview.prototype.get_id=function(){return this.id};Preview.prototype.bind_events=function(){var container=$(this.elem).closest(E.conf.unite_img_and_link).get(0);if(container&&($(container).width()>E.conf.container.max_width||$(container).height()>E.conf.container.max_height)){return}this.icon=new Icon(this);$(container||this.elem).on("mouseenter",this.on_show);$(container||this.elem).on("mouseleave",this.on_hide)};Preview.prototype.hover=function(){};Preview.prototype.unhover=function(){};Preview.prototype.show=function(){if(this.hide_requested)this.hide_requested=clearTimeout(this.hide_requested);if(this.is_playing||$(this.elem).prop("hola-video-preview-has-video"))return;this.is_playing=this.href in pages_to_images;if(this.is_playing)return void this._show();if(!this.previews_requested){this.previews_requested=true;get_previews([this.href])}};Preview.prototype.hide=function(){if(this.hide_requested)return;var _this=this;this.hide_requested=setTimeout(function(){if(E.watermark)E.watermark.remove(_this.watermark_container);if(_this.watermark_container){$(_this.watermark_container).remove();_this.watermark_container=null}_this.animation.stop();_this.is_playing=false;_this.hide_requested=null;_this.icon.show()},300)};Preview.prototype._show=function(){var src=pages_to_images[this.href];if(!src)return;var img=img_of_elem(this.elem);if(!img.length){if(!E.conf.unite_img_and_link)return;img=$(this.elem).closest(E.conf.unite_img_and_link).find('a[href="'+this.href+'"] img');if(!img.length)return}this.animation.play(img,src);this.add_watermark(img);this.icon.hide()};Preview.prototype.add_watermark=function(img){if(!E.watermark)return;var container=this.watermark_container=document.createElement("div");$(container).css({position:"absolute",width:Math.ceil($(img).width())+"px",height:Math.ceil($(img).height())+"px",top:$(img).position().top+"px",left:$(img).position().left+"px","z-index":$(img).css("z-index")});$(img).parent().append(container);E.watermark.apply({v:{html5:{duration:1}},container:container})};function Animation(){this.stop_animation_fn=null;this.stop_fn=null;this.last_idx=0;this.duration=E.conf.animation.swap_duration}Animation.prototype.stop_animation=function(){if(!this.stop_animation_fn)return;this.stop_animation_fn();this.stop_animation_fn=null};function get_img(elem){if($(elem).is("img"))return $(elem).get(0);var m=$(elem).css("background-image").match(/\(\"(.*)\"\)$|\(\'(.*)\'\)$/);var img=new Image($(elem).width(),$(elem).height());img.src=m[1]||m[2];return img}Animation.prototype.play=function(img,src){var _this=this;this.play_animation_t=setTimeout(function(){_this.play_animation_t=null;_this.play_animation(img,src)},E.conf.animation.start_duration)};Animation.prototype.play_animation=function(img,src){this.stop_animation();var w=Math.ceil($(img).width()),_this=this;var h=Math.ceil($(img).height());src=(src.thumbs||[]).slice(0,E.conf.count);var c=document.createElement("canvas");$(c).attr("width",w);$(c).attr("height",h);var extra_css=typeof E.conf.extra_css=="function"?E.conf.extra_css({img:img},$):E.conf.extra_css;$(c).css(assign({position:"absolute",top:$(img).position().top+"px",left:$(img).position().left+"px","z-index":$(img).css("z-index"),"background-color":"transparent",transform:$(img).css("transform"),"pointer-events":"none"},extra_css||{}));var ctx=c.getContext("2d"),idx=this.last_idx,i;var stop_animation=false;this.last_img=get_img(img);ctx.drawImage(this.last_img,0,0,w,h);var draw=function(){if(stop_animation)return;_this.last_idx=idx;i=cached_image(src[idx]);i.onready(function(){_this.draw_image(ctx,i.image,w,h,false,function(progress){if(progress>=1)_this.last_img=i.image});setTimeout(draw,E.conf.animation.slide_duration)});idx=(idx+1)%src.length;cached_image(src[idx])};draw();$(img).after(c);this.stop_fn=function(){stop_animation=true;_this.stop_animation();if(!i||!i.ready)return void $(c).remove();if(i.image==_this.last_img)_this.last_img=get_img(img);_this.draw_image(ctx,i.image,w,h,true,function(){$(c).remove()})}};Animation.prototype.stop=function(){if(this.play_animation_t){clearTimeout(this.play_animation_t);this.play_animation_t=null}if(!this.stop_fn)return;this.stop_fn();this.stop_fn=null};Animation.prototype.draw_image=function(ctx,img,w,h,reverse,cb){if(E.conf.draw=="full")return this.draw_image_full(ctx,img,w,h,reverse,cb);return this.draw_image_fill(ctx,img,w,h,reverse,cb)};Animation.prototype.draw_image_fill=function(ctx,img,w,h,reverse,cb){var iw=img.naturalWidth,ih=img.naturalHeight,_this=this;var dsr=w*ih/h/iw;if(dsr>1)dsr=1/dsr;var sw=iw*dsr,sh=sw*h/w,sx=(iw-sw)/2,sy=(ih-sh)/2;var start=Date.now(),add=0,stop=false,dx;if(this.animation_state){add=this.animation_state.progress*this.duration;if(this.animation_state.reverse!=reverse)add=this.duration-add;this.animation_state=null}function step(){var progress=(Date.now()-start+add)/_this.duration;if(stop){if(cb)cb(progress);return}if(progress>=1)dx=0;else dx=Math.floor(w*Math.asin(1-progress)*2/Math.PI);if(reverse){dx=w-dx;ctx.clearRect(0,0,w,h);if(_this.last_img){ctx.save();ctx.globalAlpha=1-progress;ctx.drawImage(_this.last_img,0,0,w,h);ctx.restore()}}ctx.drawImage(img,sx,sy,sw,sh,dx,0,w,h);_this.animation_state={progress:progress,reverse:reverse};if(progress<1)return void requestAnimationFrame(step);_this.animation_state=null;if(cb)cb(progress)}requestAnimationFrame(step);this.stop_animation_fn=function(){stop=true}};Animation.prototype.draw_image_full=function(ctx,img,w,h,reverse,cb){var iw=img.naturalWidth,ih=img.naturalHeight,_this=this;var sx=0,sy=0,sw=iw,sh=ih;var rx,ry,rw,rh;if(w<h){rh=ih*w/iw;rw=w}else{rw=iw*h/ih;rh=h}rx=(w-rw)/2;ry=(h-rh)/2;var start=Date.now(),add=0,stop=false,dx;if(this.animation_state){add=this.animation_state.progress*this.duration;if(this.animation_state.reverse!=reverse)add=this.duration-add;this.animation_state=null}function step(){var progress=(Date.now()-start+add)/_this.duration;if(stop){if(cb)cb(progress);return}if(progress>=1)dx=0;else dx=Math.floor(w*Math.asin(1-progress)*2/Math.PI);if(reverse){dx=w-dx;ctx.clearRect(0,0,w,h);if(_this.last_img){ctx.save();ctx.globalAlpha=1-progress;ctx.drawImage(_this.last_img,0,0,w,h);ctx.restore()}}var c=$(document.body).css("background-color");if(c&&c.startsWith("rgba(")&&c.match(/,\s*0\)$/))c=null;ctx.fillStyle=c||"white";ctx.fillRect(dx,0,w,h);ctx.drawImage(img,sx,sy,sw,sh,rx+dx,ry,rw,rh);_this.animation_state={progress:progress,reverse:reverse};if(progress<1)return void requestAnimationFrame(step);_this.animation_state=null;if(cb)cb(progress)}requestAnimationFrame(step);this.stop_animation_fn=function(){stop=true}};E.init=function(spark){log.notice("image_preview init");E.spark=spark;E.links=spark.links;var local_conf=storage.get_json("hola_image_preview_conf")||{};E.conf=zutil.defaults_deep({},window.hola_ve_image_preview_conf,local_conf,spark.conf.image_previews,E.default_conf);E.conf.debug=E.conf.debug||spark.conf.debug||/hola_ve_image_preview_debug/.test(window.location.href);E.stats=new Stats;E.watermark=watermark(assign({customer:spark.customer,module:"image_preview",delay:function(duration,pos){return 0},extra_css:{".hola_watermark":{"background-image":"url(//ve-cdn.h-cdn.com/svc/preview/pub/img/"+"watermark-transparent.svg)"},".hola_watermark:hover":{"background-image":"url(//ve-cdn.h-cdn.com/svc/preview/pub/img/"+"watermark-transparent.svg)"}}},E.conf.watermark));var update=function(){update_links(E.conf)};E.links.on("update",update);update();util.on("zbeforeunload",util.try_wrapper({prefix:"image_preview"},function(){E.stats.send_perr()}))};function Stats(){this.prefix="image_preview_";this.init()}Stats.prototype.init=function(reset){if(!reset&&this.stats&&!zutil.is_mocha())return void log.notice("stats already initialized");this.stats={};if(reset){this.hovers=this.hovers.map(function(){return{}});this.inc("stats_reset_n")}else{this.hovers=[];this.inc("init_n")}this.total_hover_ms=0;this.total_load_ms=0;this.total_play_ms=0;this.played_hover_ms=0;this.played_load_ms=0;this.loaded_not_played_hover_ms=0};Stats.prototype.add_preview=function(preview){var id=preview.get_id();preview.on("hover",this.try_wrapper(this.hover,id));preview.on("unhover",this.try_wrapper(this.unhover,id));preview.on("loaded",this.try_wrapper(this.loaded,id));preview.on("played",this.try_wrapper(this.played,id));this.hovers[id]={}};Stats.prototype.inc=function(s,v){return this.set(s,(this.get(s)||0)+(v||1))};Stats.prototype.set=function(s,v){return this.stats[this.prefix+s]=v};Stats.prototype.get=function(s){return this.stats[this.prefix+s]};Stats.prototype.get_stats=function(){var _this=this;this.hovers.forEach(function(h,id){if(h.active)_this.unhover(id)});function set_avg(key,total,count){if(total&&count)_this.set(key,total/count)}set_avg("hover_ms",this.total_hover_ms,this.get("hover_n"));set_avg("load_ms",this.total_load_ms,this.get("loaded_n"));set_avg("play_ms",this.total_play_ms,this.get("played_n"));set_avg("played_hover_ms",this.played_hover_ms,this.get("played_n"));set_avg("played_load_ms",this.played_load_ms,this.get("loaded_n"));set_avg("loaded_not_played_hover_ms",this.loaded_not_played_hover_ms,this.get("loaded_n")-(this.get("played_n")||0));return this.stats};Stats.prototype.hover=function(id){if(this.hovers[id].active)return;this.hovers[id]={active:true,start:date.monotonic()};this.inc("hover_n")};Stats.prototype.unhover=function(id){if(!this.hovers[id].active)return;var now=date.monotonic();var time=now-this.hovers[id].start;var loaded=this.hovers[id].loaded;var played=this.hovers[id].played;if(played){this.total_play_ms+=now-this.hovers[id].play_start;this.played_load_ms+=this.hovers[id].load_ms||0}if(loaded&&!played)this.loaded_not_played_hover_ms+=time;this.hovers[id].active=false;this.total_hover_ms+=time;if(loaded)return;if(time<300)this.inc("hover_under_300ms_n");else if(time<500)this.inc("hover_under_500ms_n")};Stats.prototype.loaded=function(id){if(this.hovers[id].loaded)return;this.hovers[id].loaded=true;this.hovers[id].load_ms=date.monotonic()-this.hovers[id].start;this.total_load_ms+=this.hovers[id].load_ms;this.inc("loaded_n")};Stats.prototype.played=function(id){if(!this.hovers[id].active||this.hovers[id].played)return;this.hovers[id].played=true;this.hovers[id].play_start=date.monotonic();this.played_hover_ms+=this.hovers[id].play_start-this.hovers[id].start;this.inc("played_n")};Stats.prototype.try_wrapper=function(func,arg){return util.try_wrapper({prefix:"image_preview_stats"},func.bind(this,arg))};Stats.prototype.send_perr=function(){if(!this.total_hover_ms)return;perr({id:"image_preview_stats",info:{stats:this.get_stats()},delay:false,use_beacon:true});this.init(true)};E.t={};return E});
define("/svc/cdn/pub/playlist.js",["cash","/util/es6_shim.js","/util/events.js","/util/util.js","/svc/cdn/pub/util.js","/util/conv.js","/util/ajax_lite.js","/util/sprintf.js","/util/etask.js","/svc/cdn/pub/zone_match.js","/util/storage.js","/svc/cdn/pub/watermark.js","/util/date.js"],function($,shim,events,zutil,util,conv,ajax,sprintf,etask,zone_match,storage,watermark,date){var assign=Object.assign,log={},E={},id="playlist";var wm_url="ve-cdn.h-cdn.com/svc/preview/pub/img/watermark-transparent.svg";E.default_conf={text:"coming up in <b>%d sec</b>...",sec_before_end:30,margin_bottom:41};zutil.inherits(NextPopup,events.EventEmitter);function NextPopup(playlist,frame){this.playlist=playlist;this.controls=playlist.controls;this.hidden=false;this.video_finished_t=null;this.iframe=frame;this.els={};this.render();this.inited=true}NextPopup.prototype.update_pos=function(){if(this.hidden||!this.iframe)return;var container=$(this.playlist.container);var width=container.width(),height=container.height();var player_pos=container.offset();if(!height)height=container.find("video").height();$(this.iframe).css({top:player_pos.top+height-E.conf.margin_bottom-(util.is_mobile?58:109)+"px",left:player_pos.left+width-(util.is_mobile?135:250)+"px"});setTimeout(this.update_pos.bind(this),500)};NextPopup.prototype.append=function(attr,val){var el=this.els[attr];el.empty();if(val)el.append(val)};NextPopup.prototype.render=function(){log.debug_spark("next popup render");this.update_pos();$(this.iframe).css({height:util.is_mobile?"58px":"109px",width:util.is_mobile?"130px":"244px","pointer-events":"all",display:"block"});$(this.iframe).addClass("hola_playlist");var el=this.dom_el=$(this.iframe.contentWindow.document);var els=this.els;[".wrapper",".overlay",".main",".poster",".description",".sec_timer",".clearfix",".watermark_container",".close"].forEach(function(cl){els[cl.slice(1)]=el.find(cl)});els.body=el.find("body");if(util.is_mobile)els.body.addClass("mobile");els.wrapper.addClass("slide_animation");var css=E.conf.css||{},player=this.playlist.player,next=E.next||{};this.video_pos_changed({dur:player.dur,pos:player.pos});if(next.poster){var img=$("<div>").addClass("poster_img");img.css({"background-image":"url("+next.poster+")"});this.append("poster",img)}this.add_watermark();this.append("description",next.description);els.main.attr("data-hola-playlist-link","");if(!E.conf.skip_preview)els.main.attr("data-hola-playlist-link",next.url||"");if(css.background_color)els.overlay.css({"background-color":css.background_color});if(css.font_family)els.body.css({"font-family":css.font_family});if(css.font_size){els.body.css({"font-size":css.font_size+"px"});els.sec_timer.css({"font-size":css.font_size-1+"px"})}this.t_hidden=els.sec_timer.css("display")=="none";this.bind_events();E.links.scan();E.stats_inc("show_popup_n")};NextPopup.prototype.add_watermark=function(){var watermark_obj=watermark(assign({module:id,customer:E.spark.customer,delay:function(){return 0},doc:this.dom_el[0],extra_css:{".hola_watermark .hola_hint":{margin:"0 5px"},".hola_watermark":{"background-image":"url(//"+wm_url+")"},".hola_watermark:hover":{"background-image":"url(//"+wm_url+")"}}},E.conf.watermark));if(!watermark_obj)return;var player=this.playlist.player;watermark_obj.apply({v:{html5:player.html5,get_duration:function(){return player.dur},get_pos:function(){return player.pos}},container:this.dom_el.find((E.next||{}).poster?".watermark_container":".wrapper")[0]})};NextPopup.prototype.show_element=function(el,hide){el.css("display",hide?"none":"block")};NextPopup.prototype.video_pos_changed=function(opt){var left=Math.ceil(opt.dur-opt.pos),sec_timer=this.els.sec_timer;if(left<=E.conf.sec_before_end){sec_timer.html(sprintf(E.conf.text,left));if(this.t_hidden)this.t_hidden=!!this.show_element(sec_timer)}else if(!this.t_hidden)this.t_hidden=!this.show_element(sec_timer,true)};NextPopup.prototype.video_finished=function(is_click){if(this.video_finished_t)this.video_finished_t=clearTimeout(this.video_finished_t);if(this.playlist.is_ad_active()){this.video_finished_t=setTimeout(this.video_finished.bind(this,is_click),500);return}if(E.conf.no_switch&&!is_click)return log.notice("not switching due to conf");if(this.hidden&&!E.conf.force_switch)return log.debug_spark("not switching due to closed popup");log.debug_spark("switching to another video");var next=E.next||{};if(E.conf.redir&&next.url){this.playlist.invalidate();this.uninit();E.stats_inc("next_url_n");return void setTimeout(function(){(E.target_win||window.top).location.href=next.url})}next=next.sources||[next];log.debug_spark("attempt to play next sources:",next);if(typeof next=="string")next=[{file:next}];E.stats_inc("next_src_n");this.playlist.controls.play_src(next);this.playlist.invalidate();this.uninit()};NextPopup.prototype.bind_events=function(){var _this=this,el=this.dom_el,els=this.els;this.video_pos_changed_fn=this.video_pos_changed.bind(this);this.video_finished_fn=function(is_click){if(is_click)return _this.video_finished(true);setTimeout(function(){_this.video_finished()},1500)};this.uninit_fn=this.uninit.bind(this);var one=function(target,event,cb){var fn=function(e){e.preventDefault();e.stopPropagation();cb();target.off(event,fn)};target.on(event,fn);return fn};this.on_close_fn=one(els.close,"click",function(){_this.hidden=true;$(_this.iframe).css("display","none");E.stats_inc("close_popup_n")});this.on_main_fn=one(els.main,"click",function(){_this.video_finished(true)});el.find(".playlist_watermark").on("click",function(event){event.stopPropagation()});this.playlist.on("detach",this.uninit_fn);this.playlist.on("video_pos_changed",this.video_pos_changed_fn);this.playlist.on("video_finished",this.video_finished_fn)};NextPopup.prototype.uninit=function(){if(!this.inited)return;log.debug_spark("popup uninit");this.playlist.off("detach",this.uninit_fn);this.playlist.off("video_pos_changed",this.video_pos_changed_fn);this.playlist.off("video_finished",this.video_finished_fn);this.sec_timer=undefined;var remove=function(){E.frames.push(this.iframe);this.els.wrapper.removeClass("slide_animation");$(this.iframe).css("display","none");this.els.close.off("click",this.on_close_fn);this.els.main.off("click",this.on_main_fn);this.els=this.iframe=undefined}.bind(this);if(E.conf.delay_hide)setTimeout(function(){remove()},E.conf.delay_hide*1e3);else remove();this.inited=false};zutil.inherits(Playlist,events.EventEmitter);Playlist.prototype.remove_popup=function(){if(this.next_popup)this.next_popup=this.next_popup.uninit()};Playlist.prototype.show_popup=function(){this.remove_popup();if(this.player.attached&&!this.controls.is_live_stream()&&E.frames.length){this.next_popup=new NextPopup(this,E.frames.shift())}};Playlist.prototype.persistent_mode=function(){return E.is_persistent_playing&&E.is_persistent_playing(this.container)||$(this.container).hasClass("floating-video")||$(this.container).closest(".floating-video").length>0||$(window.document.body).hasClass("floating-video-iframe")};Playlist.prototype.is_ad_active=function(){return E.is_ad_playing&&E.is_ad_playing(this.container)||this.controls.is_ad_active()||this.controls.ad_active};Playlist.prototype.monitor_playback=function(){if(!this.attached)return;var dur=this.player.dur,pos=this.player.pos,conf=E.conf;var allow_popup=dur&&pos&&(dur-pos<=conf.sec_before_end||!conf.disable_popup_on_pause&&pos>10&&this.controls.is_paused()&&!this.controls.is_seeking()||this.show_suggestion)&&!this.is_ad_active()&&!this.persistent_mode()&&E.next;if(!this.next_popup&&allow_popup)this.show_popup();else if(this.next_popup&&!allow_popup)this.remove_popup();if(this.next_popup&&(this.old_dur!=dur||this.old_pos!=pos))this.emit("video_pos_changed",{dur:dur,pos:pos});this.old_dur=dur;this.old_pos=pos};Playlist.prototype.attach=function(player){this.before_unload=this.detach.bind(this);util.on("beforeunload",this.before_unload);this.player=player;this.controls=player.controls;this.container=get_container(player);this.attached=true;if(!E.frames.length)preload_html();log.debug_spark("attached "+player.id)};Playlist.prototype.detach=function(){if(!this.attached)return;log.debug_spark("detach");this.attached=false;this.emit("detach");util.off("beforeunload",this.before_unload)};Playlist.prototype.invalidate=function(){E.next=E.master_next=undefined;E.msg.invalidate()};function Playlist(opt){if(!(this instanceof Playlist))return new Playlist(opt);this.id=opt.id||0;this.log=log}function rand_int(min,max){return Math.floor(Math.random()*(max-min))+min}function preload_handler(prefix,fn){var preload_err_t=rand_int(800,1200),start_ts=Date.now();var done=function(iframe,err){if(iframe)iframe.onload=iframe.onerror=undefined;if(!err||Date.now()-start_ts>=15*date.ms.MIN)return;setTimeout(cb,preload_err_t);preload_err_t*=rand_int(1,3)};var cb=fn.bind(null,done);cb()}function get_html(){var wrapper=$("<div>").addClass("wrapper");wrapper.append($("<div>").addClass("overlay"));var main=$("<div>").addClass("main");["poster","description","sec_timer","clearfix","watermark_container"].forEach(function(cl){main.append($("<div>").addClass(cl))});wrapper.append(main);wrapper.append($("<a>").addClass("close skip-preview").attr("href","#"));var css=$("<link>").attr("rel","stylesheet").attr("href","//player.h-cdn.com"+require.zdot("playlist_css"));return"<html><head>"+$("<div>").append(css).html()+"</head><body>"+$("<div>").append(wrapper).html()+"</body></html>"}function preload_html(){if(["pr_started","pr_failed"].includes(E.state))return;var html=get_html();E.state="pr_started";preload_handler("html_preload",function(done){try{var iframe=document.createElement("iframe");$(iframe).css({position:"absolute",left:"-1000px",top:"-1000px",width:"1px",height:"1px",border:"none",margin:0,padding:0,overflow:"hidden",display:"none","z-index":2147483647});$(iframe).attr("scrolling","no");document.body.appendChild(iframe);iframe.contentWindow.document.open();iframe.contentWindow.document.write(html);iframe.contentWindow.document.close();iframe.onload=function(){log.debug_spark("html/css preload success");E.state="pr_success";E.frames.push(iframe);done(iframe)};iframe.onerror=function(){log.debug_spark("html/css preload error");E.state="pr_failed";E.stats_inc("preload_err_n");done(iframe,true)}}catch(e){log.debug_spark("preload error",e);done(undefined,e)}})}function get_playlist_next(ctx,pl){if(!pl.length)return;if(E.conf.cursor_disabled)return pl[0];var url,idx=storage.get_int("hola_playlist_cursor")+1||0;var len=pl.length;idx%=len;url=pl[idx].url;if(url&&(url==util.get_url_frame().top_url||ctx&&url==ctx.player.controls.get_url())){idx=(idx+1)%len}storage.set("hola_playlist_cursor",idx);return pl[idx]}function get_next_by_selector(){var sel=E.conf.selectors;if(!sel||!Object.keys(sel).length)return;etask([function(){return E.msg.next_video()},function(next){E.next=next||E.next}]);var len=0,base=document,win=window.self;if(sel.item){var item,old_win;while(!(item=$(base).find(sel.item).get(0))){if(win.parent==win)break;old_win=win;try{win=win.parent;base=win.document;log.debug_spark("going to parent..",win.name)}catch(e){win=old_win;base=old_win.document;break}}if(!item)return void setTimeout(find_next_video,1e3);len=$(base).find(sel.item).length}E.target_win=win;var get_fn=function(selector,selector_js,prop,idx){var _$=function(selector){return $(base).find(selector)};if(typeof selector=="function")return selector(_$,idx);if(selector_js){var fn=new Function("_$","pc",selector_js);return fn(_$,idx)}return(_$(selector).get(idx)||{})[prop]};var idx,next,playlist=[];for(idx=0,next={url:1};idx<len||!len&&next.url;idx++){next={url:get_fn(sel.link,sel.link_js,"href",idx),poster:get_fn(sel.img,sel.img_js,"src",idx),description:get_fn(sel.desc,sel.desc_js,"innerText",idx)};if(next.url)playlist.push(next)}return playlist}function find_next_video(pl){var next,plist,conf=E.conf;if(E.next&&E.next.url)return;if(!E.next_fn){var next_by=conf.next_by?conf.next_by:"selector";switch(next_by){case"selector":E.next_fn=get_next_by_selector;break;case"api":E.next_fn=function(){return E.api_next};break;case"none":log.debug_spark("next video popup disabled");break;default:log.debug_spark("unsupported option: "+next_by);break}if(!E.next_fn)return}if(!(plist=E.next_fn(pl))||!(next=get_playlist_next(pl,plist)))return;E.master_next=next;if(conf.sources&&!conf.redir){log.debug_spark("requesting data from",next.url);etask([function(){return ajax.raw({url:next.url})},function(res){log.debug_spark("got response");var parser=new DOMParser;var doc=parser.parseFromString(res,"text/html");next.sources=conf.sources($,doc);log.debug_spark("next sources are",next.sources);E.next=next},function catch$(e){log.debug_spark(e)}])}else E.next=next}function on_player_attach(player,ctx,reason){log.debug_spark("on player attached "+player.id);if(!E.monitor)E.monitor=setInterval(update_players,500);var pl_ctx;if(!(pl_ctx=ctx.attached_pl)){pl_ctx=ctx.attached_pl=new Playlist({id:player.wrapper.id});pl_ctx.attach(player);E.playlist.push(pl_ctx);find_next_video(pl_ctx)}var on_ended=this.emit.bind(pl_ctx,"video_finished");var show_suggestion=function(hide){this.show_suggestion=!hide;this.monitor_playback()};var play_next=this.emit.bind(pl_ctx,"video_finished",true);var on_show_suggestion=show_suggestion.bind(pl_ctx);var on_hide_suggestion=show_suggestion.bind(pl_ctx,true);var controls=player.controls;controls.on("pre-ended",on_ended);controls.on("next_suggestion_show",on_show_suggestion);controls.on("next_suggestion_hide",on_hide_suggestion);controls.on("next_suggestion_play",play_next);player.once("detach",function(ctx,reason){log.debug_spark("on player detached "+player.id);var index=E.playlist.indexOf(pl_ctx);if(index>=0){E.playlist.splice(index,1);pl_ctx.detach(player);pl_ctx=ctx.attached_pl=undefined}controls.off("ended",on_ended);controls.off("next_suggestion_show",on_show_suggestion);controls.off("next_suggestion_hide",on_hide_suggestion);controls.off("next_suggestion_play",play_next);if(!E.playlist.length)E.monitor=clearInterval(E.monitor)})}function update_players(){E.playlist.forEach(function(pl){pl.monitor_playback()})}function match_conf(conf){assign(E.conf,conf.find(function(c){c=c||{};if(!c.match)return c;var matched,match=c.match,url_frame=util.get_url_frame();var match_opt={url:url_frame.top_url,browser:util.browser_rule_s,os:util.guess.os,frame_url:url_frame.frame_url};if(!match.js)match.js=zone_match.make_fn(match);try{var match_fn=new Function("opt",match.js);matched=match_fn(match_opt)}catch(e){log.err(e)}if(matched)return c}))}E.set_next_video=function(opt){E.set([opt])};E.set=function(opts){E.api_next=opts;E.conf.next_by="api";E.next_fn=undefined;find_next_video()};function get_container(player){var c,el=player.controls.get_container();if(c=E.conf.player&&E.conf.player.container)return typeof c=="function"?c($,el):$(el).closest(c).get(0);return player.container||el}function setup_msg_handlers(){E.msg.add_handler("next_video",function(){return E.next||E.master_next});E.msg.add_handler("invalidate",function(){E.next=E.master_next=undefined;find_next_video()})}E.init=function(spark){E.spark=spark;E.links=spark.links;log=E.spark.log(id);E.conf=zutil.defaults_deep(E.spark.conf[id],E.default_conf);if(E.conf.conf)match_conf(E.conf.conf);E.playlist=[];E.frames=[];E.stats_inc=function(s,v){spark.stats.inc(id+"_"+s,v)};E.msg=E.spark.Msg("pl");setup_msg_handlers();preload_html();find_next_video();E.spark.players.on("attach",on_player_attach);if(typeof E.conf.ad_detect=="function"){E.is_ad_playing=function(container){return E.conf.ad_detect(function(s){return $(document).find(s)},container)}}if(typeof E.conf.persistent_detect=="function"){E.is_persistent_playing=function(container){return E.conf.persistent_detect(function(s){return $(document).find(s)},container)}}E.spark.loader.playlist={set_next_video:E.set_next_video,set:E.set};E.inited=true;log.debug_spark("inited")};return E});
define("/svc/cdn/pub/autoplay.js",["cash","/util/util.js","/svc/cdn/pub/util.js"],function($,zutil,util){var log,id="autoplay";var E={};E.default_conf={volume_mode:"scroll",min_volume:20,max_volume:100};E.controllers=[];E.active=null;function Controller(player){this.player=player;var video;if(util.is_ios&&(video=zutil.get(player,"controls.html5")))$(video).attr({playsinline:1})}Controller.prototype.ignore=function(){var p=this.player.controls;return p.is_autostart()||this.manual_pause||!this.active&&p.is_playing()&&!zutil.get(p,"persistent_video.is_floating")};Controller.prototype.distance=function(vp){var rect=(zutil.get(this.player.controls,"persistent_video.holder")||this.player.container).getBoundingClientRect();var pl={x:rect.left+(rect.right-rect.left)/2,y:rect.top+(rect.bottom-rect.top)/2};if(pl.x<vp.left||pl.x>vp.right||pl.y<vp.top||pl.y>vp.bottom)return;var vp_center={x:vp.left+vp.width/2,y:vp.top+vp.height/2};var distance=Math.sqrt(Math.pow(pl.x-vp_center.x,2)+Math.pow(pl.y-vp_center.y,2));var max=Math.sqrt(Math.pow(vp.height,2)+Math.pow(vp.width,2))/2;return distance/max};Controller.prototype.start=function(){if(this.active)return;var pl=this.player;this.active=true;log.notice("play "+pl.id);if(E.conf.volume_mode=="mute")pl.controls.muted(true);pl.controls.play();this.watch_volumechange()};Controller.prototype.stop=function(){if(!this.active)return;var pl=this.player;this.active=false;if(pl.controls.is_paused()){log.notice("manual pause "+pl.id);this.manual_pause=true;return}if(zutil.get(pl.controls,"persistent_video.is_floating")){log.notice("mute floating "+pl.id);pl.controls.muted(true)}else{log.notice("pause "+pl.id);pl.controls.pause()}this.unwatch_volumechange()};Controller.prototype.set_volume=function(value){var pl=this.player;if(E.conf.volume_mode!="scroll"||this.manual_volume)return;this.unwatch_volumechange();pl.controls.muted(false);var min=E.conf.min_volume/100||0,max=E.conf.max_volume/100||1;pl.controls.volume(min+(max-min)*value);this.watch_volumechange()};Controller.prototype.watch_volumechange=function(){var _this=this;if(this.on_volumechange)return;this.on_volumechange=function(){log.notice("manual volume "+_this.player.id);_this.manual_volume=true};this.volumechange_t=setTimeout(function(){_this.player.controls.on("volumechange",_this.on_volumechange)},100)};Controller.prototype.unwatch_volumechange=function(){if(this.on_volumechange)this.player.controls.off("volumechange",this.on_volumechange);this.on_volumechange=null;clearTimeout(this.volumechange_t)};Controller.prototype.uninit=function(){this.unwatch_volumechange()};function set_active(ctrl){if(ctrl==E.active)return;if(E.active)E.active.stop();E.active=ctrl;if(E.active)E.active.start()}function on_scroll(){var active,min;var vp=util.visual_viewport();E.controllers.forEach(function(ctrl){if(ctrl.ignore())return;var distance=ctrl.distance(vp);if(distance!==undefined&&(min===undefined||distance<min)){active=ctrl;min=distance}});if(active)active.set_volume(1-min);set_active(active)}function on_player_add(pl){log.notice("attach "+pl.id);E.controllers.push(new Controller(pl));on_scroll()}function on_player_remove(pl){var ctrl=E.controllers.find(function(c){return c.player==pl});if(!ctrl)return;ctrl.uninit();if(E.active==ctrl)set_active(null);E.controllers.splice(E.controllers.indexOf(ctrl),1);on_scroll()}E.init=function(spark){E.spark=spark;log=E.spark.log(id);var conf=spark.get_platform_conf(E.spark.conf[id]);E.conf=zutil.defaults_deep(conf,E.default_conf)||{};if(util.is_mobile||util.is_safari)E.conf.volume_mode="mute";var update=util.throttle(on_scroll,300);if(util.is_mobile)$(window).on("orientationchange",update);$(window).on("scroll",update);if(window.visualViewport){window.visualViewport.addEventListener("scroll",update);window.visualViewport.addEventListener("resize",update)}E.spark.players.forEach(on_player_add);E.spark.players.on("add",on_player_add);E.spark.players.on("remove",on_player_remove);update();E.inited=true;log.notice("inited")};return E});
define("/svc/cdn/pub/spark.js",["cash","/util/util.js","/util/url.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cdnlist.js","/util/etask.js","/svc/cdn/pub/spark_features.js","/svc/cdn/pub/persistent_video.js","/svc/cdn/pub/thumbnails.js","/svc/cdn/pub/preview.js","/svc/cdn/pub/watch_later.js","/svc/cdn/pub/zone.js","/svc/cdn/pub/log.js","/svc/cdn/pub/links.js","/util/storage.js","/svc/cdn/pub/position_memory.js","/util/events.js","/util/conv.js","/svc/cdn/pub/spark_welcome.js","/util/date.js","/svc/cdn/pub/image_preview.js","/svc/cdn/pub/playlist.js","/svc/cdn/pub/autoplay.js"],function($,zutil,zurl,util,cdnlist,etask,spark_features,persistent_video,thumbnails,preview,watch_later,_zone,_log,links,storage,position_memory,events,conv,spark_welcome,date,image_preview,playlist,autoplay){var E={};var log=_log?_log.set_module("spark"):{warn:function(){},info:function(){}};if(!events)events={EventEmitter:function(){}};var assign=Object.assign;var perr=util.cdn_perr;E.libs=spark_features.libs;E.libs.links.module=links;E.features=spark_features.features;E.features.persistent.module=persistent_video;E.features.video_previews.module=preview;E.features.thumbnails.module=thumbnails;E.features.watch_later.module=watch_later;E.features.position_memory.module=position_memory;E.features.playlist.module=playlist;E.features.autoplay.module=autoplay;var use_image_preview=window.hola_ve_image_preview||storage.get("hola_ve_image_preview")||location.href.match(/hola_ve_image_preview=(1|on)/);if(use_image_preview)E.features.image_previews.module=image_preview;E.modules=assign({},E.features,E.libs);function use_feature(feature){var enabled=E.is_feature_enabled(feature);var code_exists=!!E.features[feature].module.init;if(enabled&&!code_exists)log.warn(feature+" code missing - enable in customer conf");return enabled||code_exists&&E.force_enable(feature)}function debug_init(){E.loader.debug_spark=E.debug_spark;if(storage.get("hola_debug_spark")||util.get_hola_uri("hola_debug_spark"))E.debug_spark()}E.log=function(module){var spark_log=_log?_log.set_module(module):{notice:function(){},info:function(){}};spark_log.debug_spark=function(){var args=[].slice.call(arguments);spark_log[E.conf.debug?"notice":"info"].apply(spark_log,args)};return spark_log};E.force_enable=function(feature){var var_name=E.modules[feature].force_enable;return[true,1].includes(window[var_name])||["true","1","on"].includes(util.get_hola_uri({},var_name))||["true","1","on"].includes(storage.get(var_name))};function hash_parse(){var hash={};if(!window||!window.location||!window.location.hash)return hash;var h=window.location.hash.substr(1).split("&");h.forEach(function(p){var args=p.split("=");if(args[0]=="spark"){hash.spark={};args[1].split(";").forEach(function(a){hash.spark[a]=true})}else hash[args[0]]=args[1]||true});return hash}E.hash_get=function(n){return(E.hash.spark||{})[n]};function feature_init(o){if(!zutil.is_mocha()&&o.inited)return;(o.dep||[]).forEach(function(dep){feature_init(E.modules[dep])});o.inited=true;util.try_wrapper({prefix:o.s_enable.replace(".enable","")},o.module.init)(E);o.welcome=spark_welcome.available_for(o.name)}E.page2cache=function(url){return E.zone.conf_apply("agent.page2cache",[url,{mobile:util.is_mobile}],util.def_url2cache(url))};E.video2cache=function(url,adaptive){return E.zone.conf_apply(adaptive?"agent.manifest2cache":"agent.url2cache",[url],util.def_url2cache(url))};function set_top_url(url){return E.top_url=E.page2cache(url)}E.get_top_url=function(){return set_top_url(util.get_top_url())};E.verify_top_url=etask.fn([function(){return E.msg.get_top_url()},function(res){if(res)return set_top_url(res)}]);E.init=function(opt){E.loader=opt.loader;if(!E.loader.allow_feature_init()){console.log("%cHolaSpark.com enhancements suspended","color: blue; font-size: 15px");return}E.conf=zutil.extend_deep({},opt.conf,util.get_spark_conf());E.customer=opt.loader.customer;E.zone=new _zone(E.loader,assign({zone:"gen"},opt.gen));E.storage=new Storage("hola_spark");E.hash=hash_parse();E.players=new Players;E.msg=new E.Msg("spark",{cross_domain_master_only:true});E.msg.add_handler("get_top_url",function(){return E.get_top_url()},{exec_on_self:true});E.stats=new Stats("spark");debug_init();E.verify_top_url();var s="",d="",welcome=[];if(zutil.get(E.conf,"disable"))return;for(var feature in E.features){var o=E.features[feature];if(o.module&&use_feature(feature)){feature_init(o);s+=(s?", ":"")+o.title;if(o.welcome)welcome.push(o.name)}else d+=(d?", ":"")+o.title}if(s){console.log("%cVideo enhancements powered by HolaSpark.com","color: blue; font-size: 15px");console.log("%cEnabled features: "+s,"color: blue");if(d)console.log("%cAvailable features: "+d,"color: green");console.log("Embedded in frame: "+location.href);if(E.is_welcome_enabled()&&welcome.length){spark_welcome.init(zutil.get(E.conf,"welcome.strings"));spark_welcome.show_once(welcome)}}util.on("zbeforeunload",util.try_wrapper({prefix:"spark"},function(){E.stats.send_perr()}))};E.debug_spark=function(v){E.conf.debug=v===undefined?true:v;log.notice("spark debug mode is ",E.conf.debug);if(E.conf.debug)storage.set("hola_debug_spark",E.conf.debug);else storage.clr("hola_debug_spark")};E.is_browser_allowed=function(list){var browser=util.browser&&util.browser.browser;if(list instanceof Array){if(!list.length||!browser||!list.includes(browser))return false;return true}if(!list||!browser)return true;var include=list.include||[];var exclude=list.exclude||[];var ucbrowser=util.browser&&util.browser.ucbrowser;if(ucbrowser&&(exclude.includes("ucbrowser")||include.includes("ucbrowser"))){browser="ucbrowser"}if(exclude.includes(browser))return false;if(!include.length||include.includes(browser))return true;return false};E.is_platform_allowed=function(opt){if(!opt)return true;if(util.is_mobile)return!opt.mobile_disabled;return!opt.desktop_disabled};E.is_url_allowed=function(list){return E.check_url(E.top_url,list)};E.is_player_allowed_by_css=function(player,filter){if(!filter)return true;var include=filter.include||[];var exclude=filter.exclude||[];var container=player.get_container();function match(selector){if(!selector||!container)return false;return(container.matches||container.msMatchesSelector||container.webkitMatchesSelector).call(container,selector)}if(exclude.find(match))return false;if(!include.length||include.find(match))return true;return false};E.get_platform_conf=function(conf){conf=conf||{};if(util.is_mobile&&conf.mobile){return conf.mobile.use_desktop_conf?assign({},conf.desktop,{disable:conf.mobile.disable}):conf.mobile}if(!util.is_mobile&&conf.desktop)return conf.desktop;return conf};E.is_feature_enabled_by_conf=function(conf){conf=conf||{};if(util.has_ext)return conf.enable;var platform_conf=E.get_platform_conf(conf)||{};if(!platform_conf.disable&&E.is_browser_allowed(platform_conf.browsers)&&E.is_url_allowed(platform_conf.urls)&&E.is_platform_allowed(platform_conf.platform)){return conf.enable}return false};E.is_feature_available=function(feature){var os_ver;if(feature=="video_previews"&&util.is_ios){os_ver=util.guess.version&&util.guess.version.split(".");os_ver=+(os_ver&&os_ver[0]);return!os_ver||os_ver>=10}return true};E.is_feature_enabled=function(feature){return E.is_feature_available(feature)&&E.is_feature_enabled_by_conf(E.conf[feature]||{})};E.is_feature_inited=function(feature){return E.modules[feature]&&E.modules[feature].inited};E.is_welcome_enabled=function(){return!util.is_mobile&&E.is_feature_enabled("welcome")};E.on=function(e,cb){E.loader.on(e,cb)};E.off=function(e,cb){E.loader.off(e,cb)};E.on_wrapper_attached=function(cb){E.on("wrapper_attached",function(wrapper){if(E.is_player_allowed_by_css(wrapper.player,zutil.get(E.conf,"general.player.filter_by_css"))){cb.apply(this,arguments)}})};E.on_wrapper_detached=function(cb){E.on("wrapper_detached",cb)};E.on_wrapper_attach_video=function(cb){E.on("wrapper_attach_video",cb)};E.check_url=function(url,filter){if(!filter)return true;var include=filter.include||[];var exclude=filter.exclude||[];function match(glob){if(!glob)return false;var rx=new RegExp("^"+zurl.http_glob_url(glob,false));return rx.test(url)}if(exclude.find(match))return false;if(!include.length||include.find(match))return true;return false};E.fetch_from_fastest=function(cmd,route,opt){var cdns,_this=this;opt=opt||{};return etask([function(){cdns=opt.cdnlist instanceof cdnlist.Cdn_list?opt.cdnlist:Array.isArray(opt.cdnlist)||opt.cdnlist&&opt.cdnlist.host?new cdnlist.Cdn_list({cdns:opt.cdnlist.host?[opt.cdnlist]:opt.cdnlist,zone:opt.zone||_this.zone}):E.conf.cdns?new cdnlist.Cdn_list({cdns:E.conf.cdns,zone:opt.zone||_this.zone}):cdnlist.get_fast_cdns({dedicated:opt.dedicated===undefined?true:opt.dedicated,zone:opt.zone||_this.zone,allow_alt:opt.allow_alt||true});if(!opt.cdnlist&&!E.conf.cdns&&cdns.length<3){return cdnlist.get_closest(opt.zone||_this.zone,{fast_limit:3-cdns.length})}},function(closest){if(closest){cdns.add(closest);closest.uninit()}cdns.send(cmd,route,opt.data,this.continue_fn(),{timeout:opt.timeout,gap_ms:opt.gap_ms,on_req:opt.on_req,on_res:opt.on_res,xhr_only:E.conf.debug});return this.wait()},function(res){if(opt.cb)opt.cb(res);return res},function finally$(){if(cdns instanceof cdnlist.Cdn_list&&cdns!=opt.cdnlist)cdns.uninit()}])};E.fetch_from_master=function(cmd,route,opt){opt=opt||{};var cdns=cdnlist.local_url2cdns(opt.zone||this.zone,cdnlist.all_agents,util.geoip,route.video_url,assign(util.get_url_frame(),{user_agent:navigator&&navigator.userAgent,segment_url:route.segment_url}));if(!cdns||!cdns.length||!cdns.get_master())return;return E.fetch_from_singles(cmd,route,assign(opt,{cdnlist:cdns.get_master()}))};E.fetch_from_singles=function(cmd,route,opt){var cdns,_this=this,sp;opt=opt||{};opt.timeout=opt.timeout||1e4;opt.gap_ms=opt.gap_ms||2e3;function cb(res){if(opt.on_res)opt.on_res(res.cdn.index,res);if(res.err)throw new Error("failed");if(!sp&&opt.wait_for_all&&opt.cb)opt.cb(res);if(sp)sp.continue(res)}return etask([function(){sp=this;this.sent=[]},function send(){cdns=opt.cdnlist instanceof cdnlist.Cdn_list?opt.cdnlist:Array.isArray(opt.cdnlist)||opt.cdnlist&&opt.cdnlist.host?new cdnlist.Cdn_list({cdns:opt.cdnlist.host?[opt.cdnlist]:opt.cdnlist,zone:opt.zone||_this.zone}):E.conf.cdns?new cdnlist.Cdn_list({cdns:E.conf.cdns,zone:opt.zone||_this.zone}):cdnlist.local_url2cdns(opt.zone||_this.zone,cdnlist.all_agents,util.geoip,route.video_url,assign(util.get_url_frame(),{user_agent:navigator&&navigator.userAgent,segment_url:route.segment_url}));if(!cdns||!cdns.length)return this.return();var cdn=cdns.find(function(c){return!sp.sent.includes(c.host)});if(!cdn){return this.wait(Math.max(opt.timeout-opt.gap_ms*cdns.length,2e3))}cdn.index=cdns.arr.indexOf(cdn);if(opt.on_req)opt.on_req(cdn.index);this.sent.push(cdn.host);cdn.using(opt.zone||_this.zone).send(cmd,route,opt.data,cb,{xhr_only:E.conf.debug});return this.wait(opt.gap_ms||2e3)},function(res){if(opt.cb)opt.cb(res);sp=undefined;return res},function catch$(err){if(err=="timeout"&&this.sent.length<cdns.length)return this.goto("send");this.return({err:err})},function finally$(){if(cdns instanceof cdnlist.Cdn_list&&cdns!=opt.cdnlist)cdns.uninit()}])};zutil.inherits(Players,events.EventEmitter);function Players(){this.arr=[];this.length=0;E.on_wrapper_attached(this.attach_player.bind(this));E.on_wrapper_detached(this.detach_player.bind(this))}Players.prototype.forEach=function(func,a){this.arr.forEach(func,a)};Players.prototype.find=function(func){return this.arr.find(func)};Players.prototype.attach_player=function(wrapper){var player=new Player(wrapper);this.arr.push(player);this.length=this.arr.length;this.emit("add",player)};Players.prototype.detach_player=function(wrapper){var player=this.arr.find(function(p){return p.wrapper==wrapper});if(!player)return;player.uninit();this.arr.splice(this.arr.indexOf(player),1);this.length=this.arr.length;this.emit("remove",player)};zutil.inherits(Storage,events.EventEmitter);function Storage(name,parent,init){if(!(this instanceof Storage))return new Storage(name,parent,init);if(arguments.length==2&&!(parent instanceof Storage)){init=parent;parent=undefined}this.name=name;this.init=init||{};if(parent){this.parent=parent;var path=name.split(".");var j=parent.o;for(var i=0;i<path.length;i++){if(j[path[i]]===undefined||typeof j[path[i]]!="object")j[path[i]]={};j=j[path[i]]}this.o=j}else{try{this.o=conv.JSON_parse(window.localStorage.getItem(name))}catch(e){}this.o=this.o||this.init}this.orig=zutil.clone_deep(this.o)}Storage.prototype.set_leaf_max_stale=function(path,max_stale){return this.set_max_stale(path,max_stale,true)};Storage.prototype.set_max_stale=function(path,max_stale,leaf){path=!path?[]:path.split(".");var o=this.o;for(var i=0;i<path.length;i++){if(o[path[i]]===undefined||typeof o[path[i]]!="object")o[path[i]]={};o=o[path[i]]}var now=date();if(leaf){o.___leaf_max_stale=max_stale;Object.keys(o).forEach(function(l){if(o[l].constructor==Object&&!o[l].___ts)o[l].___ts=now})}else{o.___max_stale=max_stale;o.___ts=now}this.sync()};Storage.prototype.get=function(path,init){return new Storage(path,this,init)};Storage.prototype.sync=function(){if(this.parent)return this.parent.sync();var diff,now=date();function scan(o,g,max_stale){var eq=zutil.equal_deep(o,g);diff=!eq||diff;if(o.___max_stale&&eq&&now-o.___ts>o.___max_stale*date.ms.SEC)return true;if(max_stale&&eq&&o.___ts&&now-o.___ts>max_stale*date.ms.SEC)return true;if(!eq&&(max_stale||o.___max_stale)){o.___ts=now;diff=true}if(o.constructor==Object){Object.keys(o).forEach(function(k){if(o[k]===undefined||o[k].constructor!=Object)return;g[k]=g[k]||{};if(scan(o[k],g[k],o.___leaf_max_stale)){o[k]=undefined;diff=true}})}}if(scan(this.o,this.orig)){this.o=this.init;diff=true}if(diff&&window.localStorage){window.localStorage.setItem(this.name,conv.JSON_stringify(this.o));this.orig=zutil.clone_deep(this.o)}};zutil.inherits(Player,events.EventEmitter);function Player(wrapper){if(!(this instanceof Player))return new Player;this.wrapper=wrapper;this.attached=false;this.controls=this.wrapper.player;this.html5=this.controls.html5;this.id=this.controls.name+"_"+this.controls.player_id;this.container=get_container(this.controls.get_container());this.name=this.controls.kaltura?"kaltura":this.controls.name;this.before_unload=this.uninit.bind(this);this.on_new_context=function(ctx){var handlers={started:this.attach.bind(this,ctx,"attach"),"pre-suspend":this.detach.bind(this,ctx,"suspend"),"post-restore":this.attach.bind(this,ctx,"restore"),"post-shutdown":this.detach.bind(this,ctx,"detach")};ctx.multi_on(handlers);ctx.once("post-shutdown",function(){ctx.multi_off(handlers)})}.bind(this);this.wrapper.on("context_created",this.on_new_context);util.on("beforeunload",this.before_unload)}Player.prototype.monitor_playback=function(){if(!this.attached||this.controls.is_any_ad_mode())return;var dur=this.controls.get_duration();var pos=this.controls.get_pos();if(this.dur!=dur||this.pos!=pos)this.emit("pos_change",{dur:dur,pos:pos});this.dur=dur;this.pos=pos};Player.prototype.seek=function(pos){var _this=this;function seek_to_same_pos(){var now=_this.controls.get_pos(),margin=5;return pos>now-margin&&pos<now+margin}function check_seek_waiting(){pending_seek_cancel();return _this.controls.is_any_ad_mode()&&!!(_this.pending_seek=setTimeout(_this.seek.bind(_this,pos),500))}function pending_seek_cancel(opt){if(!_this.pending_seek)return;_this.controls.off("seeked",pending_seek_cancel);_this.pending_seek=clearTimeout(_this.pending_seek)}if(isNaN(pos)||pos<0||check_seek_waiting()||seek_to_same_pos())return;this.pending_seek=setTimeout(check_seek_waiting,1e3);this.controls.once("seeked",pending_seek_cancel);this.controls.seek(Math.round(pos*1e3))};Player.prototype.uninit=function(){if(this.attached)this.detach(this.attached,"uninit");this.wrapper.off("context_created",this.on_new_context);util.off("beforeunload",this.before_unload)};function get_container(container){var sel="*";var conf=E.conf.general;if(conf&&conf.player&&conf.player.container)sel=conf.player.container;return $(container).closest(sel)[0]}function allow_disabled(ctx){var block=["filtered out","skip enforced from page uri","bing preview","origin is not allowed","ad video in non-ad zone"];if(Array.isArray(E.conf.allow_skip_reasons)){block=block.filter(function(e){return!E.conf.allow_skip_reasons.includes(e)})}var skip=ctx.skip_reasons.filter(function(r){return block.includes(r)});return!skip.length}Player.prototype.attach=function(ctx,reason){if(this.attached||this.controls.is_ad_source()||ctx.is_disabled()&&!allow_disabled(ctx)){return}this.attached=ctx;this.adaptive=this.wrapper.adaptive;this.mode=this.wrapper.CG("mode");this.url=this.wrapper.video_url;this.url_key=zurl.parse(E.video2cache(this.url,this.adaptive)).path;this.monitor=setInterval(this.monitor_playback.bind(this),1e3);log.info("attach to "+this.id);E.verify_top_url();E.players.emit("attach",this,ctx,reason)};Player.prototype.detach=function(ctx,reason){if(!this.attached)return;this.attached=undefined;if(this.monitor){this.monitor=clearInterval(this.monitor);this.pos=this.duration=undefined}log.info("detach from "+this.id);this.emit("detach",ctx,reason);E.players.emit("detach",this,ctx,reason)};zutil.inherits(Msg,events.EventEmitter);function Msg(domain,opt){if(!(this instanceof E.Msg))return new E.Msg(domain,opt);this.domain=domain;this.opt=opt||{};this.log=E.log("msg_"+this.domain);this.handlers={};this.id=0;this.resps={};this.master=this.get_master();this.start_msg_loop();if(this.opt.child_frames)this.setup_child_frames();this.log.debug_spark("frame messaging inited")}E.Msg=Msg;Msg.prototype.is_master=function(){return!this.master};Msg.prototype.reset_master=function(){this.master=undefined;this.setup_handlers()};Msg.prototype.get_master=function(){if(this.opt.cross_domain_master_only){var w,d;if(!window.location.href.match(/^https?:\/\/holaspark\.com\//)){try{w=window.top||window;d=w.document}catch(e){return{frame:window.top}}}return}if(window.top!=window)return{frame:window.top}};Msg.prototype.send_msg=function(dst,msg,data){var o=dst.origin||"*";this.log.debug_spark("sent msg "+msg+" to "+o+" with payload "+JSON.stringify(data));dst.frame.postMessage({type:"spark",domain:this.domain,cmd:msg,data:data},o)};Msg.prototype.send_req=etask._fn([function(_this,dst,msg,data){this.frame_msg=_this;if(!data)data={};data.resp_id=_this.id++;_this.resps[data.resp_id]=this;_this.send_msg(dst,msg,data);return this.wait()},function(resp){var _this=this.frame_msg;delete _this.resps[resp.resp_id];delete resp.resp_id;return resp}]);Msg.prototype.find_frame=function(src){var id=0;for(var f in this.frames){if(this.frames[f].origin==src.origin)id=f}return id};Msg.prototype.start_msg_loop=function(){var _this=this;window.addEventListener("message",function(event){var msg=event.data;if(msg.type!="spark"||msg.domain!=_this.domain||!msg.cmd)return;_this.log.debug_spark("received msg "+msg.cmd+" with payload "+JSON.stringify(msg.data));if(msg.cmd=="result"){if(!_this.resps[msg.data.resp_id]){_this.log.debug_spark("received a result message with "+"unknown resp_id")}_this.resps[msg.data.resp_id].continue(msg.data);return}if(!_this.handlers[msg.cmd]){_this.log.debug_spark("received an unknown message "+msg.cmd);return}var src={frame:event.source,origin:event.origin};etask([function(){if(_this.is_master()&&_this.opt.child_frames)msg.data.args.unshift(_this.find_frame(src));msg.data.args.push(src);return _this.handlers[msg.cmd].apply(null,msg.data.args)},function(data){var res={};res.data=data;res.resp_id=msg.data.resp_id;_this.send_msg(src,"result",res)}])})};Msg.prototype.setup_child_frames=function(){var _this=this,master_polling_int;this.frames={};this.frame_id=0;this.add_handler("_msg_hello",function(fid,src){if(!fid){var id=_this.frame_id++;_this.frames[id]=src;_this._msg_hello_ack(id);_this.emit("frame_found",id)}});this.add_handler("_msg_goodbye",function(fid){if(!fid)return;delete _this.frames[fid];_this.emit("frame_removed",fid)});this.add_frame_handler("_msg_hello_ack",function(){if(master_polling_int){clearInterval(master_polling_int);master_polling_int=undefined}window.addEventListener("unload",function(){_this._msg_goodbye()});_this.log.debug_spark("master have responded");_this.emit("master_found")});if(!this.is_master()){this.log.debug_spark("trying to contact master frame...");master_polling_int=setInterval(function(){_this._msg_hello()},1e3)}};Msg.prototype.create_handler=function(name,dst){var _this=this;return etask.fn([function(){var data={args:arguments.length==1?[arguments[0]]:Array.apply(null,arguments)};data.args.pop();var _dst=dst;if(!_dst){var frame_idx=data.args.shift();if(!_this.frames[frame_idx]){_this.log.debug_spark("trying to contact an inexistant frame "+frame_idx);return}_dst=_this.frames[frame_idx]}return _this.send_req(_dst,name,data)},function(res){return res.data}])};Msg.prototype.add_handler=function(name,func,opt){opt=opt||{};if(!this.master){this.handlers[name]=func;this[name]=opt.exec_on_self?func:function(){};return}this[name]=this.create_handler(name,this.master)};Msg.prototype.add_frame_handler=function(name,func,opt){opt=opt||{};if(this.master){this.handlers[name]=func;this[name]=opt.exec_on_self?func:function(){};return}this[name]=this.create_handler(name)};function Stats(id){this.prefix=id+"_";this.init()}Stats.prototype.init=function(reset){if(!reset&&this.stats&&!zutil.is_mocha())return void log.notice(this.prefix+"stats already initialized");this.stats={};if(reset)this.inc(this.prefix+"stats_reset_n");else this.inc(this.prefix+"init_n")};Stats.prototype.inc=function(s,v){return this.set(s,(this.get(s)||0)+(v||1))};Stats.prototype.set=function(s,v){return this.stats[s]=v};Stats.prototype.get=function(s){return this.stats[s]};Stats.prototype.get_stats=function(){return this.stats};Stats.prototype.send_perr=function(){perr({id:this.prefix+"stats",info:{stats:this.get_stats()},delay:false,use_beacon:true});this.init(true)};if(zutil.is_mocha()){var uninit=function(){Object.keys(E.modules).forEach(function(m){E.modules[m].inited=false});if(E.links)E.links.t.uninit()};E.t={Storage:Storage,Player:Player,hash_parse:hash_parse,use_feature:use_feature,uninit:uninit}}return E});
define("/svc/cdn/pub/req.js",["/util/url.js","/svc/cdn/pub/util.js","/util/etask.js","/util/util.js","/util/date.js","/util/events.js","/util/array.js","/util/escape.js","/svc/cdn/pub/spark.js"],function(zurl,util,etask,zutil,date,events,array,zescape,spark){var ERR=util.ERR;var ms_since=util.ms_since;var KB=1024;zutil.inherits(Req,events.EventEmitter);var E=Req,proto=E.prototype;function Req(cdn,from,to,stream,info,E){if(!(this instanceof Req))return new Req(cdn,from,to,stream,info,E);this.info=info||{};this.cdn=cdn;this.from=from;this.to=to;this.E=E;this.stream=stream;this.zone=stream.bws.zone;this.zcdn=this.cdn.using(this.zone);this.hola_resp={};this.res_q=[];this.CG=this.zone.CG.bind(this.zone);this.CS=this.zone.CS.bind(this.zone);this.CE=this.zone.CE.bind(this.zone);this.CES=this.zone.CES.bind(this.zone);this.log=this.zone.log_get().set_module("req");this.fallback_wrapper=this.stream.bws.fallback_wrapper.bind(this);this.oncomplete=this.fallback_wrapper(this._oncomplete);this.slice_sec=this.to_sec();this.loaded=0;this.info.bitrate=stream.bitrate;this.info.orig_from_cache=this.info.from_cache;this.use_get_head=this.info.rate&&this.CG("cdn.send_reqs.use_get_head")&&this.cdn.is_hola();if(this.info.rate&&this.zcdn.is_head_unsupported()&&!this.zcdn.is_ranges_unsupported()){this.from=1;this.to=2}this.set_name();if(0&&!this.info.rate&&this.info.from_cache&&!this.stream.bws.adaptive&&this.cdn.is_origin()&&this.from&&this.from<=64*KB){this.from=0}this.init();this.set_ttc();stream.reqs.push(this);if(this.use_get_head)return this.get_head();this.fetch_bin()}proto.set_ttc=function(){var ms=this.to_ms();this.ttc=Math.round(Math.min(ms-Math.min(date.ms.SEC,ms/3),this.remaining_ms()));this.ttc_ms_hdrs=Math.max(Math.min(this.cdn.ms_hdrs||date.ms.SEC,this.ttc/2),200)};proto.set_name=function(){this.name=(this.id?this.id+" ":"")+(this.info.rate?"rate"+(this.use_get_head?" get_head":""):this.from+"-"+this.to)+(this.info.segment?" segment "+this.info.segment.index+" of qid "+this.info.segment.qid:"")};proto.init=function(){this.tm_create=date.monotonic();this.progress_ts=this.tm_create;this.ms_hdrs=this.served=this.loaded=this.ttfb=this.completed=0;this.error=undefined;this.progress=this.from};proto.set_params=function(url,force_params){var _this=this;function add_path(q){_this.path+=(url.search?"&":"?")+q}if(this.cdn.is_origin()){if(this.CG("cdn.send_reqs.origin.add_markers")){add_path(util.set_param("hola_client","v"+zutil.get(this,"zone.loader.ver","0.0.0")+"_tag"+zutil.get(this,"zone.loader.tag.id","")))}return}var s="",h="";if(!this.info.rate&&!this.CG("cdn.send_reqs.disable_url_ranges")&&(this.to!=-1&&(!this.stream.bws.adaptive||this.stream.bws.method.ranged_playlist||this.info.keymap_split)||this.from)){this.hrange=util.set_param("hrange",this.from+"-"+(this.to<0?"":this.to));s+=this.hrange;if(this.CG("cdn.send_reqs.disable_url_params"))s=s.slice(1)}if(!this.CG("cdn.send_reqs.disable_url_params")){var bws=this.stream.bws;s+=util.set_param("player",bws.player.name);s+=util.set_param("tech",bws.tech);s+=util.set_param("method",bws.method.type);s+=util.set_param("cdn",this.cdn.is_fast()?"fast":"single");s+=util.set_param("live",bws.player.is_live_stream());s+=util.set_param("rate",this.info.rate);h+=util.set_param("bps",this.cdn.bps());h+=util.set_param("type",this.info.clone?"clone":this.info.overloaded?"overloaded":"req");s+=bws.method.set_params(this,force_params)}this.vary_hdr=h!=""?h.slice(1):null;if(s!=""){var vary=this.info.vary?"&"+this.info.vary:h;add_path((!this.CG("cdn.send_reqs.disable_url_params")?"hola":"")+s+(this.CG("cdn.send_reqs.vary_url_params")&&vary!=""&&(this.hrange||!this.from&&this.to==-1)?vary:""))}};proto.on_stream_data=function(xhr,res,caller){if(!res||!res.data)return;res.caller=caller;if(!this.status&&!xhr.status)return void this.res_q.push(res);this.res_q.forEach(function(r){this._on_stream_data(xhr,r,r.caller+" res_q")},this);this.res_q=[];this._on_stream_data(xhr,res,caller)};proto._on_stream_data=function(xhr,res,caller){if(this.cdn.is_origin()&&xhr.responseType=="text"&&xhr.response.length<xhr.loaded){this.log.info("unicode bom detected");return this.xhr_sp.return(ERR.unicode_bom)}else if(!res.progress)this.strip_data_prefix(res);res.fullsize=util.fullsize_from_xhr(xhr);res.file_start=res.progress+this.from;if(!this.loaded)this.cdn.set_ttfb(this.ttfb=ms_since(this.tm_create));if(res.progress+res.data.byteLength>this.loaded)this.stream.bws.emit("req_resp",this,"onprogress");this.stream.ondata(this,res,caller);this.completed+=res.data.byteLength||res.data.length};proto.close_progress_monitor=function(){if(this.progress_monitor&&this.progress_monitor.interval)clearInterval(this.progress_monitor.interval)};proto.set_progress_monitor=function(){var _this=this;this.progress_monitor={hdrs:false,loaded:0,c:0};this.progress_monitor.interval=setInterval(function(){var m=_this.progress_monitor;if(!m.hdrs&&!_this.ms_hdrs&&m.c){_this.error=ERR.disconnected;_this.abort("progress_monitor","no hdrs m.c"+m.c)}else if(m.hdrs&&m.loaded==_this.loaded){_this.error=ERR.disconnected;_this.abort("progress_monitor","no progress at "+m.loaded)}else _this.stream.bws.emit("req_resp",_this,"progress_monitor");m.loaded=_this.loaded;m.hdrs=!!_this.ms_hdrs;m.c++},this.CG("cdn.send_reqs.progress_monitor_interval")||1e4)};proto.get_head=function(){var _this=this,stream=this.stream,cdn=this.cdn;var segment=this.info.segment;this.ws_cmd=true;stream.bws.emit("req_start",this);etask({name:"req_ws"},[function(){var sp=_this.sp=this;_this.id="cs"+cdn.uid+"/"+_this.uid;_this.set_name();_this.log.info("req init get_head "+_this.id+" to "+cdn.host+" "+(segment?" seg "+segment.index+" "+(segment.playlist_id||segment.bitrate):""));var parse_opt={proxy:_this.CG("cdn.static_video_proxy"),zone:_this.CG("zone")};_this.url=segment?util.parse_segment_url(segment.url,parse_opt):_this.cdn.is_origin()&&stream.origin_redirect||stream.url;_this.zcdn.send_ws("get_head",{url:_this.url.orig,index:segment&&segment.index,id:segment&&(segment.playlist_id||segment.bitrate),playlist:segment&&segment.playlist_url,manifest:segment&&(_this.url&&_this.url.force_params&&_this.url.force_params.manifest||_this.stream.bws.url_s)},null,function(e){if(!e||sp!=_this.sp)return sp.return();_this.res=e.res;_this.ms_hdrs=_this.elapsed();_this.sp.continue(e)});_this.set_progress_monitor();return this.wait()},function(res){},function catch$(err){var s=err.message||util.ERR_str[err]||""+err||"error";_this.log.info("req "+_this.name+" failed "+(err.stack||s));if(!_this.error_str)_this.error_str=s;_this.error=_this.error||ERR.failed;return this.return(-1)},function finally$(){_this.sp=undefined;_this.close_progress_monitor();_this.log.info("resp end "+_this.name+" "+JSON.stringify(_this.res));_this.stream.bws.emit("req_end",_this);if(!_this.res){_this.init();return _this.fetch_bin()}_this.tm_complete=date.monotonic();_this.update_stats(_this.res,true);_this.oncomplete();if(this.error&&this.error instanceof Error)throw this.error}])};proto.fetch_bin=function(){var _this=this,stream=this.stream,cdn=this.cdn,opt;var segment=this.info.segment,info=this.info;function gen_url(vid){var protocol=vid.protocol=="https:"||typeof location=="undefined"||!["http:","https:"].includes(location.protocol)||util.is_ios_sdk||util.is_android_sdk||window.hola_cdn_sdk?vid.protocol:location.protocol;if(cdn.is_hola()&&_this.CG("loader.https_xhr_only"))protocol="https:";var host=protocol=="https:"||_this.CG("cdn.send_reqs.https")?cdn.hostname:cdn.host;if(_this.E.debug_fail_cdns&&!cdn.is_origin()){_this.log.console("failing "+JSON.stringify(vid));host="1.1.1.18"}_this.cache_path=_this.path=(cdn.is_hola()?host+"/"+util.conf.customer+"/"+_this.CG("zone")+"/":"")+(cdn.is_hola()?vid.hostname:cdn.hostname)+(vid.port?":"+vid.port:"");_this.cache_path+=vid.pathname;_this.path+=vid.path;if(_this.info.add_random_param)_this.path+=(vid.query?"&":"?")+"r="+Math.random();_this.set_params(vid,vid.force_params);return protocol+"//"+_this.path}function onprogress(event,res){_this.xhr=_this.xhr||this;_this.xhr.req=_this;_this.xhr.total=_this.xhr.total||event.total;var loaded=_this.loaded;_this.loaded=event.loaded||_this.loaded;_this.status=_this.status||_this.xhr.status;if(_this.info.rate){if((util.is_ie||util.is_edge)&&_this.opt.method=="HEAD")_this.loaded=0;if(event.loaded>1&&event.loaded<event.total)_this.abort("onprogress");if(!_this.resp){_this.on_hdrs_arrived(this.ms_hdrs,util.get_resp_hdrs(this),"onprogress")}return}if(_this.CG("util.log.req_xhr")){_this.log.info("req onprogress cw"+_this.cdn.uid+"/"+_this.uid+" loaded "+event.loaded)}if(!loaded&&event.loaded){_this.cdn.set_ttfb(_this.ttfb=ms_since(_this.tm_create));if(!_this.resp){_this.on_hdrs_arrived(this.ms_hdrs,util.get_resp_hdrs(this),"onprogress")}}_this.on_stream_data(this,res,"onprogress");if(_this.loaded>loaded)_this.stream.bws.emit("req_resp",_this,"onprogress");_this.progress=_this.from+_this.loaded;_this.progress_ts=date.monotonic();if(_this.to<0&&(event.totalSize||event.total)){_this.to=_this.opt.to=(event.totalSize||event.total)-1;_this.set_name()}var t;if((t=date.monotonic()-_this.hdrs_ts)&&event.loaded>=1e4)_this.cdn.set_progress_bw(Math.round(event.loaded*1e3*8/t));var other=_this.info.clone||_this.info.overloaded;if(other&&!other.error&&_this.loaded>=128*KB&&(_this.can_get()&&!other.can_get()||!_this.stream.bws.adaptive&&other.to>_this.to||_this.remaining_ms()<other.remaining_ms()&&(other.loaded>128*KB||other.is_slow_rate()||_this.can_get()))){_this.log.info("closing parallel req "+other.name+" loaded/elapsed/remaining "+other.loaded+"/"+other.elapsed()+"/"+other.remaining_ms()+" mine "+_this.loaded+"/"+_this.elapsed()+"/"+_this.remaining_ms()+" other.ttc "+other.ttc+" other.slow "+other.is_slow_rate()+" ms "+_this.to_ms());other.abort("onprogress")}if(stream.bws.method.onprogress)stream.bws.method.onprogress(event,_this);if(event.loaded<event.total&&_this.stream.allow_req("onprogress"))_this.stream.send_reqs()}stream.bws.emit("req_start",this);etask({name:"req"},[function(){_this.sp=this;_this.id="cw"+_this.cdn.uid+"/"+_this.uid;_this.set_name();var parse_opt={proxy:_this.CG("cdn.static_video_proxy"),zone:_this.CG("zone")};_this.url=_this.o_url=gen_url(segment?util.parse_segment_url(segment.url,parse_opt):_this.cdn.is_origin()&&stream.origin_redirect||stream.url);var cdns=stream.bws.cdns;_this.log.info("req init cw"+cdn.uid+"/"+_this.uid+" "+(info.from_cache?"from cache ":info.ping?"ping ":info.rate?"rate ":"")+"to "+_this.cdn.host+" "+_this.from+"-"+_this.to+" policy "+stream.bws.policy()+(cdn.rate()==Infinity?" ms_hdrs "+cdn.ms_hdrs:" rate "+cdn.rate())+" best "+(stream.bws.fastest_policy()&&cdns.prev_best_cdn?"cw"+cdns.prev_best_cdn.uid+(cdns.prev_best_cdn!=_this.cdn?" "+cdns.prev_best_cdn.rate():""):"none")+" ttc "+_this.ttc+(stream.bws.parser&&stream.bws.parser.ofs2time?" ofs2time "+Math.round((stream.bws.parser.ofs2time(_this.to+1)-stream.bws.parser.ofs2time(_this.from))*1e3)/1e3:"")+(info.segment?" seg "+info.segment.index+" dur "+info.segment.dur+" id "+(info.segment.playlist_id||info.segment.bitrate):"")+" "+_this.url);opt={url:_this.url,headers:{},fallback_wrapper:_this.fallback_wrapper.bind(_this),redir:_this.o_url,req_id:segment?segment.req_id:undefined,fullsize:!stream.fullsize,onprogress:onprogress,streaming:!_this.CG("cdn.send_reqs.disable_streaming")&&(segment&&segment.streaming!==undefined?segment.streaming:true),hrange:_this.hrange,hola_src:cdn.is_hola(),segment:segment,xhr_opt:info.xhr_opt,XHR:!info.rate?stream.bws.method.xhr:undefined,rate:info.rate,method:_this.info.rate&&(!_this.zcdn.is_head_unsupported()||_this.zcdn.is_ranges_unsupported())?"HEAD":"GET",streaming_text:_this.CG("cdn.send_reqs.streaming_method_text")};var hls_conf=stream.bws.player.hls&&stream.bws.player.hls.config||stream.bws.player.module&&stream.bws.player.module.dailymotion&&stream.bws.player.module.dailymotion.config||{};if((_this.from||_this.to!=-1&&(!_this.stream.bws.adaptive||_this.stream.bws.method.ranged_playlist||_this.info.keymap_split))&&!_this.hrange&&!info.no_range){opt.headers.Range="bytes="+_this.from+"-"+(_this.to<0?"":_this.to)}if(cdn.is_origin()){if(hls_conf.xhrSetup){var x=new XMLHttpRequest;hls_conf.xhrSetup(x,opt.url);opt.withCredentials=x.withCredentials}if(_this.CG("cdn.send_reqs.origin.with_credentials")||hls_conf.withCredentials){opt.withCredentials=true}stream.bws.stats.origin_head_n+=opt.method=="HEAD";stream.bws.stats.origin_ranges_n+=!!opt.headers.Range}if(stream.opt.dummy)_this.onprogress=onprogress;if(zutil.is_mocha()){opt.from_cache=info.from_cache;if(segment){opt.cache_id=segment.playlist_id;opt.segment_idx=segment.index}opt.uid=_this.uid;opt.from=_this.from;opt.to=_this.to;opt.req=_this}_this.opt=opt;_this.set_progress_monitor();if(_this.stream.opt.dummy)return this.wait();if(_this.E.debug_freeze_next_req&&_this.E.debug_freeze_next_req.cdn==cdn.host){return freeze_req_and_fetch_bin.call(_this,opt)}else if(_this.E.debug_freeze_cdns_ms&&!cdn.is_origin())return freeze_cdns_and_fetch_bin.call(_this,opt)},function send(){return _this.xhr_fetch_bin(opt)},function(err){if(err==ERR.unicode_bom){_this.stream.bws.stats.unicode_bom++;_this.init();opt.streaming=false;return this.goto("send")}if(err)throw err},function catch$(err){var s=err.message||err.statusText||util.ERR_str[err]||""+err||"error";_this.log.info("req "+_this.name+" failed "+(err.stack||s));if(!_this.error_str)_this.error_str=s;_this.error=_this.error||ERR.failed;return this.return(-1)},function finally$(){_this.sp=undefined;_this.close_progress_monitor();if(_this.res&&_this.res.fallback)throw new Error(_this.res.error);_this.tm_complete=date.monotonic();_this.update_stats(_this.res,true);_this.stream.bws.emit("req_end",_this);_this.oncomplete();if(this.error&&this.error instanceof Error)throw this.error}])};proto.validate_status=function(status,caller){if(this.error)return this.error;this.ms_hdrs=this.ms_hdrs||this.xhr&&this.xhr.ms_hdrs;if(this.xhr&&this.xhr.aborted)this.error=ERR.aborted;else if(this.opt.headers.Range&&(status==200||this.cdn.is_origin()&&!status&&!this.cdn.ranges_supported&&this.stream.bws.adaptive)){this.error=ERR.ranges_unsupported;if(this.cdn.is_origin())this.stream.bws.stats.ranges_unsupported++}else if(status!=200&&status!=206){if(this.cdn.is_hola()&&status==503){this.error=ERR.busy;this.error_str="too busy"}else if(!status||this.cdn.is_hola()&&status==520){this.error=ERR.disconnected;this.error_str="disconnected"+(status==520&&this.hola_resp&&this.hola_resp.status?" origin status "+this.hola_resp.status:"")}else if(this.cdn.is_origin()&&this.stream.bws.player.is_live_stream()&&["404","403"].includes(status)){this.error=ERR.disconnected;this.error_str="origin returned "+status+" wait for next playlist download"}else{this.error=this.opt.method=="HEAD"&&!this.cdn.is_hola()?ERR.head_unsupported:ERR.failed;if(this.error==ERR.head_unsupported&&this.cdn.is_origin())this.stream.bws.stats.head_unsupported++;this.error_str="bad status code "+status+" ready state "+(this.xhr?this.xhr.readyState:"none")}if(this.CG("util.log.req_xhr")&&!status&&this.loaded){var zperr=this.zone.perr_get();zperr({id:"loaded_bytes_no_status",add_log:true,info:{url:this.o_url,final_url:this.url,throttle:1,status:this.status,loaded:this.loaded}})}}return this.error};proto.strip_data_prefix=function(res){var prefix=+this.hola_resp.data_prefix||this.info.from_cache&&+this.info.data_prefix;if(!prefix)return;this.log.info("req "+this.id+" strip "+prefix+" data prefix bytes");res.data=res.data.slice(prefix);this.info.data_prefix=prefix};proto.xhr_fetch_bin=function(opt){var _this=this;var zperr=this.zone.perr_get();function onreadystatechange(xhr,res){_this.xhr=xhr;xhr.req=_this;if(xhr.readyState<xhr.HEADERS_RECEIVED||_this.error==ERR.aborted||opt.aborted){return}_this.info.onreadystatechange=true;_this.status=_this.status||xhr.status;_this.validate_status(_this.status,"onreadystatechange");if(!_this.resp||!_this.resp.hdrs){_this.progress_ts=date.monotonic();_this.on_hdrs_arrived(xhr.ms_hdrs,util.get_resp_hdrs(xhr),"onreadystatechange")}if(_this.error)return void(_this.xhr_sp?_this.xhr_sp.continue():null);_this.on_stream_data(xhr,res,"onreadystatechange")}opt.onreadystatechange=onreadystatechange;return etask({name:"xhr_fetch_bin",cancel:true},[function(){_this.xhr_sp=this;var p;if(!_this.stream.bws.method.fetch_bin||_this.info.rate||!(p=_this.stream.bws.method.fetch_bin(opt))){if(opt.segment)opt.segment.ts_fetch_bin=date.monotonic();p=util.fetch_bin(opt)}_this.xhr=(p||{}).xhr;if(_this.xhr)_this.xhr.req=_this;return p},function(res){_this.done=true;_this.res=res;if(res&&res.fullsize&&_this.to<0)_this.to=_this.opt.to=res.fullsize-1;_this.status=_this.status||_this.xhr&&_this.xhr.status||res&&res.status;if(_this.status&&!_this.ms_hdrs)_this.ms_hdrs=_this.elapsed();if(_this.validate_status(_this.status,"xhr_fetch_bin"))return this.return(_this.error);_this.res_q.forEach(function(r){_this._on_stream_data(_this.xhr,r,r.caller+" xhr_fetch_bin")},_this);if(!res||!_this.info.rate&&(!res.data||!res.data.byteLength&&!res.data.length)&&!_this.loaded){if(!res&&_this.status&&_this.loaded){_this.error=ERR.disconnected;_this.error_str="mid stream disconnect"}_this.error=_this.error||ERR.failed;_this.error_str=_this.error_str||"missing response data";_this.log.info("req "+_this.id+" failed status "+_this.status+" loaded "+_this.loaded+" res "+!!res+" error "+_this.error+" "+(_this.error_str?_this.error_str+" ":"")+"data "+!!(res&&res.data)+" "+_this.url);return this.return(_this.error)}if(res.fullsize)_this.stream.bws.method.set_fullsize(_this.stream,res.fullsize);var size=_this.loaded?_this.loaded-(_this.hola_resp&&_this.hola_resp.data_prefix||_this.info.data_prefix||0):res.data&&(res.data.byteLength||res.data.length)||0;var expected=_this.size();if(_this.to!=-1&&size!=expected){if(res.fullsize&&res.fullsize<_this.to+1)_this.to=res.fullsize;else if(!res.fullsize&&!_this.stream.fullsize&&size<expected)_this.to=_this.from+size-1;else{_this.log.warn(_this.id+" byte range mismatch "+_this.o_url+(_this.o_url!=_this.url?" original url "+_this.url:"")+" expected size "+expected+" got size "+size+" "+(_this.hola_resp.data_prefix||"no data prefix")+" data size "+(res.data?res.data.byteLength||res.data.length:"0"));var pid=(_this.cdn.is_origin()?"origin_":"")+"req_size_mismatch";zperr({id:pid,add_log:true,info:{url:_this.o_url,final_url:_this.url,req_size:expected,resp_size:size}})}}if(!_this.resp||!_this.resp.hdrs&&res.hdrs)_this.on_hdrs_arrived(res.ms_hdrs,res.hdrs,"xhr_fetch_bin");if(res.data&&!_this.served&&res.data.byteLength!==undefined){_this.strip_data_prefix(res);_this.stream.ondata(_this,res,"xhr_fetch_bin");_this.completed+=res.data.byteLength}_this.stream.bws.emit("req_resp",_this,"xhr_fetch_bin")},function finally$(){_this.xhr_sp=undefined},function catch$(err){return this.return(err)}])};proto.on_hdrs_parsed=function(hdrs){var sz=util.fullsize_from_hdrs(hdrs,!!this.opt.headers.Range);if(this.to<0&&sz){this.to=this.opt.to=sz-1;this.name+=" sz "+sz}if(this.stream.bws.method.type=="hola_adaptive"&&!this.error){if(this.to>-1&&sz&&sz!=this.to+1){this.log.info("ERR - %s size mismatch from hdrs %d this.to %d"+" hdrs %s",this.name,sz,this.to,JSON.stringify(hdrs))}var other=this.info.clone||this.info.overloaded;if(sz&&other&&other.info.segment.qid==this.info.segment.qid&&other.to>-1&&sz!=other.to+1){this.log.info("ERR - %s size mismatch from hdrs %d clone.to %d"+" hdrs %s clone.hdrs %s",sz,other.to,JSON.stringify(hdrs),other.resp?JSON.stringify(other.resp.hdrs):"none")}}this.cdn.update_from_hdrs(hdrs);var resp=zescape.parse.http_words(hdrs["x-hola-resp"]);for(var i=0;i<resp.length;i++)this.hola_resp[resp[i][0]]=resp[i][1]};proto.on_hdrs_arrived=function(ms_hdrs,hdrs,caller){var was_resp=!!this.resp;this.resp=this.resp||{};this.resp.status=this.resp.status||this.status;this.hdrs_ts=this.hdrs_rs||date.monotonic();this.ms_hdrs=this.ms_hdrs||ms_hdrs||this.elapsed();if(zutil.is_mocha()&&!ms_hdrs){this.ms_hdrs=this.info.rate?this.ms_hdrs:Math.max(Math.min(this.ms_hdrs/2,300),10)}if(zutil.is_mocha()&&ms_hdrs)this.hdrs_ts=this.tm_create+this.ms_hdrs;if(hdrs&&!this.resp.hdrs){this.resp.hdrs=hdrs;this.on_hdrs_parsed(hdrs);if(this.info.from_cache){if(!this.error)this.stream.cache_validate(this);else if(this.error!=ERR.aborted)this.stream.cache_purge(this,"not found in cache")}if(was_resp){this.log.info("resp hdrs "+caller+" server cache "+(hdrs["x-cache"]||"unknown")+" status "+(this.resp.status||"unknown"))}}if(!was_resp){this.log.info("resp init "+caller+" "+(this.info.from_cache?"from cache ":"")+this.name+" remaining "+this.remaining().ms+(hdrs?" server cache "+(hdrs["x-cache"]||"unknown"):"")+" status "+(this.resp.status||"unknown"));this.log.debug("resp headers "+this.name+" "+JSON.stringify(hdrs))}this.stream.bws.emit("req_resp",this,"on_hdrs_arrived")};proto.update_cdn_stats=function(final){var e;if(final&&this.CG("cdn.send_reqs.enable_window_performance")&&this.hrange&&typeof window!=="undefined"&&window.performance&&window.performance.getEntriesByName&&(e=window.performance.getEntriesByName(this.url))&&e.length==1){e=e[e.length-1];if(e.responseEnd&&e.responseStart)this.ms=Math.round(e.responseEnd-e.responseStart);if(e.responseStart&&(e.redirectStart||e.domainLookupEnd||e.connectEnd||e.fetchStart)){this.ms_hdrs=Math.round(e.responseStart-(e.redirectStart||e.connectEnd||e.domainLookupEnd||e.fetchStart));this.ms_hdrs_all=Math.round(e.responseStart-(e.fetchStart||e.domainLookupEnd||e.connectEnd||e.redirectStart));this.info.bw_by_performance_stats=true}}this.cdn.update_stats({ms_hdrs:this.ms_hdrs,ms:this.ms,ttc:this.ttc,sz:this.loaded,error:!this.info.rate||!this.xhr||!this.xhr.status||[ERR.disconnected,ERR.busy].includes(this.error)?this.error:0,cache:this.ws_cmd?"HIT":this.resp&&this.resp.hdrs["x-cache"],rate:this.info.rate,"final":final,elapsed:this.elapsed(),range:!!(this.opt&&this.opt.headers&&this.opt.headers.Range),rate_decrease:this.CG("cdn.send_reqs.rate_decrease")})};proto.update_stats=function(res,final){this.ms=final&&this.loaded?res&&res.ms||ms_since(this.tm_create)-this.ms_hdrs:0;if(!this.ms_hdrs&&(this.error==ERR.disconnected||this.error==ERR.ranges_unsupported&&this.stream.bws.adaptive)){return}if(final&&!this.CG("cdn.cache.disabled")&&this.stream.bws.cache&&this.info.from_cache){this.stream.bws.stats.cached+=this.loaded;return this.stream.bws.cache.update_stats({ms:this.ms,sz:this.loaded,ms_hdrs:this.ms_hdrs})}this.update_cdn_stats(final)};proto.is_slow_jtest=function(){var jtest_slow_reqs=this.stream.bws.jtest_slow_reqs,_this=this;var ret=jtest_slow_reqs&&jtest_slow_reqs.some(function(r){return!(r.host!=_this.cdn.host||r.from!==undefined&&(r.from!=_this.from||r.to!=_this.to)||r.url&&r.url!=_this.url)});return ret};proto.to_json=function(){return{id:this.id,from:this.from,to:this.to,dur:this.to_sec(),slow:this.is_slow(),rate:this.rate(),bps:this.bps(),ms:this.ms,ms_hdrs:this.ms_hdrs,segment:this.info.segment,rate_req:this.info.rate,from_cache:this.info.from_cache,size:this.size(),elapsed:this.elapsed(),remaining:this.remaining(),will_make_it:this.can_get()}};proto.to_ms=function(from,to){return this.to_sec(from,to)*date.ms.SEC};proto.to_sec=function(from,to){if(this.dur&&from===undefined&&to===undefined)return this.dur;var parser=this.stream.bws.parser,res,o_to=to;from=from||this.from;to=to||(this.to>-1?this.to+1:this.size());if(this.info.segment){var segment=this.info.segment;res=!to||!o_to&&this.to<0&&!from?segment.dur:this.to>-1?(to-from)/this.to*segment.dur:segment.bitrate?(to-from)/(segment.bitrate/8*segment.dur):0}else{res=parser&&parser.ofs2time&&!isNaN(parser.ofs2time(to))?parser.ofs2time(to)-parser.ofs2time(from):this.stream.bitrate?this.stream.sz2sec(to-from):this.stream.slice_sec*((to-from)/this.size())}if(from===undefined&&to===undefined)this.dur=res;return res?Math.round(res*100)/100:res};proto.is_slow_rate=function(){if(zutil.is_mocha()&&this.E.jtest.set_slow)return this.is_slow_jtest();var elapsed=this.elapsed();if(this.info.rate)return false;if(!this.ms_hdrs)return elapsed>2*this.ttc_ms_hdrs;if(!this.ttc)return false;var exp_rate=Math.round(this.size()*date.ms.SEC/this.ttc);var real_rate=this.loaded*date.ms.SEC/(elapsed-this.ms_hdrs);var ret=elapsed-this.ms_hdrs>date.ms.SEC&&real_rate<exp_rate*.75;if(ret&&!this.slow)this.stream.bws.emit("set_slow",this);else if(!ret&&this.slow){this.log.info("req "+this.name+" is suddenly not slow!");this.stream.bws.emit("req_resp",this,"is_slow")}return this.slow=ret};proto.is_slow=function(){if(zutil.is_mocha()&&this.E.jtest.set_slow)return this.is_slow_jtest();return this.is_slow_rate()};proto.close_parallel=function(){if(this.info.overloaded){this.info.overloaded.other_completed=this.from+this.completed;if(!this.allow_parallel)this.info.overloaded.info.was_cloned=this.id;this.info.was_overloaded=this.info.overloaded.id;this.info.overloaded.info.clone=undefined}if(this.info.clone){this.info.clone.other_completed=this.from+this.completed;if(!this.allow_parallel)this.info.clone.info.was_overloaded=this.id;this.info.was_cloned=this.info.clone.id;this.info.clone.info.overloaded=undefined}this.info.overloaded=this.info.clone=undefined};proto._oncomplete=function(){this.closed=1;var res="success",ms;var origin=this.stream.bws.cdns.get_origin();if(!this.error&&this.info.overloaded)this.info.overloaded.abort("oncomplete");if(!this.error&&this.info.clone)this.info.clone.abort("oncomplete");if(this.error){if(this.error!=ERR.aborted){this.cdn.set_error(this.error);if(this.error==ERR.busy){this.allow_parallel=true;this.cdn.set_busy();res="too busy"}else if(this.error==ERR.disconnected){this.cdn.disconnected();res=this.cdn.is_hola()&&this.status==520?"origin error":"disconnected"}else if(this.error==ERR.ranges_unsupported&&this.stream.bws.adaptive){res="failed ranges unsupported, cdn still active"}else if(!this.cdn.is_origin()||!this.info.rate){this.cdn.failed(this.error,this.stream.bws.adaptive);res="failed"+(this.cdn.enabled?"":" final")+" "+this.error+" "+(this.error_str||util.ERR_str[this.error])}}else{res="aborted by "+this.abort_caller;if(this.stream.bws.fastest_policy()&&this.is_slow())this.cdn.delayed++}}this.close_parallel();this.log.info("resp end cw"+this.cdn.uid+"/"+this.uid+" "+res+" "+(this.status!=200&&this.status!=206?this.status+" ":"")+this.elapsed()+"ms "+this.ms_hdrs+"/"+this.ttfb+"/"+this.ms+"/"+(this.ms_hdrs_all||"")+" rate "+this.cdn.rate()+(this.resp?" server cache "+(this.resp.hdrs["x-cache"]||"unknown"):"")+(origin?" origin rate "+origin.rate():"")+(ms?" dur "+ms:"")+" loaded "+this.loaded+(this.info.bw_by_performance_stats?" bw by performance stats":""));this.stream.oncomplete_req(this);this.emit("complete");this.stream.bws.emit("req_complete",this)};function freeze_req_and_fetch_bin(opt){var _this=this;var ms=this.E.debug_freeze_next_req.ms;var cdn=this.E.debug_freeze_next_req.cdn;delete this.E.debug_freeze_next_req;return etask([function(){_this.log.console("sleep for next cdn "+cdn+" req "+ms+"ms "+JSON.stringify(opt));return etask.sleep(ms)},function(){_this.log.console("sleep done cdn "+cdn);this.return(ms)}])}function freeze_cdns_and_fetch_bin(opt){var _this=this;var ms=this.E.debug_freeze_cdns_ms;return etask([function(){_this.log.console("sleep for "+ms+"ms "+JSON.stringify(opt));return etask.sleep(ms)},function(){_this.log.console("sleep done");this.return(ms)}])}proto.abort=function(caller,s){if(this.abort_caller)return;this.log.info("req "+this.id+" aborted by "+caller+(s?" "+s:""));this.abort_caller=caller||"unknown";this.error=this.error||ERR.aborted;var reqs=this.stream.reqs;array.rm_elm(reqs,this);this.cdn.aborted++;this.cdn.aborted_bytes+=this.loaded-this.served;this.close_parallel();if(this.sp)this.sp.return(this.error)};proto.remaining_ms=function(o){return this.remaining({if_not_accurate:o===undefined?Infinity:o}).ms};proto.remaining=function(){var sz=this.size(),left=Math.max(sz-this.loaded,0);var ms=this.done?0:ms_since(this.tm_create);var cdn=this.info.from_cache?this.stream.bws.cache.calc_ttc(left):this.cdn.calc_ttc(left);var elapsed=this.elapsed();ms=!this.ms_hdrs||!this.loaded?!this.cdn.ms_hdrs?Math.max(cdn,elapsed*3):this.is_slow_rate()?elapsed/this.cdn.ms_hdrs*cdn:cdn:this.loaded<Math.min(128*KB,sz/2)&&!this.is_slow_rate()?cdn:Math.round(ms/this.loaded*left);return{bytes:left,ms:Math.round(ms),cdn:cdn}};proto.elapsed=function(){return Math.round(this.tm_complete?this.tm_complete-this.tm_create:ms_since(this.tm_create))};proto.size=function(){return this.info.rate?0:this.to<0?Math.max(this.info.segment&&this.info.segment.est_sz||0,this.stream.slice):this.to+1-this.from};proto.bpms_a=function(){return this.bpms({accurate:true})};proto.bpms=function(opt){opt=opt||{};return this.loaded<128*KB&&!opt.force?opt.if_not_accurate||(opt.accurate?0:this.cdn.bpms):Math.round(this.loaded/this.elapsed())};proto.bps=function(opt){return date.ms.SEC*this.bpms(opt)};proto.bits_ps=function(opt){return this.bps(opt)*8};proto.rate=function(){return!this.ms_hdrs?this.cdn.rate():Math.round(512*KB/this.bpms())};proto.can_get_a=function(){return this.can_get({if_not_accurate:Infinity})};proto.can_get=function(opt){return this.remaining(opt).ms<=this.to_ms()-this.elapsed()};return E});
define("/svc/cdn/pub/stream.js",["/svc/cdn/pub/util.js","/util/util.js","/util/date.js","/util/events.js","/util/url.js","/svc/cdn/pub/map.js","/svc/cdn/pub/stats.js","/svc/cdn/pub/req.js","/svc/cdn/pub/cache.js"],function(util,zutil,date,events,zurl,map,stats,zreq,cache){var ERR=util.ERR;var ms_since=util.ms_since;var KB=1024,MB=1024*KB;zutil.inherits(Stream,events.EventEmitter);var E=Stream,proto=E.prototype;function Stream(opt){if(!(this instanceof Stream))return new Stream(opt);this.tm_create=date.monotonic();this.label=opt.label;this.fullsize=opt.fullsize||0;this.bitrate=opt.bitrate||0;this.bws=opt.bws;this.CG=this.bws.zone.CG.bind(this.bws.zone);this.CS=this.bws.zone.CS.bind(this.bws.zone);this.CTD=this.bws.zone.CTD.bind(this.bws.zone);this.url=opt.url||this.bws.url;this.opt=opt;this.reqs=[];this.chunks=[];this.chunks_order=0;this.chosen=[];this.stats={};this.map=new map.Map(opt.map);this.id=opt.id;this.stopped=this.bws.paused;this.log=this.bws.zone.log_get().set_module("stream");this.start_pos=this.bws.start_pos||0;this.completed=this.from=opt.from||0;this.to=opt.to||(this.fullsize?this.fullsize-1:this.map.size);this.name=this.from+"-"+this.to+" "+this.url.path+" id "+this.id;this.served_sec=this.downloaded_sec=this.vid_hdr_sz=0;this.served_bytes=0;this.allow_req=function(caller,mark){if(this.stopped)return;var i,count=0;this.reqs.forEach(function(req){count+=!req.info.rate});if(count&&this.CG("cdn.send_reqs.sequential"))return false;if(!count)return true;for(i=0;i<this.reqs.length&&(this.reqs[i].info.rate||this.reqs[i].info.early||this.reqs[i].info.overloaded||this.reqs[i].info.clone||this.reqs[i].loaded&&this.reqs[i].from+this.reqs[i].loaded==this.reqs[i].to+1||this.reqs[i].remaining_ms()*.9>(this.reqs[i].ttfb||this.reqs[i].ms_hdrs));i++);var ret=i<this.reqs.length?this.reqs[i]:false;if(!ret)return false;if(mark)ret.info.early=date.monotonic();this.log.debug("allow early req ms "+JSON.stringify(ret.remaining_ms())+"<"+(ret.ttfb||ret.ms_hdrs||ret.cdn.ms_hdrs)+" "+ret.name+" by "+caller);this.emit("allow_early_req",ret);return ret};this.slice=+(opt.slice||this.CG("cdn.send_reqs.start_slice_sz")||MB);this.slice_sec=opt.slice_sec||this.bws.slice_sec;this.bws.emit("stream_start",this,{id:opt.uid,verify:opt.verify});this.log.info("Stream create "+this.name+" uid "+this.uid+(this.stopped?" paused":" active")+" slice "+this.slice+" sec "+this.slice_sec);this.bws.emit("stream_start_set",this);this.monitor();this.serve();if(!opt.no_reqs)this.send_reqs();return this}proto.oncomplete_req=function(req){if(this.bws.cache&&(!req.info.from_cache||req.hola_resp.status==304)&&!req.error&&req.loaded&&req.resp&&(!req.cdn.is_origin()||cache.is_cachable(req.resp.hdrs)&&!this.CG("cdn.cache.urls.origin.disable"))){this.bws.method.cache_set(req)}else if(req.info.from_cache&&req.error&&(req.error!=ERR.aborted||!req.ms_hdrs&&req.elapsed()>200)){this.bws.cache.unset({id:req.info.cache_id,host:req.cdn.host,from:req.from,to:req.to})}if(!req.error&&req.info.overloaded)this.bws.stats.parallel_overloaded_n++;else if(!req.error&&req.info.clone)this.bws.stats.parallel_clone_n++;if(this.CG("cdn.send_reqs.origin_use_final_url")&&req.cdn.is_origin()&&req.info.rate&&req.xhr&&req.xhr.status==200&&!this.origin_redirect&&req.xhr.responseURL!=this.url.orig){this.origin_redirect=zurl.parse(req.xhr.responseURL);this.bws.add_origin(this.origin_redirect.hostname);req.cdn.enabled=false;this.log.info("set stream url to "+req.xhr.responseURL)}this.bws.method.oncomplete_req(req);if(req.info.early){this.bws.stats.early_req.n++;this.bws.stats.early_req.ms+=req.ms_hdrs-(req.tm_complete-req.info.early)}else if(!req.info.rate&&this.bws.method.type!="adaptive"&&(req.index||req.to)!=this.to){this.bws.stats.early_req.miss_n++}if(!req.info.from_cache&&!req.error&&!req.info.rate&&req.loaded&&req.cdn.is_hola()){req.zcdn.send_ws("set_ttc",null,{sz:req.loaded,ttc:req.elapsed(),cache:req.resp&&req.resp.hdrs["x-cache"]})}if(req.cdn.is_single()&&!req.cdn.is_usable()&&this.bws.cdns.count_single_busy()>=2&&this.bws.cdns.hola_single_usable()<5&&this.bws.next_single_copy_cdn()){this.bws.stats.replace_agent_n++;this.send_reqs()}if(req.cdn.is_hola()&&req.status==503&&this.get_req_by_id(req.info.was_cloned||req.info.was_overloaded)){this.parallel_on_slow("oncomplete_req")}};proto.get_cdn_by_req_id=function(id){var m=(id||"").match(/cw([0-9]+)\/[0-9]+/);return m?this.bws.cdns.find(function(c){return c.uid==m[1]}):null};proto.get_req_by_id=function(id){return this.reqs.find(function(r){return r.id==id})};proto.needed_sec=function(){return Math.max(this.bws.needed_sec()-this.requested_sec(),0)};proto.parallel_on_slow=function(caller){var best_cdn;if(this.CG("cdn.overload.disable")||(!this.CG("cdn.send_reqs.lowcost_parallel_on_slow")?this.bws.lowcost_policy():0)||this.stopped||!this.bws.cdns){return}var parallel=[];var overloaded=this.reqs.some(function(r){return!!r.info.overloaded});this.reqs.forEach(function(r){if(r.info.rate)return;if(r.done||r.loaded==r.size())return this.log.debug("req "+r.name+" is already done");if(!r.is_slow()){return this.log.debug("req "+r.name+" "+r.cdn.host+" not slow "+" elapsed "+r.elapsed()+"ms loaded "+r.loaded+" remaining "+r.remaining_ms())}if(r.cdn.is_origin()&&this.CG("cdn.overload.disable_origin"))return this.log.debug("req "+r.name+" origin overload disabled");var other=r.info.overloaded||r.info.clone;if(other){return this.log.debug("req "+r.name+" is "+(r.info.overloaded?"overloaded by ":"clone of ")+other.id+" loaded "+r.loaded)}var remaining=r.remaining(),fs=r.size();var sz=r.opt.streaming?remaining.bytes:fs;var origin=this.bws.cdns.get_origin(),best_ttc;var sec=Math.max((r.to_sec()||this.slice_sec)-r.elapsed()/date.ms.SEC,1);if(r.info.cache_backup){best_cdn=r.info.cache_backup.cdn;best_ttc=this.bws.cache.calc_ttc(remaining.bytes)}else if(!r.cdn.is_origin()&&origin&&origin.is_enabled()&&(origin.is_bw_from_cache()&&origin.is_usable()||r.info.was_cloned&&this.get_cdn_by_req_id(r.info.was_cloned)!=origin||r.info.was_overloaded&&this.get_cdn_by_req_id(r.info.was_overloaded)!=origin)&&origin.can_get(origin.using(this.bws.zone).is_ranges_unsupported()||!r.opt.streaming?fs:sz,sec,{by_hdrs:origin.is_bw_from_cache()})){best_cdn=origin;best_ttc=Infinity}else if(!this.CG("cdn.overload.disable_parallel_limit")&&(r.info.was_cloned||r.info.was_overloaded)){return this.log.debug("req "+r.name+" was "+(r.info.was_overloaded?"overloaded by "+r.info.was_overloaded:"clone of "+r.info.was_cloned)+" loaded "+r.loaded)}else{best_cdn=this.bws.cdns.get_best_cdn("parallel_on_slow",{allow_fast:this.bws.method.fast_allowed_range(this,{from:r.from+r.loaded,to:r.to,index:r.info.segment&&r.info.segment.index,segment:r.info.segment,qid:r.info.segment&&r.info.segment.qid}),sz:sz,fs:fs,sec:sec,replace:[{id:r.cdn.id,bpms:r.bpms({force:true}),ms_hdrs:r.ms_hdrs||r.elapsed()}]});if(best_cdn)best_ttc=best_cdn.calc_ttc(remaining.bytes)}if(!best_cdn)return this.log.debug("req "+r.name+" no best cdn");if(r.cdn==best_cdn&&!r.info.cache_backup)return this.log.debug("req "+r.name+" is already using best cdn");if(best_ttc!=Infinity&&remaining.ms<best_ttc*.8){return this.log.debug("req "+r.name+" best cdn not fast enough "+remaining.ms+" < "+best_ttc+" "+best_cdn.id)}if(this.CG("cdn.overload.if_not_loaded")&&r.loaded)return this.log.debug("req "+r.name+" already loaded "+r.loaded);if(!this.CG("cdn.overload.disable_will_make_it")&&r.loaded>=128*KB&&r.can_get()){return this.log.debug("req "+r.name+" can get, loaded "+r.loaded)}if((overloaded||parallel.length)&&this.CG("cdn.overload.check_allow_range")&&!this.allow_req("parallel_on_slow")){return this.log.debug("req "+r.name+" not allowed another "+"parallel")}parallel.push({req:r,best:best_cdn})},this);parallel.forEach(function(o){var r=o.req;var from=this.bws.adaptive&&(this.CG("cdn.method.disable_ranges")||o.best.is_origin()&&o.best.using(this.bws.zone).is_ranges_unsupported()||this.bws.tech=="flash"||!r.opt.streaming)?r.from:r.progress;this.log.info("parallel ("+caller+") "+r.name+" loaded "+r.loaded+" to "+o.best.id+" after "+r.elapsed()/1e3+" hdrs "+r.ms_hdrs);var range={from:from,to:r.to,cache_id:r.info.cache_id};var p={req:r,info:r.info,cdn:o.best,range:range};if(this.bws.method.on_parallel_req)this.bws.method.on_parallel_req(this,p);if(this.bws.method.next_slice_fixup)this.bws.method.next_slice_fixup(this,p.range);r.info.overloaded=this.req(p.cdn,p.range.from,p.range.to,{segment:p.info.segment,clone:r,cache_id:p.info.cache_id,xhr_opt:p.info.xhr_opt,from_cache:p.from_cache},"parallel_on_slow");this.bws.stats.parallel_n++},this)};proto.req=function(cdn,from,to,info,caller){if(to>-1&&from>to){this.log.info("invalid range "+from+"-"+to);return void this.onerror("invalid req range",{fallback:1,reason:"invalid_range"})}var req=new zreq(cdn,from,to,this,info,this.bws.cdn_svc);this.bws.method.sort_reqs(this);if((!info||!info.clone&&!info.rate)&&this.stats.prev_cdn&&cdn!=this.stats.prev_cdn){var prev=this.stats.prev_cdn;if(cdn.is_origin()&&prev.is_origin())this.bws.stats.cdn_switch.o2o++;else if(cdn.is_origin()&&!prev.is_origin())this.bws.stats.cdn_switch.h2o++;else if(!cdn.is_origin()&&prev.is_origin())this.bws.stats.cdn_switch.o2h++;else if(!cdn.is_origin()&&!prev.is_origin())this.bws.stats.cdn_switch.h2h++}if(!info||!info.clone&&!info.rate)this.stats.prev_cdn=cdn;this.bws.cancel_delayed_fb();return req};proto.cache_validate=function(req){var hdrs=req.resp.hdrs;var hdr_date=hdrs.date,hdr_x_date=req.cdn.is_hola()&&hdrs["x-date"];if(!hdr_date)return;var ndate=date(hdr_date),pdate;var entry=this.bws.cache.get_entry(req.info.cache_id);if(!(pdate=entry.maps[req.cdn.host].get_date(req.from,req.to)))return;if(ndate<=pdate.setSeconds(pdate.getSeconds()+1)||hdr_x_date&&hdr_x_date!=hdr_date||req.hola_resp.status==304){return}this.cache_purge(req,"mismatch "+hdr_date+" > "+pdate.toUTCString())};proto.cache_purge=function(req,reason){req.info.from_cache=false;this.log.info(req.id+" cache purge "+reason);this.bws.cache.unset({id:req.info.cache_id,host:req.cdn.host});this.reqs.forEach(function(r){if(r.info.cache_backup&&r.info.cache_backup.cdn==req.cdn)delete r.info.cache_backup});req.set_ttc()};proto.send_reqs=function(){if(this.stopped)return;this.bws.player.refresh_buffered();if(this.bws.fastest_policy())this.parallel_on_slow("send_reqs");this.bws.method.send_reqs(this)};proto.choose_cache_source=function(cached){cached.sort(function(a,b){return b.range.to-a.range.to});var chosen,chosen_i;if(cached.length)this.log.debug("cache_get found "+cached.length+" options");for(var i=0;i<cached.length;i++){var cdn;if(chosen&&chosen.is_enabled()&&(cached[0].range.to-cached[0].range.from)/2>cached[i].range.to-cached[i].range.from){break}cdn=this.bws.cdns.find(function(e){return e.host==cached[i].cdn});if(cdn&&cdn.is_enabled()){if(chosen&&chosen.is_enabled()&&chosen.compare_rate(cdn)<=0){this.log.debug("cdn "+cdn.id+" !fail "+cdn.bps()+"<"+chosen.bps()+" "+cached[i].range.from+"-"+cached[i].range.to);continue}chosen=cdn;chosen_i=i;this.log.debug("chosen "+cdn.id+" !fail "+cdn.bps()+"Bps"+" "+cached[i].range.from+"-"+cached[i].range.to)}else if(cdn&&cdn.enabled){if(chosen&&(chosen.is_enabled()||chosen.compare_rate(cdn)<=0||(cached[chosen_i].range.to-cached[chosen_i].range.from)/2>cached[i].range.to-cached[i].range.from)){this.log.debug("cdn "+cdn.id+" usable "+cdn.bps()+"<"+chosen.bps()+" "+cached[i].range.from+"-"+cached[i].range.to);continue}chosen=cdn;chosen_i=i;this.log.debug("chosen "+cdn.id+" enabled "+cdn.bps()+" "+cached[i].range.from+"-"+cached[i].range.to)}}if(!chosen)return;this.log.debug("next cache cdn "+chosen.name+" "+JSON.stringify(cached[chosen_i]));return{cdn:chosen,range:cached[chosen_i].range}};proto.sec_until_offset=function(o){if(this.bws.method.sec_until_offset)return this.bws.method.sec_until_offset(o);return Math.max(0,this.bws.method.offset2sec?this.bws.method.offset2sec(this,o)-this.bws.get_pos():this.bws.method.dur)};proto.cache_get=function(range){if(!this.bws.cache||this.CG("cdn.cache.disabled"))return;var cached=this.bws.cache.next_immediate({id:range.cache_id,from:range.from,to:range.to})||[];return this.choose_cache_source(cached)};proto.get_best_cdn=function(range){var sz=range.to<0||this.bws.method.type=="hola_adaptive"?this.slice:range.to+1-range.from;var allow_fast=this.bws.method.fast_allowed_range(this,range);var sec=Math.round(this.sec_until_offset(range.from)*.8)||this.slice_sec;var replace=[];this.reqs.forEach(function(req){if(!req.is_slow_rate())return;replace.push({id:req.cdn.id,bpms:req.bpms({force:true}),ms_hdrs:req.ms_hdrs||req.elapsed()})});return Object.assign({fastest:this.bws.cdns.get_best_cdn("next_cdn",{allow_fast:allow_fast,sz:sz,sec:sec,fastest:this.bws.fastest_policy(),replace:replace})},this.bws.cdns.get_lowcost_cdn(sz,this.slice_sec,allow_fast,replace))};proto.next_cdn=function(range){var if_not_cached=this.CG("cdn.send_reqs.origin_if_not_cached");var fastest=this.bws.fastest_policy();var origin=this.bws.cdns.get_origin();var res;if(if_not_cached&&this.bws.method.offset2sec&&origin&&origin.is_enabled()&&(!this.bitrate||if_not_cached>this.bws.method.offset2sec(this,range.from))){res={cdn:origin,range:range};this.log.debug("origin if not cached - next cdn "+JSON.stringify(res));return res}if(fastest&&origin&&origin.is_enabled()&&(this.CG("cdn.send_reqs.origin_as_fastest")||this.CG("cdn.send_reqs.origin_until_rated")&&!origin.bpms)){res={cdn:origin,range:range};this.log.debug("next cdn "+JSON.stringify(res));return res}var chosen_cdns=this.get_best_cdn(range);var best=fastest?chosen_cdns.fastest:chosen_cdns.lowcost_usable||chosen_cdns.fastest;if(!best)return void this.log.debug("next cdn none - no best");if(fastest){this.reqs.forEach(function(req){if(req.cdn==best||req.cdn.bpms||req.loaded<128*KB||req.info.from_cache){return}if(best.compare_rate({host:req.cdn.host,bpms:req.bpms(),ms_hdrs:req.ms_hdrs,can_get:function(){return req.can_get()},rate:function(){return req.rate()},is_bw_from_cache:function(){return 0},is_req:true})>0){best=req.cdn}})}if(this.CTD("cdn.send_reqs.next_cdn.use_best_single")){var _best=fastest?best:this.bws.cdns.prev_best_cdn;if(!this.CG("cdn.send_reqs.next_cdn.disable_use_best_single")&&_best){this.log.debug("use_best_single - next cdn "+_best.id);return{cdn:_best,range:range}}}if(util.jtest.next_cdn){return{cdn:this.bws.cdns.get_by_uid(util.jtest.next_cdn),range:range}}if(res=best?{cdn:best,range:range}:null){this.log.debug("next cdn policy "+this.bws.policy()+" buffered "+this.bws.buf_sec_total()+" requested "+this.requested_sec()+" chosen cw"+res.cdn.uid+"/"+res.cdn.req_uid+" rate "+res.cdn.rate()+" best cw"+best.uid+(res.cdn!=best?" rate "+best.rate():""))}return res};proto.next_unrated=function(){var allow_fail=this.bws.cdns.every(function(cdn){return!cdn.is_enabled()});var live_stream=this.bws.player.is_live_stream();var chosen=this.bws.cdns.find(function(cdn){if(this.CG("cdn.send_reqs.origin_only")&&!cdn.is_origin())return;var ping_ms=this.CG("cdn.send_reqs.rate.keep_alive")?cdn.is_origin()?Math.max(this.CG("cdn.send_reqs.origin.keep_alive")||0-date.ms.SEC,4*date.ms.SEC):25*date.ms.SEC:live_stream&&cdn.cache_flag=="miss"&&cdn.is_hola()&&!this.bws.is_paused()?5*date.ms.SEC:this.CG("cdn.send_reqs.rate.stale_ms")||5*date.ms.MIN;return cdn.enabled&&(allow_fail||cdn.is_enabled())&&!this.is_cdn_active(cdn)&&(!cdn.ms_hdrs||ms_since(cdn.success_ts)>ping_ms)&&!cdn.is_disconnected()&&!cdn.is_busy()},this);return chosen?{cdn:chosen}:null};proto.requested_sec=function(){var sec=0,ranges=[];this.reqs.forEach(function(r){if(r.info.rate)return;var range=this.bws.adaptive?r.info.segment.index+"-"+r.info.segment.index:r.from+"-"+r.to;if(ranges.includes(range))return;sec+=r.to_sec(r.opt.streaming?r.progress:r.from,r.to)||0;ranges.push(range)},this);return sec};proto.add_chunk=function(chunk){var req=chunk.req;if(req.info.data_prefix&&chunk.from>req.from){chunk.from-=req.info.data_prefix;chunk.to-=req.info.data_prefix}chunk.index=req.info.segment&&req.info.segment.index;chunk.qid=req.info.segment&&req.info.segment.qid;if(!this.bws.method.need_chunk(chunk))return req.discarded=chunk.data.byteLength;var from=chunk.from;if(req.pending_served){if(req.pending_served.to+1==from)from=req.pending_served.from;req.pending_served=null}chunk.sec=req.to_sec(from,chunk.to)||0;this.downloaded_sec+=chunk.sec;chunk.data.final=!req.info.keymap_split&&(chunk.to==req.to||req.xhr&&(req.xhr.success||chunk.to+1==req.xhr.total));if(!chunk.sec&&from!=chunk.to)req.pending_served={from:from,to:chunk.to};this.log.debug("req "+req.name+" data added"+(req.info.from_cache?" from cache":"")+" "+chunk.from+"-"+chunk.to+" len "+chunk.data.byteLength);if(this.bws.method.merge_chunk)return this.bws.method.merge_chunk(chunk);for(var i=0;i<this.chunks.length&&chunk.from>this.chunks[i].from;i++);chunk.order=this.chunks_order+","+chunk.to;this.chunks_order++;this.chunks.splice(i,0,chunk);chunk.req.served+=chunk.data.byteLength;return chunk};proto.serve=function(){if(this.bws.suspended||!this.chunks.length||this.opt.jtest_no_serve)return;var served=[];for(var i=0;i<this.chunks.length;i++){var chunk=this.chunks[i];if(!this.bws.method.is_next_chunk(chunk))continue;var other=chunk.req.info.overloaded||chunk.req.info.clone;if(other&&other.error==ERR.aborted){this.discard_req_chunks(other);i=0}this.bws.method.set_chunk_data(chunk);var from=chunk.from,to=from+this.bws.method.chunk_len(chunk);if(this.pending_served){if(this.pending_served.to+1==from)from=this.pending_served.from;this.pending_served=null}var sec=chunk.req.to_sec(from,to);if(!sec&&from!=to)this.pending_served={from:from,to:to};this.log.info("stream->bwsaver "+from+"-"+to+" sec "+sec+" of range "+(this.bws.adaptive?chunk.req.from+"-"+chunk.req.to+" completed "+chunk.req.loaded+" of idx "+chunk.index:this.from+"-"+this.to+" completed "+this.completed));if(!i)this.bws.set_serving_state(!this.served_bytes);this.served_sec+=sec;this.served_bytes+=chunk.data.byteLength;if(chunk.req.cdn.is_fast()){this.bws.stats.served_fast_bytes+=chunk.data.byteLength;this.bws.stats.served_fast_sec+=sec}served.push(chunk);chunk.fullsize=this.fullsize;this.bws.serve_log(chunk);this.bws.method.ondata(chunk)}if(served.length){this.emit("serve");served.forEach(function(c){this.chunks.splice(this.chunks.indexOf(c),1)},this)}this.bws.buf_sec_recalc()};proto.bps=function(){return Math.round(this.bpms()*date.ms.SEC)};proto.bpms=function(){return this.served_bytes/ms_since(this.tm_create)};proto.delay_fallback=function(err,opt){var _this=this,ms;if(!opt||!opt.fallback||opt.reason!="no_resources")return;if(!(ms=this.CG("portal.demo.fallback_delay")))return;if(this.bws.fallback_delayed())return true;this.bws.delay_fallback(function(){if(_this.cdns&&_this.cdns.some(function(c){return c.is_enabled()})){_this.bws.cancel_delayed_fb()}else _this._onerror(err,opt)},ms);this.log.info("fallback delayed for "+ms+" ms");return true};proto.onerror=function(err,opt){if(this.delay_fallback(err,opt))return;this._onerror(err,opt)};proto._onerror=function(err,opt){this.log.err(this.name+" failed "+err);if(this.opt.onerror)this.opt.onerror(this,err,opt)};proto.set_completed=function(completed,caller){var _this=this;if(completed==this.completed)return;this.bws.emit("set_completed",this,completed);this.completed=completed;this.from=Math.min(this.from,this.completed);this.map=new map.Map;this.chunks=this.chunks.filter(function(c){if(c.req.info.segment&&c.req.info.segment.index<_this.bws.from)return;var from=c.index!==undefined?c.index:c.from;var to=c.index!==undefined?c.index:c.to;_this.map.update(from,to);return true});this.log.info("set completed "+this.completed+" called by "+caller)};proto.ondata=function(req,res,caller){var zperr=this.bws.zone.perr_get();if(req.info.rate)return;if(req.done&&req.info.segment)req.info.segment.done=true;if(!this.fullsize&&res&&res.fullsize&&!(req.cdn.is_hola()&&!this.CG("cdn.send_reqs.disable_url_ranges")&&!req.resp.hdrs["x-hola-fullsize"])){this.bws.method.set_fullsize(this,res.fullsize)}if(!req.error&&[200,206].includes(+req.status)){var data=res.data,size=data.byteLength||data.length;if(req.done){req.resp.size=size;if(req.to<0)req.to=req.resp.size-1}this.bws.emit("ondata",{size:size,req:req});if(!req.done||!req.served){var from=res.file_start||req.from;var to=res.file_start!==undefined?res.file_start+data.byteLength-1:req.to;if(req.to>-1&&to>req.to){this.log.info(req.id+" size mismatch, req.to "+req.to+" chunk.to "+to+" file_start "+res.file_start+" data.len "+data.byteLength+" caller "+caller)}this.add_chunk({from:from,to:to,data:data,req:req,id:(req.info.segment?"-- "+req.info.segment.index+" -- ":"")+from+"-"+to+" "+req.id+(req.info.segment?" qid "+req.info.segment.bitrate:"")});this.serve()}else if(req.served!=data.length){zperr({id:"streaming_not_served_all_bytes",err:"served "+req.served+" != data "+data.byteLength})}}else{this.log.info("req "+req.name+" failed "+(res.error||"")+" status "+req.status);this.bws.method.ondata({error:req.error,status:+req.status,req:req})}};proto.resume=function(){this.stopped=false;this.serve();this.send_reqs();this.monitor()};proto.req_size=function(){var bytes=0,completed=this.completed;this.chunks.forEach(function(c){if(completed!=c.from)return;bytes+=c.to+1-c.from;completed+=c.to+1-c.from});this.reqs.forEach(function(req){if(!req.info.clone)bytes+=req.to+1-req.from});return bytes};proto.rate_bomb=function(){if(!this.CG("cdn.monitor.rate_bomb"))return;this.rate_bomb_state=this.rate_bomb_state||{count:0,last:0};var h=this.rate_bomb_state,_this=this;var origin=this.bws.cdns.get_origin();if(h.running||!origin||this.bws.get_pos()<10||date.monotonic()-h.last<5*date.ms.SEC||h.count>9){return}var req=this.bws.method.req(this,origin,0,-1,{rate:true,add_random_param:true});h.running=true;h.count++;req.once("complete",function(){_this.rate_bomb_state.running=false;_this.rate_bomb_state.last=date.monotonic()})};proto.monitor=function(){var _this=this;if(this.opt.dummy||this.req_mon)return;function _monitor(){this.monitor_start=date.monotonic();if(!this.bws.cdns){this.uninit();return}if(!this.stopped){if(this.reqs.length)this.parallel_on_slow("monitor");else this.send_reqs()}this.rate_bomb()}if(this.opt.jtest_next_monitor_ms){var ms=this.opt.jtest_next_monitor_ms;this.opt.jtest_next_monitor_ms=undefined;this.req_mon=setTimeout(function(){_monitor.call(_this);_this.req_mon=undefined;_this.monitor()},ms);return}this.req_mon=setInterval(function(){_monitor.call(_this)},500)};proto.abort=function(allow_finish){this.stopped=true;for(var i=0;i<this.reqs.length;i++){var req=this.reqs[i];if(allow_finish&&(req.done||req.info.rate||req.loaded)||!req.sp||req.info.allow_finish){if(!req.done&&!req.rate&&req.loaded&&req.sp)this.emit("allow_finish",req);continue}req.abort("stream abort");i--}if(!this.rate_bomb_state||!allow_finish){clearInterval(this.req_mon);this.req_mon=undefined}this.bws.buf_sec_last_ts=this.bws.buf_sec_last=undefined};proto.discard_req_chunks=function(req){this.chunks=this.chunks.filter(function(c){return c.req!=req})};proto.uninit=function(){this.abort()};proto.is_video=function(){return this.id.startsWith("video")};proto.is_audio=function(){return this.id.startsWith("audio")};proto.is_cdn_active=function(cdn){return this.reqs.some(function(req){return req.cdn==cdn})};proto.pause=function(){return this.abort(true)};proto._sz2sec=function(sz){return this.bitrate?sz*8/this.bitrate:0};proto.sz2sec=function(sz){return Math.round(this._sz2sec(sz))};proto.sec2sz=function(sec){return this.bitrate?Math.round(sec*this.bitrate/8):0};proto.print_chunks=function(){return this.chunks.reduce(function(s,r){return s+r.from+"-"+r.to+"\n"},"")};proto.print_reqs=function(){var s="";this.reqs.forEach(function(r){s+=r.name+" "+Math.round(r.from/KB)+"K-"+Math.round((r.to+1)/KB)+"K"+(r.info.from_cache?" c":"")+"\n"});return s};proto.oncomplete=function(){this.log.info("oncomplete stream "+this.name);if(this.opt.oncomplete)this.opt.oncomplete(this)};proto.set_slice_size=function(sz,sec,caller){if(!sec)return;sz=sz||this.bws.method.sec2offset(this,sec)-this.vid_hdr_sz;var min=this.CG("cdn.bwsaver.min_slice_sz")||(this.is_video()?MB:512*KB);if((!zutil.is_mocha()||this.bws.cdn_svc.jtest.set_slice)&&sz<min&&!this.bws.adaptive){sz=min;sec=this.bws.method.offset2sec(this,sz+this.vid_hdr_sz)}if(this.slice_sec==sec&&this.slice==sz)return;this.slice_sec=sec;this.slice=sz;this.log.info("stream "+this.id+" set slice size "+sz+" = "+this.slice_sec+" sec caller "+caller);this.bws.player.emit("bws.slice_sz",{slice_sec:this.slice_sec,slice_sz:sz})};proto.on_meta_data=function(info){if(!info.bitrate&&(!info.duration||!this.fullsize))return;var prev=this.bitrate;this.bitrate=info.bitrate;if(!this.bitrate&&info.duration&&this.fullsize)this.bitrate=this.fullsize*8/info.duration;this.bws.stats.hdr_size=this.vid_hdr_sz=info.start_hdr_sz;if(!prev||this.bitrate!=prev){this.log.info("bitrate="+this.bitrate+" vid_hdr_sz="+this.vid_hdr_sz);if(!this.bws.adaptive&&!zutil.is_mocha())this.set_slice_size(0,this.slice_sec,"on_meta_data")}};return E});
define("/svc/cdn/pub/aggregator.js",["/util/date.js"],function(date){var E=Aggregator;function Aggregator(opt){if(!(this instanceof Aggregator))return new Aggregator(opt);this.log=opt.log.set_module("aggregator");this.ts=[];this.samples=[];return this}E.prototype.init_stream=function(ts){this.ts.push(ts)};E.prototype.ondata=function(sz){this.samples.push({sz:sz,ts:date.monotonic()})};E.prototype.end_stream=function(ts){for(var i=0;i<this.ts.length&&this.ts[i]!=ts;i++);if(i<this.ts.length)this.ts.splice(i,1);if(i>0)return;if(!this.ts.length)return this.samples=[];if(!this.samples.length||this.samples[0].ts>=this.ts[0])return;for(i=0;i<this.samples.length&&this.samples[i].ts<this.ts[0];i++);this.samples.splice(0,i)};E.prototype.data_since=function(ts){var sz=0;if(ts<0)ts=date.monotonic()+ts;this.samples.forEach(function(s){if(s.ts>ts)sz+=s.sz});return sz};return E});
(function(){var __hola_stub_define,crypto;var is_node=typeof module=="object"&&module.exports&&module.children;var is_ff_addon=typeof module=="object"&&module.uri&&!module.uri.indexOf("resource://");if(is_node||is_ff_addon)define=require("./require_node.js").define(module,"../");else define=define||self.define;if(is_node)crypto=require("crypto");define("/util/version_util.js",["/util/sprintf.js","/util/conv.js"],function(sprintf,conv){var E={};var ver_regexp=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;E._expand=function(ver){var v;if(!ver)return"";if(!(v=ver_regexp.exec(ver)))return;return sprintf("%03d.%03d.%03d",+v[1],+v[2],+v[3])};E.expand=conv.cache_str_fn(E._expand);E._trim=function(ver){var v;if(!ver)return"";if(!(v=ver_regexp.exec(ver)))return;return""+ +v[1]+"."+ +v[2]+"."+ +v[3]};E.trim=conv.cache_str_fn(E._trim);E._cmp=function(v1,v2){if(!v1||!v2)return+!!v1-+!!v2;var _v1=v1.split("."),_v2=v2.split("."),i;for(i=0;i<_v1.length&&i<_v2.length&&+_v1[i]==+_v2[i];i++);if(_v1.length==i||_v2.length==i)return _v1.length-_v2.length;return+_v1[i]-+_v2[i]};E.cmp=conv.cache_str_fn2(E._cmp);E._valid=function(v){return ver_regexp.test(""+v)};var version_valid_cache={};E.valid=function(v){var cache=version_valid_cache,res;v=""+v;if(v in cache)return cache[v];if(res=E._valid(v))cache[v]=res;return res};function iter_ver(version,cb){var v;if(!E.valid(version))return version;v=version.split(".");for(var i=v.length-1;i>=0&&!cb(v,i);i--);return v.join(".")}E.inc=function(version){return iter_ver(version,function(v,i){if(v[i]<999){v[i]=+v[i]+1;return true}v[i]=0})};E.dec=function(version){return iter_ver(version,function(v,i){if(v[i]>0){v[i]=+v[i]-1;return true}v[i]=999})};E.get_max=function(versions,cmp){var v,i;versions=versions.sort(cmp||function(v1,v2){return E.cmp(v2.version,v1.version)});for(i=0;i<versions.length;i++){v=versions[i];if(+v.isbranch||!+v.soft_tag||!+v.onsymbol||v.repository!="zon"||!E.valid(v.version)){continue}return v.version}};E.hash=function(ver){return crypto.createHash("md5").update("wQ"+ver+"\n").digest("hex").substr(0,8)};return E})})();
define("/svc/cdn/pub/source_buffer.js",["/util/events.js","/svc/cdn/pub/util.js","/util/etask.js","/util/util.js","/util/version_util.js"],function(events,util,etask,zutil,version_util){var api=util.get_api();zutil.inherits(SourceBuffer,events.EventEmitter);var E=SourceBuffer,proto=E.prototype;proto.addEventListener=proto.on;proto.removeEventListener=proto.off;var BYTES_PER_SECOND_GOAL=4*1024*1024;var TICKS_PER_SECOND=60;function SourceBuffer(opt){this.flash_api=opt.flash_api;this.log=opt.log.set_module("source_buffer");this.source=opt.media_src;this.buffer=[];this.buffer_sz=0;this.ms=Math.ceil(1e3/TICKS_PER_SECOND);this.player_id=opt.player_id;var ver=this.flash_api.version()||{};this.use_old_api=ver.jwplayer_version&&version_util.cmp(ver.patch_version,"1.0.31")<0}proto.schedule_tick=fallback_wrapper(function(func){if(!document.hidden||!this.flash_api.avail_set_timeout())return void(this.timer=setTimeout(func,this.ms));api.onTimeout=window.hola_onTimeout=function(){api.onTimeout=window.hola_onTimeout=undefined;func()};var _this=this;this._on_msg=function(e){if(e.data&&e.data.id=="hola.timeout"&&e.data.timeout_id=="source_buffer"&&e.data.player_id==_this.player_id){window.removeEventListener("message",_this._on_msg);_this._on_msg=null;func()}};window.addEventListener("message",this._on_msg);return void(this.use_old_api?this.flash_api.set_timeout(this.ms):this.flash_api.set_timeout(this.ms,"source_buffer"))});proto.append=fallback_wrapper(function(){var buffer=this.buffer,_this=this;var chunk,i,payload,max_size;if(!this.buffer_sz)return;max_size=Math.ceil(BYTES_PER_SECOND_GOAL/TICKS_PER_SECOND);payload=new Uint8Array(Math.min(max_size,this.buffer_sz));i=payload.byteLength;while(i){chunk=buffer[0].subarray(0,i);payload.set(chunk,payload.byteLength-i);if(chunk.byteLength<buffer[0].byteLength)buffer[0]=buffer[0].subarray(i);else buffer.shift();i-=chunk.byteLength}this.buffer_sz-=payload.byteLength;this.sp=etask([function(){return util.btoa(payload)},function(b64str){_this.emit("updatebegin",{b64str:b64str});_this.emit("updateend");if(_this.aborted)return;if(_this.buffer_sz)_this.schedule_tick(proto.append.bind(_this));else if(!_this.source||_this.source.readyState=="ended")_this.emit("ended")},function catch$(err){_this.log.warn("SourceBuffer error "+err);_this.emit("error",err)},function finally$(){_this.sp=null}])});proto.appendBuffer=fallback_wrapper(function(arr){this.aborted=false;if(!this.buffer_sz)this.schedule_tick(proto.append.bind(this));this.buffer.push(arr);this.buffer_sz+=arr.byteLength});proto.abort=function(){this.aborted=true;if(this._on_msg){window.removeEventListener("message",this._on_msg);this._on_msg=null}api.onTimeout=window.hola_onTimeout=undefined;clearTimeout(this.timer);this.buffer=[];this.buffer_sz=0;if(this.sp)this.sp.return();this.emit("aborted")};proto.uninit=function(){this.abort();this.removeAllListeners()};function fallback_wrapper(func){return function(){try{return func.apply(this,arguments)}catch(err){this.log.warn("SourceBuffer error "+err);this.emit("error",err)}}}return E});
define("/svc/cdn/pub/jsurlstream.js",["/svc/cdn/pub/util.js","/util/date.js","/util/etask.js","/svc/cdn/pub/source_buffer.js"],function(util,date,etask,source_buffer){var E={sb_list:{}};var api=util.get_api();var assign=Object.assign;function log_from_zone(z){return z.log_get().set_module("jsurlstream")}function hdrs_from_head(et,opt,zlog){var xhr=new XMLHttpRequest;return etask({name:"hdrs_from_head",cancel:true},[function try_catch$(){xhr.onload=this.continue_fn();xhr.onerror=this.throw_fn();xhr.open("HEAD",opt.url);xhr.send();zlog.info("req init hdrs from head "+opt.url);return this.wait()},function(){if(xhr.status==200)et.resp_hdrs=util.get_resp_hdrs(xhr)},function finally$(){xhr.abort()}])}E.flash_fetch_bin=function(player,opt){if(opt.headers&&opt.headers.Range)return;var remover,req,total,loaded,status=0,dont_abort,fetch_time;var zlog=log_from_zone(player.zone),ms_hdrs=0;var xhr={flash_xhr:true,readyState:XMLHttpRequest.OPENED,getAllResponseHeaders:function(){},getResponseHeader:function(){},abort:function(){if(req)opt.api_abort(req)},responseType:"arraybuffer",response:null};var et=etask({name:"flash_fetch_bin",cancel:true},[function(){remover=util.on_window_message(function(e){var data;if(!(data=e.data)||!/^holaflash\./.test(e.data.id))return;if(data.data){data=data.data;if(data.id!=req.id)return}else if(data.fb_id!=req.id||player.player_id&&e.data.player_id!=player.player_id){return}switch(e.data.id){case"holaflash.streamOpen":if(player.zone.CG("util.log.req_xhr")){zlog.info("flash_fetch_bin "+req.id+" streamOpen "+opt.url)}break;case"holaflash.streamProgress":total=data.bytesTotal;loaded=data.bytesLoaded;if(player.zone.CG("util.log.req_xhr")){zlog.info("flash_fetch_bin "+req.id+" streamProgress "+total+" "+loaded+" "+opt.url)}xhr.readyState=XMLHttpRequest.LOADING;if(opt.onprogress){opt.onprogress({srcElement:xhr,loaded:loaded,total:total})}break;case"holaflash.streamHttpStatus":if(player.zone.CG("util.log.req_xhr")){zlog.info("flash_fetch_bin "+req.id+" streamHttpStatus "+data.status+" "+data.ms_hdrs+" "+opt.url)}xhr.readyState=XMLHttpRequest.HEADERS_RECEIVED;xhr.status=status=data.status||200;ms_hdrs=data.ms_hdrs;if(opt.onreadystatechange)opt.onreadystatechange(xhr,{ms_hdrs:ms_hdrs});break;case"holaflash.streamComplete":var res={};res.fullsize=res.size=total;if(player.zone.CG("util.log.req_xhr")){zlog.info("flash_fetch_bin "+req.id+" streamComplete "+total+" "+loaded+" "+opt.url)}res.data=xhr.response={byteLength:res.size};res.status=status;res.flash_xhr=true;res.ms_hdrs=ms_hdrs;res.hdrs=et.resp_hdrs||{};dont_abort=true;et.return(res);break;case"holaflash.streamError":et.throw("streamError");break}},true);var o={url:opt.url,jsurlstream_req_id:opt.req_id,rate:opt.rate};fetch_time=date.monotonic();xhr.flash_req=req=opt.api_load(o);if(player.zone.CG("cdn.send_reqs.hdrs_from_head"))this.spawn(hdrs_from_head(this,opt,zlog))},function(){return this.wait()},function catch$(e){var is_critical=e instanceof Error;zlog[is_critical?"err":"warn"]("flash_fetch_bin err: "+e);return this.return({fallback:is_critical,error:e})},function finally$(){remover();if(!req)return;if(!dont_abort)opt.api_abort(req);else{if(opt.segment&&opt.segment.type=="fragment"&&!opt.hrange){opt.segment.ts_fetch_bin=fetch_time;player.emit("request_fragment_done",{jstime:opt.segment.ts_fetch_bin-opt.segment.t0})}}}]);E.sp.spawn(et);et.xhr=xhr;return et};E.init_adaptive=function(player,adaptive){var zlog=log_from_zone(player.zone);var swf=player.swf||player.module&&player.module.swf;E.adaptive=adaptive;player.set_cdn_mode(true);var request_fragment=adaptive.fallback_wrapper(function(o){var data=o.data;var type=data.context&&data.context.type||"fragment";var segment={url:data.url,req_id:data.req_id,playlist_id:"def",dur:10,type:type,format:"abst",t0:date.monotonic()};if(type=="fragment")player.emit("request_fragment",data);zlog.debug("hola_requestFragment req "+data.req_id+" "+data.url);adaptive.init_segment(segment)},"adaptive");var abort_fragment=adaptive.fallback_wrapper(function(o){zlog.debug("hola_abortFragment id ",o.data.req_id);var req,segment,req_id=o.data.req_id,sb;while(req=adaptive.get_req_by_id(req_id)){req.abort_fragment=true;req.abort("abort_fragment")}if(segment=adaptive.get_segment_by_req_id(req_id))adaptive.remove_segment(segment);if(sb=E.sb_list[req_id])sb.abort()},"adaptive");api.requestFragment=window.hola_requestFragment=request_fragment;api.abortFragment=window.hola_abortFragment=abort_fragment;var on_msg=function(e){if(!e.data||player.player_id&&e.data.player_id!=player.player_id)return;switch(e.data.id){case"hola.abortFragment":return abort_fragment(e);case"hola.requestFragment":return request_fragment(e)}};window.addEventListener("message",on_msg);adaptive.on("uninit",function(){player.set_cdn_mode(false);api.requestFragment=window.hola_requestFragment=undefined;api.abortFragment=window.hola_abortFragment=undefined;window.removeEventListener("message",on_msg)});if(player.zone.CG("cdn.send_reqs.disable_flash_xhr"))return;adaptive.flash_xhr=true;player.flash_api.settings({fetch_bin_chunk_size:Infinity});adaptive.fetch_bin=function(opt){return E.flash_fetch_bin(player,assign(opt,{api_load:function(o){return swf.hola_fetchBin(o)},api_abort:function(r){swf.hola_fetchBinRemove(r.id)}}))};zlog.notice(adaptive.adaptive+" using flash_xhr");E.sp=etask("cdn_method_adaptive",[function(){return this.wait()}]);adaptive.on("uninit",function(){E.sp.return()})};E.ondata_adaptive=function(chunk,player,adaptive){var zlog=log_from_zone(player.zone);var swf=player.swf||player.module&&player.module.swf;var segment=chunk.req.info.segment,req_id=segment.req_id,req_xhr;zlog.debug("ondata_jsurlstream resp "+req_id);adaptive.indexer[segment.playlist_id].completed=segment.index;if((req_xhr=chunk.req.xhr)&&req_xhr.flash_xhr){adaptive.send_single_perf_event("jsurlstream_send_data_from_fetchbin");return void swf.hola_onFragmentData({req_id:req_id,fetchBinReqId:req_xhr.flash_req.id})}function onFragmentData(req_id,status,b64str){var cmd='<invoke name="hola_onFragmentData" '+'returntype="javascript"><arguments><object>'+'<property id="req_id">'+"<string>"+req_id+"</string>"+"</property>"+'<property id="total">'+"<number>"+chunk.data.byteLength+"</number>"+"</property>"+(b64str?'<property id="data">'+"<string>"+b64str+"</string>"+"</property>":"")+(status?'<property id="status">'+"<number>"+status+"</number>"+"</property>":"")+"</object></arguments></invoke>";swf.CallFunction(cmd)}var sb=new source_buffer({flash_api:player.flash_api,log:player.zone.log_get(),player_id:player.player_id});sb.on("updatebegin",function(e){onFragmentData(req_id,0,e.b64str)});sb.on("ended",function(){onFragmentData(req_id,200,"");delete E.sb_list[req_id]});sb.on("aborted",function(){delete E.sb_list[req_id]});sb.on("error",function(err){adaptive.bws.fallback(err,"hls")});E.sb_list[req_id]=sb;sb.appendBuffer(new Uint8Array(chunk.data))};return E});
define("/svc/cdn/pub/hap_util.js",["/svc/cdn/pub/config.js","/svc/cdn/pub/util.js"],function(config,util){var E={},assign=Object.assign;E.parse_manifest=function(data,url){var levels=[],level_data;var level_re=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g;var attr_re=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;while(level_data=level_re.exec(data)){var level={segments:[]},match,attrs={},codecs;while(match=attr_re.exec(level_data[1])){var value=match[2];if(value[0]=='"'&&value[value.length-1]=='"')value=value.slice(1,-1);attrs[match[1].toLowerCase()]=value}level.url=util.resolve_url(url,level_data[2]);var resolution=attrs.resolution;if(resolution&&(match=/^(\d+)x(\d+)$/.exec(resolution))){level.width=+match[1];level.height=+match[2]}level.bitrate=+attrs["average-bandwidth"]||+attrs.bandwidth;level.name=attrs.name;if(codecs=attrs.codecs){codecs=codecs.split(",");for(var i=0;i<codecs.length;i++){var codec=codecs[i];if(codec.includes("avc1"))level.video_codec=E._transform_vcodec(codec);else level.audio_codec=codec}}levels.push(level)}return levels};E.parse_level=function(data,level,level_id,manifest){var cur_sn=0,levelkey={method:null,key:null,iv:null,uri:null};var range_st,range_end,segment,cc,total=0;var result,level_re=new RegExp("(?:#EXT-X-(MEDIA)-SEQUENCE:(\\d+))|"+"(?:#EXT-X-(TARGET)DURATION:(\\d+))|"+"(?:#EXT-X-(KEY):(.*)[\\r\\n]+([^#|\\r\\n]+)?)|"+"(?:#EXT(INF):([\\d\\.]+)[^\\r\\n]*[\\r\\n]+([^#|\\r\\n]+)?)|"+"(?:#EXT-X-(BYTE)RANGE:([\\d]+[@[\\d]*)]*[\\r\\n]+([^#|\\r\\n]+)?|"+"(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DIS)CONTINUITY))|"+"(?:#EXT-X-(PROGRAM)-DATE-TIME:(.*))","g");assign(level,{live:true,first_sn:0});while(result=level_re.exec(data)){result.shift();result=result.filter(function(n){return n!==undefined});switch(result[0]){case"MEDIA":cur_sn=level.first_sn=+result[1];break;case"TARGET":level.target=+result[1];break;case"ENDLIST":level.live=false;break;case"DIS":cc++;break;case"BYTERANGE":var params=result[1].split("@");range_st=params.length<2?range_end:+params[1];range_end=+params[0]+range_st;if(segment&&!segment.url){segment.range={start:range_st,end:range_end};segment.url=util.resolve_url(manifest,result[2])}break;case"INF":var duration=+result[1];if(isNaN(duration))break;var sn=cur_sn++,url;url=result[2]?util.resolve_url(manifest,result[2]):"";segment={url:url,duration:duration,start:total,sn:sn,level:level_id,cc:cc,PTSDTSshift:0};level.segments.push(segment);total+=duration;break;case"PROGRAM":break;default:break}}if(segment&&!segment.url){level.segments.pop();total-=segment.duration}level.total=total;level.avg_duration=total/level.segments.length;level.end_sn=cur_sn-1;return level};E.parse_keymap=function(data){function parse_str(str){var kw=str.split(";"),map={},res;for(var i=0;i<kw.length;i++){if(res=/([^=]*)=(.*)/.exec(kw[i]))map[res[1]]=res[2]}return map}var keymap={VER:1,frags:{}},res,header={},cur_sn=0,cnt=0;var keymap_re=new RegExp("^(?:#EXT(INF|ENC|-X-ENCODING-INFO|"+"-X-MEDIA-SEQUENCE)): ?(.*)$","mg");var pmt_re=/(aac|avc|id3)([-0-9]+)(,|$)/g,temp,key,is_keymap=false;while(res=keymap_re.exec(data)){switch(res[1]){case"-X-MEDIA-SEQUENCE":cur_sn=+res[2];break;case"INF":cur_sn++;cnt++;break;case"-X-ENCODING-INFO":is_keymap=true;var head_str=parse_str(res[2]);for(key in head_str){switch(key){case"pps":case"sps":header[key]=JSON.parse("["+head_str[key]+"]");break;case"pmt":header.pmt={};while(res=pmt_re.exec(head_str.pmt))header.pmt[res[1]]=+res[2];break}}break;case"ENC":temp=parse_str(res[2]);for(key in temp){temp[key]=temp[key].split(",").map(function(el){var raw_data=el.split("/");return{offset:+raw_data[0],sn:+raw_data[1]}})}keymap.frags[cur_sn-1]=assign({idr:[],indr:[],sei:[]},temp,header);break}}keymap.frag_cnt=cnt;return is_keymap?keymap:null};E.strip_keymap=function(data){return data.replace(/^#EXT(?:ENC|-X-ENCODING-INFO).*$\n/gm,"")};E._transform_vcodec=function(codec){var avcdata=codec.split(".");if(avcdata.length<=2)return codec;return avcdata[0]+"."+("0"+(+avcdata[1]).toString(16)).slice(-2)+("000"+(+avcdata[2]).toString(16)).slice(-4)};return E});
define("/svc/cdn/pub/hola_adaptive.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/progressive.js","/util/util.js","/util/url.js","/util/events.js","/util/array.js","/util/zerr.js","/svc/cdn/pub/jsurlstream.js","/util/etask.js","/util/date.js","/svc/cdn/pub/cache.js","/util/escape.js","/svc/cdn/pub/hap_util.js","/svc/cdn/pub/cdnlist.js"],function(util,progressive,zutil,zurl,events,array,zerr,jsurlstream,etask,date,zcache,zescape,hutil,cdnlist){var E={};var assign=Object.assign;var ERR=util.ERR;var KB=1024;function get_dm(pl){return(pl.module||pl.slave&&pl.slave.module||{}).dailymotion}function log_from_zone(zone){return zone.log_get().set_module("hap")}function set_quality(qid,stream,caller,live_updated){var manual_level=this.hap.get_manual_level(),stats;if(manual_level>-1)qid=manual_level;if(this.qid==qid)return;var _this=this,playlist;this.hap.set_quality(qid,playlist=this.playlists[qid]);if(!playlist.segments||!playlist.segments.length||playlist.attributes.live&&!live_updated&&this.last_updated_qid!=qid){stats=this.bws.cdn_svc.attached_stats&&this.bws.cdn_svc.attached_stats.get_stats_all();if(stats&&stats.player.view_sec<=10)this.bws.stats.quality_switch.miss_10sec++;this.bws.stats.quality_switch.miss++;this.log.info("set_quality wait for qid "+qid+" caller "+caller);return this.wait_level=qid}this.wait_level=undefined;this.emit("set_quality",qid,caller);if(typeof stream=="string"){caller=stream;stream=undefined}this.prev_qid=this.qid;this.prev_cache_id=this.cache_id;this.qid=qid;this.cache_id=this.pl_info[qid].cache_id;var segment=playlist.segments[0],purl=zurl.parse(segment.url);var info=this.pl_info[qid];if(!this.bws.cdns.has(purl.hostname))this.bws.add_origin_url(segment.url,"set_quality");function set_stream_quality(s){if(_this.is_live&&(s.completed<segment.media_index||s.completed>segment.media_index+playlist.segments.length)){s.set_completed(+segment.media_index,"set_quality_live")}else{s.set_completed(Math.max(s.completed>info.last_index?info.start_index:s.completed||0,info.start_index),"set_quality")}s.set_slice_size(_this.pl_info[qid].sz,_this.pl_info[qid].sec,"set_quality");s.bitrate=playlist.bitrate||segment.bitrate;if(info.first_index&&(!_this.is_live||!s.from))s.from=info.first_index;if(info.last_index>-1)_this._set_fullsize(s,info.last_index+1,true);s.name="stream vc"+s.uid+" "+s.id+" "+s.from+"-"+s.to+" "+s.url.path;var close=[];s.reqs.forEach(function(req){if(req.info.rate||req.resp&&req.info.from_cache)return;if(req.info.segment.qid<_this.qid&&!req.loaded||req.size()-req.loaded>info.est_ts_sz&&req.info.segment.qid>_this.qid){return close.push(req)}req.stream.bws.emit("req_resp",req,"set_quality")});var sinfo=_this.stream_info[s.id];if(sinfo.transition&&sinfo.transition.km&&sinfo.transition.km.req)close.push(sinfo.transition.km.req);if(sinfo.transition&&sinfo.transition.km&&sinfo.transition.km.old_req)close.push(sinfo.transition.km.old_req);close.forEach(function(req){req.stream.discard_req_chunks(req);req.abort("set quality")});if(_this.prev_qid!==undefined){sinfo.transition={old_qid:_this.prev_qid,qid:_this.qid};if(_this.debug_keymap_switch){_this.log.console("define transition "+_this.prev_qid+"->"+_this.qid)}}if(caller!="update_playlists")_this.send_reqs(s)}if(stream)set_stream_quality(stream);else this.bws.streams.forEach(function(s){set_stream_quality(s)});this.log.info("quality changed from "+(this.prev_qid===undefined?"none":this.playlists[this.prev_qid].bitrate||"cache id "+this.prev_cache_id)+" to "+(this.playlists[this.qid].bitrate||"cache id "+this.cache_id)+" qid "+this.qid+" caller "+caller);if(this.prev_qid!==undefined){if(this.prev_qid<this.qid)this.bws.stats.quality_switch.up++;else this.bws.stats.quality_switch.down++;this.bws.stats.quality_switch.n++;stats=this.bws.cdn_svc.attached_stats&&this.bws.cdn_svc.attached_stats.get_stats_all();if(stats&&stats.player.view_sec<=10)this.bws.stats.quality_switch.under_10sec++}}function ondetached(){var _this=this;this.bws.streams.forEach(function(stream){stream.abort(true);stream.set_completed(_this.start_index());_this.reset_segments(stream);stream.served_sec=stream.served_bytes=0});if(this.hap)this.hap.abort();this.update_playlists()}function onseeking(prev,_pos,jtest_index){this.last_segment_index=undefined;var pos=this.player.get_pos();var playlist=this.playlists&&this.playlists[this.qid];var dm=this.hap.dm;this.log.info("hap onseeking pos "+pos+" prev "+prev+" playlist "+(playlist&&playlist.bitrate)+" segments "+!!(playlist&&playlist.segments));if(pos===undefined||!playlist||!playlist.segments)return;if(!this.CG("cdn.method.disable_skip_seeks")){if(prev==0&&pos&&this.is_live)return void this.log.info("skip live start seek");var buf=this.player.get_buffered(),range;for(var i=0;i<buf.length;i++){if(pos-prev<1&&buf.start(i)==pos)return void this.log.info("skip gap seek");if(!range&&(prev>=buf.start(i)&&prev<buf.end(i)||pos>=buf.start(i)&&pos<buf.end(i))){range={from:buf.start(i),to:buf.end(i)}}else if(range&&buf.start(i)-range.to<dm.config.maxBufferHole)range.to=buf.end(i);if(range&&prev>=range.from&&prev<range.to&&pos>=range.from&&pos<range.to){return void this.log.info("skip seek into buffered area")}}}var index=zutil.is_mocha()?jtest_index:this.get_index(playlist,pos+this.bws.sec_in_buffer(pos,true,dm.config.maxBufferHole),true);if(!isFinite(index))return void this.log.info("hap onseeking could not determine index");var cur=this.frag_current();var info={offset:index,time:pos,to:this.is_live?-1:this.last_index()};this.log.info("hap seek index "+index+" cur index "+cur);if(cur!=index)this.seek_info=info;else{this.emit("seek_complete",info);this.bws.seek_complete(info)}}function max_qid(opt){opt=opt||{};var max=[];if(opt.bps!==undefined)max.push(this.max_qid_by_bandwidth(opt.bps));max.push(this.max_qid_by_resolution(opt.res));max.push(this.max_qid_by_customer());max=max.filter(function(q){return q!==undefined});if(!max.length)return opt.def!==undefined?opt.def:this.playlists.length-1;return Math.min.apply(null,max)}function max_qid_by_customer(){var func=this.CG("cdn.method.max_bitrate_func"),pls=this.playlists;var max;if(typeof func!="function")return;try{max=func.apply(this)}catch(e){this.log.err("max_qid_func failed "+e.stack);return}if(!max)return;var i=pls.length-1;while(i>=0&&(pls[i].is_audio||pls[i].attributes.bandwidth>max))i--;return i<0?this.min_qid:i}function max_qid_by_bandwidth(bps){var i=this.playlists.length-1;while(i>=0&&(this.playlists[i].is_audio||(this.pl_info[i].est_ts_sz?this.pl_info[i].est_ts_sz*1.2>bps*this.dur:this.playlists[i].attributes.bandwidth*1.2>bps*8))){i--}return i<0?this.min_qid:i}function max_qid_by_resolution(res){var ext_res=res!==undefined;res=res||this.player.get_resolution("hap_resolution");if(!ext_res&&res&&res.width&&res.height&&(!this.res||res.width!=this.res.width||res.height!=this.res.height)){this.log.info("resolution changed to "+res.width+"x"+res.height);if(this.res)this.emit("resolution_change",res);this.res=res}return util.max_qid_by_resolution(this.playlists,res)}function reset_segments(stream){var segments=this.stream_info[stream.id].segments;for(var i in segments){if(!segments[i])continue;segments[i].completed=0;segments[i].final=false}}function get_index(name,qid){qid=qid!==undefined?qid:this.qid||0;return(this.pl_info[qid]&&this.pl_info[qid][name]!==undefined?this.pl_info[qid][name]:(this.pl_info.find(function(p){return p[name]!==undefined})||{})[name])||0}E.Method=function(opt){if(!(this instanceof E.Method))return new E.Method(opt);var _this=this;var player=this.player=opt.player,player_events=[];this.bws=opt.bws;this.bws.method=this;this.CG=this.bws.zone.CG.bind(this.bws.zone);this.CD=this.bws.zone.CD.bind(this.bws.zone);this.CE=this.bws.zone.CE.bind(this.bws.zone);this.CS=this.bws.zone.CS.bind(this.bws.zone);this.CMVP=this.bws.zone.CMVP.bind(this.bws.zone);this.log=log_from_zone(this.bws.zone);this.log.notice("using hola_adaptive");this.zperr=this.bws.zone.perr_get();this.hap=new E.hap({player:player,bws:this.bws});this.fallback_wrapper=this.bws.fallback_wrapper.bind(this);this.type="hola_adaptive";this.pl_info=[];this.stream_info={};this.ondata=this.fallback_wrapper(this._ondata,"ondata");this.set_quality=this.fallback_wrapper(set_quality,"set_quality");this.first_index=get_index.bind(this,"first_index");this.last_index=get_index.bind(this,"last_index");this.start_index=get_index.bind(this,"start_index");this.sec2offset=undefined;this.max_qid_by_resolution=this.fallback_wrapper(max_qid_by_resolution,"max_qid_by_resolution");this.max_qid_by_bandwidth=this.fallback_wrapper(max_qid_by_bandwidth,"max_qid_by_bandwidth");this.max_qid_by_customer=this.fallback_wrapper(max_qid_by_customer,"max_qid_by_customer");this.max_qid=this.fallback_wrapper(max_qid,"max_qid");if(this.CG("cdn.method.override_selection"))this.selection=this.CG("cdn.method.override_selection");if(this.CG("cdn.method.hold_play_start_quality")||!!this.selection)this.force_quality=true;this.alg={last_req_bw:{},up:0,down:0,jump_at:2,fall_at:2};if(this.hap.fetch_bin)this.fetch_bin=this.hap.fetch_bin.bind(this);this.reset_segments=reset_segments.bind(this);this.origins={};this.playlists=this.get_playlists();this._on=function(o,event,func){player_events.push({event:event,callback:func});_this.on("uninit",function(){o.off(event,func)});o.on(event,func)};this.CS("cdn.bwsaver.min_slice_sz",200*KB);this.CD("cdn.overload.if_not_loaded");this.CD("cdn.bwsaver.estimated_sec");if(this.CG("cdn.method.auto_load_keyframe_map"))this.CE("cdn.method.load_keyframe_map");if(!this.CG("cdn.bwsaver.disable_streaming")&&!this.CG("cdn.send_reqs.disable_serve_complete_ts")){this.CE("cdn.send_reqs.serve_complete_ts")}if(util.browser.browser=="safari"){this.CD("cdn.send_reqs.origin.disable");this.CE("cdn.send_reqs.origin.ranges_unsupported")}this.CMVP("cdn.method.use_keyframe_map");if(this.CG("cdn.method.use_keyframe_map")&&!zutil.is_mocha()&&!this.hap.is_smooth_streaming()){this.CD("cdn.method.use_keyframe_map")}this.CE("cdn.method.load_playlist_data");this.debug_keymap_switch=this.CG("cdn.method.debug_keyframe_map");this._on(this.bws,"req_start",function(req){_this.req_start.apply(_this,arguments);req.index=req.info.segment.index;req.name+=" qid "+req.info.segment.qid;_this.stream_info[req.stream.id].segments[req.index]=_this.stream_info[req.stream.id].segments[req.index]||{completed:0,"final":false}});this._on(this.bws,"stream_start",function(stream){var from,segments;if(_this.playlists&&_this.qid!==undefined){_this.set_quality(_this.qid,stream);if(segments=_this.playlists[_this.qid].segments)from=segments[0].media_index;if(!_this.is_live){_this.playlists.forEach(function(pl){var info=_this.pl_info[pl.level_idx]||{};if(info.inited&&info.start_index>stream.from)info.start_index=stream.from})}}_this.stream_info[stream.id]={segments:[]};var dm=_this.hap.dm,sc=util.get_hls_sc(dm);var idx=sc&&sc.fragCurrent&&sc.fragCurrent.sn;if(idx!==null&&idx!==undefined){if(!dm.hola_adaptive&&_this.hap.wait_attach){++idx;_this.log.info("start from segment "+idx+" on late attach")}if(stream.completed!=idx&&(!from||idx>=from)){_this.log.info("mismatch on stream start fragCurrent!="+"completed "+idx+"!="+stream.completed+" syncing");stream.set_completed(idx,"stream_start")}}});this._onmanifest_loaded=this.fallback_wrapper(this.onmanifest_loaded.bind(this));if(!this.CG("cdn.method.manifest_loader.disable")&&!util.is_safari){this.manifest_loader=new E.ManifestLoader({method:this,player:this.player})}if(this.playlists)this._onmanifest_loaded();else this.reload_pending_requests();this._on(player,"manifest_loaded",this._onmanifest_loaded);this._on(player,"dm_attached",this.fallback_wrapper(this.update_playlists,"dm_attached"));this._on(player,"level_updated",this.fallback_wrapper(this.update_playlists,"level_updated"));this._on(player,"quality_level",this.fallback_wrapper(function(){var manual_level=_this.hap.get_manual_level();if(manual_level>-1)_this.set_quality(manual_level,null,"quality_level")},"quality_level"));this._on(player,"seeking",this.fallback_wrapper(onseeking,"onseeking"));this._on(player,"detached",this.fallback_wrapper(ondetached,"ondetached"));this.bws.on("suspend",this.on_bws_suspend=function(){player_events.forEach(function(e){_this.player.off(e.event,e.callback)})});this.bws.on("continue",this.on_bws_continue=function(){player_events.forEach(function(e){_this.player.on(e.event,e.callback)})});this.on("uninit",function(){_this.bws.off("continue",this.on_bws_continue);_this.bws.off("suspend",this.on_bws_suspend);if(_this.manifest_loader)_this.manifest_loader.abort_all();_this.hap.destroy();player_events=[]});this.update_playlists()};util.assert_enabled(progressive,"progressive module is required but disabled");zutil.inherits(E.Method,progressive.Method);E.Method.prototype.onmanifest_loaded=function(){this.hap.emit("manifest_loaded");this.update_playlists();this.bws.streams.forEach(function(stream){if(stream.stopped)stream.resume()})};E.Method.prototype.reload_pending_requests=function(){var p_ldr=(this.hap.dm||{}).playlistLoader;if(p_ldr&&p_ldr.reloadCurrentRequests)p_ldr.reloadCurrentRequests()};E.Method.prototype.get_chunks_by_index_qid=function(stream,opt){var ret=stream.chunks.filter(function(c){return c.index==opt.idx&&c.qid==opt.qid});return ret&&opt.last?ret.splice(-1,1)[0]:ret};E.Method.prototype.set_params=function(req,opt){var s="",segment=req.info.segment;opt=opt||{};s+=util.set_param("index",segment.index);s+=util.set_param("dur",segment.dur);s+=util.set_param("id",segment.playlist_id);s+=util.set_param("stack","hap_hls");s+=util.set_url_param("playlist",opt.playlist||segment.playlist_url);s+=util.set_url_param("manifest",opt.manifest||req.stream.bws.url_s);return s};E.Method.prototype.frag_current=function(){var sc=util.get_hls_sc(this.hap.dm);return sc&&sc.fragCurrent&&sc.fragCurrent.sn};E.Method.prototype.merge_chunk=function(chunk){var _this=this,i,j;function merge_data(dst){if(dst.to+1<chunk.from||chunk.to<=dst.to)return;var data=dst.to+1>chunk.from?chunk.data.slice(dst.to+1-chunk.from):chunk.data;var ndata,total_len=data.byteLength+dst.to-dst.from+1;try{ndata=total_len>dst.data.byteLength?new Uint8Array(total_len):new Uint8Array(dst.data);if(total_len>dst.data.byteLength)ndata.set(new Uint8Array(dst.data),0);dst.data=ndata.buffer;ndata.set(new Uint8Array(data),dst.to-dst.from+1)}catch(e){var m=window.performance&&window.performance.memory||{};_this.log.info("state on error. total_len: %d, dst_len: %d, "+"chunk_len: %d, memory usage: jsHeapSizeLimit %d, "+"totalJSHeapSize %d, usedJSHeapSize %d",total_len,dst.data.byteLength,data.byteLength,m.jsHeapSizeLimit,m.totalJSHeapSize,m.usedJSHeapSize);chunk.req.stream.onerror(e,{fallback:1,reason:"hap_merge_data"})}var log=dst.req!=req?_this.log.info:_this.log.debug;log("merge "+dst.req.name+" "+dst.from+"-"+(dst.to+1)+" with "+req.name+" "+chunk.from+"-"+chunk.to+(data!=chunk.data?" slice data from "+(dst.to+1-chunk.from)+" len "+data.byteLength:""));dst.to=chunk.to;dst.req=req;dst.id=(req.info.segment?"-- "+req.info.segment.index+" -- ":"")+dst.from+"-"+chunk.to+" "+req.id+(req.info.segment?" qid "+req.info.segment.bitrate:"");dst.order+=";"+stream.chunks_order+","+chunk.to;dst.data.final=chunk.data.final}var req=chunk.req,stream=req.stream,chunks=stream.chunks;var km=req.info.keymap_split,c_merge;for(i=0;i<chunks.length&&(chunks[i].req.info.keymap_split!=km||!km||chunks[i]==chunk);i++);c_merge=chunks[i];for(i=0;!c_merge&&i<chunks.length&&(chunk.index!=chunks[i].index||chunk.qid!=chunks[i].qid);i++);c_merge=c_merge||chunks[i];for(i=0;i<chunks.length&&(chunk.index>chunks[i].index||chunk.index==chunks[i].index&&chunk.qid>chunks[i].qid||chunk.index==chunks[i].index&&chunk.qid==chunks[i].qid&&chunk.from>=chunks[i].from);i++);if(this.CG("cdn.send_reqs.serve_complete_ts")&&c_merge){if(!km)merge_data(c_merge);else{var log=this.debug_keymap_switch?this.log.console:this.log.info;if(chunk.qid==km.qid&&!c_merge.new_c)c_merge.new_c=chunk;else if(chunk.qid!=km.qid&&!c_merge.old_c)c_merge.old_c=chunk;else merge_data(chunk.qid==km.qid?c_merge.new_c:c_merge.old_c);if(c_merge.old_c&&c_merge.old_c.data.byteLength==km.old_seg.offset&&c_merge.new_c&&(c_merge.new_c.data.final||c_merge.new_c.to==c_merge.new_c.req.to)){c_merge.data=new Uint8Array(c_merge.old_c.data.byteLength+c_merge.new_c.data.byteLength);c_merge.data.set(new Uint8Array(c_merge.old_c.data));c_merge.data.set(new Uint8Array(c_merge.new_c.data),c_merge.old_c.data.byteLength);c_merge.data=c_merge.data.buffer;c_merge.data.keymaps={old_map:assign({},this.pl_info[km.old_qid].keymap[c_merge.index]),new_map:assign({},this.pl_info[km.qid].keymap[c_merge.index])};c_merge.from=c_merge.old_c.req.info.segment.from||0;c_merge.to=c_merge.from+c_merge.data.byteLength-1;c_merge.data.final=true;km.done=true;log("keymap quality switch chunk download complete "+c_merge.from+"-"+c_merge.to)}}stream.chunks_order++;chunk.req.served+=chunk.data.byteLength;return}if(this.CG("cdn.send_reqs.serve_complete_ts")){for(j=0;j<chunks.length&&(chunks[j].index!=chunk.index||chunks[j].qid!=chunk.qid);j++);if(j<chunks.length){this.bws.emit("unittest_progress","add_chunk");chunks.forEach(function(c){_this.log.info("-- "+c.id+" "+c.order)});this.log.info("ERR - found another chunk of same index "+chunks[j].id+" inserting chunk "+chunk.id);chunks[j].req.stream.onerror("invalid chunk list",{fallback:1,reason:"invalid_chunk_list"})}}chunk.order=stream.chunks_order+","+chunk.to;req.served+=chunk.data.byteLength;if(km){chunk={from:0,to:0,old_c:km.old_qid==chunk.qid&&chunk,new_c:km.qid==chunk.qid&&chunk,data:new Uint8Array(0).buffer,index:chunk.index,qid:km.qid,req:km.req||km.old_req};this.log.info("created keymap quality switch chunk old: "+(chunk.old_c?chunk.old_c.from+"-"+chunk.old_c.to:"none")+" new: "+(chunk.new_c?chunk.new_c.from+"-"+chunk.new_c.to:"none")+" req "+km.req.id)}stream.chunks_order++;chunks.splice(i,0,chunk);return chunk};E.Method.prototype.process_keymap=function(level,keymap){if(!keymap.frags||this.pl_info[level].keymap)return;this.pl_info[level].keymap=keymap.frags;if(!this.is_live)this.bws.streams.forEach(function(s){this.send_reqs(s)},this)};E.Method.prototype.set_slice_by_req=function(req,caller){if(req.error||req.info.rate)return;var segment=req.info.segment,qid=segment.qid;var info=this.pl_info[qid];info.sz=Math.round((info.sz*info.w+req.size())/(info.w+1));info.sec=Math.round((info.sec*info.w+req.to_sec())/(info.w+1));info.w++;req.stream.set_slice_size(info.sz,info.sec,caller)};E.Method.prototype.get_pos=function(){var pos=this.player.get_pos();if(!pos&&this.is_live)pos=this.hap.get_live_pos();return pos};E.Method.prototype.sec_until_offset=function(i){var cur=this.frag_current(),pos=this.get_pos();var buf=this.bws.sec_in_buffer(pos,true,this.hap.dm.config.maxBufferHole)||0;return buf+(cur!==undefined?Math.max((i-cur)*this.dur,Math.ceil(this.dur/2)):this.dur)};E.Method.prototype.offset2sec=function(stream,offset){return offset*this.dur};E.Method.prototype.next_slice_fixup=function(stream,range,sec){if(!sec)return;range.to=range.from;range.cache_id=this.cache_id;range.qid=this.qid;if(this.is_live&&this.pl_info[this.qid].first_index>range.from){this.bws.fallback("index_mismatch","mismatch live index need "+range.from+" but manifest starts with "+this.playlists[this.qid].segments[0].media_index)}var s="next slice idx "+range.from+" needed sec "+sec;if(s!=this.next_slice_s)this.log.info("next slice idx "+range.from+" needed sec "+sec);this.next_slice_s=s};E.Method.prototype.obtained_sec=function(stream){if(!stream)return 0;var completed=stream.completed,sec=0;for(var i=0;i<stream.chunks.length;i++){var chunk=stream.chunks[i],idx=chunk.req.info.segment.index;if(idx<completed)continue;if(idx>completed)break;sec+=chunk.data.final?+chunk.req.info.segment.dur:0;if(chunk.data.final)completed=idx+1}return sec};E.Method.prototype.need_chunk=function(chunk){var req=chunk.req,idx=req.info.segment.index;var to=chunk.to-(req.info.segment.from||0);var last=this.get_chunks_by_index_qid(req.stream,{idx:chunk.index,qid:chunk.qid,last:true});return!req.info.rate&&idx>=req.stream.completed&&(!last||to>last.to)};E.Method.prototype.is_next_chunk=function(chunk){if(this.CG("cdn.send_reqs.serve_complete_ts")&&!chunk.req.xhr.success&&!chunk.data.final){return false}var req=chunk.req,idx=req.info.segment.index;var km=req.info.keymap_split;var other=req.info.overloaded||req.info.clone;var from=chunk.from-(req.info.segment.from||0);var to=chunk.to-(req.info.segment.from||0);var ret=idx==req.stream.completed&&(!km||chunk.data.final)&&from<=this.stream_info[req.stream.id].segments[idx].completed&&to>=this.stream_info[req.stream.id].segments[idx].completed&&!this.hap.is_buffer_delayed(chunk)&&(!other||req.info.segment.qid==other.info.segment.qid||!req.opt.streaming&&!other.opt.streaming||req.loaded>=Math.min(128*KB,req.size())||chunk.data.final);if(ret&&other&&req.info.segment.qid!=other.info.segment.qid&&(req.opt.streaming||other.opt.streaming)){other.abort("is_next_chunk");req.info.was_cloned=req.info.was_overloaded=undefined}return ret};E.Method.prototype.set_chunk_data=function(chunk){if(this.bws.tech=="flash"||!chunk.req.opt.streaming)return;var req=chunk.req,idx=req.info.segment.index;var from=req.info.segment.from||0,final=chunk.data.final;var segments=this.stream_info[req.stream.id].segments;if(chunk.from-from>=segments[idx].completed)return;chunk.data=chunk.data.slice(segments[idx].completed+from-chunk.from);chunk.from=segments[idx].completed+from;chunk.data.final=final;chunk.id="-- "+(this.ranged_playlist?req.from+"-"+req.to:req.info.segment.index)+" -- "+chunk.from+"-"+chunk.to+"/"+req.to+" "+req.id+" qid "+req.info.segment.bitrate};E.Method.prototype.cacheid2qid=function(id){var pl=this.playlists.find(function(p){return p.cache_id==id||p.bitrate==id});return this.playlists.indexOf(pl)};E.Method.prototype.on_parallel_req=function(stream,p){var info,cache=p.info.cache_backup,qid,req=p.req;var remaining=req.remaining();var left=req.opt.streaming?remaining.bytes:req.to>-1?req.to+1:this.pl_info[req.info.segment.qid].est_ts_sz;var fs=req.to>-1&&(!req.hrange&&!req.opt.headers.Range||req.info.segment.second_slice)?req.to+1:0;var ratio=fs?fs/this.pl_info[req.info.segment.qid].est_ts_sz:1;if(cache&&(qid=this.cacheid2qid(cache.cache_id))>-1&&(!req.loaded||!req.opt.streaming||this.CG("cdn.send_reqs.serve_complete_ts")&&left>this.pl_info[qid].est_ts_sz*ratio)){if(info=this.prepare_info_req(cache.cdn,p.info.segment.index,null,qid)){var last=this.get_chunks_by_index_qid(stream,{idx:p.info.segment.index,qid:qid,last:true});p.range.cache_id=cache.cache_id;p.range.from=last?last.to+1:0;p.range.to=last?last.req.to:-1;p.from_cache=true}}else if(this.CG("cdn.method.parallel_with_lower_qid")&&p.info.segment.qid&&(!req.loaded||!req.opt.streaming||this.CG("cdn.send_reqs.serve_complete_ts"))&&this.bws.fastest_policy()){qid=p.info.segment.qid;var i=qid-1;while(i>=0&&(this.playlists[i].is_audio||this.pl_info[i].last_index!=this.pl_info[qid].last_index||left<=this.pl_info[i].est_ts_sz*ratio*1.1)){i--}if(i>-1){var bps=p.cdn.bps()||req.bps();var bps_qid=bps?this.max_qid({bps:bps}):Math.floor(this.qid/2);info=this.prepare_info_req(req.cdn,p.info.segment.index,null,Math.max(Math.min(this.qid,i,bps_qid),this.min_qid));if(info){p.range.from=0;p.range.to=-1}}}p.info=info||p.info};E.Method.prototype.set_req_alg=function(req){if(req.info.rate||req.cdn.is_fast()||req.info.from_cache)return;if(req.error&&!req.info.live_sliding||this.CG("cdn.req_alg.disable"))return;var ms=req.to_ms(),too_slow,qid;if(req.info.live_sliding||req.info.bitrate&&ms&&ms+500<req.ms+req.ms_hdrs){req.emit("too_slow",req);too_slow=true}var idx=req.info.segment.index+1;var ops={allow_fast:this.fast_allowed_range(req.stream,{from:idx,to:idx,index:idx,segment:req.info.segment,qid:req.info.segment.qid}),sz:req.stream.slice,sec:req.stream.slice_sec};var bps=this.bws.cdns.get_best_cdn_bw(assign(ops,{no_cache:true}))||this.bws.cdns.get_best_cdn_bw(ops);qid=this.max_qid({bps:too_slow?req.cdn.is_bw_from_cache()?req.bps():req.cdn.bps():bps});this.set_quality(qid,req.stream,"set_req_alg")};E.Method.prototype.close_obtained_reqs=function(stream){for(var i=0;i<stream.reqs.length;i++){var req=stream.reqs[i],idx=req.info.segment.index;if(!req.closed&&!req.info.rate&&!stream.map.next_unobtained(idx,idx)){this.log.debug("closing obtained "+req.name);req.abort("close obtained");i--}}};E.Method.prototype.oncomplete_req=function(req){var stream=req.stream,set_final,km=req.info.keymap_split;array.rm_elm(stream.reqs,req);if(!req.error&&!req.info.rate){if(!req.set_final&&!km){var i=stream.chunks.length-1;while(i>=0&&stream.chunks[i].req.info.segment!=req.info.segment)i--;if(i<0&&req.info.segment.qid==this.qid&&req.info.segment.index==this.frag_current()){this.hap.oncomplete_req(req);set_final=true}else if(i>-1){stream.chunks[i].data.final=true;set_final=true}req.set_final=true}if(!km||km.done)stream.map.update(req.index,req.index);this.log.debug("map updated "+req.index+"-"+req.index+" "+JSON.stringify(stream.map.ranges));this.close_obtained_reqs(stream);this.log.info(stream.name+" completed "+stream.completed);if(req.to>-1&&!km){this.pl_info[req.info.segment.qid].est_ts_sz=(this.pl_info[req.info.segment.qid].est_ts_sz+req.to+1)/2}}if(!req.info.rate)this.emit("seg_complete",req);if(!km){this.set_slice_by_req(req,"oncomplete_req");this.set_req_alg(req)}if(set_final)stream.serve();if(km){var sinfo=this.stream_info[stream.id];km.old_req=km.old_qid==req.info.segment.qid?undefined:km.old_req;km.req=km.qid==req.info.segment.qid?undefined:km.req;if(req.error&&(req.error!=ERR.aborted||req.abort_caller=="progress_monitor")){var other;if(req.info.was_overloaded&&(other=this.stream.get_req_by_id(req.info.was_overloaded))){km.old_req=km.old_qid==req.info.segment.qid?other:km.old_req;km.req=km.qid==req.info.segment.qid?other:km.req;other.info.keymap_split=km;this.log.info("keymap quality switch failed request "+req.name+" replaced with overloaded req "+other.name)}else{var fs=req.size();var sz=req.remaining().bytes;var sec=Math.max((req.to_sec()||req.stream.slice_sec)-req.elapsed()/date.ms.SEC,1);var best_cdn=this.bws.cdns.get_best_cdn("oncomplete_req",{allow_fast:this.bws.method.fast_allowed_range(req.stream,{from:req.progress,to:req.to,index:req.info.segment.index,segment:req.info.segment,qid:req.info.segment.qid}),sz:sz,fs:fs,sec:sec,ranges_supported:true});best_cdn=best_cdn||req.cdn.is_usable()&&req.cdn;if(best_cdn){var range=req.info.segment.qid==km.qid?km.range:km.old_range;var r=req.stream.req(best_cdn,req.progress,range.to,{segment:req.info.segment,keymap_split:km,cache_id:req.info.cache_id});km.old_req=km.old_qid==req.info.segment.qid?r:km.old_req;km.req=km.qid==req.info.segment.qid?r:km.req;this.log.info("keymap quality switch failed request "+req.name+" replaced with new req "+r.name)}else{this.log.info("keymap quality switch failed request "+req.name+" could not be replaced aborting"+" transition");(km.req||km.old_req).abort("oncomplete_req");km.done=true}}}if(km.done&&sinfo.transition){sinfo.transition.km=undefined;sinfo.transition=undefined}}if(req.error!=ERR.aborted||req.abort_caller=="progress_monitor")stream.send_reqs()};E.Method.prototype.send_reqs=function(stream){if(stream.stopped||!this.playlists||this.qid===undefined||!this.playlists[this.qid].segments&&!this.is_live){return}var ns=E.Method.super_.prototype.next_slice.call(this,stream);if(ns&&this.force_quality){var ix=ns.from-(this.is_live?0:this.first_index()),new_qid;if(this.CG("cdn.method.hold_play_start_quality")){if(this.player.is_playing()){this.force_quality=!!this.selection;delete this.start_qid}new_qid=this.start_qid}if(this.selection)new_qid=this.selection[ix];if(new_qid!==undefined&&new_qid!=this.qid){this.log.info("override quality selection - choose qid "+new_qid+" for index "+ns.from);return this.set_quality(new_qid,stream,"send_reqs")}}E.Method.super_.prototype.send_reqs.call(this,stream)};E.Method.prototype.uninit=function(){this.emit("uninit");E.Method.super_.prototype.uninit.call(this)};E.Method.prototype.get_index=function(playlist,pos,seek){if(!playlist)return;if(playlist.level_idx!==undefined){var index=this.hap.get_index(playlist,pos,seek);if(index!==undefined)return index}var i=0,segs=playlist.segments;for(var sec=0;i<segs.length&&sec+ +segs[i].duration<pos;i++)sec+=+segs[i].duration;return i<segs.length?segs[i].media_index:segs[segs.length-1].media_index};E.Method.prototype.get_playlists=function(){var playlists=this.player.get_playlists();if(!playlists)return playlists;var has_res_n=0,no_res_n=0;for(var i=0;i<playlists.length;i++){var pl=playlists[i];if(pl.attributes&&pl.attributes.bandwidth<=64e3||pl.attributes.audio&&!pl.attributes.video){pl.is_audio=true;this.zperr({id:"hap_debug_low_bitrate_64k",throttle:1})}else if(this.min_qid===undefined)this.min_qid=i;if(pl.attributes&&pl.attributes.resolution)has_res_n++;else if(!pl.attributes||!pl.attributes.resolution)no_res_n++}if(this.min_qid===undefined)this.min_qid=0;if(has_res_n&&no_res_n)this.zperr({id:"hap_debug_mixed_resolution",throttle:1});return playlists};E.Method.prototype.init_playlist=function(pl,new_qid){var segments=pl.segments;this.is_live=this.player.is_live_stream();this.pl_info[pl.level_idx]=this.pl_info[pl.level_idx]||{w:0};if(!segments||this.pl_info[pl.level_idx].inited&&!this.is_live)return;var segment=segments[0];var info=this.pl_info[pl.level_idx];if(!info.sz)info.sz=segment.duration*(pl.bitrate||segment.bitrate)/8||1e3*KB;if(!info.sec)info.sec=segment.duration;var pos=this.get_pos(),cur=this.frag_current();info.first_index=segments[0].media_index;info.last_index=segments[segments.length-1].media_index;info.qid=pl.level_idx;var is_cur_level=info.qid==new_qid||info.qid==this.qid||info.qid==this.wait_level;info.start_index=zutil.is_mocha()?pl.start_index||info.first_index:is_cur_level&&this.hap.is_loading_frag(cur)&&cur>=info.first_index?cur:this.get_index(pl,pos+this.bws.sec_in_buffer(pos,true,0));info.est_ts_sz=info.est_ts_sz||(pl.bitrate?pl.bitrate/8*(pl.segments&&pl.segments.length?pl.segments[0].duration:10):500*1024);info.cache_id=pl.playlist_id||pl.bitrate||"q"+pl.level_idx;pl.cache_id=info.cache_id;if(is_cur_level&&this.is_live){this.bws.streams.forEach(function(stream){stream.set_completed(Math.max(stream.completed>info.last_index?info.start_index:stream.completed||0,info.start_index),"update_playlist")},this)}info.inited=this.hap.dm.hola_adaptive};E.Method.prototype.get_cdns=function(segment_url){if(this.cdns_selected)return;var ret;if(ret=cdnlist.local_url2cdns(this.bws.zone,cdnlist.all_agents,util.geoip,this.bws.url.orig,Object.assign(util.get_url_frame(),{user_agent:navigator&&navigator.userAgent,segment_url:segment_url}))){this.bws.extra_singles=ret.extra||[];this.bws.set_single_copy_cdn(ret.single,"hola_adaptive");this.cdns_selected=true;this.bws.emit("local_get_cdns",ret.single,"single_copy")}if(this.bws.cdns.hola_usable())this.bws.do_streams(null,"send_reqs")};E.Method.prototype.update_playlists=function(level){var playlist,segments,new_qid,_this=this,prev=this.playlists;this.playlists=this.get_playlists();if(!this.playlists||!this.playlists.length)return;if(playlist=this.playlists[level])segments=playlist.segments;if(this.qid===undefined){new_qid=this.bws.opt.start_quality||this.CG("cdn.method.start_quality");if(new_qid===undefined)new_qid=this.max_qid({def:this.min_qid});if(level===undefined)level=new_qid;this.start_qid=new_qid}else if(this.is_live&&prev&&level==this.qid&&prev[level]&&playlist&&segments&&(prev=prev[level].segments)&&segments.length==prev.length&&segments[0].media_index==prev[0].media_index){return this.log.info("ignore same live playlist, level "+level)}this.playlists.forEach(function(pl){_this.init_playlist(pl,new_qid)});var info=this.pl_info[level];if(playlist=this.playlists[level])segments=playlist.segments;if(!playlist||!segments){this.emit("update_playlists");if(new_qid!==undefined)this.set_quality(new_qid,null,"update_playlists");return}this.get_cdns(segments[0].url);
this.dur=+segments[0].dur||+segments[0].duration;this.last_updated_qid=level;this.ranged_playlist=segments[0].from!==undefined;this.bws.from=info.start_index;this.bws.to=this.is_live?-1:info.last_index;this.emit("update_playlists",level);this.log.info("update new playlist "+(this.bws.unittest?this.bws.unittest.playlist:""));if(level!==undefined&&(level==this.wait_level||new_qid!==undefined)){this.set_quality(new_qid!==undefined?new_qid:level,null,"update_playlists",true)}if(!this.is_live||level==this.qid)this.bws.streams.forEach(function(s){this.send_reqs(s)},this)};E.Method.prototype.set_fullsize=function(){};E.Method.prototype._set_fullsize=function(stream,fullsize,force){if(this.is_live)return;E.Method.super_.prototype.set_fullsize.call(this,stream,fullsize,force)};E.Method.prototype.next_unassigned=function(stream,from,to){return this.next_missing(stream.reqs,stream.fullsize,from,to,function(r){return r.info.rate})};E.Method.prototype.next_unobtained=function(stream,from,to){return this.next_missing(stream.chunks,stream.fullsize,from,to,function(c){return!c.data.final})};E.Method.prototype.next_missing=function(arr,fullsize,from,to,skip){var i=0,p_lst=this.playlists&&this.playlists[this.qid];if(fullsize>0)to=to>=0?Math.min(to,fullsize-1):fullsize-1;if(p_lst&&p_lst.attributes.live)to=Math.min(to,p_lst.segments[p_lst.segments.length-1].media_index);for(;i<arr.length&&(to<0||from<=to);i++){var r=arr[i].req||arr[i];if(r.error||r.index<from||skip&&skip(arr[i]))continue;else if(from<r.index)break;else from=to<0?r.index+1:Math.min(r.index+1,to+1)}return to>=0&&from>to?null:{from:from,to:i==arr.length?to:to<0?arr[i].index-1:Math.min(to,arr[i].index-1)}};E.Method.prototype.req=function(stream,cdn,idx,_to,info){var early=info.early_of?stream.get_req_by_id(info.early_of):null;var qid=info&&info.cache_id&&this.cacheid2qid(info.cache_id)>-1?this.cacheid2qid(info.cache_id):this.qid;var from=0,to=-1;if(early&&this.CG("cdn.method.use_other_qids_in_early_req")&&(early.info.clone||early.info.was_cloned)&&early.info.segment.qid<this.qid){qid=Math.min(this.qid,Math.max(early.info.segment.qid,this.max_qid({bps:early.bps()})))}if(!(info=this.prepare_info_req(cdn,idx,info,qid)))return null;if(info.rate)return stream.req(cdn,0,-1,info);var sinfo=this.stream_info[stream.id];if(this.CG("cdn.method.use_keyframe_map")&&sinfo.transition&&!sinfo.transition.km){var km,info2=info,failed;var log=this.debug_keymap_switch?this.log.console:this.log.info;if((km=this.get_keymap_info(cdn,idx,info,sinfo.transition))&&!km.aligned){info2=zutil.clone_deep(info);info.segment.from_offset=km.seg.offset;info2=this.prepare_info_req(cdn,idx,info2,km.old_qid);info2.segment.to_offset=km.old_seg.offset-1;sinfo.transition.km=info2.keymap_split=info.keymap_split=km;info.allow_finish=info2.allow_finish=true;this.emit("keymap_info",km);km.range={from:(info.segment.from||0)+info.segment.from_offset,to:info.segment.to||-1};km.old_range={from:info2.segment.from||0,to:(info2.segment.from||0)+info2.segment.to_offset};km.old_req=stream.req(cdn,km.old_range.from,km.old_range.to,info2);km.log.push(km.old_req.name);km.req=stream.req(cdn,km.range.from,km.range.to,info);km.log.push(km.req.name);log("create keymap switch old "+km.old_req.name+" new "+km.req.name+" info old_seg "+JSON.stringify(km.old_seg)+" seg "+JSON.stringify(km.seg));return}for(var i=idx+1;!km&&!sinfo.transition.at_idx&&i<=stream.to&&i<=idx+3;i++){if(this.get_keymap_info(cdn,i,info,sinfo.transition))sinfo.transition.at_idx=i}if(km){log("keyframe is aligned, loading full");failed=true}else if(!sinfo.transition.at_idx){log("could not find location for transition "+JSON.stringify(sinfo.transition)+" at idx "+(idx+1));failed=true}else if(sinfo.transition.at_idx==idx){log("could not transition at index "+idx+" in transition "+JSON.stringify(sinfo.transition));failed=true}else if(!(info=this.prepare_info_req(cdn,idx,info,sinfo.transition.old_qid))){log("could not create info with old qid in transition "+JSON.stringify(sinfo.transition));info=info2;failed=true}if(failed)sinfo.transition=undefined}if(!cdn.using(this.bws.zone).is_ranges_unsupported()){var chunk=stream.chunks.find(function(c){return c.index==idx&&c.qid==qid});from=chunk?chunk.to+1:from;to=chunk?chunk.req.to:to}return stream.req(cdn,info.segment.from||from,info.segment.to||to,info)};E.Method.prototype.get_keymap_info=function(cdn,idx,info,transition){if(info.rate||info.no_ranges||!this.CG("cdn.method.use_keyframe_map"))return;if(zutil.is_mocha()&&util.jtest.keymap_info&&util.jtest.keymap_info[idx]){return assign({log:[]},util.jtest.keymap_info[idx])}var old_qid=transition.old_qid,qid=transition.qid;var new_seg_rng,old_seg_rng;var old_pl=this.playlists&&this.playlists[old_qid];var old_keymap=this.pl_info[old_qid]&&this.pl_info[old_qid].keymap&&this.pl_info[old_qid].keymap[idx];var new_keymap=this.pl_info[qid]&&this.pl_info[qid].keymap&&this.pl_info[qid].keymap[idx];function get_best_fit(keymap,target,first){var offset=0,current=Infinity,sn;["idr","sei","indr"].forEach(function(type){for(var i=0;(!offset||!first)&&i<keymap[type].length;i++){sn=keymap[type][i].sn;if(sn<target||sn>=current)continue;current=sn;offset=keymap[type][i].offset;break}});return{sn:current,offset:offset}}if(old_keymap&&new_keymap&&old_pl&&old_pl.segments&&old_pl.segments["media_index_"+idx]){new_seg_rng=get_best_fit(new_keymap,0,true);if(new_seg_rng.sn)old_seg_rng=get_best_fit(old_keymap,new_seg_rng.sn);else return{aligned:true}}return old_seg_rng?{old_seg:old_seg_rng,seg:new_seg_rng,old_qid:old_qid,qid:qid,log:[]}:null};E.Method.prototype.prepare_info_req=function(cdn,idx,info,qid){qid=qid===undefined?info&&info.cache_id&&this.cacheid2qid(info.cache_id)>-1?this.cacheid2qid(info.cache_id):this.qid:qid;if((!info||!info.rate)&&(!this.playlists||qid===undefined||!this.playlists[qid].segments)){return void this.log.debug("no info for qid "+qid+" seg "+this.playlists[qid].segments)}info=info||{};var sc=util.get_hls_sc(this.hap.dm);if(info.rate){if(this.is_live&&sc&&sc.state=="STOPPED")return void this.log.debug("sc STOPPED state");idx=this.is_live?this.last_index(qid):this.first_index(qid)}var segment=this.playlists?this.playlists[qid||0].segments["media_index_"+idx]:this.player.get_current_fragment();if(!segment||typeof segment!="object")return void this.log.debug("no segments for qid "+qid+" idx "+idx);segment=info.segment=zutil.clone_deep(segment);info.cache_id=this.pl_info[qid].cache_id;info.cached_bw=!cdn.prev_bpms;info.no_range=cdn.using(this.bws.zone).is_ranges_unsupported();segment.bps=segment.bitrate/8;segment.index=segment.index||segment.media_index;segment.playlist_id=info.cache_id;segment.qid=qid;segment.dur=info.rate?0:segment.dur||segment.duration;segment.est_sz=segment.dur*segment.bps;segment.streaming=this.CG("cdn.send_reqs.serve_complete_ts")||!!this.CG("cdn.send_reqs.enable_streaming");var u=zurl.parse(segment.url),host=u.hostname,bws=this.bws;this.origins[host]=this.origins[host]||bws.origin_select(u).hostname;if(host!=this.origins[host]){u.hostname=this.origins[host];segment.url=zurl.uri_obj_href(u);bws.add_origin_url(segment.url,"req")}else if(!bws.cdns.has(host)){bws.add_origin_url(segment.url,"req");this.zperr({id:"hola_adaptive_playlist_origin_mismatch",info:{playlist:this.playlists[qid].url,segment:segment.url}})}segment.hostname=u.hostname;return info};E.Method.prototype.cache_set=function(req){if(req.info.rate||req.info.keymap_split)return;if(!req.info.cache_id)return this.log.info("missing cache id for req "+req.id);this.bws.cache.set({id:req.info.cache_id,host:req.cdn.host,path:req.cache_path,from:req.info.segment.index,to:req.info.segment.index,cache_date:req.resp.hdrs.date,info:{max_age:zcache.is_cachable(req.resp.hdrs),vary:req.vary_hdr,data_prefix:req.hola_resp.data_prefix,from:req.info.segment.from,to:req.info.segment.to}});if(this.is_live){this.bws.cache.unset({to:this.start_index(req.info.segment.qid)-1,id:req.info.segment.playlist_id})}};E.Method.prototype.serve=function(chunk){var req=chunk.req,seg=req.info.segment,stream=req.stream;if(!req.xhr.total){this.zperr({id:"hap_xhr_total_error",info:{total:req.xhr.total,state:req.xhr.readyState,loaded:req.xhr.loaded},throttle:1})}if(this.CG("util.log.chunk_hash")){this.log.info("chunk size "+chunk.data.byteLength+" index "+seg.index+" qid "+seg.qid+" checksum "+util.fnv1a(chunk.data))}this.hap.append_buffer(chunk);this.bws.stats.served+=chunk.data.byteLength;if(chunk.data.final&&stream.completed==seg.index)stream.completed++;this.stream_info[stream.id].segments[seg.index].completed+=chunk.data.byteLength;this.log.info("served chunk "+chunk.id+" sz "+chunk.data.byteLength);if(this.debug_keymap_switch&&chunk.req.info.keymap_split)this.log.console("serving chunk "+chunk.id);this.bws.emit("serve",chunk.data,chunk)};E.Method.prototype.load_playlist_data=function(){if(!this.CG("cdn.method.load_playlist_data"))return;var _this=this,manifest_loader=this.manifest_loader;var use_keymap=this.CG("cdn.method.use_keyframe_map");function load_qid(qid){var pl=_this.playlists[qid],info=_this.pl_info[qid]||{};if((pl.segments||info.resp_ready)&&(!use_keymap||info.keymap))return true;manifest_loader.load({url:pl.url,id:info.cache_id===undefined?pl.bitrate:info.cache_id,internal:true,playlist_loader:true,level:qid})}function get_qid(qid){for(var i=qid;i>=0;i--){if(!_this.playlists[i].segments&&!_this.pl_info[i].resp_ready||use_keymap&&!_this.pl_info[i].keymap){return i}}}if(!manifest_loader||!this.playlists||this.playlists_loaded||manifest_loader.is_loading()||this.bws.buf_sec_total()<5){return}var fs_qid=this.max_qid({res:window&&window.screen||{},def:this.playlists.length-1});var res=this.player.get_resolution("load_playlist_data"),qid;var win_qid=res&&this.max_qid({res:res,def:this.qid})||this.qid;if(load_qid(this.qid)&&load_qid(Math.floor(win_qid/2))&&(!res||res.width<=300&&res.height<=300||load_qid(fs_qid))&&load_qid(0)&&(!(qid=get_qid(win_qid))||load_qid(qid))&&load_qid(fs_qid)){this.playlists_loaded=true}};E.Method.prototype._ondata=function(chunk){if(!chunk.data)return this.log.debug("ondata error: missing data chunk "+chunk.id);this.serve(chunk);this.bws.track_state("hola hls ondata");this.load_playlist_data()};E.Method.prototype.cache_get=function(stream,range){if(!this.bws.cache||this.CG("cdn.cache.disabled"))return;var opts=this.bws.cache.next_immediate({from:range.from,to:range.to,all:true})||[];var chosen,_this=this,str=isNaN(range.cache_id);var req_id=str?range.cache_id:+range.cache_id;var force_equal=!this.CG("cdn.method.use_other_qids_in_cache");opts.forEach(function(o){if(str&&o.id==req_id&&!chosen)chosen=o;else if(!str&&(force_equal?o.id==req_id:o.id>=req_id)&&_this.cacheid2qid(o.id)>-1&&(!chosen||o.id<chosen.id)){chosen=o}});var backup;opts.forEach(function(o){o.dst=str?0:Math.abs(_this.cacheid2qid(o.id)-_this.cacheid2qid(req_id));if(force_equal&&!backup&&o.id==req_id&&(!chosen||o.cdn!=chosen.cdn)){backup=o}else if(!force_equal&&(!chosen||o.id!=chosen.id||o.cdn!=chosen.cdn)&&(!backup||o.dst<backup.dst||!str&&o.dst==backup.dst&&o.id>backup.id)){backup=o}});if(backup&&!chosen){range.cache_backup=stream.choose_cache_source(opts.filter(function(o){return o.id==backup.id}));if(range.cache_backup)range.cache_backup.cache_id=backup.id}if(!chosen)return;var ret=stream.choose_cache_source(opts.filter(function(o){return o.id==chosen.id}));if(backup){range.cache_backup=stream.choose_cache_source(opts.filter(function(o){return o.id==backup.id&&ret.cdn.host!=o.cdn}));if(range.cache_backup)range.cache_backup.cache_id=backup.id}if(ret)ret.cache_id=chosen.id;return ret};E.Method.prototype.fast_allowed_range=function(stream,range){var from=range.index!==undefined?range.index:range.from;var sec_limit=this.CG("cdn.send_reqs.fast.sec_limit")||10;var fast_index=this.CG("cdn.send_reqs.fast.ts_limit")||this.first_index(range.qid)+Math.max(1,Math.ceil(sec_limit/this.dur));return!this.is_live&&from<fast_index};E.hap=function(opt){if(!(this instanceof E.hap))return new E.hap(opt);var player=this.player=opt.player,dm=this.dm=get_dm(player);this.log=log_from_zone(player.zone);this.log.info("hls.js version "+(dm&&dm.constructor.version));var bws=this.bws=opt.bws;this.CG=this.bws.zone.CG.bind(this.bws.zone);this.zperr=this.bws.zone.perr_get();this.fallback_wrapper=this.bws.fallback_wrapper.bind(this);this.frag_stats_hnd=this.frag_stats.bind(this);this.keymap_info={};this.attach_dm=this.fallback_wrapper(this._attach_dm,"attach_dm");this.detach_dm=this.fallback_wrapper(this._detach_dm,"detach_dm");this.on("manifest_loaded",function(){var sc=util.get_hls_sc(dm);if(sc&&(!sc.state||sc.state=="STOPPED"))dm.startLoad();sc.fragBitrateTest=false});if(zutil.is_mocha())return;this.attach_dm(dm);this.onbwscontinue=this.fallback_wrapper(this._onbwscontinue,"on_bws_continue");this.onbwsuninit=this.fallback_wrapper(this._onbwsuninit,"on_bws_uninit");bws.on("continue",this.onbwscontinue);bws.on("uninit",this.onbwsuninit)};zutil.inherits(E.hap,events);E.hap.prototype._attach_dm=function(dm){function attach(pos){if(pos!==undefined)dm.stopLoad();_this.log.info("attach dm");dm.hola_adaptive=true;dm.fragmentLoader.prev_onFragLoading=dm.fragmentLoader.onFragLoading;dm.abrController.prev_clearTimer=dm.abrController.clearTimer;dm.abrController.prev_clearTimer();dm.fragmentLoader.onFragLoading=function(o){setTimeout(_this.frag_loading.bind(_this),0,o)};dm.abrController.clearTimer=function(){};dm.abrController.timer=1;dm.levelController.manualLevel=_this.initial_load_level=dm.loadLevel===undefined?-1:dm.loadLevel;var config=dm.config;dm.saved_config=zutil.clone_deep(dm.config);if(dm.constructor.Events.FRAG_STATISTICS)dm.on(dm.constructor.Events.FRAG_STATISTICS,_this.frag_stats_hnd);config.maxBufferHole=_this.CG("cdn.hap.max_buffer_hole")||.5;config.maxBufferLength=_this.bws.low_watermark_sec;config.maxMaxBufferLength=_this.bws.low_watermark_sec;config.maxBufferSize=_this.CG("cdn.hap.max_buffer_size")||6e7;config.fragLoadingTimeOut=_this.CG("cdn.hap.frag_loading_timeout")||6e4;config.fragLoadingMaxRetry=_this.CG("cdn.hap.frag_loading_retries")||6;config.manifestLoadingTimeOut=_this.CG("cdn.hap.manifest_load_timeout")||2e4;config.manifestLoadingMaxRetry=_this.CG("cdn.hap.max_manifest_load_retry")||4;assign(config,_this.CG("cdn.hap.hls_config"));if(pos!==undefined){var loaded_meta=sc&&sc.loadedmetadata;dm.startLoad(pos);if(loaded_meta)sc.loadedmetadata=loaded_meta;_this.player.emit("dm_attached")}}function do_attach(name,cb,val){cb.forEach(function(f){var prev="prev_"+f;if(sc[prev]){sc[f]=sc[prev];delete sc[prev]}});sc[name](val);_this.player.refresh_buffered();_this.wait_attach=false;attach(_this.player.get_pos())}var _this=this,sc=util.get_hls_sc(dm);var too_late=["FRAG_LOADING","FRAG_LOADING_WAITING_RETRY","PARSING","PARSED"];if(!sc.fragPrevious&&!too_late.includes(sc.state))return attach();this.log.info("late attach to dm in "+sc.state+" state");if(!too_late.includes(sc.state)||!sc.onFragAppended)attach(this.player.get_pos());else{var cb=["onFragAppended","onFragLoadEmergencyAborted"];if(sc.state=="FRAG_LOADING")cb.push("onError");cb.forEach(function(f){sc["prev_"+f]=sc[f]});this.wait_attach=true;sc.onFragAppended=function(){do_attach("onFragAppended",cb)};sc.onFragLoadEmergencyAborted=function(){do_attach("onFragLoadEmergencyAborted",cb)};if(sc.state=="FRAG_LOADING"){sc.onError=function(o){if(["fragLoadError","fragLoadTimeOut"].includes(o.details))return do_attach("onError",cb,o);sc.onError=sc.prev_onError;delete sc.prev_onError;sc.onError(o)}}}};E.hap.prototype._detach_dm=function(dm){this.log.info("detach dm");dm.hola_adaptive=false;dm.fragmentLoader.onFragLoading=dm.fragmentLoader.prev_onFragLoading;dm.abrController.clearTimer=dm.abrController.prev_clearTimer;dm.abrController.timer=null;dm.levelController.manualLevel=-1;dm.config=dm.saved_config;if(dm.constructor.Events.FRAG_STATISTICS)dm.off(dm.constructor.Events.FRAG_STATISTICS,this.frag_stats_hnd);if(this.initial_load_level>-1)dm.nextLoadLevel=this.initial_load_level};E.hap.prototype._onbwsuninit=function(){var cdns=this.bws.cdns.filter(function(c){return c.is_hola()&&c.is_usable()});var master=this.bws.cdns.get_master();for(var level in this.keymap_info){var keymap=assign({full:true},this.keymap_info[level]);var playlist=this.bws.method.playlists[level];var url=util.parse_segment_url(playlist.url,{zone:this.CG("zone"),proxy:this.CG("cdn.static_video_proxy")});var route={url:url.orig,id:playlist.playlist_id||playlist.bitrate,playlist:playlist.url,manifest:url.force_params&&url.force_params.manifest||this.bws.url_s};if(master&&cdns.includes(master)){master.using(this.bws.zone).send_xhr("cmd/set_keymap",route,keymap)}else{cdns.forEach(function(c){c.using(this.bws.zone).send_xhr("cmd/set_keymap",route,keymap)},this)}}};E.hap.prototype.destroy=function(){this.append_timer=clearTimeout(this.append_timer);if(zutil.is_mocha())return;this.abort();this.bws.off("continue",this.onbwscontinue);this.bws.off("uninit",this.onbwsuninit);var sc=util.get_hls_sc(this.dm);if(sc.skipCount)this.zperr({id:"dm_skip_cnt",info:{skip:sc.skipCount}});this.detach_dm(this.dm)};E.hap.prototype._onbwscontinue=function(){var now_qid,qid,sc,now_dm=get_dm(this.player);if(this.dm==now_dm)return;if(sc=util.get_hls_sc(this.dm))qid=sc.level;this.detach_dm(this.dm);this.attach_dm(this.dm=now_dm);if(sc=util.get_hls_sc(this.dm))now_qid=sc.level;if(qid!==undefined&&qid!=now_qid)this.set_quality(qid)};E.hap.prototype.serve=function(){this.bws.do_streams(null,"serve")};E.hap.prototype.is_loading_frag=function(sn){var sc=util.get_hls_sc(this.dm);return sc.fragCurrent&&sc.fragCurrent.sn==sn&&sc.state=="FRAG_LOADING"};E.hap.prototype.frag_loading=function(o){var _this=this,method=this.bws.method,mismatch,info;var stream=this.bws.get_stream_by_id("video"),idx=o.frag.sn;this.log.info("dm onFragLoading "+idx);if(idx===undefined&&!zutil.is_mocha())this.log.info("dmFrag: "+JSON.stringify(o)+" "+(new Error).stack);this.player.emit("on_frag_loading",idx);if(info=method.seek_info){method.seek_info=undefined;if(info.to==-1&&method.pl_info[this.qid].first_index>info.offset)info.offset=method.pl_info[this.qid].first_index;method.emit("seek_complete",info);this.bws.seek_complete(info)}if(this.is_loading_frag(idx)){if(mismatch=stream&&idx!=stream.completed){this.log.info("index mismatch dm expects "+idx+" hap is working on "+stream.completed+" syncing");this.bws.stats.seg_mismatch++}this.bws.streams.forEach(function(s){s.set_completed(idx,"frag_loading");var remove=[];var segments=method.stream_info[s.id].segments;s.reqs.forEach(function(req){var unobtained;if(req.info.rate||idx==req.info.segment.index&&!segments[idx].completed||req.info.segment.index>idx&&(unobtained=method.next_unobtained(s,idx,req.info.segment.index))&&req.info.segment.index<=unobtained.from+1){return}if(idx>req.info.segment.index)req.info.live_sliding=_this.player.is_live_stream();remove.push(req)});remove.forEach(function(req){req.abort("frag_loading")});remove=[];s.chunks.forEach(function(c){if(c.index==idx&&segments[idx].completed)remove.push(c);if(c.index<idx||c.index>idx+5)remove.push(c)});remove.forEach(function(c){s.chunks.splice(s.chunks.indexOf(c),1)});if(mismatch)method.reset_segments(s);method.send_reqs(s)})}this.serve()};E.hap.prototype.frag_stats=function(event,info){if(!this.CG("cdn.method.load_keyframe_map"))return;var seglist=this.bws.method.playlists&&this.bws.method.playlists[info.level].segments||{};var seg=seglist["media_index_"+info.segment];if(!seg||!info.keymap||!info.keymap.sps||!info.keymap.pps)return;var data={keymap:{frags:{},pmt:info.keymap.pmt},frag_cnt:seglist.length};data.keymap.frags[info.segment]=zutil.pick(info.keymap,"idr","indr","sei");data.keymap.sps=info.keymap.sps.map(function(e){return Array.prototype.slice.call(e)});data.keymap.pps=info.keymap.pps.map(function(e){return Array.prototype.slice.call(e)});this.keymap_info[info.level]=this.keymap_info[info.level]||data;assign(this.keymap_info[info.level].keymap,data.keymap)};E.hap.prototype.set_quality=function(qid){var dm=this.dm,sc;if(!dm.levelController)return;dm.levelController.manualLevel=this.qid=qid;if(sc=util.get_hls_sc(dm))sc.level=qid;if(dm.startLevel==-1)dm.startLevel=qid};E.hap.prototype.get_index=function(playlist,pos,seek){var sc=util.get_hls_sc(this.dm);if(!sc)return;var det,levels=sc.levels,level=levels[playlist.level_idx];if(!(det=level.details))return;var fragments=det.fragments,start=fragments[0].start;var fraglen=fragments.length;var end=fragments[fraglen-1].start+fragments[fraglen-1].duration;var frag=sc._findFragment({start:start,fragPrevious:sc.fragPrevious,fragLen:fraglen,fragments:fragments,holaSeek:!!seek,levelDetails:det,end:end,bufferEnd:pos});if(!frag)return;var sn=frag.sn,index=sn-det.startSN;if(["PARSING","PARSED"].includes(sc.state)&&sn==sc.fragCurrent.sn&&index<fraglen-1){sn++}return sn};E.hap.prototype.get_live_pos=function(){return util.get_hls_sc(this.dm).startPosition};E.hap.prototype.obtained_sec_parser=function(){return 0};E.hap.prototype.oncomplete_req=function(req){var seg=req.info.segment,dm=this.dm,sc=util.get_hls_sc(dm);if(!sc.fragCurrent||seg.index!=sc.fragCurrent.sn){return this.log.info("ERR - try to send end event on idx "+seg.index+(sc.fragCurrent?" but current fragment is "+sc.fragCurrent.sn:" but no current fragment"))}return dm.trigger("hlsFragLoaded",{frag:sc.fragCurrent,stats:{loaded:req.loaded}})};E.hap.prototype.abort=function(){this.append_timer=clearTimeout(this.append_timer)};E.hap.prototype._check_serving_state=function(){var sc=util.get_hls_sc(this.dm);return sc&&sc.levels};E.hap.prototype.is_buffer_delayed=function(chunk){var playlist=this.bws.method.playlists[chunk.qid];var dm=this.dm,sc=util.get_hls_sc(dm),delay=0,reason,wait;var level=playlist.level_idx;if(!sc||!sc.fragCurrent||!sc.levels.length){wait=true;reason="no fragCurrent or sc.levels"}else if(sc.fragCurrent.sn!=chunk.index){wait=true;reason="fragCurrent.sn!=idx "+sc.fragCurrent.sn+"!="+chunk.index}else if(!"FRAG_LOADING|FRAG_PARSING".includes(sc.state)){delay=50;reason="state is "+sc.state}else if(sc.fragBitrateTest){this.log.notice("append_all while fragBitrateTest, disable");this.zperr({id:"hola_adaptive_frag_bitrate_test_error",add_log:true,throttle:1});var event={payload:null,frag:sc.fragCurrent,stats:{loaded:chunk.req.loaded}};dm.trigger("hlsFragChunkLoaded",event);dm.trigger("hlsFragLoaded",event);reason="frag bitrate test";delay=10}else if(level===undefined){delay=50;reason="level is undefined"}else if(!sc.levels[level].details){this.set_quality(level,"is_buffer_delayed");delay=50;reason="no levels details"}if(delay)this.schedule_append_buffer(delay);if(wait||delay)this.log.info("append buffer stopped due to "+reason);return wait||!!delay};E.hap.prototype.append_buffer=function(chunk){var dm=this.dm,sc=util.get_hls_sc(dm);var method=this.bws.method,req=chunk.req;var level=method.playlists[req.info.segment.qid].level_idx;this.append_timer=clearTimeout(this.append_timer);sc.fragCurrent=assign({},sc.fragCurrent);sc.level=sc.fragCurrent.level=level;var data=chunk.data;data.first=!chunk.from;req.set_final=data.final=data.final||(!req.opt.streaming||chunk.to==req.to);if(chunk.old_c&&data.keymaps)data.keymaps.old_map.len=chunk.old_c.data.byteLength;method.stream_info[req.stream.id].segments[chunk.index].final=data.final;dm.trigger("hlsFragChunkLoaded",{payload:data,frag:sc.fragCurrent,stats:{}});if(data.final&&sc.fragCurrent){dm.trigger("hlsFragLoaded",{frag:sc.fragCurrent,stats:{loaded:req.loaded}})}return true};E.hap.prototype.schedule_append_buffer=function(ms){if(this.append_timer)return;this.append_timer=setTimeout(this.fallback_wrapper(this.serve,"serve"),ms)};E.hap.prototype.get_manual_level=function(){return this.dm.manual_level===undefined?-1:this.dm.manual_level};E.hap.prototype.reload_master_playlist=function(){var dm=this.dm;this.log.info("reload master playlist");if(dm.clearLevelDetails)dm.clearLevelDetails();dm.loadSource(dm.url)};E.hap.prototype.is_smooth_streaming=function(){return this.dm.isSmoothStreaming&&this.dm.isSmoothStreaming()};E.supported=function(player){if(!util.is_enabled(E))return false;var dm=get_dm(player);if(zutil.is_mocha()||util.is_hola_hls_js(dm))return true};E.ManifestLoader=function(opt){if(!(this instanceof E.ManifestLoader))return new E.ManifestLoader(opt);this.method=opt.method;this.CG=this.method.CG;this.bws=this.method.bws;this.log=this.method.log;this.dm=this.method.hap.dm;this.req_id=1;var player=this.player=opt.player;this.module=player.module||player.slave&&player.slave.module;this.manage_origin=!!this.CG("cdn.method.manifest_loader.manage_origin");this.is_live=player.is_live_stream();this.req2state={};this.pl2status={};this.pl2live_status={};if(!this.dm||!util.is_hola_hls_js(this.dm)||!this.dm.playlistLoader||!this.dm.playlistLoader.replaceLevelPlaylist){this.log.info("not a hola hls.js or hls.js version is too old: "+"disabling manifest loader");return}if(!this.module||!this.module.init_ploader)return;this.module.init_ploader(this);if(this.manage_origin){this.log.info("manifest loader: inited in manage_origin mode, "+"disabling origin");this.bws.disable_origin()}this.check_origin_status();if(this.CG("cdn.method.manifest_loader.enable_levels_preload"))this.dm.config.levelsPreload=true};E.ManifestLoader.prototype.load=function(opt){this.log.info("manifest loader: starting loading "+(opt.is_master?"manifest":"bitrate "+opt.id+" playlist qid "+opt.level)+" from "+opt.url);opt.key=opt.url+"_"+(opt.is_master?"manifest":"playlist");this.req2state[opt.key]=this.req2state[opt.key]||[];if(this.req2state[opt.key].length)this.abort(this.req2state[opt.key]);else if(!opt.internal){for(var key in this.req2state){if(this.req2state[key].length&&(key!=opt.key&&!this.req2state[key][0].opt.is_master||this.req2state[key][0].opt.is_master&&opt.is_master)){this.abort(this.req2state[key])}}}this.send_requests(opt);return this.req2state[opt.key]};E.ManifestLoader.prototype.abort_origin=function(state,caller){if(state.origin_xhr&&state.origin_xhr.abort){state.origin_xhr.abort();this.log.info("manifest loader: abort req ml"+state.origin_xhr.id)}state.origin_xhr=undefined};E.ManifestLoader.prototype.abort_state=function(state,caller){state.forEach(function(xhr){if(xhr.abort)xhr.abort();this.log.info("manifest loader: abort req ml"+xhr.id+" from "+caller);xhr.aborted=true},this);state.splice(0)};E.ManifestLoader.prototype.abort=function(state){var opt=state.opt||{};this.log.info("manifest loader: abort loading of "+(opt.is_master?"manifest ":"bitrate "+opt.id+" playlist ")+"from "+opt.url);clearTimeout(state.timeout);clearTimeout(state.origin_timeout);this.abort_state(state,"abort");this.abort_origin(state);for(var key in this.req2state){if(this.req2state[key]==state)this.req2state[key]=[]}};E.ManifestLoader.prototype.is_loading=function(){for(var key in this.req2state){var state=this.req2state[key];if(state.length||state.origin_xhr&&!state.origin_finished)return true}};E.ManifestLoader.prototype.abort_all=function(){for(var key in this.req2state){if(this.req2state[key].length)this.abort(this.req2state[key])}};E.ManifestLoader.prototype.send_requests=function(opt,mode){var _this=this,state=this.req2state[opt.key];state.opt=opt;state.finished=false;delete state.timeout;if(mode!="agents"&&!opt.playlist_loader){state.origin_finished=false;delete state.origin_timeout;if(opt.is_master||this.origin_status!="agent")this.send_origin_req(opt)}if(mode!="origin"&&!this.is_live&&!(opt.is_master&&_this.CG("cdn.method.manifest_loader.disable_master"))){this.send_hola_reqs(opt)}};E.ManifestLoader.prototype.send_origin_req=function(opt){var u=zurl.parse(opt.url);var origin={host:u.host,hostname:u.hostname,is_hola:function(){return false},is_origin:function(){return true}};this.send_req(origin,opt)};E.ManifestLoader.prototype.send_hola_reqs=function(opt){if(!this.bws.cdns)return;if(this.req2state[opt.key].resp_xhr&&!opt.playlist_loader)return this.on_hola_load(this.req2state[opt.key].resp_xhr);this.bws.cdns.filter(function(cdn){return cdn.is_fast()&&cdn.is_usable()}).forEach(function(cdn){if(!opt.playlist_loader||!cdn.no_keymap)this.send_req(cdn,opt)},this)};E.ManifestLoader.prototype.set_params=function(cdn,opt,url){if(!cdn.is_hola())return"";var res=(url.search?"&":"?")+"hola";res+=util.set_param("method",this.method.type);res+=opt.is_master?"":util.set_param("id",opt.id);res+=opt.is_master?"":util.set_url_param("playlist",url.orig);res+=util.set_url_param("manifest",this.bws.url_s);if(this.CG("cdn.method.load_keyframe_map")&&!opt.is_master)res+=util.set_url_param("with_keymap",1);return res};E.ManifestLoader.prototype.gen_url=function(opt,cdn){var url=opt.url,res={};if(typeof url!="object")url=zurl.parse(url);var protocol=url.protocol=="https:"||typeof location=="undefined"||!["http:","https:"].includes(location.protocol)||util.is_ios_sdk||util.is_android_sdk||window.hola_cdn_sdk?url.protocol:location.protocol;var host=protocol=="https:"?cdn.hostname:cdn.host;res.cache_path=res.path=(cdn.is_hola()?host+"/"+util.conf.customer+"/"+this.CG("zone")+"/":"")+(cdn.is_hola()?url.hostname:cdn.hostname)+(url.port?":"+url.port:"");res.cache_path+=url.pathname;res.path+=url.path+this.set_params(cdn,opt,url);res.url=protocol+"//"+res.path;return res};E.ManifestLoader.prototype.fail_check=function(xhr){return xhr.opt.cdn.is_hola()?this.hola_fail_check(xhr):this.origin_fail_check(xhr)};E.ManifestLoader.prototype.onload=function(xhr){xhr.resp_text=["text",""].includes(xhr.responseType)?xhr.responseText:null;return xhr.opt.cdn.is_hola()?this.on_hola_load(xhr):this.on_origin_load(xhr)};E.ManifestLoader.prototype.send_req=function(cdn,opt){var _this=this,state=this.req2state[opt.key];var xhr=new XMLHttpRequest,res=this.gen_url(opt,cdn);var server=cdn.is_hola()?"hola":"origin";var is_retry=cdn.is_hola()?state.gap:state.origin_gap;xhr.id=this.req_id++;xhr.withCredentials=!cdn.is_hola()&&this.CG("cdn.send_reqs.origin.with_credentials");xhr.opt=assign({cdn:cdn},opt);xhr.open("GET",res.url);xhr.onprogress=opt.onprogress;xhr.timeout=opt.timeout||2e4;xhr.onload=function(ev){_this.method.emit("playlist_resp",{cdn:cdn,qid:opt.level,loader:opt.playlist_loader,status:this.status});if(this.status!=200){_this.log.info("manifest loader: req ml"+xhr.id+" failure code "+this.status+" to "+res.url);_this.stat_inc("fail_"+server+"_"+this.status);return _this.fail_check(this,opt)}if(is_retry)_this.stat_inc("retry_success_"+server);_this.log.info("manifest loader: req ml"+xhr.id+" success to "+res.url);return _this.onload(this,opt)};xhr.onerror=function(ev){_this.stat_inc("fail_"+server+"_error");return _this.fail_check(this,opt)};xhr.ontimeout=function(ev){_this.log.info("manifest loader: req timeout");_this.stat_inc("fail_"+server+"_timeout");return _this.fail_check(this,opt)};xhr.onabort=function(){if(is_retry)_this.stat_inc("retry_abort_"+server)};if(cdn.is_hola())state.push(xhr);else state.origin_xhr=xhr;this.log.info("manifest loader: send req ml"+xhr.id+" to "+res.url);this.method.emit("playlist_req",{cdn:cdn,qid:opt.level,loader:opt.playlist_loader});xhr.send();if(is_retry)this.stat_inc("retry_"+server)};E.ManifestLoader.prototype.on_hola_load=function(xhr){var info,opt=xhr.opt;var state=this.req2state[opt.key],resp_text=xhr.resp_text;if(!resp_text){state.splice(state.indexOf(xhr),1);return this.log.info("missing resp text for "+opt.url)}this.check_live(xhr);if(this.is_live)return this.abort_state(state,"on_hola_load_live");if(this.CG("cdn.method.load_keyframe_map")&&!opt.is_master&&(info=this.method.pl_info[opt.level])){var keymap=hutil.parse_keymap(resp_text);resp_text=hutil.strip_keymap(resp_text);if(keymap&&!info.keymap){this.log.info("manifest loader: got keymap lvl "+opt.level);this.method.process_keymap(opt.level,keymap)}opt.cdn.no_keymap=!keymap;if(!state.resp_xhr||keymap)state.resp_xhr=xhr;info.resp_ready=true;if(opt.playlist_loader&&!keymap)return}if(!state.origin_xhr||state.origin_finished)this.req2state[opt.key]=[];this.abort_state(state,"on_hola_load");if(state.finished||!opt.onsuccess)return;
if(opt.is_master)this.origin_status="agent";else this.pl2status[opt.id]="agent";var resp_url,hola_resp;if(hola_resp=xhr.getResponseHeader("X-Hola-Resp")){var redirect=zescape.parse.http_words(hola_resp).find(function(w){return w[0]=="redirect"});resp_url=decodeURIComponent((redirect||[0,""])[1])}opt.onsuccess({currentTarget:{responseText:resp_text,responseURL:resp_url||opt.url,getResponseHeader:xhr.getResponseHeader.bind(xhr)}});state.finished=true;this.update_origin_status()};E.ManifestLoader.prototype.on_origin_load=function(xhr){var opt=xhr.opt;var state=this.req2state[opt.key],resp_text=xhr.resp_text;if(!resp_text)return this.abort_origin(state);if(opt.is_master)this.origin_status="origin";else this.pl2status[opt.id]="origin";if(!state.length)this.req2state[opt.key]=[];this.check_live(xhr);if(!state.finished&&!opt.internal){if(opt.onsuccess){opt.onsuccess({currentTarget:{responseText:xhr.resp_text,responseURL:xhr.responseURL,getResponseHeader:xhr.getResponseHeader.bind(xhr)}})}if(!this.CG("cdn.method.load_keyframe_map")||opt.is_master||(this.method.pl_info[opt.level]||{}).keymap){this.abort_state(state,"on_origin_load")}state.finished=true}else{if(opt.is_master){var is_master=!resp_text.includes("#EXTINF:");if(is_master)this.update_master_playlist(xhr.resp_text,xhr.responseURL);this.reload_playlists_from_origin()}else{this.update_level_playlist(xhr.resp_text,xhr.responseURL,opt.level)}}state.origin_finished=true;this.update_origin_status()};E.ManifestLoader.prototype.hola_fail_check=function(xhr){var opt=xhr.opt;xhr.fail=true;if(this.req2state[opt.key].find(function(x){return!x.fail}))return;var gap=Math.min(2*(this.req2state[opt.key].gap||500),8e3);this.log.info("manifest loader: all reqs to agents failed for "+(opt.is_master?"manifest":"bitrate "+opt.id+" playlist")+", reload in "+gap+" ms");this.req2state[opt.key].splice(0,this.req2state[opt.key].length);this.req2state[opt.key].gap=gap;this.req2state[opt.key].timeout=setTimeout(this.send_hola_reqs.bind(this),gap,opt)};E.ManifestLoader.prototype.origin_fail_check=function(xhr){var opt=xhr.opt,state=this.req2state[opt.key];state.origin_retries=(state.origin_retries||0)+1;state.origin_xhr=undefined;if(state.origin_retries>=5){this.log.info("manifest loader: req to origin failed for "+(opt.is_master?"manifest":"bitrate "+opt.id+" playlist")+" 5 times, stopping.");if(!state.finished||this.is_live){this.log.err("manifest loader: req to download "+(opt.is_master?"manifest":"bitrate "+opt.id+" playlist")+" have failed.");this.abort(state);if(opt.onerror)opt.onerror({currentTarget:xhr})}return}var gap=Math.min(2*(state.origin_gap||500),8e3);this.log.info("manifest loader: req ml"+xhr.id+" to origin failed for "+(opt.is_master?"manifest":"bitrate "+opt.id+" playlist")+", reload in "+gap+" ms");state.origin_gap=gap;this.origin_timeout=setTimeout(this.send_origin_req.bind(this),gap,opt)};E.ManifestLoader.prototype.update_master_playlist=function(data,url){var ploader=this.dm.playlistLoader;this.log.info("manifest loader: manifest is loaded from origin, "+"replacing the currently used version");ploader.replaceManifest(data,url)};E.ManifestLoader.prototype.update_level_playlist=function(data,url,level_id){var ploader=this.dm.playlistLoader;this.log.info("manifest loader: level playlist for level "+level_id+" is loaded from origin, replacing the currently used version");ploader.replaceLevelPlaylist(level_id,data,url)};E.ManifestLoader.prototype.reload_playlists_from_origin=function(){var _this=this,levels=this.dm.levels;for(var k in this.req2state){var state=this.req2state[k];if(state.opt&&!state.origin_xhr){var lvl=levels.find(function(l){return l.bitrate==state.opt.id});state.opt.url=lvl.url[lvl.urlId];if(state.opt.key!=k)this.req2state[state.opt.key]=state;this.send_origin_req(state.opt)}}levels.forEach(function(l,idx){if(_this.pl2status[l.bitrate]!="agent")return;var url=l.url[l.urlId],key=url+"_playlist";if(!_this.req2state[key])_this.req2state[key]=[];_this.log.info("manifest loader: reload bitrate "+l.bitrate+" playlist from origin at url "+url);_this.send_origin_req({url:url,is_master:false,id:l.bitrate,internal:true,level:idx,key:key})})};E.ManifestLoader.prototype.check_live=function(xhr){var opt=xhr.opt;if(this.is_live||opt.is_master||this.pl2live_status[opt.id])return;this.is_live=!xhr.responseText.includes("#EXT-X-ENDLIST");if(this.is_live){this.log.info("manifest loader: live stream detected, use only origin "+"from now on")}this.pl2live_status[opt.id]=true};E.ManifestLoader.prototype.check_origin_status=function(){var _this=this,levels;if(!(levels=this.dm.levels))return;this.origin_status="origin";levels.forEach(function(l){if(l.details)_this.pl2status[l.bitrate]="origin"});this.update_origin_status()};E.ManifestLoader.prototype.update_origin_status=function(){if(!this.manage_origin)return;var enable_origin=this.origin_status!="agent",completed_pl=0;for(var pl in this.pl2status){completed_pl++;enable_origin=this.pl2status[pl]=="agent"?false:enable_origin}enable_origin=!!(enable_origin&&completed_pl);if(enable_origin==this.bws.origin_enabled)return;if(enable_origin){this.log.info("manifest loader: all playlists come from origin, "+"enable origin as source");this.bws.enable_origin()}else{this.log.info("manifest loader: not all playlists come from origin, "+"disable origin as source");this.bws.disable_origin()}};E.ManifestLoader.prototype.stat_inc=function(stat){var ml=this.bws.stats.manifest_loader;ml[stat]=(ml[stat]||0)+1};if(typeof window!="undefined")window.hola_cdn.api.hap_get_index=E.hap.prototype.get_index;return E});
define("/svc/cdn/pub/play_log.js",["/svc/cdn/pub/util.js","/util/storage.js","/util/util.js","/util/string.js","/util/date.js"],function(util,storage,zutil,string,date){var E={};E.Play_log=function(opt){var zperr=opt.bws.zone.perr_get();this.requests={};this.start_time=undefined;this.stop_pos=undefined;this.play_state="IDLE";this.have_requests=false;this.resp_progress={};this.bws=opt.bws;this.base_ts=Date.now();try{this.log=opt.bws.zone.log_get().set_module("play_log");this.bootstrap_cache=storage.get_json("hola_bootstrap_cache");this.bwsaver_cache=storage.get_json("hola_bwsaver_cache");if(this.bwsaver_cache&&opt.bws.cache){this.bwsaver_cache.urls=zutil.pick(this.bwsaver_cache.urls,opt.bws.cache.url)}this.cdnlist_cache=storage.get_json("hola_cdnlist_cache");this.geoip=storage.get_json("hola_geoip");this.resolution=this.bws.player.get_resolution();this.bootstrap_cdns=util.conf.bootstrap_cdns;this.bws.on("ondata",this.try_wrapper(this.ondata));this.bws.on("req_end",this.try_wrapper(this.req_end));this.bws.on("wrapper_send_report",this.try_wrapper(this.send_report));this.bws.on("cdns_received",this.try_wrapper(this.cdns_received));this.bws.on("parser_init",this.try_wrapper(this.parser_inited));this.bws.on("method_init",this.try_wrapper(this.method_inited));this.bws.player_on("play",this.try_wrapper(this.on_play));this.bws.player_on("seeking",this.try_wrapper(this.on_stop));this.bws.player_on("ended",this.try_wrapper(this.on_stop));this.bws.player_on("on_frag_loading",this.try_wrapper(this.on_frag_loading));this.parser_inited();this.get_manifest()}catch(e){if(this.log)this.log.info("error play_log init "+e+" "+e.stack);zperr({id:"bwsaver_err_set_play_log",err:e.message})}return this};E.Play_log.prototype.parser_inited=function(){var _this=this;var on_metainfo=function(metainfo){_this.metainfo=metainfo};if(this.bws.parser)this.bws.parser.on("meta_info",on_metainfo)};E.Play_log.prototype.method_inited=function(method){if(this.bws.adaptive)this.hola_adaptive=method.type=="hola_adaptive"};function get_dm(pl){return(pl.module||pl.slave&&pl.slave.module||{}).dailymotion}E.Play_log.prototype.get_manifest=function(){var _this=this;var bws=this.bws;var player=bws.player;var dm=get_dm(player);if(!dm)return;var sc=util.get_hls_sc(dm);if(!sc)return;var update_metadata=function(){var buffered=_this.manifest&&_this.manifest.buffered;if(!buffered&&player.get_buffered().length){buffered=[];var buf=player.get_buffered();for(var i=0;i<buf.length;i++){if(buf.end(i)>0)buffered.push({start:buf.start(i),end:buf.end(i)})}}_this.manifest={from:bws.from,levels:sc.levels,playlists:player.get_playlists(),buffered:buffered}};player.on("manifest_loaded",update_metadata);player.on("level_loaded",function(){update_metadata();_this.manifest.level_ms=_this.manifest.level_ms||date()-_this.base_ts});update_metadata()};E.Play_log.prototype.try_wrapper=function(func){var _this=this;var zperr=this.bws.zone.perr_get();return function(){try{return func.apply(_this,arguments)}catch(e){zperr({id:"bwsaver_err_set_play_log",err:e.message,throttle:1});_this.log.info("play_log error "+e.message+" "+e.stack)}}};E.Play_log.prototype.req_end=function(req){var ts=+Date.now();var m=this.requests[req.opt.method]||(this.requests[req.opt.method]={});var s=m[req.url]||(m[req.url]=[]);var resp_hdrs=req.resp?req.resp.hdrs:{};var size_hdr=zutil.own(resp_hdrs,"x-hola-fullsize")&&"x-hola-fullsize"||zutil.own(resp_hdrs,"content-range")&&"content-range"||"content-length";var hdrs=zutil.pick(resp_hdrs,size_hdr,"x-cache","date","x-date");var r={ts:req.tm_create-this.base_ts|0,ms_hdrs:req.ms_hdrs,ms:ts-req.tm_create|0,size:req.size(),data_prefix:req.info.data_prefix,bps:req.bps()|0,range:req.opt.headers.Range,hdrs:hdrs,progress:this.resp_progress[req.name]};if(req.status!=200&&req.status!=206)r.status=req.status;s.push(r);this.have_requests=true};E.Play_log.prototype.ondata=function(d){var p=this.resp_progress[d.req.name]||(this.resp_progress[d.req.name]=[]);p.push({size:d.size,ms:Date.now()-d.req.tm_create|0})};E.Play_log.prototype.cdns_received=function(data){this.cdns_ms=date()-this.base_ts;this.cdns=data};E.Play_log.prototype.send_report=function(){if(!this.have_requests)return;this.on_stop();var zperr=this.bws.zone.perr_get();var info=zutil.pick(this,"bootstrap_cdns","manifest","bootstrap_cache","bwsaver_cache","cdnlist_cache","geoip","base_ts","requests","cdns","cdns_ms","metainfo","start_time","resolution","stop_pos","hola_adaptive","frag_ms");this.reduce_report(info);zperr({id:"play_log",info:info})};E.Play_log.prototype.reduce_report=function(data){if(data.manifest&&data.manifest.levels){var levels=[];data.manifest.levels.forEach(function(l){var cp_l=zutil.pick(l,"attrs","url");levels.push(cp_l);if(!l.details)return;cp_l.details=zutil.pick(l.details,"url","startSN","targetduration","totalduration","averagetargetduration","endSN");if(!l.details.fragments)return;cp_l.details.fragments=zutil.extend_deep(l.details.fragments);var fragments=cp_l.details.fragments;for(var i=0;i<fragments.length;i++){fragments[i]=zutil.pick(fragments[i],"url","duration","sn","expectedLen","level","start")}});data.manifest.levels=levels}};E.Play_log.prototype.on_play=function(){if(!this.start_time)this.start_time=Date.now()-this.base_ts};E.Play_log.prototype.on_stop=function(){if(!this.stop_pos)this.stop_pos=this.bws.player.get_pos()};E.Play_log.prototype.on_frag_loading=function(idx){if(idx==this.bws.from)this.frag_ms=Date.now()-this.base_ts};return E});
define("/svc/cdn/pub/cdn.js",["/util/url.js","/svc/cdn/pub/util.js","/util/user_agent.js","/util/etask.js","/util/zerr.js","/util/util.js","/util/date.js","/util/events.js","/util/array.js","/util/escape.js","/svc/cdn/pub/map.js","/svc/cdn/pub/cache.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/adaptive.js","/svc/cdn/pub/progressive.js","/svc/cdn/pub/unittest.js","/svc/cdn/pub/log.js","/svc/cdn/pub/stream.js","/svc/cdn/pub/aggregator.js","/util/rand.js","/svc/cdn/pub/hola_adaptive.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/play_log.js"],function(zurl,util,user_agent,etask,zerr,zutil,date,events,array,zescape,map,cache,cdnlist,adaptive,progressive,unittest,_log,stream,aggregator,rand,hola_adaptive,load_perf,play_log){var KB=1024,MB=1024*KB;var assign=Object.assign;var E={Bwsaver:Bwsaver};function log_from_zone(zone){return zone.log_get().set_module("cdn")}function create_fallback_wrapper(bws,opt){var counter=0,fallback=false,advanced=opt&&opt.advanced;return function fallback_wrapper(func,reason){var ctx=this;return function(){try{counter++;return func.apply(ctx,arguments)}catch(e){if(!fallback){fallback=true;bws.fallback(e,reason);e.sent_perr=1}if(advanced&&counter>1)throw e}finally{if(!--counter)fallback=false}}}}function Bwsaver(opt){if(!(this instanceof Bwsaver))return new Bwsaver(opt);opt=opt||{};this.zperr=opt.zone.perr_get();this.cdn_svc=opt.cdn_svc;this.zone=opt.zone;this.CG=this.zone.CG.bind(this.zone);this.CS=this.zone.CS.bind(this.zone);this.CE=this.zone.CE.bind(this.zone);this.CD=this.zone.CD.bind(this.zone);this.CGJ=this.zone.CGJ.bind(this.zone);this.log=log_from_zone(this.zone);this.fdt_id=0;this.origin_enabled=true;this.fallback_wrapper=create_fallback_wrapper(this);this.fallback_wrapper(function(){this.init(opt)},"init")();this.test_fallback=this.fallback_wrapper(function(){throw new Error("test_fallback")},"test_fallback");opt.zone.loader.bwsaver_active(!this.closed);if(util.is_webos||util.is_android_sdk||util.is_ios_sdk)this.CE("cdn.cache.urls.disable");if(util.is_chrome&&util.is_windows&&util.is_arch_32)this.CE("cdn.send_reqs.disable_streaming");return this}zutil.inherits(Bwsaver,events.EventEmitter);Bwsaver.prototype.abort=function(opt){opt=opt||{};if(this.parser)this.parser.emit("clear_buffers",this.pending_seek_pos);this.buf_sec_last_ts=this.buf_sec_last=undefined;if(this.streams.length){var s=this.streams[0];this.stream_info={fullsize:s.fullsize,slice:s.slice,bitrate:s.bitrate,from:s.from,to:s.to,completed:s.completed,slice_sec:s.slice_sec,mem_cache_offset:this.CG("cdn.media.memory_cache_sec")&&this.method.sec2offset?this.method.sec2offset(s,this.get_pos()-this.CG("cdn.media.memory_cache_sec")):0}}this.streams.forEach(function(s){s.uninit()});this.streams=[];this.ids=0};Bwsaver.prototype.bps=function(){var bps=0;this.streams.forEach(function(s){bps+=s.bps()});return bps};Bwsaver.prototype.set_serving_state=function(first){var pos=this.player.get_pos(),buf_sec=this.buf_sec_total();var bitrate=0,i=0;for(;i<this.streams.length&&this.streams[i].bitrate;i++)bitrate+=this.streams[i].bitrate;var allow_serve=pos-this.start_pos>.2||buf_sec>3||i==this.streams.length&&this.bps()*8>=bitrate;if(!allow_serve&&!this.denied_serve_start){this.stats.serve_if_fast.n++;this.denied_serve_start=date.monotonic();this.log.info("serving denied: pos "+pos+"-"+this.start_pos+" buffer "+buf_sec+" bps "+this.bps()+"*8>="+bitrate+" feature is "+(this.CG("cdn.media.serve_if_fast")?"enabled":"disabled"))}else if(allow_serve&&this.denied_serve_start){this.stats.serve_if_fast.wait_ms+=date.monotonic()-this.denied_serve_start[this.uid];this.denied_serve_start=undefined;this.log.info("serving allowed: pos "+pos+"-"+this.start_pos+" buffer "+buf_sec+" bps "+this.bps()+"*8>="+bitrate+" feature is "+(this.CG("cdn.media.serve_if_fast")?"enabled":"disabled"))}else if(first){this.log.info("serving "+(allow_serve?"allowed":"denied")+": pos "+pos+"-"+this.start_pos+" buffer "+buf_sec+" bps "+this.bps()+"*8>="+bitrate+" feature is "+(this.CG("cdn.media.serve_if_fast")?"enabled":"disabled"))}this.emit(allow_serve?"serving_allowed":"serving_denied")};Bwsaver.prototype.ofs2time=function(offset){return this.parser.ofs2time(offset)};Bwsaver.prototype.needed_sec=function(){if(this.CG("cdn.bwsaver.disable"))return this.slice_sec;var _bsec=this.buf_sec(),bsec=_bsec.buffered+_bsec.obtained;var watermark=this.CG("cdn.bwsaver.paused_start_needed_sec")||5;if(!this.is_paused()||!this.is_start_pos()){var potent=[[2,10],[5,15],[10,30],[15,40]].find(function(elm){return bsec<=elm[0]});watermark=potent?Math.min(this.low_watermark_sec,potent[1]):this.low_watermark_sec}var sec=Math.max(watermark-bsec,0);var s="needed sec: watermark "+watermark+" - buffered "+bsec+" = "+sec;if(s!=this.needed_sec_s){this.log.debug(s+" bsec p"+_bsec.player+"|e"+_bsec.estimated+"|o"+_bsec.obtained+"|b"+_bsec.buffered)}this.needed_sec_s=s;return sec};Bwsaver.prototype.disable_cache=function(){this.CE("cdn.cache.disabled")};Bwsaver.prototype.enable_cache=function(){this.CD("cdn.cache.disabled")};Bwsaver.prototype.cancel_delayed_fb=function(){if(!this.fdt_id)return;clearTimeout(this.fdt_id);this.fdt_id=0;this.log.info("fallback cancelled")};Bwsaver.prototype.fallback_delayed=function(){return!!this.fdt_id};Bwsaver.prototype.delay_fallback=function(fn,ms){this.fdt_id=setTimeout(fn,ms)};Bwsaver.prototype.onerror_stream=function(s,err,opt){if(this.onerror_stream_ext)this.onerror_stream_ext(s);if(opt.fallback){var err_obj=err instanceof Error?err:new Error(err);err_obj.reason=opt.reason;throw err_obj}};Bwsaver.prototype.oncomplete_stream=function(s){array.rm_elm(this.streams,s);if(!this.streams.length)this.done=true;s.uninit()};Bwsaver.prototype.get_stream_by_uid=function(uid){return this.streams.find(function(s){return s.uid==uid})};Bwsaver.prototype.get_stream_by_id=function(id){var r=new RegExp(id||"video");return this.streams.find(function(s){return s.id.match(r)})};Bwsaver.prototype.stream_completed=function(id){var s;if(s=this.get_stream_by_id(id))return s.completed};Bwsaver.prototype.resume=function(id){if(!this.paused||this.suspended||this.no_visibility)return;this.was_suspended=true;this.emit("resume");this.log.info("bws resume "+(id||""));if(!id)this.paused=false;this.do_streams(id,"resume")};Bwsaver.prototype.pause=function(reason,id){if(this.paused)return;this.emit("pause");this.log.info("bws pause "+(id?id+" ":"")+reason);if(!id)this.paused=true;this.do_streams(id,"pause")};Bwsaver.prototype.do_streams=function(id,func){var s,_id=id,_func=func;try{var args=Array.prototype.slice.call(arguments,2);if(!_id){if(this.streams)this.streams.forEach(function(s){s[_func].apply(s,args)})}else if(s=this.get_stream_by_id(_id))s[_func].apply(s,args);else this.onerror("stream "+_id+" not found")}catch(e){this.onerror("do_streams apply func "+_func+" failed "+zerr.e2s(e),{fallback:true,reason:"do_streams"})}};Bwsaver.prototype.onerror=function(err,opt){opt=opt||{};err=err||opt.reason||"unknown";this.log.err('bws error "'+err+'"');if(opt.fallback)this.uninit({err:'err "'+err+'"',reason:opt.reason})};Bwsaver.prototype.get_logs=function(evt){var unittest=this.unittest.gen_test();var logs=this.log.concat(evt&&evt.data,true);unittest+="\n\n"+this.log.logs_to_str(logs,true);if(this.CG("cdn.bwsaver.graph")){unittest+="\n\n";var cdn_timeline=window.cdn_graph.tl_export();if(cdn_timeline)unittest+=cdn_timeline}return unittest};Bwsaver.prototype.create_stream=function(opt){load_perf.push("bwsaver_create_stream_start",this.zone);opt=zutil.clone_deep(opt||{});this.buf_sec_last_ts=this.buf_sec_last=undefined;this.onerror_stream_ext=opt.onerror;this.done=false;opt.bws=this;opt.onerror=this.fallback_wrapper(this.onerror_stream,"onerror_stream");opt.oncomplete=this.oncomplete_stream.bind(this);if(!opt.id)opt.id="video";opt.id+=this.ids||"";this.ids++;this.log.info("create_stream "+opt.id+" "+(opt.url||this.url_s));var s=new stream(opt);this.streams.push(s);this.serve_log({from:s.from,to:s.to,msg:"stream start",req:{info:{url:this.zone.video_url,segment:["adaptive","hola_adaptive"].includes(this.method.type)?{index:this.method.start_index(),qid:this.method.qid}:undefined},stream:{id:s.id}}});return s};Bwsaver.prototype.is_start_pos=function(){var buffered=this.player.get_buffered(),pos=this.get_pos();return(!buffered||!buffered.length)&&pos<1||buffered.length&&buffered.start(0)==pos};Bwsaver.prototype.sec_in_buffer=function(pos,exact,hole){var bsec=0;var buffered=this.player.get_buffered();if(!buffered)return 0;hole=hole||0;for(var i=0;i<buffered.length&&!bsec;i++){var start=exact?buffered.start(i):Math.floor(buffered.start(i));var end=buffered.end(i);if(zutil.range(start,pos,pos+hole))start-=hole;while(i<buffered.length-1&&end+hole>=buffered.start(i+1))end=buffered.end(++i);if(zutil.range(pos,start,end))bsec+=end-pos}return exact?bsec:Math.round(bsec)};Bwsaver.prototype.buf_sec=function(pos,force){var now=date.monotonic();if(!zutil.is_mocha()&&!force&&this.buf_sec_last_ts&&now-this.buf_sec_last_ts<=10){return this.buf_sec_last}pos=pos||this.player.get_pos();var bsec=this.sec_in_buffer(pos,true);var s=this.get_stream_by_id("video");var est_sec=Math.round(s?Math.max(s.served_sec*(this.CG("cdn.bwsaver.estimate_sec_per")||80)/100-(pos-this.start_pos),0):0);var max_sec=this.CG("cdn.bwsaver.estimated_sec")?Math.max(bsec,est_sec):bsec;if(est_sec-bsec>50&&!this.est_sec_perr_sent){this.est_sec_perr_sent=true;this.zperr({id:"est_sec_vs_bsec_too_big",info:{est_sec:est_sec,bsec:bsec},add_log:true})}var res={player:bsec,obtained:this.method.obtained_sec(s),estimated:est_sec,buffered:max_sec,pos:pos};if(pos&&res.obtained>4&&bsec<2)this.stats.buf_stall=1;if(!this.buf_sec_last||max_sec!=this.buf_sec_last.buffered)this.emit("player_state",pos,res);this.buf_sec_last=res;this.buf_sec_last_ts=now;return this.buf_sec_last};Bwsaver.prototype.buf_sec_recalc=function(pos){this.buf_sec(pos,true)};Bwsaver.prototype.buf_sec_total=function(pos){var bsec=this.buf_sec(pos);return bsec.buffered+bsec.obtained};Bwsaver.prototype.urgent_policy=function(){return this.policy()=="urgent"};Bwsaver.prototype.lowcost_policy=function(){return this.policy()=="lowcost"};Bwsaver.prototype.fastest_policy=function(){return this.policy()!="lowcost"};Bwsaver.prototype.policy=function(){if(this.jtest_set_policy)return this.jtest_set_policy;var pos=this.player.get_pos();var is_paused=this.is_paused()&&(this.CG("cdn.paused_start")||pos>=1);var sec=this.buf_sec_total();var ret=!is_paused&&sec<=this.urgent_watermark_sec?"urgent":!is_paused&&sec<=this.lowcost_watermark_sec?"fastest":"lowcost";if(ret!=this.prev_policy){if(!this.prev_policy){this.log.info("policy inited to "+ret+" sec "+sec+" paused "+is_paused)}else{this.log.info("policy switched "+this.prev_policy+" -> "+ret+" sec "+sec+" paused "+is_paused)}this.prev_policy=ret;this.emit("set_policy",ret)}return ret};Bwsaver.prototype.track_state=function(caller){if(this.done||this.suspended)return;if(this.preload=="metadata"&&this.meta_data_received&&this.is_paused()&&this.player.get_pos()<1){return}var bsec=this.buf_sec();var buf_sec=bsec.buffered+bsec.obtained;this.stats.buf_sec+=buf_sec;this.stats.buf_n++;var s=bsec.buffered+"+"+bsec.obtained+"="+buf_sec;if(this.track_state_s!=s){var method=this.method;this.log.info("track state pos "+bsec.pos+" buf_sec+buffers "+s+" bsec p"+bsec.player+"|e"+bsec.estimated+"|o"+bsec.obtained+"|b"+bsec.buffered+" bps "+this.bps()+(method.type=="hola_adaptive"&&method.player.is_live_stream()&&method.qid!==undefined&&method.playlists[method.qid].segments?" live window "+method.playlists[method.qid].segments[0].media_index+"-"+method.playlists[method.qid].segments[method.playlists[method.qid].segments.length-1].media_index:"")+" called by "+caller)}this.track_state_s=s;if(bsec.obtained){this.stats.sec_obtained+=bsec.obtained;this.stats.sec_obtained_n++}if(!this.CG("cdn.bwsaver.disable")){var needed_sec=this.needed_sec();if(!needed_sec)this.pause("not needed sec "+needed_sec);else if(this.CG("cdn.bwsaver.pause_on_obtained")&&(bsec.obtained>10||bsec.obtained>5&&bsec.buffered<=5)){this.pause("large obtained queue "+bsec.obtained)}else if(needed_sec>=this.resume_sec)this.resume()}this.streams.forEach(function(s){if(s.allow_req("track_state"))s.send_reqs()});this.emit("track_state")};Bwsaver.prototype.onmetaready=function(){this.metadata_ready=true;this.pending_seek()};Bwsaver.prototype.pending_seek=function(){if(this.pending_seek_pos===undefined)return;this.onseek(this.pending_seek_pos);delete this.pending_seek_pos};Bwsaver.prototype.skip_seek=function(){return this.CG("cdn.bwsaver.skip_seek_to_same_pos")&&this.player.get_pos()==this.last_time_pos};Bwsaver.prototype.onseek=function(){var pos=this.player.get_pos();var reason=this.player.is_ad_active()?"ad play":this.skip_seek()?"same position":0;if(reason)return this.log.info("skipped seek ("+reason+")");if(!this.metadata_ready||!this.cdns)return void(this.pending_seek_pos=pos);this.player.emit("seek_prepare",this);this.parser.emit("seek",pos,this.pending_seek_pos)};Bwsaver.prototype.fallback=function(err,reason){try{this.uninit({err:zerr.e2s(err),reason:err.reason||reason,info:err.info})}catch(e){this.log.err("bws.uninit "+zerr.e2s(e)+"\nwhile handling fallback "+zerr.e2s(err))}};Bwsaver.prototype.onseeked=function(e){this.start_pos=this.player.get_pos()};Bwsaver.prototype.ontimeupdate=function(){var now=date.monotonic();if(now-(this.track_ts||0)<this.track_rate)return;this.track_ts=now;this.last_time_pos=this.player.get_pos();this.emit("timeupdate");this.track_state("timeupdate")};Bwsaver.prototype.ontimeinterval=function(){var pos;if(this.suspended||!this.player.is_playing()||(pos=this.player.get_pos())==this.last_time_pos){return}this.last_time_pos=pos;this.emit("timeupdate");this.track_state("timeupdate")};Bwsaver.prototype.force_end_of_stream=function(){var _this=this;if(this.player.media_src&&this.player.media_src.duration-this.last_time_pos<2&&this.player.media_src.ended==this.player.media_src.seq&&this.player.media_src.readyState=="open"){this.log.info("set endOfStream");try{this.player.media_src.endOfStream()}catch(e){var map=this.parser.media_appender.src_bufs_map;Object.keys(map).forEach(function(key){var rec=map[key];_this.log.info("sbuf "+rec.codec+" q.l="+rec.sbuf.chunkq.length+" sn="+rec.sbuf.sn+" u="+rec.sbuf.updating+" n_s="+rec.n_samples)});throw e}}};Bwsaver.prototype.parser_uninit=function(){this.off("timeupdate",this._force_end_of_stream);if(this.parser)this.parser.uninit();this.parser=undefined;this.metadata_ready=false};Bwsaver.prototype.parser_init=function(parsers){var _this=this;if(zutil.is_mocha())this.log.info("jtest parser init");else if(parsers[this.media]){util.assert_enabled(parsers[this.media],this.media+" module is required but disabled");this.parser=new parsers[this.media].Parser(this.tech,this.fallback_wrapper,this)}else return this.log.err("no parser for media type "+this.media);this.emit("parser_init");this.on("timeupdate",this._force_end_of_stream=this.force_end_of_stream.bind(this));this.parser.on("meta_info",function(info){_this.meta_data_received=true;_this.do_streams(null,"on_meta_data",info);if(_this.preload=="metadata"&&_this.is_paused())_this.pause("metadata preloaded")});this.parser.on("open",this.create_stream.bind(this));this.parser.on("seek_player_set",function(ms){_this.player.seek(ms,true)});this.parser.on("abort",this.abort.bind(this));this.parser.media_appender.on("onmetaready",this.onmetaready.bind(this));this.parser.on("seek_complete",this.seek_complete.bind(this));this.parser.init()};Bwsaver.prototype.parser_reopen=function(parsers){this.pause("parser reopen");this.abort();this.parser_uninit();this.parser_init(parsers);this.resume()};Bwsaver.prototype.seek_complete=function(seek_info){this.stats.seeks++;this.seek_ts=date.monotonic();var info=this.stream_info||{};this.player.refresh_buffered();if(this.streams.length){var s=this.streams[0];if(seek_info.cb)seek_info.cb(s,seek_info);if(!this.CG("cdn.disable_skip_seek_to_same_offset")&&seek_info.offset==s.completed){this.track_state("onseek");return void this.log.info("skip seek to completed offset")}info={fullsize:s.fullsize,slice:s.slice,bitrate:s.bitrate,to:s.to,completed:s.completed,slice_sec:s.slice_sec,mem_cache_offset:this.CG("cdn.media.memory_cache_sec")&&this.method.sec2offset?this.method.sec2offset(s,this.get_pos()-this.CG("cdn.media.memory_cache_sec")):0}}info.from=seek_info.offset;info.to=seek_info.to||info.to;info.verify=true;this.abort();this.done=false;this.track_state("onseek");this.create_stream(info)};Bwsaver.prototype.media_src_uninit=function(){this.player.disable_data_mode();this.off("uninit",this.media_src_uninit);this.player_off("seeking",this._onseek);if(this._onadstart)this.player_off("ad_start",this._onadstart)};Bwsaver.prototype.media_src_init=function(parsers,allow_jtest){var _this=this;if(zutil.is_mocha()&&!allow_jtest)return void(this.player.media_src={});this.log.debug("media src init");this.player.enable_data_mode(this.fallback_wrapper(function(media_src){if(media_src&&media_src.readyState!==undefined&&media_src.readyState!="open"){return}this.emit("sourceopen");media_src.seq=(media_src.seq||0)+1;_this.log.info("sourceopen seq:"+media_src.seq);if(_this.parser){_this.log.info("unexpected mediasource reopen");_this.zperr({id:"bwsaver_mediasource_reopened_error",add_log:_this.CG("util.log.report.msrc_reopen")});if(_this.CG("cdn.bwsaver.allow_parser_reopen"))return _this.parser_reopen(parsers)}if(zutil.is_mocha()||!_this.parser)_this.parser_init(parsers)},_this.media));this.on("uninit",this.media_src_uninit);this.player_on("seeking",this._onseek)};Bwsaver.prototype.is_playing=function(){return this.player.is_playing()};Bwsaver.prototype.is_paused=function(){return this.player.is_paused()};Bwsaver.prototype.get_pos=function(){return this.player.get_pos()};Bwsaver.prototype.reset_stats=function(){var s=this.stats,keys=Object.keys;this.reset_snapshot=util.data_snapshot(s,[].concat(keys(s).filter(function(k){var unresetable=["single_copy_rank","hdr_size"];return typeof s[k]=="number"&&!unresetable.includes(k)}),keys(s.cdn_switch).map(function(k){return"cdn_switch."+k}),keys(s.early_req).map(function(k){return"early_req."+k}),keys(s.buffering).map(function(k){return"buffering."+k}),keys(s.serve_if_fast).map(function(k){return"serve_if_fast."+k})));if(this.cdns)this.cdns.reset_stats()};Bwsaver.prototype.get_stats=function(opt){opt=opt||{};try{return this.final_stats||{buf:this.buf_sec(),saver:!opt.from_start&&this.reset_snapshot?this.reset_snapshot.diff(this.stats):this.stats,cdns:this.cdns?this.cdns.stats(opt):null,ws:this.cdns?this.cdns.ws_stats(opt):null}}catch(e){return{bwsaver_stats_error:zerr.e2s(e)}}};Bwsaver.prototype.uninit=function(opt){opt=opt||{};if(this.closed)return;if(!opt.err){this.log.info("bwsaver uninit");if(!zutil.is_mocha())this.final_stats=this.get_stats()}else{this.log.err("bw_saver fallback "+opt.err+(opt.reason?" "+opt.reason:""));var stat;try{stat=this.cdn_svc.attached_stats&&this.cdn_svc.attached_stats.get_stats_all()}catch(e){this.log.err("error get_stats "+zerr.e2s(e));stat={err:""+e}}var info={};if(opt.reason)info.reason=opt.reason;if(opt.info)assign(info,opt.info);info.err=""+opt.err;if(this.serve_log_arr.length)info.serve_log=this.serve_log_arr;this.zperr({id:"bwsaver_err_fallback",err:""+opt.err,delay:false,add_log:true,info:info,extra:stat,filehead:this.unittest?this.unittest.gen_test():undefined,bt:opt.err.stack||opt.err,full:this.CG("util.log.fallback_full")});this.cdn_svc.fallback=opt.err+" "+opt.reason;if(this.unittest&&_log.settings.console_log){window.hola_unittest=this.unittest.gen_test();this.log.debug("unittest generated at window.hola_unittest")}}this.emit("uninit");this.abort();this.closed=true;this.zone.loader.bwsaver_active(false);this.zone.info.bwsaver="disabled";if(this._onseeked)this.player_off("seeked",this._onseeked);this.player_off("seeking",this._onseek);if(this.use_time_poll)this.time_poll_id=clearInterval(this.time_poll_id);else this.player_off("timeupdate",this._ontimeupdate);this.player_off("play",this.onplay);this.player_off("seeking",this.onseeking);this.player_off("visibility_end",this._onvisibility_end);this.player_off("visibility_start",this._onvisibility_start);clearInterval(this.stats_debug_interval);if(!this.opt.player_obj)this.player.uninit();if(this.parser)this.parser_uninit();if(this.method)this.method.uninit();if(this.cache)this.cache.save({close:true});if(this.cdns){this.cdns.save({close:true});this.cdns.uninit()}this.cdns=this.cache=undefined;this.cdn_svc.attached_bws=undefined;if(this.sp)this.sp.return(-1);if(!opt.err)return;this.events.emit("fallback",opt.err);if(this.player)this.player.emit("fallback",opt.err)};Bwsaver.prototype.dump_chunk=function(track_id,chunk,info){if(this.dump[track_id]===undefined)this.dump[track_id]={chunks:[],info:[]};this.dump[track_id].chunks.push(chunk);this.dump[track_id].info.push(info||"")};Bwsaver.prototype.save_dump=function(track_cb){function err_fn(){}function save_track_dump(fs,track_id,dump){var fname="dump"+track_id+"_"+(date()/1e3|0)+".bin";fs.root.getFile(fname,{create:true},function(file){file.createWriter(function(writer){var blob=new Blob(dump.chunks);writer.addEventListener("writeend",function(){track_cb(file.toURL(),dump.info)},false);writer.write(blob)},err_fn)},err_fn)}var _this=this;var request_fs=window.requestFileSystem||window.webkitRequestFileSystem;request_fs(window.TEMPORARY,50*MB,function(fs){for(var track_id in _this.dump)save_track_dump(fs,track_id,_this.dump[track_id])},err_fn)};Bwsaver.prototype.fast_cdns_from_cache=function(data){if(this.cache)this.cdns_cache.fast=zutil.clone_deep(this.cache.get_fast_cdns());return this.cdns_cache.fast.length};Bwsaver.prototype.add_cdns_from_list=function(list,num,role,caller){if(!list||!list.length||num<=0||!this.cdns)return;var added=0,cdns=[];var single_cost=this.CG("cdn.send_reqs.hola.cost",1);for(var i=0;i<list.length&&(num=="all"||added<num);i++){var cdn=list[i],alt=this.cdns.get_by_host(cdn.host);if(alt&&alt.role==role)continue;added=added+!alt;cdn.role=role;cdn.owner="hola";cdn.cost=cdn.cost||(role=="fast"?5:single_cost);cdns.push(cdn);if(this.cache)this.cache.add_filter_cdn(cdn.host)}this.cdns.add(cdns);return cdns&&cdns.length};Bwsaver.prototype.next_single_copy_cdn=function(){if(!this.extra_singles.length)return void this.zperr({id:"err_no_extra_resources",add_log:true});this.add_cdns_from_list(this.extra_singles,1,"single_copy","extra");this.stats.single_copy_rank++;return true};Bwsaver.prototype.set_single_copy_cdn=function(data,caller){this.add_cdns_from_list(data,this.CG("cdn.single_copy.in_parallel")||"all","single_copy","set");this.stats.single_copy_rank++};Bwsaver.prototype.serve_log=function(chunk){if(!this.CG("cdn.serve_log.enable"))return;var pos=this.player.get_pos();var segment=chunk.req.info.segment;this.serve_log_arr.push({from:chunk.from,to:chunk.to,index:segment&&segment.index,qid:segment&&segment.qid,url:chunk.req.url,stream:chunk.req.stream.id,dur:segment&&segment.duration,pos:pos,resume:+this.was_suspended||undefined,buffer:this.sec_in_buffer(pos),msg:chunk.msg});this.was_suspended=false;if(this.serve_log_arr.length>(this.CG("cdn.serve_log.size")||30))this.serve_log_arr.splice(0,1)};Bwsaver.prototype.get_cdns=function(){if(this.CG("cdn.bootstrap.disabled")||this.cdns_cache.sent||!util.is_mode_cdn(this.zone)||zutil.is_mocha()&&util.jtest.no_bootstrap){this.log.info("bootstrapping disabled due "+(this.CG("cdn.bootstrap.disabled")?"config":this.cdns_cache.sent?"already sent":!util.is_mode_cdn(this.zone)?"not cdn mode":"using preconfigured cdns list"));return}this.log.info("get_cdns started");var have_cdns=this.fast_cdns_from_cache(),ret;if(!this.cdns.length&&cdnlist.bootstraps)this.cdns.uid=cdnlist.bootstraps.uid;if(ret=cdnlist.local_url2cdns(this.zone,cdnlist.all_agents,util.geoip,this.url.orig,Object.assign(util.get_url_frame(),{user_agent:navigator&&navigator.userAgent}))){if(!this.adaptive){this.extra_singles=ret.extra||[];this.set_single_copy_cdn(ret.single,"local_url2cdns");this.emit("local_get_cdns",ret.single,"single_copy")}this.emit("local_get_cdns",ret.fast,"fast")}if(have_cdns)this.add_cdns_from_list(this.cdns_cache.fast,1,"fast","cache");if(ret&&ret.fast&&ret.fast.length){this.add_cdns_from_list(ret.fast,2-this.cdns.hola_fast_usable(),"fast","local")}if(this.cdns.hola_usable())this.do_streams(null,"send_reqs")};Bwsaver.prototype.fast_cdns_from_bootstraps=function(){var _this=this;this.cdns_cache.sent=date.monotonic();this.sp=etask({name:"bwsaver_bootstrap"},[function(){return cdnlist.url2cdns(_this.url_s,null,_this.cdns,_this.zone)},function(ret){if(!ret||!ret.data||ret.status!=200){throw new Error("bootstrap failed to receive cdns "+(!ret?"!ret":!ret.data?"!ret.data":"status "+ret.status))}_this.cdns_cache.received=date.monotonic();_this.emit("cdns_received",ret.data);if(_this.cache)_this.cache.set_fast_cdns(ret.data.fast);_this.add_cdns_from_list(ret.data.fast,1,"fast","network");if(zutil.is_mocha())_this.set_single_copy_cdn(ret.data.single,"cdn_sources");_this.do_streams(null,"send_reqs");_this.log.info("get_cdns success "+JSON.stringify(_this.cdns_cache));_this.stats.get_cdns_ms=_this.cdns_cache.received-_this.cdns_cache.sent;return this.wait()},function catch$(err){var s=err.message||err.statusText||""+err||"unknown error";_this.zperr({id:"bwsaver_err_bootstrap_failed",err:s,add_log:true});_this.log.info("get_cdns failed with err "+s);if(!_this.cdns.length&&!_this.adaptive||_this.cdns.length&&!_this.cdns.has_usable()){_this.onerror(s,{fallback:true,reason:"get_cdns_failed_and_no_resources"})}},function finally$(){if(!_this.cdns_cache.received)_this.cdns_cache.received=date.monotonic()}])};Bwsaver.prototype.get_fake_cdn_bandwidth=function(){return this.method&&this.method.fake_cdn&&this.method.fake_cdn.get_progress_bw()};Bwsaver.prototype.enable_origin=function(){this.origin_enabled=true;this.cdns.forEach(function(c){if(c.is_origin())c.enable()})};Bwsaver.prototype.disable_origin=function(){this.origin_enabled=false;this.cdns.forEach(function(c){if(c.is_origin())c.disable()})};Bwsaver.prototype.add_origin_url=function(url,caller){return this.add_origin(zurl.parse(url).hostname,caller)};Bwsaver.prototype.add_origin=function(host){if(this.CG("cdn.send_reqs.origin.disable")||this.CG("cdn.send_reqs.https")&&this.CG("cdn.send_reqs.origin_https_unsupported")){return}var origin=this.cdns.add_origin({host:host}),_this=this;if(this.cache)this.cache.add_origin_filter_cdn(host);if(!this.origin_enabled)origin.disable();var on_origin_failed=function(){_this.origin_failed(this)};origin.on("failed",on_origin_failed);origin.on("disconnect",on_origin_failed);this.on("uninit",function(){origin.off("failed",on_origin_failed);origin.off("disconnect",on_origin_failed)})};Bwsaver.prototype.origin_failed=function(cdn){var s=this.get_stream_by_id("video");if(!this.origin_fallback.length||cdn.enabled&&cdn.fail<2&&cdn.disconnect<2&&this.cdns.can_get(s.slice,s.slice_sec,function(){return this!=cdn})){return}var host=this.origin_fallback.splice(0,1)[0];this.stats.origin_select_fallback++;this.add_origin(host,"origin_failed")};Bwsaver.prototype.origin_select=function(url){var groups=this.CGJ("origin_control")||[],i=0;for(;i<groups.length&&!groups[i].sources.includes(url.hostname);i++);if(i==groups.length)return url;var group=groups[i],geoip=util.geoip||{},rule;for(i=0;group.rules.length;i++){rule=group.rules[i];if(rule.select=="all")break;try{var match_fn=new Function("country","state","city","asn","return "+rule.select);if(match_fn(geoip.country,geoip.state,geoip.city,geoip.asn))break}catch(e){this.zperr({id:"bwsaver_origin_select_rule_error",info:{error:e,group:group,rule:rule.select}})}}if(i==group.rules.length)return url;if(!rule.policy||rule.policy=="dont_change")return url;var set=rule.set,rand_percent=0,random=rand.rand("origin_select");for(i=0;i<set.length;i++){if(rule.policy=="dynamic")this.cdns.add_origin({host:set[i].source,cost:set[i].apply||5});else{rand_percent+=parseFloat(set[i].apply)/100;if(random<rand_percent)break;if(!this.origin_fallback.includes(set[i].source))this.origin_fallback.push(set[i].source)}}if(i==set.length||set[i].source==url.hostname)return url;if(!this.origin_fallback.includes(url.hostname))this.origin_fallback.push(url.hostname);url.hostname=set[i].source;url.host=url.hostname+(url.port?":"+url.port:"");return url};Bwsaver.prototype.init=function(opt){load_perf.push("bwsaver_init_start",this.zone);this.events=new events;this.dump={};var player=this.player=opt.player_obj;this.tech=opt.tech||(opt.player_obj||{}).tech;var link_type=this.player.get_video_type_name(opt.url);this.adaptive=util.get_adaptive_by_type(link_type);this.media=util.is_progressive(link_type)?link_type:"mp4";this.preload=this.player.preload||this.player.html5&&this.player.html5.preload;this.offset=0;this.fullsize=0;this.strategy=this.CG("cdn.strategy","performance");switch(this.strategy){case"performance":this.low_watermark_sec=40;this.lowcost_watermark_sec=20;this.urgent_watermark_sec=10;this.compare_ratio=1;break;case"offload":this.low_watermark_sec=60;this.lowcost_watermark_sec=10;this.urgent_watermark_sec=5;this.compare_ratio=1.2;break;case"full_offload":this.low_watermark_sec=60;this.lowcost_watermark_sec=60;this.urgent_watermark_sec=10;this.compare_ratio=1;this.CE("cdn.send_reqs.origin.disable");break}this.low_watermark_sec=this.CG("cdn.bwsaver.low_watermark_sec",this.low_watermark_sec);this.lowcost_watermark_sec=this.CG("cdn.bwsaver.lowcost_watermark_sec",this.lowcost_watermark_sec);this.urgent_watermark_sec=this.CG("cdn.bwsaver.urgent_watermark_sec",this.urgent_watermark_sec);this.compare_ratio=this.CG("cdn.bwsaver.compare_ratio",this.compare_ratio);this.slice_sec=this.CG("cdn.bwsaver.slice_sec",5);this.resume_sec=this.CG("cdn.bwsaver.resume_sec",5);this.track_rate=this.CG("cdn.bwsaver.track_rate",zutil.is_mocha()?0:250);this.use_time_poll=this.CG("cdn.bwsaver.use_time_poll");this.chunk_size=this.url=this.prev_policy=null;this.start_pos=0;this.url_s=opt.url;this.url=zurl.parse(this.url_s);this.origin_fallback=[];this.serve_log_arr=[];this.memory_cache={start:[],last:[]};this.opt=opt;this.buf_sec_last_ts=this.buf_sec_last=undefined;this.track_state_s=this.needed_sec_s=undefined;this.player_events=[];this.extra_singles=[];var browser=user_agent.guess_browser();var guess=user_agent.guess();this.log.info("bws init: "+guess.os+" "+guess.version+", "+(browser.opera?"opera":browser.browser)+" "+browser.version+", "+this.tech+(this.adaptive||"")+", "+player.name+" strategy "+this.strategy);if(typeof location!=="undefined"&&location.protocol=="https:"||this.url.protocol=="https:"){this.CE("cdn.send_reqs.https")}this._onseek=this.fallback_wrapper(this.onseek,"onseek");var _this=this;this._ontimeupdate=this.fallback_wrapper(this.use_time_poll?this.ontimeinterval:this.ontimeupdate,"ontimeupdated");this._onvisibility_end=this.fallback_wrapper(function(){this.pause("visibility");this.no_visibility=true});this._onvisibility_start=this.fallback_wrapper(function(){this.no_visibility=false;this.resume()});this.stats={served:0,cached:0,viewed:new map.Map,start_sec:0,viewed_sec:0,buf_sec:0,buf_n:0,single_copy_rank:0,max_num_reqs:0,max_num_reqs_n:0,max_max_num_reqs:0,max_sz_reqs:0,max_sz_reqs_n:0,buf_stall:0,max_max_sz_reqs:0,served_fast_bytes:0,served_fast_sec:0,too_slow:{},rate_decrease:0,seeks:0,parallel_n:0,parallel_overloaded_n:0,parallel_clone_n:0,sec_obtained:0,sec_obtained_n:0,cdn_switch:{h2h:0,o2h:0,h2o:0,o2o:0},early_req:{n:0,ms:0,miss_n:0},buffering:{start:0,seek:0,none_can_get:0,other:0},serve_if_fast:{wait_ms:0,n:0},memory_cache:{start:[],mid:[]},origin_select_fallback:0,unicode_bom:0,seg_mismatch:0,get_cdns_ms:0,replace_agent_n:0,quality_switch:{n:0,up:0,down:0,miss:0,under_10sec:0,miss_10sec:0},ranges_unsupported:0,head_unsupported:0,origin_head_n:0,origin_ranges_n:0,manifest_loader:{}};this.cdns_cache=opt.get_cdns||{single_copy:[],fast:[],popular:[]};this.streams=[];this.ids=0;this.tm_create=date.monotonic();
this.last_time_pos=this.player.get_pos();this.cdns=new cdnlist.Cdn_list({save_to:this.CG("cdn.cache.cdnlist.disable")?null:"hola_cdnlist_cache",cdns:opt.cdns,zone:this.zone});(opt.cdns||[]).forEach(function(c){var cdn=_this.cdns.get_by_host(c.host);cdn.enabled=!c.disabled});var purged_md5=[];this.cdns.on("message.purge_notify",function(cdn,msg){if(!msg.opt||!msg.opt.urls||msg.purge_handled||typeof fetch=="undefined"){return}msg.purge_handled=true;var conf_md5=msg.opt.md5;if(conf_md5){if(purged_md5.includes(conf_md5))return;purged_md5.push(msg.opt.md5)}var urls=msg.opt.urls;urls.forEach(function(url){if(!url)return;var protocol=zutil.is_mocha()?"http:":location.protocol;url=protocol+url;fetch(url,{method:"get",redirect:browser.browser!="firefox"?"manual":undefined,headers:{"Cache-Control":"must-revalidate,max-age=0"}}).catch(function(){})});_this.zperr({id:"bwsaver_cache_clean",info:{urls:urls}})});if(!this.CG("cdn.cache.disabled")){this.cache=new cache.Cache(this.url,this.cdns,{cache_ranges:!this.adaptive&&!this.CG("cdn.send_reqs.disable_url_ranges"),zone:this.zone,adaptive:this.adaptive})}if(zutil.is_mocha())this.cdn_svc.jtest_bws=this;this.unittest=new unittest.Unittest({origin:this.url.hostname,url:this.url_s,adaptive:this.adaptive,cache:this.cache,bws:this,player:player,vc_id:opt.vc_id});if(this.CG("cdn.play_log")||Math.random()<.001)this.play_log=new play_log.Play_log({bws:this});this.tracker=new aggregator({log:this.log.reset_module()});this.on("req_start",function(req){_this.tracker.init_stream(req.tm_create)});this.on("req_complete",function(req){_this.tracker.end_stream(req.tm_create)});this.on("ondata",function(d){_this.tracker.ondata(d.size)});this._onplay=function(e){if(player.is_ad_active())return;load_perf.push("player_onplay",this.zone);this.track_state("on_play");if(this.parser)this.parser.emit("on_play")};this.onplay=this._onplay.bind(this);this._onseeking=function(e){if(this.skip_seek())return;this.prev_policy=null;this.served_sec=0;var pos=player.get_pos();this.log.info("seeking to position "+pos);this.start_pos=pos};this.onseeking=this._onseeking.bind(this);if(opt.stats_debug!==false){this.stats_debug_interval=setInterval(function(){this.cdn_svc.send_stats_debug()}.bind(this),10*date.ms.SEC)}this.zone.info.player_type=player.type;this.zone.info.bwsaver="enabled";if(player.type!="hola"){this.zone.info.tech=this.tech;this.zone.info.stream_type="http"}this.get_cdns();if(this.adaptive){var args={bws:this,adaptive:this.adaptive,player:player};var use_hola_adaptive=zutil.is_mocha()?this.CG("cdn.method.hola_adaptive"):this.adaptive=="hls"&&util.is_enabled(hola_adaptive)&&hola_adaptive.supported(player);if(use_hola_adaptive)this.method=new hola_adaptive.Method(args);else{util.assert_enabled(adaptive,"adaptive module is required but disabled");this.method=new adaptive.Method(args)}this._onseeked=this.fallback_wrapper(this.onseeked,"onseeked");this.player_on("seeked",this._onseeked)}else{util.assert_enabled(progressive,"progressive module is required but disabled");this.method=new progressive.Method({bws:this,player:player});this.media_src_init(opt.parsers)}this.emit("method_init",this.method);if(this.use_time_poll)this.time_poll_id=setInterval(this._ontimeupdate,this.track_rate);else this.player_on("timeupdate",this._ontimeupdate);this.player_on("play",this.onplay);this.player_on("seeking",this.onseeking);this.player_on("visibility_end",this._onvisibility_end);this.player_on("visibility_start",this._onvisibility_start);if(!this.cdn_svc.jtest.delayed&&(this.adaptive||this.cdn_svc.jtest.start)){this.create_stream({from:this.from,to:this.to})}load_perf.push("bwsaver_init_finish",this.zone,true)};Bwsaver.prototype.cross_context_listen=function(subscribe){if(!this.CG("cdn.enable_xctx_events"))return;if(!subscribe)return this.on_cross_context_uninit();var _this=this,monitor_enabled;var on_buffer_monitor=this.fallback_wrapper(function(buffer_state){},"on_buffer_monitor");var on_next_started=this.fallback_wrapper(function(){_this.player.on("buffer_monitor",on_buffer_monitor);_this.player.extensions.buffer_monitor.enable();monitor_enabled=true});var on_uninit=function(){if(monitor_enabled)_this.player.extensions.buffer_monitor.disable();_this.player.off("post-started",on_next_started);_this.player.off("buffer_monitor",on_buffer_monitor);_this.off("uninit",on_uninit);delete _this.on_cross_context_uninit};this.player.once("post-started",on_next_started);this.on("uninit",this.on_cross_context_uninit=on_uninit)};Bwsaver.prototype.suspend=function(suspend,opt){var _this=this;opt=opt||{};this.emit(suspend?"suspend":"continue");this.log.info("bws "+(suspend?"suspend":"continue"));if(this.suspended=!!suspend){this.pause("suspend");if(!this.adaptive){this.parser_uninit();this.abort()}this.player_events.forEach(function(e){_this.player.off(e.event,e.callback)});return void this.cross_context_listen(true)}this.cross_context_listen(false);this.player_events.forEach(function(e){_this.player.on(e.event,e.callback)});this.restore_ts=date.monotonic();this.seek_ts=0;if(!opt.beforecomplete)this.resume()};Bwsaver.prototype.player_on=function(e,cb){this.player_events.push({event:e,callback:cb});if(!this.suspended)this.player.on(e,cb)};Bwsaver.prototype.player_off=function(e,cb){var o=this.player_events.find(function(o){return o.event==e&&o.callback==cb});if(!o)return;this.player.off(e,cb);this.player_events.splice(this.player_events.indexOf(o),1)};return E});
define("/svc/cdn/pub/cdn_svc.js",["/svc/cdn/pub/cdn.js","/svc/cdn/pub/stats.js","/svc/cdn/pub/stream.js","/util/events.js","/svc/cdn/pub/util.js","/util/rand.js","/util/date.js","/util/url.js","/util/util.js","/util/zerr.js"],function(cdn,stats,stream,events,util,rand,date,zurl,zutil,zerr){function log_from_zone(zone){return zone.log_get().set_module("cdn_svc")}function ProblemReporter(opt){this.zone=opt.zone;this.cdn_svc=opt.cdn_svc;this.url_s=opt.url;this.log=log_from_zone(this.zone);this.url=zurl.parse(this.url_s)}ProblemReporter.prototype.send_problem_report=function(o){var zperr=this.zone.perr_get();var bugid=+(Math.random()+"").slice(2);var player=this.cdn_svc.is_attached()&&this.cdn_svc.attached_stats.get_stats(true,true);o=o||{};var opt={id:"err_problem_report",add_log:true,full_log:true,player_logs:o.player_logs,full:o.full,info:{bugid:bugid,userid:o.userid,player:player}};if(this.cdn_svc.attached_bws)opt.filehead=this.cdn_svc.attached_bws.unittest.gen_test();zperr(opt);this.log.console(util.get_perr_link_msg(this.zone.loader.customer,bugid))};ProblemReporter.prototype.uninit=function(){};zutil.inherits(Cdn_svc,util.events);function Cdn_svc(opt){if(!(this instanceof Cdn_svc))return new Cdn_svc(opt);util.events.call(this);this.id="cdn_"+rand.rand("cdn_id");this.state="IDLE";this.jtest={}}Cdn_svc.prototype.is_idle=function(){return this.state=="IDLE"};Cdn_svc.prototype.is_disabled=function(){return this.state=="DISABLED"||this.is_suspended()&&!this.attached_stats};Cdn_svc.prototype.is_attached=function(){return this.state=="ATTACHED"||!!(this.is_suspended()&&this.attached_stats)};Cdn_svc.prototype.is_suspended=function(){return this.state=="SUSPENDED"};Cdn_svc.prototype.is_shutdown=function(){return this.state=="SHUTDOWN"};Cdn_svc.prototype.change_state=function(new_state,details){var prev_state=this.state;if(prev_state==new_state)return;var data=Object.assign({state:new_state},details&&{details:details});this.state=new_state;this.emit("state",data);if(prev_state=="IDLE")this.emit("started",data)};Cdn_svc.prototype.set_disabled=function(reason){if(!this.is_idle())return;this.change_state("DISABLED",reason)};Cdn_svc.prototype.attach_stats=function(opt){if(this.attached_stats)return;this.attached_stats=new stats.PlayerStats(opt)};Cdn_svc.prototype.detach_stats=function(opt){if(!this.attached_stats)return;this.attached_stats.uninit();this.attached_stats=undefined};Cdn_svc.prototype.attach_problem_reporter=function(opt){if(this.attached_problem_reporter)return;opt.cdn_svc=opt.cdn_svc||this;this.attached_problem_reporter=new ProblemReporter(opt)};Cdn_svc.prototype.detach_problem_reporter=function(){if(!this.attached_problem_reporter)return;this.detached_problem_reporter=this.attached_problem_reporter;this.attached_problem_reporter.uninit();this.attached_problem_reporter=undefined};Cdn_svc.prototype.attach_bw_saver=function(opt){var zperr=opt.zone.perr_get();if(this.attached_bws){zerr("cdn already attached");zperr({id:"bwsaver_err_already_attached"});throw new Error("cdn already attached")}opt.cdns=opt.zone.CG("cdn.bwsaver.cdns");opt.cdn_svc=this;this.log=log_from_zone(opt.zone);this.attached_bws=new cdn.Bwsaver(opt);if(this.attached_bws.closed)this.attached_bws=undefined;return this.attached_bws};Cdn_svc.prototype.detach_bw_saver=function(opt){this.detach_problem_reporter();if(!this.attached_bws)return;this.attached_bws.uninit(opt);this.attached_bws=undefined};Cdn_svc.prototype.attach=function(opt){if(!this.is_idle())return;this.emit_wrapped("attach",function(){if(opt.bwsaver){this.attach_stats(opt.stats);if(this.attach_bw_saver(opt.bwsaver))this.attach_problem_reporter(opt.problem_reporter)}else{this.attach_stats(opt.stats);this.attach_problem_reporter(opt.problem_reporter)}this.change_state("ATTACHED")}.bind(this))};Cdn_svc.prototype.shutdown=function(opt){if(this.is_shutdown())return;this.emit_wrapped("shutdown",function(){if(this.attached_bws)this.detach_bw_saver();if(this.attached_problem_reporter)this.detach_problem_reporter();if(this.attached_stats)this.detach_stats();this.change_state("SHUTDOWN")}.bind(this))};Cdn_svc.prototype.suspend=function(suspend,opt){this.emit_wrapped(suspend?"suspend":"restore",function(){if(this.attached_bws)this.attached_bws.suspend(suspend,opt);if(this.attached_stats)this.attached_stats.suspend(suspend,opt);this.change_state(suspend?"SUSPENDED":this.is_attached()?"ATTACHED":"DISABLED")}.bind(this))};Cdn_svc.prototype.emit_wrapped=function(event,action_fn){this.once(event,action_fn);this.emit(event)};Cdn_svc.prototype.send_stats_debug=util.try_wrapper(function(){if(!this.attached_bws||this.is_suspended()||this.attached_bws.stats_debug_sent){return}var zperr=this.attached_bws.zone.perr_get();var stats_all=this.attached_stats&&this.attached_stats.get_stats_all();var stat=stats_all&&stats_all.player&&stats_all.player.stat;if(!stat)return;if((stat.wait_ms||0)<5*date.ms.SEC&&!stats.is_bad_performance(stat)&&(!this.attached_bws.zone.CG("cdn.stats.buffering_log")||!stat.wait_ms)){return}this.attached_bws.stats_debug_sent={stats:stats_all,unittest:this.attached_bws.unittest.gen_test()||"no unittest"};this.log.notice("sending stats debug",stat);zperr({id:"stats_debug",info:{only_stats:!this.attached_bws},add_log:true,extra:this.attached_bws.stats_debug_sent.stats,filehead:this.attached_bws.stats_debug_sent.unittest})});return Cdn_svc});
define("/svc/cdn/pub/player_util.js",["/util/util.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/util.js","/util/url.js","/svc/cdn/pub/log.js","/util/etask.js"],function(zutil,cdnlist,util,zurl,log,etask){var E={};var assign=Object.assign;E.Player=function(opt){var _this=this;util.call_super(E,this);this.zone=opt.zone;this.zperr=opt.zone.perr_get();this.log=this.log||opt.zone.log_get().set_module("player_util");this.on("wrapper.attach_to_player",function(){_this.get_est_bytes()});function rm_seek_hook(){if(!_this.seek_hook)return;_this.seek_hook.remove();_this.seek_hook=undefined}this.on("wrapper.zone_init",rm_seek_hook);this.on("uninit",rm_seek_hook);this.on("missing_idr",function(){if(_this.seek_hook)return;if(util.is_firefox&&+util.browser.version>=51&&_this.html5){_this.seek_hook=util.inject_hook(_this.html5,"currentTime",{set:function(e,args){if(_this.is_buffered(args[0])||args[0]==0)return;_this.log.warn("Due to firefox bug "+"https://bugzilla.mozilla.org/show_bug.cgi?id=1345808"+" of handling seeks in video encodings with missing "+"IDR in random access points, seek is disabled");e.set_handled()}})}})};zutil.inherits(E.Player,util.events);E.Player.prototype.emit_external=function(e,data){var container=this.get_container()||{};if(container.dispatchEvent)container.dispatchEvent(assign(util.new_event(e),{data:data}))};E.Player.prototype.get_current_buffer=function(){var pos=this.get_pos()||0,b=this.get_buffered()||[];for(var i=0;i<b.length;i++){if(pos>=b.start(i)&&pos<=b.end(i))return{from:b.start(i),to:b.end(i)}}return{from:pos,to:pos}};E.Player.prototype.get_buffered_sec=function(){var b=this.get_buffered()||[],sum=0;for(var i=0;i<b.length;i++)sum+=b.end(i)-b.start(i);return sum};E.Player.prototype.is_buffered=function(pos){var b=this.get_buffered()||[];for(var i=0;i<b.length;i++){if(pos>=b.start(i)&&pos<=b.end(i))return true}};E.Player.prototype.get_est_bytes=function(){return null};E.Player.video_sizes={};E.Player.prototype._get_media_size_server=function(){if(this.zone.CG("player.no_media_size_server"))return null;var _this=this,url=this.get_url();if(!url||util.is_blob_url(url))return null;if(E.Player.video_sizes[url]){var bytes=null,info=E.Player.video_sizes[url];if(info.total){bytes=info.total/this.get_duration()*this.get_buffered_sec()}var sizes=info.bw_per_res;if(sizes){var res=this.get_resolution();if(!res)return null;var bw;for(var i=0;i<sizes.length;i++){var size=sizes[i];var d=size.res.split("x");bw=size.bw;if(res.width<=d[0]||res.height<=d[1])break}bytes=bw*this.get_buffered_sec()}if(info.bw)bytes=info.bw*this.get_buffered_sec();return{bytes:bytes!=null?Math.round(bytes):bytes,src:"server"}}E.Player.video_sizes[url]={};etask([cdnlist.get_closest.bind(null,this.zone),function(closest){if(!closest)return;var route={customer:util.conf.customer,zone:_this.zone.name,url:url};if(!util.is_progressive(_this.get_video_type_name())){assign(route,{manifest:url,live:_this.is_live_stream()?1:0})}closest.send("get_video_size",route,function(e){if(!e||!e.res)return;E.Player.video_sizes[url]=e.res})}]);return null};E.Player.prototype.get_video_type_name=function(url){url=url||this.get_url();if(this.zone&&this.zone.url2type)url=this.zone.url2type(url);return util.get_video_type(url)};E.Player.prototype.get_video_type=function(){return""};E.Player.prototype.get_ad_scheme=function(){};E.Player.prototype.is_native_hls=function(){return false};E.Player.prototype.is_interrupted=function(){return false};E.Player.prototype.captions_supported=function(){return true};E.Player.prototype.check_playback_status=function(status_cb){var _this=this,html5=this.html5;if(!html5||!window.MediaSource)return void status_cb({state:"enabled",based_on:"env"});var enabled_reason=html5.readyState>html5.HAVE_NOTHING?"readystate":!util.is_hidden?"visibility":null;this.log.info("playback test request: %s",enabled_reason?"enabled based on "+enabled_reason:"test in progress");if(enabled_reason)return status_cb({state:"enabled",based_on:enabled_reason});status_cb({state:"checking"});var ms,v,on_sourceopen,on_loadedmetadata;var cleanup=function(){if(ms)ms.removeEventListener("sourceopen",on_sourceopen);if(html5)html5.removeEventListener("loadedmetadata",on_loadedmetadata);ms=v=html5=null};var done=function(reason){_this.log.info("playback test complete: enabled based on %s",reason);status_cb({state:"enabled",based_on:reason});cleanup()};on_sourceopen=function(){done("sourceopen")};on_loadedmetadata=function(){done("testfailure")};html5.addEventListener("loadedmetadata",on_loadedmetadata);ms=new window.MediaSource;ms.addEventListener("sourceopen",on_sourceopen);v=document.createElement("video");v.src=window.URL.createObjectURL(ms);return cleanup};E.Player.prototype.get_caps=function(caps){return assign({save_context:[]},caps)};E.Player.prototype.get_media_type=function(){return"video"};E.Player.prototype.get_media_size=function(){if(this.html5&&this.html5.videoWidth&&this.html5.videoHeight)return{width:this.html5.videoWidth,height:this.html5.videoHeight}};E.Player.prototype.is_bitrate_supported=function(){return true};E.Player.prototype.get_current_error=function(){};E.Player.prototype.enable_context_menu=function(){var c=this.get_container();if(!c)return;c.oncontextmenu=this.saved_oncontextmenu};E.Player.prototype.disable_context_menu=function(){var c=this.get_container();if(!c)return;this.saved_oncontextmenu=c.oncontextmenu;c.oncontextmenu=function(){return false}};E.Player.prototype.check_buffer=function(){};E.Player.prototype.is_any_ad_mode=function(){return this.is_ad_active()||this.is_ad_source()};E.Player.prototype.is_ad_source=function(){return this.zone.CG("kw.ads_only",false)};E.Player.prototype.is_ad_active=function(){return false};E.Player.prototype.is_ad_loading=function(){return false};E.Player.prototype.get_ad_state=function(){return!this.is_ad_active()?"IDLE":this.is_ad_loading()?"LOADING":"PLAYING"};E.Player.prototype.get_captions_track=function(){return-1};E.Player.prototype.set_captions_track=function(track){};E.Player.prototype.play_src=function(src){};E.Player.prototype.is_seeking=function(){return this.html5&&this.html5.seeking};E.Player.prototype.muted=function(v){if(!this.html5)return;if(v===undefined)return this.html5.muted;this.html5.muted=v};E.Player.prototype.volume=function(v){if(!this.html5)return;if(v===undefined)return this.html5.volume;this.html5.volume=v};E.build_flash_api=function(_this){function call_api(name,check){var f,slice=Array.prototype.slice;if(_this.swf&&(f=_this.swf["hola_"+name]))return check?!!f:f.apply(_this.swf,slice.call(arguments,2))}return{_call_api:call_api,set_bandwidth:call_api.bind(null,"setBandwidth",false),version:call_api.bind(null,"version",false),avail_version:call_api.bind(null,"version",true),settings:call_api.bind(null,"settings",false),avail_settings:call_api.bind(null,"settings",true),set_timeout:call_api.bind(null,"setTimeout",false),avail_set_timeout:call_api.bind(null,"setTimeout",true)}};return E});
define("/svc/cdn/pub/dom_util.js",[],function(){var E={};E.get_elm_resolution=function(elm){var st=elm&&getComputedStyle(elm);if(!st||isNaN(parseInt(st.width))||isNaN(parseInt(st.height)))return;var full_screen=!(document.fullScreenElement===null||document.msFullscreenElement===null||document.mozFullScreen!==undefined&&!document.mozFullScreen||document.webkitIsFullScreen!==undefined&&!document.webkitIsFullScreen);return{width:parseInt(st.width,10),height:parseInt(st.height,10),full_screen:full_screen}};E.get_full_elm_selector=function(elm){return elm.tagName.toLowerCase()+(elm.id?"#"+elm.id:"")+(elm.className?"."+elm.className.replace(/\s+/g,"."):"")};E.closest=function(elm,selector){if(elm.closest)return elm.closest(selector);if(elm.matches){if(!document.documentElement.contains(elm))return null;do{if(elm.matches(selector))return elm;elm=elm.parentElement}while(elm)}return null};return E});
define("/svc/cdn/pub/flashls.js",["/svc/cdn/pub/map.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/jsurlstream.js","/util/version_util.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js"],function(map,zutil,util,jsurlstream,version_util,player_util,dom_util){var E={};var api=util.get_api();var version_cmp=version_util.cmp;function is_state_waiting(state){return/BUFFERING/.test(state)}function is_state_idle(state){return state=="IDLE"}function is_state_playing(state){return state=="PLAYING"||state=="PLAYING_BUFFERING"}function is_state_paused(state){return!is_state_idle(state)&&!is_state_playing(state)}var loading_e=[];util.on_window_message(function(e){if(e.data&&e.data.id=="flashls.hlsEventManifestLoading")loading_e.push(e)});function ensure_swf_init(swf,ready){var pver;if(!swf.hola_version||!(pver=swf.hola_version().patch_version)||version_cmp(pver,"1.0.17")>0&&version_cmp(pver,"2.0.0")<0||version_cmp(pver,"2.0.3")>0){return ready()}try{swf.hola_hls_get_state();ready()}catch(e){setTimeout(ready,0)}}E.Player=function(opt){var _this=this;util.call_super(E,this,null,opt);this.player_id=opt.player_id||1;this.name="flashls";this.event_list=["error","timeupdate","state","waiting","play","pause","seeking","seeked","quality_level","ended","started","manifest_parsed","hlsNew","dispose","fragmentloaded","level_loaded","live_manifest"];this.swf=opt.flashls.flashObject||opt.flashls;var fapi=this.flash_api=player_util.build_flash_api(this);if(this.swf.hola_hls_version){fapi.version=fapi._call_api.bind(null,"hls_version",false);fapi.avail_version=fapi._call_api.bind(null,"hls_version",true);fapi.set_bandwidth=fapi._call_api.bind(null,"hls_setBandwidth",false)}ensure_swf_init(this.swf,function(){_this.swf_ready=true});this.state=this.swf_ready&&this.swf.hola_hls_get_state?this.swf.hola_hls_get_state():"IDLE";this.flashls=opt.flashls;this.vjs=this.video=opt.vjs;this.tech="flash";this.level_url={};this.log=this.zone.log_get().set_module("flashls");this.live_stream=undefined;if(this.swf.hola_settings)this.swf.hola_settings({player_id:this.player_id});if(this.vjs){this.on("wrapper_attached",function(){_this.vjs.trigger("hola.wrapper_attached")});this.on("wrapper_detached",function(){_this.vjs.trigger("hola.wrapper_detached")})}this.segment_from_flash=function(level,segment){return{playlist_url:level.url,bitrate:level.bitrate,url:segment.url,duration:segment.duration,media_index:segment.seqnum}};this.add_level_from_flash_ex=function(level){var _level={url:level.url,bitrate:level.bitrate,segments:[],attributes:{bandwidth:level.bitrate,audio:level.audio},id:level.index};if(level.width!=undefined&&level.height!=undefined){_level.attributes.resolution={width:level.width,height:level.height}}if(level.fragments){level.fragments.forEach(function(s){var segment=this.segment_from_flash(level,s);_level.segments.push(segment);_level.segments["media_index_"+s.seqnum]=segment}.bind(this))}this.levels[_level.url]=_level;this.level_url[level.index]=_level.url;return _level};this.get_levels_async=function(){if(!this.swf.hola_hls_get_levels_async||this.levels_waiting)return;this.swf.hola_hls_get_levels_async();this.levels_waiting=true};api.onFlashlsEvent=function(data){_this.on_msg({data:data})};this.on_msg=function(e){if(!e.data||e.data.player_id!==undefined&&e.data.player_id!=_this.player_id){return}var id=e.data.id,action=e.data.action;if(action=="mako_player.error"){_this.emit("error",{reason:"other",message:"waiting_over_10sec"});return}if(!id)return;if(e.data.mediatime){_this.position=e.data.mediatime.position||0;_this.live_sliding=e.data.mediatime.live_sliding||e.data.mediatime.live_sliding_main||0;_this.buffer=e.data.mediatime.buffer;_this.obtained=e.data.mediatime.obtained||0}var state=e.data.state;switch(id){case"flashls.hlsEventMediaTime":_this.emit("timeupdate",_this.position);return;case"flashls.hlsPlaybackState":_this._change_state(state);if(is_state_waiting(state))_this.emit("waiting");else if(state=="PLAYING")_this.emit("play");else if(state=="PAUSED")_this.emit("pause");return;case"flashls.hlsSeekState":if(e.data.seek_pos){_this.position=e.data.seek_pos;_this.buffer=e.data.buffer;_this.live_sliding=0}if(state=="SEEKING")_this.emit("seeking");else if(state=="SEEKED")_this.emit("seeked");return;case"flashls.hlsEventLevelSwitch":_this.level=e.data.level;_this.emit("quality_level");return;case"flashls.hlsEventPlayBackComplete":_this.log.notice("flashls.js ended");_this.emit("ended");return;case"flashls.hlsEventManifestParsed":return void _this.emit("manifest_parsed");case"flashls.hlsNew":return void _this.emit("hlsNew",e.data);case"flashls.hlsDispose":_this.log.notice("flashls.hlsDispose",e.data);_this.emit("dispose",e.data);return;case"flashls.error":var err=e.data.error||{};_this.log.err("flashls.error",err.msg);var list=["other","manifest_load","manifest_load","manifest_parse","media_load","media_load","media_decode","manifest_load","manifest_load","manifest_parse","media_decode"];_this.emit("error",{reason:list[err.code]||"other",message:err.msg||"unknown",url:err.url});return;case"flashls.hlsEventFragmentLoaded":var m=e.data.loadMetrics;_this.emit("fragmentloaded",{loadtime:m.frag_processing_time||m.processing_duration});_this.bandwidth=m.bandwidth;return;case"flashls.hlsEventLevelEndList":_this.live_stream=false;return;case"flashls.hlsEventStreamTypeDidChange":_this.live_stream=e.data.streamType=="LIVE";return;case"flashls.hlsPlayListDurationUpdated":_this.duration=e.data.duration;return;case"flashls.hlsAsyncMessage":if(e.data.type!="get_levels"||!e.data.msg)return;_this.levels=_this.levels||{};e.data.msg.forEach(function(level){_this.add_level_from_flash_ex(level)});_this.levels_waiting=false;_this.emit("level_loaded");return;case"flashls.hlsEventLevelLoaded":var _level;if(e.data.level){_this.levels=_this.levels||{};_level=_this.add_level_from_flash_ex(e.data.level)}else if(!_this.levels)_this.get_levels();if(_this.is_live_stream()){_this.emit("live_manifest",{url:_level?_level.url:_this.get_current_level(),format:"m3u8"})}_this.emit("level_loaded");return}};this.on_msg_reset=util.on_window_message(this.on_msg);for(var i=0;i<loading_e.length;i++){var e=loading_e[i];if(e.data.player_id!==undefined&&e.data.player_id!=_this.player_id)continue;if(this.is_idle())this._change_state("LOADING");loading_e.splice(i,1);break}};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){this.on_msg_reset();api.onFlashlsEvent=undefined};E.Player.prototype.set_cdn_mode=function(on,hap){this.swf.hola_settings({hls_mode:!!on,mode:on?hap?"hola_adaptive":"adaptive":"native"})};E.Player.prototype.get_video_type=function(){return this.vjs?this.vjs.currentType():""};E.Player.prototype.is_autostart=function(){return this.vjs&&this.vjs.autoplay()};E.Player.prototype.get_url=function(){return this.swf.hola_hls_get_video_url()};E.Player.prototype.seek=function(ms){this.log.warn("XXX flashls stub")};E.Player.prototype.get_pos=function(){return(this.position||0)+(this.live_sliding||0)};E.Player.prototype.refresh_buffered=function(){};E.Player.prototype.get_buffered=function(){var ret={};var first_ts=this.get_pos();var last_ts=first_ts+(this.buffer||0);ret.length=first_ts==last_ts?0:1;ret.start=function(i){return first_ts};ret.end=function(i){return last_ts};return ret};E.Player.prototype.get_duration=function(){if(this.is_idle())return 0;return this.is_live_stream()?Infinity:this.duration||this.swf.hola_hls_get_duration()};E.Player.prototype.is_live_stream=function(){if(this.live_stream!==undefined)return this.live_stream;if(!this.swf.hola_hls_get_type)return this.live_stream=false;var type=this.swf.hola_hls_get_type();return type&&(this.live_stream=type=="LIVE")};E.Player.prototype.discontinuity=function(sbuf){this.log.warn("XXX flashls stub")};E.Player.prototype.play=function(){this.log.notice("XXX play stub")};E.Player.prototype.pause=function(){this.log.notice("XXX pause stub")};E.Player.prototype.play_url=function(url,pos,is_paused,video_type){var vjs=this.vjs;if(!vjs)return this.log.notice("XXX play_url stub");setTimeout(function(){vjs.src({src:url,type:video_type});vjs.on("loadedmetadata",function(){vjs.off("loadedmetadata");if(pos)vjs.currentTime(pos);if(!is_paused)vjs.play()})})};E.Player.prototype.enable_data_mode=function(on_sourceopen){this.log.warn("XXX flashls stub")};E.Player.prototype.disable_data_mode=function(){};E.Player.prototype._change_state=function(state){var prev=this.state;if(prev==state)return;this.state=state;if(prev=="IDLE"){this.log.notice("flashls.js started");this.emit("started",this.get_url())}this.emit("state",state)};E.Player.prototype.get_state=function(){return this.state};E.Player.prototype.is_playing=function(){return is_state_playing(this.get_state())};E.Player.prototype.is_paused=function(){return is_state_paused(this.get_state())};E.Player.prototype.is_idle=function(){return is_state_idle(this.get_state())};E.Player.prototype.get_container=function(){return this.swf};E.Player.prototype.get_levels=function(cached){if(cached&&this.levels)return this.levels;if(this.is_idle())return{};var levels=this.swf.hola_hls_get_levels(),ret={};if(!levels||!levels.length)return ret;for(var idx=0;idx<levels.length;idx++){var level=levels[idx];if(ret[level.url]||!level.fragments)continue;var _level={url:level.url,segments:[],bitrate:level.bitrate};ret[level.url]=_level;this.level_url[idx]=level.url;for(var j=0;j<level.fragments.length;j++){_level.segments.push(this.segment_from_flash(level,level.fragments[j]))}}return this.levels=ret};E.Player.prototype.get_playlists=function(){var ret=[];if(!this.levels)return void this.get_levels_async();if(!this.levels)return;zutil.forEach(this.levels,function(v){if(!v.attributes||!v.attributes.audio)ret.push(v)});return ret.length?ret:undefined};E.Player.prototype.get_current_playlist=function(with_segments){};E.Player.prototype.get_segment_info=function(url){var res;if(this.levels){for(var idx in this.levels){if(this.levels[idx].segments){if(res=this.levels[idx].segments.find(function(v){return v.url===url})){return res}}}}this.get_levels_async();if(!this.swf.hola_hls_get_segment_info)return;return(res=this.swf.hola_hls_get_segment_info(url))&&this.segment_from_flash(res.level,res.fragment)};E.Player.prototype.get_bitrate=function(){if(this.is_idle())return 0;var level=this.get_current_level();if(level&&this.levels&&this.levels[level])return this.levels[level].bitrate;this.get_levels_async();if(this.swf.hola_hls_get_bitrate)return this.swf.hola_hls_get_bitrate();this.get_levels();if(!this.levels)return 0;return this.levels[level]?this.levels[level].bitrate:0};E.Player.prototype.get_current_fragment=function(){if(!this.swf.hola_hls_get_current_fragment)return;var frag=this.swf.hola_hls_get_current_fragment();return frag.url?{index:frag.index,qid:frag.level,url:frag.url,duration:frag.duration}:{url:frag}};E.Player.prototype.get_current_level=function(){if(this.is_idle())return;var level=this.level,from_flash=false,_this=this;if(level===undefined){if((level=this.swf.hola_hls_get_level())===undefined)return;from_flash=true}function level2url(level,from_flash){if(!/^[0-9]+$/.test(level))return level;if(!_this.level_url[level]){if(!from_flash){_this.get_levels_async();if((level=_this.swf.hola_hls_get_level())!==undefined)return level2url(level,true)}_this.get_levels()}return _this.level_url[level]}return this.level=level2url(level,from_flash)};E.Player.prototype.get_bandwidth=function(){return this.bandwidth||0};E.Player.prototype.get_resolution=function(){return dom_util.get_elm_resolution(this.swf)};E.Player.prototype.init_adaptive=function(adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.init_adaptive(this,adaptive)};E.Player.prototype.ondata_adaptive=function(chunk,adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.ondata_adaptive(chunk,this,adaptive)};E.Player.prototype.get_decoded_frames=function(){};E.Player.prototype.get_dropped_frames=function(){};E.is_hola_flashls_object=function(el){return el&&el.hola_version&&el.hola_version().flashls_version};return E});
define("/svc/cdn/pub/shaka.js",{__stub:1});
define("/svc/cdn/pub/dash.js",{__stub:1});
define("/svc/cdn/pub/dailymotion.js",["/util/util.js","/svc/cdn/pub/util.js","/util/date.js","/util/zerr.js","/util/version_util.js","/svc/cdn/pub/log.js"],function(zutil,util,date,zerr,version_util,log){var E={};var ERR=util.ERR;var assign=Object.assign;E.Module=function(opt){var _this=this,loader=window.hola_cdn;var zperr=opt.zone.perr_get();util.events.call(this);this.name="dailymotion";this.event_list=["started","error","quality_level","manifest_parsed","manifest_loaded","level_loaded","detached","seg_stats","buf_stats","level_updated","frag_load_stats","system_seek"];this.levels=undefined;this.bitrate={};this.level_url={};this.zone=opt.zone;this.log=this.zone.log_get().set_module("dailymotion");this.dailymotion=opt.dailymotion;this.player=opt.player;this.vjs=opt.vjs;this.hls=this.dailymotion.constructor;this.state=this.get_url()&&(!this.player.state||this.player.state=="IDLE")?"PAUSED":this.player.state||"IDLE";this.log.notice("using hls.js version "+this.hls.version);this.zone_watch=this.zone.conf_watch([{conf:"util.log.dailymotion",onchange:function(ctx,from,to){_this.extended_logs=!!to;if(to&&!_this.dailymotion.holaLog&&loader){_this.dailymotion.holaLog=loader._create_hola_hls_log(_this.zone.CG.bind(_this.zone))}},uninit:function(){delete _this.dailymotion.holaLog}},{conf:"mode",onchange:function(ctx,from,to){if(!_this.dailymotion._proxy||!to)return;_this.dailymotion.trigger("hlsHolaMode",to);_this.hls=_this.dailymotion.constructor}},{conf:"loader.dailymotion.config",onchange:function(ctx,from,to){if(to)assign(_this.dailymotion.config,to)}}]);this.est_bytes=0;function change_state(state){var prev=_this.state;if(prev==state)return;_this.state=state;if(prev=="IDLE")_this.emit("started",_this.get_url())}this.dm_handlers={};this.dm_handlers[this.hls.Events.MANIFEST_LOADING]=function(e,d){var prev=_this.state;if(_this.zone.info.video_url!=d.url)change_state("IDLE");change_state(prev=="PLAYING"?prev:"PAUSED")};this.dm_handlers[this.hls.Events.MANIFEST_LOADED]=function(){_this.emit("manifest_loaded");if(_this.state!="PLAYING")change_state("PAUSED")};this.player.on("pre-state",change_state);this.dm_handlers[this.hls.Events.MEDIA_DETACHED]=function(){_this.emit("detached")};this.dm_handlers[this.hls.Events.LEVEL_LOADED]=function(e,lvl){_this.emit("level_loaded",lvl.level)};this.dm_handlers[this.hls.Events.ERROR]=function(e,d){var d_resp=d.response||{},d_err=d.err||{};var type=d.details,ed=_this.hls.ErrorDetails,r;var sys_seeks=[ed.BUFFER_SEEK_OVER_HOLE,ed.BUFFER_NUDGE_ON_STALL];var err={type:d.type,details:type,fatal:d.fatal,url:d.url,frag_url:d.frag&&d.frag.url,reason:d.reason||"",hls_err:d.err&&d.err.stack,status:d_resp.status};_this.log[d.fatal?"err":"info"]("Dailymotion "+(d.fatal?"fatal error":"warn")+" "+d.type+" "+type+(err.frag_url?" "+err.frag_url:"")+(d.reason?" reason "+d.reason:"")+" level "+d.level+" frag "+d.frag+" "+zerr.json(d));if(err.hls_err)_this.log[d.fatal?"err":"info"](err.hls_err);if(type==ed.BUFFER_STALLED_ERROR&&_this.extended_logs){var media=_this.dailymotion.media;err.stall=d.buffer>.5?"high":"low";_this.log.info(err.stall+" buffer stall, state "+media.readyState+" rate "+media.playbackRate+" buffer "+d.buffer)}if(sys_seeks.includes(type))_this.emit("system_seek");if(d.fatal)zperr({id:"player_dm_error",info:{err:err},delay:!d.fatal});if(!d.fatal)return;var map={MANIFEST_LOAD_ERROR:{reason:"manifest_load",url:d.url,status:d_resp.status},MANIFEST_LOAD_TIMEOUT:{reason:"manifest_load",url:d.url},MANIFEST_PARSING_ERROR:{reason:"manifest_parse",url:d.url,message:d.reason},MANIFEST_INCOMPATIBLE_CODECS_ERROR:{reason:"manifest_parse",url:d.url,message:d.reason},LEVEL_LOAD_ERROR:{reason:"manifest_load",url:d.url,status:d_resp.status,level:d.level},LEVEL_LOAD_TIMEOUT:{reason:"manifest_load",url:d.url,level:d.level},LEVEL_SWITCH_ERROR:{reason:"other",level:d.level,message:d.reason},FRAG_LOAD_ERROR:{reason:"media_load",url:err.frag_url},FRAG_LOOP_LOADING_ERROR:{reason:"media_load"},FRAG_LOAD_TIMEOUT:{reason:"media_load"},FRAG_DECRYPT_ERROR:{reason:"media_decode",message:d.reason},FRAG_PARSING_ERROR:{reason:"media_decode",message:d.reason},KEY_LOAD_ERROR:{reason:"manifest_load",url:err.frag_url,status:(d_resp.currentTarget||d_resp).status},KEY_LOAD_TIMEOUT:{reason:"manifest_load",url:err.frag_url},BUFFER_ADD_CODEC_ERROR:{reason:"media_decode",message:d_err.message},BUFFER_APPEND_ERROR:{reason:"media_decode",url:err.frag_url},BUFFER_APPENDING_ERROR:{reason:"media_decode"},BUFFER_STALLED_ERROR:{reason:"other"},BUFFER_FULL_ERROR:{reason:"other"},BUFFER_SEEK_OVER_HOLE:{reason:"other"},unknown:{reason:"other",message:"unknown"}};r=zutil.find(map,function(v,k){return type==ed[k]});_this.emit("error",r?assign({message:type},r):map.unknown)};this.dm_handlers[this.hls.Events.LEVEL_UPDATED]=function(e,lvl){if(!_this.levels)_this.get_levels();else _this.update_levels();_this.emit("level_updated",lvl.level)};this.dm_handlers[this.hls.Events.FRAG_PARSING_DATA]=function(e,data){if(data.endDTS>=data.startDTS&&data.endDTS-data.startDTS<20&&(data.deltaPTS||0)<2){return}var sc=util.get_hls_sc(_this.dailymotion),frag=sc.fragCurrent||{};zperr({id:"segment_len_error",info:{sn:frag.sn,level:frag.level,s_dts:data.startDTS,e_dts:data.endDTS,delta:data.deltaPTS||0},add_log:true})};if(this.hls.Events.FRAG_STATISTICS){var prev_st,sent;this.dm_handlers[this.hls.Events.FRAG_STATISTICS]=function(e,d){function fmt(keymap){var res="",obj;["idr","indr","sei"].forEach(function(name){if(!keymap[name]||!keymap[name].length)return;obj=keymap[name].map(function(e){return e.sn});res+=name+"=["+obj.join(",")+"] "});["sps","pps"].forEach(function(name){if(obj=keymap[name]&&keymap[name][0]){try{res+=name+"=["+obj.join(",")+"] "}catch(e){_this.log.info("abnormal object: %s %s",name,Object.prototype.toString.call(obj))}}});return res}if(_this.extended_logs){if(d.videoDurStd||d.audioDurStd||d.cttsError){_this.log.info("remux seg %d/%d ctts_err=%d, video_dur="+"%.2f/%.2f, audio_dur=%.2f/%.2f",d.segment,d.level,d.cttsError,d.videoDurAvg,d.videoDurStd,d.audioDurAvg,d.audioDurStd)}if(d.keymap){_this.log.info("remux seg %d/%d keymap: %s",d.segment,d.level,fmt(d.keymap))}}if(!sent&&prev_st&&prev_st.segment+1==d.segment&&!prev_st.keyFrames&&!d.keyFrames){zperr({id:"segment_no_keyframe",info:{sn:d.segment-1,video_source_error:"keyframe not found in continuos "+"segments",level:d.level}});sent=true}prev_st=d;if(d.audioGap){d=zutil.clone(d);d.audioGap={cnt:d.audioGap.length,min:Math.round(Math.min.apply(null,d.audioGap)),max:Math.round(Math.max.apply(null,d.audioGap))}}_this.emit("seg_stats",d)}}if(this.hls.Events.BUF_STATISTICS){this.dm_handlers[this.hls.Events.BUF_STATISTICS]=function(e,d){_this.emit("buf_stats",d)}}if(this.hls.Events.FRAG_BUFFERED){this.dm_handlers[this.hls.Events.FRAG_BUFFERED]=function(e,d){_this.emit("frag_load_stats",d)}}this.dm_handlers[this.hls.Events.FRAG_LOADED]=function(n,info){_this.est_bytes+=info.stats.loaded};var e;if(this.dailymotion.hola_events_cb){for(e in this.hls.Events){this.dailymotion.off(this.hls.Events[e],this.dailymotion.hola_events_cb)}}for(e in this.dm_handlers)this.dailymotion.on(e,this.dm_handlers[e])};zutil.inherits(E.Module,util.events);E.Module.prototype.get_url=function(){return this.dailymotion.url};E.Module.prototype.get_current_fragment=function(){var sc=util.get_hls_sc(this.dailymotion);if(!sc)return;var frag=sc.fragCurrent;return{index:frag.sn,qid:frag.level,url:frag.url,duration:frag.duration}};E.Module.prototype.is_live_stream=function(){var levels=this.dailymotion.levels;if(!levels)return;var loaded_lvl=levels.find(function(lvl){return lvl.details});return loaded_lvl&&!!loaded_lvl.details.live};E.Module.prototype.get_bitrate=function(){var level;try{level=this.dailymotion.currentLevel}catch(e){return 0}if(level<0){var frag=util.get_hls_sc(this.dailymotion).fragPrevious;level=frag?frag.level:this.dailymotion.loadLevel;if(typeof level!="number"||level<0)return 0}return this.dailymotion.levels[level].bitrate};E.Module.prototype.is_bitrate_supported=function(){var levels=this.dailymotion.levels;return levels&&levels.length>1||levels[0]&&levels[0].bitrate!==undefined};E.Module.prototype.get_levels=function(cached){if(cached&&this.levels)return this.levels;var levels=this.dailymotion.levels;var ret={},_this=this;if(!levels||!levels.length)return ret;levels.forEach(function(level,idx){var url=level.url.length&&level.url[0];var fragments=level.details&&level.details.fragments;if(!url||ret[url]||!fragments)return;var _level=ret[url]={url:url,level_idx:idx,segments:[]};var bitrate=_this.bitrate[url]=_level.bitrate=level.bitrate;_this.level_url[idx]=url;fragments.forEach(function(frag){_level.segments.push({playlist_url:url,media_index:frag.sn,duration:frag.duration,url:frag.url,bitrate:bitrate})})});return this.levels=ret};E.Module.prototype.update_levels=function(){var levels=this.dailymotion.levels;if(!levels||!levels.length)return;var _this=this,lvls=this.levels;levels.forEach(function(level,idx){var url=level.url.length&&level.url[0],old_url,_level,_segs;var fragments=level.details&&level.details.fragments;if(!url||!fragments||!(old_url=_this.level_url[idx])||!(_level=lvls[old_url])||!(_segs=_level.segments)){return}if(url!=old_url){lvls[url]=_level;delete lvls[old_url];_level.url=url;_this.level_url[idx]=url}for(var frag_idx in fragments){try{assign(_segs[frag_idx],{playlist_url:url,url:fragments[frag_idx].url})}catch(e){_this.log.info(e.stack);_this.log.info("oob seg update frag %d/%d",frag_idx,_segs.length);return}}});return lvls};E.Module.prototype.get_playlists=function(){var levels=this.dailymotion.levels,ret=[],p,_this=this;if(!levels)return;levels.forEach(function(level,idx){if(p=_this.get_playlist(idx,true))ret.push(p)});ret.sort(function(a,b){return Math.sign(a.bitrate-b.bitrate)});return ret.length?ret:undefined};E.Module.prototype.get_playlist=function(idx,with_segments){var levels=this.dailymotion.levels;if(!levels)return;var level=levels[idx];if(!level)return;var url=level.url.length&&level.url[0];var fragments=level.details&&level.details.fragments;if(!url)return;var p={playlist:url,url:url,level_idx:idx,attributes:{bandwidth:level.bitrate,audio:level.audioCodec,video:level.videoCodec}};var attr=p.attributes,bitrate=p.bitrate=attr.bandwidth;attr.live=level.details&&level.details.live;if(level.width!=undefined&&level.height!=undefined)attr.resolution={width:level.width,height:level.height};if(!with_segments||!fragments||!fragments.length)return p;p.segments=[];fragments.forEach(function(frag,i){var o={playlist_url:url,media_index:frag.sn,duration:frag.duration,url:frag.url,bitrate:bitrate,from:frag.byteRangeStartOffset,to:frag.byteRangeEndOffset};p.segments.push(o);p.segments["media_index_"+frag.sn]=o});return p};E.Module.prototype.get_current_playlist=function(with_segments){if(!util.get_hls_sc(this.dailymotion).bufferRange)return;var idx=this.dailymotion.currentLevel;return this.get_playlist(idx,with_segments)};E.Module.prototype.get_segment_info=function(){};E.Module.prototype.get_current_level=function(){if(!util.get_hls_sc(this.dailymotion).bufferRange)return;var level=this.dailymotion.currentLevel;if(level===undefined)return;if(!this.level_url[level])this.get_levels();return this.level_url[level]};E.Module.prototype.get_state=function(){return this.state};E.Module.prototype.is_paused=function(){return this.state=="PAUSED"};E.Module.prototype.is_playing=function(){return this.state=="PLAYING"};E.Module.prototype.is_idle=function(){return this.state=="IDLE"};E.Module.prototype.play=function(){var dm=this.dailymotion,media=dm.media;if(media)media.play()};E.Module.prototype.pause=function(){var dm=this.dailymotion,media=dm.media;if(media)media.pause()};E.Module.prototype.play_url=function(url,pos,is_paused){var vjs;if(vjs=this.vjs){setTimeout(function(){vjs.src(url);if(pos)vjs.currentTime(pos);if(!is_paused)vjs.play()});return}var dm=this.dailymotion,media=dm.media;if(!media)return;dm.detachMedia();dm.attachMedia(media);if(pos)media.currentTime=pos;if(!is_paused)media.play()};E.Module.prototype.get_est_bytes=function(){return{bytes:this.est_bytes,src:this.name}};E.Module.prototype.enable_data_mode=function(on_sourceopen){};E.Module.prototype.init_adaptive=function(adaptive){var hls=this.dailymotion,_this=this;var hola_hls=util.is_hola_hls_js(hls);this.old_floader=hls.config.fLoader;hls.config.fLoader=function(){return new Loader({log:_this.log,zone:_this.zone,adaptive:adaptive,hola_hls:hola_hls})};adaptive.on("uninit",function(){_this.dailymotion.config.fLoader=_this.old_floader});adaptive.on("seg_complete",function(req){util.update_fake_xhr(req)})};E.Module.prototype.init_ploader=function(ploader){var hls=this.dailymotion;var config={log:this.log,zone:this.zone,hls:hls,ploader:ploader};hls.config.pLoader=function(){return new Loader(config)}};E.Module.prototype.uninit_ploader=function(){var dm=this.dailymotion,p_ldr=dm.playlistLoader;if(!dm.config||!dm.config.pLoader)return;delete dm.config.pLoader;if(!p_ldr.loading||!p_ldr.loader)return;p_ldr.loader.abort();p_ldr.loader=null;p_ldr.load(p_ldr.url,p_ldr.id,p_ldr.id2)};E.Module.prototype.uninit=function(){this.events.removeAllListeners();for(var e in this.dm_handlers)this.dailymotion.off(e,this.dm_handlers[e]);this.uninit_ploader();this.zone_watch.uninit();var sc=util.get_hls_sc(this.dailymotion);var zperr=this.zone.perr_get();if(sc.skipCount)zperr({id:"dm_skip_cnt",info:{skip:sc.skipCount}})};function Loader(opt){this.log=opt.log;this.zone=opt.zone;this.CG=this.zone.CG.bind(this.zone);this.adaptive=opt.adaptive;this.hls=opt.hls;this.ploader=opt.ploader}Loader.prototype.destroy=function(){this.abort();this.fake_xhr=null};Loader.prototype.abort=function(){clearTimeout(this.timeoutHandle);if(this.ploader)return this.ploader.abort(this.ml_state);if(!this.fake_xhr)return;this.stats.aborted=true;var req=this.fake_xhr.req;if(!req||req.error==ERR.aborted||req.info.rate)return;var other=req.info.overloaded||req.info.clone;req.abort();if(other&&other.error!=ERR.aborted)other.abort();if(this.adaptive)this.adaptive.remove_segment(this.segment)};Loader.prototype.load=function(context,config,callbacks){var args;if(typeof context=="string"){args=Array.prototype.slice.call(arguments);if(typeof config=="string")args.splice(1,0,null)}else{var _on_progress=function(event,stats,context){callbacks.onProgress(stats,context)};var _on_success=function(event,stats,context){callbacks.onSuccess({url:context.url,data:event.currentTarget.response},stats,context)};var _on_error=function(event,context){callbacks.onError(event.currentTarget,context)};var _on_timeout=function(event,stats,context){callbacks.onTimeout(stats,context)};args=[context.url,{frag:context.frag},context.responseType,_on_success,_on_error,_on_timeout,config.timeout,config.maxRetry,config.retryDelay,_on_progress,context.frag,callbacks.onChunk]}if(this.context=args.splice(1,1)[0])this.context.url=args[0];this.stable_load.apply(this,args)};Loader.prototype.stable_load=function(url,responseType,onSuccess,onError,onTimeout,timeout,maxRetry,retryDelay,onProgress,frag,on_chunk){var _this=this;this.log.info("load "+url);this.stats={trequest:window.performance.now(),retry:0};this.url=url;if(!frag){var level_id=this.hls.playlistLoader.id;this.ml_state=this.ploader.load({url:url,is_master:level_id==null,id:level_id!=null?this.hls.levelController.levels[level_id].bitrate:undefined,level:level_id,onprogress:this.loadprogress.bind(this),onsuccess:function(event){onSuccess(event,_this.stats,_this.context)},onerror:function(event){onError(event,_this.context)},ontimeout:function(event){onTimeout(event,_this.stats,_this.context)},timeout:timeout});return}this.responseType=responseType;this.onSuccess=onSuccess;this.onProgress=util.is_hola_hls_js(this.hls)?function(ev,st){onProgress(st)}:onProgress;this.onTimeout=onTimeout;this.onError=onError;this.streaming=!this.CG("cdn.send_reqs.disable_streaming")&&!!(this.on_chunk=on_chunk);this.maxRetry=Math.max(maxRetry,3);this.retryDelay=retryDelay;this.timeout=timeout;this.timeoutHandle=setTimeout(this.loadtimeout.bind(this),timeout);this.load_internal()};Loader.prototype.load_internal=function(){this.fake_xhr={onprogress:this.loadprogress.bind(this),onchunkdata:this.onchunkdata.bind(this)};var segment=this.segment={url:this.url,fake_xhr:this.fake_xhr,playlist_id:"def",streaming:this.streaming};if(this.adaptive)this.adaptive.init_segment(segment);this.stats.tfirst=0;this.stats.loaded=0;this.stats.aborted=undefined};Loader.prototype.loadtimeout=function(event){this.log.info("timeout, req is "+this.fake_xhr.req.name);if(!this.CG("player.dailymotion.no_timeout"))this.onTimeout(event,this.stats,this.context)};Loader.prototype.loadprogress=function(event){var stats=this.stats;if(stats.tfirst===0)stats.tfirst=Math.max(window.performance.now(),stats.trequest);stats.loaded=event.loaded;if(event.lengthComputable)stats.total=event.total;if(this.onProgress)this.onProgress(event,stats,this.context)};Loader.prototype.onchunkdata=function(chunk){var stats=this.stats;if(stats.aborted)return;var req=chunk.req;this.fake_xhr.req=req&&req.info.overloaded&&!req.info.overloaded.error?req.info.overloaded:req;var segment=req.info.segment;if(!chunk.data||req.error){if(stats.retry<this.maxRetry){this.log.info("retry, req is "+req.name);this.destroy();setTimeout(this.load_internal.bind(this),this.retryDelay);this.retryDelay=Math.min(2*this.retryDelay,64e3);stats.retry++}else{clearTimeout(this.timeoutHandle);this.onError({currentTarget:this.fake_xhr},this.context)}return}this.fake_xhr.status=200;this.fake_xhr.response=chunk.data;this.fake_xhr.responseTime=Date.now();if(req.opt.streaming)this.fake_xhr.type="progress";if(!req.opt.streaming||req.xhr.readyState==req.xhr.DONE||req.xhr.readyState==req.xhr.LOADING&&req.xhr.total&&req.xhr.loaded==req.xhr.total){this.adaptive.indexer[segment.playlist_id].completed=segment.index;clearTimeout(this.timeoutHandle);stats.tload=Math.max(stats.tfirst,window.performance.now());return void this.onSuccess({currentTarget:this.fake_xhr},stats,this.context)}return void this.on_chunk({currentTarget:this.fake_xhr},stats)};E.Module.prototype.ondata_adaptive=function(chunk,adaptive){chunk.req.info.segment.fake_xhr.onchunkdata(chunk,adaptive)};function log_dm(level,msg){if(!util.loader||!util.loader.get_inited_wrapper)return;var wrapper=util.loader.get_inited_wrapper();var log_obj=(wrapper?wrapper.log:log).set_module("hlsprov");log_obj[level](msg)}function copy_own_properties(dst,src){Object.getOwnPropertyNames(src).forEach(function(x){if(!["arguments","caller"].includes(x)&&src[x]&&!dst[x])dst[x]=src[x]});return dst}function dm_conf_build(conf,hls_constructor,conf_get){conf=assign({},conf);if(util.is_hola_hls_js_constructor(hls_constructor)){conf=assign(conf,util.def_hola_hls_config(conf_get),hls_constructor.hola_config)}if(!conf.debug){conf.debug={debug:function(msg){log_dm("debug",msg)},info:function(msg){log_dm("info",msg)},log:function(msg){log_dm("info",msg)},warn:function(msg){log_dm("warn",msg)},error:function(msg){log_dm("err",msg)}}}return conf}E.patch_dm=function(hls_orig,conf_get){if(hls_orig.hola_patched)return;var controller=new util.events;controller.hls_orig=hls_orig;var hls=controller.hls=function Hls(conf){var instance=new hls_orig(dm_conf_build(conf,hls_orig,conf_get));instance.hola_events=[];instance.hola_events_cb=function(e){instance.hola_events.push({name:e,args:arguments})};for(var event in hls_orig.Events)instance.on(hls_orig.Events[event],instance.hola_events_cb);try{controller.emit("newplayer",instance)}catch(e){}return instance};hls.hola_patched=true;copy_own_properties(hls,hls_orig);return controller};E.patch_dm_with_proxy=function(hls_orig,hls_hola,conf_get){if(hls_orig.hola_patched)return;var Proxy=function Hls(conf){var _this=this;var proxy_ctx=this._proxy={events:[]};var mode2hls=function(mode){return mode=="cdn"?hls_hola:hls_orig};var mode2desc=function(mode){return mode=="cdn"?"hola":"customer"};var swap_hls=function(new_hls,old_hls,listeners,done){var media=old_hls.media,source=old_hls.url;var was_playing=media&&!media.paused;listeners.forEach(function(e){old_hls.off(e.event,e.cb)});old_hls.destroy();if(media){new_hls.attachMedia(media);new_hls.on(Hls.Events.MEDIA_ATTACHED,function cb(e){new_hls.off(e,cb);done()});if(media.paused&&was_playing)media.play()}if(source)new_hls.loadSource(source);listeners.forEach(function(e){new_hls.on(e.event,e.cb)});if(!media)done()};var attach_proxy_conn=function(proxy,conn){var keys=[];var conn_proto=Object.getPrototypeOf(conn);var proxy_proto=Object.getPrototypeOf(proxy);var future_fields=["media","url","hola_adaptive"];var do_proxy_field=function(key){if(proxy.hasOwnProperty(key)||proxy_proto.hasOwnProperty(key)){return}Object.defineProperty(proxy,key,{configurable:true,enumerable:true,set:function(v){conn[key]=v},get:function(v){var res=conn[key];return typeof res=="function"?res.bind(conn):res}});keys.push(key)};Object.getOwnPropertyNames(conn).forEach(do_proxy_field);Object.getOwnPropertyNames(conn_proto).forEach(do_proxy_field);future_fields.forEach(do_proxy_field);return function(){keys.forEach(function(k){delete proxy[k]})}};var hide_swap=function(e){if(proxy_ctx.swap_in_progress)e.stopImmediatePropagation()};var reconf_proxy=function(mode){var hls,hls_constructor=mode2hls(mode);if(proxy_ctx.hls){if(proxy_ctx.hls.constructor==hls_constructor)return;log_dm("notice","dm proxy reconf to "+mode2desc(mode)+" hls.js version "+hls_constructor.version);proxy_ctx.detach()}hls=new hls_constructor(dm_conf_build(conf,hls_constructor,conf_get));if(proxy_ctx.hls){proxy_ctx.swap_in_progress=true;swap_hls(hls,proxy_ctx.hls,proxy_ctx.events,function(){proxy_ctx.swap_in_progress=false})}proxy_ctx.hls=hls;proxy_ctx.detach=attach_proxy_conn(_this,hls)};reconf_proxy("init");this.on("hlsHolaMode",function(e,mode){reconf_proxy(mode)});this.on(Hls.Events.MEDIA_ATTACHING,function(){_this.media.addEventListener("emptied",hide_swap);_this.media.addEventListener("abort",hide_swap);_this.media.addEventListener("loadstart",hide_swap);_this.media.addEventListener("play",hide_swap)});this.on(Hls.Events.MEDIA_DETACHING,function(){if(!_this.media)return;_this.media.removeEventListener("emptied",hide_swap);_this.media.removeEventListener("abort",hide_swap);_this.media.removeEventListener("loadstart",hide_swap);_this.media.removeEventListener("play",hide_swap)});try{controller.emit("newplayer",this)}catch(e){}};copy_own_properties(Proxy,hls_orig);Proxy.prototype.on=function(event,cb){this._proxy.events.push({event:event,cb:cb});this._proxy.hls.on(event,cb)};Proxy.prototype.off=function(event,cb){this._proxy.events=this._proxy.events.filter(function(e){return e.event!=event&&e.cb!=cb});this._proxy.hls.off(event,cb)};var controller=new util.events;controller.hls=Proxy;controller.hls.hola_patched=true;controller.hls_orig=hls_orig;return controller};return E});
define("/svc/cdn/pub/html5.js",["/svc/cdn/pub/util.js","/util/util.js","/svc/cdn/pub/shaka.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/dailymotion.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js","/util/date.js","/util/array.js"],function(util,zutil,shaka,dash,dailymotion,player_util,dom_util,date,array){var E={};var perr=util.cdn_perr;E.Player=function(opt){var _this=this;util.call_super(E,this,null,opt);this.log=this.zone.log_get().set_module("html5");this.html5=this.video=opt.html5;this.name="html5";this.tech="html5";this.media_src_api=window;this.state="IDLE";this.blob2url={};this.position=0;this.paused=this.html5.paused;this.kaltura=opt.kaltura;this.clappr=opt.clappr;this.ooyala=opt.ooyala;this.custom=opt.custom;this.src=this.get_url();function check_interrupted(){var player=opt.parent_player||_this,new_url=_this.get_url();if(!player.is_idle()&&_this.src!=new_url){_this.src=new_url;_this.emit("interrupted")}}function is_pending_sourceopen(){if(_this.media_src_url!=E.get_hola_video_source(_this.html5))_this.pending_sourceopen=false;return _this.pending_sourceopen}function html5_src_ext(){var src=_this.get_url();var hola_src=_this.html5.hola_src||_this.blob2url[_this.html5.src]&&_this.html5.src;return hola_src&&hola_src!=src?src+" (hola="+hola_src+")":src}function change_state(state,ext_event,ext_data){var prev=_this.state;var external_states={IDLE:"IDLE",PLAYING:"PLAYING",PLAYING_SEEKING:"PLAYING",BUFFERING:"PLAYING",PAUSED:"PAUSED"};_this.state=state;if(external_states[state]==external_states[prev])return;if(prev=="IDLE")_this.emit("started",_this.get_url());if(ext_event)_this.emit(ext_event,ext_data);_this.emit("state",_this.state)}function video_completed(){_this.log.info("html5 ended "+_this.state+" "+html5_src_ext());var is_full_complete=_this.config.allow_full_complete&&!_this.is_ad_source();change_state("IDLE","ended",{full_complete:is_full_complete})}this.on_html5=function(event,handler){handler=handler.bind(this);this.html5_events=this.html5_events||{};this.html5_events[event]=[].concat(this.html5_events[event]||[],handler);this.html5.addEventListener(event,handler)};this.off_html5=function(event){this.html5_events[event].forEach(function(handler){this.html5.removeEventListener(event,handler)}.bind(this));this.html5_events[event]=[]};if(window.hola_debug_player){var all_html5_video_events=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","play","playing","pause","progress","ratechange","seeking","seeked","stalled","suspend","waiting"];all_html5_video_events.forEach(function(e){_this.on_html5(e,function(o){_this.log.console("html5 "+e+": "+o.timeStamp)})})}this.on_html5("loadedmetadata",function(e){this.log.info("html5 loadedmetadata "+this.state+" "+html5_src_ext());if(this.pending_seek_ms)this.seek(this.pending_seek_ms)});this.on_html5("seeked",function(e){if(this.state=="PLAYING_SEEKING")change_state("PLAYING");var t=e&&(e.target||this.html5);if(!this.config.seek_no_state_change&&!this.paused&&t&&t.paused)this.do_pause();if(!this.config.seek_no_state_change&&this.paused&&t&&!t.paused)this.do_play();this.emit("seeked")});this.on_html5("abort",function(){if(is_pending_sourceopen())return;this.log.info("html5 abort "+this.state+" "+html5_src_ext());check_interrupted();change_state("IDLE")});this.on_html5("emptied",function(){if(is_pending_sourceopen())return;this.log.info("html5 emptied "+this.state+" "+html5_src_ext());check_interrupted();change_state("IDLE")});this.on_html5("loadstart",function(e){this.log.notice("html5 loadstart "+this.state+" "+html5_src_ext());var html5_state=this.html5.paused?"PAUSED":"PLAYING";this.src=this.get_url();if(is_pending_sourceopen()){this.log.info("loadstart after source replacement: ignored");if(this.is_idle())change_state(html5_state);return}if(this.src)change_state(html5_state)});this.on_html5("seeking",function(e){if(this.state=="PLAYING")this.state="PLAYING_SEEKING";this.prev_position=this.position;this.position=this.html5.currentTime;this.emit("seeking",this.prev_position,this.position)});this.on_html5("pause",function(e){var t=e&&(e.target||this.html5);if(t&&t.ended)return video_completed();if(t&&t.seeking)return;this.do_pause()});this.on_html5("ended",function(e){video_completed()});this.on_html5("play",function(e){var t=e&&(e.target||this.html5);if(t&&(!this.is_idle()&&t.seeking||t.networkState==t.NETWORK_NO_SOURCE)){this.log.info("html5 play ignored net_state "+t.networkState+" seeking "+t.seeking);return}this.do_play()});this.on_html5("waiting",function(e){if(this.state=="PLAYING")change_state("BUFFERING");this.emit("waiting")});this.on_html5("loadedmetadata",function(e){var src=E.get_hola_video_source(this.html5);if(src&&!util.is_blob_url(src))change_state("PAUSED")});this.on_html5("error",function(e){var err;if(err=html5_get_error(this))this.emit("error",err)});this.on_html5("timeupdate",function(e){var t=e&&(e.target||this.html5);if(t&&t.networkState==t.NETWORK_NO_SOURCE)return;var pos=this.html5.currentTime;if(pos>this.position&&!this.html5.paused&&!this.html5.ended)change_state("PLAYING");this.position=pos;this.emit("timeupdate",pos)});this.on_html5("durationchange",function(){this.emit("duration_changed")});this.on_html5("volumechange",function(){this.emit("volumechange")});if(this.html5.networkState&&this.html5.networkState!=this.html5.NETWORK_NO_SOURCE){this.state=this.html5.paused?"PAUSED":"PLAYING"}this.reset_state=function(){delete this.pending_seek_ms}.bind(this);this.on("started",this.reset_state);this.do_pause=function(){this.paused=true;this.log.notice("html5 pause");change_state("PAUSED");this.emit("pause")};this.do_play=function(){this.play_count=this.play_count||0;this.paused=false;this.log.notice("html5 play "+this.state+" "+html5_src_ext());change_state("PLAYING");this.emit("play");var n=this.zone.conf&&this.zone.conf.player&&this.zone.conf.player.ignore_num_play_events||0;if(this.play_count<n)this.html5.pause();if(this.adjust_pos&&!this.html5.seeking&&this.html5.currentTime)this.html5.currentTime+=.1;this.play_count++};this.stash=function(){var stash={on_sourceopen:this.on_sourceopen};if(stash.on_sourceopen)this.disable_data_mode();return function(){if(stash.on_sourceopen)this.enable_data_mode(stash.on_sourceopen)}.bind(this)};this.zone_watch=this.zone.conf_watch([{conf:{ignore_other_error:"player.ignore_other_error",disable_ended_fallback:"player.disable_ended_fallback",disable_src_change_hiding:"player.disable_src_change_hiding",lock_reload_request:"player.html5.lock_reload_request",seek_no_state_change:"player.html5.seek_no_state_change",allow_full_complete:"player.html5.full_complete"},onchange:function(ctx,from,to){_this.config=to},uninit:function(ctx,value){_this.config={}}},{conf:"player.html5.ext_control_logs",ontoggle:function(ctx,value){if(!value){ctx.seek_hook=ctx.seek_hook&&ctx.seek_hook.remove();ctx.load_hook=ctx.load_hook&&ctx.load_hook.remove();ctx.pause_hook=ctx.pause_hook&&ctx.pause_hook.remove();ctx.play_hook=ctx.play_hook&&ctx.play_hook.remove();ctx.src_change_uninit=ctx.src_change_uninit&&ctx.src_change_uninit();return}ctx.seek_hook=util.inject_hook(_this.html5,"currentTime",{set:function(e,args){_this.log.info("html5 curtime=%d state %s src %s "+"stack %s",args[0],_this.state,html5_src_ext(),(new Error).stack)}});ctx.load_hook=util.inject_hook(_this.html5,"load",{exec:function(e,args){_this.log.info("html5 load state %s src %s stack %s",_this.state,html5_src_ext(),(new Error).stack)}});ctx.pause_hook=util.inject_hook(_this.html5,"pause",{exec:function(e,args){_this.log.info("html5 pause state %s src %s stack %s",_this.state,html5_src_ext(),(new Error).stack)}});ctx.play_hook=util.inject_hook(_this.html5,"play",{exec:function(e,args){_this.log.info("html5 play state %s src %s stack %s",_this.state,html5_src_ext(),(new Error).stack)}});ctx.src_change_uninit=E.hacks.on_source_change(_this.html5,function(from,to,stack){_this.log.info("html5 sourcechange from %s to %s %s",from||"<empty>",to||"<empty>",to!=_this.media_src_url?"stack "+stack:"")})},uninit:function(ctx,value){this.ontoggle(ctx,false)}}]);if(opt.shaka){util.assert_enabled(shaka,"shaka module is required but disabled");this.module=new shaka.Module({zone:this.zone,shaka:opt.shaka})}else if(opt.dashjs){util.assert_enabled(dash,"dash module is required but disabled");this.module=new dash.Module({zone:this.zone,dashjs:opt.dashjs})}else if(opt.dailymotion){util.assert_enabled(dailymotion,"dailymotion module is required but disabled");this.module=new dailymotion.Module({zone:this.zone,dailymotion:opt.dailymotion,player:this})}util.create_forwarding_emit(this)};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){this.zone_watch=this.zone_watch.uninit();this.off("started",this.reset_state);if(this.src_unlock)this.src_unlock=this.src_unlock();if(this.events&&this.events.removeAllListeners)this.events.removeAllListeners();if(this.module&&this.module.uninit)this.module.uninit();for(var event in this.html5_events)this.off_html5(event)};E.Player.prototype.set_cdn_mode=function(on){};util.module_fn(E,function get_url(){if(this.ooyala)return this.ooyala.getConfig().source.hls;var src=E.get_video_source(this.html5);if(util.is_blob_url(src)){if(this.blob2url[src])src=this.blob2url[src];else if(this.custom&&this.custom.get_url)src=this.custom.get_url()||src}return src});E.Player.prototype.seek=function(ms){if(this.html5.readyState<this.html5.HAVE_METADATA)return this.pending_seek_ms=ms;this.html5.currentTime=ms/1e3};E.Player.prototype.get_pos=function(){return this.html5.currentTime};util.module_fn(E,function get_state(){return this.state});E.Player.prototype.refresh_buffered=function(){return this.html5.buffered};E.Player.prototype.get_buffered=function(){return this.html5.buffered};E.Player.prototype.get_duration=function(){return this.html5.duration};E.Player.prototype.get_resolution=function(){return dom_util.get_elm_resolution(this.html5)};E.Player.prototype.discontinuity=function(sbuf){};E.Player.prototype.play=function(){this.html5.play()};E.Player.prototype.pause=function(){this.html5.pause()};E.play_url=function play_url(html5,url,pos,is_paused,video_type){if(pos){html5.addEventListener("loadedmetadata",function cb(){html5.removeEventListener("loadedmetadata",cb);if(pos)html5.currentTime=pos})}html5.src=url;if(!is_paused)html5.play()};util.module_fn(E,function play_url(url,pos,is_paused,video_type){return E.play_url(this.html5,url,pos,is_paused,video_type)});util.module_fn(E,function enable_data_mode(on_sourceopen){if(!this.media_src_api.MediaSource)throw new Error("MediaSource API not available");this.media_src=new this.media_src_api.MediaSource;this.pending_sourceopen=true;var played=!this.html5.paused;this.media_src_url=this.media_src_api.URL.createObjectURL(this.media_src);var current_url=E.get_video_source(this.html5);var original_url=this.blob2url[this.media_src_url]=this.blob2url[current_url]||current_url;this.prev_src=this.html5.src;this.html5.src=this.media_src_url;if(!this.config.disable_src_change_hiding){if(this.src_unlock)this.src_unlock();this.src_unlock=E.hacks.hide_source_change(this.html5,original_url,this.media_src_url)}if(this.config.lock_reload_request)this.load_unlock=E.hacks.lock_reload_request(this.html5,this.log);var _this=this;if(played){var promise=this.html5.play();if(promise&&promise.catch){promise.catch(function(err){if(err&&err.name=="AbortError")setTimeout(function(){_this.html5.play()})})}}if(!this.config.disable_ended_fallback){this.schedule_end_of_stream_check=function(){var html5=_this.html5,_ct=html5.currentTime;_this.end_of_stream_timer=clearTimeout(_this.end_of_stream_timer);if(!html5.duration||html5.duration-_ct>.25)return;_this.end_of_stream_timer=setTimeout(function(){var ct=html5.currentTime;if(!html5.duration||!ct||html5.ended&&ct!=_ct||html5.duration-ct>.25){return}perr({id:"html5_ended_fallback",add_log:true});html5.dispatchEvent(util.new_event("ended"));html5.removeEventListener("timeupdate",_this.schedule_end_of_stream_check)},500)};this.html5.addEventListener("timeupdate",this.schedule_end_of_stream_check)}this.on_sourceopen=function(){_this.pending_sourceopen=false;return on_sourceopen(this.media_src)}.bind(this);this.media_src.addEventListener("sourceopen",this.on_sourceopen);if(this.media_src.readyState=="open")this.on_sourceopen(this.media_src);this.last_pos=this.metadata=this.stalled=undefined;this.nudge_retry=0});E.Player.prototype.disable_data_mode=function(){if(!this.media_src)return;if(this.load_unlock)this.load_unlock();if(window.__dl8__delightVrApp&&!this.prev_src)this.html5.removeAttribute("src");this.media_src.removeEventListener("sourceopen",this.on_sourceopen);if(this.schedule_end_of_stream_check){this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer);this.html5.removeEventListener("timeupdate",this.schedule_end_of_stream_check)}this.media_src=this.media_src_url=this.pending_sourceopen=this.schedule_end_of_stream_check=this.on_sourceopen=this.load_unlock=undefined};util.module_fn(E,function is_playing(){if(this.is_idle())return false;return!this.html5.paused});util.module_fn(E,function is_paused(){if(this.is_idle())return false;if(zutil.is_mocha())return this.html5.paused;return this.paused});E.Player.prototype.get_decoded_frames=function(){return E.get_decoded_frames(this.html5)};E.Player.prototype.get_dropped_frames=function(){return E.get_dropped_frames(this.html5)};E.Player.prototype.check_buffer=function(opt){E.check_buffer.call(this,this.html5,opt)};util.module_fn(E,function get_captions_track(){for(var i=0;i<this.html5.textTracks.length;i++){if(this.html5.textTracks[i].mode=="showing")return i}return-1});util.module_fn(E,function set_captions_track(track){for(var i=0;i<this.html5.textTracks.length;i++)this.html5.textTracks[i].mode="disabled";if(track>=0)this.html5.textTracks[track].mode="showing"});util.module_fn(E,function is_idle(){return this.state=="IDLE"});util.module_fn(E,function get_container(){if(this.custom&&this.custom.get_container)return this.custom.get_container();return this.html5});util.module_fn(E,function get_levels(){});util.module_fn(E,function get_playlists(){});util.module_fn(E,function get_current_playlist(){});util.module_fn(E,function get_segment_info(){});util.module_fn(E,function get_bitrate(){return 0});util.module_fn(E,function is_bitrate_supported(){return true});util.module_fn(E,function init_adaptive(){});util.module_fn(E,function is_live_stream(){return Infinity==this.html5.duration});util.module_fn(E,function get_current_level(){});util.module_fn(E,function ondata_adaptive(){});util.module_fn(E,function get_current_fragment(){});util.module_fn(E,function is_autostart(){if(this.clappr)return!!this.clappr.playerInfo.options.autoPlay;if(this.kaltura)return this.kaltura.autoplay;return this.html5.autoplay});E.Player.prototype.get_bandwidth=function(){return 0};E.Player.prototype.get_caps=function(){return player_util.Player.prototype.get_caps({save_context:["progressive"]})};E.Player.prototype.get_est_bytes=function(){var res=null;if(this.module)res=this.module.get_est_bytes();if(!res)res=E.est_bytes_from_tag(this.html5);if(!res)res=this._get_media_size_server();return res};E.Player.prototype.get_current_error=function(){return html5_get_error(this)};E.Player.prototype.play_src=function(src){this.html5.src=src[0].file||src[0].url;this.html5.load();this.html5.play()};function html5_get_error(player){var err_map={1:{message:"download was cancelled",reason:"other"},2:{message:"network error",reason:"media_load"},3:{message:"decode error",reason:"media_decode"},4:{message:"source not supported",reason:"media_support"},5:{message:"encryption error",reason:"media_decode"},unknown:{message:"unknown",reason:"other"}};if(!player.html5.error)return;var code=player.html5.error&&player.html5.error.code;if(!E.get_video_source(player.html5)&&code==4)return;var info=err_map[code]||err_map.unknown;info.message=player.html5.error&&player.html5.error.message||info.message;if(player.config.ignore_other_error&&info.reason=="other"){player.log.err("ignoring other error");return}return{code:code,reason:info.reason,message:info.message}}E.get_decoded_frames=function(video){if(!video)return;if(video.webkitDecodedFrameCount!==undefined)return video.webkitDecodedFrameCount;if(video.mozDecodedFrames!==undefined)return video.mozDecodedFrames};E.get_dropped_frames=function(video){if(video.webkitDroppedFrameCount!==undefined)return video.webkitDroppedFrameCount};E.get_video_source=function(video){var video_url,empty_src_re=/^#?$/;if(video_url=video.src){if(empty_src_re.test(video.getAttribute("src")))video_url=""}else if(video_url=video.currentSrc){var is_src=false;var s=array.slice(video.querySelectorAll("source"));s.push(video);for(var i=0;i<s.length;i++){if(s[i].src!=video_url)continue;is_src=true;if(empty_src_re.test(s[i].getAttribute("src")))video_url="";break}if(!is_src)video_url=""}return video_url};E.get_hola_video_source=function(video){return video.hola_src||E.get_video_source(video)};E.dump_buffered=function(video){var str="",b=video.buffered,len=b.length;for(var i=0;i<len;i++)str+="["+b.start(i)+","+b.end(i)+"]";return str};E.at_init_position=function(video){return!video.buffered.length||video.currentTime==video.buffered.start(0)};E.est_bytes_from_tag=function(el){if(isFinite(el.webkitAudioDecodedByteCount)&&isFinite(el.webkitVideoDecodedByteCount)&&(el.webkitVideoDecodedByteCount!=0||el.currentTime==0)){return{bytes:el.webkitAudioDecodedByteCount+el.webkitVideoDecodedByteCount,src:"html5"}}return null};E.check_buffer=function(video,opt){if(!video.readyState)return;var ts,spos,_this=this,state=opt.state,pos=video.currentTime;var buf=video.buffered;if(!state.metadata&&buf.length&&buf.start(0)<buf.end(0)){spos=buf.start(0);if(pos==0&&pos!=spos){if(spos<.05&&!video.paused){ts=date.monotonic();if(!state.start_stalled){state.start_stalled=ts;return void setTimeout(function(){E.check_buffer.call(_this,video,opt)},100)}else if(ts-state.start_stalled<100)return}this.log.info("position "+pos+" not buffered, seek to "+spos);video.currentTime=spos}state.metadata=true;state.start_stalled=undefined}else if(state.metadata){if(pos!=state.last_pos){state.stalled=undefined;state.nudge_retry=0;state.last_pos=pos}else{if(video.paused||video.ended||!buf.length){state.nudge_retry=0;return state.stalled=undefined}ts=date.monotonic();if(!state.stalled)state.stalled=ts;else{var dur=ts-state.stalled,nudge_retry=state.nudge_retry||0;var bsec=opt.bws.sec_in_buffer(pos,true),conf=opt.conf;if(bsec>conf.bsec&&dur>conf.buf_wd*1e3){state.stalled=undefined;state.nudge_retry=++nudge_retry;if(nudge_retry<conf.max_nudge_retry){spos=pos+nudge_retry*conf.offset;this.log.info("adjust position from "+pos+" to "+spos);video.currentTime=spos}else{this.log.info("still stuck at "+pos+" after "+nudge_retry)}}}}}};E.hacks={};E.hacks.hide_source_change=function(video,facade_src,surrogate_src){E.polyfill.video_source_access(video);var src_hook_cb=function(e){if(hooks.src.original_handlers.get()!=surrogate_src)return;e.set_handled();return facade_src};var attr_hook_cb=function(e,args){if(args[0]!="src")return;var attr_src=hooks.attr.original_handlers.exec("src");if(util.absolute_uri(attr_src,true)!=surrogate_src)return;e.set_handled();return facade_src};var hola_src_hook_cb=function(e,args){e.set_handled();return hooks.src.original_handlers.get()};var hooks={src:util.inject_hook(video,"src",{get:src_hook_cb}),csrc:util.inject_hook(video,"currentSrc",{get:src_hook_cb}),attr:util.inject_hook(video,"getAttribute",{exec:attr_hook_cb}),hsrc:util.inject_hook(video,"hola_src",{get:hola_src_hook_cb})};E.hacks.lock_no_source_ns(video);return function(){Object.keys(hooks).forEach(function(name){hooks[name].remove()});if(!hooks.hsrc.count())delete video.hola_src}};E.hacks.on_source_change=function(video,cb){E.polyfill.video_source_access(video);var src_hook_cb=function(e,args){cb(E.get_hola_video_source(video),args[0],(new Error).stack)};var attr_hook_cb=function(e,args){if(args[0]=="src")cb(E.get_hola_video_source(video),args[1],(new Error).stack)};var hooks={src:util.inject_hook(video,"src",{set:src_hook_cb}),attr:util.inject_hook(video,"setAttribute",{exec:attr_hook_cb})};return function(){Object.keys(hooks).forEach(function(name){hooks[name].remove()})}};E.hacks.lock_reload_request=function(video,log){var lock_url=E.get_hola_video_source(video);var hook=util.inject_hook(video,"load",function(e,args){if(args[0]&&args[0].hola_force)return;if(E.get_hola_video_source(video)==lock_url){e.set_handled();log.info("video.load() call intercepted/ignored")}});return hook.remove.bind(hook)};E.hacks.lock_no_source_ns=function(video){if(util.conf_get("loader.html5.disable_ns_lock"))return;var hook=util.inject_hook(video,"networkState",{get:function(e){e.set_handled();var ns=hook.original_handlers.get();return ns==video.NETWORK_NO_SOURCE?video.NETWORK_LOADING:ns}});setTimeout(hook.remove.bind(hook))};E.polyfill={};E.polyfill.video_source_access=function(video){var pd=Object.getOwnPropertyDescriptor(video,"src");if(pd&&!pd.configurable)return false;if(!util.is_safari||util.conf_get("loader.html5.disable_video_src_polyfill")){return true}var proto=video;while(!proto.hasOwnProperty("src")&&(proto=Object.getPrototypeOf(proto)));if(!proto||!(pd=Object.getOwnPropertyDescriptor(proto,"src"))||pd.get||pd.hasOwnProperty("value")){return true}var orig_set_attr=video.setAttribute,orig_get_attr=video.getAttribute;Object.defineProperty(video,"src",{configurable:true,enumerable:true,set:function(value){orig_set_attr.call(this,"src",value)},get:function(){var src=orig_get_attr.call(this,"src");return src!=null?util.absolute_uri(src,true):""}});perr({id:"html5_source_polyfill"});return true};return E});
define("/svc/cdn/pub/zjwplayer3.js",{__stub:1});

(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/match.js",["/util/escape.js","/util/util.js"],function(zescape,zutil){var E={};E.glob_to_regex_str=function(glob){return"^("+glob.replace(/(\?|\*\*|\*)|([^?*]+)/g,function(m){return m=="?"?"[^/]":m=="**"?".*":m=="*"?"[^/]*":zescape.regex(m)})+")$"};E.glob_to_regex=function(glob){return new RegExp(E.glob_to_regex_str(glob))};E.glob_fn=function(glob){var re=E.glob_to_regex(glob);return function(s){return re.test(s)}};E.glob=function(glob,value){return E.glob_fn(glob)(value)};function eat_group(arr,start){for(var c=0,i=start;i<arr.length;i++){if(arr[i].depth)c+=arr[i].depth;if(!c)return arr.splice(start,i-start+1).slice(1,-1)}throw new Error("unbalanced group")}function parse_arr_to_tree(arr,join){function is_join(el){return el.join&&Object.keys(el).length==1}function clean(el){if(!Array.isArray(el.elm))delete el.join;return el}function pass(fn){for(var i=0;i<arr.length;i++){var change;if(change=fn(arr[i],arr[i+1],i))i+=change}}pass(function(el,next,i){if(el.depth)arr.splice(i,0,parse_arr_to_tree(eat_group(arr,i),join))});pass(function(el,next,i){if(el.fn&&!el.elm)el.elm=arr.splice(i+1,1)[0]});pass(function(el,next,i){if(is_join(el)){arr[i-1]={join:el.join,elm:[arr[i-1],next].map(clean)};arr.splice(i,2);return-1}if(next&&next.join=="&&"&&!is_join(next)){arr[i]={join:"&&",elm:[el,next].map(clean)};arr.splice(i+1,1)}});if(arr.length<=1)return arr[0];return{join:join,elm:[arr[0],parse_arr_to_tree(arr.slice(1),join)].map(clean)}}E.match_parse=function(filter,opt){var res=[],o={s:filter},cmp=[],match,i,_plugin;var eat_token=zescape.parse.eat_token;opt=opt||{};var plugin=opt.plugin||[];var join=opt.join||"||";var logical=opt.logical===undefined||opt.logical;token:while(o.s.length){if(opt.eat_white!==false&&eat_token(o,/^\s+/))continue;for(i=0;i<plugin.length;i++){_plugin=plugin[i];if(match=eat_token(o,_plugin.re)){cmp.push({plugin:_plugin,m:match});continue token}}if(match=eat_token(o,/^\/((\\.|[^\\\/])+)\/([i]?)(\s|$)/)){cmp.push({re:match[1],re_opt:match[3]});continue}if(match=eat_token(o,/^\S+/)){var m=match[0],l;var _logical={"&&":{join:"&&"},"||":{join:"||"},"!":{fn:"!"},"+":{join:"||"},"-":{fn:"!",join:"&&",wrap_join:true},"(":{fn:"(",depth:1},")":{fn:")",depth:-1,join:""}};if(logical&&(l=_logical[m])){if(l.wrap_join){var depth=0;for(i=cmp.length;i>=0&&depth>=0;i--)depth+=-(l.depth||0);i++;if(i<cmp.length){cmp.splice(i,0,_logical["("]);cmp.push(_logical[")"])}delete l.wrap_join}cmp.push(l)}else if(opt.glob&&/[\[\]*?{}]/.test(m)){cmp.push(opt.glob=="re"?{re:E.glob_to_regex_str(m)}:{glob:m})}else cmp.push({eq:m});continue}E.match_last_error=new Error("invalid token "+o.s)}var have_val=false;cmp.forEach(function(c){var _join=have_val&&join;if(c.eq!==undefined||c.re!==undefined||c.glob!==undefined||c.plugin){have_val=true}else{if(c.join!==undefined)_join=c.join;have_val=false}if(_join)c.join=_join;else delete c.join});return opt.tree?parse_arr_to_tree(cmp,join):cmp};E.match_fn=function(filter,opt){opt=opt||{};var cmp=E.match_parse(filter,opt),func="return ",i;for(i=0;i<cmp.length;i++){var c=cmp[i];if(c.join)func+=c.join+" ";if(c.re!==undefined){try{var re=new RegExp(c.re,c.re_opt);c=function(s){return this.test(s)}.bind(re)}catch(e){c=function(){return false};E.match_last_error=e}}else if(c.glob!==undefined)c=E.glob_fn(c.glob);else if(c.eq!==undefined)c=function(s){return s===this}.bind(c.eq);else if(c.plugin){c=c.plugin.cmp?c.plugin.cmp.bind(null,c.m):c.plugin.cmp_fn(c.m)}cmp[i]=c;if(typeof c=="function")func+="cmp["+i+"](s) ";else if(c instanceof Object)func+=c.fn?c.fn+" ":"";else throw new Error}if(!cmp.length)func+="false ";func+=";";return new Function(["cmp","s"],func).bind(null,cmp)};E.match=function(filter,value,opt){return E.match_fn(filter,opt)(value)};E.cmp_norm=function(cmp){return cmp>0?1:cmp<0?-1:0};E.strcmp=function(a,b){return a>b?1:a<b?-1:0};E.strverscmp=function(a,b){var _a,_b,diff,skip_digit=0;for(_a=0,_b=0;_a<a.length&&_b<b.length;_a++,_b++){if(a[_a]==b[_b]&&!zutil.isdigit(a[_b]))continue;if(skip_digit)skip_digit--;if(zutil.isdigit(a[_a])&&zutil.isdigit(b[_b])){var ma=a.substr(_a).match(/\d+/)[0];var mb=b.substr(_b).match(/\d+/)[0];if(diff=+ma-+mb)return diff;skip_digit=ma.length}if(diff=a[_a].charCodeAt()-b[_b].charCodeAt())return diff}return a.length-b.length};E.regexp_merge=function(a){var re=[],i;for(i=0;i<a.length;i++)re.push(a[i]instanceof RegExp?a[i].source:zescape.regex(""+a[i]));return new RegExp("("+re.join(")|(")+")")};return E})})();
define("/svc/cdn/pub/vjs.js",["/util/util.js","/svc/cdn/pub/jsurlstream.js","/svc/cdn/pub/util.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/shaka.js","cash","/svc/cdn/pub/html5.js","/util/version_util.js","/svc/cdn/pub/dailymotion.js","/util/zerr.js","/util/match.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js","/util/user_agent.js"],function(zutil,jsurlstream,util,dash,shaka,$,html5,version_util,dailymotion,zerr,match,player_util,dom_util,user_agent){var E={};var ERR=util.ERR,perr=util.cdn_perr;var vjs_version;function is_vjs6(){return version_util.cmp(vjs_version,"6.0")>=0}function is_vjs5(){return version_util.cmp(vjs_version,"5.0")>=0}function is_vjs5_new_hls(){return version_util.cmp(vjs_version,"5.9.2")>=0}E.Player=function(opt){var videojs=window.videojs||opt.video.constructor;vjs_version=videojs&&videojs.VERSION;util.call_super(E,this,null,opt);var _this=this;var hola_version=/-\d+$/.test(vjs_version)||videojs&&videojs.HOLA_VERSION;this.player_id=opt.player_id||1;this.vjs=this.video=opt.video;this.video_url=opt.video_url;this.vjs_adapter=is_vjs6()?E.adapters.v6(this.vjs):E.adapters.v4_5(this.vjs);this.tech=opt.tech;this.name=hola_version?"hola":"vjs";this.backward_seek_bug=opt.tech=="html5"&&util.is_chrome&&util.browser.version>=55&&vjs_version&&(hola_version?match.strverscmp(vjs_version,"5.10.2-22")<0:match.strverscmp(vjs_version,"5.16.0")<0);if(opt.html5)this.html5=opt.html5;this.is_vjs5_new_hls=is_vjs5_new_hls();this.is_brightcove=vjs_is_brightcove(this.vjs);this.log=this.zone.log_get().set_module("vjs");this.on("wrapper_attached",function(){_this.vjs.trigger("hola.wrapper_attached")});this.on("wrapper_detached",function(){_this.vjs.trigger("hola.wrapper_detached")});if(this.swf=this.vjs&&this.vjs.osmf&&this.vjs.osmf.el_){this.flash_api=player_util.build_flash_api(this);if(this.swf.hola_settings)this.swf.hola_settings({player_id:this.player_id})}this.media_src_api=opt.tech=="html5"&&window.MediaSource?window:videojs;this.blob2url={};this.position=0;this.vjs_handlers={};this.zone_watch=this.zone.conf_watch([{conf:{disable_ended_fallback:"player.disable_ended_fallback",disable_src_change_hiding:"player.disable_src_change_hiding",cdn_disable_streaming:"cdn.send_reqs.disable_streaming"},onchange:function(ctx,from,to){_this.config=to},uninit:function(){_this.config={}}},{conf:{skip_caching:"loader.vjs.skip_caching",cache_field:"loader.vjs.cache_field"},onchange:function(ctx,from,to){_this.gconfig=to},uninit:function(){_this.gconfig={}}}]);var is_shaka=E.vjs_getTechName(this.vjs).toLowerCase()=="shaka";this.module_handlers={shaka:function(){var is_shaka_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="dash"&&is_shaka};if(!is_shaka_env())return;util.assert_enabled(shaka,"shaka module is required but disabled");var vjs_shaka_get=function(vjs){return vjs.tech_.shakaPlayer||vjs.tech_.shakaPlayer_};var shaka_obj=vjs_shaka_get(_this.vjs);_this.module=new shaka.Module({html5:opt.html5||vjs_getElement(_this.vjs),zone:_this.zone,shaka:shaka_obj});return{changed:function(){return!is_shaka_env()||shaka_obj!=vjs_shaka_get(_this.vjs)},uninit:function(){_this.module.uninit();_this.module=undefined}}},dashjs:function(){var is_dashjs_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="dash"&&videojs&&videojs.Html5DashJS};if(!is_dashjs_env())return;util.assert_enabled(dash,"dash module is required but disabled");var vjs_dashjs_get=function(vjs){return vjs.tech_.sourceHandler_.mediaPlayer_};var dash_obj=vjs_dashjs_get(_this.vjs);dash.patch_dashjs(dash_obj);_this.module=new dash.Module({html5:opt.html5||vjs_getElement(_this.vjs),zone:_this.zone,dashjs:dash_obj,vjs:_this.vjs});_this.module.on("missing_idr",_this.dash_missing_idr=function(e){_this.emit("missing_idr",e)});return{changed:function(){return!is_dashjs_env()||dash_obj!=vjs_dashjs_get(_this.vjs)},uninit:function(){_this.module.off("missing_idr",_this.dash_missing_idr);_this.module.uninit();_this.module=_this.dash_missing_idr=undefined}}},hls_dm:function(){var vjs_hola_dm_get=function(vjs){return vjs.tech_.hls_obj};var vjs_orig_dm_get=function(vjs){return E.vjs_getTechObj(vjs).hls_};var vjs_dm_get=function(vjs){return vjs_hola_dm_get(vjs)||vjs_orig_dm_get(vjs)};var is_hls_dm_env=function(vjs){var adaptive=_this.get_video_type_name();return adaptive=="hls"&&((videojs||{}).HolaProviderHLS&&vjs_hola_dm_get(vjs)||window.Hls&&vjs_orig_dm_get(vjs))};if(!is_hls_dm_env(_this.vjs))return;util.assert_enabled(dailymotion,"dailymotion module is required but disabled");var hls_obj=vjs_dm_get(_this.vjs);_this.module=new dailymotion.Module({html5:opt.html5||vjs_getElement(_this.vjs),zone:_this.zone,dailymotion:hls_obj,vjs:_this.vjs,player:_this});util.create_forwarding_emit(_this);_this.module.on("manifest_loaded",_this.hls_manifest_loaded=function(){_this.emit("manifest_loaded")});_this.module.on("level_loaded",_this.hls_level_loaded=function(lvl){_this.emit("level_loaded",lvl)});_this.module.on("level_updated",_this.hls_level_updated=function(lvl){_this.emit("level_updated",lvl)});_this.module.on("seg_stats",_this.hls_seg_stats=function(lvl){_this.emit("seg_stats",lvl)});_this.module.on("buf_stats",_this.hls_buf_stats=function(lvl){_this.emit("buf_stats",lvl)});_this.module.on("frag_load_stats",_this.hls_frag_load_stats=function(lvl){_this.emit("frag_load_stats",lvl)});_this.module.on("error",_this.hls_error=function(lvl){_this.emit("error",lvl)});return{changed:function(){return!is_hls_dm_env(_this.vjs)||hls_obj!=vjs_dm_get(_this.vjs)},uninit:function(){if(!_this.module)return;_this.module.off("manifest_loaded",_this.hls_manifest_loaded);_this.module.off("level_updated",_this.hls_level_updated);_this.module.off("seg_stats",_this.hls_seg_stats);_this.module.off("buf_stats",_this.hls_buf_stats);_this.module.off("frag_load_stats",_this.hls_frag_load_stats);_this.module.uninit();_this.module=_this.hls_level_loaded=undefined;_this.hls_seg_stats=_this.hls_buf_stats=undefined;_this.hls_frag_load_stats=undefined;_this.hls_manifest_loaded=undefined;_this.hls_level_updated=undefined},is_err_allowed:function(err){return err.code==-2&&hls_obj.streamController&&!hls_obj.streamController.media}}},hls_contrib:function(){var vjs_contrib_hls_get=function(vjs){return vjs.tech_.hls};var is_contrib_hls_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="hls"&&videojs&&!videojs.HolaProviderHLS&&_this.vjs.tech_&&!_this.vjs.tech_.hls_obj&&vjs_contrib_hls_get(_this.vjs)};if(!is_contrib_hls_env())return;var hls_obj=vjs_contrib_hls_get(_this.vjs);return{changed:function(){return false},uninit:function(){},is_err_allowed:function(err){return err.code==-2&&hls_obj.mediaSource&&hls_obj.mediaSource.readyState=="closed"}}},hls_native_no_play:function(){if(!_this.is_native_hls())return;var on_check_skip_video=function(e){if(util.is_mode_cdn_or_bwsaver(_this.zone))e.skip="native hls is used"};_this.on("wrapper.check_skip_video",on_check_skip_video);return{changed:function(){return!_this.is_native_hls()},uninit:function(){_this.off("wrapper.check_skip_video",on_check_skip_video)}}}};this.on("pre-started",this.module_reconf=function(){if(_this.module_ops){if(!_this.module_ops.changed())return;_this.module_ops.uninit()}Object.keys(_this.module_handlers).find(function(h){return _this.module_ops=_this.module_handlers[h]()})});this.module_reconf();this.change_state=function(state,reason){if(state.detect)state=_this.vjs.paused()?"PAUSED":"PLAYING";if(this.state==state)return;var prev_state=this.state;this.state=state;if(prev_state=="IDLE")this.emit("started");else if(reason=="ended")this.emit(reason);this.emit("state",this.state)};this.align_state=function(){if(this.is_paused()&&!this.vjs.paused())this.change_state("PLAYING");if(this.is_playing()&&this.vjs.paused())this.change_state("PAUSED")};player_set_initial_state(this);this.src_hook=util.inject_hook(this.vjs,"src",{log:this.log,exec:function(e,args){var src=args[0];if(!src)return;if(typeof src!="string")src=Array.isArray(src)?src[0].src:src.src;if(_this.blob2url[src]||src==_this.get_url())return;_this.zperr({id:"source_change"});_this.emit("src_change",{from:_this.get_url(),to:src});if(!_this.is_idle()){_this.emit("interrupted");_this.seeking=_this.pending_sourceopen=false;_this.change_state("IDLE")}_this.source_change_in_progress=true;_this.src_hook.original_handlers.exec.apply(this,args);e.set_handled();_this.refresh_buffered();_this.vjs.ready(function(){_this.change_state({detect:true})},true)}});this.on_vjs=function(events,handler){var wrapper=function(e){if(this.ready)handler.call(this,e)}.bind(this);events=typeof events=="string"?[events]:events;events.forEach(function(event){_this.vjs_handlers[event]=[].concat(_this.vjs_handlers[event]||[],wrapper);_this.vjs.on(event,wrapper)})};this.on_vjs("seeked",function(a){if(Math.abs(this.seek_position-this.vjs.currentTime())>4){this.log.err("detected a bad seek: "+this.prev_position+" -> "+this.seek_position+" current: "+this.vjs.currentTime());var backward_seek_bug=this.backward_seek_bug&&this.prev_position>this.seek_position;if(backward_seek_bug&&util.is_mode_cdn_or_bwsaver(this.zone)){this.log.notice("correcting bad seek to "+this.seek_position);this.vjs.currentTime(this.seek_position)}else{perr({id:backward_seek_bug?"vjs_bad_backward_seek":"vjs_bad_seek",add_log:true,throttle:1,info:"previous: "+this.prev_position+" current: "+this.vjs.currentTime()+" seek position: "+this.seek_position})}}this.seeking=false;this.emit("seeked");this.align_state();if(this.schedule_end_of_stream_check)this.schedule_end_of_stream_check()});this.on_vjs("ended",function(a){if(this.is_ad_active())return;this.change_state("IDLE","ended")});this.on_vjs("loadstart",function(){this.source_change_in_progress=false});this.on_vjs("abort",function(){if(this.pending_sourceopen||this.source_change_in_progress){this.align_state();return this.log.info("vjs abort - ignored (%s)",this.pending_sourceopen?"mse restart":"source change")}this.log.info("vjs abort");this.change_state("IDLE")});this.on_vjs("seeking",function(a){this.seeking=true;this.prev_position=this.position;this.seek_position=this.position=this.vjs.currentTime();this.emit("seeking",this.prev_position,this.position);if(this.end_of_stream_timer)this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer)});this.play_during_ad=false;this.on_vjs("pause",function(a){this.log.info("vjs pause state "+this.state+" seeking "+!!this.seeking+" ad_playback "+this.is_ad_active());if(this.seeking)return;if(this.is_idle())return;this.play_during_ad=false;this.change_state("PAUSED");this.emit("pause")});this.on_vjs("play",function(a){this.log.info("vjs play state "+this.state+" seeking "+!!this.seeking);if(this.seeking&&!this.is_idle())return;if(this.play_during_ad=this.is_ad_active())return;if(this.is_idle())this.seeking=false;if(this.adjust_pos&&this.html5&&this.html5.currentTime)this.html5.currentTime+=.1;this.change_state("PLAYING");this.emit("play")});this.on_vjs("waiting",function(a){this.emit("waiting")});this.on_vjs("error",function(a){var err;if(err=vjs_get_error(this,a))this.emit("error",err)});this.on_vjs("timeupdate",function(a){if(this.is_ad_active()){this.emit("ad_time",{duration:this.vjs.duration(),position:this.vjs.currentTime()})}else{this.buffered=E.vjs_getBuffered(this.vjs,this.html5);var pos=this.vjs.currentTime();if(pos>this.position&&!this.vjs.paused()&&!this.is_playing()){this.change_state("PLAYING");perr({id:"vjs_missing_play_event",add_log:true,throttle:1})}this.position=pos;this.emit("timeupdate",pos)}});this.on_vjs("progress",function(){this.buffered=undefined});this.on_vjs("mediachange",function(a){this.emit("quality_level")});this.on_vjs("beforeresolutionchange",function(e){this.emit("beforeresolutionchange")});this.on_vjs("resolutionchange",function(){this.emit("resolutionchange")});this.on_vjs("volumechange",function(){this.emit("volumechange")});this.on_vjs("problem_report",function(e){this.emit("problem_report",e&&e.data?{data:e.data}:undefined)});this.on_vjs("save_logs",function(e){this.emit("save_logs",e&&e.data?{data:e.data}:undefined)});this.on_vjs("durationchange",function(){this.emit("duration_changed")});this.vjs.hola_logs=function(){var bws=window.hola_cdn&&window.hola_cdn.cdn_latest&&window.hola_cdn.cdn_latest.attached_bws;return bws?bws.get_logs():_this.log.get_logs()};this.stash=function(){var stash={on_sourceopen:this.on_sourceopen};if(stash.on_sourceopen)this.disable_data_mode();return function(){if(stash.on_sourceopen)this.enable_data_mode(stash.on_sourceopen)}.bind(this)};this.on("wrapper.check_skip_video",function(e){if(videojs&&videojs.HolaProviderHLS&&e.method=="hls"&&e.mode!="stats")return e.skip="method hls is not allowed, when hap_hls loaded";var is_adaptive=util.is_adaptive(_this.get_video_type_name());if(is_adaptive&&util.is_mode_cdn(_this.zone)&&!_this.module_ops)return e.skip="adaptive video, but no handler can handle";if(_this.tech!="flash"||videojs&&videojs.MediaSource||!util.is_progressive(_this.get_video_type_name())||!util.is_mode_cdn_or_bwsaver(_this.zone)){return}e.skip="missing flash MediaSource";try{var options=_this.vjs.options_,sources=options.sources;if(options.techOrder[0]=="flash")return;var html5=videojs.getTech("Html5");perr({id:"vjs_missing_flash_media_source",add_log:true,info:{canPlaySource:html5.canPlaySource(sources[0]),techOrder:options.techOrder,sources:sources}})}catch(err){}});this.is_enc_key=function(url){this.get_levels(true);return this.enc_keys&&this.enc_keys[url]};var handler;if(handler=Object.keys(E.ad_handlers).find(function(h){return E.ad_handlers[h].is_enabled({vjs:_this.vjs})})){this.ad_handler=new E.ad_handlers[handler](this);this.ad_handler.init()}};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){if(this.module_ops)this.module_ops=this.module_ops.uninit();if(this.ad_handler)this.ad_handler=this.ad_handler.uninit();this.events.removeAllListeners();for(var event in this.vjs_handlers){for(var i=0;i<this.vjs_handlers[event].length;i++)this.vjs.off(event,this.vjs_handlers[event][i])}if(this.schedule_end_of_stream_check){this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer);this.vjs.off("timeupdate",this.schedule_end_of_stream_check)}if(this.src_hook)this.src_hook.remove();if(this.src_unlock)this.src_unlock=this.src_unlock();delete this.vjs.hola_logs;this.zone_watch.uninit()};E.Player.prototype.set_cdn_mode=function(on){if(this.swf&&this.swf.hola_settings){this.swf.hola_settings({hls_mode:!!on,mode:on?"adaptive":"native"})}else this.log.err("swf missing holacdn hooks")};E.Player.prototype.get_url=function(){if(this.video_url)return this.video_url;var vjs=this.vjs;var src,cache;if(!this.gconfig.skip_caching){cache=vjs.cache_||this.gconfig.cache_field&&vjs[this.gconfig.cache_field]||{};src=this.vjs_adapter.src_from_cache(cache)}src=src||vjs.currentSrc();if((typeof src=="object"||util.is_blob_url(src))&&this.module)src=this.module.get_url();return src&&util.is_blob_url(src)&&this.blob2url[src]||src};E.Player.prototype.get_video_type_name=function(url){var t1=player_util.Player.prototype.get_video_type_name.call(this,url);if(this.wrong_currenttype)return t1;var mime=this.get_video_type();var t2=util.mime_to_type(mime);if(t1&&t1!=t2){this.wrong_currenttype=true;perr({id:"vjs_"+(t2?"wrong":"no")+"_currenttype",info:t1+" "+t2+" mime: "+mime})}return t1||t2};E.Player.prototype.get_video_type=function(){var type;if(is_vjs5())type=this.vjs.currentType();if(!type){var url=this.get_url();var srcs=(this.vjs.options_||this.vjs.options()).sources;var src=srcs&&srcs.find(function(s){return util.absolute_uri(s.src)==url});type=src&&src.type}if(!type){var tech2type={hlsjs:"application/x-mpegurl"};var tech=E.vjs_getTechName(this.vjs)||"";type=tech2type[tech.toLowerCase()]}return type||""};E.Player.prototype.get_ad_scheme=function(){return this.ad_handler&&this.ad_handler.get_ad_scheme()};E.Player.prototype.get_resolution=function(){return dom_util.get_elm_resolution(vjs_getElement(this.vjs))};E.Player.prototype.seek=function(ms){this.vjs.currentTime(ms/1e3)};E.Player.prototype.get_pos=function(){if(this.vjs_adapter.is_changing_src())return 0;return this.position||(this.position=this.vjs.currentTime())};util.module_fn(E,function get_state(){return this.state});E.Player.prototype.refresh_buffered=function(){if(this.vjs_adapter.is_changing_src())return{length:0};this.buffered=E.vjs_getBuffered(this.vjs,this.html5);this.position=this.vjs.currentTime();return this.buffered};E.Player.prototype.get_buffered=function(){if(this.vjs_adapter.is_changing_src())return{length:0};return this.buffered||this.refresh_buffered()};E.Player.prototype.get_duration=function(){if(zutil.is_mocha()||this.vjs.readyState&&!this.vjs.readyState()||this.vjs_adapter.is_changing_src()){return 0}return this.vjs.duration()};util.module_fn(E,function is_live_stream(){return this.vjs.osmf&&this.vjs.osmf.streamType?this.vjs.osmf.streamType()=="live":this.get_duration()===Infinity});E.Player.prototype.discontinuity=function(sbuf){this.media_src.swfObj.vjs_discontinuity()};E.Player.prototype.play=function(){this.vjs.play()};E.Player.prototype.pause=function(){this.vjs.pause()};util.module_fn(E,function play_url(url,pos,is_paused,video_type){var _this=this;setTimeout(function(){var srcs=(_this.vjs.options_||_this.vjs.options()).sources;var src_changed=srcs&&srcs.some(function(src){if(util.absolute_uri(src.src)==url){_this.vjs.src(src);return true}});if(!src_changed)_this.vjs.src({src:url,type:video_type});_this.vjs.load();if(!is_paused&&!pos)_this.vjs.play();var hls=get_hls_object(_this.vjs);var emmitter=hls&&hls.playlists||_this.vjs;var event=hls?"loadedmetadata":"canplay";emmitter.on(event,function cb(){emmitter.off(event,cb);if(!is_paused&&_this.vjs.paused())_this.vjs.play();if(!pos)return;if(_this.tech=="flash"){_this.vjs.on("timeupdate",function cb2(){if(_this.vjs.currentTime()==0)return;_this.vjs.off("timeupdate",cb2);_this.vjs.currentTime(pos)})}else _this.vjs.currentTime(pos)})},0)});E.Player.prototype._hide_src_change=function(from,to){if(this.src_unlock)this.src_unlock=this.src_unlock();if(!this.config.disable_src_change_hiding)this.src_unlock=E.hacks.hide_source_change(this.vjs,from,to)};E.Player.prototype.enable_data_mode=function(on_sourceopen){var _this=this,original_url=this.get_url();if(!this.media_src_api||!this.media_src_api.MediaSource){this.log.err("MSE not available, tech = "+this.tech+", window.MediaSource is"+(window.MediaSource?"":" not")+" enabled, used MediaSource API provider is "+(this.media_src_api===window?"window":"vjs"));throw new Error("MediaSource API not available")}this.media_src=new this.media_src_api.MediaSource({mode:this.tech=="flash"&&(this.media_src_api.FlashMediaSource||this.is_vjs5_new_hls)?"flash":"auto"});this.buffered=undefined;this.pending_sourceopen=true;this.vjs_adapter.replace_src(original_url,function(){var media_source_url=_this.media_src_api.URL.createObjectURL(_this.media_src);_this.blob2url[media_source_url]=original_url;_this._hide_src_change(original_url,media_source_url);return media_source_url});if(!this.config.disable_ended_fallback){var prev,vjs=this.vjs;this.schedule_end_of_stream_check=function(){if(prev==vjs.currentTime())return;prev=vjs.currentTime();_this.end_of_stream_timer=clearTimeout(_this.end_of_stream_timer);if(_this.seeking||!util.close_to_end(prev,vjs.duration()))return;_this.end_of_stream_timer=setTimeout(function(){var cur=vjs.currentTime(),dur=vjs.duration();if(!dur||!cur||vjs.ended()||!util.close_to_end(cur,dur)){return}_this.log.notice("schedule_end_of_stream_check fake ended "+"%s %s",cur,dur);perr({id:"vjs_ended_fallback",add_log:true,info:"previous: "+prev+" current: "+cur+" duration: "+dur});vjs.trigger(util.new_event("ended"));vjs.off("timeupdate",_this.schedule_end_of_stream_check)},1e3)};vjs.on("timeupdate",this.schedule_end_of_stream_check)}this.on_sourceopen=function(){this.pending_sourceopen=false;return on_sourceopen(this.media_src)}.bind(this);this.media_src.addEventListener("sourceopen",this.on_sourceopen);if(this.media_src.readyState=="open")on_sourceopen(this.media_src)};E.Player.prototype.disable_data_mode=function(){if(!this.media_src)return;this.media_src.removeEventListener("sourceopen",this.on_sourceopen);if(this.schedule_end_of_stream_check){this.vjs.off("timeupdate",this.schedule_end_of_stream_check);this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer)}this.media_src=this.pending_sourceopen=this.on_sourceopen=this.schedule_end_of_stream_check=undefined};util.module_fn(E,function is_playing(){return this.state=="PLAYING"});util.module_fn(E,function is_paused(){return this.state=="PAUSED"});util.module_fn(E,function is_idle(){return this.state=="IDLE"});E.Player.prototype.is_ad_source=function(){return this.ad_handler&&this.ad_handler.is_ad_source()||util.call_super(E,this,"is_ad_source")};E.Player.prototype.is_ad_active=function(){return this.ad_handler&&this.ad_handler.is_ad_active()};E.Player.prototype.is_ad_loading=function(){return this.ad_handler&&this.ad_handler.is_ad_loading()};E.Player.prototype.enable_context_menu=function(){if(!this.is_brightcove)return player_util.Player.prototype.enable_context_menu.call(this);var c=this.get_container();if(!c||!this.contextmenu_handler)return;c.removeEventListener("contextmenu",this.contextmenu_handler,{capture:true});delete this.contextmenu_handler};E.Player.prototype.disable_context_menu=function(){if(!this.is_brightcove)return player_util.Player.prototype.disable_context_menu.call(this);var c=this.get_container();if(!c||this.contextmenu_handler)return;this.contextmenu_handler=function(e){e.stopPropagation();e.preventDefault()};c.addEventListener("contextmenu",this.contextmenu_handler,{capture:true})};E.Player.prototype.get_captions_track=function(){for(var i=0;i<this.vjs.textTracks().length;i++){if(this.vjs.textTracks()[i].mode=="showing")return i}return-1};E.Player.prototype.set_captions_track=function(track){for(var i=0;i<this.vjs.textTracks().length;i++)this.vjs.textTracks()[i].mode="disabled";if(track>=0)this.vjs.textTracks()[track].mode="showing"};function process_osmf_levels(levels){var ret={};if(!levels||!levels.length)return ret;for(var i=0;i<levels.length;i++){var p=levels[i],url=p.url;if(ret[url]||!p.fragments)continue;var _p={url:url,segments:[]};ret[url]=_p;var bitrate=_p.bitrate=p.bitrate;for(var j=0;j<p.fragments.length;j++){var frag=p.fragments[j];_p.segments.push({playlist_url:url,media_index:frag.frag_no||j,url:frag.url,bitrate:bitrate,duration:frag.duration})}}return ret}E.Player.prototype.get_container=function(){return this.vjs.el()};util.module_fn(E,function get_levels(cached){if(this.vjs.osmf&&this.vjs.osmf.levels)return process_osmf_levels(this.vjs.osmf.levels());if(cached&&this.levels&&!this.levels_stale)return this.levels;var ret;var playlists=this.get_playlists();if(!playlists)return;playlists.forEach(function(p){if(!p.segments)return;ret=ret||{};ret[p.playlist]=p});this.levels_stale=false;return this.levels=ret});util.module_fn(E,function is_autostart(){return this.vjs.autoplay()});util.module_fn(E,function get_playlists(){if(this.vjs.osmf&&this.vjs.osmf.levels)return;var _this=this;function to_playlist(p){if(!p)return;var bitrate=0;var _p={playlist:p.uri,url:p.uri,attributes:{}};if(p.attributes){for(var a in p.attributes)_p.attributes[a.toLowerCase()]=p.attributes[a];bitrate=_p.bitrate=p.attributes.BANDWIDTH}_p.bitrate=bitrate;if(p.segments&&p.segments.length){_p.segments=[];p.segments.forEach(function(seg,i){var _url=seg.resolvedUri||resolve_url(base_url,p.uri,seg.uri);var _seg={playlist_url:p.uri,url:_url,duration:seg.duration,media_index:i+(p.mediaSequence||0),bitrate:bitrate};if(seg.key){_seg.key=seg.key.resolvedUri||resolve_url(base_url,p.uri,seg.key.uri);_this.enc_keys=_this.enc_keys||{};_this.enc_keys[_seg.key]=true}_p.segments.push(_seg)})}return _p}var base_url=this.get_url(),ret=[],playlists,_playlists;var vjs=this.vjs,hls_obj=get_hls_object(vjs),media,state;if(!hls_obj)return;if(!vjs.currentSrc()||!(playlists=hls_obj.playlists))return;if((state=playlists.state)=="HAVE_NOTHING"||!(media=playlists.media())||!media.segments){return}if(state=="SWITCHING_MEDIA")return;if(!playlists.master||!(_playlists=playlists.master.playlists))return;_playlists.forEach(function(p){ret.push(to_playlist(p))});ret.sort(function(a,b){return Math.sign(a.bitrate-b.bitrate)});return ret});util.module_fn(E,function get_current_playlist(){});util.module_fn(E,function get_segment_info(url){var info,levels;if(levels=this.get_levels(true)){for(var l in levels){if(info=levels[l].segments.find(function(s){return s.url==url})){return info}}}this.zperr({id:"vjs_no_segment_info",info:{url:url},add_log:true})});util.module_fn(E,function is_native_hls(){return this.tech=="html5"&&this.get_video_type_name()=="hls"&&!util.is_blob_url(html5.get_video_source(this.html5))});function get_hls_object(vjs){var hls_obj=vjs.tech_&&vjs.tech_.hls||vjs.hls;if(hls_obj&&!hls_obj.playlists)hls_obj=undefined;return hls_obj}function get_bitrate_byteark(vjs){try{return vjs.getLevelIndex()>0?vjs.getLevels()[vjs.getLevelIndex()-1].bitrate:0}catch(e){return 0}}util.module_fn(E,function get_bitrate(){var hls_obj=get_hls_object(this.vjs);if(!hls_obj){if(this.vjs.getLevels)return get_bitrate_byteark(this.vjs);return 0}var curr=hls_obj.playlists.media();return curr?(curr.attributes||{}).BANDWIDTH||0:0});util.module_fn(E,function get_current_fragment(){});util.module_fn(E,function get_current_level(){if(zutil.is_mocha())return 0;if(this.vjs.osmf&&this.vjs.osmf.currentLevel)return this.vjs.osmf.currentLevel();var hls_obj=get_hls_object(this.vjs);if(!hls_obj)return 0;var curr=hls_obj.playlists.media();return curr&&curr.uri});E.Player.prototype.get_bandwidth=function(){var hls_obj=get_hls_object(this.vjs);return(hls_obj||{}).bandwidth||0};E.Player.prototype.init_adaptive=function(adaptive){var _this=this,tech=E.vjs_getTechObj(this.vjs),hls;if(adaptive.adaptive=="hds"){this.on_manifestloaded=function(event,data){if(_this.is_live_stream())_this.emit("live_manifest",{url:data.url,format:"hds"})};tech.on("manifestloaded",this.on_manifestloaded);adaptive.on("uninit",function(){tech.off("manifestloaded",_this.on_manifestloaded)});util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");return void jsurlstream.init_adaptive(this,adaptive)}if(this.module)return this.module.init_adaptive&&this.module.init_adaptive(adaptive);if(hls=get_hls_object(this.vjs)){hls.playlists.on("loadedmetadata",function(){_this.emit("manifest_loaded")});hls.playlists.on("loadedplaylist",function(){_this.levels_stale=true;_this.emit("manifest_loaded")});if(tech){tech.on("levelloading",function(e,url){if(_this.is_live_stream())_this.emit("live_manifest",{url:url,format:"m3u8"})});tech.on("manifestparsed",function(){_this.emit("manifest_parsed")})}}var videojs=this.vjs.constructor;var xhr_cont=this.is_vjs5_new_hls?hls:videojs.Hls||videojs;var hook=util.inject_hook(xhr_cont,"xhr",adaptive.fallback_wrapper(function(e,args){var opt=args[0],callback=args[1];if(!opt||opt.responseType!="arraybuffer")return;var url=opt.uri||opt.url;if(hook.count()>1&&!_this.get_segment_info(url))return;if(_this.is_enc_key(url))return void _this.log.info("skip key file "+url);e.set_handled();if(typeof callback!="function")callback=function(){};var fake_xhr={abort:function(){if(!this.req||this.req.error===ERR.aborted)return;this.req.abort();adaptive.remove_segment(segment);_this.log.notice("req aborted",this.req)},requestTime:Date.now(),addEventListener:function(){if(!this.req.xhr)return _this.log.warn("addEventListener: not exposed xhr");this.req.xhr.addEventListener.apply(this.req.xhr,arguments)},removeEventListener:function(){if(!this.req.xhr){return _this.log.warn("removeEventListener: not exposed "+"xhr")}this.req.xhr.removeEventListener.apply(this.req.xhr,arguments)}};var segment={callback:callback,url:url,fake_xhr:fake_xhr,playlist_id:"def",dur:10,streaming:zutil.is_mocha()?_this.config.cdn_disable_streaming:false&&opt.streaming};adaptive.init_segment(segment);return fake_xhr}));adaptive.on("uninit",hook.remove.bind(hook));if(adaptive.adaptive=="hls"){adaptive.on("seg_complete",function(req){if(req.error||!req.opt.streaming||!req.served)return;var segment=req.info.segment,fake_xhr=segment.fake_xhr;fake_xhr.status=200;fake_xhr.response=null;fake_xhr.responseTime=Date.now();fake_xhr.roundTripTime=fake_xhr.responseTime-fake_xhr.requestTime;fake_xhr.bytesReceived=req.res.size;var bw=Math.floor(fake_xhr.bytesReceived/fake_xhr.roundTripTime*8*1e3);if(adaptive.bw_src&&adaptive.bw_src.bw>bw)bw=adaptive.bw_src.bw;fake_xhr.bandwidth=bw;fake_xhr.type="final";segment.callback.call(fake_xhr,undefined,is_vjs5()?fake_xhr:segment.url)})}};E.Player.prototype.ondata_adaptive=function(chunk,adaptive){if(adaptive.adaptive=="hds"){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");return void jsurlstream.ondata_adaptive(chunk,this,adaptive)}if(this.module){if(this.module.ondata_adaptive)this.module.ondata_adaptive(chunk,adaptive);return}var segment=chunk.req.info.segment;var callback=segment.callback,url=segment.url;var fake_xhr=segment.fake_xhr;if(!chunk.data||chunk.req.error){return void callback.call(fake_xhr,chunk.req.error||true,is_vjs5()?fake_xhr:url)}adaptive.indexer[segment.playlist_id].completed=segment.index;fake_xhr.status=200;fake_xhr.response=chunk.data;fake_xhr.responseTime=Date.now();fake_xhr.roundTripTime=fake_xhr.responseTime-fake_xhr.requestTime;fake_xhr.bytesReceived=fake_xhr.response.byteLength||fake_xhr.response.length;var bw=Math.floor(fake_xhr.bytesReceived/fake_xhr.roundTripTime*8*1e3);if(adaptive.bw_src&&adaptive.bw_src.bw>bw)bw=adaptive.bw_src.bw;fake_xhr.bandwidth=bw;if(chunk.req.opt.streaming)fake_xhr.type="progress";return callback.call(fake_xhr,false,is_vjs5()?fake_xhr:url)};util.module_fn(E,function get_decoded_frames(){if(this.vjs_adapter.is_changing_src())return 0;var el=vjs_getElement(this.vjs);if(!el)return 0;if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");return html5.get_decoded_frames(el)}return el.vjs_getProperty&&el.vjs_getProperty("decodedFrames")});util.module_fn(E,function get_dropped_frames(){if(this.vjs_adapter.is_changing_src())return 0;var el=vjs_getElement(this.vjs);if(!el)return 0;if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");return html5.get_dropped_frames(el)}return el.vjs_getProperty&&el.vjs_getProperty("droppedFrames")});E.Player.prototype.get_caps=function(){return player_util.Player.prototype.get_caps({save_context:["progressive","hls","hap_hls"],hap_provider_loaded:this.name=="hola"||!!(window.hola_videojs_hls||util.dom_query("script[src*=hola_videojs_hls]"))})};E.Player.prototype.get_est_bytes=function(){var hls=get_hls_object(this.vjs);if(hls&&hls.stats)return{bytes:hls.stats.mediaBytesTransferred,src:"vjs_hls"};var res=null;var el=vjs_getElement(this.vjs);if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");res=html5.est_bytes_from_tag(el)}if(!res)res=this._get_media_size_server();return res};E.Player.prototype.get_current_error=function(){return vjs_get_error(this)};E.Player.prototype.check_buffer=function(opt){var el=vjs_getElement(this.vjs);if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");html5.check_buffer.call(this,el,opt)}};E.Player.prototype.play_src=function(src,idx){src=src[idx||0];if(src.poster)this.vjs.poster(src.poster);this.vjs.src([{type:src.type,src:src.file||src.url}]);this.vjs.load();this.vjs.play()};E.Player.prototype.muted=function(v){return this.vjs.muted(v)};E.Player.prototype.volume=function(v){return this.vjs.volume(v)};function map_ad_events(vjs,player,map){Object.keys(map).forEach(function(ad_event){if(typeof map[ad_event]!="function"){var player_event=map[ad_event];map[ad_event]=function(){player.emit(player_event)}}vjs.on(ad_event,map[ad_event])});return function(){
Object.keys(map).forEach(function(ad_event){vjs.off(ad_event,map[ad_event])})}}E.ad_handlers={};E.ad_handlers.Contrib=function(player){this.ad_flag_re=/(^|\s)vjs-ad-(loading|playing)/;this.player=player;this.is_googima=!!this.get_ad_scheme().match("googima");this.log=player.log.set_module(this.is_googima?"googima":"adother")};E.ad_handlers.Contrib.is_enabled=function(opt){return opt.vjs.ads};E.ad_handlers.Contrib.prototype.get_ad_class=function(){var m,cls=this.player.get_container().className;return(m=cls.match(this.ad_flag_re))&&m[0].trim()};E.ad_handlers.Contrib.prototype.get_ad_scheme=function(){var vjs=this.player.vjs;return vjs.ima||vjs.ima3||vjs.ads._googleIma?"contrib/googima":"contrib/other"};E.ad_handlers.Contrib.prototype.init=function(){var _this=this,player=this.player,vjs=player.vjs;if(typeof vjs.ads=="function"){this.adinit_hook=util.inject_hook(vjs,"ads",{post_set:function(e,args){_this.adinit_hook=_this.adinit_hook.remove();_this.init()}});return this.log.info("contrib-ads awaiting plugin setup")}this.log.info("contrib-ads init state %s class %s",vjs.ads.state,this.get_ad_class()||"<not present>");var ad_info={};var vjs_contrib_ads_map={"contrib/googima":{adstart:function(){ad_info={};player.emit("ad_start");player.emit("ad_play")},adtimeupdate:"ad_time",adtimeout:"ad_timeout","ads-first-quartile":"ad_time","ads-midpoint":"ad_time","ads-third-quartile":"ad_time","ima3-resumed":"ad_play","ima3-paused":"ad_pause","ima3-skipped":function(){ad_info.skipped=true},adserror:"ad_error",adend:function(){player.emit(ad_info.skipped?"ad_skipped":"ad_complete")}},"contrib/other":{}};this.contrib_ad_map_uninit=map_ad_events(vjs,player,vjs_contrib_ads_map[this.get_ad_scheme()]);this.ad_state=this.calc_state();if(this.is_ad_active())this.ima_fix_state("PAUSED");this.adcls_unwatch=util.attr_watch(player.get_container(),{attr:"class",toggle_pattern:this.ad_flag_re,watch_fn:function(from,to){if(to){_this.log.info("ad mode started: %s detected",to.trim());_this.update_state()}else{_this.log.info("ad mode finished: %s removed",from.trim());_this.update_state()}}});this.adstat_hook=util.inject_hook(vjs.ads,"state",{set:function(e,args){_this.log.info("contrib-ads state changed: %s >> %s",vjs.ads.state,args[0]);_this.adstat_hook.original_handlers.set(args[0]);_this.update_state();e.set_handled()}})};E.ad_handlers.Contrib.prototype.ima_fix_state=function(target_state){var player=this.player;if(player.state==target_state)return;player.log.info("vjs ima_fix_state state %s>>%s ad_state %s",player.state,target_state,player.vjs.ads.state);player.state=target_state;player.emit("state",player.state);player.emit(target_state=="PAUSED"?"pause":"play")};E.ad_handlers.Contrib.prototype.calc_state=function(){var player=this.player,plugin_state=player.vjs.ads.state;if(!plugin_state||plugin_state.match(/^content-(playback|resuming)/)||!this.ad_flag_re.test(player.get_container().className)){return"IDLE"}return plugin_state=="ad-playback"?"PLAYING":"LOADING"};E.ad_handlers.Contrib.prototype.update_state=function(){var from=this.ad_state,to=this.ad_state=this.calc_state();if(from==to)return;var player=this.player;if(from=="IDLE"){this.ima_fix_state("PAUSED");player.emit("ad_suspend")}else if(to=="IDLE"){player.emit("ad_restore",{ad_empty:from=="LOADING"});if(player.play_during_ad){player.play_during_ad=false;player.emit("play");player.change_state("PLAYING")}else if(!player.vjs.ended()){this.ima_fix_state("PLAYING")}}};E.ad_handlers.Contrib.prototype.is_ad_source=function(){return false};E.ad_handlers.Contrib.prototype.is_ad_active=function(){return this.is_ad_loading()||this.is_ad_playing()};E.ad_handlers.Contrib.prototype.is_ad_loading=function(){return this.ad_state=="LOADING"};E.ad_handlers.Contrib.prototype.is_ad_playing=function(){return this.ad_state=="PLAYING"};E.ad_handlers.Contrib.prototype.uninit=function(){if(this.contrib_ad_map_uninit)this.contrib_ad_map_uninit();if(this.adcls_unwatch)this.adcls_unwatch();if(this.adstat_hook)this.adstat_hook.remove();if(this.adinit_hook)this.adinit_hook.remove()};E.ad_handlers.VastVpaid=function(player){this.player=player};E.ad_handlers.VastVpaid.is_enabled=function(opt){return opt.vjs.vast};E.ad_handlers.VastVpaid.prototype.get_ad_scheme=function(){return"vast"};E.ad_handlers.VastVpaid.prototype.init=function(){var _this=this,player=this.player,vjs=player.vjs;var ad_info=null;this.detect_ad_inplace=function(e){if(!vjs.vast.adUnit||(vjs.vast.adUnit.getSrc()||{}).src!=e.to)return;player.off("src_change",_this.detect_ad_inplace);_this.ads_attachable=true};this.is_vast_active=function(){return!!(vjs.vastClient&&vjs.controlBar.getChild("AdsLabel"))};this.vast_ad_start=function(){if(ad_info)return ad_info.skipped=false;ad_info={};player.emit("ad_start");player.emit("ad_play")};this.vast_ad_error=function(e){if(!ad_info)return;ad_info=null;player.emit("ad_error",e&&e.error&&e.error.message||"Unknown error")};this.vast_ad_skip=function(){if(ad_info)ad_info.skipped=true};this.vast_ad_complete=function(){player.log.notice("vjs vast.adEnd/vast.adCancel ad_info "+!!ad_info);if(!ad_info)return;player.emit(ad_info.skipped?"ad_skipped":"ad_complete");ad_info=null};this.vast_ad_map_uninit=map_ad_events(vjs,player,{"vast.adStart":this.vast_ad_start,"vast.adSkip":this.vast_ad_skip,"vast.adError":this.vast_ad_error,"vast.adEnd":this.vast_ad_complete,"vast.adsCancel":this.vast_ad_complete,"vpaid.AdImpression":"ad_impression","vpaid.AdSkipped":this.vast_ad_skip,"vpaid.pauseAd":"ad_pause","vpaid.resumeAd":"ad_play","hola.adConfigReqSending":"ad_config","hola.adDownload":"ad_download"});player.on("src_change",this.detect_ad_inplace);this.detect_ad_inplace({to:player.get_url()})};E.ad_handlers.VastVpaid.prototype.is_ad_source=function(){return this.ads_attachable&&this.is_vast_active()};E.ad_handlers.VastVpaid.prototype.is_ad_active=function(){return!this.ads_attachable&&this.is_vast_active()};E.ad_handlers.VastVpaid.prototype.is_ad_loading=function(){return false};E.ad_handlers.VastVpaid.prototype.uninit=function(){var player=this.player;player.off("src_change",this.detect_ad_inplace);this.vast_ad_map_uninit()};E.ad_handlers.ArtiMedia=function(player){this.player=player};E.ad_handlers.ArtiMedia.is_enabled=function(opt){return opt.vjs.artimedia};E.ad_handlers.ArtiMedia.prototype.get_ad_scheme=function(){return"artimedia"};E.ad_handlers.ArtiMedia.prototype.is_ad_source=function(){return false};E.ad_handlers.ArtiMedia.prototype.is_ad_active=function(){var ad=this.get_ad_instance(this.vjs);return ad&&ad.isPlaying&&ad.isPlaying()};E.ad_handlers.ArtiMedia.prototype.is_ad_loading=function(){return false};E.ad_handlers.ArtiMedia.prototype.init=function(){this.get_ad_instance=function(){var instances=window.artimediaInstances;var _el=this.player&&this.player.vjs&&this.player.vjs.el();if(!instances||!_el)return;for(var id in instances){var am=instances[id];var ad_frame=am.adContainer;var ad_el=ad_frame&&ad_frame.frameElement||am.vidElement;if(!ad_el)continue;if(_el.contains(ad_el))return am}}};E.ad_handlers.ArtiMedia.prototype.uninit=function(){};function resolve_url(src_url,playlist_url,segment_url){if(playlist_url==src_url)return util.resolve_url(src_url,segment_url);return util.resolve_url(util.resolve_url(src_url,playlist_url||""),segment_url)}function player_set_initial_state(player){var vjs=player.vjs;player.state="IDLE";player.ready=false;player.is_late_attach=function(){return player.is_playing()||player.is_ad_active()||!vjs_atInitPosition(vjs)};vjs.ready(function ready_cb(){if(!player.get_url()){if(!ready_cb.exec_count)player.log.info("waiting for videojs source setup");ready_cb.exec_count=(ready_cb.exec_count||0)+1;if(player.is_brightcove)setTimeout(ready_cb,100);else if(!vjs_getOptions("sources.length")){player.ready=true}return}player.ready=true;player.change_state({detect:true})},true)}function vjs_change_src(vjs,src){var was_playing=!vjs.paused();vjs.src(src);if(was_playing)vjs.ready(vjs.play.bind(vjs))}E.vjs_getTechObj=function(vjs){return vjs.tech_||vjs.tech};E.vjs_getTechName=function(vjs){var t;if(t=vjs.techName||vjs.techName_)return t;var el;if(!(el=vjs_getElement(vjs)))return"";return(t=el.id&&el.id.match(/_([a-zA-Z0-9]+)_api$/))&&t[1]||""};E.vjs_getTech=function(vjs){var t=E.vjs_getTechName(vjs).toLowerCase();if(t=="flash"||t=="html5")return t;var el=vjs_getElement(vjs);var tag=el&&el.tagName&&el.tagName.toLowerCase();return tag=="video"?"html5":tag=="object"?"flash":""};E.vjs_getBuffered=function(vjs,html5){return html5&&!vjs_version?html5.buffered:vjs.buffered()};function vjs_is_brightcove(vjs){return/(^|\s)bc-player/.test(vjs.el().className)}function vjs_get_html5(vjs){var el=vjs_getElement(vjs);return is_video_element(el)?el:undefined}function vjs_get_error(player,a){var err_map={1:{message:"download was cancelled",reason:"other"},2:{message:"network error",reason:"media_load"},3:{message:"decode error",reason:"media_decode"},4:{message:"source not supported",reason:"media_support"},5:{message:"encryption error",reason:"media_decode"},unknown:{message:"unknown",reason:"other"},"-1":{message:"no video was loaded",reason:"other"},"-2":{message:"timeout",reason:"media_load"}};var code,msg;if(player.vjs.error){var ops,error=player.vjs.error();if(!error)return;code=error.code;msg=error.message;if((ops=player.module_ops)&&ops.is_err_allowed&&ops.is_err_allowed(error)){return}}code=code||a.target&&a.target.error&&a.target.error.code||a.code;var info=err_map[code]||err_map.unknown;msg=msg||a.message||info.message;return{code:code,reason:info.reason,message:msg}}function vjs_atInitPosition(vjs){var el;if(!(el=vjs_get_html5(vjs)))return!vjs.currentTime();return html5.at_init_position(el)}E.vjs_getElement=vjs_getElement;function vjs_getElement(vjs){var tech=E.vjs_getTechObj(vjs),el=tech&&(tech.el_||tech.el);if(!el&&typeof vjs.el=="function")el=vjs.el().getElementsByClassName("vjs-tech")[0];return typeof el=="function"&&!(el instanceof Node)?el():el}function is_video_element(el){return el&&el.tagName&&el.tagName.toLowerCase()=="video"}function vjs_getOptions(vjs,path){return path?zutil.get(vjs.options_,path):vjs.options_}E.hacks={};E.hacks.hide_source_change=function(vjs,facade_src,surrogate_src){var proxy_fn=function(e,args,based_on){if(args[0]!==undefined)return;var real_src=based_on.original_handlers.exec();if(real_src!=surrogate_src)return;e.set_handled();return facade_src};var hooks={src:util.inject_hook(vjs,"src",function(e,args){return proxy_fn(e,args,hooks.src)}),csrc:util.inject_hook(vjs,"currentSrc",function(e,args){return proxy_fn(e,args,hooks.csrc)})};return function(){Object.keys(hooks).forEach(function(name){hooks[name].remove()})}};E.adapters={};E.adapters.v6=function(vjs){function register_mw(){var videojs=window.videojs||vjs.constructor;if(!videojs||register_mw.attached)return;videojs.use("video/mp4",function(){return{setSource:function(src,next){if(src.hola_media_src_gen)src.src=src.hola_media_src_gen();next(null,src)}}});register_mw.attached=true}return{replace_src:function(src,create_cb){register_mw();vjs_change_src(vjs,{src:src,type:"video/mp4",hola_media_src_gen:create_cb})},src_from_cache:function(cache){return vjs.changingSrc_?cache.source.src:cache.src},is_changing_src:function(){return vjs.changingSrc_}}};E.adapters.v4_5=function(vjs){return{replace_src:function(src,create_cb){vjs_change_src(vjs,{src:create_cb(),type:"video/mp4"})},src_from_cache:function(cache){return cache.src},is_changing_src:function(){}}};return E});
define("/svc/cdn/pub/osmf.js",["/util/util.js","/svc/cdn/pub/map.js","/svc/cdn/pub/util.js","/svc/cdn/pub/jsurlstream.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js"],function(zutil,map,util,jsurlstream,player_util,dom_util){var E={};var api=util.get_api();function is_state_waiting(state){return/BUFFERING/.test(state)}E.Player=function(opt){var _this=this;util.call_super(E,this,null,opt);this.player_id=opt.player_id||1;this.name="osmf";if(this.swf=opt.osmf.flashObject||opt.osmf)this.flash_api=player_util.build_flash_api(this);this.osmf=opt.osmf;this.tech="flash";this.log=this.zone.log_get().set_module("osmf");this.bitrate={};this.level_url={};if(this.swf.hola_settings)this.swf.hola_settings({player_id:this.player_id});var started_sent=false;api.onOsmfEvent=function(data){_this.on_msg({data:data})};this.on_msg=function(e){if(!e.data||(e.data.player_id||1)!=_this.player_id)return;var id=e.data.id;if(!id)return;var state=e.data.state;switch(id){case"osmf.mediaTime":_this.refresh_buffered();_this.emit("timeupdate",_this.get_pos());return;case"osmf.playbackState":if(!started_sent){_this.emit("started",_this.get_url());started_sent=true}_this.emit("state",state);if(is_state_waiting(state))_this.emit("waiting");else if(state=="PLAYING")_this.emit("play");else if(state=="PAUSED")_this.emit("pause");return;case"osmf.seekState":if(state=="SEEKING")_this.emit("seeking");else if(state=="SEEKED")_this.emit("seeked");return;case"osmf.levelSwitch":_this.level=e.data.level;_this.emit("quality_level");return;case"osmf.playBackComplete":_this.log.notice("osmf.js ended");_this.emit("ended");return;case"osmf.manifestLoading":_this.log.notice("osmf.js started");if(!started_sent){_this.emit("started",_this.get_url());started_sent=true}return;case"osmf.manifestParsed":_this.emit("manifest_parsed");return;case"osmf.error":_this.emit("error",{reason:"other",message:"unknown"});return;case"osmf.fragmentLoaded":_this.bandwidth=e.data.loadMetrics.bandwidth;return}};window.addEventListener("message",this.on_msg)};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){window.removeEventListener("message",this.on_msg)};E.Player.prototype.set_cdn_mode=function(on){this.swf.hola_settings({hls_mode:!!on,mode:on?"adaptive":"native"})};E.Player.prototype.get_url=function(){return this.swf.hola_osmf_get_video_url()};E.Player.prototype.seek=function(ms){this.log.warn("XXX osmf stub")};E.Player.prototype.get_pos=function(){return this.swf.hola_osmf_get_position()||0};E.Player.prototype.refresh_buffered=function(){var from=this.get_pos(),ret={};var to=from+(this.swf.hola_osmf_get_buffer_sec()||0);ret.length=from==to?0:1;ret.start=function(i){return from};ret.end=function(i){return to};return this.buffered=ret};E.Player.prototype.get_buffered=function(){return this.buffered||this.refresh_buffered()};E.Player.prototype.get_duration=function(){return this.swf.hola_osmf_get_duration()};E.Player.prototype.is_live_stream=function(){var type=this.swf.hola_osmf_get_stream_type();return type=="live"||type=="dvr"};E.Player.prototype.discontinuity=function(sbuf){this.log.warn("XXX osmf stub")};E.Player.prototype.play=function(){this.log.warn("XXX play stub")};E.Player.prototype.pause=function(){this.log.warn("XXX pause stub")};E.Player.prototype.play_url=function(url,pos,is_paused,video_type){this.log.warn("XXX play_url stub")};E.Player.prototype.enable_data_mode=function(on_sourceopen){this.log.warn("XXX osmf stub")};E.Player.prototype.disable_data_mode=function(){};E.Player.prototype.get_state=function(){return this.swf.hola_osmf_get_state()};E.Player.prototype.is_playing=function(){var state=this.swf.hola_osmf_get_state();return state=="PLAYING"||state=="PLAYING_BUFFERING"};E.Player.prototype.is_paused=function(){return!this.is_idle()&&!this.is_playing()};E.Player.prototype.is_idle=function(){return!this.swf.hola_osmf_get_state||this.swf.hola_osmf_get_state()=="IDLE"};E.Player.prototype.get_container=function(){return this.swf};E.Player.prototype.get_levels=function(){var levels=this.swf.hola_osmf_get_levels();var ret={};if(!levels||!levels.length)return ret;for(var i=0;i<levels.length;i++){var p=levels[i],url=p.url;if(ret[url]||!p.fragments)continue;var _p={url:url,segments:[]};ret[url]=_p;var bitrate=_p.bitrate=p.bitrate;for(var j=0;j<p.fragments.length;j++){var frag=p.fragments[j];_p.segments.push({playlist_url:url,media_index:frag.frag_no||j,url:frag.url,bitrate:bitrate,duration:frag.duration})}}return ret};E.Player.prototype.get_playlists=function(){};E.Player.prototype.get_current_playlist=function(with_segments){};E.Player.prototype.get_segment_info=function(){};E.Player.prototype.get_bitrate=function(){var level=this.get_current_level();if(this.bitrate[level])return this.bitrate[level];var levels=this.get_levels();if(!levels||!levels[level])return 0;return this.bitrate[level]=levels[level].bitrate||0};E.Player.prototype.get_current_fragment=function(){};E.Player.prototype.is_autostart=function(){return false};E.Player.prototype.get_current_level=function(){var level=this.level!==undefined?this.level:this.swf.hola_osmf_get_level&&this.swf.hola_osmf_get_level();if(level===undefined)return;if(this.level_url[level])return this.level_url[level];var levels=this.swf.hola_osmf_get_levels()||{};return this.level_url[level]=(levels[level]||{}).url};E.Player.prototype.get_bandwidth=function(){return this.bandwidth||0};E.Player.prototype.get_resolution=function(){return dom_util.get_elm_resolution(this.swf)};E.Player.prototype.init_adaptive=function(adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.init_adaptive(this,adaptive)};E.Player.prototype.ondata_adaptive=function(chunk,adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.ondata_adaptive(chunk,this,adaptive)};E.Player.prototype.get_decoded_frames=function(){};E.Player.prototype.get_dropped_frames=function(){};E.is_hola_osmf_object=function(el){return el&&el.hola_osmf_get_video_url};return E});
define("/svc/cdn/pub/android.js",{__stub:1});
define("/svc/cdn/pub/youtube.js",{__stub:1});
define("filesaver",[],function(){var saveAs=saveAs||function(e){if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,i=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},a=/constructor/i.test(e.HTMLElement),f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d="application/octet-stream",s=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,s)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(i){u(i)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,s){if(!s){t=p(t)}var v=this,w=t.type,m=w===d,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&a)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;i(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);return saveAs});
define("/svc/cdn/pub/flowplayer.js",{__stub:1});
define("/svc/cdn/pub/mode.js",["/util/user_agent.js","/svc/cdn/pub/log.js","/svc/cdn/pub/util.js","/util/version_util.js","/util/util.js"],function(user_agent,_log,util,version_util,zutil){var E={};var log=_log.set_module("mode");var formats={mp4:"mp4",m4p:"mp4",m3u8:"hls",mpd:"dash",m4v:"mp4",f4m:"hds",flv:"flv",webm:"webm"};var matrix=function(){var mp4_holavjs_jw={windows:{"*":{chrome:{"*":"*"},opera:{"*":"*"},firefox:function(p){if(p.os_version=="xp")return"";return p.browser_version>=42?"*":"fl"},edge:{"*":"*"},ie:function(p){var bv=p.browser_version;return bv>=11&&p.os_version>=8?"*":bv>=10?"fl":""}}},linux:{"*":{chrome:{"*":"*"},opera:{"*":"fl"},firefox:{"*":"fl"}}},macos:{"*":{chrome:{"*":"*"},opera:{"*":"fl"},firefox:{"*":"fl"},safari:{"*":"*"}}},android:{"*":{chrome:{"*":"h5"}}}};var flv_holavjs_jw=function(p){return p.browser=="ie"&&(p.browser_version==9||p.browser_version==10&&p.os_version==8)?"":"fl"};var h5_if_ms=function(){return window.MediaSource?"h5":""};return{mp4:{hola_vjs:mp4_holavjs_jw,hola_vjs5:mp4_holavjs_jw,vjs6:mp4_holavjs_jw,flowplayer6:mp4_holavjs_jw,flowplayer7:mp4_holavjs_jw,clappr:mp4_holavjs_jw,kaltura:mp4_holavjs_jw,vjs:function(p){return p.browser=="firefox"||p.browser=="ie"||p.os=="linux"&&p.browser=="opera"?"":"h5"},jw:mp4_holavjs_jw,html5:function(p){if(p.browser=="firefox"&&p.os_version=="xp")return"";return h5_if_ms()},byteark:function(p){if(p.browser=="firefox"&&p.os_version=="xp")return"";return h5_if_ms()}},flv:{hola_vjs:flv_holavjs_jw,hola_vjs5:flv_holavjs_jw,jw:flv_holavjs_jw},hds:{hola_vjs:flv_holavjs_jw,hola_vjs5:flv_holavjs_jw},hls:{hola_vjs:function(p){return p.browser=="ie"&&p.browser_version==9?"":"fl"},hola_vjs5:function(p){return p.browser=="ie"&&p.browser_version==9?"":"*"},vjs4:function(p){return p.browser=="ie"&&p.browser_version==9?"":"*"},flowplayer6:function(){return"*"},flowplayer7:function(){return"*"},clappr:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},jw:function(p){return p.browser=="ie"&&p.browser_version==9||p.os=="windows"&&(p.os_version=="8"||p.os_version=="8.1")&&p.browser=="firefox"?"":"*"},dailymotion:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},byteark:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},kaltura:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"}},dash:{dashjs:h5_if_ms,shaka:h5_if_ms,hola_vjs5:h5_if_ms,flowplayer6:h5_if_ms,flowplayer7:h5_if_ms},webm:{"*":function(p){return p.browser=="chrome"?"h5":""}}}}();function check_obj_path(obj,path,order){var part=path[order.shift()];if((obj=obj[part]||obj["*"])===undefined)return false;return order.length?typeof obj=="function"?obj(path):check_obj_path(obj,path,order):obj}function get_format(url){var ext=/(?:\.([^.\/?#]+))?([?#].*)?$/.exec(url)[1];return ext?formats[ext]:url}E.get_available_tech_by_env=function(path,order){return check_obj_path(matrix,path,order)};E.get_available_tech=function(url,player){function is_flash_enabled(){try{return!!new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){var mime="application/x-shockwave-flash";return!!(navigator.mimeTypes&&navigator.mimeTypes[mime]&&navigator.mimeTypes[mime].enabledPlugin)}}var guess=user_agent.guess();var browser=user_agent.guess_browser();var path={format:get_format(url),player:player,os:guess.os,os_version:guess.version,browser:browser.opera?"opera":browser.browser,browser_version:browser.version};var order=["format","player","os","os_version","browser","browser_version"];var tech=E.get_available_tech_by_env(path,order.slice());log.notice("Available tech for ["+order.map(function(o){return path[o]}).join(", ")+"] is "+tech);switch(tech){case"fl":return{flash:is_flash_enabled(),html5:false};case"h5":return{flash:false,html5:true};case"*":return{flash:is_flash_enabled(),html5:true};default:return{flash:false,html5:false}}};E.is_ip_blacklisted=function(opt){var blacklist=opt.CG("loader.ip_blacklist")||[];if(util.geoip&&util.geoip.ip&&blacklist.includes(util.geoip.ip))return true};E.is_browser_supported=function(){var version=util.browser.version;if(!util.is_android&&!util.is_windows&&!util.is_linux&&!util.is_ios&&!util.is_mac&&!util.is_webos){return false}if(util.is_android&&util.guess.version<4.4)return false;if(util.conf_get("customer")=="hc_9e6cd09b"&&util.is_android&&(util.guess.version<4.5||version<48)){return false}if(util.is_webos&&version_util.cmp(version,"38")<0)return false;if(util.is_edge)return true;if(util.is_ie&&version>=(util.is_mobile?11:8))return true;if(util.is_chrome&&version>=(util.is_mobile?30:23))return true;if(util.is_firefox&&!util.is_mobile&&version>=37)return true;if(util.is_opera&&version>=(util.is_mobile?30:15))return true;if(typeof version=="string")version=version.replace(/_/g,".");if(!util.is_safari)return false;return util.is_ios_sdk||version_util.cmp(version,"10")>=0};E.select_mode=function(opt){function storage_mode(){try{return window.sessionStorage.getItem("hola_mode")||localStorage.getItem("hola_mode")}catch(e){}}function debug_compatible_mode(){var debug_compatible;try{debug_compatible=localStorage.hola_debug_compatible_browser}catch(e){}if(debug_compatible!=undefined)debug_compatible=debug_compatible||"disabled";return debug_compatible}function browser_rule_mode(r){if(r.browser&&r.browser!=util.browser_rule_s||r.os&&r.os!=util.guess.os&&r.os!="*"){return false}var rand=util.get_random("mode");var p=r.cdn||0;if(rand<p)return"cdn";p+=r.bwsaver||0;if(rand<p)return"bwsaver";p+=r.stats||0;if(rand<p)return"stats";return"disabled random"}function mode_create(mode,reason){mode=mode=="hola_cdn"?"cdn":mode=="origin_cdn"?"stats":mode;return{mode:mode,disabled_reason:mode=="disabled"?reason:null,disabled_help:mode=="disabled"&&reason}}var url=opt.location||location;try{url.toString()}catch(e){url=location}var CG=opt.CG,r_mode,mode;if(opt.suspended){mode="stats";r_mode=mode_create(mode,"force_stats_on_suspended_account")}else if(opt.method=="hls"&&!CG("wrapper.disable_force_stats_on_hls")&&opt.hap_provider_loaded&&CG("provider.register_percent",100)){mode="stats";r_mode=mode_create(mode,"force_stats_on_hls")}else if(mode=util.get_hola_uri(url,"hola_mode"))r_mode=mode_create(mode,"uri");else if(mode=storage_mode())r_mode=mode_create(mode,"storage");else if(require.zdot("disabled"))r_mode=mode_create("disabled","conf");else if(mode=CG("loader.mode"))r_mode=mode_create(mode,"conf");else if(mode=debug_compatible_mode())r_mode=mode_create(mode,"debug_compatible");else if(!E.is_browser_supported())r_mode=mode_create("disabled","browser_unsupported");else if(E.is_ip_blacklisted(opt))r_mode=mode_create("disabled","ip_blacklist");else{var rl=opt.rules||CG("loader.rules")||[],ret;for(var i=0;i<rl.length&&!(ret=browser_rule_mode(rl[i]));i++);ret=(ret||"disabled no_browser_match").split(" ");r_mode=mode_create(ret[0],ret[1])}if(!["disabled","stats","bwsaver","cdn"].includes(r_mode.mode)){log.err("unknown mode="+r_mode.mode+", forcing disabled");r_mode=mode_create("disabled","mode_unknown")}return r_mode};return E});
define("/svc/cdn/pub/ios.js",{__stub:1});
define("/svc/cdn/pub/hola_vjs.js",["/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/html5.js","/util/version_util.js","/svc/cdn/pub/dailymotion.js","/svc/cdn/pub/flashls.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/jsurlstream.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js"],function(zutil,util,html5,version_util,dailymotion,flashls,dash,jsurlstream,player_util,dom_util){var E={};var perr=util.cdn_perr;var ad_flag_re=/(^|\s)vjs-ad-(playing|loading)/;var ad_loading_flag_re=/(^|\s)vjs-ad-loading/;E.Player=function(opt){util.call_super(E,this,null,opt);var _this=this;this.player_id=opt.player_id||1;this.vjs=this.video=opt.video;this.tech=opt.tech;this.name="hola";this.is_vjs5_new_hls=true;this.log=this.zone.log_get().set_module("hola");if(opt.html5)this.html5=opt.html5;this.media_src_api=opt.tech=="html5"&&window.MediaSource?window:window.videojs;this.position=0;this.blob2url={};this.vjs_handlers={};this.media_type="video";this.on("wrapper_attached",function(){_this.vjs.trigger("hola.wrapper_attached")});this.on("wrapper_detached",function(){_this.vjs.trigger("hola.wrapper_detached")});this.on_vjs=function(events,handler){var wrapper=function(e){if(this.ready)handler.call(this,e)}.bind(this);[].concat(events).forEach(function(event){_this.vjs_handlers[event]=(_this.vjs_handlers[event]||[]).concat(wrapper);_this.vjs.on(event,wrapper)});return wrapper};this.zone_watch=this.zone.conf_watch([{conf:{disable_ended_fallback:"player.disable_ended_fallback",disable_src_check:"player.disable_src_check"},onchange:function(ctx,from,to){_this.config=to},uninit:function(){_this.config={}}},{conf:"player.log_all_events",ontoggle:function(ctx,to){if(to)ctx.events={};var all_events=["durationchange","ready","controlsenabled","firstplay","waiting","loadedqualitydata","userinactive","stalled","ads-cuepoints","adsready","readyforpreroll","ads-load","adstart","adskip","ads-impression","ads-ad-started","ads-first-quartile","ads-midpoint","ads-third-quartile","ads-ad-ended","adend","ads-click","ads-ad-skipped","ads-mute","nopreroll"];all_events.forEach(function(e){if(to){ctx.events[e]=_this.on_vjs(e,function(){_this.log.info('vjs event "%s"',e)})}else if(ctx.events&&Object.keys(ctx.events).length)_this.vjs.off(e,ctx.events[e])})}}]);this.module_handlers={dashjs:function(){var is_dashjs_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="dash"&&window.videojs.Html5DashJS};if(!is_dashjs_env())return;util.assert_enabled(dash,"dash module is required but disabled");var vjs_dashjs_get=function(vjs){return vjs.tech_.sourceHandler_.mediaPlayer_};var dash_obj=vjs_dashjs_get(_this.vjs);dash.patch_dashjs(dash_obj);_this.module=new dash.Module({html5:opt.html5||vjs_getElement(_this.vjs),zone:_this.zone,dashjs:dash_obj,vjs:_this.vjs});return{changed:function(){return!is_dashjs_env()||dash_obj!=vjs_dashjs_get(_this.vjs)},uninit:function(){_this.module.uninit();_this.module=undefined}}},flashls:function(){var is_flashls_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="hls"&&opt.flashls};if(!is_flashls_env())return;util.assert_enabled(flashls,"flashls module is required but disabled");_this.module=new flashls.Player({flashls:opt.flashls,zone:opt.zone,player_id:_this.player_id,vjs:_this.vjs});_this.flash_api=_this.module.flash_api;_this.module.on("level_loaded",_this.flashls_level_loaded=function(lvl){_this.emit("level_loaded",lvl)});util.create_forwarding_emit(_this);return{changed:function(){return!is_flashls_env()},uninit:function(){if(!_this.module)return;_this.module.off("level_loaded",_this.flashls_level_loaded);_this.flash_api=undefined;_this.module.uninit();_this.module=_this.hls_level_loaded=undefined}}},vjs_osmf:function(){var vjs_osmf_get=function(vjs){return vjs.osmf&&vjs.osmf.el_};var is_osmf_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="hds"&&vjs_osmf_get(_this.vjs)};if(!is_osmf_env())return;var swf=vjs_osmf_get(_this.vjs);_this.module=new Osmf({vjs:_this.vjs,swf:swf,zone:opt.zone,player_id:_this.player_id});_this.flash_api=_this.module.flash_api;return{changed:function(){return!is_osmf_env()||swf!=vjs_osmf_get(_this.vjs)},uninit:function(){if(!_this.module)return;_this.module.uninit();_this.flash_api=_this.module=undefined}}},hola_hls:function(){var vjs_hls_get=function(vjs){return vjs.tech_.hls_obj};var is_hola_hls_env=function(){var adaptive=_this.get_video_type_name();return adaptive=="hls"&&window.videojs.HolaProviderHLS&&vjs_hls_get(_this.vjs)};if(!is_hola_hls_env())return;util.assert_enabled(dailymotion,"dailymotion module is required but disabled");var hls_obj=vjs_hls_get(_this.vjs);_this.module=new dailymotion.Module({html5:opt.html5||vjs_getElement(_this.vjs),zone:_this.zone,dailymotion:hls_obj,vjs:_this.vjs,player:_this});var get_media_type=function(levels){if(!levels||!levels.length)return"video";var is_video=0;levels.forEach(function(level){var frag=level.details&&level.details.fragments&&level.details.fragments[0];var url=frag&&frag.url;var ext=url&&url.split("?")[0].substr(-3).toLowerCase();is_video+=+!!(level.videoCodec||!level.audioCodec&&(level.bitrate>64e3||level.width||level.height)||!level.bitrate&&ext&&ext!="aac")});return is_video?"video":"audio"};_this.media_type=get_media_type(hls_obj.levels);util.create_forwarding_emit(_this);_this.hls_manifest_loaded=function(){_this.media_type=get_media_type(hls_obj.levels);_this.emit("media_type",_this.media_type);_this.emit("manifest_loaded")};_this.module.on("manifest_loaded",_this.hls_manifest_loaded);_this.module.on("level_loaded",_this.hls_level_loaded=function(lvl){_this.media_type=get_media_type(hls_obj.levels);_this.emit("level_loaded",lvl)});_this.module.on("level_updated",_this.hls_level_updated=function(lvl){_this.emit("level_updated",lvl)});_this.module.on("seg_stats",_this.hls_seg_stats=function(lvl){_this.emit("seg_stats",lvl)});_this.module.on("buf_stats",_this.hls_buf_stats=function(lvl){_this.emit("buf_stats",lvl)});_this.module.on("frag_load_stats",_this.hls_frag_load_stats=function(d){_this.emit("frag_load_stats",d)});_this.module.on("error",_this.hls_error=function(lvl){_this.emit("error",lvl)});return{changed:function(){return!is_hola_hls_env()||hls_obj!=vjs_hls_get(_this.vjs)},uninit:function(){if(!_this.module)return;_this.module.off("manifest_loaded",_this.hls_manifest_loaded);_this.module.off("level_loaded",_this.hls_level_loaded);_this.module.off("level_updated",_this.hls_level_updated);_this.module.off("seg_stats",_this.hls_seg_stats);_this.module.off("buf_stats",_this.hls_buf_stats);_this.module.off("frag_load_stats",_this.hls_frag_load_stats);_this.module.uninit();_this.module=_this.hls_level_loaded=undefined;_this.hls_seg_stats=_this.hls_buf_stats=undefined;_this.hls_manifest_loaded=undefined;_this.hls_level_updated=undefined;_this.hls_frag_load_stats=undefined}}}};this.on("pre-started",this.module_reconf=function(){if(_this.module_ops){if(!_this.module_ops.changed())return;_this.module_ops.uninit()}Object.keys(_this.module_handlers).find(function(h){return _this.module_ops=_this.module_handlers[h]()})});this.module_reconf();player_set_initial_state(this);function change_state(state){if(_this.state==state)return;_this.state=state;var map={PLAYING:"play",PAUSED:"pause",IDLE:"ended"};_this.emit(map[state]);_this.emit("state",state)}["next_suggestion_show","next_suggestion_hide","next_suggestion_play"].forEach(function(e){_this.on_vjs(e,function(a){_this.emit(a.type)})});this.on_vjs("seeked",function(a){this.seeking=false;this.emit("seeked");if(this.is_paused()&&!this.vjs.paused())change_state("PLAYING");if(this.is_playing()&&this.vjs.paused())change_state("PAUSED");if(this.schedule_end_of_stream_check)this.schedule_end_of_stream_check()});this.on_vjs("ended",function(a){if(this.ended_edge_hack){a.preventDefault();this.ended_edge_hack=false;this.vjs.play();return}change_state("IDLE")});this.on_vjs("seeking",function(a){this.seeking=true;this.prev_position=this.position;this.position=this.vjs.currentTime();this.emit("seeking",this.prev_position,this.position);if(this.end_of_stream_timer)this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer)});var play_during_ad=false;this.on_vjs("pause",function(a){this.log.info("vjs pause state "+this.state+" seeking "+this.seeking+" ad_playback "+this.is_ad_active());if(this.seeking)return;if(this.state=="IDLE")return;play_during_ad=false;change_state("PAUSED")});var has_play=false;this.on_vjs("play",function(a){this.log.info("vjs play state "+this.state+" seeking "+this.seeking+" ad_playback "+this.is_ad_active()+" has_play "+has_play);if(this.seeking&&has_play&&this.state!="IDLE")return;has_play=true;if(this.is_ad_active()){play_during_ad=true;return}play_during_ad=false;if(this.state=="IDLE"){this.seeking=false;if(util.is_edge&&this.vjs.ended()&&this.vjs.paused())this.ended_edge_hack=true;this.emit("started",this.get_url())}if(this.adjust_pos&&this.html5&&this.html5.currentTime)this.html5.currentTime+=.1;change_state("PLAYING")});this.on_vjs("waiting",function(a){this.emit("waiting")});this.on_vjs("error",function(a){var err;if(err=vjs_get_error(this,a))this.emit("error",err)});this.on_vjs("timeupdate",function(a){this.refresh_buffered();this.emit("timeupdate",this.position)});this.on_vjs("adstart",function(){this.emit("ad_start");this.emit("ad_play")});this.on_vjs("durationchange",function(){this.emit("duration_changed")});var ad_skipped;this.on_vjs(["adtimeupdate","ads-first-quartile","ads-midpoint","ads-third-quartile"],function(){this.emit("ad_time")});this.on_vjs("ads-impression",function(){this.emit("ad_impression")});this.on_vjs("ads-pause",function(){this.emit("ad_pause")});this.on_vjs("ads-play",function(){this.emit("ad_play")});this.on_vjs("adserror",function(){this.emit("ad_error")});this.on_vjs("adtimeout",function(){this.emit("ad_timeout")});this.on_vjs("ads-ad-skipped",function(){ad_skipped=true});this.on_vjs("adend",function(){this.emit(ad_skipped?"ad_skipped":"ad_complete")});this.on_vjs("contentplay",function(){change_state("PLAYING")});this.on_vjs("mediachange",function(a){this.emit("quality_level")});this.on_vjs("beforeresolutionchange",function(e){if(this.media_src){this.interrupted=true;this.emit("interrupted")}this.emit("beforeresolutionchange")});this.on_vjs("resolutionchange",function(){if(this.interrupted){this.interrupted=false;this.emit("started",this.get_url())}this.emit("resolutionchange")});this.on_vjs("volumechange",function(){this.emit("volumechange")});this.on_vjs("problem_report",function(e){this.emit("problem_report",e&&e.data?{data:e.data}:undefined)});this.on_vjs("save_logs",function(e){this.emit("save_logs",e&&e.data?{data:e.data}:undefined)});this.vjs.hola_logs=function(){return _this.bws?_this.bws.get_logs():_this.log.get_logs()};if(this.vjs.ads){this.log.info("contrib-ads init state %s adclass %s",this.vjs.ads.state,vjs_getAdClass(this.vjs)||"<not present>");this.adcls_unwatch=util.attr_watch(this.get_container(),{attr:"class",toggle_pattern:ad_flag_re,watch_fn:function(from,to){if(to){_this.log.info("ad mode started: %s detected",to.trim());setTimeout(function(){_this.emit("ad_suspend")})}else{_this.log.info("ad mode finished: %s removed",from.trim());if(_this.is_paused()&&!_this.vjs.paused()&&!_this.vjs.ended()){change_state("PLAYING")}_this.emit("ad_restore",{ad_empty:!!from.match(ad_loading_flag_re)});if(play_during_ad){play_during_ad=false;change_state("PLAYING")}}}});this.adstat_hook=util.inject_hook(this.vjs.ads,"state",{set:function(e,args){_this.log.info("contrib-ads state changed: %s >> %s",_this.vjs.ads.state,args[0])}})}this.change_src=function(src){var vjs=this.vjs;if(vjs.ads)vjs.ads.contentSrc=src;if(this.is_ad_active()&&vjs.ads&&vjs.ads.snapshot){vjs.ads.snapshot.src=vjs.ads.snapshot.currentSrc=src;vjs.ads.snapshot.type="";return}var was_playing=!vjs.paused();vjs.src({src:src});if(was_playing)vjs.ready(vjs.play.bind(vjs))};this.stash=function(){var stash={on_sourceopen:this.on_sourceopen};if(stash.on_sourceopen)this.disable_data_mode();return function(){if(stash.on_sourceopen)this.enable_data_mode(stash.on_sourceopen)}.bind(this)};this.on("missing_ended",function(){var ms;try{ms=_this.vjs.tech_.hls_obj.bufferController.mediaSource}catch(e){}_this.log.notice("Missing ended in vjs, ms "+!!ms+", readyState "+(ms&&ms.readyState)+", duration "+(ms&&ms.duration))})};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){if(this.module_ops)this.module_ops=this.module_ops.uninit();for(var event in this.vjs_handlers){for(var i=0;i<this.vjs_handlers[event].length;i++)this.vjs.off(event,this.vjs_handlers[event][i])}if(this.adcls_unwatch)this.adcls_unwatch();if(this.adstat_hook)this.adstat_hook.remove();if(this.schedule_end_of_stream_check){this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer);this.vjs.off("timeupdate",this.schedule_end_of_stream_check)}delete this.vjs.hola_logs;this.zone_watch.uninit()};E.Player.prototype.get_video_type=function(){return this.vjs.currentType()};E.Player.prototype.get_ad_scheme=function(){if(!this.vjs.ads)return;return this.vjs.ima||this.vjs.ima3?"contrib/googima":"contrib/other"};E.Player.prototype.get_url=function(){var src;if(src=this.module&&this.module.get_url())return src;src=this.vjs.currentSrc();if(!this.config.disable_src_check){var el=vjs_getElement(this.vjs);if(el&&el.networkState==el.NETWORK_NO_SOURCE&&this.vjs.cache_)src=this.vjs.cache_.src}return util.is_blob_url(src)&&this.blob2url[src]||src};E.Player.prototype.get_resolution=function(debug_mode){var element=vjs_getElement(this.vjs);var res=dom_util.get_elm_resolution(element);var debug_res=element&&getComputedStyle(element);if(this.hap_debug_no_height&&res&&res.height){perr({id:"hap_debug_resolution_obtained",throttle:1,info:{player_name:this.name,element:!!element,width:res.width,height:res.height,res:debug_res,call_from:debug_mode}})}if(debug_mode=="hap_resolution"&&(!res||!res.height)){perr({id:"hap_debug_resolution_player",throttle:1,info:{player_name:this.name,element:!!element,width:(res||{}).width,height:(res||{}).height,res:debug_res,initial_msg:!this.hap_debug_no_height}});this.hap_debug_no_height=true}return res};E.Player.prototype.seek=function(ms){this.vjs.currentTime(ms/1e3)};E.Player.prototype.get_pos=function(){return this.position||(this.position=this.vjs.currentTime())};util.module_fn(E,function get_state(){return this.state});E.Player.prototype.refresh_buffered=function(){this.buffered=this.vjs.buffered();this.position=this.vjs.currentTime();return this.buffered};E.Player.prototype.get_buffered=function(){return this.buffered||this.refresh_buffered()};E.Player.prototype.get_duration=function(){if(zutil.is_mocha())return 0;return this.vjs.duration()};util.module_fn(E,function is_live_stream(){return this.get_duration()===Infinity});E.Player.prototype.discontinuity=function(sbuf){this.media_src.swfObj.vjs_discontinuity()};E.Player.prototype.play=function(){this.vjs.play()};E.Player.prototype.pause=function(){this.vjs.pause()};util.module_fn(E,function play_url(url,pos,is_paused,video_type){var _this=this;setTimeout(function(){var srcs=_this.vjs.options_.sources;var src_changed=srcs&&srcs.some(function(src){if(util.absolute_uri(src.src)==url){_this.vjs.src(src);return true}});if(!src_changed)_this.vjs.src({src:url,type:video_type});_this.vjs.one("canplay",function(){if(!is_paused&&_this.vjs.paused())_this.vjs.play();if(!pos)return;if(_this.tech=="flash"){_this.vjs.on("timeupdate",function cb(){if(_this.vjs.currentTime()==0)return;_this.vjs.off("timeupdate",cb);_this.vjs.currentTime(pos)})}else _this.vjs.currentTime(pos)});_this.vjs.load();if(!is_paused&&!pos)_this.vjs.play()},0)});E.Player.prototype.enable_data_mode=function(on_sourceopen){if(!this.media_src_api||!this.media_src_api.MediaSource){this.log.err("MSE not available, tech = "+this.tech+", window.MediaSource is"+(window.MediaSource?"":" not")+" enabled, used MediaSource API provider is "+(this.media_src_api===window?"window":"vjs"));throw new Error("MediaSource API not available")}this.media_src=new this.media_src_api.MediaSource({mode:this.tech=="flash"?"flash":"auto"});this.buffered=undefined;var media_src_url=this.media_src_api.URL.createObjectURL(this.media_src);this.blob2url[media_src_url]=this.get_url();this.change_src(media_src_url);if(!this.config.disable_ended_fallback){var prev,_this=this,vjs=this.vjs;this.schedule_end_of_stream_check=function(){if(prev==vjs.currentTime())return;prev=vjs.currentTime();_this.end_of_stream_timer=clearTimeout(_this.end_of_stream_timer);if(_this.seeking||!util.close_to_end(prev,vjs.duration()))return;_this.end_of_stream_timer=setTimeout(function(){var cur=vjs.currentTime(),dur=vjs.duration();if(!dur||!cur||vjs.ended()||!util.close_to_end(cur,dur)){return}_this.log.notice("schedule_end_of_stream_check fake ended "+"%s %s",cur,dur);perr({id:"hola_vjs_ended_fallback",add_log:true,info:"previous: "+prev+" current: "+cur+" duration: "+dur});vjs.trigger(util.new_event("ended"));vjs.off("timeupdate",_this.schedule_end_of_stream_check)},1e3)};vjs.on("timeupdate",this.schedule_end_of_stream_check)}this.on_sourceopen=function(){return on_sourceopen(this.media_src)}.bind(this);this.media_src.addEventListener("sourceopen",this.on_sourceopen);if(this.media_src.readyState=="open")on_sourceopen(this.media_src)};E.Player.prototype.disable_data_mode=function(){if(!this.media_src)return;this.media_src.removeEventListener("sourceopen",this.on_sourceopen);if(this.schedule_end_of_stream_check){this.vjs.off("timeupdate",this.schedule_end_of_stream_check);this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer);this.schedule_end_of_stream_check=undefined}this.media_src=this.on_sourceopen=undefined};util.module_fn(E,function is_playing(){return this.state=="PLAYING"});util.module_fn(E,function is_paused(){return this.state=="PAUSED"});util.module_fn(E,function is_idle(){return this.state=="IDLE"});E.Player.prototype.is_ad_active=function(){var o=this.get_container();return ad_flag_re.test(o&&o.className)&&this.vjs.ads&&this.vjs.ads.state!="content-playback"};E.Player.prototype.get_media_type=function(){return this.media_type};E.Player.prototype.get_container=function(){return this.vjs.el()};E.Player.prototype.enable_context_menu=function(){if(!this.vjs.enablePopupMenu)return;this.vjs.enablePopupMenu()};E.Player.prototype.disable_context_menu=function(){if(!this.vjs.disablePopupMenu)return;this.vjs.disablePopupMenu()};E.Player.prototype.get_captions_track=function(){for(var i=0;i<this.vjs.textTracks().length;i++){if(this.vjs.textTracks()[i].mode=="showing")return i}return-1};E.Player.prototype.set_captions_track=function(track){for(var i=0;i<this.vjs.textTracks().length;i++)this.vjs.textTracks()[i].mode="disabled";if(track>=0)this.vjs.textTracks()[track].mode="showing"};["get_levels","get_playlists","get_current_playlist","get_segment_info","is_native_hls","get_bitrate","get_current_level","get_bandwidth","init_adaptive","ondata_adaptive","get_current_fragment","set_cdn_mode","is_bitrate_supported"].forEach(function(name){util.module_fn(E,name)});util.module_fn(E,function is_autostart(){return this.vjs.autoplay()});util.module_fn(E,function get_decoded_frames(){var el=vjs_getElement(this.vjs);if(!el)return 0;if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");return html5.get_decoded_frames(el)}return el.vjs_getProperty&&el.vjs_getProperty("decodedFrames")});util.module_fn(E,function get_dropped_frames(){var el=vjs_getElement(this.vjs);if(!el)return 0;if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");return html5.get_dropped_frames(el)}return el.vjs_getProperty&&el.vjs_getProperty("droppedFrames")});E.Player.prototype.get_caps=function(){return player_util.Player.prototype.get_caps({save_context:["progressive"],hap_provider_loaded:true})};E.Player.prototype.get_est_bytes=function(){var res=null;if(this.module)res=this.module.get_est_bytes();if(res)return res;var el=vjs_getElement(this.vjs);if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");res=html5.est_bytes_from_tag(el)}if(!res)res=this._get_media_size_server();return res};E.Player.prototype.get_current_error=function(){return vjs_get_error(this)};E.Player.prototype.check_buffer=function(opt){var el=vjs_getElement(this.vjs);if(is_video_element(el)){util.assert_enabled(html5,"html5 module is required but disabled");html5.check_buffer.call(this,el,opt)}};E.Player.prototype.play_src=function(src,idx){src=src[idx||0];if(src.poster)this.vjs.poster(src.poster);this.vjs.src([{type:src.type,src:src.file||src.url}]);this.vjs.load();this.vjs.play()};E.Player.prototype.muted=function(v){return this.vjs.muted(v)};E.Player.prototype.volume=function(v){return this.vjs.volume(v)};function player_set_initial_state(player){var vjs=player.vjs;player.state="IDLE";player.ready=false;vjs.ready(function(){player.ready=true;player.state=vjs.paused()?"PAUSED":"PLAYING";player.emit("started",player.get_url());player.emit("state",player.state)})}function vjs_getElement(vjs){return vjs.tech_&&vjs.tech_.el_}function is_video_element(el){return el&&el.tagName&&el.tagName.toLowerCase()=="video"}function vjs_getAdClass(vjs){var m,elm=vjs_getElement(vjs);if(!elm.parentNode||!(m=elm.parentNode.className.match(ad_flag_re)))return;return m[0].trim()}function vjs_get_error(player,a){var err_map={1:{message:"download was cancelled",reason:"other"},2:{message:"network error",reason:"media_load"},3:{message:"decode error",reason:"media_decode"},4:{message:"source not supported",reason:"media_support"},5:{message:"encryption error",reason:"media_decode"},unknown:{message:"unknown",reason:"other"},"-1":{message:"no video was loaded",reason:"other"},"-2":{message:"timeout",reason:"media_load"}};var code,msg;if(player.vjs.error){var error=player.vjs.error();if(!error)return;code=error.code;msg=error.message}code=code||a.target&&a.target.error&&a.target.error.code||a.code;var info=err_map[code]||err_map.unknown;msg=msg||a.message||info.message;return{code:code,reason:info.reason,message:msg}}function Osmf(opt){util.call_super(E,this,null,opt);var _this=this;this.vjs=opt.vjs;this.swf=opt.swf;this.player_id=opt.player_id||1;this.flash_api=player_util.build_flash_api(this);if(this.swf.hola_settings)this.swf.hola_settings({player_id:this.player_id});var tech=this.vjs.tech_;tech.on("manifestloaded",this.on_manifestloaded=function(event,data){if(_this.is_live_stream())_this.emit("live_manifest",{url:data.url,format:"hds"})})}zutil.inherits(Osmf,util.events);Osmf.prototype.is_live_stream=function(){return this.vjs.osmf.streamType()=="live"};Osmf.prototype.get_levels=function(){var levels=this.vjs.osmf.levels();var ret={};if(!levels||!levels.length)return ret;for(var i=0;i<levels.length;i++){var p=levels[i],url=p.url;if(ret[url]||!p.fragments)continue;var _p={url:url,segments:[]};ret[url]=_p;var bitrate=_p.bitrate=p.bitrate;for(var j=0;j<p.fragments.length;j++){var frag=p.fragments[j];_p.segments.push({playlist_url:url,media_index:frag.frag_no||j,url:frag.url,bitrate:bitrate,duration:frag.duration})}}return ret};Osmf.prototype.init_adaptive=function(adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.init_adaptive(this,adaptive)};Osmf.prototype.ondata_adaptive=function(chunk,adaptive){util.assert_enabled(jsurlstream,"jsurlstream module is required but disabled");jsurlstream.ondata_adaptive(chunk,this,adaptive)};Osmf.prototype.get_playlists=function(){};Osmf.prototype.get_url=function(){};Osmf.prototype.get_current_level=function(){return this.vjs.osmf.currentLevel()};Osmf.prototype.set_cdn_mode=function(on){this.swf.hola_settings({hls_mode:!!on,mode:on?"adaptive":"native"})};Osmf.prototype.get_est_bytes=function(){return null};Osmf.prototype.uninit=function(){this.vjs.tech_.off("manifestloaded",this.on_manifestloaded)};return E});
define("/svc/cdn/pub/buffer_monitor.js",["/svc/cdn/pub/util.js"],function(util){var E={};var defaults={buffer_threshold:20,poll_period:500};E.PlayerExtension=function(player,opt){if(!(this instanceof E.PlayerExtension))return new E.PlayerExtension(player,opt);opt=Object.assign(defaults,opt);this.player=player;this.enabled=0;this.buffer_poll=this.try_wrapper(function(){var duration;if(!(duration=this.player.get_duration()))return;var last_state=this.state;var buf=this.player.get_current_buffer();if(duration-buf.to>0){var buffer_len=buf.to-this.player.get_pos();this.state=buffer_len>=opt.buffer_threshold?"buffer_full":buffer_len<=opt.buffer_threshold-5?"buffer_low":last_state=="buffer_full"?"buffer_full":"buffer_low"}else this.state="buffer_loaded";if(this.state!=last_state)this.player.emit("buffer_monitor",this.state)});this.on_player_state=this.try_wrapper(function(){this.run(!this.player.is_idle())});this.on_zone_init=this.try_wrapper(function(){var conf;if(!(conf=this.player.zone.CGJ("player.extension.buffer_monitor")))conf=defaults;if(this.running&&conf.poll_period!=opt.poll_period){clearInterval(this.buffer_poll_interval);this.buffer_poll_interval=setInterval(this.buffer_poll,conf.poll_period)}Object.assign(opt,conf)});this.run=function(run){if(!(run^this.running))return;this.state=undefined;this.running=run;if(run){this.buffer_poll_interval=setInterval(this.buffer_poll,opt.poll_period);this.buffer_poll()}else{this.buffer_poll_interval=clearInterval(this.buffer_poll_interval)}}};E.PlayerExtension.prototype.enable=function(){if(this.enabled++)return;this.player.on("state",this.on_player_state);this.player.on("wrapper.zone_init",this.on_zone_init);this.on_zone_init();if(!this.player.is_idle())this.run(true)};E.PlayerExtension.prototype.disable=function(force_close){if(!force_close&&(!this.enabled||--this.enabled))return;this.run(false);this.player.off("wrapper.zone_init",this.on_zone_init);this.player.off("state",this.on_player_state)};E.PlayerExtension.prototype.try_wrapper=function(func){return util.try_wrapper({prefix:"buffer_monitor"},func.bind(this))};E.PlayerExtension.prototype.uninit=function(){this.disable(true)};return E});
define("/svc/cdn/pub/jwplayer_hls_provider.js",{__stub:1});
define("/svc/cdn/pub/flv.js",{__stub:1});
define("/svc/cdn/pub/mp4.js",["/svc/cdn/pub/util.js","/util/util.js","/util/user_agent.js","/util/events.js","/svc/cdn/pub/log.js","/svc/cdn/pub/flv.js","mp4box","muxjs"],function(util,zutil,ua,events,_log,flv,mp4box,muxjs){var E={};var assign=Object.assign;function log_from_zone(zone){return zone.log_get().set_module("mp4")}E.Appender=function(opt){var _this=this;this.bws=opt.bws;this.parser=opt.parser;this.log=log_from_zone(opt.bws.zone);this.CG=this.bws.zone.CG.bind(this.bws.zone);if((this.cache=this.CG("cdn.media.memory_cache_sec")>>0)&&!this.bws.memcache&&!opt.parser.use_mp4box){this.bws.memcache={data:[]}}this._on_serving_denied=function(){_this.serve_suspended=true};this._on_serving_allowed=function(){if(!_this.serve_suspended)return;_this.serve_suspended=false;if(_this.CG("cdn.media.serve_if_fast")){for(var map in _this.src_bufs_map)_this.serve(_this.src_bufs_map[map].sbuf,"serving_allowed")}};this.bws.on("serving_denied",this._on_serving_denied);this.bws.on("serving_allowed",this._on_serving_allowed)};zutil.inherits(E.Appender,events.EventEmitter);E.Appender.prototype.init=function(mp4_info,mp4_init_segs){var _this=this;this.avsync=[];this.save_dump=_log.settings.save_dump;this.src_bufs=[];this.threshold=this.CG("cdn.mse.threshold")>>0;this.append_err_max=this.CG("cdn.mse.append_err_max",10)>>0;this.src_bufs_map={};var tracks=mp4_info.tracks;tracks.forEach(function(track){_this.on_src_track(track.id,track.codec,track.nb_samples)});this._on_remove_sb=function(){_this.log.info("remove sb from MediaSource")};this.bws.player.media_src.sourceBuffers.addEventListener("removesourcebuffer",this._on_remove_sb);mp4_init_segs.forEach(function(segment){_this.append_samples(segment.id,segment.buffer,false,{init:true})});this.emit("onmetaready")};E.Appender.prototype.on_src_track=function(track_id,track_codec,track_nb_samples){var ms_api=this.bws.player.media_src_api&&this.bws.player.media_src_api.MediaSource;var _this=this,zperr=this.bws.zone.perr_get();var media_type=track_codec.startsWith("mp4a")?"audio":"video";var mime=media_type+'/mp4; codecs="'+track_codec+'"',sbuf;var filter=this.CG("cdn_opts.mse.filter");if(track_codec=="mp4v"||track_codec=="hvc1"||ms_api&&ms_api.isTypeSupported&&!ms_api.isTypeSupported(mime)||filter&&!new RegExp(filter,"i").test(track_codec)){var r="unsupported "+track_codec+" codec";zperr({id:"mse_codec_unsupported",info:{codec:track_codec}});throw util.err_ex(r,{info:{video_source_error:r},reason:"mp4_mediasource_codec"})}var media_src=this.bws.player.media_src;this.log.info("add sbuf for mime:"+mime+" state:"+media_src.readyState);sbuf=media_src.addSourceBuffer(mime);sbuf.media_src=media_src;this.src_bufs.push(sbuf);this.src_bufs_map[track_id]={id:track_id,sbuf:sbuf,codec:track_codec,type:media_type,n_samples:track_nb_samples};sbuf.chunkq=[];sbuf.track_id=track_id;sbuf.track_codec=track_codec;sbuf.append_err=0;sbuf.addEventListener("updatestart",function(){_this.log.debug("["+track_id+", "+track_codec+"] updatestart")});var on_updateend=this.bws.fallback_wrapper(function(){_this.log.debug("["+track_id+", "+track_codec+"] updateend, "+"queue size = "+sbuf.chunkq.length);if(sbuf.sn==track_nb_samples-1&&!sbuf.chunkq.length)return void _this.check_ended(sbuf);_this.serve(sbuf,"updateend");_this.bws.track_state("updateend");if(_this.parser.cb_opt)_this.bws.player.check_buffer(_this.parser.cb_opt)},"html5");sbuf.addEventListener("updateend",on_updateend);sbuf.addEventListener("error",function(err){_this.bws.fallback("sourceBuffer error, codec = "+err.target.track_codec,"mp4")});sbuf.addEventListener("abort",function(){_this.log.debug("abort")});this.serve(sbuf,"on_src_track")};E.Appender.prototype.append_samples=function(track_id,buf,wait,opt){opt=opt||{};var cache=this.cache&&this.bws.memcache&&this.bws.memcache.data;if(cache&&(opt.init||opt.time<=this.cache))cache.push({id:track_id,buffer:buf,init:opt.init});var track_rec=this.src_bufs_map[track_id];if(!track_rec)return;var sbuf=track_rec.sbuf;this.log.debug("["+track_id+", "+sbuf.track_codec+"] append_segment, "+"size = "+buf.byteLength);if(this.save_dump=="network")this.bws.dump_chunk(track_id,buf,buf.byteLength);sbuf.chunkq.push(buf);if(opt.time){this["last_"+this.src_bufs_map[track_id].type]=opt.time;if(this.last_video&&this.last_audio)this.avsync.push(Math.abs(this.last_video-this.last_audio))}if(!wait)this.serve(sbuf,"append_samples")};E.Appender.prototype.clear_buffers=function(){this.log.debug("clear_buffers");if(this.src_bufs)this.src_bufs.forEach(function(sbuf){sbuf.chunkq=[]})};E.Appender.prototype.calc_chunkq_bytes=function(){if(!this.src_bufs)return 0;var bytes=0;this.src_bufs.forEach(function(sbuf){sbuf.chunkq.forEach(function(chunk){bytes+=chunk.byteLength})});return bytes};E.Appender.prototype.check_ended=function(sbuf){var media_src=sbuf.media_src,seq=media_src.seq,sbufs=this.src_bufs;sbuf.ended=seq;this.log.info("ended sbuf "+sbuf.track_codec);if(sbufs.every(function(sb){return sb.ended==seq&&!sb.updating}))media_src.ended=seq};E.Appender.prototype.serve=function(sbuf,caller){if(sbuf.updating||sbuf.media_src.readyState=="closed"||this.serve_suspended&&this.CG("cdn.media.serve_if_fast")||sbuf.media_src.sourceBuffers&&!sbuf.media_src.sourceBuffers.length){return}for(;;){var chunks=[],total_len=0,i;for(i=0;i<sbuf.chunkq.length&&total_len<=this.threshold;i++){chunks.push(sbuf.chunkq[i]);total_len+=sbuf.chunkq[i].byteLength}if(!chunks.length)return;var block=new Uint8Array(total_len),ptr=0;for(var j=0;j<i;ptr+=chunks[j].byteLength,j++)block.set(new Uint8Array(chunks[j]),ptr);this.log.debug("["+sbuf.track_id+", "+sbuf.track_codec+"] sbuf_append "+block.length+" at "+this.bws.stream_completed()+" called by "+caller);try{sbuf.appendBuffer(block);delete sbuf.ended;delete sbuf.media_src.ended}catch(e){if(e.name!="QuotaExceededError")throw e;this.threshold=Math.floor(this.threshold/2);if(this.threshold)continue;if(++sbuf.append_err>this.append_err_max){throw new Error("sourceBuffer QuotaExceededError after "+this.append_err_max+" retries")}this.threshold=this.CG("cdn.mse.threshold")>>0;return setTimeout(this.serve.bind(this,sbuf,caller),200)}sbuf.sn=chunks[i-1].sn;sbuf.chunkq.splice(0,i);sbuf.append_err=0;if(this.save_dump=="player")this.bws.dump_chunk(sbuf.track_id,block.buffer,block.length);chunks=null;break}};E.Appender.prototype.get_avsync=function(){var res=this.avsync;this.avsync=[];return res};E.Appender.prototype.media_info=function(){var msrc,src_bufs=this.src_bufs||[],_this=this;function dump(buffered){var str="";if(!buffered)return;for(var i=0,len=buffered.length;i<len;i++)str+="["+buffered.start(i)+","+buffered.end(i)+"]";return str}if(!src_bufs.length||!(msrc=src_bufs[0].media_src))return;this.log.info("media_src ct:"+msrc.currentTime+" rs:"+msrc.readyState+" buffered:"+dump(msrc.buffered));src_bufs.forEach(function(sbuf){_this.log.info("sbuf t_id:"+sbuf.track_id+" codec:"+sbuf.track_codec+" q:"+sbuf.chunkq.length+" u:"+sbuf.updating+" buffered:"+dump(sbuf.buffered))})};E.Appender.prototype.uninit=function(){if(this.CG("cdn.media.log_media_info"))this.media_info();if(this.bws.player.media_src){this.bws.player.media_src.sourceBuffers.removeEventListener("removesourcebuffer",this._on_remove_sb)}this.bws.off("serving_denied",this._on_serving_denied);this.bws.off("serving_allowed",this._on_serving_allowed);if(!this.src_bufs)return;this.src_bufs.forEach(function(sbuf){try{sbuf.media_src.removeSourceBuffer(sbuf)}catch(e){}})};E.Appender.prototype.seek=function(){this.last_video=this.last_audio=undefined};E.Parser=function(tech,fallback_wrapper,bws){if(!(this instanceof E.Parser))return new E.Parser(tech,fallback_wrapper,bws);if(tech=="flash")util.assert_enabled(flv,"flv module is required but disabled");this.type="mp4";this.tech=tech;this.log=log_from_zone(bws.zone);this.s_i=[];this.bws=bws;this.last_pos=0;this.fallback_wrapper=fallback_wrapper.bind(this);this.use_mp4box=bws.CG("cdn.media.mp4box")&&(!util.is_safari||this.tech!="html5");this.mp4_eseek=(util.is_firefox||util.is_android||bws.CG("cdn.media.mp4_exact_seek"))&&this.tech=="html5"&&!this.use_mp4box;this.mp4_fast_start=bws.CG("cdn.media.mp4_fast_start",!this.mp4_eseek);this.mp4_disable_edts=bws.CG("cdn.media.mp4_disable_edts");this.mp4_mark_non_sync=!bws.CG("cdn.media.disable_mark_non_sync")&&(util.is_safari||(util.is_chrome||util.is_opera&&util.browser.browser=="chrome")&&util.browser.version>=50);this.force_he_aac_on_low_freq=!bws.CG("cdn.media.disable_force_he_aac")&&util.is_chrome&&util.browser.version<50;if(!bws.CG("player.html5.disable_check_buffer")){this.cb_opt={bws:bws,state:{},conf:assign({},bws.CG("player.html5.check_buffer_conf"),{bsec:2,buf_wd:3,max_nudge_retry:5,offset:.1})}}this.media_appender=this.tech=="flash"?new flv.Appender({bws:bws,samples_per_segment:10,parser:this}):new E.Appender({bws:bws,parser:this});this._on_seek=this.fallback_wrapper(this.seek);this._on_clear_buffers=this.fallback_wrapper(function(pending){if(pending===undefined)this.media_appender.clear_buffers()});if(!this.use_mp4box&&!this.bws.CG("cdn.parser.disable_skip_seeks"))this.seek_complete=this._seek_complete.bind(this);this._on_play=this.fallback_wrapper(function(){var opt;if(opt=this.cb_opt)setTimeout(function(){bws.player.check_buffer(opt)})});this.on("seek",this._on_seek);this.on("clear_buffers",this._on_clear_buffers);this.on("on_play",this._on_play)};zutil.inherits(E.Parser,events.EventEmitter);E.Parser.prototype.init=function(){this.fallback_wrapper(this._init)()};E.Parser.prototype.uninit=function(){if(!this.use_mp4box)this.muxjs_uninit();this.media_appender.uninit();this.off("seek",this._on_seek);this.off("clear_buffers",this._on_clear_buffers);this.off("on_play",this._on_play);if(this._seek_timer!==undefined)this._seek_timer=clearTimeout(this._seek_timer);if(this.flipped)this._flip(false)};E.Parser.prototype.flush=function(){this._parser.flush()};E.Parser.prototype.append_buffer=function(data,fullsize,req){function probe_zero(chunk){var v=new DataView(chunk,0,chunk.byteLength);for(var i=0;i<chunk.byteLength;i++){if(v.getUint8(i))return false}return true}if(this.bws.CG("util.log.chunk_hash")){var checksum=util.fnv1a(data);this.log.info("chunk from "+this.last_pos+" sz "+data.byteLength+" cs "+checksum+" "+req.id)}if(probe_zero(data)){this.log.info("invalid zero chunk detected "+req.id);this.bws.stats.zero_chunks=(this.bws.stats.zero_chunks||0)+1}return this.last_pos=this._parser.appendBuffer(data)};E.Parser.prototype._init=function(){if(!this.use_mp4box)return this.muxjs_init();this.mp4box_init()};E.Parser.prototype._seek_complete=function(s,info){var offset=this.time2ofs(info.seek_pos);if(s.completed==this._parser.get_buf_pos()&&offset>=s.from&&offset<=s.completed&&(this.bws.player.is_buffered(info.pos)||info.seek_pos==0&&this.bws.sec_in_buffer(info.seek_pos))){info.offset=s.completed}else assign(info,this._parser.seek(info.seek_pos,true))};E.Parser.prototype.seek=function(pos,pending){var _this=this,seek_info;var workaround=this._seek_sec!==undefined&&this._seek_timer===undefined;if(this._seek_timer!==undefined)clearTimeout(this._seek_timer);var seek_pos=workaround?this._seek_sec:pos;var eseek=this.tech!="html5"||this.mp4_eseek||this.mp4_mark_non_sync;if(eseek)seek_pos+=this.bws.sec_in_buffer(pos,true);this.log.info("seeking"+(workaround?" (workaround) ":" ")+pos);seek_info=eseek&&this.seek_complete?{seek_pos:seek_pos,pos:pos,cb:this.seek_complete}:this._parser.seek(seek_pos,!workaround);if(workaround||eseek){this._seek_sec=undefined;this.media_appender.seek();return this.emit("seek_complete",seek_info)}var _seek_sec;if(this.use_mp4box&&!util.is_safari){for(var i=0;i<4&&seek_info.time>.01;i++)seek_info=this._parser.seek(seek_info.time-.01,false);_seek_sec=seek_info.time}else _seek_sec=seek_info.time+this.s_delay;this.emit("abort");this._seek_timer=setTimeout(function(){_this._seek_timer=undefined;_this._seek_sec=_seek_sec;_this.emit("seek_player_set",_seek_sec*1e3)},20)};E.Parser.prototype.ofs2time=function(offset){var t_i=this.t_info&&this.t_info[this.v_id];if(!t_i)return(offset-this.start_hdr_sz)*8/this.meta_bitrate;var l=0,r=t_i.offset.length;while(l<r-1){var m=l+r>>1;if(t_i.offset[m]<offset)l=m;else r=m}return t_i.time[l]};E.Parser.prototype.time2ofs=function(time){var t_i=this.t_info&&this.t_info[this.v_id];if(!t_i)return this.start_hdr_sz+time*this.meta_bitrate/8;var l=0,r=t_i.time.length;while(l<r-1){var m=l+r>>1;if(t_i.time[m]<time)l=m;else r=m}return t_i.offset[l]};E.Parser.prototype.get_spec_info=function(track_id){return this.s_i[track_id]};E.Parser.prototype.muxjs_uninit=function(){if(!this._parser)return;this._parser.off("data",this._muxjs_ondata);this._parser.off("header_found",this._muxjs_header_found);this._parser.off("metadata",this._muxjs_onmetadata);delete this._parser};E.Parser.prototype._flip=function(on){var video=this.bws.player.get_container()||{};if(!video.style)return;if(on)this.saved_transform=video.style.transform;video.style.transform=on?"rotate(180deg)":this.saved_transform};E.Parser.prototype._validate_dur=function(info){if(info.type!="vide")return;var i,dur,st=info.s_time;for(i=2,dur=st[1]-st[0];i<st.length;i++){if(dur!=st[i]-st[i-1]){if(this.bws.CG("cdn.media.disable_dur_validation"))return void(this.bws.player.adjust_pos=true);var r="different frame duration unsupported";throw util.err_ex(r,{info:{video_source_error:r},reason:"muxjs_safari_frame"})}}};E.Parser.prototype._process_metainfo=function(info){var bitrate=0,_this=this,nim_type="mvhd",non_identity_matrix;var identity_matrix=[65536,0,0,0,65536,0,0,0,1073741824];var empty_edits=[];info.s_info.forEach(function(t){if(util.is_safari)_this._validate_dur(t);if(t.elst&&t.elst.length>1&&t.elst[0].media_time<0)empty_edits.push({type:t.type,dur:t.elst[0].segment_duration})});if(empty_edits.length){this.bws.zone.perr_get()({id:"empty_edit_list_entry",info:{edits:empty_edits},add_log:true})}var vinfo=info.s_info.find(function(e){return e.type=="vide"});var ainfo=info.s_info.find(function(e){return e.type=="soun"});if(info.timescale)this.meta_duration=info.duration/info.timescale;if(this.meta_duration>this.bws.low_watermark_sec&&ainfo&&vinfo&&vinfo.s_off[vinfo.s_off.length-1]<ainfo.s_off[0]){var r="audio samples located at the end of media file";throw util.err_ex(r,{info:{video_source_error:r},reason:"muxjs_audio_offset"})}if(!util.array_equal(info.matrix,identity_matrix))non_identity_matrix=zutil.clone(info.matrix);info.videoTracks=info.tracks.filter(function(e){return e.type=="video"});info.audioTracks=info.tracks.filter(function(e){return e.type=="audio"});info.tracks.forEach(function(track){track.id=""+track.id;if(track.type=="video"){if(!util.array_equal(track.matrix,identity_matrix)){non_identity_matrix=zutil.clone(track.matrix);nim_type="tkhd"}_this.s_delay=track.edit_list&&track.edit_list.length?-Math.ceil(track.edit_list[0].media_time/900+8)/100:-.08}_this.s_i[track.id]=track.s_i;bitrate+=track.bitrate|0});if(info.tracks.length){this.v_id=info.videoTracks[0].id;this.t_info={};info.tracks.forEach(function(e){_this.t_info[e.id]=_this._parser.get_tl(e.id)})}if(non_identity_matrix){if(non_identity_matrix[1]!=0||non_identity_matrix[3]!=0||this.tech!="html5"){this.bws.zone.perr_get()({id:"non_identity_matrix_error",info:{matrix:non_identity_matrix,type:nim_type},add_log:true});throw new Error("non-identity video matrix unsupported")}if(non_identity_matrix[0]==4294901760&&non_identity_matrix[4]==4294901760){this._flip(true);this.flipped=true}}this.meta_bitrate=bitrate;this.start_hdr_sz=info.start_hdr_sz|0;this.end_hdr_sz=info.end_hdr_sz|0};E.Parser.prototype.muxjs_init=function(){util.assert_enabled(muxjs,"muxjs is required but disabled");this.log.notice("mux.js transmuxer is activated");var _this=this;var cache=this.bws.memcache;var cache_init=cache&&cache.data&&cache.data.filter(function(e){return e.init});var cache_data=cache&&cache.data&&cache.data.filter(function(e){return!e.init});var parser_opt={input_type:"mp4",no_multi_init:true,no_combine:true,disable_val_frame_nal_len4:this.bws.CG("cdn.media.disable_val_frame_nal_len4"),break_on_count:this.mp4_fast_start,mark_non_sync:this.mp4_mark_non_sync,disable_edts:this.mp4_disable_edts,force_he_aac_on_low_freq:this.force_he_aac_on_low_freq,metadata:cache_init&&cache_init.length&&cache_init.length==cache.meta.tracks.length&&cache.meta};this._muxjs_ondata=this.fallback_wrapper(function(packet){if(packet.init){_this.log.info("init segments from "+(parser_opt.metadata?"cache":"video"));return void _this.media_appender.init(_this.m_i,packet.inits,_this.m_i.tracks)}_this.emit("append_samples",packet.id,packet.data);_this.media_appender.append_samples(packet.id,packet.data,false,{time:_this.t_info[packet.id].time[packet.data.sn]});packet.data=null},"muxjs");this._muxjs_header_found=this.fallback_wrapper(function(info){if(info.type!="moov")return;_this.bws.stats.hdr_loc=info.pos<256?"start":"end";_this.emit("hdr_found",info.pos)},"muxjs");this._muxjs_onmetadata=this.fallback_wrapper(function(info){var is_memcache=_this.bws.memcache&&_this.bws.memcache.meta;_this.log.info("got metadata from "+(is_memcache?"cache":"video"));if(_this.bws.memcache&&!is_memcache)_this.bws.memcache.meta=zutil.clone_deep(info);_this.m_i=info;_this._process_metainfo(info);_this.emit("meta_info",{start_hdr_sz:_this.start_hdr_sz,end_hdr_sz:_this.end_hdr_sz,bitrate:_this.meta_bitrate,dur:_this.meta_duration})},"muxjs");this._stream_start_set=this.fallback_wrapper(function(stream){_this._muxjs_onmetadata(cache.meta);_this._muxjs_ondata({init:true,inits:cache_init});var last_index={};cache_data.forEach(function(el,index){last_index[el.id]=index});cache_data.forEach(function(el,index){var wait=index!=last_index[el.id];_this.media_appender.append_samples(el.id,el.buffer,wait,{time:_this.t_info[el.id].time[el.buffer.sn]})});cache.data=cache.meta=_this.media_appender.cache=0;_this.bws.off("stream_start_set",_this._stream_start_set)},"muxjs");if(parser_opt.metadata){cache_data.forEach(function(el){var tr_ind=0,sinf=parser_opt.metadata.s_info;while(sinf[tr_ind++].id!=el.id&&tr_ind<sinf.length);parser_opt.metadata.s_p[tr_ind-1].s=el.buffer.sn+1})}this._parser=new muxjs.mp4.Transmuxer(parser_opt);this._parser.setupTsPipeline();this._parser.on("data",this._muxjs_ondata);this._parser.on("header_found",this._muxjs_header_found);this._parser.on("metadata",this._muxjs_onmetadata);if(parser_opt.metadata)this.bws.on("stream_start_set",this._stream_start_set);this.emit("open")};E.Parser.prototype.mp4box_init=function(){util.assert_enabled(mp4box,"mp4box is required but disabled");var _this=this;this.log.notice("mp4box is activated");this._parser=this.mp4box=new mp4box;this.mp4box.onError=function(e){_this.log.warn("mp4box err"+e)};this.mp4box.onSegment=this.fallback_wrapper(function(id,buf,chunk,sample_num){_this.emit("append_samples",id,chunk,sample_num);chunk.sn=sample_num-1;_this.media_appender.append_samples(id,chunk,false,{time:_this.t_info[id].time[sample_num]});_this.mp4box.releaseUsedSamples(id,sample_num)},"mp4");this.mp4box.onReady=this.fallback_wrapper(function(info){var bitrate=0;info.tracks=[].concat(info.audioTracks||[],info.videoTracks||[]);if(info.tracks.length){_this.v_id=info.videoTracks[0].id;_this.t_info={};info.tracks.forEach(function(tr){var samp_i=_this._parser.getTrackSamplesInfo(tr.id);_this.t_info[tr.id]={offset:samp_i.map(function(el){return el.offset}),time:samp_i.map(function(el){return el.dts/el.timescale})}})}var identity_matrix=[65536,0,0,0,65536,0,0,0,1073741824];info.tracks.forEach(function(track){if(track.video&&!util.array_equal(track.matrix,identity_matrix)){throw new Error("non-identity video matrix unsupported")}bitrate+=track.bitrate;_this.mp4box.setSegmentOptions(track.id,null,{nbSamples:10,ownMvhdSeq:1,removeCtts:1})});var hdr=_this.mp4box.inputIsoFile.boxHeaders,i;for(i=0;i<hdr.length&&hdr[i].type!="mdat";i++);if(i<hdr.length)_this.start_hdr_sz=hdr[i].start;_this.meta_bitrate=bitrate;if(info.timescale)_this.meta_duration=info.duration/info.timescale;_this.m_i=info;_this.emit("meta_info",{start_hdr_sz:_this.start_hdr_sz,bitrate:_this.meta_bitrate,dur:_this.meta_duration});var segments=_this.mp4box.initializeSegmentation();segments.forEach(function(segment){var tr_id=segment.id;for(var i=0;i<_this.mp4box.fragmentedTracks.length;i++){var track;if((track=_this.mp4box.fragmentedTracks[i]).id==tr_id){var stsd=track.trak.mdia.minf.stbl.stsd;var is_vid=track.trak.mdia.hdlr.handler=="vide";var c_box=stsd.entries[0][is_vid?"avcC":"esds"];if(is_vid){_this.s_i[tr_id]=new Uint8Array(segment.buffer,c_box.sizePosition+c_box.hdr_size,c_box.size-c_box.hdr_size)}else{_this.s_i[tr_id]=c_box.esd.descs[0].descs[0].data}}}});_this.media_appender.init(info,segments,_this.mp4box.fragmentedTracks)},"mp4");this.mp4box.onSamples=function(id,user,samples){_this.log.debug("received samples len="+samples.length)};if(typeof this.mp4box.start=="function")this.mp4box.start();this.emit("open")};return E});
define("/svc/cdn/pub/webm.js",{__stub:1});
define("/svc/cdn/pub/wrapper.js",["cash","/util/es6_shim.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/flashls.js","/svc/cdn/pub/zjwplayer3.js","/util/url.js","/svc/cdn/pub/vjs.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/osmf.js","/svc/cdn/pub/android.js","/svc/cdn/pub/dailymotion.js","/util/rand.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/youtube.js","/svc/cdn/pub/zone.js","/util/events.js","/svc/cdn/pub/shaka.js","/util/zerr.js","filesaver","/svc/cdn/pub/flowplayer.js","/svc/cdn/pub/mode.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/hola_adaptive.js","/svc/cdn/pub/ios.js","/svc/cdn/pub/hola_vjs.js","/svc/cdn/pub/buffer_monitor.js","/svc/cdn/pub/jwplayer_hls_provider.js","/svc/cdn/pub/flv.js","/svc/cdn/pub/mp4.js","/svc/cdn/pub/webm.js","/util/date.js"],function($,shim,zutil,util,flashls,zjwplayer,zurl,vjs,html5,osmf,android,dailymotion,rand,dash,youtube,_zone,events,shaka,zerr,filesaver,flowplayer,mode,load_perf,hola_adaptive,ios,hola_vjs,buffer_monitor,jwplayer_hls_provider,flv,mp4,webm,date){var assign=Object.assign,perr=util.cdn_perr;var try_wrapper_n=0,try_wrapper_err;function try_wrapper(opt,func,ctx){opt=opt||{};if(typeof opt=="function"){ctx=func;func=opt;opt={}}var perr_id=opt.report?"bwsaver_report_sent_err":"wrapper_typeerror";var _this=ctx||this;var wrapped_func=function(){try{try_wrapper_n++;return func.apply(this,arguments)}catch(e){var zperr=this.zone.perr_get();try{var need_perr=!try_wrapper_err&&!e.try_wrapper;try_wrapper_err=true;if(need_perr){zperr({id:perr_id,err:""+e.message,bt:e.stack,use_beacon:true,add_log:this.zone.CG("util.log.report.wrapper_typeerror")});this.log.err("detach, wrapper typeerror "+(e.stack||e));if(this.attached)this.detach({err:"typeerror",restore:true});e.try_wrapper=true}}catch(e2){console.error("try_wrapper first err",e);console.error("try_wrapper second err",e2);zperr({id:"wrapper_try_"+perr_id,err:""+e2.message,bt:e2.stack})}if(opt.can_throw)throw e}finally{try_wrapper_n--;if(!try_wrapper_n)try_wrapper_err=false}};return opt.method?wrapped_func:wrapped_func.bind(_this)}function define_ext(name,obj){if(!obj||require.specified(name))return;this.log.notice("reusing external library "+name);define(name,function(){return obj})}zutil.inherits(Wrapper,events.EventEmitter);Wrapper.prototype.new_context=function(){var _this=this;this.cdn=new this.loader.cdn_svc;this.cdn.skip_reasons=[];this.emit("context_created",this.cdn)};Wrapper.prototype.remove_context=function(cdn){if(cdn&&this.cdn!=cdn)return;this.last_cdn=this.cdn;this.cdn=undefined};Wrapper.prototype.send_report=try_wrapper({report:true,method:true},function(opt){opt=opt||{};var zperr=this.zone.perr_get(),cdn=opt.cdn||this.cdn,info;if(!cdn||!cdn.is_attached()||cdn.is_reported)return;var bws=cdn.attached_bws;this.loader.emit("wrapper_send_report",cdn);if(bws)bws.emit("wrapper_send_report");if(zutil.is_mocha())return;cdn.send_stats_debug();var stats=cdn.attached_stats.get_stats_all();var player=(bws||cdn.attached_stats).player;var zone=(bws||cdn.attached_stats).zone;this.log.notice("sending stats attached_bws "+!!bws);this.last_stats=bws?{stats:stats,stats_debug:bws.stats_debug_sent}:{stats:stats};info={only_stats:!bws||this.in_fallback,err:opt.err};if(player.is_ad_source()&&this.stash.length){info.context_mode=this.stash[0].mode;info.context_attached=!!this.stash[0].cdn.attached_stats}if(player&&player.flash_api&&player.flash_api.avail_version())info.swf_version=player.flash_api.version();if(player&&player.name=="hola"&&window.videojs)info.hola_player_version=window.videojs.VERSION;if(this.CG("wrapper.use_final_video_url")&&player){info.final_video_url=player.module&&player.module.final_video_url||player.final_video_url}["flowplayer","jwplayer","videojs"].forEach(function(p){if(window["hola_"+p+"_hls"]&&!info.hap_hls_version)info.hap_hls_version=window["hola_"+p+"_hls"].version});if(bws&&bws.method)info.bws_method=bws.method.type;info.media_size=player.get_media_size();var extra=zutil.clone_deep(stats);delete extra.player.stat;zperr({id:"bwsaver_report",info:info,extra:extra,use_beacon:true,delay:false});if(bws||zone.CG("util.log.report.enable_stats")){util.log_report({id:"log",cdn:cdn,stats:stats,add_unittest:zone.CG("util.log.report.end.unittest"),add_log:zone.CG("util.log.report.end.add_log"),load_perf:this.CG("util.log.report.load_perf")&&load_perf.enabled()&&load_perf.timeline_to_str(zone)})}cdn.is_reported=true});Wrapper.prototype.reset_report=function(opt){var cdn=opt&&opt.cdn||this.cdn;if(!cdn||!cdn.is_attached()||!cdn.is_reported)return;this.log.notice("resetting stats attached_bws "+!!cdn.attached_bws);cdn.attached_stats.reset();cdn.is_reported=false};Wrapper.prototype.uninit_prev=function(opt){opt=opt||{};opt.cdn=opt.cdn||this.cdn;if(!opt.cdn)return;if(opt.cdn.is_attached()){this.send_report(opt);this.player.emit("wrapper.detach_from_player")}opt.cdn.shutdown();opt.cdn.is_reported=undefined;this.remove_context(opt.cdn)};Wrapper.prototype.verify_attached=function(is_attached){if(!!this.attached!=!!is_attached)return false;var zperr=this.zone.perr_get();var s=is_attached?"already":"not";this.log.err("wrapper.js "+s+" attached to player");zperr({id:"wrapper_"+s+"_attached"});return-1};Wrapper.prototype.is_static_proxy=function(){return this.CG("cdn.static_video_proxy")};Wrapper.prototype.get_proxy_url=function(){var player_url=this.player.get_url();return util.is_proxy_url(this.video_url)?this.video_url:util.is_proxy_url(player_url)&&player_url};Wrapper.prototype.check_skip_video=function(opt){var skip_reasons=this.cdn.skip_reasons;var mode=this.CG("mode");function is_below(f,m){return isFinite(m)?f<m:!!m}function is_late_attach(){return!player.is_late_attach||player.is_late_attach()}var player=this.player;opt=opt||{};if(util.get_hola_uri("hola_skip"))skip_reasons.push("skip enforced from page uri");var filter_out_js=this.CG("cdn.filter_out.js");if(filter_out_js){var u=util.get_url_frame();var filter_opt={url:u.frame_url||u.top_url,video_url:this.video_url};try{var filter_fn=new Function("opt",filter_out_js);if(filter_fn(filter_opt))skip_reasons.push("filtered out")}catch(e){this.log.err(e.stack||""+e)}}if(util.is_blob_url(this.video_url)&&(mode=="cdn"||!this.CG("player.allow_blob_attach"))){this.log.err("media source url found instead of real video url: "+"probably html5 module not detected");skip_reasons.push("video url not detected")}var allowed=this.CG("wrapper.methods");if(allowed&&allowed[mode]&&!allowed[mode].includes(this.method)){skip_reasons.push("method "+this.method+" is not allowed")}if(!util.video_format_is_enabled(this.zone,this.video_url))skip_reasons.push("video format unsupported");if(/BingPreview\/\d+\.\d+/.test(navigator.userAgent||""))skip_reasons.push("bing preview");if(!util.origin_is_allowed_url(this.video_url,this.CG("agent.origins")))skip_reasons.push("origin is not allowed");var allow_stats_no_mse=util.is_ios||this.CG("wrapper.allow_stats_no_mse");if(player.tech=="html5"&&!window.MediaSource&&(!allow_stats_no_mse||["cdn","bwsaver"].includes(mode))){skip_reasons.push("mse unavailable")}if(util.is_firefox&&util.is_windows&&util.guess.version=="xp"&&this.method=="progressive"){skip_reasons.push("progressive not supported on winxp/ff")}if(this.is_static_proxy()&&!this.get_proxy_url())skip_reasons.push("not proxy url");if(player.is_ad_source()&&!this.CG("kw.ads_only"))skip_reasons.push("ad video in non-ad zone");if(opt.init_not_idle&&is_late_attach()&&!this.adaptive){var frames=player.get_decoded_frames()||0;if(player.is_playing()&&!is_below(frames,this.CG("player.allow_late_attach",5))){skip_reasons.push("already playing, "+frames+" frames decoded")}if(player.is_ad_active()&&!player.is_ad_loading()&&!this.CG("player.allow_late_attach_during_ad")){skip_reasons.push("already playing, ad in progress")}}var e={method:this.method,mode:mode};player.emit("wrapper.check_skip_video",e);if(e.skip)skip_reasons.push(e.skip)};Wrapper.prototype.zone_init=function(){function init_zone_info(){var video_type=null;video_type=_this.player.get_video_type_name(_this.video_url);_this.adaptive=util.get_adaptive_by_type(video_type);_this.method=util.is_progressive(video_type)?"progressive":_this.adaptive=="hls"&&util.is_enabled(hola_adaptive)&&hola_adaptive.supported(_this.player)?"hap_hls":util.get_method_type(video_type);_this.zone.info.video_url=_this.video_url;_this.zone.info.video_type=_this.video_type;_this.zone.info.method=_this.method;_this.zone.info.player_info=_this.player.name+"/"+_this.player.tech}var _this=this;var zperr=this.zone.perr_get();this.zone.uninit();this.video_check_n=(this.video_check_n||0)+1;if(this.video_check_n>1)this.log.reset_logs();this.zone.zone_init({video_url:this.video_url,player_n:this.player_n,video_check_n:this.video_check_n,player:this.player});init_zone_info();var m=mode.select_mode({location:this.loader.jtest.location,CG:this.CG.bind(this.zone),method:this.method,hap_provider_loaded:this.player.get_caps().hap_provider_loaded,suspended:this.loader.suspended});this.log.notice("using zone "+this.zone.name+" mode "+m.mode+(m.disabled_reason?" ("+m.disabled_reason+")":""));this.CS("mode",m.mode);this.CS("skip",undefined);if(!this.player.is_ad_source()&&this.video_url!=this.video_seq_url){this.video_seq_n++;this.video_seq_url=this.video_url}this.CS("sequential",this.video_seq_n>1);this.zone.reconf();this.player.emit("wrapper.zone_init")};Wrapper.prototype.save_context=function(){var supported=this.CG("wrapper.save_context",this.player.get_caps().save_context);if(!this.video_url||this.player.is_ad_source()||this.player.tech!="html5"||!supported.includes(this.method)){return}this.log.notice("saving interrupted context for "+this.video_url);this.player.emit("wrapper.suspend",this.cdn);this.cdn.suspend(true);this.stash.push({mode:this.zone.CG("mode"),video_url:this.video_url,video_check_n:this.video_check_n,cdn:this.cdn,zone_restore:this.zone.stash(),player_restore:this.player.stash&&this.player.stash(),log_restore:this.log.stash()});if(0)this.zone.uninit();this.remove_context()};Wrapper.prototype.restore_context=function(opt){var stash,url=this.video_url;if(!(stash=this.stash.find(function(s){return s.video_url==url})))return;this.stash.splice(this.stash.indexOf(stash),1);if(stash.video_check_n<this.video_check_n)stash.log_restore();stash.zone_restore();if(stash.player_restore)stash.player_restore();this.cdn=stash.cdn;this.player.emit("wrapper.zone_init");this.cdn.suspend(false,opt);this.player.emit("wrapper.restore",this.cdn);this.log.notice("using zone "+this.zone.name+" mode "+this.CG("mode"));this.log.notice("restoring context for "+this.video_url);if(this.cdn.is_reported)this.reset_report({cdn:stash.cdn});return true};Wrapper.prototype.foreach_saved_context=function(cb){if(!this.stash.length)return;var orig_env=[this.zone.stash(),this.log.stash(),function(cdn){this.cdn=cdn}.bind(this,this.cdn)];this.stash.forEach(function(s){this.cdn=s.cdn;s.zone_restore();s.log_restore();cb.call(this,s)},this);orig_env.forEach(function(restore_cb){restore_cb()})};Wrapper.prototype.uninit_saved_context=function(){this.foreach_saved_context(function(s){if(!s.cdn.is_attached())return;this.log.notice("shutting down suspended context for "+s.video_url);this.uninit_prev({cdn:s.cdn})});this.stash=[]};function set_player_info(player,o){try{var container=player.get_container();if(!container)return;container.hola_info=o}catch(e){}}Wrapper.prototype.attach=try_wrapper({method:true},function(opt){load_perf.push("wrapper_attach_start",this.zone);var _this=this;var zperr=this.zone.perr_get();this.stash=[];this.zstats=this.loader.stats;if(this.verify_attached(true))return;this.attached=true;var player=this.player=opt.player_obj;player.extensions={buffer_monitor:new buffer_monitor.PlayerExtension(player)};this.zone.info.player_info=player.name+"/"+player.tech;this.log.notice("wrapper attached to player "+player.name+" "+player.tech);function skip_reason_to_perr_id(skip_reason){switch(skip_reason){case"filtered out":return"wrapper_filter_out";case"mse unavailable":return"wrapper_no_mse";default:return"wrapper_video_skip"}}function attach_to_player(o){load_perf.push("wrapper_attach_to_player_start",_this.zone);_this.last_stats=undefined;_this.uninit_prev();o=o||{};_this.video_url=util.absolute_uri(o.url||player.get_url());_this.video_type=player.get_video_type();set_player_info(player,undefined);if(!_this.video_url)return zperr({id:"wrapper_attach_to_player_no_url"});if(_this.restore_context())return zperr({id:"wrapper_restore_cdn_context"});_this.new_context();_this.zone_init();var m=_this.CG("mode");var only_stats=m=="stats";if(m=="disabled"){_this.cdn.set_disabled("mode");return _this.log.notice("hola skip "+_this.video_url+" (mode disabled)")}_this.check_skip_video({init_not_idle:o.init_not_idle});var skip_reason=_this.cdn.skip_reasons[0];if(skip_reason){_this.loader.emit("wrapper_skip_video",{url:_this.video_url});_this.log.notice("skip "+_this.video_url+" ("+skip_reason+")");var src_info;zperr({id:skip_reason_to_perr_id(skip_reason),info:{reason:skip_reason,opt_url:o.url,player_url:player.get_url(),src_info:src_info},add_log:_this.CG("util.log.report.hola_skip")});_this.CS("skip",skip_reason);if(!_this.CG("wrapper.skip2stats")){_this.CS("mode","disabled",{reconf:true});return _this.cdn.set_disabled("skip")}only_stats=true;_this.CS("mode",m="stats",{reconf:true});_this.log.notice("skip defaults to stats mode")}set_player_info(player,{zone:_this.zone.name,mode:m,video_url:_this.video_url});player.emit("wrapper.attach_to_player");_this.loader.emit("wrapper_attach_video",{url:_this.video_url,cdn:!only_stats,player:zutil.is_mocha()?undefined:player,adaptive:_this.adaptive});_this.log.notice("attach "+_this.method+" "+(_this.is_static_proxy()?"proxy ":"")+(only_stats?"stats":"cdn")+" for "+_this.video_url);_this.zone.info.bwsaver=only_stats?"disabled":"enabled";load_perf.push("wrapper_cdn_attaching",_this.zone);set_player_info(player,{zone:_this.zone.name,mode:m,video_url:_this.video_url,attached:true});_this.cdn.attach({stats:{player:_this.player,adaptive:_this.adaptive,only_stats:only_stats,zone:_this.zone,ts:_this.loader.ts,wrapper:_this,attach_ts:date.monotonic()},bwsaver:!only_stats&&{url:_this.get_proxy_url()?util.proxy2origin(_this.get_proxy_url()):_this.video_url,player_obj:_this.player,zone:_this.zone,parsers:{flv:flv,webm:webm,mp4:mp4}},problem_reporter:{zone:_this.zone,url:_this.video_url}});load_perf.push("wrapper_cdn_atached",_this.zone);if(only_stats){var e;if(e=player.get_current_error())_this.on_error(e)}}this.on_started=try_wrapper(function(url){attach_to_player({url:url})},this);this.on_ended=try_wrapper(function(e){this.uninit_prev();if(e&&e.full_complete)this.uninit_saved_context();this.zone.info.video_url=undefined;this.zone.info.video_type=undefined;if(_this.CG("wrapper.attach_only_once"))this.detach({restore:true})},this);this.on_state=try_wrapper(function(e){if(!player.is_idle()||player.is_ad_active())return;this.uninit_prev();this.zone.info.video_url=undefined;this.zone.info.video_type=undefined;if(_this.CG("wrapper.attach_only_once"))this.detach({restore:true})},this);this.on_captions=try_wrapper(function(e){if(!player.captions_supported()&&_this.cdn&&_this.cdn.attached_bws){_this.cdn.attached_bws.fallback_wrapper(function(){throw new Error("captions are not supported on this browser")},"captions")()}},this);this.on_error=try_wrapper(function(e){e.stack=(new Error).stack;var cdn=this.cdn;var video_attached=cdn&&cdn.is_attached();if(!video_attached&&this.zone.CG("wrapper.ignore_player_error_if_unattached")){this.log.err("player error but not attached, ignore error");zperr({id:"wrapper_player_error_not_attached",add_log:true,info:e});return}this.log.err("player error %s",e.hola_dont_detach?"(non fatal)":"");var stats=video_attached&&cdn.attached_stats.get_stats_all();var test=video_attached&&cdn.attached_bws?cdn.attached_bws.unittest.gen_test():"";this.uninit_prev({err:zerr.json(e)});if(video_attached){var reason;if(!(reason=e.reason)){reason="other";if(!stats)reason="missing_last_stats";else if(!stats.player||!stats.player.stat)reason="missing_stats";else if(this.zstats.is_bad_performance(stats.player.stat)){if(!stats.player.stat.manifest_parsed_ms)reason="bad_performance_manifest";else reason="bad_performance"}else if(!stats.player.stat.manifest_parsed_ms)reason="manifest"}var body={id:"wrapper_player_error",delay:false,add_log:true,info:{player_error:e.message,player_err_code:e.code,reason:reason,group:e.reason}};if(e.info)assign(body.info,e.info);if(stats)assign(body,{extra:stats,filehead:test});if(cdn.attached_bws&&cdn.attached_bws.serve_log_arr.length){body.info.serve_log=cdn.attached_bws.serve_log_arr}zperr(body)}else{zperr({id:"wrapper_player_error_not_attached",add_log:true,info:e})}if(this.attached&&!e.hola_dont_detach)this.detach({err:"player",restore:true})},this);this.on_fallback=try_wrapper(function(){zperr({id:"wrapper_fallback"});this.in_fallback=true;this.detach({err:"fallback",restore:true})},this);this.on_dispose=try_wrapper(function(){zperr({id:"wrapper_dispose"});if(0)this.detach({err:"dispose"})},this);this.on_interrupted=try_wrapper(function(opt){if(this.cdn&&!this.player.is_idle())this.save_context()},this);this.on_resumed=try_wrapper(function(opt){if(this.restore_context(opt))return zperr({id:"wrapper_restore_cdn_context"})},this);this.on_zone_init=try_wrapper(function(){this.check_live()},this);this.check_live=try_wrapper(function(){var send_perr=!this.zone.info.video_live&&player.is_live_stream();if(this.zone.info.video_live&&!player.is_live_stream()){this.log.err("live stream changed to non-live");zperr({id:"wrapper_video_live_error"})}this.zone.info.video_live=player.is_live_stream();if(send_perr)zperr({id:"wrapper_video_live"})},this);this.before_unload=try_wrapper(function(){this.detach()},this);this.on_hidden_state=try_wrapper(function(){this.log.info("page in hidden state");if(util.is_mobile&&!this.CG("wrapper.disable_visibility_state")){this.player.emit("visibility_end");this.send_report();this.foreach_saved_context(function(s){this.send_report({cdn:s.cdn})})}},this);this.on_visible_state=try_wrapper(function(){this.log.info("page in visible state");if(util.is_mobile&&!this.CG("wrapper.disable_visibility_state")){this.reset_report();this.player.emit("visibility_start")}},this);this.on_save_logs=this.save_logs.bind(this);this.on_problem_report=this.problem_report.bind(this);player.on("started",this.on_started);player.on("interrupted",this.on_interrupted);player.on("resumed",this.on_resumed);player.on("ended",this.on_ended);player.on("state",this.on_state);player.on("captions",this.on_captions);player.on("error",this.on_error);player.on("fallback",this.on_fallback);player.on("dispose",this.on_dispose);player.on("wrapper.zone_init",this.on_zone_init);player.on("manifest_loaded",this.check_live);player.on("level_loaded",this.check_live);player.on("duration_changed",this.check_live);player.on("save_logs",this.on_save_logs);player.on("problem_report",this.on_problem_report);util.on("beforeunload",this.before_unload);util.on("visible_state",this.on_visible_state);util.on("hidden_state",this.on_hidden_state);player.emit("wrapper_attached");this.emit("wrapper_attached");load_perf.push("wrapper_attach_finish",this.zone);if(this.attached&&!player.is_idle()){attach_to_player({init_not_idle:true});if(player.is_interrupted())this.on_interrupted()}});Wrapper.prototype.detach=try_wrapper({method:true},function(opt){if(this.verify_attached(false))return;this.save_global();if(this.CG("wrapper.attach_only_once"))jwplayer_hls_provider.disabled=true;var zperr=this.zone.perr_get(),info=this.zone.info;opt=opt||{};this.attached=false;var player=this.player,saved_pos,saved_state;if(opt.restore){saved_pos=player.get_pos();saved_state=player.is_paused()}player.extensions.buffer_monitor.uninit();player.off("started",this.on_started);player.off("interrupted",this.on_interrupted);player.off("resumed",this.on_resumed);player.off("captions",this.on_captions);player.off("ended",this.on_ended);player.off("state",this.on_state);player.off("error",this.on_error);player.off("fallback",this.on_fallback);player.off("dispose",this.on_dispose);player.off("wrapper.zone_init",this.on_zone_init);player.off("manifest_loaded",this.check_live);player.off("level_loaded",this.check_live);player.off("duration_changed",this.check_live);player.off("save_logs",this.on_save_logs);player.off("problem_report",this.on_problem_report);util.off("beforeunload",this.before_unload);util.off("visible_state",this.on_visible_state);util.off("hidden_state",this.on_hidden_state);this.on_started=this.on_ended=this.before_unload=this.on_state=this.on_error=this.on_fallback=this.on_dispose=this.on_visible_state=this.on_hidden_state=undefined;this.log.notice("wrapper detached from player");this.uninit_prev(opt);this.uninit_saved_context();player.emit("wrapper_detached");this.emit("wrapper_detached",{err:opt.err});if(opt.err)this.loader.emit("wrapper_error",opt.err);if(opt.restore&&info.video_url&&(util.is_mode_cdn(this.zone)||util.is_mode_bwsaver(this.zone))){if(this.loader.fallback_to_native_on_error&&util.is_android&&player.html5){html5.play_url(player.html5,info.video_url,saved_pos,saved_state,info.video_type)}else{player.play_url(info.video_url,saved_pos,saved_state,info.video_type)}}player.uninit();this.player=undefined;info.video_url=undefined;info.video_type=undefined;info.video_live=undefined});Wrapper.prototype.attach_flashls=try_wrapper({method:true},function(opt){util.assert_enabled(flashls,"flashls module is required but disabled");var player=opt.player_obj;if(!player){player=opt.player_obj=new flashls.Player(_player_opt({flashls:opt.flashls,vjs:opt.vjs},this))}this.attach(opt);return player});Wrapper.prototype.attach_yt=try_wrapper({method:true},function(opt){util.assert_enabled(youtube,"youtube module is required but disabled");var player=opt.player_obj;if(!player)player=opt.player_obj=new youtube.Player({yt:opt.yt});this.attach(opt);return player});Wrapper.prototype.attach_android=try_wrapper({method:true},function(opt){util.assert_enabled(android,"android module is required but disabled");var player=opt.player_obj;if(!player){player=opt.player_obj=new android.Player(_player_opt({android:opt.android},this))}this.attach(opt);return player});Wrapper.prototype.attach_ios=try_wrapper({method:true},function(opt){util.assert_enabled(ios,"ios module is required but disabled");var player=opt.player_obj;if(!player){player=opt.player_obj=new ios.Player(_player_opt({ios:opt.ios},this))}this.attach(opt);return player});Wrapper.prototype.attach_osmf=try_wrapper({method:true},function(opt){util.assert_enabled(osmf,"osmf module is required but disabled");var player=opt.player_obj;if(!player){player=opt.player_obj=new osmf.Player(_player_opt({osmf:opt.osmf},this))}this.attach(opt);return player});function use_hola_vjs(){return window.hola_player&&window.hola_player.VERSION}function attach_vjs_fn(_vjs){return try_wrapper({method:true},function(opt){var player=opt.player_obj;if(!player){util.assert_enabled(_vjs,"vjs module is required but disabled");player=opt.player_obj=new _vjs.Player(_player_opt({tech:util.is_enabled(vjs)&&vjs.vjs_getTech(opt.vjs)||"html5",video:opt.vjs,html5:opt.html5,flashls:opt.flashls,video_url:opt.video_url},this))}this.attach(opt);return player})}Wrapper.prototype.attach_hola_vjs=attach_vjs_fn(hola_vjs);Wrapper.prototype.attach_vjs=attach_vjs_fn(vjs);function _player_opt(opt,wrapper){return assign(opt,{zone:wrapper.zone,player_id:wrapper.id})}function attach_html5_based_fn(player_mod,props){return try_wrapper({method:true},function(opt){var player=opt.player_obj;if(!player){var player_opt=_player_opt({html5:opt.html5},this);props=typeof props=="string"?[props]:props||[];props.forEach(function(p){if(opt[p])player_opt[p]=opt[p]});util.assert_enabled(player_mod);player=opt.player_obj=new player_mod.Player(player_opt)}this.attach(opt);return player})}Wrapper.prototype.attach_html5=attach_html5_based_fn(html5,["jw","shaka","dashjs","dailymotion","kaltura","clappr","ooyala","custom"]);Wrapper.prototype.attach_flowplayer=attach_html5_based_fn(flowplayer,["flowplayer","flashls","dailymotion"]);Wrapper.prototype.attach_jtest=function(opt){return this.attach(opt)};Wrapper.prototype.attach_jwplayer=try_wrapper({method:true},function(opt){util.assert_enabled(zjwplayer,"jwplayer module is required but disabled");var _this=this,need_reload=zjwplayer.need_jwplayer_reload(opt);var loaded;if(need_reload&&(loaded=zjwplayer.jw_getSwf(opt.jw))&&loaded.PercentLoaded&&loaded.PercentLoaded()==100){this.log.warn("jwplayer version "+window.jwplayer.version.split("+")[0]+" and swf not hola-enabled. Maybe haven't replaced swf?")}window.jwplayer.hola=window.jwplayer.hola||new events;var cb=try_wrapper(function(){var player=opt.player_obj;if(!player){player=opt.player_obj=new zjwplayer.Player(_player_opt({jwplayer:opt.jw},this))}player.set_cdn_mode(true,true);player.on("wrapper_detached",function detach_cb(){player.set_cdn_mode(false,true);player.off("wrapper_detached",detach_cb)});_this.attach(opt)},_this);var canceller=zjwplayer.jw_onHolaFlashReady(opt.jw,cb);_this.on("wrapper_detached",function detach_cb(){_this.off("wrapper_detached",detach_cb);if(canceller)canceller()})});Wrapper.prototype.attach_config=function(opt){var win_vjs=window.vjs||window.videojs;define_ext.call(this,"videojs",win_vjs);define_ext.call(this,"videojs-media-source",win_vjs&&win_vjs.MediaSource);define_ext.call(this,"jquery",window.jQuery);if(this.verify_attached(true))return;opt=opt||{};if(opt.yt)return this.attach_yt(opt);if(opt.android)return this.attach_android(opt);if(opt.ios)return this.attach_ios(opt);if(opt.flowplayer)return this.attach_flowplayer(opt);if(opt.vjs&&use_hola_vjs())return this.attach_hola_vjs(opt);if(opt.flashls)return this.attach_flashls(opt);if(opt.osmf)return this.attach_osmf(opt);if(opt.vjs)return this.attach_vjs(opt);if(opt.jw)return this.attach_jwplayer(opt);if(opt.html5)return this.attach_html5(opt);if(opt.jtest)return this.attach_jtest(opt);this.log.err("player not found");perr({id:"wrapper_player_not_found"})};Wrapper.prototype.save_logs=function(evt){var bws=this.cdn&&this.cdn.attached_bws;var logs=bws?bws.get_logs(evt):this.log.logs_to_str(this.log.concat(evt&&evt.data,true),true);filesaver(new Blob([logs],{type:"application/json"}),"cdnlogs.txt")};Wrapper.prototype.problem_report=function(evt){var cdn=this.cdn||this.last_cdn;var reporter=cdn&&(cdn.attached_problem_reporter||cdn.detached_problem_reporter);reporter.send_problem_report({player_logs:evt&&evt.data})};var global_data={};Wrapper.prototype.load_global=function(){var data=global_data[this.id]=global_data[this.id]||{};this.init_n=(data.init_n||0)+1;this.video_seq_n=data.video_seq_n||0;this.video_seq_url=data.video_seq_url};Wrapper.prototype.save_global=function(key,value){var data=global_data[this.id]=global_data[this.id]||{};data.init_n=this.init_n;data.video_seq_n=this.video_seq_n;data.video_seq_url=this.video_seq_url};function Wrapper(_loader,opt){if(!(this instanceof Wrapper))return new Wrapper(_loader,opt);this.id=opt.player_id;this.player_n=opt.player_n;this.load_global();this.log=opt.log.set_module("wrapper");var zone_conf=assign({},util.conf,util.get_uri_conf());this.zone=new _zone(_loader,zone_conf,this.id+"/0",{log:opt.log});this.CG=this.zone.CG.bind(this.zone);this.CS=this.zone.CS.bind(this.zone);this.loader=_loader}return Wrapper});
define("/svc/cdn/pub/customers.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/log.js","/util/user_agent.js","/util/util.js","/svc/cdn/pub/flashls.js","/util/etask.js","/util/storage.js","/util/ajax_lite.js","/util/date.js"],function(util,_log,user_agent,zutil,flashls,etask,storage,ajax,date){var E={};var perr=util.cdn_perr;var log=_log.set_module("customers");E.init_hc_7c034c53=function(){return etask(function(){var _this=this;util.assert_enabled(flashls,"flashls module is required but disabled");function get_flashls(){var objs=util.dom_query_all("object");for(var n in objs){if(flashls.is_hola_flashls_object(objs[n]))return true}return false}function wait_for_flashls_ready(){var flashls=get_flashls();if(!flashls)return setTimeout(wait_for_flashls_ready,200);log.notice("flashls loaded");_this.continue()}if(!get_flashls()){setTimeout(wait_for_flashls_ready,200);return this.wait()}})};E.init_mako_co_il=function(){function mako_adblock_test(){if(!/\/mako-vod/.test(location.href))return;var prev=storage.get_json("hola_loader_adblock")||{};etask([function(){return ajax.raw({url:util.fix_url("//"+require.zdot("host")+"/ads.js."),timeout:0})},function(){perr({id:"loader_adblock_not_found"});if(prev.adblock_found!==undefined&&prev.adblock_found)perr({id:"loader_adblock_not_found_prev_found"});storage.set_json("hola_loader_adblock",{adblock_found:false,ts:date.monotonic()})},function catch$(e){perr({id:"loader_adblock_found"});if(prev.adblock_found!==undefined&&!prev.adblock_found)perr({id:"loader_adblock_found_prev_not_found"});storage.set_json("hola_loader_adblock",{adblock_found:true,ts:date.monotonic()})}]);etask([function(){return ajax.raw({url:util.fix_url("//rcs.mako.co.il/js/ads.js"),timeout:0})},function(){perr({id:"loader_mako_adblock_not_found"})},function catch$(e){perr({id:"loader_mako_adblock_found"})}])}mako_adblock_test()};E.init_demo=function(loader){if(util.is_chrome&&!zutil.is_mocha()){document.addEventListener("hola_cdn_init",function(e){loader.attach(e.detail||{})},false);document.dispatchEvent(new CustomEvent("hola_cdn_ready"))}};E.resolve_customer_deps=function(loader){if(E["init_"+loader.customer])return E["init_"+loader.customer](loader)};return E});
define("/svc/cdn/pub/hls.js",{__stub:1});








define("/svc/cdn/pub/autodetect.js",["cash","/svc/cdn/pub/log.js","/svc/cdn/pub/util.js","/util/util.js","/util/zerr.js","/util/events.js","/svc/cdn/pub/zjwplayer3.js","/svc/cdn/pub/vjs.js","/svc/cdn/pub/flowplayer.js","/svc/cdn/pub/youtube.js","/svc/cdn/pub/android.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/dailymotion.js","/svc/cdn/pub/flashls.js","/svc/cdn/pub/osmf.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/ios.js","/svc/cdn/pub/hls.js","/svc/cdn/pub/hola_vjs.js","/svc/cdn/pub/dom_util.js","/util/array.js"],function($,_log,util,zutil,zerr,events,zjwplayer,vjs,flowplayer,youtube,android,dash,dailymotion,flashls,osmf,html5,ios,hls,hola_vjs,dom_util,array){var E={};var perr=util.cdn_perr,CG=util.conf_get,assign=Object.assign;var log=_log.set_module("autodetect");var ad_ctrl,wrapper_fn;function Player(opt){var default_opt={setup:function(){},is_ready:function(){return true},get_container:function(){return},get_footprint:function(){return{}},get_caps:function(){return{}},destroy:function(){}};assign(this,default_opt,opt);this.setup()}zutil.inherits(Player,events.EventEmitter);E.player_handlers={};E.player_handlers.jwplayer={disabled:!util.is_enabled(zjwplayer),rels:{html5:"anc"},get_instances:function(){return zjwplayer.jw_getPlayerInstances().filter(function(jw){return zjwplayer.jw_getVideoEl(jw)})},normalize:function(jw){var _ready_sent=false;return new Player({setup:function(){var _this=this;function emit_ready(){if(!_ready_sent){_ready_sent=true;_this.emit("ready")}}if(!this.is_ready()){window.jwplayer.hola=new events;jw.onReady(emit_ready);window.jwplayer.hola.on("ready",emit_ready)}if(zjwplayer.jw_isError(jw)){log.err("jwplayer loaded with error");perr({id:"loader_error_jwplayer",add_log:true,info:{playlist:zerr.json(jw.getPlaylist())}})}this.load_hook=util.inject_hook(jw,"load",function(){_this.emit("dispose")})},get_element:function(){return zjwplayer.jw_getVideoEl(jw)},get_container:function(){return zjwplayer.jw_getContainer(jw)},get_footprint:function(){return{player_id:jw.id}},is_ready:function(){return _ready_sent||!zjwplayer.jw_isBeforeReady(jw)},get_opt:function(){return{jw:jw}},get_caps:function(){return{init_on_master_ready:true}},destroy:function(){this.load_hook.remove()}})}};E.player_handlers.videojs={disabled:!util.is_enabled(vjs)&&!util.is_enabled(hola_vjs),rels:{html5:"anc",flashls:"mod",osmf:"mod",dailymotion:"mod",dashjs:"mod",shaka:"mod"},get_instances:function(){var players=[];if(window.videojs){players=zutil.values(window.videojs.getPlayers?window.videojs.getPlayers():window.videojs.players||{})}if(!players.length){$(CG("loader.autodetect.videojs.selector",".video-js")).each(function(){var el=this;if(el.player&&el.id)players.push(el.player)})}return players.filter(function(p){if(zutil.is_mocha())return true;var el=p&&(p.contentEl&&p.contentEl()||p.el&&p.el());return el&&document.body.contains(el)})},normalize:function(instance){return new Player({setup:function(){var _this=this;this.ready=false;this.on_dispose=function(){_this.disposed=true;_this.emit("dispose")};instance.ready(function(){_this.ready=true;_this.emit("ready")});instance.one("dispose",this.on_dispose);instance.one("gotSourceUrl",function(e){_this.video_url=e.source})},destroy:function(){if(!this.disposed)instance.off("dispose",this.on_dispose)},get_element:function(){if(!this.disposed)return instance.el().querySelector(".vjs-tech")},get_container:function(){return instance.el()},get_footprint:function(){return{player_id:instance.id()}},is_ready:function(){return this.ready},get_opt:function(){var opt={vjs:instance};if(this.video_url)opt.video_url=this.video_url;return opt}})}};E.player_handlers.flowplayer={disabled:!util.is_enabled(flowplayer),rels:{html5:"anc",dailymotion:"mod",flashls:"mod"},get_instances:function(){return flowplayer.get_players().filter(function(p){if(zutil.is_mocha())return true;return p.container.querySelector(".fp-engine")}).map(function(group){return group.fplayer})},normalize:function(instance){var group=flowplayer.get_players().find(function(g){return g.fplayer==instance});return new Player({setup:function(){var _this=this;if(!this.is_ready()){instance.on("ready",function(){delete instance.hola_reloading});instance.one("ready",function(){_this.emit("ready")})}if(!instance.hola_patched){instance.on("load",function(){instance.hola_reloading=true});instance.hola_patched=true}},get_element:function(){var el=group.container.querySelector(".fp-engine");return el&&["object","embed","video"].includes(el.tagName.toLowerCase())?el:null},get_container:function(){return group.container},get_footprint:function(){return{player_id:group.id}},is_ready:function(){if(!zutil.is_mocha()&&instance.engine&&instance.engine.engineName!="flash"){return true}return instance.ready&&!instance.hola_reloading},get_opt:function(){var dm,opt={flowplayer:instance};if(dm=flowplayer.fp_dailymotion_get(instance))opt.dailymotion=dm;return opt}})}};E.player_handlers.bluebillywig={rels:{html5:"anc",dailymotion:"mod"},get_instances:function(){var predicate=function(p){return p.getWrapper()};return window.bluebillywig&&window.bluebillywig.players&&window.bluebillywig.players.filter(predicate)},normalize:function(instance){return new Player({setup:function(){var _this=this;function emit_ready(){_this.emit("ready");instance.off(emit_ready)}if(!instance.isReady())instance.on("ready",emit_ready)},is_ready:function(){return instance.isReady()},get_element:function(){return instance.getWrapper().querySelector("video")},get_opt:function(){var dm;try{dm=instance._internal.Main._programController._headController._heads.Html5HLS_video._hlsHelper._hls}catch(e){}return dm&&{dailymotion:dm}}})}};E.player_handlers.panolens={rels:{html5:"anc"},get_instances:function(){return window.PANOLENS&&(window.panorama||typeof(window.player||{}).panorama=="function"&&window.player.panorama()||{}).videoElement},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{html5:instance}}})}};E.player_handlers.delightvr={rels:{html5:"anc"},get_instances:function(){return window.__dl8__delightVrApp&&window.__dl8__delightVrApp._store.getState().data.contents.map(function(p){return p.element})},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{html5:instance}}})}};E.player_handlers.kaltura={rels:{html5:"anc",dailymotion:"mod"},get_instances:function(elements){if(!window.kalturaIframePackageData)return;var pid=window.kalturaIframePackageData.playerId;var sel='[id="'+pid+'"].mwEmbedPlayer';var player=document.querySelector(sel);return player&&player.getPlayerElement()?player:null},normalize:function(instance){return new Player({setup:function(){if(CG("loader.autodetect.kaltura.destroy_on_swap_media")){var _this=this;window.$(instance).on("onChangeMediaDone",function(){_this.emit("reload","reloaded")})}},get_element:function(){return instance.getPlayerElement()},get_opt:function(){var hls,opt={kaltura:instance};if(hls=zutil.get(instance,"plugins.hlsjs.hls"))opt.dailymotion=hls;return opt}})}};E.player_handlers.clappr={rels:{html5:"anc",dailymotion:"mod"},get_instances:function(elements){if(!window.Clappr)return;return zutil.get(window,CG("loader.autodetect.clappr.location","hola_cdn.clappr"))},validate:function(instance){return instance instanceof window.Clappr.Player},normalize:function(instance){return new Player({setup:function(){if(!this.is_ready()){instance.once(window.Clappr.Events.PLAYER_READY,this.emit.bind(this,"ready"))}},get_element:function(){var container=instance.options.parentElement;return container&&container.querySelector("video")},get_container:function(){return instance.options.parentElement},is_ready:function(){return instance.isReady},get_opt:function(){var dm,opt={clappr:instance};if(dm=(instance.getPlugin("hls")||{})._hls)opt.dailymotion=dm;return opt}})}};E.player_handlers.ooyala={rels:{html5:"anc"},get_instances:function(){if(!window.OO)return;var player;try{var root=window.OO.__internal.players;player=root[Object.keys(root)[0]].modules.find(function(m){return m.name=="videoController"}).instance.activeInstances.main.element.wrapper.player}catch(e){}return player},validate:function(instance){return instance.getConfig},normalize:function(instance){return new Player({setup:function(){var _this=this;if(this.is_ready())return;instance.addEventHandler("onReady",this.on_ready=function(){_this.emit("ready")})},get_element:function(){return instance.getVideoElement()},is_ready:function(){return instance.isReady()&&instance.getConfig().source},get_opt:function(){return{ooyala:instance}},destroy:function(){if(!this.on_ready)return;instance.removeEventHandler("onReady",this.on_ready)}})}};E.player_handlers.youtube={disabled:!util.is_enabled(youtube),rels:{html5:"anc"},get_instances:function(){return youtube.get_player()},normalize:function(instance){return new Player({get_element:function(){return instance.querySelector("video")},get_opt:function(){return{youtube:instance}}})}};E.player_handlers.android={disabled:!util.is_enabled(android),init:function(ctrl){if(android.get_player())return;var watch_uninit=android.watch_player(function(){ctrl.emit("resync")});ctrl.once("uninit",watch_uninit)},get_instances:function(){return android.get_player()},normalize:function(instance){return new Player({setup:function(){var _this=this,hola_cdn=window.hola_cdn;var ws_socket=instance.get_ws_socket?instance.get_ws_socket():5e3;var attach_handler=function(data){if(data.cmd=="attach"){_this.ready=true;_this.emit("ready")}};hola_cdn.android_messenger=new events.EventEmitter;hola_cdn.android_messenger.on("message",attach_handler);hola_cdn.android_message=function(data){hola_cdn.android_messenger.emit("message",typeof data=="string"?JSON.parse(data):data)};if(ws_socket>-1){var ws=new util.ws("127.0.0.1:"+ws_socket,{path:"mp",protocol:"ws"});ws.on("message",hola_cdn.android_message)}},get_element:function(){return instance},is_ready:function(){return this.ready},get_opt:function(){return{android:instance}}})}};E.player_handlers.ios={disabled:!util.is_enabled(ios),init:function(ctrl){window.hola_cdn.api.ios_ready=function(){ctrl.emit("resync")};ctrl.once("uninit",function(){window.hola_cdn.api.ios_ready=undefined})},get_instances:function(){return ios.get_players()},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{ios:instance}}})}};E.player_handlers.shaka={init:function(ctrl){window.hola_cdn.api.shaka_message=function(msg){if(msg.id=="attach")ctrl.emit("resync")};ctrl.once("uninit",function(){window.hola_cdn.api.shaka_message=undefined})},get_instances:function(elements){return elements.map(function(el){return el.shaka}).filter(function(shaka){return shaka})},normalize:function(instance){return new Player({get_element:function(){return instance.getMediaElement?instance.getMediaElement():instance.getVideo()},get_opt:function(){return{shaka:instance}}})}};E.player_handlers.dashjs={init:function(ctrl){function on_player(player){setTimeout(function(){var v;try{v=player.getVideoModel().getElement()}catch(e){return}v.dashjs=player;ctrl.emit("resync")})}function patch_dashjs(){if(window.MediaPlayer&&window.Dash||window.dashjs&&window.dashjs.MediaPlayer){util.assert_enabled(dash,"dash module is required but disabled");var dashjs_ctrl=dash.patch_dashjs();if(dashjs_ctrl)dashjs_ctrl.on("newplayer",on_player);ctrl.off("domupdate",patch_dashjs)}}window.hola_cdn.api.dashjs_message=on_player;ctrl.on("domupdate",patch_dashjs);ctrl.once("uninit",function(){window.hola_cdn.api.dashjs_message=undefined;ctrl.off("domupdate",patch_dashjs)})},get_instances:function(elements){var detect=CG("loader.autodetect.dash.detect");if(detect){var player;try{player=detect()}catch(e){}return player}return elements.filter(function(e){return e.dashjs}).map(function(e){return e.dashjs})},normalize:function(instance){return new Player({get_element:function(){try{return instance.getVideoModel().getElement()}catch(e){}},get_opt:function(){return{dashjs:instance}}})}};E.player_handlers.dailymotion={disabled:!util.is_enabled(dailymotion),rels:{html5:"anc"},init:function(ctrl){function resync_on_new_player(player){var Hls=window.Hls||player.constructor;if(player.media.hola_dm_hls_attached)return;player.media.hola_hls=player;ctrl.emit("resync");player.on(Hls.Events.MEDIA_DETACHING,function cb(){player.off(Hls.Events.MEDIA_DETACHING,cb);player.media.hola_hls=undefined;setTimeout(function(){ctrl.emit("resync");on_player(player)})})}function on_player(player){if(player.hola_detected)return;player.hola_detected=true;var Hls=window.Hls||player.constructor;if(player.media)return resync_on_new_player(player);player.on(Hls.Events.MEDIA_ATTACHING,function cb(){player.off(Hls.Events.MEDIA_ATTACHING,cb);resync_on_new_player(player)})}function config_detect(){var detect=CG("loader.autodetect.dailymotion.detect",function(){return window.dm_hls_inst||window.hola_cdn.dm_hls_inst});if(detect){var player;try{player=detect()}catch(e){}if(player)on_player(player)}}function on_domupdate(){config_detect();if(!window.Hls||typeof window.Hls.isSupported=="function"&&!window.Hls.isSupported()){return}if(window.Hls.api&&window.Hls.api.players)window.Hls.api.players.forEach(on_player);if(window.Hls.api&&window.Hls.api.players&&CG("loader.autodetect.dailymotion.use_detection_api")){window.Hls.api.addListener(window.Hls.Events.PLAYER_CREATED,on_player);ctrl.once("uninit",function(){window.Hls.api.removeListener(window.Hls.Events.PLAYER_CREATED,on_player)});return ctrl.off("post-domupdate",on_domupdate)}var dm_ctrl;if(CG("loader.autodetect.dailymotion.use_proxy")||util.get_hola_uri("hola_dm_proxy")){util.assert_enabled(hls,"hls is required but disabled");dm_ctrl=dailymotion.patch_dm_with_proxy(window.Hls,hls,CG)}else dm_ctrl=dailymotion.patch_dm(window.Hls,CG);if(!dm_ctrl)return;window.Hls=dm_ctrl.hls;dm_ctrl.on("newplayer",on_player);ctrl.once("uninit",function(){window.Hls=dm_ctrl.hls_orig})}if(Array.isArray(window.__hola_hls_instances))window.__hola_hls_instances.forEach(on_player);if(window.__hola_hls_instances&&Array.isArray(window.__hola_hls_instances.listeners)){var l=window.__hola_hls_instances.listeners;if(l.indexOf(on_player)==-1)l.push(on_player)}config_detect();ctrl.on("post-domupdate",on_domupdate);ctrl.once("uninit",function(){ctrl.off("post-domupdate",on_domupdate)})},get_instances:function(elements){return elements.filter(function(e){return e.hola_hls}).map(function(e){return e.hola_hls})},normalize:function(instance){return new Player({setup:function(){var _this=this;(function onready(){if(!_this.is_ready()){var event=window.Hls.Events[instance.media?"MANIFEST_LOADING":"MEDIA_ATTACHING"];instance.on(event,function waiting_cb(){instance.off(event,waiting_cb);onready()});return}_this.emit("ready")})()},get_element:function(){return instance.media},is_ready:function(){if(instance.media&&instance.media.className.includes("vjs-tech")){if(!window.hola_player)return true}return!!(instance.media&&instance.url)},get_opt:function(){return{dailymotion:instance}}})}};E.player_handlers.flashls={disabled:!util.is_enabled(flashls),init:function(ctrl){var reset=util.on_window_message(function(e){if(e.data&&e.data.id&&e.data.id=="flashls.hlsNew")ctrl.emit("resync")});ctrl.once("uninit",reset)},get_instances:function(elements){return elements.filter(function(el){return flashls.is_hola_flashls_object(el)})},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{flashls:instance}},get_extra_info:function(){return"v"+instance.hola_version().patch_version}})}};E.player_handlers.osmf={disabled:!util.is_enabled(osmf),init:function(ctrl){var reset=util.on_window_message(function(e){if(e.data&&e.data.id&&e.data.id=="osmf.manifestLoading")ctrl.emit("resync")});ctrl.once("uninit",reset)},get_instances:function(elements){return elements.filter(function(el){return osmf.is_hola_osmf_object(el)})},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{osmf:instance}}})}};E.player_handlers.html5={rels:{shaka:"mod",dashjs:"mod"},get_instances:function(elements){return elements.filter(function(el){return el.tagName=="VIDEO"})},validate:function(el){var ignore=CG("loader.autodetect.ignore");return el.src!==undefined&&!(el.src&&el.src.startsWith("data:"))&&(!ignore||!RegExp(ignore).test(el.src))&&!el.className.includes("hola_video_preview")},normalize:function(instance){var _this=this;return new Player({setup:function(){var __this=this;if(!this.is_ready()){var cb=function(){if(__this.is_ready()){__this._remove_ready_listeners();__this.emit("ready")}};instance.addEventListener("loadstart",cb);instance.addEventListener("play",cb);this._remove_ready_listeners=function(){instance.removeEventListener("loadstart",cb);instance.removeEventListener("play",cb);delete __this._remove_ready_listeners}}},get_element:function(){return instance},is_ready:function(){if(instance.className.includes("video-js")||!_this.validate(instance)){return false}if(instance.hola_hls)return true;if(instance.preload=="none"&&!instance.autoplay&&instance.paused){return!!(html5.get_video_source(instance)&&(instance.readyState||instance.networkState==2||instance.initNetworkState_==2))}return!!html5.get_video_source(instance)},get_opt:function(){var ops_fn,opt={html5:instance};if(ops_fn=CG("loader.autodetect.html5.custom_ops"))try{opt.custom=ops_fn(instance)}catch(e){}return opt},destroy:function(){if(this._remove_ready_listeners)this._remove_ready_listeners()}})}};function Sequence(ctrl){this.ctrl=ctrl;this.ctrl.once("uninit",this.uninit.bind(this));this.init()}Sequence.prototype.init=function(){var _this=this,ctrl=this.ctrl;if(this.inited)return;this.inited=true;this.footprints={};ctrl.on("pre-domupdate",this.on_domupdate=function(arg){if(!arg||!util.dom_listen.using_observer)return;var pid_control=[],retry_attempts=0;do{for(var i=arg.length-1;i>=0;i--){var mutation=arg[i];for(var j=0;j<mutation.removedNodes.length;j++){var rem=mutation.removedNodes[j],hnodes=[];if(rem.hasAttribute&&rem.hasAttribute("hola-pid"))hnodes=[rem];else if(rem.querySelectorAll)hnodes=rem.querySelectorAll("[hola-pid]");if(!hnodes.length)continue;for(var k=0;k<hnodes.length;k++){var pid=hnodes[k].getAttribute("hola-pid");if(!pid_control.includes(pid))pid_control.push(pid);var parent=mutation.target;var ppid=parent.getAttribute("hola-pid")||"";if(!ppid.split(",").includes(pid)){parent.setAttribute("hola-pid",ppid?ppid+","+pid:pid)}hnodes[0].removeAttribute("hola-pid")}}}if(pid_control.length){var pids_in_dom=[];util.dom_query_foreach("[hola-pid]",function(node){node.getAttribute("hola-pid").split(",").forEach(function(pid){pids_in_dom.push(pid)})});pid_control=pid_control.filter(function(pid){return!pids_in_dom.includes(pid)})}}while(pid_control.length&&++retry_attempts<10);if(pid_control.length)_this.report("pid transfer failed",{pids:pid_control.join(",")})})};Sequence.prototype.uninit=function(){if(!this.inited)return;this.inited=false;this.ctrl.off("pre-domupdate",this.on_domupdate);util.dom_query_foreach("[hola-pid]",function(node){node.removeAttribute("hola-pid")});this.footprints=this.ctrl=undefined};Sequence.prototype.report=function(desc,data){if(!CG("autodetect.sequence.report"))return;data=assign({desc:desc,footprints:this.footprints},data);perr({id:"loader_autodetect_seq_failure",add_log:true,full:true,info:assign({},data)})};Sequence.prototype.detect_pid=function(el,footprint){var parent,ppid;if(!(parent=dom_util.closest(el,"[hola-pid]"))||!(ppid=parent.getAttribute("hola-pid"))){return}var match,pid_list=ppid.split(",");if(!(match=this.find_by_footprint(pid_list,footprint))){this.report("pid pickup failed",{pids:ppid,using_footprint:footprint});pid_list.forEach(function(pid){this.remove_footprint(pid)},this);return void parent.removeAttribute("hola-pid")}pid_list.splice(pid_list.indexOf(match),1);if(pid_list.length)parent.setAttribute("hola-pid",pid_list.join(","));else parent.removeAttribute("hola-pid");return match};Sequence.prototype.build_footprint=function(player){function is_element_node(node){return node&&typeof Node!="undefined"&&node.nodeType==Node.ELEMENT_NODE}function get_node_path(node,opt){var path="";for(var i=0;is_element_node(node)&&i<opt.max_depth;i++){path=dom_util.get_full_elm_selector(node)+(path?" "+path:"");node=node.parentNode}return path}var el=player.get_element(),pfp=player.get_footprint();var conf_fn=CG("loader.autodetect.sequence.footprint_fn");return{element_id:el.id||undefined,player_name:player.name,player_id:pfp.player_id?player.name+"/"+pfp.player_id:undefined,conf_id:conf_fn&&util.try_wrapper_silent(conf_fn)(player),debug:{path:get_node_path(el,{max_depth:4})}}};Sequence.prototype.save_footprint=function(pid,footprint){this.footprints[pid]=footprint};Sequence.prototype.remove_footprint=function(pid){delete this.footprints[pid]};Sequence.prototype.find_by_footprint=function(pid_list,fp){var fps=this.footprints;var criterias={match_by_conf:function(){return fp.conf_id&&pid_list.splice(0,pid_list.length).find(function(pid){return fp.conf_id==fps[pid].conf_id})},match_by_id:function(){return pid_list.find(function(pid){return fp.element_id&&fp.element_id==fps[pid].element_id||fp.player_id&&fp.player_id==fps[pid].player_id})},match_by_player_name:function(){pid_list=pid_list.filter(function(pid){return fps[pid].player_name==fp.player_name});return pid_list.length==1?pid_list[0]:0}};var pid;Object.keys(criterias).find(function(key){if(!(pid=criterias[key]()))return;log.debug("rediscovered pid %d using rule %s",pid,key);return true});return pid||0};Sequence.prototype.gen_next_pid=function(player){Sequence.pid=Sequence.pid||0;return++Sequence.pid};Sequence.prototype.get_pid=function(player,is_slaved){var pid,el=player.get_element();if(!this.inited||!el||!el.hasAttribute||is_slaved)return this.gen_next_pid();if(el.hasAttribute("hola-pid"))return+el.getAttribute("hola-pid")||this.gen_next_pid();var footprint=this.build_footprint(player);if(!(pid=this.detect_pid(el,footprint))){pid=this.gen_next_pid();this.save_footprint(pid,footprint)}el.setAttribute("hola-pid",pid);return pid};Group.id=0;function Group(ctrl,player,pid){this.id=++Group.id;this.pid=pid;this.log=log.fork(this.pid);this.players=[];this.ctrl=ctrl;this.ctrl_handlers=[];this._check_players_ready=this.check_players_ready.bind(this);this.on_ctrl_event("playerfound",this.on_player_found.bind(this));this.on_ctrl_event("playerlost",this.on_player_lost.bind(this));this.on_ctrl_event("domupdate",this.on_dom_changed.bind(this));this.on_ctrl_event("uninit",this.uninit.bind(this));this.on_player_found(player)}Group.prototype.uninit=function(reason){var _this=this;if(!this.is_destroyed()){this.log.info("autodetect getting shut down (%s)",reason);this.destroy()}this.ctrl_handlers.forEach(function(h){_this.ctrl.off(h.event,h.handler)});this.ctrl_handlers=[];this.players.forEach(function(p){delete p.group});this.players=[];this.log=this.log.uninit();this.master_player=null;this.ctrl=null};Group.prototype.on_ctrl_event=function(event,handler){this.ctrl.on(event,handler);this.ctrl_handlers.push({event:event,handler:handler})};Group.prototype.on_player_found=function(player){function get_player_info(){return player.get_extra_info?"("+player.get_extra_info()+")":""}var group_element=this.get_group_element();if(group_element&&player.get_element()!=group_element)return;player.group=this;if(this.is_destroyed()){return this.players.push(player)}this.log.notice("auto-detected "+player.name+" player instance "+get_player_info());var master=this.master_player;if(this.wrapper||this.wrapper===null){this.log.notice("player added but group already inited: tech change?");this.players.push(player);return this.destroy()}else if(this.is_new_master(player)){this.players.unshift(player);if(master){this.log.info("changing master from "+master.name+" to "+player.name)}else this.log.info("master "+player.name+" appears");this.set_master(player)}else{this.log.info("added "+player.name+" related to "+master.name+" master");this.players.push(player)}function dispose_reload(e){if(!player.group)return;player.group.log.notice(player.name+" player getting "+(e||"disposed"));player.group.destroy()}player.once("reload",dispose_reload);player.once("dispose",dispose_reload);this.check_players_ready()};Group.prototype.on_player_lost=function(player){if(!this.players.includes(player))return;this.log.notice(player.name+" player instance removed");this.destroy()};Group.prototype.on_dom_changed=function(){if(!this.master_player)return;var new_element=this.master_player.get_element();if(!this.element||this.is_destroyed())return this.element=new_element;if(new_element!=this.element){this.element=new_element;this.log.notice(this.element?"group video element changed, recreating the group":"group video element purged, destroying the group");this.destroy()}};Group.prototype.get_group_element=function(){return this.element||this.master_player&&this.master_player.get_element()};Group.prototype.is_new_master=function(candidate){function is_player_related(master,rel){var master_rels=master.get_player_info().rels||{};return master_rels[rel.get_player_info().name]}return!this.master_player||is_player_related(candidate,this.master_player)};Group.prototype.set_master=function(master){this.master_player=master;if(!this.element)this.element=this.master_player.get_element()};Group.prototype.get_ready_waiting=function(){var ready_checklist=this.master_player.get_caps().init_on_master_ready?[this.master_player]:this.players;return ready_checklist.filter(function(p){return!p.is_ready()})};Group.prototype.check_players_ready=function(){var _this=this,waiting;this.ctrl.off("post-resync",this._check_players_ready);if(this.ctrl.resyncing)return this.ctrl.once("post-resync",this._check_players_ready);if(this.is_destroyed())return;if((waiting=this.get_ready_waiting()).length){waiting.forEach(function(p){if(p.on_player_ready)p.off("ready",p.on_player_ready);p.on_player_ready=function(){if(_this.get_ready_waiting().length)return;_this.ctrl.once("post-resync",_this._check_players_ready);_this.ctrl.emit("domupdate");_this.ctrl.emit("resync")};p.on("ready",p.on_player_ready)});return}this.players.forEach(function(p){if(!p.on_player_ready)return;p.off("ready",p.on_player_ready);delete p.on_player_ready});this.create_wrapper()};Group.prototype.create_wrapper=function(){var _this=this,opt={},missing_player,err;if(err=this.ignore_group_after_error()){this.wrapper=null;return this.log.notice("group ready but stalled due to previous "+"error=%s",err)}if(missing_player=this.is_group_incomplete()){return this.log.notice("group ready but incomplete: "+missing_player+" missing, waiting...")}this.players.forEach(function(p){assign(opt,p.get_opt())});this.log.notice("init wrapper with "+Object.keys(opt).join(", "));assign(opt,{player_id:this.pid,player_n:this.id,log:this.log});if(!(this.wrapper=wrapper_fn(opt))){this.invalidate_errored_group("wrapper_init_failure");return this.ctrl.emit("wrappererror")}this.wrapper.once("wrapper_detached",function(opt){if(opt.err)_this.invalidate_errored_group(opt.err)});if(this.ctrl)this.ctrl.emit("wrappercreated",this.wrapper)};Group.prototype.ignore_group_after_error=function(){var err;this.players.find(function(p){return err=p.get_wrapped_player().hola_autodetect_ignore});return err};Group.prototype.invalidate_errored_group=function(err){this.players.forEach(function(p){p.get_wrapped_player().hola_autodetect_ignore=err});this.wrapper=null;this.log.notice("video locked from future re-attach due to error="+err)};function is_group_incomplete(player_list){var include;if(!(include=CG("loader.autodetect.group.include")))return;if(!(include instanceof Array))include=[include];return include.find(function(inc){return!player_list.find(function(player){return player==inc})})}Group.prototype.is_group_incomplete=function(){var player_list=this.players.map(function(p){return p.name});return is_group_incomplete(player_list)};Group.prototype.destroy=function(){if(this.destroyed)return;this.destroyed=true;this.log.info("destroying player group including "+this.players.map(function(p){return p.name}).join(", "));this.ctrl.off("post-resync",this._check_players_ready);this.players.forEach(function(p){if(p.on_player_ready){p.off("ready",p.on_player_ready);delete p.on_player_ready}});if(this.wrapper){if(this.wrapper.attached)this.wrapper.detach();else this.wrapper.emit("wrapper_detached",{});this.wrapper=undefined;this.ctrl.emit("wrapperdestroyed")}};Group.prototype.is_destroyed=function(){return this.destroyed};Group.prototype.get_players=function(){return this.players};Group.prototype.contains_el=function(el){var container=this.master_player.get_container();return container&&container.contains(el)};function Detector(ctrl){this.players=[];this.nplayers=[];this.elements=[];this.player_handlers=Object.keys(E.player_handlers).filter(function(k){return!E.player_handlers[k].disabled}).map(function(k){return assign({name:k},E.player_handlers[k])});this.player_handlers.forEach(function(ph){if(ph.init)ph.init(ctrl)});this.ctrl=ctrl;this._update_players=this.update_players.bind(this);this._update_elements=this.update_elements.bind(this);this._uninit=this.uninit.bind(this);this.ctrl.on("resync",this._update_players);if(!window.hola_cdn_sdk)this.ctrl.on("domupdate",this._update_elements);this.ctrl.once("uninit",this._uninit)}Detector.prototype.uninit=function(){if(!window.hola_cdn_sdk)this.ctrl.off("domupdate",this._update_elements);this.ctrl.off("resync",this._update_players);this.nplayers.forEach(function(np){np.destroy()});this.players=this.nplayers=this.elements=this.ctrl=null};Detector.prototype.check_diff=function(old_list,new_list,onchange){old_list.forEach(function(i){if(!new_list.includes(i))onchange(i,false)});new_list.forEach(function(i){if(!old_list.includes(i))onchange(i,true)})};Detector.prototype.update_elements=function(){var _this=this;var old_list=this.elements;var new_list=this.elements=$("video,object,embed").get();this.check_diff(old_list,new_list,function(e,is_added){_this.ctrl.emit(is_added?"elementfound":"elementlost",e)})};Detector.prototype.get_player_list=function(){var list=[],hlist=[],elements=this.elements;this.player_handlers.forEach(function(ph){var instances=ph.get_instances(elements)||[];if(!(instances instanceof Array))instances=[instances];if(ph.validate)instances=instances.filter(ph.validate);list=list.concat(instances);hlist=hlist.concat(instances.map(function(i){return ph}))});return{players:list,handlers:hlist}};Detector.prototype.update_players=function(){var _this=this;var collection=this.get_player_list();var old_list=this.players;var new_list=collection.players;this.ctrl.resyncing=true;this.check_diff(old_list,new_list,function(p,is_added){var np,index,handler;if(is_added){index=collection.players.indexOf(p);handler=collection.handlers[index];np=assign(handler.normalize(p),{name:handler.name,get_wrapped_player:function(){return p},get_player_info:function(){return handler}});if(!np.get_element())perr({id:"loader_autodetect_early_detection"});_this.players.push(p);_this.nplayers.push(np);_this.ctrl.emit("playerfound",np)}else{index=_this.players.indexOf(p);np=_this.nplayers[index];_this.players.splice(index,1);_this.nplayers.splice(index,1);_this.ctrl.emit("playerlost",np);np.destroy()}});this.ctrl.resyncing=false};Detector.prototype.remove_player_from_cache=function(np){var index=this.nplayers.indexOf(np);if(index<0)return;this.players.splice(index,1);this.nplayers.splice(index,1);np.destroy()};function Controller(){var evts=this.events=new util.events;util.on("post-beforeunload",function(){evts.emit("uninit","beforeunload")})}Controller.prototype.start=function(){var _this=this;if(this.running)return;this.running=true;this.groups=[];this.seq=new Sequence(this.events);this.detector=new Detector(this.events);var dom_reset=util.dom_listen(document,function(arg){
_this.events.emit("domupdate",arg);_this.events.emit("resync")});this.events.on("post-playerfound",function(player){if(!player.group){_this.groups.push(new Group(_this.events,player,_this.seq.get_pid(player,_this.is_slaved(player))))}});this.events.on("post-resync",this.cleanup_groups.bind(this));this.events.once("uninit",dom_reset);this.events.once("post-uninit",this.stop.bind(this));this.events.emit("domupdate");this.events.emit("resync")};Controller.prototype.is_slaved=function(player){var el=player.get_element();return!!this.groups.find(function(g){return g.contains_el(el)})};Controller.prototype.cleanup_groups=function(){var _this=this;function uninit_group(group){group.get_players().forEach(function(p){_this.detector.remove_player_from_cache(p)});group.uninit()}if(!this.groups.find(function(g){return g.is_destroyed()}))return;this.resync_delayed=setTimeout(function(){delete _this.resync_delayed;_this.groups=_this.groups.filter(function(g){var destroyed;if(destroyed=g.is_destroyed())uninit_group(g);return!destroyed});_this.events.emit("resync")})};Controller.prototype.stop=function(reason){if(!this.running)return;this.running=false;this.events.emit("uninit",reason||"manual");if(this.resync_delayed){clearTimeout(this.resync_delayed);delete this.resync_delayed}this.events.events.removeAllListeners();this.groups=[];this.detector=null};Controller.prototype.print_all=function(){if(!this.groups||!this.groups.length)return console.log("no players found");this.groups.forEach(function(g){var state=g.wrapper===undefined?"waiting":g.wrapper?"inited":g.ignore_group_after_error()?"ignored":"shutdown";console.log("group id %d state %s",g.id,state);g.players.forEach(function(p){console.log("%s player %s ready %s",g.master_player==p?"*":" ",p.name,p.is_ready())})})};E.init=function(opt){if(ad_ctrl)return ad_ctrl;wrapper_fn=opt.wrapper_fn;ad_ctrl=new Controller;return ad_ctrl};if(zutil.is_mocha())E.t={is_group_incomplete:is_group_incomplete,Sequence:Sequence};return E});
define("/svc/cdn/pub/vjs_hls_provider.js",{__stub:1});
define("/svc/cdn/pub/flowplayer_hls_engine.js",{__stub:1});
define("/svc/cdn/pub/ad.js",["/util/ajax_lite.js","/svc/cdn/pub/log.js","/util/etask.js","/util/date.js","/svc/cdn/pub/vjs.js"],function(ajax,_log,etask,date,_vjs){var E={};var log=_log.set_module("ad");E.vjs_setup=function(vjs,ad_opt){var adm=new ad_manager;adm.init({vjs:vjs,ad_opt:ad_opt});return vjs};E.get_ad_video=function(xml){if(!xml)return;var a=xml.match(/MediaFile.*mp4.*/);if(!a)return;a=a[0].match(/(\[CDATA\[)(.*)(]]><\/MediaFile>)/);return a&&a[2]};function ad_manager(){}ad_manager.prototype.init=function(opt){var _this=this;var ad_opt=opt.ad_opt;this.vjs=opt.vjs;if(!ad_opt||!ad_opt.schedule||!ad_opt.schedule.preroll)return log.notice("no preroll ad");etask({name:"ad_manager"},[function(){var qs=_this.prepare_tag(ad_opt.schedule.preroll.qs);var url="http://"+(ad_opt.agent||"zagent53.hola.org")+"/get_xml?qs="+encodeURIComponent(qs);log.notice("preroll url %s",url);return ajax.raw({url:url})},function(e){var v=E.get_ad_video(e);log.notice("preroll video %s",v);if(v)_this.play_ad(v)}])};ad_manager.prototype.play_ad=function(v){var _this=this;log.notice("playing ad %s",v);var vjs=this.vjs;var vad=document.createElement("video");var parent=_vjs.vjs_getElement(this.vjs).parentNode;vad.src=v;vad.autoplay=true;vad.controls=true;vad.style.position="absolute";vad.style.width="100%";vad.style.height="100%";vad.style["z-index"]=9999999;vad.addEventListener("loadeddata",function loadeddata(){vad.removeEventListener("loadeddata",loadeddata);_this.video_paused=vjs.paused();if(!_this.video_paused)vjs.pause()});vad.addEventListener("ended",function ended(){vad.parentNode.removeChild(vad);vad.removeEventListener("ended",ended);log.notice("ad ended");if(!_this.video_paused)vjs.play()});parent.appendChild(vad)};ad_manager.prototype.prepare_tag=function(tag){if(!tag)return;tag=tag.replace("[correlator]",parseInt(date.monotonic()));tag=tag.replace("[referrer_url]",location.href);tag=tag+"&sdkv=h.3.161.1";return tag};return E});
require(["cash","/util/es6_shim.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cdn_svc.js","/svc/cdn/pub/wrapper.js","/svc/cdn/pub/mode.js","/svc/cdn/pub/log.js","/svc/cdn/pub/stats.js","/svc/cdn/pub/customers.js","/util/date.js","/util/conv.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/zone.js","/svc/cdn/pub/autodetect.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/zjwplayer3.js","/svc/cdn/pub/jwplayer_hls_provider.js","/util/etask.js","/util/storage.js","/util/user_agent.js","/svc/cdn/pub/hls.js","/svc/cdn/pub/vjs_hls_provider.js","/svc/cdn/pub/flowplayer.js","/svc/cdn/pub/flowplayer_hls_engine.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/ad.js","/svc/cdn/pub/spark.js"],function($,shim,zutil,util,cdn_svc,_wrapper,mode,_log,stats,customers,date,conv,cdnlist,_zone,autodetect,load_perf,zjwplayer,jwplayer_hls_provider,etask,storage,user_agent,hls,vjs_hls_provider,zflowplayer,flow_hls_engine,html5,zad,spark){if(window.hola_cdn&&window.hola_cdn.log){window.hola_cdn.loaded_twice=true;window.hola_cdn.log.warn("Hola loader.js already loaded. If you are using "+"Hola Player there is no need to load it separately, it is included "+"with Hola Player");window.hola_cdn.perr({id:"loader_already_loaded"});return}var E=new util.events;E.init_ts=date.monotonic();var CG=E.CG=util.conf_get;E.cdn=[];E.wrapper=[];E.hooks=[];E.cdn_svc=cdn_svc;E.log=_log;E.ad=zad;E.stats=stats;E.util=util;E.require=require;E.jtest=window.hola_cdn&&window.hola_cdn.jtest||{};E.api=window.hola_cdn&&window.hola_cdn.api||{};window.hola_cdn=E.util.loader=E;var log=_log.set_module("loader");var perr=util.cdn_perr,customer,zones,gen;E.perr=perr;var zdot_json=conv.JSON_parse(require.zdot("json"))||{};var async_modules=[];var assign=Object.assign;var fake_hls_video_url="fake.m3u8",fake_video_url=fake_hls_video_url;var fake_mp4_video_url="fake.mp4";E.tag=zdot_json.test&&zdot_json.test.tag||{};E.customer=customer=zdot_json.customer;E._customer={status:zdot_json.customer_status,end:zdot_json.customer_end,name:zdot_json.customer};E.suspended=E._customer.status=="disabled"&&!E._customer.end;if(E._customer.status=="disabled"&&E._customer.end){E.disabled=true;E.disabled_reason="account closed"}E.loader_conf=zdot_json.loader||{};E.provider=zdot_json.provider||{};E.spark=zdot_json.spark||{};zones=zdot_json.zones||{};gen=zdot_json.gen||{};E.init_delay=!!zutil.get(E.loader_conf,"perr.enable_init_delay");util.ver=util.conf.ver=E.ver=require.zdot("version");function loader_inject_hook(object,prop,opts){var hook=util.inject_hook(object,prop,opts);if(hook)E.hooks.push(hook);return hook}function preload_async_modules(cb){var a=async_modules;async_modules=[];var n=a.length;if(!n){if(cb)cb();return}for(var i=0;i<a.length;i++){log.notice("loading module "+a[i]);util.load_script(a[i],function(){n--;if(n)return;var t=date.monotonic();E.async_dur=(E.async_dur||0)+t-E.async_t0;log.notice("all async modules loaded in %sms",E.async_dur);if(cb)cb();E.async_t0=undefined})}}E.async_require=function(module){E.async_t0=E.async_t0||date.monotonic();async_modules.push(module)};E.jtest_init=function(ua,platform,_gen,_spark){if(!zutil.is_mocha())return;if(_gen)gen=assign(gen,_gen);if(_spark)E.spark=assign(E.spark,_spark);util.browser_init(ua,platform);E.t={on_init_ready:auto_detect_start}};E.is_browser_supported=mode.is_browser_supported;function conf_init(){util.init(assign({customer:E.customer,ver:E.ver,bootstrap_cdns:require.zdot("agents"),loader:E.loader_conf,provider:E.provider},util.get_uri_conf()))}var log_inited;function log_init(){if(log_inited)return;log_inited=true;_log.init(E.loader_conf&&E.loader_conf.log)}E.allow_feature_init=function(){return!E.suspended&&(!E.disabled||E.disabled_reason!="account closed")};var bwsaver_active=false;E.bwsaver_active=function(active){if(arguments.length)bwsaver_active=active;return bwsaver_active};function mode_init(){var mode_opts={location:E.jtest.location,CG:CG,rules:[{cdn:1}]};var m=mode.select_mode(mode_opts);if(m.mode=="disabled"){E.disabled=true;E.disabled_reason=m.disabled_reason}var path_last=location.pathname.split("/").slice(-2);var frame=window==top?"top":(window.name?window.name+" (":"")+(path_last[1]||path_last[0])+(window.name?")":"");log.notice("hola spark loader v"+(E.ver||"0.0.0")+" tag "+(E.tag||{}).id+(m.disabled_reason?" mode disabled ("+m.disabled_reason+")":"")+" was loaded in frame: "+frame+(m.disabled_help?"\n"+m.disabled_help:""))}function cdnlist_init(){if(E.disabled)return;var zone=new _zone(E,{loader:E.loader_conf},"cdnlist");cdnlist.init(require.zdot("agents"),zone,require.zdot("all_agents"));if(!cdnlist.bootstraps)return;cdnlist.bootstraps.send("get_geoip",null,function(e){if(!e||!e.res)return;util.set_geoip(e.res);cdnlist.bootstraps.emit("geoip_received",e.res);cdnlist.bootstraps.remove_ws_listener()})}function feature_init(){if(use_video_proxy_hooks())util.try_wrapper({prefix:"video_proxy"},install_video_proxy_hooks)();spark.init({conf:E.spark,loader:E,gen:gen})}function debug_init(){var hola_debug;try{hola_debug=window.sessionStorage.getItem("hola_debug")}catch(e){if(!zutil.is_mocha())log.err("session storage error %s",e.stack||e)}if(E.loader_conf.debug||util.get_hola_uri("hola_debug")||(storage.get_json("holacdn_debug")||{}).debug||(hola_debug||"false")!="false"){E.debug_mode()}}function loader_init(){E.ts=date.monotonic();conf_init();stats.init();log_init();mode_init();cdnlist_init();feature_init();debug_init();if(0)loader_stats()}function stats_visit(){var s=storage.get_json("hola_loader_stats")||{};if(!s.last||!s.last.ts){log.notice("first time user visit");s.last={ts:date.monotonic(),href:location.href};storage.set_json("hola_loader_stats",s);perr({id:"loader_first_visit"});return}var d=(date.monotonic()-s.last.ts)/1e3;log.notice("last visit %ssec ago",d);perr({id:"loader_visit",info:{last_visit:d,prev_url:s.last.href,reload:s.last.href==location.href}});s.last.ts=date.monotonic();s.last.href=location.href;storage.set_json("hola_loader_stats",s)}function stats_browser_play(){var browser=util.browser&&util.browser.browser;var unknown=["chrome","firefox","edge","ie","safari","opera"].indexOf(browser)==-1;var video=util.dom_query_all("video");var info={browser:browser||"none",unknown:unknown,video_n:video.length,Hls:!!window.Hls};for(var i=0;i<video.length;i++){info["video_"+i+"_src"]=video[i].src;info["video_"+i+"_currentSrc"]=video[i].currentSrc;info["video_"+i+"_played"]=video[i].played&&video[i].played.length;info["video_"+i+"_paused"]=!!video[i].paused;info["video_"+i+"_duration"]=!!video[i].duration;info["video_"+i+"_pos"]=!!video[i].currentTime;video[i].__index_i=i;video[i].addEventListener("play",function cb(){this.removeEventListener("play",cb);var v=this;function get_video_info(){return assign({},info,{index:v.__index_i,src:v.src,currentSrc:v.currentSrc,pos:v.currentTime,duration:v.duration,networkState:v.networkState,h5error:v.error&&v.error.code})}function on_timeupdate(){info["video_"+v.__index_i+"_timeupdate"]=(info["video_"+v.__index_i+"_timeupdate"]||0)+1}function check_hola_attach(wait){var wrapper=E.wrapper.find(function(w){return w.player&&w.player.html5==v});if(wrapper&&wrapper.cdn&&wrapper.cdn.is_attached())return;if(wait){v.addEventListener("timeupdate",on_timeupdate);return setTimeout(check_hola_attach,5e3)}v.removeEventListener("timeupdate",on_timeupdate);perr({id:"loader_stats_browser_play_unattached",info:get_video_info()})}perr({id:"loader_stats_browser_play",info:get_video_info()});check_hola_attach(true)})}perr({id:"loader_stats_browser",info:info})}function loader_stats(){try{stats_visit();stats_browser_play()}catch(e){log.err("loader_stats error %s",e.stack||e);perr({id:"loader_stats_error",err:e})}}function wrapper_create(opt){function on_context_created(context){E.cdn.push(context);E.emit("wrapper_context_created",wrapper,context);context.once("shutdown",function(){var idx=E.cdn.indexOf(context);if(idx>=0)E.cdn.splice(idx,1)})}if(E.wrapper.length){if(CG("loader.multiplayer.disabled"))return log.notice("multiplayer mode disabled: skip new player")}var wrapper=new _wrapper(E,opt);E.wrapper.push(wrapper);if(def_player===undefined)def_player=wrapper.id;wrapper.on("context_created",on_context_created);wrapper.once("wrapper_detached",function(){wrapper.off("context_created",on_context_created);var index=E.wrapper.indexOf(wrapper);if(index>=0)E.wrapper.splice(index,1);if(wrapper.id==def_player)def_player=E.wrapper.length?E.wrapper[0].id:undefined;E.emit("wrapper_detached",wrapper)});return wrapper}function update_cdn_latest(wrapper){E.cdn_latest=wrapper.cdn||wrapper.last_cdn}function init_player(opt){opt=opt||{};load_perf.push("init_player_start");var wrapper;if(!(wrapper=wrapper_create({player_id:opt.player_id,player_n:opt.player_n,log:opt.log||_log}))){return}wrapper.on("wrapper_attached",function(){update_cdn_latest(wrapper);if(wrapper.player){wrapper.player.on("state",update_cdn_latest.bind(undefined,wrapper))}E.emit("wrapper_attached",wrapper)});wrapper.attach_config(opt);E.attached=true;return wrapper}E.finalize=function(){E.wrapper.forEach(function(w){if(w.attached)w.detach()});E.attached=false;E.wrapper=[];E.hooks.forEach(function(h){h.remove()});E.hooks=[];def_player=undefined;E.cdn=[]};E.print_load_perf=function(opt){return load_perf.timeline_to_str(E.get_wrapper(opt).zone,true)};E._unwrap_opt=function(opt){if(opt===undefined)opt=def_player||{idx:0};if(typeof opt=="number"){var wrapper=E.wrapper.find(function(w){return w.id==opt});opt={idx:wrapper?E.wrapper.indexOf(wrapper):-1}}return zutil.extend({idx:0},opt)};E.get_wrapper=function(opt){return E.wrapper[E._unwrap_opt(opt).idx]};E.get_inited_wrapper=function(opt){var wrapper;if(!E.disabled&&(wrapper=E.get_wrapper(opt))&&wrapper.zone.inited)return wrapper};var def_player;E.get_player=function(opt){return(E.get_wrapper(opt)||{}).player};E.list_players=function(){if(!E.wrapper.length)return log.console("no initialized players detected so far");E.wrapper.forEach(function(w){var CG=w.zone.CG.bind(w.zone);log.console((w.id==def_player?"*":" ")+" id="+w.id+" zone="+CG("zone")+" mode="+CG("mode")+" video_url="+w.video_url)})};E.select_player=function(id){var w,hint="use hola_cdn.list_players() to print available options";if(id===undefined)return log.console("missing player id: "+hint);if(typeof id=="string"){if(w=E.wrapper.find(function(w){return w.zone.CG("zone")==id}))id=w.id;else return log.console("no player with zone="+id+": "+hint)}else if(!E.get_wrapper(id))return log.console("no player with id="+id+": "+hint);def_player=id;log.console("player id="+id+" selected as a default player")};E.get_cdn=function(opt){return(E.get_wrapper(opt)||{}).cdn};E._get_problem_reporter=function(opt){var cdn=E.get_cdn(opt);return cdn&&cdn.attached_problem_reporter||E.cdn_latest&&E.cdn_latest.detached_problem_reporter};E._get_bws=function(opt){return(E.get_cdn(opt)||{}).attached_bws};E.get_policy=function(opt){var bws;if(bws=E._get_bws(opt))return bws.policy();return"disabled"};E.attached_stats=function(opt){return(E.get_cdn(opt)||{}).attached_stats};function get_ordered_list(zones){return Object.keys(zones).map(function(z){zones[z].zone=zones[z].zone||z;return zones[z]}).sort(function(a,b){return a.order-b.order})}var timer_id;E.get_stats=function(opt){opt=E._unwrap_opt(opt);var stat=E.attached_stats(opt);if(!stat)return;if(opt.silent)return stat.get_stats_all();clearTimeout(timer_id);if(opt.refresh>0)timer_id=setTimeout(E.get_stats.bind(E,opt),opt.refresh*1e3);return stat.print_stats()};E.api.external_err=function(opt){perr({id:"external_error",delay:false,add_log:true,bt:opt.stack,err:opt.message,info:{error:opt.message,reason:opt.reason}})};E._get_mode=function(opt){if(E.disabled)return"disabled";var wrapper=E.get_wrapper(opt);if(!wrapper||!wrapper.zone.inited)return"n/a";return wrapper.zone.CG("mode")};E.get_mode=function(opt){var m=E._get_mode(opt);if(util.is_android_sdk||util.is_ios_sdk)return m;return m=="cdn"?"hola_cdn":m=="stats"?"origin_cdn":m};E.get_zones=function(){return{gen:gen,zones:get_ordered_list(zones)}};E.set_zones=function(_zones){zones=zutil.is_mocha()?_zones:zones};E.get_log=function(opt){opt=opt||{};if(opt.full)return E.log.full_history;var wrapper=E.get_wrapper(opt);return wrapper?wrapper.log.get_logs():_log.get_logs()};E.print_log=function(opt){log.console(JSON.stringify(E.get_log(opt),null,"	"))};E.get_avail_tech=function(url,player){if(player=="jwplayer"||player=="jwplayer7")player="jw";if(["hola_vjs5_10","vjs5_10","vjs5_16","vjs5","hola_player","brightcove"].includes(player)){player="hola_vjs5"}return mode.get_available_tech(url,player)};E.help=function(){log.console("HolaCDN GitHub page (https://github.com/hola/cdn) - "+"Step by step instructions for deployment\n"+"Normal operations commands:\n"+"---------------------------\n"+"hola_cdn.set_mode_hola_cdn() - force cdn mode\n"+"hola_cdn.set_mode_bwsaver() - set bwsaver mode (MP4 only)\n"+"hola_cdn.set_mode_origin_cdn() - force stats mode\n"+"hola_cdn.set_mode_disabled() - disable HolaCDN\n"+"hola_cdn.set_mode_default() - set default mode (use server rules)\n"+"hola_cdn.get_stats() - print current stats to console\n"+"hola_cdn.get_mode() - get current operating mode\n"+"hola_cdn.get_zones() - get current zones conf\n"+"hola_cdn.get_avail_tech(url, player) - return available tech\n"+"Support commands:\n"+"---------------------------------\n"+"hola_cdn.save_log() - save log to disk; send it to HolaCDN support\n"+"hola_cdn.bug_report() - bug report. email id to HolaCDN support\n"+"hola_cdn.print_log(options) - print log, set options.full=1 to "+"print full log history\n"+"hola_cdn.print_load_perf() - print timeline of performance events\n"+"hola_cdn.get_player() - return current player object\n"+"hola_cdn.list_players() - list available players (multiplayer env)\n"+"hola_cdn.select_player(id) - set default player (multiplayer env)\n"+"Debug commands (available only in debug mode):\n"+"---------------------------------\n"+"hola_cdn.debug_mode() - enable commands listed below\n\n"+"hola_cdn.get_log() - get log array\n"+"hola_cdn.gen_unittest() - return generated unittest\n"+"hola_cdn.set_debug(on, modules) - set debug mode on/off on=1 off=0, "+"on can be an object and you can provide explicit modules\n"+"hola_cdn.set_debug_stats(on) - enable/disable stats debug\n"+"hola_cdn.get_dump() - dump of media chunks passed to MediaStream\n"+"hola_cdn.get_conf()- get current conf\n"+"hola_cdn.clear_storage() - clear hola storage (settings, cache)\n",+"hola_cdn.debug_timeline() - debug stats timeline\n"+"hola_cdn.gen_timeline() - return generated timeline\n"+"hola_cdn.gen_timeline_str() - return generated timeline str\n"+"hola_cdn.parse_timeline(s) - parse timeline\n"+"hola_cdn.test_video_origin() - check whether there is a "+"source for current video origin\n"+"hola_cdn.is_browser_in_zone() - check whether there is a rule for "+"current browser\n"+"hola_cdn.test_fallback() - simulate fallback\n"+"hola_cdn.test_js_error() - simulate uncaught js exception\n"+"hola_cdn.test_player_error() - simulate player error\n"+"hola_cdn.test_swf_version() - check whether loaded swf version is "+"latest\n"+"hola_cdn.test_whitelisted_zagents() - check whether whitelisted "+"zagents working\n"+"hola_cdn.test_cors() - check if CORS configured")};E.debug_mode=function(on_ready,on_error){var hola_debug=true;if(typeof on_ready=="boolean"){hola_debug=on_ready;var stor=storage.get_json("holacdn_debug")||{};stor.debug=hola_debug;storage.set_json("holacdn_debug",stor)}try{window.sessionStorage.setItem("hola_debug",hola_debug)}catch(e){log.err("session storage error %s",e.stack||e)}util.debug_mode=_log.debug_mode=hola_debug;util.load_script("//"+require.zdot("host")+"/debug.js",on_ready||function(){},{onerror:on_error})};E.save_log=function(opt){var wrapper=E.get_wrapper(opt);if(!wrapper)return log.notice("cdn is not attached");wrapper.save_logs()};E.bug_report=function(uid,opt,full){var problem_reporter;if(problem_reporter=E._get_problem_reporter(opt)){problem_reporter.send_problem_report({userid:uid,full:full});if(!full){this.log.console("To send bug_report with full history log, run: "+"hola_cdn.bug_report(true)")}return}var bugid=+(Math.random()+"").slice(2);util.cdn_perr({id:"err_problem_report",delay:false,full:true,add_log:true,info:{bugid:bugid}});this.log.console(util.get_perr_link_msg(this.customer,bugid))};function set_mode(m){storage.set("hola_mode",m);log.console(m+" mode is now enabled. Please refresh the page and "+"replay the video.\n\n You can always use hola_cdn.get_mode() to verify "+"current operation mode.")}E.set_mode_cdn=E.set_mode_hola_cdn=function(){set_mode("hola_cdn")};E.set_mode_bwsaver=function(){set_mode("bwsaver")};E.set_mode_stats=E.set_mode_origin_cdn=function(){set_mode("origin_cdn")};E.set_mode_disabled=function(){set_mode("disabled")};E.set_mode_default=function(){storage.set("hola_mode",null);log.console("default mode is now enabled. Please refresh the page and "+"replay the video. HolaCDN will be initialized based on settings "+"configured for this zone in the portal.\n\n You can always use "+"hola_cdn.get_mode() to verify current operation mode.")};E.set_debug_freeze_next_req=function(_cdn,ms,opt){var cdn;if(!(cdn=E.get_cdn(opt)))return log.console("no active cdn service found");cdn.debug_freeze_next_req={cdn:_cdn,ms:ms};log.console("schedule freeze for next cdn "+_cdn+" req "+ms+"ms")};E.set_debug_freeze_cdns=function(ms,opt){var cdn;if(!(cdn=E.get_cdn(opt)))return log.console("no active cdn service found");cdn.debug_freeze_cdns_ms=+ms;log.console("freeze all cdns for "+ms+"ms")};E.set_debug_fail_cdns=function(on,opt){var cdn;if(!(cdn=E.get_cdn(opt)))return log.console("no active cdn service found");cdn.debug_fail_cdns=!!on};E.console_repair=function(){var i=document.createElement("iframe");document.head.appendChild(i);window.console=i.contentWindow.console};E._create_hola_hls_log=function(conf_get){function log_dm(level,msg){var wrapper=E.get_inited_wrapper();var log_obj=(wrapper?wrapper.log:_log).set_module("hlsprov");log_obj[level](msg)}if(!conf_get("util.log.dailymotion"))return;return{debug:function(msg){log_dm("debug",msg)},info:function(msg){log_dm("info",msg)},log:function(msg){log_dm("info",msg)},warn:function(msg){log_dm("warn",msg)},error:function(msg){log_dm("err",msg)}}};function gen_hola_hls_config(conf_get){var debug;if(!conf_get)conf_get=select_zone_get_conf(fake_hls_video_url);var config=util.def_hola_hls_config(conf_get);if(conf_get("cdn.send_reqs.origin.with_credentials"))config.xhrSetup=function(x){x.withCredentials=true};if(debug=E._create_hola_hls_log(conf_get))config.debug=debug;return assign(config,conf_get("cdn.hap.hls_config"))}var dm_t0=date.monotonic();function dm_perr(id){perr({id:id,info:{t_t0:date.monotonic()-dm_t0}})}function load_dm(conf_get,cb){if(util.is_enabled(hls)){window.Hls=hls;window.Hls.hola_config=gen_hola_hls_config(conf_get);cb(conf_get);return}var src=conf_get("loader.dailymotion.src")||"//"+require.zdot("host")+require.zdot("hls_js");window.hola_cdn.async_require(src);preload_async_modules(function(){window.Hls.hola_config=gen_hola_hls_config(conf_get);cb(conf_get)})}function load_dash(conf_get,cb){dm_perr("loader_dash_start");var src=conf_get("loader.dash.src");window.hola_cdn.async_require(src||"//cdn.rawgit.com/hola/dash.js/development/dist/dash.mediaplayer.debug.js");preload_async_modules(function(){cb(conf_get)})}function select_zone_get_conf(url){var zone=_zone.t.select_zone(E.get_zones().zones,assign({top_url:location.href,video_url:url},_zone.t.get_zone_opt(E)));var z=zone=="gen"?gen:zones[zone];var conf_get=function(path,def_val){var d,p=path.split(".");return(d=util.conf_find(p,util.get_dbg_conf()||{}))!=undefined||(d=util.conf_find(p,z))!==undefined?d:def_val};conf_get.zone=zone;return conf_get}function is_cdn(conf_get,o){var m=mode.select_mode(assign({},{location:top.location,CG:conf_get,video_check_n:1,player_n:1},o));return m&&m.mode=="cdn"}function register_flowplayer_hls_engine(ready_cb){function is_playing(p){if(p.paused||!p.ready)return false;var max=conf_get("player.flowplayer.reload_max_pos",0);return!isFinite(max)||(p.video.time||0)>max}var conf_get=select_zone_get_conf(fake_hls_video_url);log.notice("use hola flowplayer hls engine");load_dm(conf_get,function _register_flowplayer_engine(){var flowplayer=window.flowplayer;if(!flowplayer){setTimeout(function(){_register_flowplayer_engine()},10);return}flow_hls_engine.attach(hls,window.flowplayer,gen_hola_hls_config());log.notice("hola flowplayer hls engine ready");if(!is_cdn(conf_get)){log.notice("mode not hola_cdn, use customer hls.js");if(flowplayer.engines[0].holaEngine)flowplayer.engines.shift();ready_cb();return}util.inject_hook(flowplayer.engines,"unshift",function(e,a){log.notice('skip register new flowplayer hls engine "%s"',a[0].engineName);e.set_handled()});log.notice("mode hola_cdn, use hola hls.js");var is_delayed_autodetect=false;zflowplayer.get_players().forEach(function(p){p=p.fplayer;if(!p.engine||p.engine.engineName!="hlsjs")return;var info={pos:p.video.time,duration:p.video.duration,paused:p.paused,zone_guess:conf_get.zone};if(is_playing(p)){perr({id:"loader_fp_hls_provider_already_playing",info:info});log.notice("player already started pos %s src %s",info.pos,p.video.src);return}is_delayed_autodetect=true;var is_detect=false;function load(){perr({id:"loader_fp_hls_provider_reload",info:info});log.notice("reloading src %s",p.video.src);p.load();if(!is_detect){is_detect=true;ready_cb()}}if(!p.loading)load();else p.one("ready",load)});if(!is_delayed_autodetect)ready_cb()})}function register_flowplayer_dash_engine(ready_cb){var conf_get=select_zone_get_conf(fake_video_url);log.notice("use hola flowplayer dash engine");load_dash(conf_get,function _register_flowplayer_dash_engine(){var flowplayer=window.flowplayer;if(!flowplayer){setTimeout(function(){_register_flowplayer_dash_engine()},10);return}window.hola_cdn.async_require("//"+require.zdot("host")+require.zdot("flow_dash_engine"));preload_async_modules(function(){log.notice("hola flowplayer dash engine ready");if(!is_cdn(conf_get)){log.notice("mode not hola_cdn, use customer dash");if(flowplayer.engines[0].holaEngine)flowplayer.engines.shift();ready_cb();return}log.notice("mode hola_cdn, use hola dash");util.inject_hook(flowplayer.engines,"unshift",function(e){log.notice("skip register new flowplayer dash engine");e.set_handled()});ready_cb()})})}function register_vjs_provider(ready_cb){var conf_get=select_zone_get_conf(fake_hls_video_url);log.notice("use hola vjs provider");perr({id:"loader_vjs_use_provider"});load_dm(conf_get,function _register_vjs_engine(){var videojs=window.videojs;if(!videojs){setTimeout(function(){_register_vjs_engine()},10);return}perr({id:"loader_vjs_hls_loaded"});videojs.hola_config=gen_hola_hls_config();if(!is_cdn(conf_get)){perr({id:"loader_vjs_mode_stats"});log.notice("mode not hola_cdn, use customer hls");ready_cb();return}perr({id:"loader_vjs_mode_cdn"});vjs_hls_provider.attach(window,videojs,window.Hls,videojs.hola_config);log.notice("hola vjs provider ready");var handle_players=function(players){players.forEach(function(p){var src=p.currentSrc();var is_playing=function(){var ad_flag_re=/(^|\s)vjs-ad-(playing|loading)/;if(ad_flag_re.test(p.el()&&p.el().className))return true;if(p.paused())return false;var max=conf_get("player.vjs.reload_max_pos",0);return!isFinite(max)||(p.currentTime()||0)>max};log.notice("found vjs player src %s",src);var info={pos:p.currentTime(),duration:p.duration(),paused:p.paused(),ads_state:p.ads&&p.ads.state,zone_guess:conf_get.zone};if(!util.is_hls_link(src)){perr({id:"loader_vjs_provider_src_not_hls",info:info});log.notice("src not hls %s",src)}else if(is_playing()){perr({id:"loader_vjs_provider_already_playing",info:info});log.notice("player already started pos %s ads %s src %s",p.currentTime(),p.ads&&p.ads.state,src)}else{perr({id:"loader_vjs_provider_reload",info:info});log.notice("reloading src %s",src);p.src(src)}});log.notice("mode hola_cdn, use hola hls.js");ready_cb()};var vjs_players,vjs_detector=autodetect.player_handlers.videojs;if((vjs_players=vjs_detector.get_instances()).length)handle_players(vjs_players);else if(util.is_mobile){log.notice("no vjs players yet");var reset_dom_listen=util.dom_listen(document,function(){if((vjs_players=vjs_detector.get_instances()).length)return;reset_dom_listen();handle_players(vjs_players)})}else{log.notice("mode hola_cdn, use hola hls.js");ready_cb()}})}function use_jwplayer_provider(){var conf_get=select_zone_get_conf(fake_hls_video_url);return!zutil.is_mocha()&&conf_get("player.jwplayer.register_hls_provider")}function register_jwplayer_provider(ready_cb){var conf_get=select_zone_get_conf(fake_hls_video_url);if(!zutil.is_mocha()&&(!window.Hls||!util.is_hola_hls_js_constructor(window.Hls))){load_dm(conf_get,function(){register_jw_provider(conf_get,ready_cb)})}else register_jw_provider(conf_get,ready_cb)}function setup_dailymotion_player(ready_cb){var conf_get=select_zone_get_conf(fake_hls_video_url);log.notice("use hola dailymotion player");load_dm(conf_get,function(){var Hls=window.Hls;if(!Hls.isSupported())return log.notice("dailymotion not suppported");var video,src;if(!(video=util.dom_query("video")))return log.notice("video element not found");if(!(src=video.currentSrc||video.src))return log.notice("missing video source");var conf_get=select_zone_get_conf(src);if(!is_cdn(conf_get,{video_url:src})){log.notice("mode not hola_cdn, skip playing with dailymotion");ready_cb();return}log.notice("mode hola_cdn, playing with dailymotion %s",src);var dm=window.hola_cdn.dm_hls_inst=new Hls(gen_hola_hls_config());dm.on(Hls.Events.MEDIA_ATTACHED,function media_cb(){dm.off(Hls.Events.MEDIA_ATTACHED,media_cb);dm.loadSource(src)});dm.attachMedia(video);E.fallback_to_native_on_error=true;ready_cb()})}function register_jw_provider(conf_get,ready_cb){var jwplayer=window.jwplayer;var hp=window.jwplayer_hls_provider||jwplayer_hls_provider;if(!jwplayer){return void setTimeout(function(){register_jw_provider(conf_get,ready_cb)},10)}if(!zjwplayer.jw_isV7(jwplayer)){dm_perr("loader_dm_hls_not_supported");log.err("load_dm not supported for jw<7");ready_cb();return}E.on("wrapper_error",function(){hp.disabled=true});if(!window.Hls.isSupported()){dm_perr("loader_dm_hls_not_supported");log.notice("hls html5 not supported");return}if(!is_cdn(conf_get)){dm_perr("loader_dm_hls_mode_stats");ready_cb();return}dm_perr("loader_dm_hls_mode_cdn");var hola_hls_config=gen_hola_hls_config();hola_hls_config.autoStartLoad=false;if(conf_get("player.jwplayer.prevent_background_video")){var old_videos=document.getElementsByTagName("video");for(var i=0;i<old_videos.length;i++){if(old_videos[i].className.includes("jw-video")){old_videos[i].src="";Object.defineProperty(old_videos[i],"src",{configurable:true,enumerable:false,set:function(){},get:function(){return""}})}}}log.notice("register jwplayer hls html5 provider %s",JSON.stringify(hola_hls_config));hp.attach();zjwplayer.jw_getPlayerInstances().forEach(function(jw){if(!jw.getProvider())return;var provider=jw.getProvider().name;if(provider=="hola/hls")return;dm_perr("loader_dm_hls_def_provider");log.notice('too late for "%s": %s already present, '+'using "%s" provider',jw.id,zjwplayer.jw_isAdPlaying(jw)?"ad":"video",provider)});ready_cb()}function use_video_proxy_hooks(){if(util.get_hola_uri("hola_static_video_proxy"))return true;if(E.suspended||!CG("loader.proxy_hooks"))return false;if(E.disabled){if(!CG("loader.proxy_in_disabled",[]).includes(E.disabled_reason))return false}return select_zone_get_conf(fake_mp4_video_url)("cdn.static_video_proxy")||select_zone_get_conf(fake_hls_video_url)("cdn.static_video_proxy")}function use_flowplayer_hls_engine(){if(util.get_hola_uri("hola_flowplayer_hls"))return true;var conf_get=select_zone_get_conf(fake_hls_video_url);return!!conf_get("player.flowplayer.register_hls_provider")}function use_flowplayer_dash_engine(){if(util.get_hola_uri("hola_flowplayer_dash"))return true;var conf_get=select_zone_get_conf(fake_hls_video_url);return!!conf_get("player.flowplayer.register_dash_provider")}function use_dailymotion_player(){if(+util.get_hola_uri("hola_dailymotion"))return true;var conf_get=select_zone_get_conf(fake_hls_video_url);return!!conf_get("player.dailymotion.autoload")}function use_vjs_hls_provider(){if(window.byteark)return true;if(util.get_hola_uri("hola_vjs_hls"))return true;var conf_get=select_zone_get_conf(fake_hls_video_url);return!!conf_get("player.vjs.register_hls_provider")}function use_hola_hls(){var conf_get=select_zone_get_conf(fake_hls_video_url);if(zutil.is_mocha()||!conf_get("loader.dailymotion.load"))return;if(!is_cdn(conf_get))return log.notice("mode not hola_cdn, use customer hls.js");return true}function load_hola_hls(ready_cb){var conf_get=select_zone_get_conf(fake_hls_video_url);return load_dm(conf_get,ready_cb)}function check_replace_dailymotion_hls_via_script_tag_hook(){var conf_get=select_zone_get_conf(fake_hls_video_url);if(conf_get("loader.replace_dailymotion_hls_via_script_tag"))set_replace_dailymotion_hls_via_script_tag_hook(conf_get)}function use_cdn_graph(){if(util.get_hola_uri("hola_graph"))return true;var conf_get=select_zone_get_conf(fake_hls_video_url);return!!conf_get("cdn.graph")}function load_cdn_graph(){window.hola_cdn.async_require("//"+require.zdot("host")+require.zdot("cdngraph_js"))}function use_image_preview(){if(window.hola_ve_image_preview||storage.get("hola_ve_image_preview")||location.href.match(/hola_ve_image_preview=(1|on)/)){return false}if(window.hola_image_preview||storage.get("hola_image_preview")||location.href.match(/hola_image_preview=1/)){return true}return spark.is_feature_enabled_by_conf(E.spark.image_previews)}function load_image_preview(){var s=document.createElement("script");s.src="//ve-cdn.h-cdn.com/image_preview.js?customer="+E.customer;document.head.appendChild(s)}function use_related_mvp(){if(window.hola_related||storage.get("hola_related")||location.href.match(/hola_related=1/)){return true}return spark.is_feature_enabled_by_conf(E.spark.related)}function load_related_mvp(){var s=document.createElement("script");s.src="//ve-cdn.h-cdn.com/related.js?customer="+E.customer;document.head.appendChild(s)}function use_visual_timeline_mvp(){if(window.hola_visual_timeline||storage.get("hola_visual_timeline")||location.href.match(/hola_visual_timeline=1/)){return true}return spark.is_feature_enabled_by_conf(E.spark.visual_timeline)}function load_visual_timeline_mvp(){var s=document.createElement("script");s.src="//ve-cdn.h-cdn.com/visual_timeline.js?customer="+E.customer;document.head.appendChild(s)}function pre_detect(ready_cb){if(use_image_preview())load_image_preview();if(use_related_mvp())load_related_mvp();if(use_visual_timeline_mvp())load_visual_timeline_mvp();if(use_cdn_graph())load_cdn_graph();if(use_flowplayer_hls_engine())return register_flowplayer_hls_engine(ready_cb);if(use_flowplayer_dash_engine())return register_flowplayer_dash_engine(ready_cb);if(use_vjs_hls_provider())return register_vjs_provider(ready_cb);if(use_dailymotion_player())return setup_dailymotion_player(ready_cb);if(use_jwplayer_provider())return register_jwplayer_provider(ready_cb);check_replace_dailymotion_hls_via_script_tag_hook();if(use_hola_hls())return load_hola_hls(ready_cb);preload_async_modules(ready_cb)}function load_external_deps(){return etask(function(){pre_detect(function(){this.continue()}.bind(this));return this.wait()})}function auto_detect_start(){util.assert_enabled(autodetect,"autodetect is required but disabled");log.notice("autoinit mode, waiting for player");E.ad_ctrl=autodetect.init({wrapper_fn:function(opt){return init_player(opt)}});E.on("wrapper_error",function(err){if(CG("loader.autodetect.shutdown_on_error")){log.notice("shutdown auto-detection due to error="+err);E.ad_ctrl.stop("werror:"+err)}});E.ad_ctrl.start();return E.ad_ctrl}function install_video_proxy_hooks(){var stat_video=util.try_wrapper_silent(function(el){if(!E.disabled||!CG("loader.proxy_in_disabled_test")||stat_video.done){
return}function on(el,event,cb){return el.addEventListener?el.addEventListener(event,cb):el.attachEvent?el.attachEvent("on"+event,cb):undefined}function off(el,event,cb){return el.removeEventListener?el.removeEventListener(event,cb):el.detachEvent?el.detachEvent("on"+event,cb):undefined}var events=["canplay","error"],res={missing:true};var cb=function(e){res={evt:e&&e.type,src:el.src,err:el.error&&el.error.code};events.forEach(function(e){off(el,e,cb)})};events.forEach(function(e){on(el,e,cb)});util.on("pre-beforeunload",function(){perr({id:"loader_video_proxy_test",info:res})});stat_video.done=true});var reload_allowed=function(el,conf_get){var frames=html5.get_decoded_frames(el);var allowed=conf_get("cdn.static_video_proxy_reload",25);log.notice("check reload: frames "+frames+" allowed "+allowed);return typeof allowed=="boolean"?allowed:isFinite(frames)&&frames<allowed};var get_proxy_url=function(src,zone){if(!src||util.is_blob_url(src))return;if(util.is_proxy_url(src)){src=util.proxy2origin(src);return util.is_proxy_url(src)?src:undefined}return util.get_proxy_url(E.customer,zone,util.absolute_uri(src))};var src_hook_gen=function(zone){return function(e,args){var nsrc,src=args[0];if(!(nsrc=get_proxy_url(src,zone)))return;log.notice("setting video src %s -> %s",src,nsrc);args[0]=nsrc}};var force_proxy=util.get_hola_uri("hola_static_video_proxy");var mp4_conf_get=select_zone_get_conf(fake_mp4_video_url);if(force_proxy||mp4_conf_get("cdn.static_video_proxy")){var videos=util.dom_query_all("video");if(videos.length){log.notice("set html5 src overload for proxy");for(var i=0;i<videos.length;i++){var el=videos[i],nsrc,src=html5.get_video_source(el);if(nsrc=get_proxy_url(src,mp4_conf_get.zone)){if(reload_allowed(el,mp4_conf_get)){log.notice("reloading video src %s -> %s",src,nsrc);perr({id:"loader_video_proxy_reload",info:{from:src,to:nsrc}});var was_playing=!el.paused;el.src=nsrc;if(was_playing)el.play();stat_video(el)}else{log.notice("proxy overload: already playing - skip");perr({id:"loader_video_proxy_skip_late_attach",info:{src:el.src}})}}if(!html5.polyfill.video_source_access(el)){perr({id:"loader_video_proxy_tag_hook_failed"});break}loader_inject_hook(el,"src",{exit_on_failure:true,set:src_hook_gen(mp4_conf_get.zone)});loader_inject_hook(el,"src",{exit_on_failure:true,set:function(){stat_video(el)}})}}else{perr({id:"loader_video_proxy_skip_no_video"});log.notice("proxy overload: no video element found - skip")}}var hls_conf_get=select_zone_get_conf(fake_hls_video_url);if(force_proxy||hls_conf_get("cdn.static_video_proxy")){var hook_hls_source=function(Hls){if(util.get_hola_uri("hola_no_hls"))return Hls.isSupported=function(){return false};log.notice("set hls src overload for proxy");loader_inject_hook(Hls.prototype,"loadSource",{exec:src_hook_gen(hls_conf_get.zone)})};if(window.Hls)hook_hls_source(window.Hls);else{loader_inject_hook(window,"Hls",{set:function(e,args){hook_hls_source(args[0])}})}if(window.__hola_hls_instances instanceof Array){window.__hola_hls_instances.forEach(function(dm){var nsrc;if(!(nsrc=get_proxy_url(dm.url,hls_conf_get.zone)))return;if(!dm.media||reload_allowed(dm.media,hls_conf_get)){log.notice("reloading hls source %s -> %s",dm.url,nsrc);perr({id:"loader_video_proxy_reload",info:{from:dm.url,to:nsrc}});dm.loadSource(nsrc)}else{log.notice("proxy overload: already playing - skip");perr({id:"loader_video_proxy_skip_late_attach",info:{src:dm.url}})}})}}}function set_replace_dailymotion_hls_via_script_tag_hook(conf_get){var hls_src=conf_get("loader.replace_dailymotion_hls_via_script_tag");var regex=conf_get("loader.replace_dailymotion_hls_via_script_tag_regex")||/\/(hls_hola|hls\.js)/;hls_src=util.fix_url(typeof hls_src=="string"?hls_src:"//"+require.zdot("host")+require.zdot("hls_js"));var h=loader_inject_hook(document,"createElement",function(e,args){try{var nodename=args[0];if(typeof nodename!="string"||nodename.toLowerCase()!="script")return;var el=h.original_handlers.exec(nodename);loader_inject_hook(el,"src",{set:function(e,args){if(regex.test(args[0]))args[0]=hls_src}});e.set_handled();return el}catch(err){perr({id:"overload_fail",info:{failed_method:"document.createElement",err:err},add_log:true})}})}if(E.loader_conf.prototype_js){[Object,Array,String,Number].forEach(function(o){delete o.prototype.toJSON;Object.defineProperty(o.prototype,"toJSON",{writable:false})})}load_perf.init(E.loader_conf.load_perf);loader_init();load_perf.push("loader_init_finish");perr({id:"loader_init"});E.init=E["init_"+customer]=function(){perr({id:"loader_legacy_manual_init"});log.debug("manual hola_cdn.init in plug-n-play mode - skipped")};if(!E.disabled){etask({name:"autodetect_prepare"},[function(){return etask.all([load_external_deps(),customers.resolve_customer_deps(E)])},function(){if(!zutil.is_mocha())auto_detect_start();load_perf.push("autodetect_init_finish")},function catch$(err){err=err||{};perr({id:"loader_autoinit_failure",info:{stack:err.stack,message:err.message}})}])}if(typeof window.hola_cdn_on_load=="function"){perr({id:"loader_legacy_onload_call"});window.hola_cdn_on_load()}function prepare4wizard(event){if(event.data.wizard_ping&&!E.has_wizard){event.source.postMessage({hola:true,wizard_retest:true},"*");return}if(!event.data.prepare4wizard||E.has_wizard)return;E.has_wizard=true;E.debug_mode(null,function(){event.source.postMessage({hola:true,failed_load:true,frame_url:window.location.href},"*")});var m=window.sessionStorage.getItem("hola_mode");if(E.get_mode()==event.data.mode||m==event.data.mode)return;window.sessionStorage.setItem("hola_mode",event.data.mode);window.location.reload()}window.addEventListener("message",prepare4wizard,false);return E});define("/svc/cdn/pub/loader.js",["/svc/cdn/pub/config.js","/svc/cdn/pub/cdn.js","/util/etask.js","/svc/cdn/pub/util.js"],function(){});

}());
//# sourceMappingURL=/loader.js?customer=independent_co_uk&map=true&md5=1340086-edb7ca6c